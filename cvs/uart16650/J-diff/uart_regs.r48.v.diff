64a65,67
> // Revision 1.25  2001/11/28 19:36:39  gorban
> // Fixed: timeout and break didn't pay attention to current data format when counting time
> //
163a167,172
> 
> `ifdef DATA_BUS_WIDTH_8
> `else
> // debug interface signals	enabled
> ier, iir, fcr, mcr, lcr, msr, lsr, rf_count, tf_count, tstate, rstate,
> `endif				
182a192,208
> `ifdef DATA_BUS_WIDTH_8
> `else
> // if 32-bit databus and debug interface are enabled
> output [3:0]							ier;
> output [3:0]							iir;
> output [1:0]							fcr;  /// bits 7 and 6 of fcr. Other bits are ignored
> output [4:0]							mcr;
> output [7:0]							lcr;
> output [7:0]							msr;
> output [7:0] 							lsr;
> output [`UART_FIFO_COUNTER_W-1:0] 	rf_count;
> output [`UART_FIFO_COUNTER_W-1:0] 	tf_count;
> output [2:0] 							tstate;
> output [3:0] 							rstate;
> 
> `endif
> 
255c281,282
< wire [2:0] 								state;
---
> wire [2:0] 								tstate;
> wire [3:0] 								rstate;
260c287
< uart_transmitter transmitter(clk, wb_rst_i, lcr, tf_push, wb_dat_i, enable, stx_pad_o, state, tf_count, tx_reset, lsr_mask);
---
> uart_transmitter transmitter(clk, wb_rst_i, lcr, tf_push, wb_dat_i, enable, stx_pad_o, tstate, tf_count, tx_reset, lsr_mask);
264c291
< 	counter_t, rf_count, rf_data_out, rf_error_bit, rf_overrun, rx_reset, lsr_mask);
---
> 	counter_t, rf_count, rf_data_out, rf_error_bit, rf_overrun, rx_reset, lsr_mask, rstate);
267c294,296
< always @(posedge clk or posedge wb_rst_i)   // synchrounous reading
---
> // Asynchronous reading here because the outputs are sampled in uart_wb.v file 
> always @(/*AUTOSENSE*/dl or dlab or ier or iir
> 			or lcr or lsr or msr or rf_data_out or wb_addr_i or wb_re_i)   // asynchrounous reading
276,279c305
< 	`UART_REG_RB : if (dlab) // Receiver FIFO or DL byte 1
< 			wb_dat_o <= #1 dl[`UART_DL1];
< 		  else
< 			wb_dat_o <= #1 rf_data_out[10:3];
---
> 				`UART_REG_RB   : wb_dat_o <= #1 dlab ? dl[`UART_DL1] : rf_data_out[10:3];
469c495
< assign lsr6 = (tf_count==5'b0 && (state == /*`S_IDLE */ 0)); // transmitter empty
---
> assign lsr6 = (tf_count==5'b0 && (tstate == /*`S_IDLE */ 0)); // transmitter empty
539c565
< 	else lsr5r <= #1 (lsr_mask || iir_read || tx_fifo_write) ? 0 :  lsr5r || (lsr5 && ~lsr5_d);
---
> 	else lsr5r <= #1 (tx_fifo_write) ? 0 :  lsr5r || (lsr5 && ~lsr5_d);
550c576
< 	else lsr6r <= #1 (lsr_mask || tx_fifo_write) ? 0 : lsr6r || (lsr6 && ~lsr6_d);
---
> 	else lsr6r <= #1 (tx_fifo_write) ? 0 : lsr6r || (lsr6 && ~lsr6_d);
