2c2
<  * Copyright (c) 2005, 2007 IBM Corporation and others.
---
>  * Copyright (c) 2005, 2008 IBM Corporation and others.
22,23d21
< import org.eclipse.jface.util.LocalSelectionTransfer;
< import org.eclipse.jface.viewers.ISelection;
28d25
< import org.eclipse.swt.dnd.TransferData;
54,62c51,69
< 		/*  Get the selection from the transfer agent */
< 		TransferData[] data = getCurrentEvent().dataTypes;
< 		List fileList = new ArrayList();
< 		
< 		for (int i=0; i < data.length; i++) {
< 			
< 			if (FileTransfer.getInstance().isSupportedType(data[i])) {
< 				// FileTransfers from the PE are supported, but an 
< 				// SWT exception is thrown when using nativeToJava call.
---
>         List<String> filesList = new ArrayList<String>();
>         if (getCurrentEvent().data instanceof String[]) {
>             insertFileNamesFromStringArray(filesList,
>                     (String[]) getCurrentEvent().data);
>         } else if (getCurrentEvent().data instanceof IStructuredSelection) {
> 			Object[] array = ((IStructuredSelection)getCurrentEvent().data).toArray();
> 			for (int j = 0; j < array.length; j++) {
> 				if (array[j] instanceof IFile) {
> 					IFile dropFile = (IFile)array[j];
> 					filesList.add(dropFile.getLocation().toOSString());
> 				}
> 			}
>         	
>         } else {
>         	/*
>         	 * No needs to check if transfered data we're looking at is FileTransfer type data.
>         	 * This drop target listener is invoked as <code>DelegatingDropAdapter</code>, hence
>         	 * if we get here the transfer is supported for the DropTargetEvent#currentDataType 
>         	 */
64c71,72
< 					Object files = FileTransfer.getInstance().nativeToJava(data[i]);
---
>                 Object files = FileTransfer.getInstance().nativeToJava(
>                         getCurrentEvent().currentDataType);
66,68c74
< 						String[] fileStrings = (String[])files;
< 						for	(int j=0; j<fileStrings.length; j++)
< 							fileList.add(fileStrings[j]);
---
>                     insertFileNamesFromStringArray(filesList, (String[]) files);
71,72c77
< 					continue;
< 				}
---
>                 return null;
76,80c81,82
< 		if (fileList.size() == 0) {
< 			ISelection selection = null;
< 	        
< 	        if (LocalSelectionTransfer.getTransfer().getSelection() != null) {
< 	        	selection = LocalSelectionTransfer.getTransfer().getSelection();
---
>         if (filesList.size() > 0) {
>             return filesList;
83,93c85
< 			if (selection instanceof IStructuredSelection
< 	            && !selection.isEmpty()) {
<             
< 				/* Get the array of objects in the selection */
< 				Object[] array = ((IStructuredSelection)selection).toArray();
< 				for (int j = 0; j < array.length; j++) {
< 					if (array[j] instanceof IFile) {
< 						IFile dropFile = (IFile)array[j];
< 						fileList.add(dropFile.getLocation().toOSString());
< 					}
< 				}
---
>         return null;
96c88,90
<             return fileList;
---
>     private void insertFileNamesFromStringArray(List<String> filesList, String[] fileNames) {
>         for (int i = 0; i < fileNames.length; i++) {
>             filesList.add(fileNames[i]);
98,102d91
< 		
< 		if (fileList.size() > 0)
< 			return fileList;
< 		
< 		return null;
114d102
< 			List dropObjects = getDropObjectsRequest().getObjects();
117,118c105
< 				return dropObjects != null && !dropObjects.isEmpty();
< 				
---
>                 return true;
124,125c111
< 				if (dropObjects == null || dropObjects.isEmpty()
< 						|| target == null) {
---
>                 if (target == null) {
133a120,130
> 	/* (non-Javadoc)
> 	 * @see org.eclipse.gmf.runtime.diagram.ui.parts.DiagramDropTargetListener#isDataTransfered()
> 	 */
> 	protected boolean isDataTransfered() {
> 		/*
> 		 * The data transfer occurs at the drop time on Linux, hence data is transfered when the request
> 		 * has some objects that are being dropped.
> 		 */
> 		return super.isDataTransfered() && !getDropObjectsRequest().getObjects().isEmpty();
> 	}
> 
