13a14
> import java.util.HashSet;
14a16
> import java.util.Set;
21a24,34
> import org.eclipse.jface.viewers.IColorProvider;
> import org.eclipse.jface.viewers.ILabelProviderListener;
> import org.eclipse.jface.viewers.ISelectionChangedListener;
> import org.eclipse.jface.viewers.IStructuredContentProvider;
> import org.eclipse.jface.viewers.IStructuredSelection;
> import org.eclipse.jface.viewers.ITableLabelProvider;
> import org.eclipse.jface.viewers.SelectionChangedEvent;
> import org.eclipse.jface.viewers.StructuredSelection;
> import org.eclipse.jface.viewers.TableViewer;
> import org.eclipse.jface.viewers.Viewer;
> import org.eclipse.jface.viewers.ViewerComparator;
22a36,38
> import org.eclipse.swt.custom.ScrolledComposite;
> import org.eclipse.swt.events.ControlAdapter;
> import org.eclipse.swt.events.ControlEvent;
24a41,42
> import org.eclipse.swt.graphics.Color;
> import org.eclipse.swt.graphics.Image;
29a48
> import org.eclipse.swt.widgets.Display;
31c50
< import org.eclipse.swt.widgets.List;
---
> import org.eclipse.swt.widgets.TableColumn;
49,50c68,73
< 	private List referencedPathVariables;
< 	private List pathVariables;
---
> 	private ScrolledComposite referencedPathVariablesScroll;
> 	private TableViewer referencedPathVariables;
> 	private StringsContentProvider referencedPathVariablesContent;
> 	private ScrolledComposite pathVariablesScroll;
> 	private TableViewer pathVariables;
> 	private StringsContentProvider pathVariablesContent;
51a75
> 	private Button remove;
98c122,125
< 		pathVariables = new List(pathVariablesComposite, SWT.MULTI | SWT.BORDER);
---
> 		pathVariablesScroll = new ScrolledComposite(
> 				pathVariablesComposite, SWT.BORDER | SWT.H_SCROLL | SWT.V_SCROLL);
> 		pathVariablesScroll.setExpandHorizontal(true);
> 		pathVariablesScroll.setExpandVertical(true);
103c130,145
< 		pathVariables.setLayoutData(gridData);
---
> 		pathVariablesScroll.setLayoutData(gridData);
> 		pathVariables = new TableViewer(pathVariablesScroll, SWT.MULTI);
> 		pathVariablesScroll.setContent(pathVariables.getTable());
> 		
> 		TableColumn column = new TableColumn(pathVariables.getTable(), SWT.LEFT);
> 		column.setMoveable(false);
> 		column.setResizable(false);
> 		pathVariables.getTable().addControlListener(new ControlAdapter() {
> 			public void controlResized(ControlEvent e) {
> 				pathVariables.getTable().getColumn(0).setWidth(
> 						pathVariables.getTable().getClientArea().width);
> 			}});
> 		pathVariablesContent = new StringsContentProvider();
> 		pathVariables.setContentProvider(pathVariablesContent);
> 		pathVariables.setLabelProvider(new StringsLabelProvider());
> 		pathVariables.setComparator(new StringsViewerComparator());
120c162
< 		Button remove = new Button(buttonComposite,SWT.CENTER);
---
> 		remove = new Button(buttonComposite,SWT.CENTER);
159c201,204
< 		referencedPathVariables = new List(referencedPathVariablesComposite,SWT.MULTI | SWT.BORDER);
---
> 		referencedPathVariablesScroll = new ScrolledComposite(
> 				referencedPathVariablesComposite, SWT.BORDER | SWT.H_SCROLL | SWT.V_SCROLL);
> 		referencedPathVariablesScroll.setExpandHorizontal(true);
> 		referencedPathVariablesScroll.setExpandVertical(true);
164c209,236
< 		referencedPathVariables.setLayoutData(gridData);
---
> 		referencedPathVariablesScroll.setLayoutData(gridData);
> 		referencedPathVariables = new TableViewer(referencedPathVariablesScroll, SWT.MULTI);
> 		referencedPathVariablesScroll.setContent(referencedPathVariables.getTable());
> 		
> 		column = new TableColumn(referencedPathVariables.getTable(), SWT.LEFT);
> 		column.setMoveable(false);
> 		column.setResizable(false);
> 		referencedPathVariables.getTable().addControlListener(new ControlAdapter() {
> 			public void controlResized(ControlEvent e) {
> 				referencedPathVariables.getTable().getColumn(0).setWidth(
> 						referencedPathVariables.getTable().getClientArea().width);
> 			}});
> 		referencedPathVariablesContent = new StringsContentProvider();
> 		referencedPathVariables.setContentProvider(referencedPathVariablesContent);
> 		referencedPathVariables.setLabelProvider(new StringsLabelProvider(true));
> 		referencedPathVariables.setComparator(new StringsViewerComparator());
> 		
> 		// adjust the scroll bars whenever the preference page is resized
> 		composite.addControlListener(new ControlAdapter() {
> 			public void controlResized(ControlEvent e) {
> 				adjustScrollpanes();
> 			}});
> 		
> 		pathVariables.addSelectionChangedListener(new ISelectionChangedListener() {
> 			public void selectionChanged(SelectionChangedEvent event) {
> 				if (!event.getSelection().isEmpty()) { // prevent oscillation
> 					referencedPathVariables.setSelection(new StructuredSelection());
> 					remove.setEnabled(true);
166,171c238
< 		pathVariables.addSelectionListener(new SelectionListener() {
< 			public void widgetSelected(SelectionEvent e) {
< 				referencedPathVariables.deselectAll();
< 				
< 				if (!validateSelections(pathVariables.getSelection())) {
< 					setMessage(EMFUIMessages.PathmapsPreferencePage_incompatiblePathVariableErrorMessage,ERROR);
---
> 					if (!validateAdditions((IStructuredSelection) event.getSelection(), true)) {
178,180d244
< 
< 			public void widgetDefaultSelected(SelectionEvent e) {
< 				// No action necessary
184,186c248,250
< 		referencedPathVariables.addSelectionListener(new SelectionListener() {
< 			public void widgetSelected(SelectionEvent e) {
< 				setMessage(null);
---
> 		referencedPathVariables.addSelectionChangedListener(new ISelectionChangedListener() {
> 			public void selectionChanged(SelectionChangedEvent event) {
> 				if (!event.getSelection().isEmpty()) { // prevent oscillation
188,189c252
< 				pathVariables.deselectAll();
< 			}
---
> 					pathVariables.setSelection(new StructuredSelection());
191,192c254,260
< 			public void widgetDefaultSelected(SelectionEvent e) {
< 				// No action necessary
---
> 					if (!validateRemovals((IStructuredSelection) event.getSelection(), true)) {
> 						remove.setEnabled(false);
> 					} else {
> 						setMessage(null);
> 						remove.setEnabled(true);
> 					}
> 				}
198c266,267
< 				String[] selections = pathVariables.getSelection();
---
> 				IStructuredSelection selection =
> 					(IStructuredSelection) pathVariables.getSelection();
200,202c269,273
< 				for (int i=0; i<selections.length; i++) {
< 					referencedPathVariables.add(selections[i]);
< 					pathVariables.remove(selections[i]);
---
> 				for (Iterator iter = selection.iterator(); iter.hasNext();) {
> 					String name = (String) iter.next();
> 					pathVariablesContent.remove(name);
> 					referencedPathVariablesContent.add(name);
> 					adjustScrollpanes();
217c288
< 				String[] items = pathVariables.getItems();
---
> 				Object[] items = pathVariablesContent.getElements(null);
219,222c290,295
< 				for (int i=0; i<items.length; i++) {
< 					if (validateSelections(new String[]{items[i]})) {
< 						referencedPathVariables.add(items[i]);
< 						pathVariables.remove(items[i]);
---
> 				for (int i=items.length - 1; i >= 0; i--) {
> 					if (validateAdditions(new StructuredSelection(items[i]), false)) {
> 						String name = (String) items[i];
> 						pathVariablesContent.remove(name);
> 						referencedPathVariablesContent.add(name);
> 						adjustScrollpanes();
230c303,304
< 				String[] selections = referencedPathVariables.getSelection();
---
> 				IStructuredSelection selection =
> 					(IStructuredSelection) referencedPathVariables.getSelection();
232,234c306,310
< 				for (int i=0; i<selections.length; i++) {
< 					pathVariables.add(selections[i]);
< 					referencedPathVariables.remove(selections[i]);
---
> 				for (Iterator iter = selection.iterator(); iter.hasNext();) {
> 					String name = (String) iter.next();
> 					referencedPathVariablesContent.remove(name);
> 					pathVariablesContent.add(name);
> 					adjustScrollpanes();
249c325
< 				String[] items = referencedPathVariables.getItems();
---
> 				Object[] items = referencedPathVariablesContent.getElements(null);
251,253c327,333
< 				for (int i=0; i<items.length; i++) {
< 					pathVariables.add(items[i]);
< 					referencedPathVariables.remove(items[i]);
---
> 				for (int i=items.length - 1; i >= 0; i--) {
> 					if (validateRemovals(new StructuredSelection(items[i]), false)) {
> 						String name = (String) items[i];
> 						referencedPathVariablesContent.remove(name);
> 						pathVariablesContent.add(name);
> 						adjustScrollpanes();
> 					}
264c344
< 				referencedPathVariables.getShell().getDisplay().asyncExec(new Runnable() {
---
> 				referencedPathVariables.getTable().getDisplay().asyncExec(new Runnable() {
282,283c362,396
< 	private boolean validateSelections(String[] selections) {
< 		if (selections.length == 0)
---
> 	private void adjustScrollpanes() {
> 		pathVariablesScroll.setMinSize(
> 				pathVariables.getTable().computeSize(SWT.DEFAULT, SWT.DEFAULT));
> 		pathVariablesScroll.layout();
> 		referencedPathVariablesScroll.setMinSize(
> 				referencedPathVariables.getTable().computeSize(SWT.DEFAULT, SWT.DEFAULT));
> 		referencedPathVariablesScroll.layout();
> 	}
> 	
> 	private boolean validateAdditions(IStructuredSelection selection, boolean showError) {
> 		if (selection.isEmpty())
> 			return false;
> 		
> 		for (Iterator iter = selection.iterator(); iter.hasNext();) {
> 			String name = (String) iter.next();
> 			
> 			if (!PathmapManager.isCompatiblePathVariable(name)) {
> 				if (showError) {
> 					setMessage(EMFUIMessages.PathmapsPreferencePage_incompatiblePathVariableErrorMessage,ERROR);
> 				}
> 				return false;
> 			}
> 			
> 			if (PathmapManager.isRegisteredPathVariable(name)) {
> 				if (showError) {
> 					setMessage(EMFUIMessages.PathmapsPreferencePage_registeredPathVariableErrorMessage,ERROR);
> 				}
> 				return false;
> 			}
> 		}
> 		return true;
> 	}
> 
> 	private boolean validateRemovals(IStructuredSelection selection, boolean showError) {
> 		if (selection.isEmpty())
286,287c399,400
< 		for (int i=0; i<selections.length; i++) {
< 			String selection = selections[i];
---
> 		for (Iterator iter = selection.iterator(); iter.hasNext();) {
> 			String name = (String) iter.next();
289c402,405
< 			if (!PathmapManager.isCompatiblePathVariable(selection)) {
---
> 			if (PathmapManager.isRegisteredPathVariable(name)) {
> 				if (showError) {
> 					setMessage(EMFUIMessages.PathmapsPreferencePage_registeredPathVariableErrorMessage,ERROR);
> 				}
299,300c415,419
< 		referencedPathVariables.removeAll();
< 		pathVariables.removeAll();
---
> 		remove.setEnabled(true);
> 		
> 		referencedPathVariables.setInput(new HashSet(PathmapManager.getAllPathVariables()));
> 		
> 		Set currentVariables = PathmapManager.getPathVariableReferences();
301a421
> 		Set available = new HashSet();
304c424,425
< 			pathVariables.add(pathVariableNames[i]);
---
> 			if (!currentVariables.contains(pathVariableNames[i])) {
> 				available.add(pathVariableNames[i]);
306,310d426
< 		
< 		for (Iterator i = PathmapManager.getPathVariableReferences().iterator(); i.hasNext();) {
< 			String pathVariable = (String)i.next();
< 			referencedPathVariables.add(pathVariable);
< 			pathVariables.remove(pathVariable);
311a428,429
> 		
> 		pathVariables.setInput(available);
324c442
< 		String[] nonReferencedPathVariables = pathVariables.getItems();
---
> 		Object[] nonReferencedPathVariables = pathVariablesContent.getElements(null);
326c444,445
< 			PathmapManager.removePathVariableReference(nonReferencedPathVariables[i]);
---
> 			String variableName = (String) nonReferencedPathVariables[i];
> 			PathmapManager.removePathVariableReference(variableName);
329c448,449
< 		String[] variablesToReference = referencedPathVariables.getItems();
---
> 		Set currentVariables = PathmapManager.getAllPathVariables();
> 		Object[] variablesToReference = referencedPathVariablesContent.getElements(null);
331c451,455
< 			PathmapManager.addPathVariableReference(variablesToReference[i]);
---
> 			String variableName = (String) variablesToReference[i];
> 			
> 			if (!currentVariables.contains(variableName)) {
> 				PathmapManager.addPathVariableReference(variableName);
> 			}
346a471,566
> 	
> 	private static class StringsContentProvider implements IStructuredContentProvider {
> 		private Set strings;
> 		private TableViewer table;
> 		
> 		StringsContentProvider() {
> 			strings = new HashSet();
> 		}
> 		
> 		void add(String string) {
> 			if (!strings.contains(string)) {
> 				strings.add(string);
> 				table.add(string);
> 			}
> 		}
> 		
> 		void remove(String string) {
> 			if (strings.contains(string)) {
> 				strings.remove(string);
> 				table.remove(string);
> 			}
> 		}
> 		
> 		public Object[] getElements(Object inputElement) {
> 			return strings.toArray();
> 		}
> 
> 		public void inputChanged(Viewer viewer, Object oldInput, Object newInput) {
> 			strings = (Set) newInput;
> 			table = (TableViewer) viewer;
> 		}
> 
> 		public void dispose() {
> 			// nothing to clean up
> 		}
> 	}
> 	
> 	private static class StringsLabelProvider implements ITableLabelProvider, IColorProvider {
> 		private final boolean isReferencedPathVariables;
> 		
> 		StringsLabelProvider() {
> 			this(false);
> 		}
> 		
> 		StringsLabelProvider(boolean isReferencedPathVariables) {
> 			this.isReferencedPathVariables = isReferencedPathVariables;
> 		}
> 		
> 		public Image getColumnImage(Object element, int columnIndex) {
> 			return null;
> 		}
> 
> 		public String getColumnText(Object element, int columnIndex) {
> 			return (columnIndex == 0) ? (String) element : null;
> 		}
> 
> 		public void dispose() {
> 			// nothing to dispose (the colors are all shared system colors)
> 		}
> 
> 		public boolean isLabelProperty(Object element, String property) {
> 			return false;
> 		}
> 
> 		public void addListener(ILabelProviderListener listener) {
> 			// not using listeners
> 		}
> 
> 		public void removeListener(ILabelProviderListener listener) {
> 			// not using listeners
> 		}
> 
> 		public Color getBackground(Object element) {
> 			if (isReferencedPathVariables && PathmapManager.isRegisteredPathVariable((String) element)) {
> 				return Display.getDefault().getSystemColor(
> 						SWT.COLOR_TITLE_INACTIVE_BACKGROUND);
> 			}
> 			
> 			return null;
> 		}
> 
> 		public Color getForeground(Object element) {
> 			return null;
> 		}
> 	}
> 	
> 	private static class StringsViewerComparator extends ViewerComparator {
> 		StringsViewerComparator() {
> 			super();
> 		}
> 		
> 		public int category(Object element) {
> 			// sort statically-registered variables to the end of the list
> 			return PathmapManager.isRegisteredPathVariable((String) element)? 1 : 0;
> 		}
> 	}
