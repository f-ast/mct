339,341c339,345
< 				final String oldContents = cu.getSource();
<                 IImportDeclaration[] declaredImports = cu.getImports();
< 				cu.getBuffer().setContents(genText);
---
> 				ICompilationUnit workingCopy = null;
> 				try {
> 					workingCopy = cu.getWorkingCopy(new SubProgressMonitor(pm, 1));
> 					final String oldContents = workingCopy.getSource();
> 	                IImportDeclaration[] declaredImports = workingCopy.getImports();
> 	                workingCopy.getBuffer().setContents(genText);
> 	                workingCopy.reconcile(ICompilationUnit.NO_AST, false, null, null);
348c352
< 					getImportsPostrocessor().organizeImports(cu, declaredImportsAsStrings, new SubProgressMonitor(pm, 1));
---
> 						getImportsPostrocessor().organizeImports(workingCopy, declaredImportsAsStrings, new SubProgressMonitor(pm, 1));
350c354
< 					cu.save(new SubProgressMonitor(pm, 1), true); // save to investigate contents
---
> 						workingCopy.commitWorkingCopy(true, new SubProgressMonitor(pm, 1)); // save to investigate contents
353c357
< 				genText = mergeJavaCode(oldContents, cu.getSource(), new SubProgressMonitor(pm, 1));
---
> 					genText = mergeJavaCode(oldContents, workingCopy.getSource(), new SubProgressMonitor(pm, 1));
356,357c360,362
< 					cu.getBuffer().setContents(genText);
< 					cu.save(new SubProgressMonitor(pm, 1), true);
---
> 						workingCopy.getBuffer().setContents(genText);
> 						workingCopy.reconcile(ICompilationUnit.NO_AST, false, null, null);
> 						workingCopy.commitWorkingCopy(true, new SubProgressMonitor(pm, 1));
359c364
< 					cu.getBuffer().close(); // discard changes
---
> 						// discard changes - would happen in finally, nothing else to do
361a367,369
> 				} finally {
> 					workingCopy.discardWorkingCopy();
> 				}
