2c2
<  * Copyright (c) 2002, 2005 IBM Corporation and others.
---
>  * Copyright (c) 2002, 2006 IBM Corporation and others.
18a19
> import org.eclipse.core.commands.ExecutionException;
19a21,26
> import org.eclipse.core.runtime.IProgressMonitor;
> import org.eclipse.core.runtime.IStatus;
> import org.eclipse.core.runtime.Status;
> import org.eclipse.emf.edit.domain.EditingDomain;
> import org.eclipse.emf.edit.domain.IEditingDomainProvider;
> import org.eclipse.emf.transaction.TransactionalEditingDomain;
29d35
< import org.eclipse.gmf.runtime.common.core.command.CommandResult;
41d46
< import org.eclipse.gmf.runtime.diagram.ui.commands.EtoolsProxyCommand;
42a48
> import org.eclipse.gmf.runtime.diagram.ui.commands.EtoolsProxyCommand;
54c60
< import org.eclipse.gmf.runtime.emf.commands.core.command.CompositeModelCommand;
---
> import org.eclipse.gmf.runtime.emf.commands.core.command.CompositeTransactionalCommand;
105c111
< 			CompoundCommand deleteCC = getDeleteCommand(cntxt);
---
> 			CompoundCommand deleteCC = getDeleteCommand(diagramPart, cntxt);
166c172,178
< 		return new CopyCommand(cntxt.getLabel(), diagramPart.getDiagram(),
---
>         TransactionalEditingDomain editingDomain = getEditingDomain(diagramPart);
>         
>         if (editingDomain == null) {
>             return null;
>         }
>         
>         return new CopyCommand(editingDomain, cntxt.getLabel(), diagramPart.getDiagram(),
169c181
< 			public boolean isUndoable() {
---
> 			public boolean canUndo() {
173c185
< 			public boolean isRedoable() {
---
> 			public boolean canRedo() {
177,179c189,196
< 			protected CommandResult doUndo() {
< 				return isUndoable ? newOKCommandResult()
< 					: super.doUndo();
---
> 		
>             protected IStatus doUndo(IProgressMonitor monitor, IAdaptable info)
>                 throws ExecutionException {
> 
>                 if (isUndoable) {
>                     return Status.OK_STATUS;
>                 }
>                 return super.doUndo(monitor, info);
182,184c199,205
< 			protected CommandResult doRedo() {
< 				return isUndoable ? newOKCommandResult()
< 					: super.doRedo();
---
> 			protected IStatus doRedo(IProgressMonitor monitor, IAdaptable info)
>                 throws ExecutionException {
> 
>                 if (isUndoable) {
>                     return Status.OK_STATUS;
>                 }
>                 return super.doRedo(monitor, info);
203c224,232
< 		CompositeModelCommand cut = new CompositeModelCommand(cntxt.getLabel());
---
>         
>         TransactionalEditingDomain editingDomain = getEditingDomain(diagramPart);
> 
>         if (editingDomain == null) {
>             return null;
>         }
>         
>         CompositeTransactionalCommand cut = new CompositeTransactionalCommand(editingDomain, cntxt
>             .getLabel());
228c257
< 		if (!cut.isEmpty() && cut.isExecutable())
---
> 		if (!cut.isEmpty() && cut.canExecute())
259a289
>      * @param part the workbench part
265c295,296
< 	private CompoundCommand getDeleteCommand(IGlobalActionContext cntxt) {
---
> 	private CompoundCommand getDeleteCommand(IDiagramWorkbenchPart part,
>             IGlobalActionContext cntxt) {
271c302,308
< 		CompositeModelCommand compositeCommand = new CompositeModelCommand(
---
>         TransactionalEditingDomain editingDomain = getEditingDomain(part);
>         
>         if (editingDomain == null) {
>             return deleteCC;
>         }
> 
> 		CompositeTransactionalCommand compositeCommand = new CompositeTransactionalCommand(editingDomain, 
272a310
>         
286c324
< 		if (compositeCommand.getCommands().size() > 0) {
---
> 		if (!compositeCommand.isEmpty()) {
489c527
< 			if (command != null && command.isExecutable()) {
---
> 			if (command != null && command.canExecute()) {
641a680,706
>     
>     /**
>      * Gets the transactional editing domain associated with the workbench
>      * <code>part</code>.
>      * 
>      * @param part
>      *            the diagram workbench part
>      * @return the editing domain, or <code>null</code> if there is none.
>      */
>     private TransactionalEditingDomain getEditingDomain(
>             IDiagramWorkbenchPart part) {
> 
>         TransactionalEditingDomain result = null;
> 
>         IEditingDomainProvider provider = (IEditingDomainProvider) part
>             .getAdapter(IEditingDomainProvider.class);
> 
>         if (provider != null) {
>             EditingDomain domain = provider.getEditingDomain();
> 
>             if (domain != null && domain instanceof TransactionalEditingDomain) {
>                 result = (TransactionalEditingDomain) domain;
>             }
>         }
> 
>         return result;
>     }
