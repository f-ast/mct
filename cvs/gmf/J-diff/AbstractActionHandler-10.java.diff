42a43
> import org.eclipse.ui.ISelectionService;
413,414c414,418
< 		ISelectionProvider selectionProvider = getWorkbenchPart().getSite()
< 			.getSelectionProvider();
---
>         ISelectionService selectionService = null;
>         if (getWorkbenchPart() != null && getWorkbenchPart().getSite().getWorkbenchWindow() != null) {
>             selectionService = getWorkbenchPart().getSite()
>                 .getWorkbenchWindow().getSelectionService();
>         }
416,417c420,421
< 		if (selectionProvider != null) {
< 			selection = selectionProvider.getSelection();
---
>         if (selectionService != null) {
>             selection = selectionService.getSelection();
430,441c434,435
< 		IStructuredSelection selection = null;
< 		ISelectionProvider selectionProvider = null;
< 		if (getWorkbenchPart() != null) {
< 			selectionProvider = getWorkbenchPart().getSite()
< 				.getSelectionProvider();
< 		}
< 
< 		if (selectionProvider != null
< 			&& selectionProvider.getSelection() instanceof IStructuredSelection) {
< 			selection = (IStructuredSelection) selectionProvider.getSelection();
< 		}
< 		return (selection != null) ? selection
---
>         ISelection selection = getSelection();
>         return (selection instanceof StructuredSelection) ? (StructuredSelection) selection
