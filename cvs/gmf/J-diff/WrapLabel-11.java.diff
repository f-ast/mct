2c2
<  * Copyright (c) 2002, 2005  IBM Corporation and others.
---
>  * Copyright (c) 2002, 2006 IBM Corporation and others.
13a14
> import java.lang.ref.WeakReference;
14a16,17
> import java.util.Map;
> import java.util.WeakHashMap;
19a23
> import org.eclipse.draw2d.LayoutManager;
24a29,31
> 
> import org.eclipse.gmf.runtime.draw2d.ui.internal.mapmode.IMapModeHolder;
> import org.eclipse.gmf.runtime.draw2d.ui.mapmode.IMapMode;
26a34
> import org.eclipse.swt.graphics.FontMetrics;
56c64,65
< 	private static String _ellipse = "..."; //$NON-NLS-1$
---
> 	private static final String _ellipse = "..."; //$NON-NLS-1$
> 
58a68,131
> 	private static final Map mapModeConstantsMap = new WeakHashMap();
> 
> 	private static class MapModeConstants {
> 
> 		private static final int MAX_IMAGE_INFO = 12;
> 
> 		public final WeakReference mapModeRef;
> 
> 		public final int nDPtoLP_3;
> 
> 		public final int nDPtoLP_2;
> 
> 		public final int nDPtoLP_0;
> 
> 		public final Dimension dimension_nDPtoLP_0;
> 
> 		public final WeakHashMap fontToEllipseTextSize = new WeakHashMap();
> 
> 		public final SingleIconInfo[] singleIconInfos = new SingleIconInfo[MAX_IMAGE_INFO];
> 
> 		public MapModeConstants(IMapMode mapMode) {
> 			this.mapModeRef = new WeakReference(mapMode);
> 			nDPtoLP_2 = mapMode.DPtoLP(2);
> 			nDPtoLP_3 = mapMode.DPtoLP(3);
> 			nDPtoLP_0 = mapMode.DPtoLP(0);
> 			dimension_nDPtoLP_0 = new Dimension(nDPtoLP_0, nDPtoLP_0);
> 		}
> 
> 		public Dimension getEllipseTextSize(Font f) {
> 			Dimension d = (Dimension) fontToEllipseTextSize.get(f);
> 			if (d == null) {
> 				IMapMode mapMode = (IMapMode) mapModeRef.get();
> 				d = FigureUtilities.getTextExtents(_ellipse, f);
> 				d.height = FigureUtilities.getFontMetrics(f).getHeight();
> 				d = new Dimension(mapMode.DPtoLP(d.width), mapMode
> 					.DPtoLP(d.height));
> 				fontToEllipseTextSize.put(f, d);
> 			}
> 			return d;
> 		}
> 
> 		public SingleIconInfo getSingleIconInfo(Image image) {
> 			if (image == null) {
> 				return SingleIconInfo.NULL_INFO;
> 			}
> 			SingleIconInfo info;
> 			for (int i = 0; i < MAX_IMAGE_INFO; ++i) {
> 				info = singleIconInfos[i];
> 				if (info == null) {
> 					info = new SingleIconInfo(image);
> 					singleIconInfos[i] = info;
> 					return info;
> 				}
> 				if (info.icon == image) {
> 					return info;
> 				}
> 			}
> 			int index = SingleIconInfo.count % MAX_IMAGE_INFO;
> 			info = new SingleIconInfo(image);
> 			singleIconInfos[index] = info;
> 			return info;
> 		}
> 	}
> 
60a134
> 
61a136
> 
62a138
> 
63a140
> 
67a145
> 
68a147
> 
69a149
> 
70a151
> 
72a154
> 	private MapModeConstants mapModeConstants;
75c157
< 	private String text = "";//$NON-NLS-1$
---
> 	private String text;
82a165,166
> 	private Dimension ellipseTextSize;
> 
87,90c171
< 	private Dimension cachedPrefSizeHint = new Dimension(-1, -1);
< 
< 	/** the cached hint used to calculate text size */
< 	private Dimension cachedTextSizeHint = new Dimension(-1, -1);
---
> 	private int cachedPrefSizeHint_width;
91a173
> 	private int cachedPrefSizeHint_height;
96c178,308
< 	private class IconInfo {
---
> 	private static abstract class IconInfo {
> 		/**
> 		 * Gets the icon at the index location.
> 		 * 
> 		 * @param i
> 		 *            the index to retrieve the icon of
> 		 * @return <code>Image</code> that corresponds to the given index.
> 		 */
> 		public abstract Image getIcon(int i);
> 		
> 		/**
> 		 * Gets the icon size of the icon at the given index.
> 		 * 
> 		 * @param i
> 		 * @return the <code>Dimension</code> that is the size of the icon at
> 		 *         the given index.
> 		 */
> 		public abstract Dimension getIconSize(IMapMode mapMode, int i);
> 
> 		/**
> 		 * @return the number of icons
> 		 */
> 		public abstract int getNumberofIcons();
> 		
> 		/**
> 		 * @return the <code>Dimension</code> that is the total size of all
> 		 *         the icons.
> 		 */
> 		public abstract Dimension getTotalIconSize(IMapMode mapMode);
> 
> 		public abstract void invalidate();
> 		
> 		/**
> 		 * Sets the icon at the index location.
> 		 * 
> 		 * @param icon
> 		 * @param i
> 		 */
> 		public abstract void setIcon(Image icon, int i);
> 		
> 		/**
> 		 * 
> 		 */
> 		public abstract int getMaxIcons();
> 
> 	}	
> 
> 	private static class SingleIconInfo
> 		extends IconInfo {	
> 
> 		static int count;
> 		
> 		public static final SingleIconInfo NULL_INFO = new SingleIconInfo(){
> 			public int getNumberofIcons() {
> 				return 0;
> 			}
> 		};
> 
> 		final Image icon;
> 
> 		/** total icon size */
> 		private Dimension totalIconSize;
> 
> 		private SingleIconInfo() {
> 			icon = null;//don't increment count, used only for NULL_INFO
> 		}
> 
> 		public SingleIconInfo(Image icon) {
> 			this.icon = icon;
> 			++count;
> 		}
> 
> 		public final int getMaxIcons() {
> 			return 1;
> 		}
> 
> 		
> 		public Image getIcon(int i) {
> 			if (i == 0) {
> 				return icon;
> 			} else if (i > 0) {
> 				return null;
> 			}
> 			throw new IndexOutOfBoundsException();
> 		}
> 
> 		
> 		public void setIcon(Image img, int i) {
> 			throw new UnsupportedOperationException();
> 		}
> 
> 		
> 		public Dimension getIconSize(IMapMode mapMode, int i) {
> 			if (i == 0) {
> 				return getTotalIconSize(mapMode);
> 			}
> 
> 			throw new IndexOutOfBoundsException();
> 		}
> 
> 		
> 		public int getNumberofIcons() {
> 			return 1;
> 		}
> 
> 		
> 		public Dimension getTotalIconSize(IMapMode mapMode) {
> 			if (totalIconSize != null)
> 				return totalIconSize;
> 
> 			if (icon != null && !icon.isDisposed()) {
> 				org.eclipse.swt.graphics.Rectangle imgBounds = icon.getBounds();
> 				totalIconSize = new Dimension(mapMode.DPtoLP(imgBounds.width),
> 					mapMode.DPtoLP(imgBounds.height));
> 			} else {
> 				totalIconSize = EMPTY_DIMENSION;
> 			}
> 
> 			return totalIconSize;
> 		}
> 
> 		
> 		public void invalidate() {
> 			totalIconSize = null;
> 		}
> 
> 	}
> 
> 	private static class MultiIconInfo
> 		extends IconInfo {
> 
98c310,311
< 		private ArrayList icons = new ArrayList();
---
> 		private ArrayList icons = new ArrayList(2);
> 
101a315,322
> 		public MultiIconInfo() {
> 			super();
> 		}
> 
> 		public int getMaxIcons() {
> 			return -1;
> 		}
> 
105c326,327
< 		 * @param i the index to retrieve the icon of
---
> 		 * @param i
> 		 *            the index to retrieve the icon of
122,124c344,346
< 			if (i >= icons.size())
< 			{
< 				for (int j=icons.size(); j<i; j++)
---
> 			int size = icons.size();
> 			if (i >= size) {
> 				for (int j = size; j < i; j++)
128,129c350
< 			}
< 			else
---
> 			} else
134a356
> 		 * 
136c358,359
< 		 * @return the <code>Dimension</code> that is the size of the icon at the given index.
---
> 		 * @return the <code>Dimension</code> that is the size of the icon at
> 		 *         the given index.
138c361
< 		public Dimension getIconSize(int i) {
---
> 		public Dimension getIconSize(IMapMode mapMode, int i) {
142,143c365,366
< 				return new Dimension(MapModeUtil.getMapMode(WrapLabel.this).DPtoLP(imgBounds.width), 
< 									MapModeUtil.getMapMode(WrapLabel.this).DPtoLP(imgBounds.height));
---
> 				return new Dimension(mapMode.DPtoLP(imgBounds.width), mapMode
> 					.DPtoLP(imgBounds.height));
156c379,380
< 		 * @return the <code>Dimension</code> that is the total size of all the icons.
---
> 		 * @return the <code>Dimension</code> that is the total size of all
> 		 *         the icons.
158c382
< 		public Dimension getTotalIconSize() {
---
> 		public Dimension getTotalIconSize(IMapMode mapMode) {
160a385,388
> 			int iconNum = getNumberofIcons();
> 			if (iconNum == 0) {
> 				return totalIconSize = EMPTY_DIMENSION;
> 			}
162,166c390,392
< 			totalIconSize = new Dimension(0, 0);
< 			
< 			for (int i = 0; i < getNumberofIcons(); i++) {
< 				Dimension iconSize = getIconSize(i);
< 				if (iconSize != null) {
---
> 			totalIconSize = new Dimension();
> 			for (int i = 0; i < iconNum; i++) {
> 				Dimension iconSize = getIconSize(mapMode, i);
171d396
< 			}
184c409,416
< 	private IconInfo iconInfo = null;
---
> 	private IconInfo iconInfo;
> 
> 	/** the cached hint used to calculate text size */	
> 	private int cachedTextSizeHint_width;
> 
> 	private int cachedTextSizeHint_height;
> 	
> 	
191a424
> 		text = "";//$NON-NLS-1$
193,197c426,430
< 		setTextAlignment(CENTER);
< 		setIconAlignment(CENTER);
< 		setLabelAlignment(CENTER);
< 		setTextWrapAlignment(LEFT);
< 		setTextPlacement(EAST);
---
> 		setAlignmentFlags(CENTER, FLAG_TEXT_ALIGN);
> 		setAlignmentFlags(CENTER, FLAG_ICON_ALIGN);
> 		setAlignmentFlags(CENTER, FLAG_LABEL_ALIGN);
> 		setAlignmentFlags(LEFT, FLAG_WRAP_ALIGN);
> 		setPlacementFlags(EAST, FLAG_TEXT_PLACEMENT);
207c440,444
< 		setText(s);
---
> 		if (s != null) {
> 			text = s;
> 		} else {
> 			text = "";//$NON-NLS-1$
> 		}
218c455,456
< 		setIcon(i);
---
> 		text = "";//$NON-NLS-1$
> 		iconInfo = new SingleIconInfo(i);
230,231c468,498
< 		setText(s);
< 		setIcon(i);
---
> 		if (s != null) {
> 			text = s;
> 		} else {
> 			text = "";//$NON-NLS-1$
> 		}
> 		iconInfo = new SingleIconInfo(i);
> 	}
> 	
> 	/**
> 	 * @return <code>IMapMode</code> used by this figure.
> 	 *         <code>IMapMode</code> that allows for the coordinate mapping
> 	 *         from device to logical units.
> 	 */
> 	private IMapMode getMapMode() {
> 		return (IMapMode) getMapModeConstants().mapModeRef.get();
> 	}
> 
> 	private MapModeConstants getMapModeConstants() {
> 		if (mapModeConstants == null) {
> 			IMapMode mapMode = MapModeUtil.getMapMode(this);
> 			while (mapMode instanceof IMapModeHolder) {
> 				mapMode = ((IMapModeHolder) mapMode).getMapMode();
> 			}
> 			mapModeConstants = (MapModeConstants) mapModeConstantsMap
> 				.get(mapMode);
> 			if (mapModeConstants == null) {
> 				mapModeConstants = new MapModeConstants(mapMode);
> 				mapModeConstantsMap.put(mapMode, mapModeConstants);
> 			}
> 		}
> 		return mapModeConstants;
235d501
< 		Insets insets = getInsets();
238c504
< 				loc.y = insets.top;
---
> 				loc.y = getInsets().top;
241c507
< 				loc.y = bounds.height - size.height - insets.bottom;
---
> 				loc.y = bounds.height - size.height - getInsets().bottom;
249d514
< 		Insets insets = getInsets();
252c517
< 				loc.x = insets.left;
---
> 				loc.x = getInsets().left;
255c520
< 				loc.x = bounds.width - size.width - insets.right;
---
> 				loc.x = bounds.width - size.width - getInsets().right;
262,264c527,528
< 	private void calculateAlignment() {
< 		Dimension iconSize = getTotalIconSize();
< 		switch (getTextPlacement()) {
---
> 	private void calculateAlignment(Dimension iconSize, int textPlacement) {
> 		switch (textPlacement) {
288,291d551
< 		int gap = getIconTextGap();
< 		if (!hasIcons() || getText().equals("")) //$NON-NLS-1$
< 			gap = 0;
< 		Dimension d = new Dimension(0, 0);
293,295c553,563
< 		if (getTextPlacement() == WEST || getTextPlacement() == EAST) {
< 			d.width = iconSize.width + gap + txtSize.width;
< 			d.height = Math.max(iconSize.height, txtSize.height);
---
> 		boolean isEmpty = (iconSize.width == 0 && iconSize.height == 0);
> 		int len = getText().length();
> 		if (len == 0 && isEmpty) {
> 			return new Dimension(txtSize.width, txtSize.height);
> 		}
> 		int gap = (len == 0 || isEmpty) ? 0
> 			: getIconTextGap();
> 		int placement = getTextPlacement();
> 		if (placement == WEST || placement == EAST) {
> 			return new Dimension(iconSize.width + gap + txtSize.width, Math
> 				.max(iconSize.height, txtSize.height));
297,298c565,566
< 			d.width = Math.max(iconSize.width, txtSize.width);
< 			d.height = iconSize.height + gap + txtSize.height;
---
> 			return new Dimension(Math.max(iconSize.width, txtSize.width),
> 				iconSize.height + gap + txtSize.height);
300d567
< 		return d;
305a573,584
> 		Dimension iconSize = getTotalIconSize();
> 		int textPlacement = getTextPlacement();
> 		calculatePlacement(iconSize, textPlacement);
> 		calculateAlignment(iconSize, textPlacement);
> 		Rectangle r = getBounds();
> 		Dimension ps = getPreferredSize(r.width, r.height);
> 		int w = (r.width - ps.width)
> 			+ (getTextSize().width - getSubStringTextSize().width);
> 		int h = r.height - ps.height;
> 		if (w == 0 && h == 0) {
> 			return;
> 		}
307,311c586
< 		calculatePlacement();
< 		calculateAlignment();
< 		Dimension offset = getSize().getDifference(
< 			getPreferredSize(getSize().width, getSize().height));
< 		offset.width += getTextSize().width - getSubStringTextSize().width;
---
> 		Dimension offset = new Dimension(w, h);
335c610
< 		switch (getTextPlacement()) {
---
> 		switch (textPlacement) {
350,353c625,627
< 	private void calculatePlacement() {
< 		int gap = getIconTextGap();
< 		if (!hasIcons() || text.equals("")) //$NON-NLS-1$
< 			gap = 0;
---
> 	private void calculatePlacement(Dimension iconSize, int textPlacement) {
> 		int gap = (getText().length() == 0 || (iconSize.width == 0 && iconSize.height == 0)) ? 0
> 			: getIconTextGap();
355,357c629
< 		Dimension iconSize = getTotalIconSize();
< 		
< 		switch (getTextPlacement()) {
---
> 		switch (textPlacement) {
376d647
< 
387c658,659
< 		return getTextExtents(getSubStringText(), getFont()); 
---
> 		Font f = getFont();
> 		return getTextExtents(getSubStringText(), f, getMapMode().DPtoLP(FigureUtilities.getFontMetrics(f).getHeight())); 
402c674,675
< 		return getTextExtents(getWrappedText(wHint, hHint), getFont());
---
> 		Font f = getFont();
> 		return getTextExtents(getWrappedText(wHint, hHint), f,getMapMode().DPtoLP(FigureUtilities.getFontMetrics(f).getHeight()));
437c710
< 		return !Dimension.SINGLETON.equals(getTotalIconSize());
---
> 		return (getNumberofIcons() > 0);
481c754
< 		return MapModeUtil.getMapMode(this).DPtoLP(3);
---
> 		return getMapModeConstants().nDPtoLP_3;
491,492c764,769
< 		if (getLayoutManager() != null)
< 			minSize.setSize(getLayoutManager().getMinimumSize(this, w, h));
---
> 		LayoutManager layoutManager = getLayoutManager();
> 		if (layoutManager != null)
> 			minSize.setSize(layoutManager.getMinimumSize(this, w, h));
> 		Font f = getFont();
> 		Dimension d = getEllipseTextSize().getIntersected(
> 			getTextExtents(getText(), f, getMapMode().DPtoLP(FigureUtilities.getFontMetrics(f).getHeight())));		
494,495d770
< 		Dimension d = getTextExtents(getEllipse(), getFont()).intersect(
< 			getTextExtents(getText(), getFont()));
508c783
< 		if (prefSize == null || wHint != cachedPrefSizeHint.width || hHint != cachedPrefSizeHint.height) {
---
> 		if (prefSize == null || wHint != cachedPrefSizeHint_width || hHint != cachedPrefSizeHint_height) {
512,513c787,789
< 			if (getLayoutManager() != null)
< 				prefSize.union(getLayoutManager().getPreferredSize(this, wHint,
---
> 			LayoutManager layoutManager = getLayoutManager();
> 			if (layoutManager != null) {
> 				prefSize.union(layoutManager.getPreferredSize(this, wHint,
514a791
> 			}
516,517c793,794
< 			cachedPrefSizeHint.width = wHint;
< 			cachedPrefSizeHint.height= hHint;
---
> 			cachedPrefSizeHint_width = wHint;
> 			cachedPrefSizeHint_height = hHint;
541c818,824
< 		Dimension shrink = getPreferredSize(getSize().width, getSize().height).getDifference(getSize());
---
> 		String theText = getText();
> 		int textLen = theText.length();
> 		if (textLen == 0) {
> 			return subStringText = "";//$NON-NLS-1$;;
> 		}
> 		Dimension size = getSize();
> 		Dimension shrink = getPreferredSize(size.width, size.height).getDifference(size);
543a827,830
> 		if (effectiveSize.height == 0) {
> 			return subStringText = "";//$NON-NLS-1$;
> 		}
> 		
545c832,835
< 		int fontHeight = MapModeUtil.getMapMode(this).DPtoLP(FigureUtilities.getFontMetrics(f).getHeight());
---
> 		FontMetrics metrics = FigureUtilities.getFontMetrics(f);
> 		IMapMode mm = getMapMode();
> 		int fontHeight = mm.DPtoLP(metrics.getHeight());
> 		int charAverageWidth = mm.DPtoLP(metrics.getAverageCharWidth());
546a837,839
> 		if (maxLines == 0) {
> 			return subStringText = "";//$NON-NLS-1$
> 		}
549,550c842
< 		StringBuffer remainingText = new StringBuffer(getText());
< 		int i = 0, j = 0;
---
> 		StringBuffer remainingText = new StringBuffer(theText);
551a844,847
> 		int effectiveSizeWidth = effectiveSize.width;
> 		int widthHint = Math.max(effectiveSizeWidth
> 			- getEllipseTextSize().width, 0);
> 		int i = 0, j = 0;
553c849
< 			i = getLineWrapPosition(remainingText.toString(), f, effectiveSize.width);
---
> 			i = getLineWrapPosition(remainingText.toString(), f, effectiveSizeWidth, fontHeight);
556c852
< 				accumlatedText.append("\n"); //$NON-NLS-1$
---
> 				accumlatedText.append('\n');
559,560c855
< 				int dotsWidth = getTextExtents(getEllipse(), f).width;
< 				i = getLargestSubstringConfinedTo(remainingText.toString(), f, Math.max(effectiveSize.width - dotsWidth, 0));
---
> 				i = getLargestSubstringConfinedTo(remainingText.toString(), f, widthHint, fontHeight, charAverageWidth);
569a865,867
> 	
> 	
> 	
579,580c877,879
< 		if (!isTextWrapped() || wHint == -1)
< 			return getText();
---
> 		String theText = getText();		
> 		if (wHint == -1 || theText.length() == 0 || !isTextWrapped())
> 			return theText;
583c882
< 		if (hasIcons()) {
---
> 		if (!(iconSize.width == 0 && iconSize.height == 0)) {
596a896,900
> 		
> 		if ((hHint == 0)||(wHint == 0)) {
> 			return "";//$NON-NLS-1$;
> 		}
> 		
597a902
> 		int fontHeight = getMapMode().DPtoLP(FigureUtilities.getFontMetrics(f).getHeight());
600d904
< 			int fontHeight = MapModeUtil.getMapMode(this).DPtoLP(FigureUtilities.getFontMetrics(f).getHeight());
601a906,908
> 			if (maxLines == 0) {
> 				return "";//$NON-NLS-1$;;
> 			}
605c912
< 		StringBuffer remainingText = new StringBuffer(getText());
---
> 		StringBuffer remainingText = new StringBuffer(theText);
609c916
< 			if ((i = getLineWrapPosition(remainingText.toString(), f, wHint)) == 0)
---
> 			if ((i = getLineWrapPosition(remainingText.toString(), f, wHint, fontHeight)) == 0)
613c920
< 				accumlatedText.append("\n"); //$NON-NLS-1$
---
> 				accumlatedText.append('\n');
632a940,955
> 	 * Returns the size of the String constant "..." the ellipse based on
> 	 * the currently used Map mode
> 	 * size.
> 	 * 
> 	 * @return the size of ellipse text
> 	 * 
> 	 */
> 	private Dimension getEllipseTextSize() {
> 		if (ellipseTextSize == null) {
> 			ellipseTextSize = getMapModeConstants().getEllipseTextSize(
> 				getFont());
> 		}
> 		return ellipseTextSize;
> 	}
> 
> 	/**
715c1038
< 		if (textSize == null || wHint != cachedTextSizeHint.width || hHint != cachedTextSizeHint.height) {
---
> 		if (textSize == null || wHint != cachedTextSizeHint_width || hHint != cachedTextSizeHint_height) {
717,718c1040,1041
< 			cachedTextSizeHint.width = wHint;
< 			cachedTextSizeHint.height= hHint;
---
> 			cachedTextSizeHint_width = wHint;
> 			cachedTextSizeHint_height= hHint;
727c1050,1051
< 		return getTextSize(getSize().width, getSize().height);
---
> 		Rectangle r = getBounds();
> 		return getTextSize(r.width, r.height);		
736a1061
> 		ellipseTextSize = null;
781a1107,1108
> 		String subString = getSubStringText();
> 		if (subString.length() > 0) {
785c1112
< 			paintText(graphics);
---
> 				paintText(graphics, subString);
787a1115,1117
> 			} else {
> 				paintText(graphics, subString);
> 			}
789d1118
< 		paintText(graphics);
796a1126
> 	 * @param subString The string to draw
798,799c1128
< 	private void paintText(Graphics graphics) {
< 		String subString = getSubStringText();
---
> 	private void paintText(Graphics graphics, String subString) {		
801d1129
< 
803,807c1131,1143
< 		int fontHeight = MapModeUtil.getMapMode(this).DPtoLP(FigureUtilities.getFontMetrics(f)
< 			.getHeight());
< 		int textWidth = getTextExtents(subString, f).width;
< 		int y = getTextLocation().y;
< 		
---
> 		FontMetrics fontMetrics = FigureUtilities.getFontMetrics(f);
> 		int fontHeight = getMapMode().DPtoLP(fontMetrics.getHeight());
> 		int fontHeightHalf = fontHeight / 2;
> 		int textWidth = getTextExtents(subString, f, fontHeight).width;
> 		Point p = getTextLocation();
> 		int y = p.y;
> 		int x = p.x;
> 		final int wrapAlignment = getTextWrapAlignment();
> 		boolean isUnderlined = isTextUnderlined();
> 		boolean isStrikedThrough = isTextStrikedThrough();
> 		Rectangle clipRect = new Rectangle();
> 		graphics.getClip(clipRect);
> 		int clipRectTopRight_x = clipRect.getTopRight().x;
810,812c1146,1147
< 		if (0 == FigureUtilities.getFontMetrics(f).getLeading()) {
< 			int offset = MapModeUtil.getMapMode(this).DPtoLP(2); // 2 is the leading area for default English
< 			y += offset;
---
> 		if (0 == fontMetrics.getLeading()) {
> 			y +=  getMapModeConstants().nDPtoLP_2; // 2 is the leading area for default English			
817,819c1152,1154
< 			int tokenWidth = getTextExtents(token, f).width;
< 			int x = getTextLocation().x;
< 			switch (getTextWrapAlignment()) {
---
> 			int tokenWidth = getTextExtents(token, f, fontHeight).width;
> 			
> 			switch (wrapAlignment) {
830,831d1164
< 			Rectangle clipRect = new Rectangle();
< 			graphics.getClip(clipRect);
833c1166,1167
< 			if (tokenWidth + x <= clipRect.getTopRight().x) {
---
> 			
> 			if (tokenWidth + x <= clipRectTopRight_x) {
844c1178
< 			if (isTextUnderlined())
---
> 			if (isUnderlined)
846,848c1180,1182
< 			if (isTextStrikedThrough())
< 				graphics.drawLine(x, y - fontHeight / 2 + 1, x + tokenWidth, y
< 					- fontHeight / 2 + 1);
---
> 			if (isStrikedThrough)
> 				graphics.drawLine(x, y - fontHeightHalf + 1, x + tokenWidth, y
> 					- fontHeightHalf + 1);
888,891c1222,1236
< 		if (iconInfo == null)
< 			iconInfo = new IconInfo();
< 			
< 		if (iconInfo.getIcon(index) == image)
---
> 		if (iconInfo == null) {
> 			if (index == 0) {
> 				iconInfo = getMapModeConstants().getSingleIconInfo(image);
> 			} else {
> 				iconInfo = new MultiIconInfo();
> 				iconInfo.setIcon(image, index);
> 			}
> 			revalidate();
> 			repaint();// Call repaint, in case the image dimensions are the same.           
> 		} else if (iconInfo.getIcon(index) != image) {
> 			if (iconInfo.getMaxIcons() == 1) {
> 				if (index == 0) {
> 					iconInfo = getMapModeConstants().getSingleIconInfo(image);
> 					revalidate();
> 					repaint();// Call repaint, in case the image dimensions are the same.
893c1238,1242
< 		
---
> 				}
> 				IconInfo oldIconInfo = iconInfo;
> 				iconInfo = new MultiIconInfo();
> 				iconInfo.setIcon(oldIconInfo.getIcon(0), 0);
> 			}
897a1247
> 	}
926c1276
< 		return iconInfo.getIconSize(index);
---
> 		return iconInfo.getIconSize(getMapMode(), index);
947c1297
< 		return iconInfo.getTotalIconSize();
---
> 		return iconInfo.getTotalIconSize(getMapMode());
1097c1447,1448
< 		 */}
---
> 		 */
> 	}
1258,1260c1609,1610
< 		figBounds
< 			.expand(new Insets(MapModeUtil.getMapMode(this).DPtoLP(2), 
< 							MapModeUtil.getMapMode(this).DPtoLP(2), 0, 0));
---
> 		int expansion = getMapModeConstants().nDPtoLP_2;
> 		figBounds.resize(expansion, expansion);
1272a1623
> 	 * @param fontHeight int <b>mapped already to logical units</b>.
1274c1625,1628
< 	private int getLineWrapPosition(String s, Font f, int w) {
---
> 	private int getLineWrapPosition(String s, Font f, int w, int fontHeight) {
> 		if (getTextExtents(s, f, fontHeight).width <= w) {
> 			return s.length();
> 		}
1283c1637
< 		if (getTextExtents(s.substring(start, end), f).width > w) {
---
> 		if (getTextExtents(s.substring(start, end), f, fontHeight).width > w) {
1293c1647
< 			&& getTextExtents(s.substring(start, end), f).width <= w);
---
> 			&& getTextExtents(s.substring(start, end), f, fontHeight).width <= w);
1304a1659,1660
> 	 * @param fontHeight int <b>mapped already to logical units</b>.
> 	 * @param charAverageWidth int <b>mapped already to logical units</b>.
1308,1313c1664,1667
< 	private int getLargestSubstringConfinedTo(String s, Font f, int w) {
< 		int min, max;
< 		float avg = MapModeUtil.getMapMode(this).DPtoLP(FigureUtilities.getFontMetrics(f)
< 			.getAverageCharWidth());
< 		min = 0;
< 		max = s.length() + 1;
---
> 	private int getLargestSubstringConfinedTo(String s, Font f, int w, int fontHeight, int charAverageWidth) {		
> 		float avg = charAverageWidth;
> 		int min = 0;
> 		int max = s.length() + 1;
1329c1683
< 			guessSize = getTextExtents(s.substring(0, guess), f).width;
---
> 			guessSize = getTextExtents(s.substring(0, guess), f, fontHeight).width;
1344c1698,1703
< 	private Dimension getTextExtents(String s, Font f) {
---
> 	private Dimension getTextExtents(String s, Font f, int fontHeight) {
> 		if (s.length() == 0) {
> 			return getMapModeConstants().dimension_nDPtoLP_0;
> 		} else {
> 			// height should be set using the font height and the number of
> 			// lines in the string			
1346,1351c1705,1708
<         // height should be set using the font height and the number of lines
<         // in the string 
<         int lineCount = getLineCount(s);
<         d.height = FigureUtilities.getFontMetrics(f).getHeight()*lineCount;
<      	return new Dimension(MapModeUtil.getMapMode(this).DPtoLP(d.width), 
< 							MapModeUtil.getMapMode(this).DPtoLP(d.height));
---
> 			IMapMode mapMode = getMapMode();
> 			d.width = mapMode.DPtoLP(d.width);
> 			d.height = fontHeight * new StringTokenizer(s, "\n").countTokens();//$NON-NLS-1$
> 			return d;			
1353,1356d1709
< 
<     private int getLineCount(String s) {
<         StringTokenizer tokenizer = new StringTokenizer(s, "\n"); //$NON-NLS-1$
<         return tokenizer.countTokens();
1358a1712,1713
>     
> 	
