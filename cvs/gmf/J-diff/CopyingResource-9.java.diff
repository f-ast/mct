2c2
<  * Copyright (c) 2004, 2005 IBM Corporation and others.
---
>  * Copyright (c) 2004, 2006 IBM Corporation and others.
38d37
< import org.eclipse.gmf.runtime.emf.core.resources.GMFResource;
51c50
< 	private CopyingResourceSet mslCopyingResourceSet;
---
> 	private CopyingResourceSet copyingResourceSet;
53,55c52,54
< 	public CopyingResource(XMLResource mslResource, URI uri,
< 			CopyingResourceSet mslCopyingResourceSet) {
< 		this(mslResource, uri, mslCopyingResourceSet, true);
---
> 	public CopyingResource(XMLResource resource, URI uri,
> 			CopyingResourceSet copyingResourceSet) {
> 		this(resource, uri, copyingResourceSet, true);
58,59c57,58
< 	public CopyingResource(XMLResource mslResource, URI uri,
< 			CopyingResourceSet mslCopyingResourceSet, boolean regenerateIds) {
---
> 	public CopyingResource(XMLResource resource, URI uri,
> 			CopyingResourceSet copyingResourceSet, boolean regenerateIds) {
61,63c60,62
< 		this.xmlResource = mslResource;
< 		this.mslCopyingResourceSet = mslCopyingResourceSet;
< 		setEncoding(mslResource.getEncoding());
---
> 		this.xmlResource = resource;
> 		this.copyingResourceSet = copyingResourceSet;
> 		setEncoding(resource.getEncoding());
66,68c65,67
< 		getDefaultSaveOptions().putAll(mslResource.getDefaultSaveOptions());
< 		mslCopyingResourceSet.getResources().add(this);
< 		mslCopyingResourceSet.getResourcesMap().put(mslResource, this);
---
> 		getDefaultSaveOptions().putAll(resource.getDefaultSaveOptions());
> 		copyingResourceSet.getResources().add(this);
> 		copyingResourceSet.getResourcesMap().put(resource, this);
82c81
< 		Iterator it = xmlResource.getAllContents();
---
> 		Iterator it = getXMLResource().getAllContents();
91c90
< 				"Can't call load on MSLCopyingResource resource"));//$NON-NLS-1$
---
> 				"Can't call load on CopyingResource resource"));//$NON-NLS-1$
96,161c95
< 		return new XMIHelperImpl(this) {
< 
< 			/**
< 			 * @see org.eclipse.emf.ecore.xmi.XMLHelper#deresolve(org.eclipse.emf.common.util.URI)
< 			 */
< 			public URI deresolve(URI anUri) {
< 
< 				// if this both target and container are within a platform resource and
< 				// projects
< 				// or plugins are different then do not deresolve.
< 				if (((EMFCoreConstants.PLATFORM_SCHEME.equals(anUri.scheme())) && (EMFCoreConstants.PLATFORM_SCHEME
< 					.equals(resourceURI.scheme())))
< 					&& ((anUri.segmentCount() > 2) && (resourceURI.segmentCount() > 2))
< 					&& ((!anUri.segments()[0].equals(resourceURI.segments()[0])) || (!anUri
< 						.segments()[1].equals(resourceURI.segments()[1]))))
< 					return anUri;
< 
< 				return super.deresolve(anUri);
< 			}
< 
< 			/*
< 			 * (non-Javadoc)
< 			 * 
< 			 * @see org.eclipse.emf.ecore.xmi.impl.XMLHelperImpl#getHREF(org.eclipse.emf.ecore.EObject)
< 			 */
< 			public String getHREF(EObject obj) {
< 				EObject eObj = obj;
< 				
< 				if (obj.eIsProxy()) {
< 					eObj = EcoreUtil.resolve(obj, xmlResource);
< 					if (eObj == null) {
< 						eObj = null;
< 					}
< 				}
< 				
< 				if ((eObj != null) && (eObj.eResource() != null)) {
< 					URI objectURI = getHREF(eObj.eResource(), eObj);
< 					objectURI = deresolve(objectURI);
< 					return objectURI.toString();
< 				}
< 				return super.getHREF(obj);
< 			}
< 
< 			protected URI getHREF(Resource otherResource, EObject obj) {
< 				if ((otherResource instanceof CopyingResource) == false) {
< 					CopyingResource copyingResource = (CopyingResource) getResourcesMap()
< 						.get(otherResource);
< 					if (copyingResource != null) {
< 						otherResource = copyingResource;
< 					}
< 				}
< 				if (otherResource instanceof GMFResource) {
< 					String qName = EMFCoreUtil.getQualifiedName(obj, true);
< 					if (qName.length() > 0) {
< 						StringBuffer buffer = new StringBuffer(otherResource
< 							.getURIFragment(obj));
< 						buffer.append(EMFCoreConstants.FRAGMENT_SEPARATOR);
< 						buffer.append(Util.encodeQualifiedName(qName));
< 						return otherResource.getURI().appendFragment(
< 							buffer.toString());
< 					}
< 				}
< 				
< 				return super.getHREF(otherResource, obj);
< 			}
< 		};
---
> 		return new CopyingHelper(this);
193c127
< 				"Can't call load on MSLCopyingResource resource"));//$NON-NLS-1$
---
> 				"Can't call load on CopyingResource resource"));//$NON-NLS-1$
197,235c131
< 		return new XMISaveImpl(createXMLHelper()) {
< 
< 			/**
< 			 * @see org.eclipse.emf.ecore.xmi.impl.XMLSaveImpl#sameDocMany(org.eclipse.emf.ecore.EObject,
< 			 *      org.eclipse.emf.ecore.EStructuralFeature)
< 			 */
< 			protected int sameDocMany(EObject o, EStructuralFeature f) {
< 				InternalEList values = (InternalEList) helper.getValue(o, f);
< 				if (values.isEmpty()) {
< 					return SKIP;
< 				}
< 
< 				for (Iterator i = values.basicIterator(); i.hasNext();) {
< 					EObject value = (EObject) i.next();
< 					if (value.eIsProxy() || (isInResource(value) == false)) {
< 						return CROSS_DOC;
< 					}
< 				}
< 
< 				return SAME_DOC;
< 			}
< 
< 			/**
< 			 * @see org.eclipse.emf.ecore.xmi.impl.XMLSaveImpl#sameDocSingle(org.eclipse.emf.ecore.EObject,
< 			 *      org.eclipse.emf.ecore.EStructuralFeature)
< 			 */
< 			protected int sameDocSingle(EObject o, EStructuralFeature f) {
< 				EObject value = (EObject) helper.getValue(o, f);
< 				if (value == null) {
< 					return SKIP;
< 				} else if (value.eIsProxy()) {
< 					return CROSS_DOC;
< 				} else {
< 					return (isInResource(value)) ? SAME_DOC
< 						: CROSS_DOC;
< 				}
< 			}
< 
< 		};
---
> 		return new CopyingSave(createXMLHelper());
243c139
< 			if (((InternalEObject) eObject).eDirectResource() == xmlResource) {
---
> 			if (((InternalEObject) eObject).eDirectResource() == getXMLResource()) {
254c150
< 		return xmlResource.getContents();
---
> 		return getXMLResource().getContents();
276c172
< 		EObject eObj = xmlResource.getEObject(id);
---
> 		EObject eObj = getXMLResource().getEObject(id);
284c180
< 	 * @return Returns the mslCopyingResourceSet.
---
> 	 * @return Returns the CopyingResourceSet.
287c183
< 		return mslCopyingResourceSet;
---
> 		return copyingResourceSet;
323c219
< 		return xmlResource.getEObjectToExtensionMap();
---
> 		return getXMLResource().getEObjectToExtensionMap();
340c236
< 		for (Iterator iter = xmlResource.getAllContents(); iter.hasNext(); ) {
---
> 		for (Iterator iter = getXMLResource().getAllContents(); iter.hasNext(); ) {
352a249,396
> 	
> 	/**
> 	 * Gets the XML resource that contains the model content to be copied.
> 	 * 
> 	 * @return the XML resource
> 	 */
> 	protected XMLResource getXMLResource() {
> 		return xmlResource;
> 	}
> 	
> 	/**
> 	 * Helper implementation for the CopyingResource.
> 	 */
> 	protected class CopyingHelper extends XMIHelperImpl {
> 		
> 		public CopyingHelper() {
> 			super();
> 		}
> 		  
> 		public CopyingHelper(XMLResource resource) {
> 		    super(resource);
> 		}
> 
> 		/**
> 		 * @see org.eclipse.emf.ecore.xmi.XMLHelper#deresolve(org.eclipse.emf.common.util.URI)
> 		 */
> 		public URI deresolve(URI anUri) {
> 
> 			// if this both target and container are within a platform resource and
> 			// projects
> 			// or plugins are different then do not deresolve.
> 			if (((EMFCoreConstants.PLATFORM_SCHEME.equals(anUri.scheme())) && (EMFCoreConstants.PLATFORM_SCHEME
> 				.equals(resourceURI.scheme())))
> 				&& ((anUri.segmentCount() > 2) && (resourceURI.segmentCount() > 2))
> 				&& ((!anUri.segments()[0].equals(resourceURI.segments()[0])) || (!anUri
> 					.segments()[1].equals(resourceURI.segments()[1]))))
> 				return anUri;
> 
> 			return super.deresolve(anUri);
> 		}
> 
> 		/*
> 		 * (non-Javadoc)
> 		 * 
> 		 * @see org.eclipse.emf.ecore.xmi.impl.XMLHelperImpl#getHREF(org.eclipse.emf.ecore.EObject)
> 		 */
> 		public String getHREF(EObject obj) {
> 			EObject eObj = obj;
> 			
> 			if (obj.eIsProxy()) {
> 				eObj = EcoreUtil.resolve(obj, getXMLResource());
> 				if (eObj == obj) {
> 					// use super.getHREF() if we can't resolve the proxy
> 					eObj = null;
> 				}
> 			}
> 			
> 			if (eObj != null) {
> 				Resource resource = eObj.eResource();
> 				if (resource != null) {
> 					URI objectURI = getHREF(resource, eObj);
> 					objectURI = deresolve(objectURI);
> 					return objectURI.toString();
> 				}
> 			}
> 			
> 			return super.getHREF(obj);
> 		}
> 
> 		protected URI getHREF(Resource otherResource, EObject obj) {
> 			if (!(otherResource instanceof CopyingResource)) {
> 				CopyingResource copyingResource = (CopyingResource) getResourcesMap()
> 					.get(otherResource);
> 				if (copyingResource != null) {
> 					otherResource = copyingResource;
> 				}
> 			}
> 
> 			String qName = EMFCoreUtil.getQualifiedName(obj, true);
> 			if (qName.length() > 0) {
> 				StringBuffer buffer = new StringBuffer(otherResource
> 					.getURIFragment(obj));
> 				buffer.append(EMFCoreConstants.FRAGMENT_SEPARATOR);
> 				buffer.append(Util.encodeQualifiedName(qName));
> 				buffer.append(EMFCoreConstants.FRAGMENT_SEPARATOR);
> 				return otherResource.getURI().appendFragment(
> 					buffer.toString());
> 			}
> 			
> 			return super.getHREF(otherResource, obj);
> 		}
> 	};
> 	
> 	/**
> 	 * Save implementation for the CopyingResource.
> 	 */
> 	public class CopyingSave extends XMISaveImpl {
> 		
> 		public CopyingSave(XMLHelper helper) {
> 			super(helper);
> 		}
> 		
> 		public CopyingSave(Map options, XMLHelper helper, String encoding) {
> 			super(options, helper, encoding);
> 		}
> 
> 		public CopyingSave(Map options, XMLHelper helper, String encoding,
> 				String xmlVersion) {
> 			super(options, helper, encoding, xmlVersion);
> 		}
> 
> 		/**
> 		 * @see org.eclipse.emf.ecore.xmi.impl.XMLSaveImpl#sameDocMany(org.eclipse.emf.ecore.EObject,
> 		 *      org.eclipse.emf.ecore.EStructuralFeature)
> 		 */
> 		protected int sameDocMany(EObject o, EStructuralFeature f) {
> 			InternalEList values = (InternalEList) helper.getValue(o, f);
> 			if (values.isEmpty()) {
> 				return SKIP;
> 			}
> 
> 			for (Iterator i = values.basicIterator(); i.hasNext();) {
> 				EObject value = (EObject) i.next();
> 				if (value.eIsProxy() || (isInResource(value) == false)) {
> 					return CROSS_DOC;
> 				}
> 			}
> 
> 			return SAME_DOC;
> 		}
> 
> 		/**
> 		 * @see org.eclipse.emf.ecore.xmi.impl.XMLSaveImpl#sameDocSingle(org.eclipse.emf.ecore.EObject,
> 		 *      org.eclipse.emf.ecore.EStructuralFeature)
> 		 */
> 		protected int sameDocSingle(EObject o, EStructuralFeature f) {
> 			EObject value = (EObject) helper.getValue(o, f);
> 			if (value == null) {
> 				return SKIP;
> 			} else if (value.eIsProxy()) {
> 				return CROSS_DOC;
> 			} else {
> 				return (isInResource(value)) ? SAME_DOC
> 					: CROSS_DOC;
> 			}
> 		}
> 
> 	};
