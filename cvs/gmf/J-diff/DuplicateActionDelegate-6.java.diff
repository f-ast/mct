18a19
> import org.eclipse.core.commands.ExecutionException;
20a22,23
> import org.eclipse.core.runtime.IStatus;
> import org.eclipse.core.runtime.Status;
21a25,26
> import org.eclipse.emf.transaction.TransactionalEditingDomain;
> import org.eclipse.emf.transaction.util.TransactionUtil;
23,29d27
< import org.eclipse.jface.viewers.IStructuredSelection;
< import org.eclipse.jface.viewers.StructuredSelection;
< import org.eclipse.ui.IObjectActionDelegate;
< import org.eclipse.ui.IWorkbenchPart;
< import org.eclipse.ui.IWorkbenchWindowActionDelegate;
< 
< import org.eclipse.gmf.runtime.common.core.command.CommandResult;
31,32c29,30
< import org.eclipse.gmf.runtime.diagram.core.internal.services.semantic.DuplicateElementsRequest;
< import org.eclipse.gmf.runtime.diagram.core.internal.services.semantic.SemanticService;
---
> import org.eclipse.gmf.runtime.common.core.util.Log;
> import org.eclipse.gmf.runtime.common.core.util.Trace;
34a33,35
> import org.eclipse.gmf.runtime.diagram.ui.internal.DiagramUIDebugOptions;
> import org.eclipse.gmf.runtime.diagram.ui.internal.DiagramUIPlugin;
> import org.eclipse.gmf.runtime.diagram.ui.internal.DiagramUIStatusCodes;
37a39,41
> import org.eclipse.gmf.runtime.emf.type.core.ElementTypeRegistry;
> import org.eclipse.gmf.runtime.emf.type.core.IElementType;
> import org.eclipse.gmf.runtime.emf.type.core.requests.DuplicateElementsRequest;
39a44,48
> import org.eclipse.jface.viewers.IStructuredSelection;
> import org.eclipse.jface.viewers.StructuredSelection;
> import org.eclipse.ui.IObjectActionDelegate;
> import org.eclipse.ui.IWorkbenchPart;
> import org.eclipse.ui.IWorkbenchWindowActionDelegate;
66c75
< 			request = new DuplicateElementsRequest();
---
> 			request = new DuplicateElementsRequest(getEditingDomain(getStructuredSelection()));
70,73c79,82
< 		if (cmd != null && cmd.isExecutable())
< 			;
< 		{
< 			CommandResult result = getCommandManager().execute(cmd);
---
> 		if (cmd != null && cmd.canExecute()) {
>             try {
>                 IStatus status = cmd.execute(progressMonitor, null);
>                 setStatus(status);
75c84
< 			if (result.getStatus().isOK()) {
---
>     			if (status.isOK()) {
83a93,106
>             } catch (ExecutionException e) {
>                 IStatus status = new Status(Status.ERROR, DiagramUIPlugin
>                     .getPluginId(), DiagramUIStatusCodes.COMMAND_FAILURE, e
>                     .getLocalizedMessage(), e);
>                 setStatus(status);
> 
>                 Trace.catching(DiagramUIPlugin.getInstance(),
>                     DiagramUIDebugOptions.EXCEPTIONS_CATCHING, getClass(),
>                     "doRun", e); //$NON-NLS-1$
> 
>                 Log.error(DiagramUIPlugin.getInstance(),
>                     DiagramUIStatusCodes.COMMAND_FAILURE, e
>                         .getLocalizedMessage(), e);
>             }
101c124
< 				new DuplicateElementsRequest());
---
> 				new DuplicateElementsRequest(getEditingDomain(selection)));
103c126
< 		return (cmd != null && cmd.isExecutable());
---
> 		return (cmd != null && cmd.canExecute());
130c153,159
< 			return SemanticService.getInstance().getCommand(request);
---
>             
>             IElementType elementType = ElementTypeRegistry.getInstance()
>                 .getElementType(request.getEditHelperContext());
>             
>             if (elementType != null) {
>                 return elementType.getEditCommand(request);
>             }
195a225,248
>     public static TransactionalEditingDomain getEditingDomain(
>             IStructuredSelection selection) {
> 
>         for (Iterator i = selection.iterator(); i.hasNext();) {
>             EObject element = (EObject) ((IAdaptable) i.next())
>                 .getAdapter(EObject.class);
> 
>             if (element != null) {
>                 TransactionalEditingDomain editingDomain = TransactionUtil
>                     .getEditingDomain(element);
> 
>                 if (editingDomain != null) {
>                     return editingDomain;
>                 }
>             }
>         }
>         return null;
>     }
>     
>     // Documentation copied from superclass
>     protected TransactionalEditingDomain getEditingDomain() {
>         return getEditingDomain(getStructuredSelection());
>     }
> 
