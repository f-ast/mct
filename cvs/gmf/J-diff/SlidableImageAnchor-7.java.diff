2c2
<  * Copyright (c) 2004 IBM Corporation and others.
---
>  * Copyright (c) 2004, 2007 IBM Corporation and others.
26,28d25
< import org.eclipse.swt.graphics.Image;
< import org.eclipse.swt.graphics.ImageData;
< 
30a28,29
> import org.eclipse.swt.graphics.Image;
> import org.eclipse.swt.graphics.ImageData;
33c32,34
<  * @author oboyko
---
>  * Implements sliding connection anchor functionality for Image figures
>  * 
>  * @author aboyko
35d35
<  * Window - Preferences - Java - Code Style - Code Templates
42c42
< 		static private Map imageAnchorLocationMap = new WeakHashMap();
---
> 		static private Map<Image, ImageAnchorLocation> imageAnchorLocationMap = new WeakHashMap<Image, ImageAnchorLocation>();
54c54
< 			ImageAnchorLocation imgAnchorLoc = (ImageAnchorLocation) imageAnchorLocationMap
---
> 			ImageAnchorLocation imgAnchorLoc = imageAnchorLocationMap
64c64
< 		private Map locationMap = new HashMap();
---
> 		private Map<Integer, Point> locationMap = new HashMap<Integer, Point>();
163c163
< 				ptIntersect = (Point) locationMap.get(new Integer(angle));
---
> 				ptIntersect = locationMap.get(new Integer(angle));
300,302c300,301
< 	/* 
< 	 * (non-Javadoc)
< 	 * @see org.eclipse.gmf.runtime.gef.ui.figures.SlidableAnchor#getLocation(org.eclipse.draw2d.geometry.Point, org.eclipse.draw2d.geometry.Point)
---
> 	/* (non-Javadoc)
> 	 * @see org.eclipse.gmf.runtime.draw2d.ui.figures.BaseSlidableAnchor#getLocation(org.eclipse.draw2d.geometry.Point, org.eclipse.draw2d.geometry.Point)
308,309c307,309
< 		Rectangle ownerRect = new Rectangle(getBox());
< 		PointList intersections = getIntersectionPoints(ownReference, foreignReference);
---
> 		Rectangle ownerRect = getBox();
> 		PointList intersections = getIntersectionPoints(ownReference,
> 				foreignReference);
311,316c311,322
< 			Point ptRef = PointListUtilities.pickFarestPoint(intersections, foreignReference);
< 			Point ptEdge = PointListUtilities.pickClosestPoint(intersections,foreignReference);
< 			Point loc = ImageAnchorLocation.getInstance(getImage()).getLocation(ptRef, ptEdge, ownerRect, isDefaultAnchor());
< 			if (loc != null)
< 				loc = normalizeToStraightlineTolerance(foreignReference, loc, 3);
< 			return loc;
---
> 			Point ptRef = PointListUtilities.pickFarestPoint(intersections,
> 					foreignReference);
> 			Point ptEdge = PointListUtilities.pickClosestPoint(intersections,
> 					foreignReference);
> 			Point location = ImageAnchorLocation.getInstance(getImage())
> 					.getLocation(ptRef, ptEdge, ownerRect,
> 							getReferencePoint().equals(ownReference) && isDefaultAnchor());
> 			if (location != null) {
> 				location = normalizeToStraightlineTolerance(foreignReference,
> 						location, 3);
> 			}
> 			return location;
319a326
> 
