2c2
<  * Copyright (c) 2003, 2005 IBM Corporation and others.
---
>  * Copyright (c) 2003, 2006 IBM Corporation and others.
14a15
> import java.util.Collections;
17a19,21
> import org.eclipse.core.commands.ExecutionException;
> import org.eclipse.core.commands.operations.IOperationHistory;
> import org.eclipse.core.commands.operations.OperationHistoryFactory;
19a24,25
> import org.eclipse.core.runtime.IStatus;
> import org.eclipse.core.runtime.NullProgressMonitor;
24,33c30,32
< import org.eclipse.jface.viewers.ISelection;
< import org.eclipse.jface.viewers.IStructuredSelection;
< import org.eclipse.swt.graphics.GC;
< import org.eclipse.swt.widgets.Composite;
< import org.eclipse.ui.IWorkbenchPart;
< import org.eclipse.ui.views.properties.tabbed.AbstractPropertySection;
< import org.eclipse.ui.views.properties.tabbed.ITabbedPropertySheetPageContributor;
< import org.eclipse.ui.views.properties.tabbed.TabbedPropertySheetPage;
< 
< import org.eclipse.gmf.runtime.common.core.command.CommandManager;
---
> import org.eclipse.emf.transaction.TransactionalEditingDomain;
> import org.eclipse.emf.transaction.util.TransactionUtil;
> import org.eclipse.emf.workspace.util.WorkspaceSynchronizer;
41d39
< import org.eclipse.gmf.runtime.diagram.ui.properties.internal.DiagramPropertiesStatusCodes;
43a42
> import org.eclipse.gmf.runtime.diagram.ui.properties.internal.DiagramPropertiesStatusCodes;
47c46
< import org.eclipse.gmf.runtime.emf.commands.core.command.AbstractModelCommand;
---
> import org.eclipse.gmf.runtime.emf.commands.core.command.AbstractTransactionalCommand;
54a54,61
> import org.eclipse.jface.viewers.ISelection;
> import org.eclipse.jface.viewers.IStructuredSelection;
> import org.eclipse.swt.graphics.GC;
> import org.eclipse.swt.widgets.Composite;
> import org.eclipse.ui.IWorkbenchPart;
> import org.eclipse.ui.views.properties.tabbed.AbstractPropertySection;
> import org.eclipse.ui.views.properties.tabbed.ITabbedPropertySheetPageContributor;
> import org.eclipse.ui.views.properties.tabbed.TabbedPropertySheetPage;
267c274,275
< 		CompositeCommand compCmd = new CompositeCommand(actionName, commands);
---
>         CompositeCommand command = new CompositeCommand(actionName, commands);
>         IOperationHistory history = OperationHistoryFactory.getOperationHistory();
269c277,279
< 		CommandResult result = CommandManager.getDefault().execute(compCmd);
---
>         try {
>             IStatus status = history.execute(command,
>                 new NullProgressMonitor(), null);
271c281
< 		if (result.getStatus().getCode() == DiagramPropertiesStatusCodes.CANCELLED)
---
>             if (status.getCode() == DiagramPropertiesStatusCodes.CANCELLED) {
272a283,292
>             }
> 
>         } catch (ExecutionException e) {
>             Trace.catching(DiagramPropertiesPlugin.getDefault(),
>                 DiagramPropertiesDebugOptions.EXCEPTIONS_CATCHING, getClass(),
>                 "executeAsCompositeCommand", e); //$NON-NLS-1$
>             Log.error(DiagramPropertiesPlugin.getDefault(),
>                 DiagramPropertiesStatusCodes.IGNORED_EXCEPTION_WARNING, e
>                     .getLocalizedMessage(), e);
>         }
276c296
< 		return result;
---
> 		return command.getCommandResult();
560c580
< 		return createCommandInternal(name, res, runnable);
---
> 		return createCommandInternal(name, res.eResource(), runnable);
566c586
< 	private ICommand createCommandInternal(String name, Object res,
---
> 	private ICommand createCommandInternal(String name, Resource res,
569c589,594
< 		ICommand command = new AbstractModelCommand(name, res) {
---
>         ICommand command = new AbstractTransactionalCommand(getEditingDomain(), name,
>             Collections.singletonList(WorkspaceSynchronizer.getFile(res))) {
> 
>             protected CommandResult doExecuteWithResult(
>                     IProgressMonitor monitor, IAdaptable info)
>                 throws ExecutionException {
571d595
< 			protected CommandResult doExecute(IProgressMonitor progressMonitor) {
574c598
< 				return newOKCommandResult();
---
>                 return CommandResult.newOKCommandResult();
580a605,620
>     /**
>      * Gets the editing domain from my EObject input.
>      * 
>      * @return my editing domain
>      */
>     protected TransactionalEditingDomain getEditingDomain() {
> 
>         EObject eObjectInput = getEObject();
> 
>         if (eObjectInput != null) {
>             return TransactionUtil.getEditingDomain(eObjectInput);
>         }
> 
>         return null;
>     }
> 
