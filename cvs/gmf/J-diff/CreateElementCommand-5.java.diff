2c2
<  * Copyright (c) 2005 IBM Corporation and others.
---
>  * Copyright (c) 2005, 2006 IBM Corporation and others.
14,15c14,15
< import java.util.Collection;
< 
---
> import org.eclipse.core.commands.ExecutionException;
> import org.eclipse.core.runtime.IAdaptable;
21d20
< 
23a23,24
> import org.eclipse.gmf.runtime.emf.core.util.EMFCoreUtil;
> import org.eclipse.gmf.runtime.emf.core.util.PackageUtil;
34,35c35
< public class CreateElementCommand
< 	extends EditElementCommand {
---
> public class CreateElementCommand extends EditElementCommand {
67c67,70
< 	protected CommandResult doExecute(IProgressMonitor progressMonitor) {
---
> 	protected CommandResult doExecuteWithResult(IProgressMonitor monitor,
>             IAdaptable info)
>         throws ExecutionException {
> 
77,78c80,81
< 		if (configureCommand != null && configureCommand.isExecutable()) {
< 			configureCommand.execute(progressMonitor);
---
>         if (configureCommand != null && configureCommand.canExecute()) {
>             configureCommand.execute(monitor, info);
85c88
< 		return newOKCommandResult(newElement);
---
>         return CommandResult.newOKCommandResult(newElement);
95,96c98,100
< 		ConfigureRequest configureRequest = new ConfigureRequest(newElement,
< 			getElementType());
---
> 		ConfigureRequest configureRequest = new ConfigureRequest(
>             getEditingDomain(), newElement, getElementType());
>         
108c112
< 
---
> 		EReference containment = getContainmentFeature();
111,120c115,116
< 		EObject element = eClass.getEPackage().getEFactoryInstance().create(
< 			eClass);
< 
< 		if (getContainmentFeature() != null) {
< 			EObject container = getElementToEdit();
< 
< 			if (container != null) {
< 				if (getContainmentFeature().isMany()) {
< 					((Collection) container.eGet(getContainmentFeature()))
< 						.add(element);
---
> 		if (containment != null) {
> 			EObject element = getElementToEdit();
122,125c118,119
< 				} else {
< 					container.eSet(getContainmentFeature(), element);
< 				}
< 			}
---
> 			if (element != null)
> 				return EMFCoreUtil.create(element, containment, eClass);
128c122
< 		return element;
---
> 		return null;
174a169,182
> 
> 		if (containmentFeature == null) {
> 			EClass classToEdit = getEClassToEdit();
> 
> 			if (classToEdit != null) {
> 				IElementType type = getElementType();
> 
> 				if (type != null) {
> 					containmentFeature = PackageUtil.findFeature(classToEdit,
> 							type.getEClass());
> 				}
> 			}
> 		}
> 
206,211c214
< 	/*
< 	 * (non-Javadoc)
< 	 * 
< 	 * @see org.eclipse.gmf.runtime.common.core.command.AbstractCommand#isExecutable()
< 	 */
< 	public boolean isExecutable() {
---
> 	public boolean canExecute() {
225c228,234
< 			return result && super.isExecutable();
---
> 
> 			result = result
> 					&& PackageUtil.canContain(getEClassToEdit(),
> 							getContainmentFeature(), getElementType()
> 									.getEClass(), false);
> 
> 			return result && super.canExecute();
