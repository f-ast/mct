12a13,14
> import java.util.HashMap;
> import java.util.Map;
19c21
< import org.eclipse.emf.ecore.impl.EReferenceImpl;
---
> import org.eclipse.emf.ecore.util.EcoreUtil;
25,26d26
< 	private EStructuralFeature mySavedFeature;
< 	private EReferenceImpl myFakeFeatureWithNarrowType;
27a28
> 	private Map<EStructuralFeature, EStructuralFeature> myNarrowedFeatureTypes;
58,59c59,61
< 		if (feature != null && feature.equals(myFakeFeatureWithNarrowType)) {
< 			feature = mySavedFeature;
---
> 		EStructuralFeature originalFeature = getOriginalFeature(feature);
> 		if (originalFeature != null) {
> 			feature = originalFeature;
77,81c79,81
< 			mySavedFeature = result;
< 			myFakeFeatureWithNarrowType = new EReferenceImpl() {};
< 			myFakeFeatureWithNarrowType.setName(result.getName());
< 			myFakeFeatureWithNarrowType.setEType(narrow);
< 			return myFakeFeatureWithNarrowType;
---
> 			EStructuralFeature fake = addNarrowedFeature(result);
> 			fake.setEType(narrow);
> 			return fake;
105a106,121
> 	
> 	protected EStructuralFeature getOriginalFeature(EStructuralFeature feature) {
> 		if (myNarrowedFeatureTypes == null) {
> 			myNarrowedFeatureTypes = new HashMap<EStructuralFeature, EStructuralFeature>();
> 		}
> 		return myNarrowedFeatureTypes.get(feature);
> 	}
> 	
> 	protected EStructuralFeature addNarrowedFeature(EStructuralFeature originalFeature) {
> 		if (myNarrowedFeatureTypes == null) {
> 			myNarrowedFeatureTypes = new HashMap<EStructuralFeature, EStructuralFeature>();
> 		}
> 		EStructuralFeature result = (EStructuralFeature) EcoreUtil.copy(originalFeature);
> 		myNarrowedFeatureTypes.put(result, originalFeature);
> 		return result;
> 	}
