3d2
< import java.io.IOException;
5d3
< import java.util.Arrays;
25d22
< import org.eclipse.emf.ecore.EObject;
29d25
< import org.eclipse.gmf.gmfgraph.FigureGallery;
31d26
< import org.eclipse.gmf.internal.graphdef.codegen.StandaloneGalleryConverter;
52a48
> 	private ConverterOptions myOptions;
62d57
< 		List/*FigureGallery*/ galleries = new ArrayList(5);
64,68c59
< 		loadFromSelection(rs, galleries);
< 		if (galleries.isEmpty()) {
< 			MessageDialog.openInformation(getShell(), "Nothing to do", "No figure galleries found in the selected files, nothing to do");
< 			return;
< 		}
---
> 		final Resource[] input = loadFromSelection(rs);
74,76c65,72
< 		FigureGallery[] input = (FigureGallery[]) galleries.toArray(new FigureGallery[galleries.size()]);
< 		StandaloneGenerator.Config config = new StandaloneGenerator.ConfigImpl(pluginId, pluginId, dialog.isUseMapMode());
< 		final StandaloneGenerator generator = new StandaloneGenerator(input, config, dialog.getFigureQualifiedNameSwitch());
---
> 		final StandaloneGenerator.Config config = new StandaloneGenerator.ConfigImpl(pluginId, pluginId, dialog.isUseMapMode());
> 		final ConverterOutcome converterOutcome = new ConverterOutcome(getOptions(), input);
> 		final IStatus inputCheck = converterOutcome.checkInputAgainstOptions();
> 		if (!inputCheck.isOK()) {
> 			MessageDialog.openInformation(getShell(), "Nothing to do", inputCheck.getMessage());
> 			return;
> 		}
> 		final StandaloneGenerator generator = new StandaloneGenerator(converterOutcome.getProcessor(), config, dialog.getFigureQualifiedNameSwitch());
82c78
< 				// setUser(true); FIXME fixed after M5, uncoment when switching to M6 
---
> 				setUser(true); 
91c87,89
< 					StandaloneGalleryConverter converter = new StandaloneGalleryConverter(generator.getGenerationInfo());					
---
> 					URI galleryURI = URI.createPlatformResourceURI(decideOnDestinationFile("bundled").getFullPath().toString());
> 					URI canvasURI = URI.createPlatformResourceURI(decideOnDestinationFile("mirrored").getFullPath().toString());
> 					return converterOutcome.createResources(rs, galleryURI, canvasURI, config);					
93,97d90
< 					IStatus result = saveToFile(decideOnDestinationFile("bundled"), converter.convertFigureGallery());
< 					if (result.isOK()){
< 						result = saveToFile(decideOnDestinationFile("mirrored"), converter.mirrorDiagramElements(rs.getResources()));
< 					}
< 					return result;
119c112
< 					IProject p = ResourcesPlugin.getWorkspace().getRoot().getProject(getConfig().getPluginID());
---
> 					IProject p = ResourcesPlugin.getWorkspace().getRoot().getProject(config.getPluginID());
134,150d126
< 			
< 			private StandaloneGenerator.Config getConfig(){
< 				return generator.getGenerationInfo().getConfig();
< 			}
< 
< 			private IStatus saveToFile(IFile outputFile, EObject root) {
< 				if (root != null){
< 					Resource outputResource = rs.createResource(URI.createPlatformResourceURI(outputFile.getFullPath().toString()));
< 					outputResource.getContents().add(root);
< 					try {
< 						outputResource.save(null);
< 					} catch (IOException e) {
< 						return new Status(IStatus.ERROR, "org.eclipse.gmf.graphdef.codegen.ui", 0, e.getMessage(), e);
< 					}
< 				}
< 				return Status.OK_STATUS;
< 			}
154,157c130,133
< 	private void loadFromSelection(ResourceSet rs, List/*FigureGallery*/ galleries) {
< 		final FigureFinder extractor = new FigureFinder();
< 		for (Iterator it = mySelectedFiles.iterator(); it.hasNext();) {
< 			try {
---
> 	private Resource[] loadFromSelection(ResourceSet rs) {
> 		Resource[] rv = new Resource[mySelectedFiles.size()];
> 		int i = 0;
> 		for (Iterator it = mySelectedFiles.iterator(); it.hasNext(); i++) {
159,165c135
< 				Resource r = rs.getResource(URI.createPlatformResourceURI(next.getFullPath().toString()), true);
< 				FigureGallery[] fg = extractor.findFigures(r);
< 				galleries.addAll(Arrays.asList(fg));
< 			} catch (Exception ex) {
< 				ex.printStackTrace();
< 				// FIXME log
< 			}
---
> 			rv[i] = rs.getResource(URI.createPlatformResourceURI(next.getFullPath().toString()), true);
166a137
> 		return rv;
187a159,172
> 	private ConverterOptions getOptions() {
> 		if (myOptions == null) {
> 			myOptions = loadOptions();
> 		}
> 		return myOptions;
> 	}
> 
> 	private ConverterOptions loadOptions() {
> 		ConverterOptions options = new ConverterOptions();
> 		options.needMirroredCanvas = true;
> 		options.needMirroredGalleries = true;
> 		return options;
> 	}
> 
