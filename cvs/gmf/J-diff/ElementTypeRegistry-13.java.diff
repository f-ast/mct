73,74c73,75
< 	 * Metamodel type descriptors stored by EClass. Each value is a collection of
< 	 * MetamodelTypeDescriptors.
---
> 	 * Metamodel type descriptors stored by nsURI. Each key is a namespace URI
> 	 * and each value is a map, whose key is an EClass name and whose value is a
> 	 * collection of MetamodelTypeDescriptors.
76c77
< 	private final Map metamodelTypeDescriptorsByEClass;
---
> 	private final Map metamodelTypeDescriptorsByNsURI;
108c109
< 		metamodelTypeDescriptorsByEClass = new HashMap();
---
> 		metamodelTypeDescriptorsByNsURI = new HashMap();
593,594c594,598
< 		Collection descriptors = (Collection) metamodelTypeDescriptorsByEClass
< 				.get(eClass);
---
> 		Map metamodelTypeDescriptorsByEClass = (Map) metamodelTypeDescriptorsByNsURI
> 				.get(eClass.getEPackage().getNsURI());
> 		Collection descriptors = metamodelTypeDescriptorsByEClass != null ? (Collection) metamodelTypeDescriptorsByEClass
> 				.get(eClass.getName())
> 				: null;
612,613c616,619
< 				descriptors = (Collection) metamodelTypeDescriptorsByEClass
< 						.get(nextEClass);
---
> 				// same nsURI is assumed because we're looking at supertypes of the eclass
> 				descriptors = metamodelTypeDescriptorsByEClass != null ? (Collection) metamodelTypeDescriptorsByEClass
> 						.get(nextEClass.getName())
> 						: null;
927c933,942
< 		EClass eClass = typeDescriptor.getEClass();
---
> 		String nsURI = typeDescriptor.getNsURI();
> 		String eClassName = typeDescriptor.getEClassName();
> 
> 		Map metamodelTypeDescriptorsByEClass = (Map) metamodelTypeDescriptorsByNsURI
> 				.get(nsURI);
> 
> 		if (metamodelTypeDescriptorsByEClass == null) {
> 			metamodelTypeDescriptorsByEClass = new HashMap();
> 			metamodelTypeDescriptorsByNsURI.put(nsURI, metamodelTypeDescriptorsByEClass);
> 		}
929,930c944
< 		Collection descriptors = (Collection) metamodelTypeDescriptorsByEClass
< 				.get(eClass);
---
> 		Collection descriptors = (Collection) metamodelTypeDescriptorsByEClass.get(eClassName);
934c948
< 			metamodelTypeDescriptorsByEClass.put(eClass, descriptors);
---
> 			metamodelTypeDescriptorsByEClass.put(eClassName, descriptors);
