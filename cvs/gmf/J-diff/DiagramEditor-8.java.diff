27a28
> import org.eclipse.emf.ecore.util.EcoreUtil;
29a31
> import org.eclipse.emf.transaction.util.TransactionUtil;
36d37
< import org.eclipse.gef.commands.Command;
37a39,40
> import org.eclipse.gef.commands.CommandStackEvent;
> import org.eclipse.gef.commands.CommandStackEventListener;
70a74,93
> 	private CommandStackEventListener mySaveListener = new CommandStackEventListener() {
> 		public void stackChanged(CommandStackEvent event) {
> 			if (event.isPostChangeEvent() && isSaved()) {
> 				getCommandStack().markSaveLocation();
> 			}
> 		}
> 		private boolean isSaved() {
> 			for(Iterator it = getEditingDomain().getResourceSet().getResources().iterator(); it.hasNext(); ) {
> 				Resource next = (Resource) it.next();
> 				if (!next.isLoaded()) {
> 					continue;
> 				}
> 				if (!next.isTrackingModification() || next.isModified()) {
> 					return false;
> 				}
> 			}
> 			return true;
> 		}
> 	};
> 
139a163
> 		getCommandStack().addCommandStackEventListener(mySaveListener);
145a170
> 			getCommandStack().removeCommandStackEventListener(mySaveListener);
149a175,180
> 		ForceTrackingModificationAdapter adapter = (ForceTrackingModificationAdapter) EcoreUtil.getExistingAdapter(getEditingDomain().getResourceSet(), ForceTrackingModificationAdapter.class);
> 		assert adapter != null;
> 		adapter.release();
> 		if (adapter.isReleased()) {
> 			getEditingDomain().getResourceSet().eAdapters().remove(adapter);
> 		}
259c290,302
< 	protected TransactionalEditingDomain getEditingDomain(IEditorInput editorInput) {
---
> 	protected TransactionalEditingDomain getEditingDomain(IEditorInput input) {
> 		if (input instanceof DiagramEditorInput) {
> 			TransactionalEditingDomain result = TransactionUtil.getEditingDomain(((DiagramEditorInput) input).getDiagram());
> 			if (result != null) {
> 				ForceTrackingModificationAdapter adapter = (ForceTrackingModificationAdapter) EcoreUtil.getExistingAdapter(result.getResourceSet(), ForceTrackingModificationAdapter.class);
> 				if (adapter == null) {
> 					adapter = new ForceTrackingModificationAdapter();
> 					result.getResourceSet().eAdapters().add(adapter);
> 				}
> 				adapter.acquire();
> 			}
> 			return result;
> 		}
286,320d328
< 		domain.setCommandStack(new CommandStack(){
< 			@Override
< 			public void execute(Command command) {
< 				super.execute(command);
< 				if (isSaved()) {
< 					markSaveLocation();
< 				}
< 			}
< 			@Override
< 			public void undo() {
< 				super.undo();
< 				if (isSaved()) {
< 					markSaveLocation();
< 				}
< 			}
< 			@Override
< 			public void redo() {
< 				super.redo();
< 				if (isSaved()) {
< 					markSaveLocation();
< 				}
< 			}
< 			private boolean isSaved() {
< 				for(Iterator it = getEditingDomain().getResourceSet().getResources().iterator(); it.hasNext(); ) {
< 					Resource next = (Resource) it.next();
< 					if (!next.isLoaded()) {
< 						continue;
< 					}
< 					if (!next.isTrackingModification() || next.isModified()) {
< 						return false;
< 					}
< 				}
< 				return true;
< 			}
< 		});
362a371,390
> 		@Override
> 		public boolean isAdapterForType(Object type) {
> 			return ForceTrackingModificationAdapter.class.equals(type);
> 		}
> 		public void acquire() {
> 			myRefCount++;
> 		}
> 
> 		public void release() {
> 			if (myRefCount == 0) {
> 				throw new IllegalStateException();
> 			}
> 			myRefCount--;
> 		}
> 
> 		public boolean isReleased() {
> 			return myRefCount == 0;
> 		}
> 
> 		private int myRefCount;
