2c2
<  * Copyright (c) 2003, 2006 IBM Corporation and others.
---
>  * Copyright (c) 2003, 2007 IBM Corporation and others.
70c70
< 		Rectangle clip = getParentRectangle();
---
> 		Rectangle clip = getVisibleExtendedBounds();
71a72,76
> 
>         if (useLocalCoordinates()) {
>             graphics.translate(getBounds().x + getInsets().left, getBounds().y
>                 + getInsets().top);
> 		}
107a113,117
> 		if (useLocalCoordinates()) {
>             x = x - getBounds().x - getInsets().left;
>             y = y - getBounds().y - getInsets().top;
>         }
> 
218c228
< 		Rectangle rectangle = getParentRectangle();
---
> 		Rectangle rectangle = getExtendedBounds();
222,223c232,246
<     private Rectangle getParentRectangle() {
<         return _getParentRectangle();
---
>     /**
>      * Gets the area of the extended bounds which is visible, that is, that is
>      * contained within the viewport bounds. This is needed so that when this
>      * shape is within a scrollable compartment, the border items are not
>      * visible when they are outside the visible area.
>      * 
>      * @return the area of the extended bounds which is visible
>      */
>     private Rectangle getVisibleExtendedBounds() {
>         Rectangle extendedRect = getExtendedBounds().getCopy();
>         translateToAbsolute(extendedRect);
>         Rectangle parentRect = getViewportBounds().getIntersection(
>             extendedRect);
>         translateToRelative(parentRect);
>         return parentRect;
228c251,255
<      * the client area of the parent.
---
>      * the client area of the parent. The viewport area is required so that
>      * border items outside the viewport are not shown (i.e. when they are
>      * scrolled out of view).
>      * 
>      * @return returns the viewport client area in absolute coordinates
230c257
<     private Rectangle _getParentRectangle() {
---
>     private Rectangle getViewportBounds() {
231a259,260
>         getParent().getParent().translateToParent(rect);
>         getParent().getParent().translateToAbsolute(rect);
235a265,267
>             port.translateToParent(portRect);
>             port.translateToAbsolute(portRect);
> 
243,245c275,276
< 	private IFigure getMainFigure(BorderItemContainerFigure gf) {
< 		BorderedNodeFigure gpf = (BorderedNodeFigure) gf.getParent();
< 		return gpf.getMainFigure();
---
> 	public IFigure getMainFigure() {
>         return ((BorderedNodeFigure) getParent()).getMainFigure();
257c288
< 		IFigure fig = getMainFigure(this);
---
> 		IFigure fig = getMainFigure();
264c295
< 				fig = getMainFigure((BorderItemContainerFigure) fig);
---
> 				fig = ((BorderItemContainerFigure) fig).getMainFigure();
289c320
< 			Rectangle rectBounds = getParentRectangle();
---
> 			Rectangle rectBounds = getExtendedBounds();
303,308c334,336
<     
< 
<     public Rectangle getExtendedBounds(){
<         if (extendedBounds == null)
<             extendedBounds = getExtendedBounds(getParent()).getCopy();
<         return extendedBounds;
---
>     public void validate() {
>         extendedBounds = null;
>         super.validate();
311,321c339,348
<        
<     private Rectangle getExtendedBounds(IFigure figure) {
<         if (figure == null)
<             return getBounds().getCopy();
<         else {
<             Rectangle _bounds = figure.getBounds().getCopy();
<             if (figure instanceof BorderedNodeFigure){
<                 BorderedNodeFigure borderedFigure = (BorderedNodeFigure)figure;
<                 BorderItemContainerFigure borderedItemContainer = (BorderItemContainerFigure)borderedFigure.getBorderItemContainer();
<                 if (borderedItemContainer!=null){
<                     Iterator iterator = borderedItemContainer.getChildren().iterator();
---
>     /**
>      * Gets the extended bounds of the figure which includes the bounds of all
>      * the border item figures.
>      * 
>      * @return the extended bounds
>      */
>     public Rectangle getExtendedBounds() {
>         if (extendedBounds == null) {
>             extendedBounds = getBounds().getCopy();
>             Iterator iterator = getChildren().iterator();
323,333c350,356
<                         Figure element = (Figure) iterator.next();
<                         if (element instanceof BorderedNodeFigure){
<                             BorderedNodeFigure childbFigure = (BorderedNodeFigure)element;
<                             BorderItemContainerFigure childBorderedItemContainer = (BorderItemContainerFigure)childbFigure.getBorderItemContainer();
<                             if (childBorderedItemContainer!=null)
<                                 _bounds.union(childBorderedItemContainer.getExtendedBounds());
<                             else
<                                 _bounds.union(childbFigure.getBounds());
<                         }
<                         else
<                             _bounds.union(element.getBounds());
---
>                 Figure childFigure = (Figure) iterator.next();
>                 Rectangle childBounds = (childFigure instanceof IExpandableFigure) ? ((IExpandableFigure) childFigure)
>                     .getExtendedBounds()
>                     : childFigure.getBounds(); 
>                 if (useLocalCoordinates()) {
>                     childBounds = childBounds.getCopy();
>                     childBounds.translate(getLocation());
334a358
>                 extendedBounds.union(childBounds);
337,338c361
<             return _bounds;
<         }
---
>         return extendedBounds;
