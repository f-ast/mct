2c2
<  * Copyright (c) 2006 Borland Software Corporation and others.
---
>  * Copyright (c) 2006, 2007 Borland Software Corporation and others.
13,15d12
< import java.io.InputStream;
< 
< import org.eclipse.core.resources.IFile;
17,19c14,15
< import org.eclipse.core.runtime.IProgressMonitor;
< import org.eclipse.gmf.runtime.diagram.ui.resources.editor.ide.wizards.EditorWizardPage;
< import org.eclipse.gmf.runtime.diagram.ui.resources.editor.util.DiagramFileCreator;
---
> import org.eclipse.core.runtime.Path;
> import org.eclipse.emf.common.util.URI;
21,22c17,19
< import org.eclipse.ui.IWorkbench;
< import org.eclipse.ui.IWorkbenchWindow;
---
> import org.eclipse.osgi.util.NLS;
> import org.eclipse.swt.widgets.Composite;
> import org.eclipse.ui.dialogs.WizardNewFileCreationPage;
24c21,24
< import org.eclipse.core.resources.ResourcesPlugin;
---
> /**
>  * @generated
>  */
> public class GMFGraphCreationWizardPage extends WizardNewFileCreationPage {
26c26,29
< import org.eclipse.gmf.graphdef.editor.edit.parts.CanvasEditPart;
---
> 	/**
> 	 * @generated
> 	 */
> 	private final String fileExtension;
31c34,37
< public class GMFGraphCreationWizardPage extends EditorWizardPage {
---
> 	public GMFGraphCreationWizardPage(String pageName, IStructuredSelection selection, String fileExtension) {
> 		super(pageName, selection);
> 		this.fileExtension = fileExtension;
> 	}
33a40,41
> 	 * Override to create files with this extension.
> 	 * 
36,39c44,45
< 	public GMFGraphCreationWizardPage(IWorkbench workbench, IStructuredSelection selection) {
< 		super("CreationWizardPage", workbench, selection); //$NON-NLS-1$
< 		setTitle("Create GMFGraph Diagram");
< 		setDescription("Create a new GMFGraph diagram.");
---
> 	protected String getExtension() {
> 		return fileExtension;
45,47c51,52
< 	public IFile createAndOpenDiagram(IPath containerPath, String fileName, InputStream initialContents, String kind, IWorkbenchWindow dWindow, IProgressMonitor progressMonitor, boolean saveDiagram) {
< 		return GMFGraphDiagramEditorUtil.createAndOpenDiagram(getDiagramFileCreator(), containerPath, fileName, initialContents, kind, dWindow, progressMonitor, isOpenNewlyCreatedDiagramEditor(),
< 				saveDiagram);
---
> 	public URI getURI() {
> 		return URI.createPlatformResourceURI(getFilePath().toString());
53,54c58,67
< 	protected String getDefaultFileName() {
< 		return "default"; //$NON-NLS-1$
---
> 	protected IPath getFilePath() {
> 		IPath path = getContainerFullPath();
> 		if (path == null) {
> 			path = new Path(""); //$NON-NLS-1$
> 		}
> 		String fileName = getFileName();
> 		if (fileName != null) {
> 			path = path.append(fileName);
> 		}
> 		return path;
60,61c73,96
< 	public DiagramFileCreator getDiagramFileCreator() {
< 		return GMFGraphDiagramFileCreator.getInstance();
---
> 	private String getUniqueFileName(IPath containerFullPath, String fileName) {
> 		if (containerFullPath == null) {
> 			containerFullPath = new Path(""); //$NON-NLS-1$
> 		}
> 		if (fileName == null || fileName.trim().length() == 0) {
> 			fileName = "default"; //$NON-NLS-1$
> 		}
> 		IPath filePath = containerFullPath.append(fileName);
> 		String extension = getExtension();
> 		if (extension != null && !extension.equals(filePath.getFileExtension())) {
> 			filePath = filePath.addFileExtension(extension);
> 		}
> 
> 		extension = filePath.getFileExtension();
> 		fileName = filePath.removeFileExtension().lastSegment();
> 		int i = 1;
> 		while (GMFGraphDiagramEditorUtil.exists(filePath)) {
> 			i++;
> 			filePath = containerFullPath.append(fileName + i);
> 			if (extension != null) {
> 				filePath = filePath.addFileExtension(extension);
> 			}
> 		}
> 		return filePath.lastSegment();
67,68c102,105
< 	protected String getDiagramKind() {
< 		return CanvasEditPart.MODEL_ID;
---
> 	public void createControl(Composite parent) {
> 		super.createControl(parent);
> 		setFileName(getUniqueFileName(getContainerFullPath(), getFileName()));
> 		setPageComplete(validatePage());
75,77c112
< 		if (super.validatePage()) {
< 			String fileName = getFileName();
< 			if (fileName == null) {
---
> 		if (!super.validatePage()) {
80,84c115,117
< 			// appending file extension to correctly process file names including "." symbol
< 			IPath path = getContainerFullPath().append(getDiagramFileCreator().appendExtensionToFileName(fileName));
< 			path = path.removeFileExtension().addFileExtension("gmfgraph"); //$NON-NLS-1$
< 			if (ResourcesPlugin.getWorkspace().getRoot().exists(path)) {
< 				setErrorMessage("Model File already exists: " + path.lastSegment());
---
> 		String extension = getExtension();
> 		if (extension != null && !getFilePath().toString().endsWith("." + extension)) {
> 			setErrorMessage(NLS.bind("File name should have ''{0}'' extension.", extension));
89,91d121
< 		return false;
< 	}
< 
