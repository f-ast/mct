32d31
< import org.eclipse.gmf.internal.xpand.ResourceManager;
38a38,39
> import org.eclipse.gmf.internal.xpand.util.ParserException;
> import org.eclipse.gmf.internal.xpand.util.ParserException.ErrorLocationInfo;
43a45
> 	private WorkspaceResourceManager resourceManager;
45,94c47,49
< 	class OawDeltaVisitor implements IResourceDeltaVisitor {
< 		private IProgressMonitor monitor;
< 
< 		public OawDeltaVisitor(final IProgressMonitor monitor) {
< 			this.monitor = monitor;
< 		}
< 
< 		public boolean visit(final IResourceDelta delta) throws CoreException {
< 			final IResource resource = delta.getResource();
< 			if (resource.isDerived()) {
< 				return false;
< 			}
< 			if ((resource instanceof IFile)) {
< 				IFile file = (IFile) resource;
< 				if (!isFileOfInterest(file)) {
< 					return false;
< 				}
< 				switch (delta.getKind()) {
< 				case IResourceDelta.ADDED:
< 					reloadResource(file);
< 					break;
< 				case IResourceDelta.REMOVED:
< 					handleRemovement(file);
< 					break;
< 				case IResourceDelta.CHANGED:
< 					reloadResource(file);
< 					break;
< 				}
< 			}
< 			monitor.worked(1);
< 			return true;
< 		}
< 
< 	}
< 
< 	private class XpandResourceVisitor implements IResourceVisitor {
< 		private IProgressMonitor monitor;
< 
< 		public XpandResourceVisitor(final IProgressMonitor monitor) {
< 			this.monitor = monitor;
< 		}
< 
< 		public boolean visit(final IResource resource) {
< 			if (!resource.isDerived() && (resource instanceof IFile) && isFileOfInterest((IFile) resource)) {
< 				reloadResource((IFile) resource);
< 			}
< 			monitor.worked(1);
< 			return true;
< 		}
< 	}
---
> 	// XXX again, using map as mere pairs
> 	private final Map<XtendResource, IFile> xtendResourcesToAnalyze = new HashMap<XtendResource, IFile>();
> 	private final Map<XpandResource, IFile> xpandResourcesToAnalyze = new HashMap<XpandResource, IFile>();
104,106c59,64
< 	// XXX again, using map as mere pairs
< 	private final Map<XtendResource, IFile> xtendResourcesToAnalyze = new HashMap<XtendResource, IFile>();
< 	private final Map<XpandResource, IFile> xpandResourcesToAnalyze = new HashMap<XpandResource, IFile>();
---
> 	@Override
> 	protected void startupOnInitialize() {
> 		// TODO Auto-generated method stub
> 		super.startupOnInitialize();
> 		resourceManager = new WorkspaceResourceManager(getProject());
> 	}
111a70
> 				System.err.println("First build, kind:" + kind + " and is FULLBUILD:" + (kind == FULL_BUILD));
145,149d103
< 	private static void updateMarkers(IFile resource, Set<AnalysationIssue> issues) {
<         OawMarkerManager.deleteMarkers(resource);
<         OawMarkerManager.addMarkers(resource, issues.toArray(new AnalysationIssue[issues.size()]));
< 	}
< 
154a109
> 		try {
165a121,128
> 		} catch (ParserException ex) {
> 			updateMarkers(resource, ex.getParsingErrors());
> 		} catch (Exception ex) {
> 			Activator.logError(ex);
> 			// perhaps, depending on exception type (Core|IO) we can decide to keep old markers? 
> 			OawMarkerManager.deleteMarkers(resource);
> 			OawMarkerManager.addErrorMarker(resource, ex.getMessage(), -1, -1);
> 		}
167a131
> 
178c142,146
< 		delta.accept(new OawDeltaVisitor(monitor));
---
> 		delta.accept(new XpandResourceVisitor(monitor));
> 	}
> 
> 	private WorkspaceResourceManager getResourceManager() {
> 		return resourceManager;
181,182c149,206
< 	protected ResourceManager getResourceManager() {
< 		return Activator.getResourceManager(getProject());
---
> 	private static void updateMarkers(IFile resource, Set<AnalysationIssue> issues) {
>         OawMarkerManager.deleteMarkers(resource);
>         OawMarkerManager.addMarkers(resource, issues.toArray(new AnalysationIssue[issues.size()]));
> 	}
> 
> 	private static void updateMarkers(IFile resource, ErrorLocationInfo[] parsingErrors) {
>         OawMarkerManager.deleteMarkers(resource);
>         OawMarkerManager.addMarkers(resource, parsingErrors);
> 	}
> 
> 	private class XpandResourceVisitor implements IResourceVisitor, IResourceDeltaVisitor {
> 		private IProgressMonitor monitor;
> 
> 		public XpandResourceVisitor(final IProgressMonitor monitor) {
> 			this.monitor = monitor;
> 		}
> 
> 		public boolean visit(final IResource resource) {
> 			if (!resource.isDerived() && (resource instanceof IFile) && isFileOfInterest((IFile) resource)) {
> 				reloadResource((IFile) resource);
> 			}
> 			monitor.worked(1);
> 			return true;
> 		}
> 
> 		public boolean visit(final IResourceDelta delta) throws CoreException {
> 			final IResource resource = delta.getResource();
> 			if (resource.isDerived()) {
> 				return false;
> 			}
> 			if ((resource instanceof IFile)) {
> 				IFile file = (IFile) resource;
> 				if (!isFileOfInterest(file)) {
> 					return false;
> 				}
> 				switch (delta.getKind()) {
> 				case IResourceDelta.ADDED:
> 					reloadResource(file);
> 					break;
> 				case IResourceDelta.REMOVED:
> 					handleRemovement(file);
> 					break;
> 				case IResourceDelta.CHANGED:
> 					reloadResource(file);
> 					break;
> 				}
> 			} else if (resource instanceof IProject) {
> 				// forget about project in resource manager
> 				if (delta.getKind() == IResourceDelta.REMOVED) {
> 					System.err.println("Project removed:" + resource.getName());
> 				}
> 				if (delta.getKind() == IResourceDelta.OPEN) {
> 					System.err.println("Project open:" + ((IProject) resource).isOpen());
> 				}
> 			}
> 			monitor.worked(1);
> 			return true;
> 		}
