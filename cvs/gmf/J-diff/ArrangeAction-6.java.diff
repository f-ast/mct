13a14
> import java.util.ArrayList;
14a16,17
> import java.util.HashSet;
> import java.util.Iterator;
16a20
> import java.util.Set;
24a29
> import org.eclipse.gef.commands.CompoundCommand;
26a32
> import org.eclipse.gmf.runtime.diagram.ui.IPreferenceConstants;
28a35
> import org.eclipse.gmf.runtime.diagram.ui.editparts.DiagramEditPart;
32d38
< import org.eclipse.gmf.runtime.diagram.ui.preferences.IPreferenceConstants;
82c88,97
< 		if (!getOperationSet().isEmpty()) {
---
> 		if (isArrangeAll()){
> 			CompoundCommand arrangeCC = new CompoundCommand(getLabel());
> 			List elements = getOperationSet();
> 			for (Iterator iter = elements.iterator(); iter.hasNext();) {
> 				EditPart element = (EditPart) iter.next();
> 				arrangeCC.add(element.getCommand(getTargetRequest()));
> 			}
> 			return arrangeCC;
> 		}
> 		else if (getOperationSet().size() >= 2) {
84c99
< 			if (parent != null) {
---
> 			if (parent != null)
87d101
< 		}
123d136
< 
127,129c140,142
< 			if( !selection.isEmpty() && selection.get(0) instanceof ShapeCompartmentEditPart )
< 				return createOperationSet( ((ShapeCompartmentEditPart)selection.get(0)).getChildren());
< 
---
> 			if( !selection.isEmpty()){
> 				return getElementsToArrange(selection);
> 			}
281c294,300
< 			if (operationSet != null && !operationSet.isEmpty()) {
---
> 			if (isArrangeAll()){
> 				for (Iterator iter = operationSet.iterator(); iter.hasNext();) {
> 					IGraphicalEditPart element = (IGraphicalEditPart) iter.next();
> 					AnimationFigureHelper.getInstance().animate(element.getFigure());
> 				}
> 			}
> 			else if (operationSet != null && !operationSet.isEmpty()) {
287a307,334
> 	/**
> 	 * @param selection
> 	 * @return
> 	 */
> 	private List getElementsToArrange(List selection) {
> 		Set parentsSet = new HashSet();
> 		for (Iterator iter = selection.iterator(); iter.hasNext();) {
> 			Object element = iter.next();
> 			if (element instanceof ShapeCompartmentEditPart || element instanceof DiagramEditPart){
> 				parentsSet.add(element);
> 			} else if (element instanceof EditPart){
> 				EditPart gEditPart = 
> 					(EditPart)element;
> 				EditPart parentEditPart = gEditPart.getParent();
> 				if (parentEditPart instanceof ShapeCompartmentEditPart ||
> 					parentEditPart instanceof DiagramEditPart){
> 					if (!parentsSet.contains(parentEditPart))
> 						parentsSet.add(parentEditPart);
> 				}
> 			}
> 		}
> 		if (parentsSet.isEmpty())
> 			return Collections.EMPTY_LIST;
> 		List elements = new ArrayList();
> 		elements.addAll(parentsSet);			
> 		return elements;
> 	}
> 
