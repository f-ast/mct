2c2
<  * Copyright (c) 2004 IBM Corporation and others.
---
>  * Copyright (c) 2004,2006 IBM Corporation and others.
13a14
> import java.text.ParseException;
22a24,27
> import org.eclipse.gmf.runtime.diagram.ui.internal.pagesetup.PageSetupPageType;
> import org.eclipse.gmf.runtime.diagram.ui.internal.properties.WorkspaceViewerProperties;
> import org.eclipse.gmf.runtime.diagram.ui.parts.DiagramGraphicalViewer;
> import org.eclipse.gmf.runtime.diagram.ui.parts.IDiagramGraphicalViewer;
31a37
> import org.eclipse.jface.preference.IPreferenceStore;
37a44,45
> import com.ibm.icu.text.NumberFormat;
> 
58a67,71
>         if (helper.getDlgPrintRangePages()) {
>             diagramPrinter.setPrintRangePageSelection(true);
>             diagramPrinter.setPrintRangePages(helper.getDlgPagesFrom(), helper.getDlgPagesTo());
>         }
>         
60,61c73,74
< 			diagramPrinter.setRows(helper.getDlgScaleFitToM());
< 			diagramPrinter.setColumns(helper.getDlgScaleFitToN());
---
>             diagramPrinter.setColumns(helper.getDlgScaleFitToM());
> 			diagramPrinter.setRows(helper.getDlgScaleFitToN());
88a102
>         IPreferenceStore pref = null;
94a109,177
>             
>             //get the preferences store currently in use...
>             
>             if (editorPart instanceof IDiagramWorkbenchPart) {
>                 
>                 IDiagramGraphicalViewer viewer = ((IDiagramWorkbenchPart)editorPart).getDiagramGraphicalViewer();
>                 if (viewer instanceof DiagramGraphicalViewer) {
>                     
>                     //default to diagram settings...
>                     pref = ((DiagramGraphicalViewer) viewer)
>                         .getWorkspaceViewerPreferenceStore();
>                     
>                     if (pref.getBoolean(WorkspaceViewerProperties.PREF_USE_WORKSPACE_SETTINGS)) {
>                         
>                         //get workspace settings...
>                         if (((IDiagramWorkbenchPart)editorPart).getDiagramEditPart().
>                                 getDiagramPreferencesHint().getPreferenceStore() != null)
>                             pref = (IPreferenceStore)((IDiagramWorkbenchPart)editorPart).getDiagramEditPart().
>                                 getDiagramPreferencesHint().getPreferenceStore(); 
>                     }
>                 }
>             }
>             
>             //set the preferences for the print dialog...
>             if (pref != null) {
>                 
>                 //the orientation...
>                 helper.setDlgOrientation(pref.getBoolean(WorkspaceViewerProperties.PREF_USE_LANDSCAPE));
>                 
>                 //the paper size...
>                 PageSetupPageType storedPageType = PageSetupPageType.LETTER; //default value
>                 String strPageType = pref.getString(WorkspaceViewerProperties.PREF_PAGE_SIZE);
>                 for (int i=0; i<PageSetupPageType.pages.length; i++) {
>                     if (strPageType.startsWith(PageSetupPageType.pages[i].getName())) {
>                         storedPageType = PageSetupPageType.pages[i];
>                         break;
>                     }
>                 }
>                 
>                 if (storedPageType.getIndex() == PageSetupPageType.USER_DEFINED.getIndex()) { //user defined size
>                     //get the width and height...
>                     
>                     NumberFormat fNumberFormat = NumberFormat.getNumberInstance();;
>                     String strWidth = pref.getString(WorkspaceViewerProperties.PREF_PAGE_WIDTH);
>                     String strHeight= pref.getString(WorkspaceViewerProperties.PREF_PAGE_HEIGHT);
>                     double width = 0, height = 0;
>                     
>                     try {
>                         Number num = fNumberFormat.parse(strWidth);
>                         width = num.doubleValue() / 0.0394d; //convert from inches to mm
>                         
>                         num = fNumberFormat.parse(strHeight);
>                         height = num.doubleValue() / 0.0394d;
>                         
>                         helper.setDlgPaperSize(PageSetupPageType.USER_DEFINED.getIndex(), width, height);
>                     } 
>                     catch (ParseException e) {
>                         Log.warning(
>                             DiagramPrintingPlugin.getInstance(),
>                             DiagramPrintingStatusCodes.IGNORED_EXCEPTION_WARNING,
>                             e.getMessage(),
>                             e);
>                     }
>                 }
>                 else
>                     helper.setDlgPaperSize(storedPageType.getIndex(), 0, 0);
> 
>             }
>             
