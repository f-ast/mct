14a15
> import org.eclipse.core.runtime.NullProgressMonitor;
26d26
< import org.eclipse.gef.commands.Command;
27a28,29
> import org.eclipse.gef.commands.CommandStackEvent;
> import org.eclipse.gef.commands.CommandStackEventListener;
59a62,75
> 	private CommandStackEventListener mySaveListener = new CommandStackEventListener() {
> 		public void stackChanged(CommandStackEvent event) {
> 			assert event.getSource() == myDiagramDisplayer.getCommandStack();
> 			if (event.isPostChangeEvent()) {
> 				try {
> 					myDiagramDisplayer.save(new NullProgressMonitor());
> 					myDiagramDisplayer.getCommandStack().markSaveLocation();
> 				} catch (CoreException e) {
> 					Activator.getDefault().getLog().log(e.getStatus());
> 				}
> 			}
> 		}
> 	};
> 
68c84
< 			myDiagramDisplayer.dispose();
---
> 			disposeDisplayer(myDiagramDisplayer);
119a136
> 			initDisplayer(myDiagramDisplayer);
130,131c147
< 					myDiagramDisplayer.getTopLevelControl().dispose();
< 					myDiagramDisplayer.dispose();
---
> 					disposeDisplayer(myDiagramDisplayer);
139,140c155
< 			oldDiagramDisplayer.getTopLevelControl().dispose();
< 			oldDiagramDisplayer.dispose();
---
> 			disposeDisplayer(oldDiagramDisplayer);
145a161,172
> 	protected void initDisplayer(DiagramDisplayer diagramDisplayer) {
> 		diagramDisplayer.getCommandStack().addCommandStackEventListener(mySaveListener);
> 	}
> 
> 	protected void disposeDisplayer(DiagramDisplayer diagramDisplayer) {
> 		if (diagramDisplayer.getTopLevelControl() != null) {
> 			diagramDisplayer.getTopLevelControl().dispose();
> 		}
> 		diagramDisplayer.getCommandStack().removeCommandStackEventListener(mySaveListener);
> 		diagramDisplayer.dispose();
> 	}
> 
166,189d192
< 		domain.setCommandStack(new CommandStack() {
< 			@Override
< 			public void execute(Command command) {
< 				super.execute(command);
< 				save();
< 			}
< 			@Override
< 			public void undo() {
< 				super.undo();
< 				save();
< 			}
< 			@Override
< 			public void redo() {
< 				super.redo();
< 				save();
< 			}
< 			private void save() {
< 				try {
< 					myDiagramDisplayer.save(null);
< 				} catch (CoreException e) {
< 					Activator.getDefault().getLog().log(e.getStatus());
< 				}
< 			}
< 		});
