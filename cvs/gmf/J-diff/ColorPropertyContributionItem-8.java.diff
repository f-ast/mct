18a19,20
> import org.eclipse.emf.ecore.EStructuralFeature;
> import org.eclipse.gef.EditPart;
22a25
> import org.eclipse.gmf.runtime.diagram.ui.editparts.IGraphicalEditPart;
24d26
< import org.eclipse.gmf.runtime.diagram.ui.preferences.IPreferenceConstants;
26,27c28
< import org.eclipse.jface.preference.IPreferenceStore;
< import org.eclipse.jface.preference.PreferenceConverter;
---
> import org.eclipse.gmf.runtime.emf.core.util.PackageUtil;
185,186d185
< 	/** the preference id */
< 	private String preferenceId;
213d211
< 	 * @param preferenceId The id of color property in pref store (optionl)
222d219
< 		String preferenceId,
229d225
< 		this.preferenceId = preferenceId;
559,560c555,557
< 	 * Returns the color to use in the default mode. By default,
< 	 * this comes from the preference store
---
>      * Returns the color to use in the default mode. A limitation is that if
>      * there are multiple editparts with different default colors only the
>      * default color of the first is returned.
565,570c562,579
< 		IPreferenceStore store = (IPreferenceStore) getDiagramEditPart()
< 			.getDiagramPreferencesHint().getPreferenceStore();
< 		RGB color = null;
< 		if (preferenceId != null)
< 			color = PreferenceConverter.getColor(store, preferenceId);
< 		return color != null ? color : DEFAULT_PREF_COLOR;
---
>         for (Iterator iter = getOperationSet().iterator(); iter.hasNext();) {
>             EditPart editpart = (EditPart) iter.next();
>             if (editpart instanceof IGraphicalEditPart) {
>                 final EStructuralFeature feature = (EStructuralFeature) PackageUtil
>                     .getElement(getPropertyId());
> 
>                 Object preferredValue = ((IGraphicalEditPart) editpart)
>                     .getPreferredValue(feature);
>                 if (preferredValue instanceof Integer) {
>                     return FigureUtilities
>                         .integerToRGB((Integer) preferredValue);
>                 }
> 
>             }
> 
>         }
> 
>         return DEFAULT_PREF_COLOR;
600d608
< 			null,
625d632
< 			IPreferenceConstants.PREF_LINE_COLOR,
650d656
< 			IPreferenceConstants.PREF_FILL_COLOR,
