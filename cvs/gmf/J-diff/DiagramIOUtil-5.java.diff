14c14,15
< import java.io.InputStream;
---
> import java.io.IOException;
> import java.util.HashMap;
15a17
> import java.util.Map;
23a26
> import org.eclipse.emf.common.util.URI;
26d28
< import org.eclipse.emf.ecore.xmi.ClassNotFoundException;
29a32
> import org.eclipse.emf.transaction.TransactionalEditingDomain;
37d39
< import org.eclipse.gmf.runtime.emf.core.edit.MEditingDomain;
39d40
< import org.eclipse.gmf.runtime.emf.core.exceptions.MSLRuntimeException;
68c69
< 		public Resource load(MEditingDomain domain, int loadOptions, IProgressMonitor monitor) throws CoreException;
---
> 		public Resource load(TransactionalEditingDomain domain, int loadOptions, IProgressMonitor monitor) throws CoreException;
78c79
< 		public Resource load(MEditingDomain domain, int loadOptions, IProgressMonitor monitor) throws CoreException {
---
> 		public Resource load(TransactionalEditingDomain domain, int loadOptions, IProgressMonitor monitor) throws CoreException {
80c81,82
< 			String fileName = fFile.getLocation().toOSString();
---
> 			URI uri = URI.createPlatformResourceURI(fFile.getFullPath()
>                 .toString(), true);
82c84
< 			Resource resource = domain.loadResource(fileName);
---
> 			Resource resource = domain.getResourceSet().getResource(uri, true);
94,96c96,98
< 		public Resource load(MEditingDomain domain, int loadOptions, IProgressMonitor monitor) throws CoreException {
< 			InputStream contents = fStorage.getContents();
< 			String storagePath = fStorage.getFullPath().toString();
---
> 		public Resource load(TransactionalEditingDomain editingDomain,
> 				int loadOptions, IProgressMonitor monitor)
> 			throws CoreException {
98,101c100
<             Resource resource = domain.findResource(storagePath, loadOptions);
<             if ( resource == null ) {
<                 resource = domain.createResource(storagePath);                
<             }
---
> 			String storagePath = fStorage.getFullPath().toString();
103c102,103
<             domain.loadResource(resource, loadOptions, contents);
---
> 			Resource resource = editingDomain.getResourceSet().getResource(
> 				URI.createPlatformResourceURI(storagePath, true), true);
108c108
< 	static public Diagram load(final MEditingDomain domain, final IFile file, boolean bTryCompatible, IProgressMonitor monitor) throws CoreException {
---
> 	static public Diagram load(final TransactionalEditingDomain domain, final IFile file, boolean bTryCompatible, IProgressMonitor monitor) throws CoreException {
113c113
< 	static public Diagram load(final MEditingDomain domain, final IStorage storage, boolean bTryCompatible, IProgressMonitor monitor) throws CoreException {
---
> 	static public Diagram load(final TransactionalEditingDomain domain, final IStorage storage, boolean bTryCompatible, IProgressMonitor monitor) throws CoreException {
130c130
< 	static private Diagram load(final MEditingDomain domain, final ILoader loader, boolean bTryCompatible, IProgressMonitor monitor) throws CoreException  {
---
> 	static private Diagram load(final TransactionalEditingDomain domain, final ILoader loader, boolean bTryCompatible, IProgressMonitor monitor) throws CoreException  {
137c137
< 			} catch (MSLRuntimeException e) {
---
> 			} catch (Exception e) {
192c192,193
< 	static public void save(MEditingDomain domain, IFile file, Diagram diagram, boolean bOverwrite, boolean bKeepUnrecognizedData, IProgressMonitor progressMonitor) throws CoreException {
---
> 	static public void save(TransactionalEditingDomain domain, IFile file, Diagram diagram, boolean bKeepUnrecognizedData, IProgressMonitor progressMonitor) throws CoreException {
>         Map options = new HashMap();
194,195d194
< 		if(bOverwrite)
< 			nOptions = MResourceOption.OVERWRITE_READONLY;
198c197
<         save(domain, file, diagram, progressMonitor, nOptions);
---
>         save(domain, file, diagram, progressMonitor, options);
201c200
< 	static public void save(MEditingDomain domain, IFile file, Diagram diagram, IProgressMonitor progressMonitor, int nOptions) throws CoreException {
---
> 	static public void save(TransactionalEditingDomain domain, IFile file, Diagram diagram, IProgressMonitor progressMonitor, Map options) throws CoreException {
203,205c202,210
<         String fileName = file.getLocation().toOSString();
<         
<         domain.saveResourceAs(notationModel, fileName, nOptions);
---
> 		String fileName = file.getFullPath().toOSString();
> 		notationModel.setURI(URI.createPlatformResourceURI(fileName, true));
> 		try {
> 			notationModel.save(options);
> 		} catch (IOException e) {
> 			throw new CoreException(new Status(IStatus.ERROR, EditorPlugin
> 				.getPluginId(), EditorStatusCodes.RESOURCE_FAILURE, e
> 				.getLocalizedMessage(), null));
> 		}
277,279c282,283
< 	public static void unload(MEditingDomain domain, Diagram diagram) {
< 		Resource resource = diagram.eResource();
< 		domain.unloadResource(resource);
---
> 	public static void unload(TransactionalEditingDomain domain, Diagram diagram) {
> 		diagram.eResource().unload();
