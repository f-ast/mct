10d9
< import java.io.BufferedReader;
12a12
> import java.io.InputStream;
14a15,16
> import java.net.URL;
> import java.nio.charset.Charset;
16d17
< import java.util.LinkedList;
18d18
< import org.eclipse.core.resources.ICommand;
21a22
> import org.eclipse.core.resources.ResourcesPlugin;
25,26c26
< import org.eclipse.gmf.internal.xpand.Activator;
< import org.eclipse.gmf.internal.xpand.ResourceManager;
---
> import org.eclipse.core.runtime.Platform;
32a33
> import org.osgi.framework.Bundle;
37,38c38
< 	private long configStamp = IResource.NULL_STAMP;
< 	private IPath[] configuredRoots;
---
> 	private final IPath[] myConfiguredRoots;
40c40
< 	public WorkspaceResourceManager(IProject context) {
---
> 	public WorkspaceResourceManager(IProject context, IPath[] configuredRoots) {
41a42
> 		myConfiguredRoots = configuredRoots;
48,56c49,51
< 		assert file.getProject() == contextProject;
< 		Reader r = null;
< 		try {
< 			r = new StreamConverter().toContentsReader(file);
< 			return super.loadXtendResource(r, toFullyQualifiedName(file));
< 		} finally {
< 			if (r != null) {
< 				r.close();
< 			}
---
> 		String fullyQualifiedName = toFullyQualifiedName(file);
> 		if (fullyQualifiedName == null) {
> 			return null;
57a53
> 		return super.loadXtendResource(fullyQualifiedName);
64,72c60,62
< 		assert file.getProject() == contextProject;
< 		Reader r = null;
< 		try {
< 			r = new StreamConverter().toContentsReader(file);
< 			return super.loadXpandResource(r, toFullyQualifiedName(file));
< 		} finally {
< 			if (r != null) {
< 				r.close();
< 			}
---
> 		String fullyQualifiedName = toFullyQualifiedName(file);
> 		if (fullyQualifiedName == null) {
> 			return null;
73a64,65
> 		fullyQualifiedName = getNonAspectsTemplateName(fullyQualifiedName);
> 		return super.loadXpandResource(fullyQualifiedName);
107,114c99,108
< 	private IPath[] getResolutions(IPath p) {
< 		IPath[] configured = getConfiguredRoots();
< 		IPath[] rv = new IPath[configured.length + 1];
< 		rv[0] = p;
< 		for (int i = 0; i < configured.length; i++) {
< 			rv[i+1] = configured[i].append(p);
< 		}
< 		return rv;
---
> 
> 	@Override
> 	protected Reader[] resolveMultiple(String fqn, String ext) throws IOException {
> 		IPath fp = new Path(fqn.replaceAll(SyntaxConstants.NS_DELIM, "/")).addFileExtension(ext);
> 		IPath[] resolutions = getResolutions(fp);
> 		ArrayList<Reader> result = new ArrayList<Reader>(resolutions.length);
> 		for (IPath p : getResolutions(fp)) {
> 			Reader nextReader = getReader(p);
> 			if (nextReader != null) {
> 				result.add(nextReader);
116,131d109
< 	private IPath[] getConfiguredRoots() {
< 		IFile config = contextProject.getFile(".xpand-root");
< 		if (!config.exists()) {
< 			return new IPath[] { new Path("templates/") };
< 		}
< 		if (config.getModificationStamp() != configStamp) {
< 			configuredRoots = new IPath[0];
< 			final ArrayList<IPath> read = new ArrayList<IPath>();
< 			BufferedReader in = null;
< 			try {
< 				in = new BufferedReader(new InputStreamReader(config.getContents(), config.getCharset()));
< 				String line;
< 				while((line = in.readLine()) != null) {
< 					line = line.trim();
< 					if (line.length() > 0 && line.charAt(0) != '#') {
< 						read.add(new Path(line));
132a111,112
> 		if (result.isEmpty()) {
> 			throw new FileNotFoundException(fp.toString());
134,143c114
< 			} catch (CoreException ex) {
< 				// IGNORE
< 			} catch (IOException ex) {
< 				// IGNORE
< 			} finally {
< 				if (in != null) {
< 					try {
< 						in.close();
< 					} catch (IOException ex) {
< 						/* IGNORE */
---
> 		return result.toArray(new Reader[result.size()]);
144a116,131
> 
> 	private Reader getReader(IPath p) throws IOException {
> 		if (p.isAbsolute()) {
> 			assert p.segmentCount() > 1;
> 			//Try workspace-relative first.
> 			IProject project = ResourcesPlugin.getWorkspace().getRoot().getProject(p.segment(0));
> 			if (project.isAccessible()) {
> 				return getWorkspaceFileReader(project, p.removeFirstSegments(1));
> 			}
> 			//Fallback to platform location
> 			Bundle platformBundle = Platform.getBundle(p.segment(0));
> 			if (platformBundle != null) {
> 				URL url = platformBundle.getEntry(p.removeFirstSegments(1).toString());
> 				if (url != null) {
> 					InputStream is = url.openStream();
> 					return new InputStreamReader(is, Charset.forName("ISO-8859-1"));	//$NON-NLS-1$
147,148c134,135
< 			configuredRoots = read.toArray(new IPath[read.size()]);
< 			configStamp = config.getModificationStamp();
---
> 		} else {
> 			return getWorkspaceFileReader(contextProject, p);
150c137
< 		return configuredRoots;
---
> 		return null;
153,154c140,142
< 	protected ResourceManager[] getDependenies() {
< 		LinkedList<ResourceManager> rv = new LinkedList<ResourceManager>();
---
> 	private Reader getWorkspaceFileReader(IProject project, IPath path) throws IOException {
> 		IResource r = project.findMember(path);
> 		if (r instanceof IFile) {
156,161c144,148
< 			IProject[] referencedProjects = contextProject.getReferencedProjects();
< 				for (IProject next : referencedProjects) {
< 					if (!next.isAccessible() || !hasXpandBuilder(next)) {
< 						continue;
< 					}
< 					rv.add(Activator.getResourceManager(next));
---
> 				return new StreamConverter().toContentsReader((IFile) r);
> 			} catch (CoreException ex) {
> 				IOException wrap = new IOException(ex.getStatus().getMessage());
> 				wrap.initCause(ex);
> 				throw wrap;
163,164d149
< 		} catch (CoreException e) {
< 			//ignore
166c151
< 		return rv.toArray(new ResourceManager[rv.size()]);
---
> 		return null;
169,172c154,158
< 	private static boolean hasXpandBuilder(IProject p) throws CoreException {
< 		for (ICommand c : p.getDescription().getBuildSpec()) {
< 			if (OawBuilder.getBUILDER_ID().equals(c.getBuilderName())) {
< 				return true;
---
> 	private IPath[] getResolutions(IPath p) {
> 		IPath[] configured = getConfiguredRoots();
> 		IPath[] rv = new IPath[configured.length];
> 		for (int i = 0; i < configured.length; i++) {
> 			rv[i] = configured[i].append(p);
173a160
> 		return rv;
175c162,163
< 		return false;
---
> 	private IPath[] getConfiguredRoots() {
> 		return myConfiguredRoots;
179c167,182
< 		return file.getProjectRelativePath().toString().replaceAll("/", SyntaxConstants.NS_DELIM);
---
> 		for (IPath nextRoot : getConfiguredRoots()) {
> 			if (!nextRoot.isAbsolute()) {
> 				if (file.getProject().equals(contextProject) && nextRoot.isPrefixOf(file.getProjectRelativePath())) {
> 					return toFullyQualifiedName(file.getProjectRelativePath().removeFirstSegments(nextRoot.segmentCount()));
> 				}
> 			} else {
> 				if (nextRoot.isPrefixOf(file.getFullPath())) {
> 					return toFullyQualifiedName(file.getFullPath().removeFirstSegments(nextRoot.segmentCount()));
> 				}
> 			}
> 		}
> 		return null;
> 	}
> 
> 	private String toFullyQualifiedName(IPath filePath) {
> 		return filePath.removeFileExtension().toString().replace("/", SyntaxConstants.NS_DELIM);
