2c2
<  * Copyright (c) 2004, 2005 IBM Corporation and others.
---
>  * Copyright (c) 2004, 2006 IBM Corporation and others.
14,15d13
< import java.io.FileInputStream;
< import java.io.FileNotFoundException;
16a15
> import java.io.InputStream;
23a23
> import org.eclipse.core.runtime.Path;
25d24
< 
28a28
> import org.osgi.framework.Bundle;
121a122,136
> 			Bundle bundle = Platform.getBundle(
> 					element.getDeclaringExtension().getNamespace());
> 			
> 			assert bundle != null;
> 			
> 			URL url = Platform.find(bundle, new Path(relativePath));
> 			
> 			if (url == null) {
> 				Log.error(CommonCorePlugin.getDefault(),
> 					CommonCoreStatusCodes.SERVICE_FAILURE,
> 					"Couldn't find relative path " + relativePath + " in " //$NON-NLS-1$ //$NON-NLS-2$
> 						+ element.getDeclaringExtension().getNamespace());
> 			}
> 			
> 			InputStream is = null;
123,125d137
< 			URL installURL = Platform.getBundle(
< 				element.getDeclaringExtension().getNamespace()).getEntry("/");//$NON-NLS-1$
< 			URL resolveURL = null;
127,130c139,145
< 				resolveURL = Platform.resolve(installURL);
< 			} catch (IOException e1) {
< 				// shouldn't happen
< 				assert (false);
---
> 				is = url.openStream();
> 				Properties properties = new Properties();
> 				properties.load(is);
> 				propertiesMap.putAll(properties);
> 				
> 			} catch (IOException e) {
> 				handleException(e);
132c147
< 			String fullPath = resolveURL.getFile() + relativePath;
---
> 			finally {
134,135c149
< 			// load the properties file
< 			Properties properties = new Properties();
---
> 				if (is != null) {
137,141c151
< 				FileInputStream stream = new FileInputStream(fullPath);
< 				properties.load(stream);
< 			} catch (FileNotFoundException e) {
< 				handleException(e);
< 				continue;
---
> 						is.close();
144d153
< 				continue;
147,148c156,159
< 			// add the properties map
< 			propertiesMap.putAll(properties);
---
> 				}
> 				
> 			}
> 
