2c2
<  * Copyright (c) 2002, 2005 IBM Corporation and others.
---
>  * Copyright (c) 2002, 2006 IBM Corporation and others.
13a14,18
> import org.eclipse.core.commands.operations.IOperationHistory;
> import org.eclipse.core.commands.operations.IOperationHistoryListener;
> import org.eclipse.core.commands.operations.IUndoContext;
> import org.eclipse.core.commands.operations.IUndoableOperation;
> import org.eclipse.core.commands.operations.OperationHistoryEvent;
16a22,30
> import org.eclipse.gmf.runtime.common.core.command.CommandManager;
> import org.eclipse.gmf.runtime.common.core.util.Log;
> import org.eclipse.gmf.runtime.common.core.util.StringStatics;
> import org.eclipse.gmf.runtime.common.core.util.Trace;
> import org.eclipse.gmf.runtime.common.ui.internal.CommonUIDebugOptions;
> import org.eclipse.gmf.runtime.common.ui.internal.CommonUIPlugin;
> import org.eclipse.gmf.runtime.common.ui.internal.CommonUIStatusCodes;
> import org.eclipse.gmf.runtime.common.ui.util.PartListenerAdapter;
> import org.eclipse.gmf.runtime.common.ui.util.StatusLineUtil;
31,42d44
< import org.eclipse.gmf.runtime.common.core.command.CommandManager;
< import org.eclipse.gmf.runtime.common.core.command.CommandManagerChangeEvent;
< import org.eclipse.gmf.runtime.common.core.command.ICommandManagerChangeListener;
< import org.eclipse.gmf.runtime.common.core.util.Log;
< import org.eclipse.gmf.runtime.common.core.util.StringStatics;
< import org.eclipse.gmf.runtime.common.core.util.Trace;
< import org.eclipse.gmf.runtime.common.ui.internal.CommonUIDebugOptions;
< import org.eclipse.gmf.runtime.common.ui.internal.CommonUIPlugin;
< import org.eclipse.gmf.runtime.common.ui.internal.CommonUIStatusCodes;
< import org.eclipse.gmf.runtime.common.ui.util.PartListenerAdapter;
< import org.eclipse.gmf.runtime.common.ui.util.StatusLineUtil;
< 
65c67
< 	ICommandManagerChangeListener, IPropertyListener {
---
> 	IOperationHistoryListener, IPropertyListener {
208,209c210,211
< 			if (isCommandStackListener()) {
< 				getCommandManager().removeCommandManagerChangeListener(this);
---
> 			if (isOperationHistoryListener()) {
>                 getOperationHistory().removeOperationHistoryListener(this);
226,227c228,229
< 			if (isCommandStackListener()) {
< 				getCommandManager().addCommandManagerChangeListener(this);
---
> 			if (isOperationHistoryListener()) {
>                 getOperationHistory().addOperationHistoryListener(this);
264a267
>      * @deprecated Use {@link #getOperationHistory()} instead.
267c270,280
< 		return getActionManager().getCommandManager();
---
> 		return CommandManager.getDefault();
> 	}
> 	
>     /**
>      * Returns the operation history for this action handler from its action
>      * manager.
>      * 
>      * @return the operation history
>      */
>     protected IOperationHistory getOperationHistory() {
>         return getActionManager().getOperationHistory();
413a427
>      * @deprecated Subclasses must implement {@link #isOperationHistoryListener()}.
419a434,444
>      * Retrieves a Boolean indicating whether this action handler is interested
>      * in operation history changed events.
>      * 
>      * @return <code>true</code> if this action handler is interested;
>      *         <code>false</code> otherwise.
>      */
>     protected boolean isOperationHistoryListener() {
>         return false;
>     }
> 
> 	/**
487,490c512
< 	 * Handles an event indicating that a command manager has changed.
< 	 * 
< 	 * @param event
< 	 *            The command manager change event to be handled.
---
>      * Refreshes me if the history event has my workbench part's context.
492c514,521
< 	public final void commandManagerChanged(CommandManagerChangeEvent event) {
---
>     public void historyNotification(OperationHistoryEvent event) {
> 
>         IUndoableOperation operation = event.getOperation();
> 
>         if (operation != null) {
>             IUndoContext partContext = getUndoContext();
> 
>             if (partContext != null && operation.hasContext(partContext)) {
494a524,540
>         }
>     }
>     
>     /**
>      * Gets the undo context from my workbench part.
>      * 
>      * @return the undo context
>      */
>     protected IUndoContext getUndoContext() {
>         IWorkbenchPart part = getWorkbenchPart();
> 
>         if (part != null) {
>             return (IUndoContext) part.getAdapter(IUndoContext.class);
>         }
> 
>         return null;
>     }
