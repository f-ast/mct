17d16
< import java.util.Iterator;
19d17
< import java.util.ListIterator;
66c64,65
< 			List results = Collections.EMPTY_LIST;
---
> 			for (int i = 0; i < PRIORITIES.length; ++i) {
> 				List providers = service.getProviders(this, PRIORITIES[i], operation);
68,73c67,68
< 			for (int i = 0; i < PRIORITIES.length; i++) {
< 				List targets = getProviders(service, this, PRIORITIES[i], operation);
< 
< 				if (!targets.isEmpty()) {
< 					results = Collections.singletonList(operation.execute((IProvider) targets.get(0)));
< 					break;
---
> 				if (providers.size() != 0) {
> 					return Collections.singletonList(operation.execute((IProvider) providers.get(0)));
76c71,72
< 			return results;
---
> 
> 			return Collections.EMPTY_LIST;
77a74
> 
83c80,84
< 			List providers = getProviders(service, priority);
---
> 			List descriptors = service.getProviders(priority);
> 			int size = descriptors.size();
> 
> 			for (int i = 0; i < size; ++i) {
> 				ProviderDescriptor descriptor = (ProviderDescriptor)descriptors.get(i);
85,86d85
< 			for (ListIterator i = providers.listIterator(); i.hasNext();) {
< 				ProviderDescriptor descriptor = (ProviderDescriptor) i.next();
90a90
> 
102,106c102,104
< 			List results = Collections.EMPTY_LIST;
< 
< 			for (int i = PRIORITIES.length - 1; i >= 0; i--) {
< 				List targets = getProviders(service, this, PRIORITIES[i], operation);
< 				int size = targets.size();
---
> 			for (int i = PRIORITIES.length; --i >= 0;) {
> 				List providers = service.getProviders(this, PRIORITIES[i], operation);
> 				int size = providers.size();
109c107
< 					results = Collections.singletonList(
---
> 					return Collections.singletonList(
111,112c109
< 							(IProvider) targets.get(size - 1)));
< 					break;
---
> 							(IProvider) providers.get(size - 1)));
115c112,113
< 			return results;
---
> 
> 			return Collections.EMPTY_LIST;
116a115
> 
122c121,124
< 				List providers = getProviders(service, priority);
---
> 			List descriptors = service.getProviders(priority);
> 
> 			for (int i = descriptors.size(); --i >= 0;) {
> 				ProviderDescriptor descriptor = (ProviderDescriptor)descriptors.get(i);
124,125d125
< 				for (ListIterator i = providers.listIterator(providers.size()); i.hasPrevious();) {
< 					ProviderDescriptor descriptor = (ProviderDescriptor) i.previous();
129a130
> 
143,144c144,146
< 			for (int i = 0; i < PRIORITIES.length; i++) {
< 				List targets = getProviders(service, this, PRIORITIES[i], operation);
---
> 			for (int i = 0; i < PRIORITIES.length; ++i) {
> 				List providers = service.getProviders(this, PRIORITIES[i], operation);
> 				int size = providers.size();
146,147c148,149
< 				for (int j = 0; j < targets.size(); j++) {
< 					results.add(operation.execute((IProvider) targets.get(j)));
---
> 				for (int j = 0; j < size; ++j) {
> 					results.add(operation.execute((IProvider) providers.get(j)));
149a152
> 
163,164c166,167
< 			for (int i = PRIORITIES.length - 1; i >= 0; i--) {
< 				List targets = getProviders(service, this, PRIORITIES[i], operation);
---
> 			for (int i = PRIORITIES.length; --i >= 0;) {
> 				List providers = service.getProviders(this, PRIORITIES[i], operation);
166,167c169,170
< 				for (int j = targets.size() - 1; j >= 0; j--) {
< 					results.add(operation.execute((IProvider) targets.get(j)));
---
> 				for (int j = providers.size(); --j >= 0;) {
> 					results.add(operation.execute((IProvider) providers.get(j)));
169a173
> 
232c236,241
< 		List targets = new ArrayList();
---
> 		List descriptors = service.getProviders(priority);
> 		int size = descriptors.size();
> 		List providers = new ArrayList(size);
> 
> 		for (int i = 0; i < size; ++i) {
> 			ProviderDescriptor descriptor = (ProviderDescriptor)descriptors.get(i);
234,235d242
< 		for (Iterator i = getProviders(service, priority).iterator(); i.hasNext();) {
< 			ProviderDescriptor descriptor = (ProviderDescriptor) i.next();
237c244
< 				targets.add(descriptor.getProvider());
---
> 				providers.add(descriptor.getProvider());
240c247,248
< 		return targets;
---
> 
> 		return providers;
