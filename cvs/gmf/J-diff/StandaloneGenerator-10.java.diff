15,21d14
< import java.util.Arrays;
< import java.util.Collections;
< import java.util.Enumeration;
< import java.util.HashSet;
< import java.util.IdentityHashMap;
< import java.util.Iterator;
< import java.util.Map;
28d20
< import org.eclipse.gmf.gmfgraph.FigureGallery;
36d27
< 	private final FigureGallery[] myInput;
42,48c33
< 	private final GenerationInfoImpl myGenerationInfo;
< 	
< 	public interface GenerationInfo {
< 		public Config getConfig(); 
< 		public Enumeration/*<Figure>*/ getProcessedFigures();
< 		public String getGeneratedClassFQN(Figure figure);
< 	}
---
> 	private Processor myProcessor;
120,121c105,110
< 	public StandaloneGenerator(FigureGallery input, Config config, FigureQualifiedNameSwitch fqnSwitch) {
< 		this(new FigureGallery[] {input}, config, fqnSwitch);
---
> 	public static abstract class Processor {
> 		public abstract void go(ProcessorCallback callback) throws InterruptedException ;
> 
> 		public String[] getRequiredBundles(FigureQualifiedNameSwitch fqnSwitch) {
> 			return new String[0];
> 		}
124,125c113,119
< 	public StandaloneGenerator(FigureGallery[] input, Config config, FigureQualifiedNameSwitch fqnSwitch) {
< 		assert input != null && config != null && fqnSwitch != null && !Arrays.asList(input).contains(null);
---
> 	public interface ProcessorCallback {
> 		public String visitFigure(Figure f) throws InterruptedException;
> 	}
> 
> 
> 	public StandaloneGenerator(Processor p, Config config, FigureQualifiedNameSwitch fqnSwitch) {
> 		assert p != null && config != null && fqnSwitch != null;
127c121
< 		myInput = input;
---
> 		myProcessor = p;
140,144d133
< 		myGenerationInfo = new GenerationInfoImpl(myArgs);
< 	}
< 	
< 	public GenerationInfo getGenerationInfo() {
< 		return myGenerationInfo;
184c173
< 		doGenerateFile(myAuxiliaryGenerators.getManifestMFEmitter(), new Path("META-INF/MANIFEST.MF"), new Object[] { new Object[] { myArgs, getRequiredBundles() } });
---
> 		doGenerateFile(myAuxiliaryGenerators.getManifestMFEmitter(), new Path("META-INF/MANIFEST.MF"), new Object[] { new Object[] { myArgs, myProcessor.getRequiredBundles(myFigureNameSwitch) } });
188,199d176
< 	private String[] getRequiredBundles() {
< 		HashSet rv = new HashSet();
< 		for (int i = 0; i < myInput.length; i++) {
< 			if (myInput[i].getImplementationBundle() != null && myInput[i].getImplementationBundle().trim().length() > 0) {
< 				rv.add(myInput[i].getImplementationBundle());
< 				}
< 			String[] additional = myFigureNameSwitch.getDependencies(myInput[i]);
< 			rv.addAll(Arrays.asList(additional));
< 		}
< 		return (String[]) rv.toArray(new String[rv.size()]);
< 	}
< 
201,205c178,180
< 		for (int i = 0; i < myInput.length; i++) {
< 			for (Iterator it = myInput[i].getFigures().iterator(); it.hasNext();){
< 				Figure next = (Figure) it.next();
< 				visitFigure(next);
< 			}
---
> 		myProcessor.go(new ProcessorCallback() {
> 			public String visitFigure(Figure f) throws InterruptedException {
> 				return StandaloneGenerator.this.visitFigure(f);
206a182
> 		});
209c185
< 	private void visitFigure(Figure figure) throws InterruptedException {
---
> 	private String visitFigure(Figure figure) throws InterruptedException {
216c192
< 		myGenerationInfo.registerFQN(figure, composeFQN(getPackageName(), importAssistant.getCompilationUnitName()));
---
> 		return composeFQN(getPackageName(), importAssistant.getCompilationUnitName());
232,258d207
< 	
< 	private static class GenerationInfoImpl implements GenerationInfo {
< 		private final Map myFigure2FQN = new IdentityHashMap();
< 		private final Config myConfig;
< 		
< 		public GenerationInfoImpl(Config config){
< 			myConfig = config;
< 		}
< 		
< 		public Config getConfig() {
< 			return myConfig;
< 		}
< 		
< 		public void registerFQN(Figure figure, String fqn){
< 			myFigure2FQN.put(figure, fqn);
< 		}
< 		
< 		public String getGeneratedClassFQN(Figure figure) {
< 			return (String)myFigure2FQN.get(figure);
< 		}
< 		
< 		public Enumeration getProcessedFigures() {
< 			return Collections.enumeration(myFigure2FQN.keySet());
< 		}
< 		
< 	}
< 	
