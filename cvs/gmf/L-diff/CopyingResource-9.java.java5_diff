49,50d48
< import org.eclipse.gmf.runtime.emf.core.resources.GMFResource;
< 
59c57
<     private CopyingResourceSet mslCopyingResourceSet;
---
>     private CopyingResourceSet copyingResourceSet;
61,62c59,60
<     public CopyingResource (XMLResource mslResource, URI uri, CopyingResourceSet mslCopyingResourceSet) {
<         this (mslResource, uri, mslCopyingResourceSet, true);
---
>     public CopyingResource (XMLResource resource, URI uri, CopyingResourceSet copyingResourceSet) {
>         this (resource, uri, copyingResourceSet, true);
65c63
<     public CopyingResource (XMLResource mslResource, URI uri, CopyingResourceSet mslCopyingResourceSet, boolean regenerateIds) {
---
>     public CopyingResource (XMLResource resource, URI uri, CopyingResourceSet copyingResourceSet, boolean regenerateIds) {
67,69c65,67
<         this.xmlResource = mslResource;
<         this.mslCopyingResourceSet = mslCopyingResourceSet;
<         setEncoding (mslResource.getEncoding ());
---
>         this.xmlResource = resource;
>         this.copyingResourceSet = copyingResourceSet;
>         setEncoding (resource.getEncoding ());
71,73c69,71
<         getDefaultSaveOptions ().putAll (mslResource.getDefaultSaveOptions ());
<         mslCopyingResourceSet.getResources ().add (this);
<         mslCopyingResourceSet.getResourcesMap ().put (mslResource, this);
---
>         getDefaultSaveOptions ().putAll (resource.getDefaultSaveOptions ());
>         copyingResourceSet.getResources ().add (this);
>         copyingResourceSet.getResourcesMap ().put (resource, this);
82c80
<         Iterator it = xmlResource.getAllContents ();
---
>         Iterator it = getXMLResource ().getAllContents ();
89c87
<         throwUnsupportedOperationException ("createXMLLoad", new UnsupportedOperationException ("Can't call load on MSLCopyingResource resource"));
---
>         throwUnsupportedOperationException ("createXMLLoad", new UnsupportedOperationException ("Can't call load on CopyingResource resource"));
94,139c92
<         return new XMIHelperImpl (this) {
< 
<             public URI deresolve (URI anUri) {
<                 if (((EMFCoreConstants.PLATFORM_SCHEME.equals (anUri.scheme ())) && (EMFCoreConstants.PLATFORM_SCHEME.equals (resourceURI.scheme ()))) && ((anUri.segmentCount () > 2) && (resourceURI.segmentCount () > 2)) && ((! anUri.segments () [0].equals (resourceURI.segments () [0])) || (! anUri.segments () [1].equals (resourceURI.segments () [1])))) return anUri;
< 
<                 return super.deresolve (anUri);
<             }
< 
<             public String getHREF (EObject obj) {
<                 EObject eObj = obj;
<                 if (obj.eIsProxy ()) {
<                     eObj = EcoreUtil.resolve (obj, xmlResource);
<                     if (eObj == null) {
<                         eObj = null;
<                     }
<                 }
<                 if ((eObj != null) && (eObj.eResource () != null)) {
<                     URI objectURI = getHREF (eObj.eResource (), eObj);
<                     objectURI = deresolve (objectURI);
<                     return objectURI.toString ();
<                 }
<                 return super.getHREF (obj);
<             }
< 
<             protected URI getHREF (Resource otherResource, EObject obj) {
<                 if ((otherResource instanceof CopyingResource) == false) {
<                     CopyingResource copyingResource = (CopyingResource) getResourcesMap ().get (otherResource);
<                     if (copyingResource != null) {
<                         otherResource = copyingResource;
<                     }
<                 }
<                 if (otherResource instanceof GMFResource) {
<                     String qName = EMFCoreUtil.getQualifiedName (obj, true);
<                     if (qName.length () > 0) {
<                         StringBuffer buffer = new StringBuffer (otherResource.getURIFragment (obj));
<                         buffer.append (EMFCoreConstants.FRAGMENT_SEPARATOR);
<                         buffer.append (Util.encodeQualifiedName (qName));
<                         return otherResource.getURI ().appendFragment (buffer.toString ());
<                     }
<                 }
<                 return super.getHREF (otherResource, obj);
<             }
< 
<         }
< 
<         ;
---
>         return new CopyingHelper (this);
159c112
<         throwUnsupportedOperationException ("doLoad", new UnsupportedOperationException ("Can't call load on MSLCopyingResource resource"));
---
>         throwUnsupportedOperationException ("doLoad", new UnsupportedOperationException ("Can't call load on CopyingResource resource"));
163,194c116
<         return new XMISaveImpl (createXMLHelper ()) {
< 
<             protected int sameDocMany (EObject o, EStructuralFeature f) {
<                 InternalEList values = (InternalEList) helper.getValue (o, f);
<                 if (values.isEmpty ()) {
<                     return SKIP;
<                 }
<                 for (Iterator i = values.basicIterator ();
<                 i.hasNext ();) {
<                     EObject value = (EObject) i.next ();
<                     if (value.eIsProxy () || (isInResource (value) == false)) {
<                         return CROSS_DOC;
<                     }
<                 }
<                 return SAME_DOC;
<             }
< 
<             protected int sameDocSingle (EObject o, EStructuralFeature f) {
<                 EObject value = (EObject) helper.getValue (o, f);
<                 if (value == null) {
<                     return SKIP;
<                 } else if (value.eIsProxy ()) {
<                     return CROSS_DOC;
<                 } else {
<                     return (isInResource (value)) ? SAME_DOC : CROSS_DOC;
<                 }
< 
<             }
< 
<         }
< 
<         ;
---
>         return new CopyingSave (createXMLHelper ());
199c121
<             if (((InternalEObject) eObject).eDirectResource () == xmlResource) {
---
>             if (((InternalEObject) eObject).eDirectResource () == getXMLResource ()) {
208c130
<         return xmlResource.getContents ();
---
>         return getXMLResource ().getContents ();
223c145
<         EObject eObj = xmlResource.getEObject (id);
---
>         EObject eObj = getXMLResource ().getEObject (id);
231c153
<         return mslCopyingResourceSet;
---
>         return copyingResourceSet;
245c167
<         return xmlResource.getEObjectToExtensionMap ();
---
>         return getXMLResource ().getEObjectToExtensionMap ();
254c176
<         for (Iterator iter = xmlResource.getAllContents ();
---
>         for (Iterator iter = getXMLResource ().getAllContents ();
264a187,288
>     protected XMLResource getXMLResource () {
>         return xmlResource;
>     }
> 
>     protected class CopyingHelper extends XMIHelperImpl {
> 
>         public CopyingHelper () {
>             super ();
>         }
> 
>         public CopyingHelper (XMLResource resource) {
>             super (resource);
>         }
> 
>         public URI deresolve (URI anUri) {
>             if (((EMFCoreConstants.PLATFORM_SCHEME.equals (anUri.scheme ())) && (EMFCoreConstants.PLATFORM_SCHEME.equals (resourceURI.scheme ()))) && ((anUri.segmentCount () > 2) && (resourceURI.segmentCount () > 2)) && ((! anUri.segments () [0].equals (resourceURI.segments () [0])) || (! anUri.segments () [1].equals (resourceURI.segments () [1])))) return anUri;
> 
>             return super.deresolve (anUri);
>         }
> 
>         public String getHREF (EObject obj) {
>             EObject eObj = obj;
>             if (obj.eIsProxy ()) {
>                 eObj = EcoreUtil.resolve (obj, getXMLResource ());
>                 if (eObj == obj) {
>                     eObj = null;
>                 }
>             }
>             if (eObj != null) {
>                 Resource resource = eObj.eResource ();
>                 if (resource != null) {
>                     URI objectURI = getHREF (resource, eObj);
>                     objectURI = deresolve (objectURI);
>                     return objectURI.toString ();
>                 }
>             }
>             return super.getHREF (obj);
>         }
> 
>         protected URI getHREF (Resource otherResource, EObject obj) {
>             if (! (otherResource instanceof CopyingResource)) {
>                 CopyingResource copyingResource = (CopyingResource) getResourcesMap ().get (otherResource);
>                 if (copyingResource != null) {
>                     otherResource = copyingResource;
>                 }
>             }
>             String qName = EMFCoreUtil.getQualifiedName (obj, true);
>             if (qName.length () > 0) {
>                 StringBuffer buffer = new StringBuffer (otherResource.getURIFragment (obj));
>                 buffer.append (EMFCoreConstants.FRAGMENT_SEPARATOR);
>                 buffer.append (Util.encodeQualifiedName (qName));
>                 buffer.append (EMFCoreConstants.FRAGMENT_SEPARATOR);
>                 return otherResource.getURI ().appendFragment (buffer.toString ());
>             }
>             return super.getHREF (otherResource, obj);
>         }
> 
>     };
> 
>     public class CopyingSave extends XMISaveImpl {
> 
>         public CopyingSave (XMLHelper helper) {
>             super (helper);
>         }
> 
>         public CopyingSave (Map options, XMLHelper helper, String encoding) {
>             super (options, helper, encoding);
>         }
> 
>         public CopyingSave (Map options, XMLHelper helper, String encoding, String xmlVersion) {
>             super (options, helper, encoding, xmlVersion);
>         }
> 
>         protected int sameDocMany (EObject o, EStructuralFeature f) {
>             InternalEList values = (InternalEList) helper.getValue (o, f);
>             if (values.isEmpty ()) {
>                 return SKIP;
>             }
>             for (Iterator i = values.basicIterator ();
>             i.hasNext ();) {
>                 EObject value = (EObject) i.next ();
>                 if (value.eIsProxy () || (isInResource (value) == false)) {
>                     return CROSS_DOC;
>                 }
>             }
>             return SAME_DOC;
>         }
> 
>         protected int sameDocSingle (EObject o, EStructuralFeature f) {
>             EObject value = (EObject) helper.getValue (o, f);
>             if (value == null) {
>                 return SKIP;
>             } else if (value.eIsProxy ()) {
>                 return CROSS_DOC;
>             } else {
>                 return (isInResource (value)) ? SAME_DOC : CROSS_DOC;
>             }
> 
>         }
> 
>     };
> 
