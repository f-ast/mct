11,12d10
< import org.eclipse.emf.ecore.util.EcoreUtil;
< 
14a13,14
> import org.eclipse.gmf.gmfgraph.ChildAccess;
> 
23,25c23
< import org.eclipse.gmf.gmfgraph.Figure;
< 
< import org.eclipse.gmf.gmfgraph.FigureAccessor;
---
> import org.eclipse.gmf.gmfgraph.FigureDescriptor;
29,30d26
< import org.eclipse.gmf.gmfgraph.FigureHandle;
< 
39,40d34
< import org.eclipse.gmf.graphdef.codegen.NamingStrategy;
< 
101c95
<             handleFigure (next.getNodeFigure ());
---
>             handleFigure (next.getFigure ());
107c101
<             handleFigure (next.getConnectionFigure ());
---
>             handleFigure (next.getFigure ());
113c107
<             FigureHandle nextFigure = next.getFigure ();
---
>             FigureDescriptor nextFigure = next.getFigure ();
117,121c111
<             if (nextFigure instanceof Figure) {
<                 handleFigure ((Figure) nextFigure);
<             } else {
<                 throw new IllegalStateException ("Don't support accessors for compartments yet");
<             }
---
>             handleFigure (nextFigure);
127,141c117,118
<             if (next.getFigure () instanceof FigureAccessor) {
<                 assert myElementCopier.containsKey (next.getFigure ()) : "Should be copied as part of previously referenced CustomFigure";
<             } else {
<                 assert next.getFigure () instanceof Figure;
<                 Figure f = (Figure) next.getFigure ();
<                 if (isInsideProcessedFigure (f)) {
<                     FigureAccessor accessor = GMFGraphFactory.eINSTANCE.createFigureAccessor ();
<                     accessor.setAccessor (NamingStrategy.INSTANCE.getChildFigureGetterName (f));
<                     myElementCopier.put (f, accessor);
<                     Figure parent = f;
<                     do {
<                         parent = parent.getParent ();
<                     } while (! myElementCopier.containsKey (parent));
<                     assert myElementCopier.get (parent) instanceof CustomFigure : "We used to keep custom figures only in the mirrored gallery";
<                     ((CustomFigure) myElementCopier.get (parent)).getCustomChildren ().add (accessor);
---
>             if (next.getAccessor () != null) {
>                 ChildAccess labelAccess = next.getAccessor ();
143,144c120
<                     handleFigure (f);
<                 }
---
>                 handleFigure (next.getFigure ());
149,154c125,126
<     private boolean isInsideProcessedFigure (Figure f) {
<         return EcoreUtil.isAncestor (myElementCopier.keySet (), f);
<     }
< 
<     private void handleFigure (Figure figure) throws InterruptedException {
<         if (myElementCopier.isSubstituted (figure)) {
---
>     private void handleFigure (FigureDescriptor fd) throws InterruptedException {
>         if (myElementCopier.isSubstituted (fd)) {
157,158c129,131
<         if (figure instanceof CustomFigure && isPlainBareCustomFigure ((CustomFigure) figure)) {
<             myOutcomeGallery.getFigures ().add ((CustomFigure) myElementCopier.copy (figure));
---
>         if (fd.getActualFigure () instanceof CustomFigure && isPlainBareCustomFigure ((CustomFigure) fd.getActualFigure ())) {
>             final CustomFigure f = (CustomFigure) fd.getActualFigure ();
>             myOutcomeGallery.getFigures ().add (myElementCopier.xcopy (f));
160,161c133,134
<             String fqn = myCallback.visitFigure (figure);
<             myElementCopier.registerSubstitution (figure, createCustomFigure (figure, fqn));
---
>             String fqn = myCallback.visitFigure (fd);
>             myElementCopier.registerSubstitution (fd, createCustomFigure (fd, fqn));
170,174c143,144
<         featuresToCheck.remove (GMFGraphPackage.eINSTANCE.getIdentity_Name ());
<         featuresToCheck.remove (GMFGraphPackage.eINSTANCE.getFigure_Children ());
<         featuresToCheck.remove (GMFGraphPackage.eINSTANCE.getFigureMarker_Parent ());
<         featuresToCheck.remove (GMFGraphPackage.eINSTANCE.getFigureHandle_ReferencingElements ());
<         featuresToCheck.remove (GMFGraphPackage.eINSTANCE.getCustomClass_BundleName ());
---
>         featuresToCheck.remove (GMFGraphPackage.eINSTANCE.getRealFigure_Name ());
>         featuresToCheck.remove (GMFGraphPackage.eINSTANCE.getRealFigure_Children ());
188,190c158,159
<     private CustomFigure createCustomFigure (Figure original, String fqn) {
<         CustomFigure cf = DiagramElementsCopier.createCustomFigure (original);
<         cf.setName (original.getName ());
---
>     private FigureDescriptor createCustomFigure (FigureDescriptor original, String fqn) {
>         CustomFigure cf = GalleryMirrorProcessor.createCustomFigure (original.getActualFigure ());
192,193c161,165
<         myOutcomeGallery.getFigures ().add (cf);
<         return cf;
---
>         FigureDescriptor fd = GMFGraphFactory.eINSTANCE.createFigureDescriptor ();
>         fd.setName (original.getName ());
>         fd.setActualFigure (cf);
>         myOutcomeGallery.getDescriptors ().add (fd);
>         return fd;
