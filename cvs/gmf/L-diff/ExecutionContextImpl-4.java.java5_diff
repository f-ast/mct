52c52
<         this (resourceManager, (Map < String, Variable >) null);
---
>         this (resourceManager, (Collection < Variable >) null);
55c55
<     public ExecutionContextImpl (ResourceManager resourceManager, Map < String, Variable > globalVars) {
---
>     public ExecutionContextImpl (ResourceManager resourceManager, Collection < Variable > globalVars) {
59c59
<     public ExecutionContextImpl (ResourceManager resourceManager, ResourceMarker resource, Map < String, Variable > variables, Map < String, Variable > globalVars) {
---
>     public ExecutionContextImpl (ResourceManager resourceManager, ResourceMarker resource, Collection < Variable > variables, Collection < Variable > globalVars) {
63c63,65
<             this.variables.putAll (variables);
---
>             for (Variable v : variables) {
>                 this.variables.put (v.getName (), v);
>             }
66c68,70
<             this.globalVars.putAll (globalVars);
---
>             for (Variable v : globalVars) {
>                 this.globalVars.put (v.getName (), v);
>             }
69a74,80
>     protected ExecutionContextImpl (ExecutionContextImpl original) {
>         this.resourceManager = original.resourceManager;
>         this.currentResource = original.currentResource;
>         this.variables.putAll (original.variables);
>         this.globalVars.putAll (original.globalVars);
>     }
> 
203c214
<         return new ExecutionContextImpl (resourceManager, currentResource, variables, globalVars);
---
>         return new ExecutionContextImpl (this);
214,215c225,230
<     public Map < String, Variable > getVisibleVariables () {
<         return Collections.unmodifiableMap (variables);
---
>     public Collection < Variable > getVisibleVariables () {
>         return Collections.unmodifiableCollection (variables.values ());
>     }
> 
>     public Collection < Variable > getGlobalVariables () {
>         return Collections.unmodifiableCollection (globalVars.values ());
218,219c233,234
<     public Map < String, Variable > getGlobalVariables () {
<         return Collections.unmodifiableMap (globalVars);
---
>     public Variable getGlobalVariable (String name) {
>         return globalVars.get (name);
223c238
<     public ExecutionContext cloneWithVariable (final Variable v) {
---
>     public ExecutionContext cloneWithVariable (final Variable...vars) {
224a240
>         for (Variable v : vars) {
225a242
>         }
229a247,251
>     public ExecutionContext cloneWithVariable (Collection < Variable > v) {
>         return cloneWithVariable (v.toArray (new Variable [v.size ()]));
>     }
> 
>     @SuppressWarnings("unchecked")
