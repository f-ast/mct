3,4d2
< import java.util.HashMap;
< 
7,8d4
< import java.util.Map;
< 
12a9,10
> import org.eclipse.core.resources.ProjectScope;
> 
16a15,18
> import org.eclipse.core.runtime.IStatus;
> 
> import org.eclipse.core.runtime.Platform;
> 
48a51,54
> import org.osgi.service.prefs.BackingStoreException;
> 
> import org.osgi.service.prefs.Preferences;
> 
51a58
>     private static final String PREF_KEY = "gmf_dashboard";
56d62
<     private Map < IProject, DashboardState > states;
62,65c68
<         if (memento == null) {
<             states = new HashMap < IProject, DashboardState > ();
<         } else {
<             states = DashboardPersistence.read (memento);
---
>         if (memento != null) {
118c121
<                 mediator.setProjectAndState (dashboardProject, states.get (dashboardProject));
---
>                 updateDashboardProject (dashboardProject);
127d129
<             states.put (mediator.getProject (), mediator.getState ());
133d134
<         DashboardPersistence.write (memento, states);
191,192c192,220
<         if (mediator.getProject () != null) {
<             states.put (mediator.getProject (), mediator.getState ());
---
>         mediator.setProjectAndState (project, new DashboardState (getPreferences (project)));
>     }
> 
>     private Preferences getPreferences (IProject project) {
>         Preferences node = getExistingPreferences (project);
>         if (node != null) {
>             return node;
>         }
>         return new ProjectScope (project).getNode (Plugin.getPluginID ()).node (PREF_KEY);
>     }
> 
>     private Preferences getExistingPreferences (IProject project) {
>         Preferences node = Platform.getPreferencesService ().getRootNode ().node (ProjectScope.SCOPE);
>         try {
>             if (! node.nodeExists (project.getName ())) {
>                 return null;
>             }
>             node = node.node (project.getName ());
>             if (! node.nodeExists (Plugin.getPluginID ())) {
>                 return null;
>             }
>             node = node.node (Plugin.getPluginID ());
>             if (! node.nodeExists (PREF_KEY)) {
>                 return null;
>             }
>             return node.node (PREF_KEY);
>         } catch (BackingStoreException e) {
>             IStatus status = Plugin.createError ("Unable to read state", e);
>             Plugin.getDefault ().getLog ().log (status);
194c222
<         mediator.setProjectAndState (project, states.get (project));
---
>         return null;
