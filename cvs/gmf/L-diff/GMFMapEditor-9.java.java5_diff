20a21,24
> import java.util.Map;
> 
> import java.util.LinkedHashMap;
> 
52a57,60
> import org.eclipse.emf.common.util.BasicDiagnostic;
> 
> import org.eclipse.emf.common.util.Diagnostic;
> 
54a63,64
> import org.eclipse.emf.common.notify.Notification;
> 
56a67,68
> import org.eclipse.emf.common.ui.editor.ProblemEditorPart;
> 
68a81,84
> import org.eclipse.emf.ecore.util.EcoreUtil;
> 
> import org.eclipse.emf.ecore.util.EContentAdapter;
> 
98a115,118
> import org.eclipse.emf.common.ui.MarkerHelper;
> 
> import org.eclipse.emf.edit.ui.util.EditUIMarkerHelper;
> 
190a211,212
> import org.eclipse.ui.PartInitException;
> 
230a253
>     protected MarkerHelper markerHelper = new EditUIMarkerHelper ();
265,267c288,318
<     Collection removedResources = new ArrayList ();
<     Collection changedResources = new ArrayList ();
<     Collection savedResources = new ArrayList ();
---
>     protected Collection removedResources = new ArrayList ();
>     protected Collection changedResources = new ArrayList ();
>     protected Collection savedResources = new ArrayList ();
>     protected Map resourceToDiagnosticMap = new LinkedHashMap ();
>     protected boolean updateProblemIndication = true;
>     protected EContentAdapter problemIndicationAdapter = new EContentAdapter () {
> 
>         public void notifyChanged (Notification notification) {
>             if (notification.getNotifier () instanceof Resource) {
>                 switch (notification.getFeatureID (Resource.class)) {
>                     case Resource.RESOURCE__IS_LOADED :
>                     case Resource.RESOURCE__ERRORS :
>                     case Resource.RESOURCE__WARNINGS :
>                         {
>                             Resource resource = (Resource) notification.getNotifier ();
>                             Diagnostic diagnostic = analyzeResourceProblems ((Resource) notification.getNotifier (), null);
>                             if (diagnostic.getSeverity () != Diagnostic.OK) {
>                                 resourceToDiagnosticMap.put (resource, diagnostic);
>                             } else {
>                                 resourceToDiagnosticMap.remove (resource);
>                             }
>                             updateProblemIndication ();
>                         }}
>             } else {
>                 super.notifyChanged (notification);
>             }
>         }
> 
>     }
> 
>     ;
371a423
>             updateProblemIndication = false;
379a432,478
>                         if (! resourceToDiagnosticMap.containsKey (resource)) {
>                             resourceToDiagnosticMap.put (resource, analyzeResourceProblems (resource, exception));
>                         }
>                     }
>                 }
>             }
>             updateProblemIndication = true;
>             updateProblemIndication ();
>         }
>     }
> 
>     protected void updateProblemIndication () {
>         if (updateProblemIndication) {
>             BasicDiagnostic diagnostic = new BasicDiagnostic (Diagnostic.OK, "org.eclipse.gmf.map.edit", 0, null, new Object [] {editingDomain.getResourceSet ()});
>             for (Iterator i = resourceToDiagnosticMap.values ().iterator ();
>             i.hasNext ();) {
>                 Diagnostic childDiagnostic = (Diagnostic) i.next ();
>                 if (childDiagnostic.getSeverity () != Diagnostic.OK) {
>                     diagnostic.add (childDiagnostic);
>                 }
>             }
>             int lastEditorPage = getPageCount () - 1;
>             if (lastEditorPage >= 0 && getEditor (lastEditorPage) instanceof ProblemEditorPart) {
>                 ((ProblemEditorPart) getEditor (lastEditorPage)).setDiagnostic (diagnostic);
>                 if (diagnostic.getSeverity () != Diagnostic.OK) {
>                     setActivePage (lastEditorPage);
>                 }
>             } else if (diagnostic.getSeverity () != Diagnostic.OK) {
>                 ProblemEditorPart problemEditorPart = new ProblemEditorPart ();
>                 problemEditorPart.setDiagnostic (diagnostic);
>                 problemEditorPart.setMarkerHelper (markerHelper);
>                 try {
>                     addPage (getPageCount (), problemEditorPart, getEditorInput ());
>                     lastEditorPage ++;
>                     setPageText (lastEditorPage, problemEditorPart.getPartName ());
>                     setActivePage (lastEditorPage);
>                 } catch (PartInitException exception) {
>                     GMFMapEditPlugin.INSTANCE.log (exception);
>                 }
>             }
> 
>             if (markerHelper.hasMarkers (editingDomain.getResourceSet ())) {
>                 markerHelper.deleteMarkers (editingDomain.getResourceSet ());
>                 if (diagnostic.getSeverity () != Diagnostic.OK) {
>                     try {
>                         markerHelper.createMarkers (diagnostic);
>                     } catch (CoreException exception) {
534a634,637
>         URI resourceURI = URI.createPlatformResourceURI (modelFile.getFile ().getFullPath ().toString ());
>         ;
>         Exception exception = null;
>         Resource resource = null;
536,538c639,659
<             editingDomain.loadResource (URI.createPlatformResourceURI (modelFile.getFile ().getFullPath ().toString ()).toString ());
<         } catch (Exception exception) {
<             GMFMapEditPlugin.INSTANCE.log (exception);
---
>             resource = editingDomain.getResourceSet ().getResource (resourceURI, true);
>         } catch (Exception e) {
>             exception = e;
>             resource = editingDomain.getResourceSet ().getResource (resourceURI, false);
>         }
>         Diagnostic diagnostic = analyzeResourceProblems (resource, exception);
>         if (diagnostic.getSeverity () != Diagnostic.OK) {
>             resourceToDiagnosticMap.put (resource, analyzeResourceProblems (resource, exception));
>         }
>         editingDomain.getResourceSet ().eAdapters ().add (problemIndicationAdapter);
>     }
> 
>     public Diagnostic analyzeResourceProblems (Resource resource, Exception exception) {
>         if (! resource.getErrors ().isEmpty () || ! resource.getWarnings ().isEmpty ()) {
>             BasicDiagnostic basicDiagnostic = new BasicDiagnostic (Diagnostic.ERROR, "org.eclipse.gmf.map.edit", 0, getString ("_UI_CreateModelError_message", resource.getURI ()), new Object [] {exception == null ? (Object) resource : exception});
>             basicDiagnostic.merge (EcoreUtil.computeDiagnostic (resource, true));
>             return basicDiagnostic;
>         } else if (exception != null) {
>             return new BasicDiagnostic (Diagnostic.ERROR, "org.eclipse.gmf.map.edit", 0, getString ("_UI_CreateModelError_message", resource.getURI ()), new Object [] {exception});
>         } else {
>             return Diagnostic.OK_INSTANCE;
539a661
> 
543a666
>         if (! getEditingDomain ().getResourceSet ().getResources ().isEmpty () && ! ((Resource) getEditingDomain ().getResourceSet ().getResources ().get (0)).getContents ().isEmpty ()) {
712a836
>         }
726a851
>         updateProblemIndication ();
857d981
<                 try {
862a987
>                         try {
864a990,991
>                         } catch (Exception exception) {
>                             resourceToDiagnosticMap.put (resource, analyzeResourceProblems (resource, exception));
868,869d994
<                 } catch (Exception exception) {
<                     GMFMapEditPlugin.INSTANCE.log (exception);
875a1001
>         updateProblemIndication = false;
882a1009,1010
>         updateProblemIndication = true;
>         updateProblemIndication ();
