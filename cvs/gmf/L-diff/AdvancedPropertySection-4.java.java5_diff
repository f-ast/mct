1c1
< package org.eclipse.gmf.runtime.lite.properties;
---
> package org.eclipse.gmf.runtime.diagram.ui.properties.sections;
3c3
< import java.util.ArrayList;
---
> import org.eclipse.emf.common.notify.Notification;
5c5
< import java.util.Iterator;
---
> import org.eclipse.emf.ecore.EObject;
7c7
< import org.eclipse.emf.common.notify.AdapterFactory;
---
> import org.eclipse.jface.viewers.ISelection;
9c9
< import org.eclipse.emf.ecore.util.EcoreUtil;
---
> import org.eclipse.swt.SWT;
11c11
< import org.eclipse.emf.transaction.TransactionalEditingDomain;
---
> import org.eclipse.swt.custom.CLabel;
13c13
< import org.eclipse.emf.transaction.util.TransactionUtil;
---
> import org.eclipse.swt.layout.FormAttachment;
15c15
< import org.eclipse.gef.commands.CommandStack;
---
> import org.eclipse.swt.layout.FormData;
17c17
< import org.eclipse.gmf.runtime.lite.parts.CommandStackAdapterManager;
---
> import org.eclipse.swt.widgets.Composite;
19c19
< import org.eclipse.jface.viewers.ISelection;
---
> import org.eclipse.ui.IActionBars;
21c21
< import org.eclipse.jface.viewers.StructuredSelection;
---
> import org.eclipse.ui.IWorkbenchPart;
23c23
< import org.eclipse.swt.widgets.Composite;
---
> import org.eclipse.ui.views.properties.IPropertySourceProvider;
25c25
< import org.eclipse.ui.IWorkbenchPart;
---
> import org.eclipse.ui.views.properties.PropertySheetPage;
29c29,33
< public abstract class AdvancedPropertySection extends org.eclipse.ui.views.properties.tabbed.AdvancedPropertySection {
---
> import org.eclipse.gmf.runtime.common.core.command.CommandManager;
> 
> import org.eclipse.gmf.runtime.emf.core.edit.MFilter;
> 
> import org.eclipse.gmf.runtime.emf.core.exceptions.MSLActionAbandonedException;
31,35c35,78
<     public void createControls (Composite parent, TabbedPropertySheetPage tabbedPropertySheetPage) {
<         super.createControls (parent, tabbedPropertySheetPage);
<         myPropertySheetEntry = new RootUndoablePropertySheetEntry (null, page);
<         myPropertySheetEntry.setPropertySourceProvider (getPropertySourceProvider ());
<         page.setRootEntry (myPropertySheetEntry);
---
> import org.eclipse.gmf.runtime.emf.ui.properties.sections.UndoableModelPropertySheetEntry;
> 
> public class AdvancedPropertySection extends AbstractModelerPropertySection {
>     protected PropertySheetPage page;
> 
>     public void createControls (final Composite parent, TabbedPropertySheetPage aTabbedPropertySheetPage) {
>         super.createControls (parent, aTabbedPropertySheetPage);
>         Composite composite = getWidgetFactory ().createFlatFormComposite (parent);
>         FormData data = null;
>         String tableLabelStr = getTableLabel ();
>         CLabel tableLabel = null;
>         if (tableLabelStr != null && tableLabelStr.length () > 0) {
>             tableLabel = getWidgetFactory ().createCLabel (composite, tableLabelStr);
>             data = new FormData ();
>             data.left = new FormAttachment (0, 0);
>             data.top = new FormAttachment (0, 0);
>             tableLabel.setLayoutData (data);
>         }
>         page = new PropertySheetPage ();
>         UndoableModelPropertySheetEntry root = new UndoableModelPropertySheetEntry (CommandManager.getDefault ());
>         root.setPropertySourceProvider (getPropertySourceProvider ());
>         page.setRootEntry (root);
>         page.createControl (composite);
>         data = new FormData ();
>         data.left = new FormAttachment (0, 0);
>         data.right = new FormAttachment (100, 0);
>         if (tableLabel == null) {
>             data.top = new FormAttachment (0, 0);
>         } else {
>             data.top = new FormAttachment (tableLabel, 0, SWT.BOTTOM);
>         }
>         data.bottom = new FormAttachment (100, 0);
>         data.height = 100;
>         data.width = 100;
>         page.getControl ().setLayoutData (data);
>         setActionBars (aTabbedPropertySheetPage.getSite ().getActionBars ());
>     }
> 
>     public void setActionBars (IActionBars actionBars) {
>         actionBars.getMenuManager ().removeAll ();
>         actionBars.getToolBarManager ().removeAll ();
>         actionBars.getStatusLineManager ().removeAll ();
>         page.makeContributions (actionBars.getMenuManager (), actionBars.getToolBarManager (), actionBars.getStatusLineManager ());
>         actionBars.getToolBarManager ().update (true);
38,62c81,82
<     public void setInput (IWorkbenchPart part, ISelection selection) {
<         if (selection.isEmpty () || false == selection instanceof StructuredSelection) {
<             super.setInput (part, selection);
<             return;
<         }
<         final StructuredSelection structuredSelection = ((StructuredSelection) selection);
<         ArrayList < Object > transformedSelection = new ArrayList < Object > (structuredSelection.size ());
<         for (Iterator < ? > it = structuredSelection.iterator ();
<         it.hasNext ();) {
<             Object r = transformSelection (it.next ());
<             if (r != null) {
<                 transformedSelection.add (r);
<             }
<         }
<         CommandStack commandStack = getCommandStack (transformedSelection);
<         myPropertySheetEntry.setCommandStack (commandStack);
<         super.setInput (part, new StructuredSelection (transformedSelection));
<     }
< 
<     protected CommandStack getCommandStack (ArrayList < ? > selection) {
<         CommandStack result = null;
<         for (Object next : selection) {
<             TransactionalEditingDomain editingDomain = TransactionUtil.getEditingDomain (next);
<             if (editingDomain == null) {
<                 return null;
---
>     protected IPropertySourceProvider getPropertySourceProvider () {
>         return propertiesProvider;
64,65c84,85
<             CommandStack nextStackCandidate = getCommandStack (editingDomain);
<             if (nextStackCandidate == null) {
---
> 
>     protected String getTableLabel () {
68,71c88,90
<             if (result == null) {
<                 result = nextStackCandidate;
<             } else if (result != nextStackCandidate) {
<                 return null;
---
> 
>     public void setInput (IWorkbenchPart part, ISelection selection) {
>         page.selectionChanged (part, selection);
73a93,97
>     public void dispose () {
>         super.dispose ();
>         if (page != null) {
>             page.dispose ();
>             page = null;
75d98
<         return result;
78,80c101,102
<     static CommandStack getCommandStack (TransactionalEditingDomain editingDomain) {
<         if (editingDomain == null) {
<             return null;
---
>     public void refresh () {
>         page.refresh ();
82,84c104,115
<         CommandStackAdapterManager adapterManager = (CommandStackAdapterManager) EcoreUtil.getExistingAdapter (editingDomain.getResourceSet (), CommandStackAdapterManager.class);
<         if (adapterManager == null || adapterManager.isReleased ()) {
<             return null;
---
> 
>     public boolean shouldUseExtraSpace () {
>         return true;
>     }
> 
>     public void update (final Notification notification, EObject element) {
>         if (! isDisposed ()) {
>             postUpdateRequest (new Runnable () {
> 
>                 public void run () {
>                     if (! isDisposed () && ! isNotifierDeleted (notification)) refresh ();
> 
86c117
<         return adapterManager.getCommandStack ();
---
> 
89,91c120
<     protected PropertySourceProvider getPropertySourceProvider () {
<         if (myPropertySourceProvider == null) {
<             myPropertySourceProvider = new PropertySourceProvider (getItemProvidersAdapterFactory ());
---
>             );
93d121
<         return myPropertySourceProvider;
96c124,126
<     protected abstract AdapterFactory getItemProvidersAdapterFactory ();
---
>     public void handleElementCreatedEvent (Notification notification, EObject owner, EObject newElement) {
>         update (notification, owner);
>     }
98,99c128,129
<     protected Object transformSelection (Object selected) {
<         return selected;
---
>     public void handleElementDeletedEvent (Notification notification, EObject owner, EObject oldElement) {
>         update (notification, owner);
102,104c132,141
<     @Override
<     public void refresh () {
<         page.refresh ();
---
>     public MFilter getFilter () {
>         MFilter lifeCycleEventFilter = new MFilter.Or (MFilter.ELEMENT_CREATED_FILTER, MFilter.ELEMENT_DELETED_FILTER);
>         return new MFilter.Or (lifeCycleEventFilter, MFilter.ELEMENT_MODIFIED_FILTER);
>     }
> 
>     protected boolean addToEObjectList (Object object) {
>         return true;
>     }
> 
>     protected void handleException (MSLActionAbandonedException exception) {
107,109d143
<     private PropertySourceProvider myPropertySourceProvider;
<     private CommandStack myCommandStack;
<     private RootUndoablePropertySheetEntry myPropertySheetEntry;
