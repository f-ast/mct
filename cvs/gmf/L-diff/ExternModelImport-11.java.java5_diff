2a3,4
> import java.util.Collection;
> 
34a37,38
> import org.eclipse.emf.ecore.EStructuralFeature.Setting;
> 
70c74,75
<     private EPackage.Registry registry;
---
>     private EPackage.Registry registry = new EPackageRegistryImpl (EPackage.Registry.INSTANCE);
>     private HashSet < URI > myProcessedMetaModels = new HashSet < URI > ();
102,104c107,112
<         Object registry = context.get (EPackageRegistryImpl.class);
<         assert registry == null || registry instanceof EPackage.Registry : "registry must be EPackage.Registry";
<         return (EPackage.Registry) registry;
---
>         Object value = context.get (ExternModelImport.class);
>         assert value == null || value instanceof ExternModelImport : "incorrect object registered as ExternModelImport: " + value.getClass ();
>         if (value instanceof ExternModelImport) {
>             return ((ExternModelImport) value).registry;
>         }
>         return null;
128,129c136,150
<         EPackage.Registry registryToInit = registry != null ? registry : EPackage.Registry.INSTANCE;
<         for (EObject next : EcoreUtil.ExternalCrossReferencer.find (root).keySet ()) {
---
>         Resource metaModelResource = root.eClass ().getEPackage ().eResource ();
>         if (! myProcessedMetaModels.contains (metaModelResource.getURI ())) {
>             for (EObject nextResourceElement : metaModelResource.getContents ()) {
>                 if (nextResourceElement instanceof EPackage) {
>                     registerLocally ((EPackage) nextResourceElement);
>                 }
>             }
>             registerReferencedMetaModels (EcoreUtil.ExternalCrossReferencer.find (metaModelResource));
>             myProcessedMetaModels.add (metaModelResource.getURI ());
>         }
>         registerReferencedMetaModels (EcoreUtil.ExternalCrossReferencer.find (root));
>     }
> 
>     private void registerReferencedMetaModels (Map < EObject, Collection < Setting > > externalCrossReferences) {
>         for (EObject next : externalCrossReferences.keySet ()) {
145c166
<                 registryToInit.getEPackage (nextPackage.getNsURI ());
---
>                 registerLocally (nextPackage);
149a171,174
>     private void registerLocally (EPackage nextPackage) {
>         registry.put (nextPackage.getNsURI (), registry.getEPackage (nextPackage.getNsURI ()));
>     }
> 
159c184
<                 EPackage p = EPackage.Registry.INSTANCE.getEPackage (importVal);
---
>                 EPackage p = registry.getEPackage (importVal);
160a186
>                     registerLocally (p);
212c238
<                     EPackage.Registry.INSTANCE.getEPackage (ePackage.getNsURI ());
---
>                     registerLocally (ePackage);
