3c3
< import org.eclipse.gef.commands.Command;
---
> import java.util.ArrayList;
5c5
< import org.eclipse.gmf.runtime.emf.type.core.commands.DestroyElementCommand;
---
> import java.util.Collection;
7c7
< import org.eclipse.gmf.runtime.emf.type.core.requests.CreateRelationshipRequest;
---
> import java.util.Collections;
9c9
< import org.eclipse.gmf.runtime.emf.type.core.requests.DestroyElementRequest;
---
> import java.util.Iterator;
13c13
< import org.eclipse.emf.ecore.EAnnotation;
---
> import org.eclipse.gef.EditPart;
15c15
< import org.eclipse.gmf.runtime.notation.View;
---
> import org.eclipse.gef.commands.Command;
17c17
< import org.eclipse.emf.ecore.EClass;
---
> import org.eclipse.gef.commands.CompoundCommand;
22a23,24
> import org.eclipse.gmf.gmfgraph.FigureHandle;
> 
24a27,36
> import org.eclipse.gmf.graphdef.editor.edit.commands.EllipseCreateCommand;
> 
> import org.eclipse.gmf.graphdef.editor.edit.commands.PolylineCreateCommand;
> 
> import org.eclipse.gmf.graphdef.editor.edit.commands.Rectangle2CreateCommand;
> 
> import org.eclipse.gmf.graphdef.editor.edit.commands.RoundedRectangleCreateCommand;
> 
> import org.eclipse.gmf.graphdef.editor.edit.parts.RoundedRectangleEditPart;
> 
27c39,41
< import org.eclipse.gmf.runtime.emf.type.core.commands.CreateElementCommand;
---
> import org.eclipse.gmf.runtime.diagram.ui.requests.EditCommandRequestWrapper;
> 
> import org.eclipse.gmf.runtime.emf.type.core.commands.DestroyElementCommand;
32a47,50
> import org.eclipse.gmf.runtime.emf.type.core.requests.CreateRelationshipRequest;
> 
> import org.eclipse.gmf.runtime.emf.type.core.requests.DestroyElementRequest;
> 
34a53,56
> import org.eclipse.gmf.runtime.notation.Edge;
> 
> import org.eclipse.gmf.runtime.notation.View;
> 
42c64
<             return getMSLWrapper (new CreateRectangle_3002Command (req));
---
>             return getMSLWrapper (new Rectangle2CreateCommand (req));
48c70
<             return getMSLWrapper (new CreateEllipse_3003Command (req));
---
>             return getMSLWrapper (new EllipseCreateCommand (req));
54c76
<             return getMSLWrapper (new CreateRoundedRectangle_3004Command (req));
---
>             return getMSLWrapper (new RoundedRectangleCreateCommand (req));
60c82
<             return getMSLWrapper (new CreatePolyline_3005Command (req));
---
>             return getMSLWrapper (new PolylineCreateCommand (req));
65,152d86
<     private static class CreateRectangle_3002Command extends CreateElementCommand {
< 
<         public CreateRectangle_3002Command (CreateElementRequest req) {
<             super (req);
<         }
< 
<         protected EClass getEClassToEdit () {
<             return GMFGraphPackage.eINSTANCE.getRoundedRectangle ();
<         }
< 
<         ;
< 
<         protected EObject getElementToEdit () {
<             EObject container = ((CreateElementRequest) getRequest ()).getContainer ();
<             if (container instanceof View) {
<                 container = ((View) container).getElement ();
<             }
<             return container;
<         }
< 
<     }
< 
<     private static class CreateEllipse_3003Command extends CreateElementCommand {
< 
<         public CreateEllipse_3003Command (CreateElementRequest req) {
<             super (req);
<         }
< 
<         protected EClass getEClassToEdit () {
<             return GMFGraphPackage.eINSTANCE.getRoundedRectangle ();
<         }
< 
<         ;
< 
<         protected EObject getElementToEdit () {
<             EObject container = ((CreateElementRequest) getRequest ()).getContainer ();
<             if (container instanceof View) {
<                 container = ((View) container).getElement ();
<             }
<             return container;
<         }
< 
<     }
< 
<     private static class CreateRoundedRectangle_3004Command extends CreateElementCommand {
< 
<         public CreateRoundedRectangle_3004Command (CreateElementRequest req) {
<             super (req);
<         }
< 
<         protected EClass getEClassToEdit () {
<             return GMFGraphPackage.eINSTANCE.getRoundedRectangle ();
<         }
< 
<         ;
< 
<         protected EObject getElementToEdit () {
<             EObject container = ((CreateElementRequest) getRequest ()).getContainer ();
<             if (container instanceof View) {
<                 container = ((View) container).getElement ();
<             }
<             return container;
<         }
< 
<     }
< 
<     private static class CreatePolyline_3005Command extends CreateElementCommand {
< 
<         public CreatePolyline_3005Command (CreateElementRequest req) {
<             super (req);
<         }
< 
<         protected EClass getEClassToEdit () {
<             return GMFGraphPackage.eINSTANCE.getRoundedRectangle ();
<         }
< 
<         ;
< 
<         protected EObject getElementToEdit () {
<             EObject container = ((CreateElementRequest) getRequest ()).getContainer ();
<             if (container instanceof View) {
<                 container = ((View) container).getElement ();
<             }
<             return container;
<         }
< 
<     }
< 
154,156c88,89
<         return getMSLWrapper (new DestroyElementCommand (req) {
< 
<             protected EObject getElementToDestroy () {
---
>         CompoundCommand cc = new CompoundCommand ();
>         Collection allEdges = new ArrayList ();
158,160c91,98
<                 EAnnotation annotation = view.getEAnnotation ("Shortcut");
<                 if (annotation != null) {
<                     return view;
---
>         allEdges.addAll (view.getSourceEdges ());
>         allEdges.addAll (view.getTargetEdges ());
>         for (Iterator it = allEdges.iterator ();
>         it.hasNext ();) {
>             Edge nextEdge = (Edge) it.next ();
>             EditPart nextEditPart = (EditPart) getHost ().getViewer ().getEditPartRegistry ().get (nextEdge);
>             EditCommandRequestWrapper editCommandRequest = new EditCommandRequestWrapper (new DestroyElementRequest (((RoundedRectangleEditPart) getHost ()).getEditingDomain (), req.isConfirmationRequired ()), Collections.EMPTY_MAP);
>             cc.add (nextEditPart.getCommand (editCommandRequest));
162,167c100,101
<                 return super.getElementToDestroy ();
<             }
< 
<         }
< 
<         );
---
>         cc.add (getMSLWrapper (new DestroyElementCommand (req)));
>         return cc;
172c106
<             return req.getTarget () == null ? null : getCreateCompleteIncomingDiagramElement_Figure4001Command (req);
---
>             return req.getTarget () == null ? null : getCreateCompleteIncomingDiagramElementFigure_4001Command (req);
177,178c111,114
<     protected Command getCreateCompleteIncomingDiagramElement_Figure4001Command (CreateRelationshipRequest req) {
<         if (! (req.getSource () instanceof DiagramElement)) {
---
>     protected Command getCreateCompleteIncomingDiagramElementFigure_4001Command (CreateRelationshipRequest req) {
>         EObject sourceEObject = req.getSource ();
>         EObject targetEObject = req.getTarget ();
>         if (false == sourceEObject instanceof DiagramElement || false == targetEObject instanceof FigureHandle) {
181,182c117,119
<         DiagramElement element = (DiagramElement) req.getSource ();
<         if (element.getFigure () != null) {
---
>         DiagramElement source = (DiagramElement) sourceEObject;
>         FigureHandle target = (FigureHandle) targetEObject;
>         if (! GMFGraphBaseItemSemanticEditPolicy.LinkConstraints.canCreateDiagramElementFigure_4001 (source, target)) {
185c122
<         SetRequest setReq = new SetRequest (req.getSource (), GMFGraphPackage.eINSTANCE.getDiagramElement_Figure (), req.getTarget ());
---
>         SetRequest setReq = new SetRequest (sourceEObject, GMFGraphPackage.eINSTANCE.getDiagramElement_Figure (), target);
