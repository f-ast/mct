28a29,30
> import org.eclipse.emf.ecore.util.EcoreUtil;
> 
32a35,36
> import org.eclipse.emf.transaction.util.TransactionUtil;
> 
45,46d48
< import org.eclipse.gef.commands.Command;
< 
48a51,54
> import org.eclipse.gef.commands.CommandStackEvent;
> 
> import org.eclipse.gef.commands.CommandStackEventListener;
> 
96a103,127
>     private CommandStackEventListener mySaveListener = new CommandStackEventListener () {
> 
>         public void stackChanged (CommandStackEvent event) {
>             if (event.isPostChangeEvent () && isSaved ()) {
>                 getCommandStack ().markSaveLocation ();
>             }
>         }
> 
>         private boolean isSaved () {
>             for (Iterator it = getEditingDomain ().getResourceSet ().getResources ().iterator ();
>             it.hasNext ();) {
>                 Resource next = (Resource) it.next ();
>                 if (! next.isLoaded ()) {
>                     continue;
>                 }
>                 if (! next.isTrackingModification () || next.isModified ()) {
>                     return false;
>                 }
>             }
>             return true;
>         }
> 
>     }
> 
>     ;
159a191
>         getCommandStack ().addCommandStackEventListener (mySaveListener);
165a198
>             getCommandStack ().removeCommandStackEventListener (mySaveListener);
169a203,208
>         ForceTrackingModificationAdapter adapter = (ForceTrackingModificationAdapter) EcoreUtil.getExistingAdapter (getEditingDomain ().getResourceSet (), ForceTrackingModificationAdapter.class);
>         assert adapter != null;
>         adapter.release ();
>         if (adapter.isReleased ()) {
>             getEditingDomain ().getResourceSet ().eAdapters ().remove (adapter);
>         }
239c278,290
<     protected TransactionalEditingDomain getEditingDomain (IEditorInput editorInput) {
---
>     protected TransactionalEditingDomain getEditingDomain (IEditorInput input) {
>         if (input instanceof DiagramEditorInput) {
>             TransactionalEditingDomain result = TransactionUtil.getEditingDomain (((DiagramEditorInput) input).getDiagram ());
>             if (result != null) {
>                 ForceTrackingModificationAdapter adapter = (ForceTrackingModificationAdapter) EcoreUtil.getExistingAdapter (result.getResourceSet (), ForceTrackingModificationAdapter.class);
>                 if (adapter == null) {
>                     adapter = new ForceTrackingModificationAdapter ();
>                     result.getResourceSet ().eAdapters ().add (adapter);
>                 }
>                 adapter.acquire ();
>             }
>             return result;
>         }
258,300d308
<         domain.setCommandStack (new CommandStack () {
< 
<             @Override
<             public void execute (Command command) {
<                 super.execute (command);
<                 if (isSaved ()) {
<                     markSaveLocation ();
<                 }
<             }
< 
<             @Override
<             public void undo () {
<                 super.undo ();
<                 if (isSaved ()) {
<                     markSaveLocation ();
<                 }
<             }
< 
<             @Override
<             public void redo () {
<                 super.redo ();
<                 if (isSaved ()) {
<                     markSaveLocation ();
<                 }
<             }
< 
<             private boolean isSaved () {
<                 for (Iterator it = getEditingDomain ().getResourceSet ().getResources ().iterator ();
<                 it.hasNext ();) {
<                     Resource next = (Resource) it.next ();
<                     if (! next.isLoaded ()) {
<                         continue;
<                     }
<                     if (! next.isTrackingModification () || next.isModified ()) {
<                         return false;
<                     }
<                 }
<                 return true;
<             }
< 
<         }
< 
<         );
345a354,374
>         @Override
>         public boolean isAdapterForType (Object type) {
>             return ForceTrackingModificationAdapter.class.equals (type);
>         }
> 
>         public void acquire () {
>             myRefCount ++;
>         }
> 
>         public void release () {
>             if (myRefCount == 0) {
>                 throw new IllegalStateException ();
>             }
>             myRefCount --;
>         }
> 
>         public boolean isReleased () {
>             return myRefCount == 0;
>         }
> 
>         private int myRefCount;
