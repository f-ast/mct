52a53
>     private boolean isProcessingNotification = false;
68,71c69
<             if (notification.getFeatureID (Resource.class) == Resource.RESOURCE__IS_LOADED) {
<                 if (notification.getNewBooleanValue ()) {
<                     updateImportsAndExports ((Resource) notifier);
<                 } else {
---
>             if (notification.getFeatureID (Resource.class) == Resource.RESOURCE__IS_LOADED && ! notification.getNewBooleanValue ()) {
74d71
<             }
80a78,80
>         if (reference.isContainment ()) {
>             return;
>         }
86,88d85
<                     if (reference.isContainment ()) {
<                         break;
<                     }
102d98
<                         if (! reference.isContainment ()) {
104,106d99
<                         } else {
<                             updateImportsAndExports (newValue, true);
<                         }
115d107
<                         if (! reference.isContainment ()) {
117,119d108
<                         } else {
<                             updateImportsAndExports (newValue, true);
<                         }
126d114
<                         if (! reference.isContainment ()) {
128,130d115
<                         } else {
<                             updateImportsAndExports (oldValue, false);
<                         }
139d123
<                         if (! reference.isContainment ()) {
141,143d124
<                         } else {
<                             updateImportsAndExports (oldValue, false);
<                         }
191c172
<     private void remove (Resource resource, EObject eObject) {
---
>     protected void remove (Resource resource, EObject eObject) {
231a213,218
>             if (isProcessingNotification) {
>                 for (Iterator iter = getInverseReferencers (eObject, null, null).iterator ();
>                 iter.hasNext ();) {
>                     registerReference (((EObject) iter.next ()).eResource (), resource);
>                 }
>             }
338,372d324
<     private void updateImportsAndExports (Resource resource) {
<         for (Iterator i = EcoreUtil.getAllContents (resource, resolve ());
<         i.hasNext ();) {
<             EObject next = (EObject) i.next ();
<             for (Iterator iter = getInverseReferencers (next, null, null).iterator ();
<             iter.hasNext ();) {
<                 registerReference (((EObject) iter.next ()).eResource (), resource);
<             }
<         }
<     }
< 
<     private void updateImportsAndExports (EObject eObject, boolean register) {
<         Resource resource = eObject.eResource ();
<         for (Iterator iter = getInverseReferencers (eObject, null, null).iterator ();
<         iter.hasNext ();) {
<             if (register) {
<                 registerReference (((EObject) iter.next ()).eResource (), resource);
<             } else {
<                 deregisterReference (((EObject) iter.next ()).eResource (), resource);
<             }
<         }
<         for (Iterator i = EcoreUtil.getAllContents (eObject, resolve ());
<         i.hasNext ();) {
<             EObject next = (EObject) i.next ();
<             for (Iterator iter = getInverseReferencers (next, null, null).iterator ();
<             iter.hasNext ();) {
<                 if (register) {
<                     registerReference (((EObject) iter.next ()).eResource (), resource);
<                 } else {
<                     deregisterReference (((EObject) iter.next ()).eResource (), resource);
<                 }
<             }
<         }
<     }
< 
484,487c436,438
<         EContentsEList.FeatureIterator crossReferences = (EContentsEList.FeatureIterator) eObject.eCrossReferences ().iterator ();
<         while (crossReferences.hasNext ()) {
<             InternalEObject referent = (InternalEObject) crossReferences.next ();
<             EReference eReference = (EReference) crossReferences.feature ();
---
>         for (Iterator i = eObject.eClass ().getEAllReferences ().iterator ();
>         i.hasNext ();) {
>             EReference eReference = (EReference) i.next ();
489,490c440,452
<             if (referent != null && eOpposite != null) {
<                 result.add (referent.eSetting (eOpposite));
---
>             if (eOpposite != null && ! eReference.isContainer () && ! eReference.isContainment () && eObject.eIsSet (eReference)) {
>                 if (eReference.isMany ()) {
>                     for (Iterator j = ((Collection) eObject.eGet (eReference)).iterator ();
>                     j.hasNext ();) {
>                         InternalEObject referencingEObject = (InternalEObject) j.next ();
>                         result.add (referencingEObject.eSetting (eOpposite));
>                     }
>                 } else {
>                     InternalEObject referencingEObject = ((InternalEObject) eObject.eGet (eReference));
>                     if (referencingEObject != null) {
>                         result.add (referencingEObject.eSetting (eOpposite));
>                     }
>                 }
495a458,466
>     public final void notifyChanged (Notification notification) {
>         try {
>             isProcessingNotification = true;
>             super.notifyChanged (notification);
>         } finally {
>             isProcessingNotification = false;
>         }
>     }
> 
