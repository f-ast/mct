51,54d50
< import org.eclipse.emf.transaction.impl.InternalTransaction;
< 
< import org.eclipse.emf.transaction.impl.InternalTransactionalEditingDomain;
< 
58a55,56
> import org.eclipse.gef.EditPartViewer;
> 
104a103,104
> import org.eclipse.gmf.runtime.diagram.ui.internal.parts.NotificationForEditPartsListener;
> 
108a109,110
> import org.eclipse.gmf.runtime.diagram.ui.util.EditPartUtil;
> 
129c131
< public abstract class CanonicalEditPolicy extends AbstractEditPolicy implements NotificationListener {
---
> public abstract class CanonicalEditPolicy extends AbstractEditPolicy implements NotificationForEditPartsListener {
356c358
<         if (ep == null || (ep != null && ((DiagramEditPart) ep).isActivatingDiagram ()) || ! isWriteTransactionInProgress ()) options = Collections.singletonMap (Transaction.OPTION_UNPROTECTED, Boolean.TRUE);
---
>         if (ep == null || (ep != null && ((DiagramEditPart) ep).isActivatingDiagram ()) || ! EditPartUtil.isWriteTransactionInProgress ((IGraphicalEditPart) getHost (), false)) options = Collections.singletonMap (Transaction.OPTION_UNPROTECTED, Boolean.TRUE);
737,748c739,740
<     private boolean isWriteTransactionInProgress () {
<         TransactionalEditingDomain theEditingDomain = ((IGraphicalEditPart) getHost ()).getEditingDomain ();
<         if (theEditingDomain instanceof InternalTransactionalEditingDomain) {
<             InternalTransactionalEditingDomain internalEditingDomain = (InternalTransactionalEditingDomain) theEditingDomain;
<             InternalTransaction transaction = internalEditingDomain.getActiveTransaction ();
<             if (transaction != null && ! transaction.isReadOnly ()) {
<                 Object unprotectedMode = transaction.getOptions ().get (Transaction.OPTION_UNPROTECTED);
<                 if (unprotectedMode == null || unprotectedMode == Boolean.FALSE) return true;
< 
<             }
<         }
<         return false;
---
>     final public EditPartViewer getViewer () {
>         return getHost ().getViewer ();
