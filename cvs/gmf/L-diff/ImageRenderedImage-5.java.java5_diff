6a7,8
> import org.eclipse.draw2d.SWTGraphics;
> 
16a19,20
> import org.eclipse.swt.graphics.GC;
> 
23c27,29
< import org.eclipse.swt.widgets.Display;
---
> import org.eclipse.swt.graphics.Rectangle;
> 
> import org.eclipse.ui.PlatformUI;
31,33c37
<     public Image getSWTImage () {
<         if (img != null) return img;
< 
---
>     protected Image renderImage () {
35,42d38
<             img = loadImageFromBuffer ();
<         } catch (Exception e) {
<             Trace.throwing (Draw2dRenderPlugin.getInstance (), Draw2dRenderDebugOptions.EXCEPTIONS_THROWING, ImageRenderedImage.class, "ImageRenderedImage.getSWTImage() : couldn't load image from buffer", e);
<         }
<         return img;
<     }
< 
<     private Image loadImageFromBuffer () throws Exception {
50,51c46,49
<         int newWidth = getKey ().getWidth () == 0 ? origWidth : getKey ().getWidth ();
<         int newHeight = getKey ().getHeight () == 0 ? origHeight : getKey ().getHeight ();
---
>             int bufferWidth = getKey ().getWidth () == 0 ? origWidth : getKey ().getWidth ();
>             int bufferHeight = getKey ().getHeight () == 0 ? origHeight : getKey ().getHeight ();
>             int newWidth = bufferWidth;
>             int newHeight = bufferWidth;
53,56c51,71
<             if (origWidth < origHeight) newWidth = (int) Math.round (newHeight * origWidth / (double) origHeight);
<             else newHeight = (int) Math.round (newWidth * origHeight / (double) origWidth);
< 
<         }
---
>                 if (newWidth > newHeight) {
>                     newHeight = (int) Math.round (newWidth * origHeight / (double) origWidth);
>                 } else {
>                     newWidth = (int) Math.round (newHeight * origWidth / (double) origHeight);
>                 }
>                 double scale = 1.0;
>                 if (newWidth > bufferWidth) scale = bufferWidth / newWidth;
> 
>                 if (newHeight > bufferHeight) scale = Math.min (scale, bufferHeight / (double) newHeight);
> 
>                 newWidth *= scale;
>                 newHeight *= scale;
>                 Image origImage = new Image (PlatformUI.getWorkbench ().getDisplay (), imgData [0]);
>                 Image image = new Image (PlatformUI.getWorkbench ().getDisplay (), new Rectangle (0, 0, bufferWidth, bufferHeight));
>                 GC gc = new GC (image);
>                 SWTGraphics swtG = new SWTGraphics (gc);
>                 swtG.drawImage (origImage, 0, 0, origWidth, origHeight, (bufferWidth - newWidth) / 2, (bufferHeight - newHeight) / 2, newWidth, newHeight);
>                 gc.dispose ();
>                 origImage.dispose ();
>                 return image;
>             } else {
58c73,78
<         return new Image (Display.getDefault (), scaledImgData);
---
>                 return new Image (PlatformUI.getWorkbench ().getDisplay (), scaledImgData);
>             }
>         } catch (Exception e) {
>             Trace.throwing (Draw2dRenderPlugin.getInstance (), Draw2dRenderDebugOptions.EXCEPTIONS_THROWING, ImageRenderedImage.class, "ImageRenderedImage.renderImage() : couldn't load image from buffer", e);
>             return null;
>         }
