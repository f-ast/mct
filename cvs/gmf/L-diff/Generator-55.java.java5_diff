1c1
< package org.eclipse.gmf.internal.codegen.lite;
---
> package org.eclipse.gmf.codegen.util;
3c3
< import java.lang.reflect.InvocationTargetException;
---
> import java.io.ByteArrayInputStream;
5c5,9
< import java.util.HashSet;
---
> import java.lang.ref.SoftReference;
> 
> import java.util.Collection;
> 
> import java.util.Collections;
8a13,14
> import java.util.LinkedList;
> 
11c17,33
< import java.util.Set;
---
> import org.eclipse.core.resources.IFile;
> 
> import org.eclipse.core.resources.IProject;
> 
> import org.eclipse.core.resources.IResource;
> 
> import org.eclipse.core.resources.ResourcesPlugin;
> 
> import org.eclipse.core.runtime.CoreException;
> 
> import org.eclipse.core.runtime.IPath;
> 
> import org.eclipse.core.runtime.IProgressMonitor;
> 
> import org.eclipse.core.runtime.IStatus;
> 
> import org.eclipse.core.runtime.MultiStatus;
17c39
< import org.eclipse.emf.codegen.util.CodeGenUtil;
---
> import org.eclipse.core.runtime.Status;
19c41
< import org.eclipse.emf.common.util.EList;
---
> import org.eclipse.core.runtime.SubProgressMonitor;
21c43
< import org.eclipse.gmf.codegen.gmfgen.GMFGenPackage;
---
> import org.eclipse.emf.codegen.jet.JETEmitter;
23c45
< import org.eclipse.gmf.codegen.gmfgen.GenApplication;
---
> import org.eclipse.emf.codegen.jet.JETException;
25c47
< import org.eclipse.gmf.codegen.gmfgen.GenChildLabelNode;
---
> import org.eclipse.emf.codegen.jmerge.JControlModel;
27c49
< import org.eclipse.gmf.codegen.gmfgen.GenChildSideAffixedNode;
---
> import org.eclipse.emf.codegen.jmerge.JMerger;
29c51
< import org.eclipse.gmf.codegen.gmfgen.GenCommonBase;
---
> import org.eclipse.emf.codegen.util.CodeGenUtil;
31c53
< import org.eclipse.gmf.codegen.gmfgen.GenCompartment;
---
> import org.eclipse.gmf.codegen.gmfgen.GenChildContainer;
33c55,57
< import org.eclipse.gmf.codegen.gmfgen.GenContainerBase;
---
> import org.eclipse.gmf.codegen.gmfgen.GenChildNode;
> 
> import org.eclipse.gmf.codegen.gmfgen.GenCommonBase;
35c59
< import org.eclipse.gmf.codegen.gmfgen.GenCustomPropertyTab;
---
> import org.eclipse.gmf.codegen.gmfgen.GenCompartment;
41,47c65
< import org.eclipse.gmf.codegen.gmfgen.GenExpressionInterpreter;
< 
< import org.eclipse.gmf.codegen.gmfgen.GenExpressionProviderBase;
< 
< import org.eclipse.gmf.codegen.gmfgen.GenExpressionProviderContainer;
< 
< import org.eclipse.gmf.codegen.gmfgen.GenLanguage;
---
> import org.eclipse.gmf.codegen.gmfgen.GenExternalNodeLabel;
53,54d70
< import org.eclipse.gmf.codegen.gmfgen.GenNavigatorChildReference;
< 
59c75
< import org.eclipse.gmf.codegen.gmfgen.GenPreferencePage;
---
> import org.eclipse.gmf.codegen.gmfgen.GenTopLevelNode;
61c77
< import org.eclipse.gmf.codegen.gmfgen.GenPropertyTab;
---
> import org.eclipse.gmf.common.UnexpectedBehaviourException;
63c79
< import org.eclipse.gmf.codegen.gmfgen.GenStandardPreferencePage;
---
> import org.eclipse.jdt.core.ICompilationUnit;
65c81
< import org.eclipse.gmf.codegen.gmfgen.OpenDiagramBehaviour;
---
> import org.eclipse.jdt.core.IPackageFragment;
67c83,87
< import org.eclipse.gmf.common.UnexpectedBehaviourException;
---
> import org.eclipse.jdt.core.IPackageFragmentRoot;
> 
> import org.eclipse.jdt.core.JavaCore;
> 
> import org.eclipse.jdt.core.JavaModelException;
69c89
< import org.eclipse.gmf.common.codegen.ImportAssistant;
---
> import org.eclipse.jdt.core.ToolFactory;
71c91
< import org.eclipse.gmf.internal.common.codegen.GeneratorBase;
---
> import org.eclipse.jdt.core.formatter.CodeFormatter;
73c93
< import org.eclipse.gmf.internal.common.codegen.TextEmitter;
---
> import org.eclipse.jface.text.Document;
75c95
< import org.eclipse.gmf.internal.common.codegen.TextMerger;
---
> import org.eclipse.jface.text.IDocument;
77,78c97,99
< public class Generator extends GeneratorBase implements Runnable {
<     private final GenEditorGenerator myEditorGen;
---
> import org.eclipse.text.edits.TextEdit;
> 
> public class Generator implements Runnable {
80c101,109
<     private final CodegenEmitters myEmitters;
---
>     private IPackageFragmentRoot myDestRoot;
>     private IProject myDestProject;
>     private JControlModel myJControlModel;
>     private CodeFormatter myCodeFormatter;
>     private IProgressMonitor myProgress;
>     private IStatus myRunStatus = Status.CANCEL_STATUS;
>     private List myExceptions;
>     private CodegenEmitters myEmitters;
>     private static SoftReference myCachedEmitters;
83c112
<         this (genModel, Activator.getInstance ().getEmitters (genModel));
---
>         this (genModel.getDiagram ());
86,119c115,120
<     public Generator (GenEditorGenerator genModel, CodegenEmitters emitters) {
<         assert genModel != null && emitters != null;
<         myDiagram = genModel.getDiagram ();
<         myEditorGen = genModel;
<         myEmitters = emitters;
<     }
< 
<     @Override
<     protected TextMerger createMergeService () {
<         return myEmitters.createMergeService ();
<     }
< 
<     @SuppressWarnings("unchecked")
<     protected void customRun () throws InterruptedException, UnexpectedBehaviourException {
<         final String pluginID = myEditorGen.getPlugin ().getID ();
<         final Path examplaryLocation = new Path (myEditorGen.getDomainGenModel ().getModelDirectory ());
<         initializeEditorProject (pluginID, guessNewProjectLocation (examplaryLocation, pluginID));
<         doGenerateFile (myEmitters.getManifestGenerator (), new Path ("META-INF/MANIFEST.MF"), new Object [] {myEditorGen.getPlugin ()});
<         doGenerateFile (myEmitters.getBuildPropertiesGenerator (), new Path ("build.properties"), new Object [] {myEditorGen.getPlugin ()});
<         doGenerateFile (myEmitters.getPluginXML (), new Path ("plugin.xml"), new Object [] {myEditorGen.getPlugin ()});
<         doGenerateFile (myEmitters.getPluginPropertiesGenerator (), new Path ("plugin.properties"), new Object [] {myEditorGen.getPlugin ()});
<         internalGenerateJavaClass (myEmitters.getCreationWizardGenerator (), myDiagram.getCreationWizardQualifiedClassName (), myDiagram);
<         internalGenerateJavaClass (myEmitters.getCreationWizardPageGenerator (), myDiagram.getCreationWizardPageQualifiedClassName (), myDiagram);
<         internalGenerateJavaClass (myEmitters.getPluginGenerator (), myEditorGen.getPlugin ().getActivatorQualifiedClassName (), myEditorGen.getPlugin ());
<         internalGenerateJavaClass (myEmitters.getInitDiagramFileActionGenerator (), myDiagram.getInitDiagramFileActionQualifiedClassName (), myDiagram);
<         internalGenerateJavaClass (myEmitters.getModelElementSelectionPageEmitter (), myEmitters.getModelElementSelectionPageQualifiedNameEmitter (), myDiagram);
<         internalGenerateJavaClass (myEmitters.getNewDiagramFileWizardGenerator (), myDiagram.getNewDiagramFileWizardQualifiedClassName (), myDiagram);
<         if (myEditorGen.getApplication () != null) {
<             internalGenerateJavaClass (myEmitters.getURISelectorPageGenerator (), myEmitters.getURISelectorPageQualifiedClassNameGenerator (), myDiagram);
<         }
<         if (myDiagram.generateCreateShortcutAction ()) {
<             internalGenerateJavaClass (myEmitters.getCreateShortcutActionEmitter (), myDiagram.getCreateShortcutActionQualifiedClassName (), myDiagram);
<             if (myEditorGen.getApplication () != null) {
<                 internalGenerateJavaClass (myEmitters.getShortcutCreationWizardEmitter (), myEmitters.getShortcutCreationWizardQualifiedClassNameEmitter (), myDiagram);
---
>     public Generator (GenDiagram diagram) {
>         myDiagram = diagram;
>         CodegenEmitters old = myCachedEmitters == null ? null : (CodegenEmitters) myCachedEmitters.get ();
>         if (old == null) {
>             myEmitters = new CodegenEmitters (true);
>             myCachedEmitters = new SoftReference (myEmitters);
121c122
<                 internalGenerateJavaClass (myEmitters.getElementChooserEmitter (), myDiagram.getElementChooserQualifiedClassName (), myDiagram);
---
>             myEmitters = old;
124,130c125,128
<         if (myDiagram.generateShortcutIcon ()) {
<             internalGenerateJavaClass (myEmitters.getShortcutProviderEmitter (), myEmitters.getShortcutProviderQualifiedClassNameEmitter (), myDiagram);
<             internalGenerateJavaClass (myEmitters.getCreateShortcutNodeCommandEmitter (), myEmitters.getCreateShortcutNodeCommandQualifiedClassNameEmitter (), myDiagram);
<             internalGenerateJavaClass (myEmitters.getCreateShortcutEdgeCommandEmitter (), myEmitters.getCreateShortcutEdgeCommandQualifiedClassNameEmitter (), myDiagram);
<             generateShortcutIcon ();
<             if (myEditorGen.getApplication () == null) {
<                 internalGenerateJavaClass (myEmitters.getShortcutPropertyTesterEmitter (), myDiagram.getShortcutPropertyTesterQualifiedClassName (), myDiagram);
---
> 
>     public void run (IProgressMonitor progress) throws InterruptedException {
>         setProgressMonitor (progress);
>         doRun ();
131a130,135
> 
>     public void run () {
>         try {
>             doRun ();
>         } catch (InterruptedException ex) {
>             myRunStatus = new Status (IStatus.CANCEL, "org.eclipse.gmf.codegen", 0, Messages.interrupted, ex);
133,155d136
<         internalGenerateJavaClass (myEmitters.getLoadResourceActionGenerator (), myDiagram.getLoadResourceActionQualifiedClassName (), myDiagram);
<         internalGenerateJavaClass (myEmitters.getElementTypesGenerator (), myDiagram.getElementTypesQualifiedClassName (), myDiagram);
<         internalGenerateJavaClass (myEmitters.getActionBarContributorGenerator (), myEditorGen.getEditor ().getActionBarContributorQualifiedClassName (), myEditorGen.getEditor ());
<         internalGenerateJavaClass (myEmitters.getDiagramEditorUtilGenerator (), myDiagram.getDiagramEditorUtilQualifiedClassName (), myDiagram);
<         internalGenerateJavaClass (myEmitters.getEditorGenerator (), myEditorGen.getEditor ().getQualifiedClassName (), myEditorGen.getEditor ());
<         if (myEditorGen.getEditor ().isEclipseEditor ()) {
<             internalGenerateJavaClass (myEmitters.getMatchingStrategyEmitter (), myDiagram.getMatchingStrategyQualifiedClassName (), myDiagram);
<         }
<         if (myEditorGen.getApplication () == null && ! myEditorGen.getEditor ().isEclipseEditor ()) {
<             internalGenerateJavaClass (myEmitters.getOpenDiagramInViewActionGenerator (), myEmitters.getOpenDiagramInViewActionQualifiedClassNameGenerator (), myEditorGen.getEditor ());
<         }
<         if (myDiagram.getPalette () != null) {
<             internalGenerateJavaClass (myEmitters.getPaletteFactoryGenerator (), myDiagram.getPalette ().getFactoryQualifiedClassName (), myDiagram.getPalette ());
<         }
<         internalGenerateJavaClass (myEmitters.getEditPartFactoryGenerator (), myDiagram.getEditPartFactoryQualifiedClassName (), myDiagram);
<         internalGenerateJavaClass (myEmitters.getDiagramEditPartGenerator (), myDiagram.getEditPartQualifiedClassName (), myDiagram);
<         HashSet < OpenDiagramBehaviour > openDiagramBehaviors = new HashSet < OpenDiagramBehaviour > ();
<         generateBehaviors (myDiagram, openDiagramBehaviors);
<         generateLayoutEditPolicy (myDiagram);
<         if (myDiagram.isValidationEnabled () || myEditorGen.hasAudits ()) {
<             generateValidationProvider ();
<             if (myDiagram.getEditorGen ().getApplication () == null) {
<                 generateMarkerNavigationProvider ();
156a138,165
> 
>     private void doRun () throws InterruptedException {
>         try {
>             setupProgressMonitor ();
>             myExceptions = new LinkedList ();
>             initializeEditorProject ();
>             generateReorientConnectionViewCommand ();
>             generateSemanticHints ();
>             generateAbstractParser ();
>             generateStructuralFeatureParser ();
>             generateStructuralFeaturesParser ();
>             generateBaseItemSemanticEditPolicy ();
>             generateBaseGraphicalNodeEditPolicy ();
>             generateReferenceConnectionEditPolicy ();
>             generateDiagramCanonicalEditPolicy ();
>             generateDiagramItemSemanticEditPolicy ();
>             for (Iterator nodes = myDiagram.getTopLevelNodes ().iterator ();
>             nodes.hasNext ();) {
>                 GenTopLevelNode node = (GenTopLevelNode) nodes.next ();
>                 generateNode (node);
>             }
>             for (Iterator nodes = myDiagram.getChildNodes ().iterator ();
>             nodes.hasNext ();) {
>                 GenChildNode node = (GenChildNode) nodes.next ();
>                 if (node.isListContainerEntry ()) {
>                     generateListContainerNode (node);
>                 } else {
>                     generateNode (node);
158,159d166
<         if (myDiagram.getEditorGen ().getMetrics () != null) {
<             generateMetricProvider ();
161,169c168,171
<         for (GenNode next : (List < ? extends GenNode >) myDiagram.getAllNodes ()) {
<             if (! (next instanceof GenChildLabelNode)) {
<                 internalGenerateJavaClass (myEmitters.getNodeEditPartGenerator (), next.getEditPartQualifiedClassName (), next);
<                 generateGraphicalEditPolicy (next);
<                 for (Iterator it2 = next.getLabels ().iterator ();
<                 it2.hasNext ();) {
<                     final GenNodeLabel label = (GenNodeLabel) it2.next ();
<                     internalGenerateJavaClass (myEmitters.getNodeLabelEditPartGenerator (), label.getEditPartQualifiedClassName (), label);
<                     internalGenerateJavaClass (myEmitters.getViewFactoryGenerator (), label.getNotationViewFactoryQualifiedClassName (), label);
---
>             for (Iterator compartments = myDiagram.getCompartments ().iterator ();
>             compartments.hasNext ();) {
>                 GenCompartment compartment = (GenCompartment) compartments.next ();
>                 generateCompartment (compartment);
170a173,226
>             for (Iterator it = myDiagram.getLinks ().iterator ();
>             it.hasNext ();) {
>                 final GenLink next = (GenLink) it.next ();
>                 generateViewFactory (next);
>                 generateLinkEditPart (next);
>                 generateLinkItemSemanticEditPolicy (next);
>                 for (Iterator labels = next.getLabels ().iterator ();
>                 labels.hasNext ();) {
>                     GenLinkLabel label = (GenLinkLabel) labels.next ();
>                     generateLinkLabelEditPart (label);
>                     generateLinkLabelTextEditPart (label);
>                     generateLinkLabelViewFactory (label);
>                     generateLinkLabelTextViewFactory (label);
>                 }
>             }
>             generateViewFactory (myDiagram);
>             generateDiagramEditPart ();
>             generateDiagramExternalNodeLabelEditPart ();
>             generateEditPartFactory ();
>             generateElementTypes ();
>             generateViewProvider ();
>             generateEditPartProvider ();
>             generateMetamodelSupportProvider ();
>             generateModelingAssistantProvider ();
>             generatePropertyProvider ();
>             generateIconProvider ();
>             generateParserProvider ();
>             if (myDiagram.isValidationEnabled ()) {
>                 generateValidationProvider ();
>                 generateMarkerNavigationProvider ();
>             }
>             generateInitDiagramFileAction ();
>             generatePalette ();
>             generateDiagramEditorUtil ();
>             generateDiagramFileCreator ();
>             generateVisualIDRegistry ();
>             generateCreationWizard ();
>             generateCreationWizardPage ();
>             generateEditor ();
>             generateCreateShortcutAction ();
>             generateLoadResourceAction ();
>             generateElementChooser ();
>             generateDocumentProvider ();
>             generateActionBarContributor ();
>             generateMatchingStrategy ();
>             generatePreferencesInitializer ();
>             generatePluginClass ();
>             generateBundleManifest ();
>             generatePluginProperties ();
>             generatePluginXml ();
>             generateBuildProperties ();
>             generateShortcutIcon ();
>             if (myExceptions.isEmpty ()) {
>                 myRunStatus = Status.OK_STATUS;
172c228,240
<                 internalGenerateJavaClass (myEmitters.getChildNodeEditPartGenerator (), next.getEditPartQualifiedClassName (), next);
---
>                 IStatus [] s = (IStatus []) myExceptions.toArray (new IStatus [myExceptions.size ()]);
>                 myRunStatus = new MultiStatus ("org.eclipse.gmf.codegen", 0, s, Messages.problems, null);
>             }
>         } catch (NullPointerException ex) {
>             myRunStatus = new Status (IStatus.ERROR, "org.eclipse.gmf.codegen", 0, NullPointerException.class.getName (), ex);
>         } catch (JETException ex) {
>             myRunStatus = ex.getStatus ();
>         } catch (UnexpectedBehaviourException ex) {
>             myRunStatus = new Status (Status.ERROR, "org.eclipse.gmf.codegen", 0, Messages.unexpected, ex);
>         } finally {
>             myProgress.done ();
>             myExceptions = null;
>         }
174,182c242,257
<             internalGenerateJavaClass (myEmitters.getViewFactoryGenerator (), next.getNotationViewFactoryQualifiedClassName (), next);
<             generateBehaviors (next, openDiagramBehaviors);
<             generateCommands (next);
<             generateComponentEditPolicy (next);
<             boolean shouldGenerateLayoutEditPolicy = false;
<             boolean shouldGenerateSideAffixedLayoutEditPolicy = false;
<             for (GenNode nextChild : next.getChildNodes ()) {
<                 if (nextChild instanceof GenChildSideAffixedNode) {
<                     shouldGenerateSideAffixedLayoutEditPolicy = true;
---
> 
>     public IStatus getRunStatus () {
>         return myRunStatus;
>     }
> 
>     private void generateNode (GenNode node) throws JETException, InterruptedException {
>         generateNodeEditPart (node);
>         for (Iterator labels = node.getLabels ().iterator ();
>         labels.hasNext ();) {
>             GenNodeLabel label = (GenNodeLabel) labels.next ();
>             if (label instanceof GenExternalNodeLabel) {
>                 GenExternalNodeLabel extLabel = (GenExternalNodeLabel) label;
>                 generateExternalNodeLabelEditPart (extLabel);
>                 generateExternalNodeLabelViewFactory (extLabel);
>                 generateExternalNodeLabelTextEditPart (extLabel);
>                 generateExternalNodeLabelTextViewFactory (extLabel);
184c259,260
<                     shouldGenerateLayoutEditPolicy = true;
---
>                 generateNodeLabelEditPart (label);
>                 generateNodeLabelTextViewFactory (label);
187,188c263,265
<             if (shouldGenerateLayoutEditPolicy) {
<                 generateLayoutEditPolicy (next);
---
>         generateChildContainer (node);
>         generateNodeGraphicalNodeEditPolicy (node);
>         generateNodeItemSemanticEditPolicy (node);
190,191c267,271
<             if (shouldGenerateSideAffixedLayoutEditPolicy) {
<                 generateSideAffixedLayoutEditPolicy (next);
---
> 
>     private void generateListContainerNode (GenNode child) throws JETException, InterruptedException {
>         generateListContainerNodeEditPart (child);
>         generateNodeItemSemanticEditPolicy (child);
>         generateViewFactory (child);
192a273,277
> 
>     private void generateCompartment (GenCompartment compartment) throws JETException, InterruptedException {
>         generateCompartmentEditPart (compartment);
>         generateCompartmentItemSemanticEditPolicy (compartment);
>         generateChildContainer (compartment);
194,198c279,282
<         for (GenLink next : (List < ? extends GenLink >) myDiagram.getLinks ()) {
<             internalGenerateJavaClass (myEmitters.getLinkEditPartGenerator (), next.getEditPartQualifiedClassName (), next);
<             generateGraphicalEditPolicy (next);
<             if (next.getLabels ().size () > 0) {
<                 generateConnectionEndpointEditPolicy (next);
---
> 
>     private void generateChildContainer (GenChildContainer childContainer) throws JETException, InterruptedException {
>         generateViewFactory (childContainer);
>         generateChildContainerCanonicalEditPolicy (childContainer);
200,202c284,286
<             for (GenLinkLabel label : (List < ? extends GenLinkLabel >) next.getLabels ()) {
<                 internalGenerateJavaClass (myEmitters.getLinkLabelEditPartGenerator (), label.getEditPartQualifiedClassName (), label);
<                 internalGenerateJavaClass (myEmitters.getViewFactoryGenerator (), label.getNotationViewFactoryQualifiedClassName (), label);
---
> 
>     private void generateReorientConnectionViewCommand () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getReorientConnectionViewCommandEmitter (), myDiagram.getEditCommandsPackageName (), myDiagram.getReorientConnectionViewCommandClassName (), myDiagram);
204,207c288,290
<             internalGenerateJavaClass (myEmitters.getViewFactoryGenerator (), next.getNotationViewFactoryQualifiedClassName (), next);
<             generateBehaviors (next, openDiagramBehaviors);
<             generateCommands (next);
<             generateComponentEditPolicy (next);
---
> 
>     private void generateDiagramEditPart () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getDiagramEditPartEmitter (), myDiagram.getEditPartsPackageName (), myDiagram.getEditPartClassName (), myDiagram);
209,214c292,294
<         for (Iterator it = myDiagram.getCompartments ().iterator ();
<         it.hasNext ();) {
<             final GenCompartment next = (GenCompartment) it.next ();
<             internalGenerateJavaClass (myEmitters.getCompartmentEditPartGenerator (), next.getEditPartQualifiedClassName (), next);
<             internalGenerateJavaClass (myEmitters.getViewFactoryGenerator (), next.getNotationViewFactoryQualifiedClassName (), next);
<             generateLayoutEditPolicy (next);
---
> 
>     private void generateDiagramExternalNodeLabelEditPart () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getDiagramExternalNodeLabelEditPartEmitter (), myDiagram.getEditPartsPackageName (), myDiagram.getBaseExternalNodeLabelEditPartClassName (), myDiagram);
216,220c296,298
<         internalGenerateJavaClass (myEmitters.getViewFactoryGenerator (), myDiagram.getNotationViewFactoryQualifiedClassName (), myDiagram);
<         internalGenerateJavaClass (myEmitters.getDomainElementInitializerGenerator (), myEmitters.getDomainElementInitializerQualifiedNameGenerator (), myDiagram);
<         internalGenerateJavaClass (myEmitters.getVisualIDRegistryGenerator (), myDiagram.getVisualIDRegistryQualifiedClassName (), myDiagram);
<         if (myDiagram.getEditorGen ().getExpressionProviders () != null) {
<             generateExpressionProviders ();
---
> 
>     private void generateNodeEditPart (GenNode genNode) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getNodeEditPartEmitter (), myDiagram.getEditPartsPackageName (), genNode.getEditPartClassName (), genNode);
222,223c300,302
<         if (isPathInsideGenerationTarget (myDiagram.getCreationWizardIconPathX ())) {
<             generateDiagramIcon (myDiagram.getCreationWizardIconPathX ());
---
> 
>     private void generateNodeLabelEditPart (GenNodeLabel label) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getNodeLabelEditPartEmitter (), myDiagram.getEditPartsPackageName (), label.getEditPartClassName (), label);
225,226c304,306
<         if (isPathInsideGenerationTarget (myEditorGen.getEditor ().getIconPathX ())) {
<             generateDiagramIcon (myEditorGen.getEditor ().getIconPathX ());
---
> 
>     private void generateExternalNodeLabelEditPart (GenExternalNodeLabel label) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getExternalNodeLabelEditPartEmitter (), myDiagram.getEditPartsPackageName (), label.getEditPartClassName (), label);
228,244c308,310
<         generateWizardBanner ();
<         if (myEditorGen.getApplication () == null && myEditorGen.getNavigator () != null) {
<             generateNavigatorContentProvider ();
<             generateNavigatorLabelProvider ();
<             generateNavigatorLinkHelper ();
<             generateNavigatorSorter ();
<             generateNavigatorActionProvider ();
<             generateAbstractNavigatorItem ();
<             generateNavigatorGroup ();
<             generateNavigatorItem ();
<             generateNavigatorGroupIcons ();
<             if (myEditorGen.getDomainGenModel () != null && myEditorGen.getNavigator ().isGenerateDomainModelNavigator ()) {
<                 generateDomainNavigatorContentProvider ();
<                 generateDomainNavigatorLabelProvider ();
<                 generateDomainNavigatorItem ();
<                 generateDomainModelElementTester ();
<                 generateURIEditorInputTester ();
---
> 
>     private void generateExternalNodeLabelTextEditPart (GenExternalNodeLabel label) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getExternalNodeLabelTextEditPartEmitter (), myDiagram.getEditPartsPackageName (), label.getTextEditPartClassName (), label);
245a312,314
> 
>     private void generateListContainerNodeEditPart (GenNode genChildNode) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getChildNodeEditPartEmitter (), myDiagram.getEditPartsPackageName (), genChildNode.getEditPartClassName (), genChildNode);
247,248c316,318
<         if (myEditorGen.getPropertySheet () != null) {
<             generatePropertySheetSections ();
---
> 
>     private void generateCompartmentEditPart (GenCompartment genCompartment) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getCompartmentEditPartEmitter (), myDiagram.getEditPartsPackageName (), genCompartment.getEditPartClassName (), genCompartment);
250,252c320,322
<         generateApplication ();
<         generatePreferences ();
<         generateExternalizationSupport ();
---
> 
>     private void generateLinkEditPart (GenLink genLink) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getLinkEditPartEmitter (), myDiagram.getEditPartsPackageName (), genLink.getEditPartClassName (), genLink);
255,258c325,326
<     private static boolean isPathInsideGenerationTarget (String path) {
<         assert path != null;
<         Path p = new Path (path);
<         return ! p.isAbsolute () && ! p.segment (0).equals ("..");
---
>     private void generateLinkLabelEditPart (GenLinkLabel label) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getLinkLabelEditPartEmitter (), myDiagram.getEditPartsPackageName (), label.getEditPartClassName (), label);
261,271c329,330
<     @SuppressWarnings("unchecked")
<     private void generateExpressionProviders () throws UnexpectedBehaviourException, InterruptedException {
<         GenExpressionProviderContainer providerContainer = myEditorGen.getExpressionProviders ();
<         internalGenerateJavaClass (myEmitters.getAbstractExpressionEmitter (), providerContainer.getExpressionsPackageName (), providerContainer.getAbstractExpressionClassName (), myDiagram);
<         for (GenExpressionProviderBase nextProvider : (List < ? extends GenExpressionProviderBase >) providerContainer.getProviders ()) {
<             if (nextProvider instanceof GenExpressionInterpreter) {
<                 TextEmitter providerEmitter = null;
<                 if (GenLanguage.OCL_LITERAL.equals (nextProvider.getLanguage ())) {
<                     providerEmitter = myEmitters.getOCLExpressionFactoryEmitter ();
<                 } else if (GenLanguage.REGEXP_LITERAL.equals (nextProvider.getLanguage ()) || GenLanguage.NREGEXP_LITERAL.equals (nextProvider.getLanguage ())) {
<                     providerEmitter = myEmitters.getRegexpExpressionFactoryEmitter ();
---
>     private void generateLinkLabelTextEditPart (GenLinkLabel label) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getLinkLabelTextEditPartEmitter (), myDiagram.getEditPartsPackageName (), label.getTextEditPartClassName (), label);
274,276c333,334
<                 GenExpressionInterpreter interpreter = (GenExpressionInterpreter) nextProvider;
<                 if (providerEmitter != null) {
<                     internalGenerateJavaClass (providerEmitter, providerContainer.getExpressionsPackageName (), interpreter.getClassName (), interpreter);
---
>     private void generateEditPartFactory () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getEditPartFactoryEmitter (), myDiagram.getEditPartsPackageName (), myDiagram.getEditPartFactoryClassName (), myDiagram);
277a336,338
> 
>     private void generateBaseItemSemanticEditPolicy () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getBaseItemSemanticEditPolicyEmitter (), myDiagram.getEditPoliciesPackageName (), myDiagram.getBaseItemSemanticEditPolicyClassName (), myDiagram);
278a340,342
> 
>     private void generateBaseGraphicalNodeEditPolicy () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getBaseGraphicalNodeEditPolicyEmitter (), myDiagram.getEditPoliciesPackageName (), myDiagram.getBaseGraphicalNodeEditPolicyClassName (), myDiagram);
279a344,346
> 
>     private void generateReferenceConnectionEditPolicy () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getReferenceConnectionEditPolicyEmitter (), myDiagram.getEditPoliciesPackageName (), myDiagram.getReferenceConnectionEditPolicyClassName (), myDiagram);
282,283c349,350
<     private void generateShortcutIcon () throws UnexpectedBehaviourException, InterruptedException {
<         doGenerateBinaryFile (myEmitters.getShortcutImageEmitter (), new Path ("icons/shortcut.gif"), null);
---
>     private void generateDiagramCanonicalEditPolicy () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getDiagramCanonicalEditPolicyEmitter (), myDiagram.getEditPoliciesPackageName (), myDiagram.getCanonicalEditPolicyClassName (), myDiagram);
286,288c353,354
<     private void generateDiagramIcon (String path) throws UnexpectedBehaviourException, InterruptedException {
<         Object [] args = new Object [] {myDiagram.getDomainDiagramElement () == null ? myEditorGen.getDiagramFileExtension () : myDiagram.getDomainDiagramElement ().getGenPackage ().getPrefix ()};
<         doGenerateBinaryFile (myEmitters.getDiagramIconEmitter (), new Path (path), args);
---
>     private void generateChildContainerCanonicalEditPolicy (GenChildContainer genContainer) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getChildContainerCanonicalEditPolicyEmitter (), myDiagram.getEditPoliciesPackageName (), genContainer.getCanonicalEditPolicyClassName (), genContainer);
291,297c357,358
<     private void generateWizardBanner () throws UnexpectedBehaviourException, InterruptedException {
<         try {
<             Object [] args = new Object [] {myEmitters.getWizardBannerStemEmitter ().generate (new NullProgressMonitor (), new Object [] {myDiagram})};
<             String path = myEmitters.getWizardBannerLocationEmitter ().generate (new NullProgressMonitor (), new Object [] {myDiagram});
<             doGenerateBinaryFile (myEmitters.getWizardBannerImageEmitter (), new Path (path), args);
<         } catch (InvocationTargetException e) {
<             handleException (e);
---
>     private void generateDiagramItemSemanticEditPolicy () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getDiagramItemSemanticEditPolicyEmitter (), myDiagram.getEditPoliciesPackageName (), myDiagram.getItemSemanticEditPolicyClassName (), myDiagram);
298a360,362
> 
>     private void generateCompartmentItemSemanticEditPolicy (GenCompartment genCompartment) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getCompartmentItemSemanticEditPolicyEmitter (), myDiagram.getEditPoliciesPackageName (), genCompartment.getItemSemanticEditPolicyClassName (), genCompartment);
301,305c365,366
<     private void generateBehaviors (GenCommonBase element, HashSet < OpenDiagramBehaviour > generatedBehaviors) throws UnexpectedBehaviourException, InterruptedException {
<         for (OpenDiagramBehaviour behaviour : element.getBehaviour (OpenDiagramBehaviour.class)) {
<             if (! generatedBehaviors.contains (behaviour)) {
<                 generatedBehaviors.add (behaviour);
<                 generateOpenDiagramEditPolicy (behaviour);
---
>     private void generateNodeGraphicalNodeEditPolicy (GenNode genNode) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getNodeGraphicalNodeEditPolicyEmitter (), myDiagram.getEditPoliciesPackageName (), genNode.getGraphicalNodeEditPolicyClassName (), genNode);
306a368,370
> 
>     private void generateNodeItemSemanticEditPolicy (GenNode genNode) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getNodeItemSemanticEditPolicyEmitter (), myDiagram.getEditPoliciesPackageName (), genNode.getItemSemanticEditPolicyClassName (), genNode);
307a372,374
> 
>     private void generateLinkItemSemanticEditPolicy (GenLink genLink) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getLinkItemSemanticEditPolicyEmitter (), myDiagram.getEditPoliciesPackageName (), genLink.getItemSemanticEditPolicyClassName (), genLink);
310,312c377,378
<     private void generateValidationProvider () throws UnexpectedBehaviourException, InterruptedException {
<         internalGenerateJavaClass (myEmitters.getValidationProviderGenerator (), myDiagram.getProvidersPackageName (), myDiagram.getValidationProviderClassName (), myDiagram);
<         internalGenerateJavaClass (myEmitters.getValidateActionGenerator (), myEmitters.getValidateActionQualifiedNameGenerator (), myDiagram);
---
>     private void generateAbstractParser () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getAbstractParserEmitter (), myDiagram.getProvidersPackageName (), myDiagram.getAbstractParserClassName (), myDiagram);
315,316c381,382
<     private void generateMarkerNavigationProvider () throws UnexpectedBehaviourException, InterruptedException {
<         internalGenerateJavaClass (myEmitters.getMarkerNavigationProviderEmitter (), myDiagram.getProvidersPackageName (), myDiagram.getMarkerNavigationProviderClassName (), myDiagram);
---
>     private void generateStructuralFeatureParser () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getStructuralFeatureParserEmitter (), myDiagram.getProvidersPackageName (), myDiagram.getStructuralFeatureParserClassName (), myDiagram);
319,321c385,386
<     private void generateMetricProvider () throws UnexpectedBehaviourException, InterruptedException {
<         internalGenerateJavaClass (myEmitters.getMetricProviderEmitter (), myDiagram.getProvidersPackageName (), myDiagram.getMetricProviderClassName (), myDiagram);
<         internalGenerateJavaClass (myEmitters.getMetricsActionEmitter (), myEmitters.getMetricsActionQualifiedNameEmitter (), myDiagram);
---
>     private void generateStructuralFeaturesParser () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getStructuralFeaturesParserEmitter (), myDiagram.getProvidersPackageName (), myDiagram.getStructuralFeaturesParserClassName (), myDiagram);
324,325c389,390
<     private void generateOpenDiagramEditPolicy (OpenDiagramBehaviour behaviour) throws UnexpectedBehaviourException, InterruptedException {
<         internalGenerateJavaClass (myEmitters.getOpenDiagramEditPolicyEmitter (), behaviour.getEditPolicyQualifiedClassName (), behaviour);
---
>     private void generateSemanticHints () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getSemanticHintsEmitter (), myDiagram.getProvidersPackageName (), myDiagram.getSemanticHintsClassName (), myDiagram);
328,330c393,394
<     private void generateCommands (GenNode genNode) throws UnexpectedBehaviourException, InterruptedException {
<         if (! genNode.getDomainMetaClass ().isAbstract ()) {
<             internalGenerateJavaClass (myEmitters.getCreateNodeCommandEmitter (), myEmitters.getCreateNodeCommandQualifiedClassNameEmitter (), genNode);
---
>     private void generateElementTypes () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getElementTypesEmitter (), myDiagram.getProvidersPackageName (), myDiagram.getElementTypesClassName (), myDiagram);
332,333c396,398
<         internalGenerateJavaClass (myEmitters.getAddNodeCommandEmitter (), myEmitters.getAddNodeCommandQualifiedClassNameEmitter (), genNode);
<         internalGenerateJavaClass (myEmitters.getCloneNodeCommandEmitter (), myEmitters.getCloneNodeCommandQualifiedClassNameEmitter (), genNode);
---
> 
>     private void generateViewProvider () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getViewProviderEmitter (), myDiagram.getProvidersPackageName (), myDiagram.getNotationViewProviderClassName (), myDiagram);
336,338c401,402
<     private void generateCommands (GenLink genLink) throws UnexpectedBehaviourException, InterruptedException {
<         if (! genLink.isViewDirectionAlignedWithModel ()) {
<             return;
---
>     private void generateEditPartProvider () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getEditPartProviderEmitter (), myDiagram.getProvidersPackageName (), myDiagram.getEditPartProviderClassName (), myDiagram);
340,343c404,406
<         internalGenerateJavaClass (myEmitters.getCreateLinkStartCommandEmitter (), myEmitters.getCreateLinkStartCommandQualifiedClassNameEmitter (), genLink);
<         internalGenerateJavaClass (myEmitters.getCreateLinkCompleteCommandEmitter (), myEmitters.getCreateLinkCompleteCommandQualifiedClassNameEmitter (), genLink);
<         internalGenerateJavaClass (myEmitters.getReconnectLinkSourceCommandEmitter (), myEmitters.getReconnectLinkSourceCommandQualifiedClassNameEmitter (), genLink);
<         internalGenerateJavaClass (myEmitters.getReconnectLinkTargetCommandEmitter (), myEmitters.getReconnectLinkTargetCommandQualifiedClassNameEmitter (), genLink);
---
> 
>     private void generateMetamodelSupportProvider () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getMetamodelSupportProviderEmitter (), myDiagram.getProvidersPackageName (), myDiagram.getMetamodelSupportProviderClassName (), myDiagram);
346,347c409,410
<     private void generateLayoutEditPolicy (GenContainerBase containerBase) throws InterruptedException, UnexpectedBehaviourException {
<         internalGenerateJavaClass (myEmitters.getLayoutEditPolicyEmitter (), myEmitters.getLayoutEditPolicyQualifiedClassNameEmitter (), containerBase);
---
>     private void generateModelingAssistantProvider () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getModelingAssistantProviderEmitter (), myDiagram.getProvidersPackageName (), myDiagram.getModelingAssistantProviderClassName (), myDiagram);
350,351c413,414
<     private void generateSideAffixedLayoutEditPolicy (GenNode node) throws InterruptedException, UnexpectedBehaviourException {
<         internalGenerateJavaClass (myEmitters.getSideAffixedLayoutEditPolicyEmitter (), myEmitters.getSideAffixedLayoutEditPolicyQualifiedClassNameEmitter (), node);
---
>     private void generatePropertyProvider () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getPropertyProviderEmitter (), myDiagram.getProvidersPackageName (), myDiagram.getPropertyProviderClassName (), myDiagram);
354,355c417,418
<     private void generateGraphicalEditPolicy (GenNode genNode) throws InterruptedException, UnexpectedBehaviourException {
<         internalGenerateJavaClass (myEmitters.getGraphicalEditPolicyEmitter (), genNode.getGraphicalNodeEditPolicyQualifiedClassName (), genNode);
---
>     private void generateIconProvider () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getIconProviderEmitter (), myDiagram.getProvidersPackageName (), myDiagram.getIconProviderClassName (), myDiagram);
358,359c421,422
<     private void generateGraphicalEditPolicy (GenLink genLink) throws InterruptedException, UnexpectedBehaviourException {
<         internalGenerateJavaClass (myEmitters.getGraphicalEditPolicyEmitter (), myEmitters.getGraphicalEditPolicyQualifiedClassNameEmitter (), genLink);
---
>     private void generateParserProvider () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getParserProviderEmitter (), myDiagram.getProvidersPackageName (), myDiagram.getParserProviderClassName (), myDiagram);
362,363c425,426
<     private void generateComponentEditPolicy (GenCommonBase genElement) throws InterruptedException, UnexpectedBehaviourException {
<         internalGenerateJavaClass (myEmitters.getComponentEditPolicyEmitter (), myEmitters.getComponentEditPolicyQualifiedClassNameEmitter (), genElement);
---
>     private void generateValidationProvider () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getValidationProviderEmitter (), myDiagram.getProvidersPackageName (), myDiagram.getValidationProviderClassName (), myDiagram);
366,367c429,430
<     private void generateConnectionEndpointEditPolicy (GenLink genLink) throws InterruptedException, UnexpectedBehaviourException {
<         internalGenerateJavaClass (myEmitters.getConnectionEndpointEditPolicyEmitter (), myEmitters.getConnectionEndpointEditPolicyQualifiedClassNameEmitter (), genLink);
---
>     private void generateMarkerNavigationProvider () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getMarkerNavigationProviderEmitter (), myDiagram.getProvidersPackageName (), myDiagram.getMarkerNavigationProviderClassName (), myDiagram);
370,371c433,434
<     private void generateNavigatorContentProvider () throws InterruptedException {
<         internalGenerateJavaClass (myEmitters.getNavigatorContentProviderEmitter (), myEditorGen.getNavigator ().getPackageName (), myEditorGen.getNavigator ().getContentProviderClassName (), myEditorGen.getNavigator ());
---
>     private void generateViewFactory (GenCommonBase genElement) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getViewFactoryEmitter (), myDiagram.getNotationViewFactoriesPackageName (), genElement.getNotationViewFactoryClassName (), genElement);
374,375c437,438
<     private void generateDomainNavigatorContentProvider () throws InterruptedException {
<         doGenerateJavaClass (myEmitters.getDomainNavigatorContentProviderEmitter (), myEditorGen.getNavigator ().getDomainContentProviderQualifiedClassName (), myEditorGen.getNavigator ());
---
>     private void generateLinkLabelViewFactory (GenLinkLabel label) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getLabelViewFactoryEmitter (), myDiagram.getNotationViewFactoriesPackageName (), label.getNotationViewFactoryClassName (), label);
378,379c441,442
<     private void generateDomainNavigatorLabelProvider () throws InterruptedException {
<         doGenerateJavaClass (myEmitters.getDomainNavigatorLabelProviderEmitter (), myEditorGen.getNavigator ().getDomainLabelProviderQualifiedClassName (), myEditorGen.getNavigator ());
---
>     private void generateLinkLabelTextViewFactory (GenLinkLabel label) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getLabelTextViewFactoryEmitter (), myDiagram.getNotationViewFactoriesPackageName (), label.getTextNotationViewFactoryClassName (), label);
382,383c445,446
<     private void generateDomainNavigatorItem () throws InterruptedException {
<         doGenerateJavaClass (myEmitters.getDomainNavigatorItemEmitter (), myEditorGen.getNavigator ().getDomainNavigatorItemQualifiedClassName (), myEditorGen.getNavigator ());
---
>     private void generateExternalNodeLabelViewFactory (GenExternalNodeLabel label) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getLabelViewFactoryEmitter (), myDiagram.getNotationViewFactoriesPackageName (), label.getNotationViewFactoryClassName (), label);
386,387c449,450
<     private void generateDomainModelElementTester () throws InterruptedException {
<         doGenerateJavaClass (myEmitters.getDomainModelElementTesterEmitter (), myEditorGen.getNavigator ().getDomainModelElementTesterQualifiedClassName (), myEditorGen.getNavigator ());
---
>     private void generateExternalNodeLabelTextViewFactory (GenExternalNodeLabel label) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getLabelTextViewFactoryEmitter (), myDiagram.getNotationViewFactoriesPackageName (), label.getTextNotationViewFactoryClassName (), label);
390,391c453,454
<     private void generateURIEditorInputTester () throws InterruptedException {
<         doGenerateJavaClass (myEmitters.getURIEditorInputTesterEmitter (), myEditorGen.getNavigator ().getUriInputTesterQualifiedClassName (), myEditorGen.getNavigator ());
---
>     private void generateNodeLabelTextViewFactory (GenNodeLabel label) throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getLabelTextViewFactoryEmitter (), myDiagram.getNotationViewFactoriesPackageName (), label.getNotationViewFactoryClassName (), label);
394,395c457,458
<     private void generateNavigatorLabelProvider () throws InterruptedException, UnexpectedBehaviourException {
<         internalGenerateJavaClass (myEmitters.getNavigatorLabelProviderEmitter (), myEditorGen.getNavigator ().getPackageName (), myEditorGen.getNavigator ().getLabelProviderClassName (), myEditorGen.getNavigator ());
---
>     private void generateInitDiagramFileAction () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getInitDiagramFileActionEmitter (), myDiagram.getEditorPackageName (), myDiagram.getInitDiagramFileActionClassName (), myDiagram);
398,399c461,462
<     private void generateNavigatorLinkHelper () throws InterruptedException {
<         if (! myEditorGen.getEditor ().isEclipseEditor ()) {
---
>     private void generatePalette () throws JETException, InterruptedException {
>         if (myDiagram.getPalette () == null) {
402c465
<         internalGenerateJavaClass (myEmitters.getNavigatorLinkHelperEmitter (), myEditorGen.getNavigator ().getPackageName (), myEditorGen.getNavigator ().getLinkHelperClassName (), myEditorGen.getNavigator ());
---
>         doGenerateJavaClass (myEmitters.getPaletteEmitter (), myDiagram.getPalette ().getPackageName (), myDiagram.getPalette ().getFactoryClassName (), myDiagram);
405,406c468,469
<     private void generateNavigatorSorter () throws InterruptedException, UnexpectedBehaviourException {
<         internalGenerateJavaClass (myEmitters.getNavigatorSorterEmitter (), myEditorGen.getNavigator ().getPackageName (), myEditorGen.getNavigator ().getSorterClassName (), myEditorGen.getNavigator ());
---
>     private void generateDiagramEditorUtil () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getDiagramEditorUtilEmitter (), myDiagram.getEditorPackageName (), myDiagram.getDiagramEditorUtilClassName (), myDiagram);
409,410c472,473
<     private void generateNavigatorActionProvider () throws InterruptedException, UnexpectedBehaviourException {
<         internalGenerateJavaClass (myEmitters.getNavigatorActionProviderEmitter (), myEditorGen.getNavigator ().getPackageName (), myEditorGen.getNavigator ().getActionProviderClassName (), myEditorGen.getNavigator ());
---
>     private void generateDiagramFileCreator () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getDiagramFileCreatorEmitter (), myDiagram.getEditorPackageName (), myDiagram.getDiagramFileCreatorClassName (), myDiagram);
413,414c476,477
<     private void generateAbstractNavigatorItem () throws InterruptedException, UnexpectedBehaviourException {
<         doGenerateJavaClass (myEmitters.getAbstractNavigatorItemEmitter (), myEditorGen.getNavigator ().getPackageName (), myEditorGen.getNavigator ().getAbstractNavigatorItemClassName (), myEditorGen.getNavigator ());
---
>     private void generateVisualIDRegistry () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getVisualIDRegistryEmitter (), myDiagram.getEditorPackageName (), myDiagram.getVisualIDRegistryClassName (), myDiagram);
417,418c480,481
<     private void generateNavigatorGroup () throws InterruptedException {
<         internalGenerateJavaClass (myEmitters.getNavigatorGroupEmitter (), myEditorGen.getNavigator ().getPackageName (), myEditorGen.getNavigator ().getNavigatorGroupClassName (), myEditorGen.getNavigator ());
---
>     private void generateCreationWizard () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getCreationWizardEmitter (), myDiagram.getEditorPackageName (), myDiagram.getCreationWizardClassName (), myDiagram);
421,422c484,485
<     private void generateNavigatorItem () throws InterruptedException {
<         internalGenerateJavaClass (myEmitters.getNavigatorItemEmitter (), myEditorGen.getNavigator ().getPackageName (), myEditorGen.getNavigator ().getNavigatorItemClassName (), myEditorGen.getNavigator ());
---
>     private void generateCreationWizardPage () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getCreationWizardPageEmitter (), myDiagram.getEditorPackageName (), myDiagram.getCreationWizardPageClassName (), myDiagram);
425,430c488,489
<     @SuppressWarnings("unchecked")
<     private void generateNavigatorGroupIcons () throws InterruptedException, UnexpectedBehaviourException {
<         Set < String > groupIcons = new HashSet < String > ();
<         for (GenNavigatorChildReference nextReference : (List < ? extends GenNavigatorChildReference >) myEditorGen.getNavigator ().getChildReferences ()) {
<             if (nextReference.getGroupIcon () != null && nextReference.getGroupIcon ().length () > 0) {
<                 groupIcons.add (nextReference.getGroupIcon ());
---
>     private void generateEditor () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getEditorEmitter (), myDiagram.getEditorPackageName (), myDiagram.getEditorClassName (), myDiagram);
431a491,494
> 
>     private void generateCreateShortcutAction () throws JETException, InterruptedException {
>         if (! myDiagram.generateCreateShortcutAction ()) {
>             return;
433,434c496
<         for (String iconPath : groupIcons) {
<             generateGroupIcon (new Path (iconPath));
---
>         doGenerateJavaClass (myEmitters.getCreateShortcutActionEmitter (), myDiagram.getEditorPackageName (), myDiagram.getCreateShortcutActionClassName (), myDiagram);
435a498,500
> 
>     private void generateLoadResourceAction () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getLoadResourceActionEmitter (), myDiagram.getEditorPackageName (), myDiagram.getLoadResourceActionClassName (), myDiagram);
438,439c503,507
<     private void generateGroupIcon (Path groupIconPath) throws InterruptedException, UnexpectedBehaviourException {
<         doGenerateBinaryFile (myEmitters.getGroupIconEmitter (), groupIconPath, null);
---
>     private void generateElementChooser () throws JETException, InterruptedException {
>         if (! myDiagram.generateCreateShortcutAction ()) {
>             return;
>         }
>         doGenerateJavaClass (myEmitters.getElementChooserEmitter (), myDiagram.getEditorPackageName (), myDiagram.getElementChooserClassName (), myDiagram);
442,445c510,511
<     @SuppressWarnings("unchecked")
<     protected void generatePropertySheetSections () throws UnexpectedBehaviourException, InterruptedException {
<         if (myEditorGen.getPropertySheet ().isNeedsCaption ()) {
<             doGenerateJavaClass (myEmitters.getPropertySheetLabelProviderEmitter (), myEditorGen.getPropertySheet ().getLabelProviderQualifiedClassName (), myEditorGen.getPropertySheet ());
---
>     private void generateDocumentProvider () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getDocumentProviderEmitter (), myDiagram.getEditorPackageName (), myDiagram.getDocumentProviderClassName (), myDiagram);
447,449c513,515
<         for (GenPropertyTab tab : (List < ? extends GenPropertyTab >) myEditorGen.getPropertySheet ().getTabs ()) {
<             if (tab instanceof GenCustomPropertyTab) {
<                 doGenerateJavaClass (myEmitters.getPropertySectionEmitter (), ((GenCustomPropertyTab) tab).getQualifiedClassName (), tab);
---
> 
>     private void generateActionBarContributor () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getActionBarContributorEmitter (), myDiagram.getEditorPackageName (), myDiagram.getActionBarContributorClassName (), myDiagram);
450a517,519
> 
>     private void generateMatchingStrategy () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getMatchingStrategyEmitter (), myDiagram.getEditorPackageName (), myDiagram.getMatchingStrategyClassName (), myDiagram);
451a521,523
> 
>     private void generatePreferencesInitializer () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getPreferencesInitializerEmitter (), myDiagram.getEditorPackageName (), myDiagram.getPreferenceInitializerClassName (), myDiagram);
454,461c526,527
<     private void generateApplication () throws UnexpectedBehaviourException, InterruptedException {
<         GenApplication application = myEditorGen.getApplication ();
<         if (application != null) {
<             doGenerateJavaClass (myEmitters.getApplicationEmitter (), application.getQualifiedClassName (), application);
<             doGenerateJavaClass (myEmitters.getActionBarAdvisorEmitter (), application.getActionBarAdvisorQualifiedClassName (), application);
<             doGenerateJavaClass (myEmitters.getPerspectiveEmitter (), application.getPerspectiveQualifiedClassName (), application);
<             doGenerateJavaClass (myEmitters.getWorkbenchAdvisorEmitter (), application.getWorkbenchAdvisorQualifiedClassName (), application);
<             doGenerateJavaClass (myEmitters.getWorkbenchWindowAdvisorEmitter (), application.getWorkbenchWindowAdvisorQualifiedClassName (), application);
---
>     private void generatePluginClass () throws JETException, InterruptedException {
>         doGenerateJavaClass (myEmitters.getPluginClassEmitter (), myDiagram.getEditorPackageName (), myDiagram.getEditorGen ().getPlugin ().getActivatorClassName (), myDiagram.getEditorGen ().getPlugin ());
462a529,539
> 
>     private void generatePluginXml () throws JETException, InterruptedException {
>         doGenerateFile (myEmitters.getPluginXmlEmitter (), new Path ("plugin.xml"), myDiagram.getEditorGen ().getPlugin ());
>     }
> 
>     private void generatePluginProperties () throws JETException, InterruptedException {
>         doGenerateFile (myEmitters.getPluginPropertiesEmitter (), new Path ("plugin.properties"), myDiagram.getEditorGen ().getPlugin ());
>     }
> 
>     private void generateBundleManifest () throws JETException, InterruptedException {
>         doGenerateFile (myEmitters.getBundleManifestEmitter (), new Path ("META-INF/MANIFEST.MF"), myDiagram.getEditorGen ().getPlugin ());
465,466c542,543
<     private void generatePreferences () throws UnexpectedBehaviourException, InterruptedException {
<         generatePreferences (myDiagram.getPreferencePages ());
---
>     private void generateBuildProperties () throws JETException, InterruptedException {
>         doGenerateFile (myEmitters.getBuildPropertiesEmitter (), new Path ("build.properties"), myDiagram);
469,472c546,548
<     private void generatePreferences (EList < GenPreferencePage > pages) throws UnexpectedBehaviourException, InterruptedException {
<         for (GenPreferencePage preferencePage : pages) {
<             if (preferencePage instanceof GenStandardPreferencePage) {
<                 generatePreferencePage ((GenStandardPreferencePage) preferencePage);
---
>     private void generateShortcutIcon () throws InterruptedException {
>         if (! myDiagram.generateShortcutIcon ()) {
>             return;
474c550,560
<             generatePreferences (preferencePage.getChildren ());
---
>         Path iconPath = new Path ("icons/shortcut.gif");
>         IProgressMonitor pm = getNextStepMonitor ();
>         try {
>             pm.beginTask (iconPath.lastSegment (), 3);
>             IPath containerPath = myDestProject.getFullPath ().append (iconPath.removeLastSegments (1));
>             CodeGenUtil.findOrCreateContainer (containerPath, false, (IPath) null, new SubProgressMonitor (pm, 1));
>             IFile f = myDestProject.getFile (iconPath);
>             if (f.exists ()) {
>                 f.setContents (new ByteArrayInputStream (myEmitters.getShortcutImageEmitter ().generateGif ()), true, true, new SubProgressMonitor (pm, 1));
>             } else {
>                 f.create (new ByteArrayInputStream (myEmitters.getShortcutImageEmitter ().generateGif ()), true, new SubProgressMonitor (pm, 1));
475a562,593
>             f.getParent ().refreshLocal (IResource.DEPTH_ONE, new SubProgressMonitor (pm, 1));
>         } catch (CoreException ex) {
>             myExceptions.add (ex.getStatus ());
>         } finally {
>             pm.done ();
>         }
>     }
> 
>     private void doGenerateFile (JETEmitter emitter, IPath filePath, Object param) throws JETException, InterruptedException {
>         assert ! myDestProject.getName ().equals (filePath.segment (0));
>         IProgressMonitor pm = getNextStepMonitor ();
>         try {
>             pm.beginTask (filePath.lastSegment (), 4);
>             IPath containerPath = myDestProject.getFullPath ().append (filePath.removeLastSegments (1));
>             CodeGenUtil.findOrCreateContainer (containerPath, false, (IPath) null, new SubProgressMonitor (pm, 1));
>             String genText = emitter.generate (new SubProgressMonitor (pm, 1), new Object [] {param});
>             IFile f = myDestProject.getFile (filePath);
>             if (f.exists ()) {
>                 f.setContents (new ByteArrayInputStream (genText.getBytes ()), true, true, new SubProgressMonitor (pm, 1));
>             } else {
>                 f.create (new ByteArrayInputStream (genText.getBytes ()), true, new SubProgressMonitor (pm, 1));
>             }
>             f.getParent ().refreshLocal (IResource.DEPTH_ONE, new SubProgressMonitor (pm, 1));
>         } catch (CoreException ex) {
>             myExceptions.add (ex.getStatus ());
>         } finally {
>             pm.done ();
>         }
>     }
> 
>     public void setProgressMonitor (IProgressMonitor progress) {
>         myProgress = progress;
478,485c596,631
<     private void generatePreferencePage (GenStandardPreferencePage preferencePage) throws UnexpectedBehaviourException, InterruptedException {
<         switch (preferencePage.getKind ()) {
<             case APPEARANCE_LITERAL :
<                 internalGenerateJavaClass (myEmitters.getAppearancePreferencePageEmitter (), myEmitters.getAppearancePreferencePageQualifiedClassNameEmitter (), myDiagram);
<                 break;
<             case GENERAL_LITERAL :
<                 internalGenerateJavaClass (myEmitters.getGeneralPreferencePageEmitter (), myEmitters.getGeneralPreferencePageQualifiedClassNameEmitter (), myDiagram);
<                 break;
---
>     private void setupProgressMonitor () {
>         if (myProgress == null) {
>             myProgress = new NullProgressMonitor ();
>             return;
>         }
>         Counter c = new Counter (myDiagram);
>         c.setAdditionalOperations (8);
>         c.setOperationsPerNode (2);
>         c.setOperationsPerListContainerNode (1);
>         c.setOperationsPerLink (2);
>         myProgress.beginTask (Messages.start, c.getTotal ());
>     }
> 
>     private IProgressMonitor getNextStepMonitor () throws InterruptedException {
>         if (myProgress.isCanceled ()) {
>             throw new InterruptedException ();
>         }
>         return new SubProgressMonitor (myProgress, 1);
>     }
> 
>     private void initializeEditorProject () throws UnexpectedBehaviourException, InterruptedException {
>         myDestProject = ResourcesPlugin.getWorkspace ().getRoot ().getProject (myDiagram.getEditorGen ().getPlugin ().getID ());
>         final Path srcPath = new Path ('/' + myDestProject.getName () + "/src");
>         final Path projectLocation = null;
>         final List referencedProjects = createReferencedProjectsList ();
>         final int style = org.eclipse.emf.codegen.ecore.Generator.EMF_PLUGIN_PROJECT_STYLE;
>         final List pluginVariables = null;
>         final IProgressMonitor pm = getNextStepMonitor ();
>         org.eclipse.emf.codegen.ecore.Generator.createEMFProject (srcPath, projectLocation, referencedProjects, pm, style, pluginVariables);
>         try {
>             myDestRoot = JavaCore.create (myDestProject).findPackageFragmentRoot (srcPath);
>         } catch (JavaModelException ex) {
>             throw new UnexpectedBehaviourException (ex.getMessage ());
>         }
>         if (myDestRoot == null) {
>             throw new UnexpectedBehaviourException ("no source root can be found");
489,493c635,636
<     private void generateExternalizationSupport () throws UnexpectedBehaviourException, InterruptedException {
<         String packageName = myEditorGen.getEditor ().getPackageName ();
<         String messagesClassName = "Messages";
<         doGenerateJavaClass (myEmitters.getExternalizeEmitter (), packageName, messagesClassName, new Object [] {myEditorGen});
<         doGenerateFile (myEmitters.getMessagesEmitter (), new Path (messagesClassName.toLowerCase () + ".properties"), new Object [] {myEditorGen});
---
>     private List createReferencedProjectsList () {
>         return Collections.EMPTY_LIST;
496,497c639,660
<     private void internalGenerateJavaClass (TextEmitter emitter, String qualifiedClassName, Object argument) throws InterruptedException {
<         internalGenerateJavaClass (emitter, CodeGenUtil.getPackageName (qualifiedClassName), CodeGenUtil.getSimpleClassName (qualifiedClassName), argument);
---
>     private void doGenerateJavaClass (JETEmitter emitter, String packageName, String className, Object input) throws InterruptedException {
>         IProgressMonitor pm = getNextStepMonitor ();
>         try {
>             pm.beginTask (className, 4);
>             String genText = emitter.generate (new SubProgressMonitor (pm, 1), new Object [] {input});
>             IPackageFragment pf = myDestRoot.createPackageFragment (packageName, true, new SubProgressMonitor (pm, 1));
>             ICompilationUnit cu = pf.getCompilationUnit (className + ".java");
>             if (cu.exists ()) {
>                 genText = merge (genText, cu.getSource (), new SubProgressMonitor (pm, 1));
>             } else {
>                 pm.worked (1);
>             }
>             pf.createCompilationUnit (cu.getElementName (), formatCode (genText), true, new SubProgressMonitor (pm, 1));
>         } catch (NullPointerException ex) {
>             myExceptions.add (new Status (IStatus.ERROR, "org.eclipse.gmf.codegen", 0, ex.getMessage (), ex));
>         } catch (JETException ex) {
>             myExceptions.add (ex.getStatus ());
>         } catch (CoreException ex) {
>             myExceptions.add (ex.getStatus ());
>         } finally {
>             pm.done ();
>         }
500,501c663,676
<     private void internalGenerateJavaClass (TextEmitter emitter, TextEmitter qualifiedClassNameEmitter, Object argument) throws InterruptedException {
<         String qualifiedClassName = null;
---
>     private String merge (String generatedText, String oldContents, IProgressMonitor pm) {
>         pm.beginTask (Messages.merge, 1);
>         JMerger jMerge = new JMerger ();
>         jMerge.setControlModel (getJControlModel ());
>         jMerge.setSourceCompilationUnit (jMerge.createCompilationUnitForContents (generatedText));
>         jMerge.setTargetCompilationUnit (jMerge.createCompilationUnitForContents (oldContents));
>         jMerge.merge ();
>         pm.done ();
>         return jMerge.getTargetCompilationUnitContents ();
>     }
> 
>     private String formatCode (String text) {
>         IDocument doc = new Document (text);
>         TextEdit edit = getCodeFormatter ().format (CodeFormatter.K_COMPILATION_UNIT, doc.get (), 0, doc.get ().length (), 0, null);
503,528c678,756
<             qualifiedClassName = qualifiedClassNameEmitter.generate (new NullProgressMonitor (), new Object [] {argument});
<         } catch (InvocationTargetException e) {
<             handleException (e);
<         } catch (UnexpectedBehaviourException e) {
<             handleException (e);
<         }
<         internalGenerateJavaClass (emitter, qualifiedClassName, argument);
<     }
< 
<     private void internalGenerateJavaClass (TextEmitter emitter, String packageName, String className, Object argument) throws InterruptedException {
<         ImportAssistant importUtil = createImportAssistant (packageName, className);
<         doGenerateJavaClass (emitter, packageName, className, argument, importUtil);
<     }
< 
<     protected void setupProgressMonitor () {
<         Counter c = new Counter ();
<         c.registerFactor (GMFGenPackage.eINSTANCE.getGenNode (), 2);
<         c.registerFactor (GMFGenPackage.eINSTANCE.getGenCompartment (), 2);
<         c.registerFactor (GMFGenPackage.eINSTANCE.getGenLink (), 2);
<         c.registerFactor (GMFGenPackage.eINSTANCE.getGenNodeLabel (), 2);
<         c.registerFactor (GMFGenPackage.eINSTANCE.getGenLinkLabel (), 2);
<         int total = c.getTotal (myDiagram);
<         total ++;
<         total += 4;
<         total += 15;
<         setupProgressMonitor (null, total);
---
>             if (edit != null) {
>                 edit.apply (doc);
>                 text = doc.get ();
>             }
>         } catch (Exception ex) {
>             ex.printStackTrace ();
>         }
>         return text;
>     }
> 
>     private CodeFormatter getCodeFormatter () {
>         if (myCodeFormatter == null) {
>             myCodeFormatter = ToolFactory.createCodeFormatter (null);
>         }
>         return myCodeFormatter;
>     }
> 
>     private JControlModel getJControlModel () {
>         if (myJControlModel == null) {
>             myJControlModel = new JControlModel (myEmitters.getJMergeControlFile ().toString ());
>         }
>         return myJControlModel;
>     }
> 
>     private static final class Counter {
>         private final GenDiagram myDiagram;
>         private int myOpsPerNode = 1;
>         private int myOpsPerLink = 1;
>         private int myOpsPerListContainerNode = 1;
>         private int myAdditionalOps = 0;
>         private int myOpsPerCompartment = 1;
> 
>         Counter (GenDiagram diagram) {
>             myDiagram = diagram;
>         }
> 
>         public void setOperationsPerNode (int opsPerNode) {
>             myOpsPerNode = opsPerNode;
>         }
> 
>         public void setOperationsPerLink (int opsPerLink) {
>             myOpsPerLink = opsPerLink;
>         }
> 
>         public void setOperationsPerListContainerNode (int opsPerChild) {
>             myOpsPerListContainerNode = opsPerChild;
>         }
> 
>         public void setOperationsPerCompartment (int opsPerCompartment) {
>             myOpsPerCompartment = opsPerCompartment;
>         }
> 
>         public void setAdditionalOperations (int additionalOps) {
>             myAdditionalOps = additionalOps;
>         }
> 
>         public int getTotal () {
>             int rv = myAdditionalOps;
>             rv += myDiagram.getTopLevelNodes ().size () * myOpsPerNode;
>             rv += getChildNodesCount (myDiagram.getChildNodes ());
>             rv += myDiagram.getCompartments ().size () * myOpsPerCompartment;
>             rv += myDiagram.getLinks ().size () * myOpsPerLink;
>             return rv;
>         }
> 
>         private int getChildNodesCount (Collection nodes) {
>             int counter = 0;
>             for (Iterator it = nodes.iterator ();
>             it.hasNext ();) {
>                 GenChildNode nextNode = (GenChildNode) it.next ();
>                 if (nextNode.isListContainerEntry ()) {
>                     counter += myOpsPerNode;
>                 } else {
>                     counter += myOpsPerListContainerNode;
>                 }
>             }
>             return counter;
>         }
> 
