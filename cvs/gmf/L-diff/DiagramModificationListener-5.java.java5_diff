4a5,6
> import org.eclipse.emf.common.notify.Notifier;
> 
11c13
< import org.eclipse.emf.transaction.DemultiplexingListener;
---
> import org.eclipse.emf.ecore.resource.ResourceSet;
13c15
< import org.eclipse.emf.transaction.NotificationFilter;
---
> import org.eclipse.emf.ecore.util.EContentAdapter;
15c17
< import org.eclipse.emf.transaction.ResourceSetListener;
---
> import org.eclipse.emf.transaction.NotificationFilter;
23,24c25
< public class DiagramModificationListener {
<     private ResourceSetListener diagramChangeListener = null;
---
> public class DiagramModificationListener extends EContentAdapter {
25a27,28
>     private NotificationFilter diagramResourceModifiedFilter;
>     private DiagramDocument document;
27,28c30,32
<     public DiagramModificationListener (final AbstractDocumentProvider documentProvider, final DiagramDocument document) {
<         final Diagram diagram = document.getDiagram ();
---
>     public DiagramModificationListener (AbstractDocumentProvider documentProvider, DiagramDocument document) {
>         this.document = document;
>         Diagram diagram = document.getDiagram ();
30,32c34,54
<         NotificationFilter diagramResourceModifiedFilter = NotificationFilter.createNotifierFilter (diagram.eResource ()).and (NotificationFilter.createEventTypeFilter (Notification.SET).or (NotificationFilter.createEventTypeFilter (Notification.UNSET))).and (NotificationFilter.createFeatureFilter (Resource.class, Resource.RESOURCE__IS_MODIFIED));
<         if (diagramChangeListener == null) {
<             diagramChangeListener = new DemultiplexingListener (diagramResourceModifiedFilter) {
---
>         diagramResourceModifiedFilter = NotificationFilter.createNotifierFilter (diagram.eResource ()).and (NotificationFilter.createEventTypeFilter (Notification.SET).or (NotificationFilter.createEventTypeFilter (Notification.UNSET))).and (NotificationFilter.createFeatureFilter (Resource.class, Resource.RESOURCE__IS_MODIFIED));
>     }
> 
>     public void startListening () {
>         EList adapters = getEditingDomain ().getResourceSet ().eAdapters ();
>         if (! adapters.contains (this)) {
>             adapters.add (this);
>         }
>     }
> 
>     public void stopListening () {
>         getEditingDomain ().getResourceSet ().eAdapters ().remove (this);
>     }
> 
>     protected TransactionalEditingDomain getEditingDomain () {
>         return editingDomain;
>     }
> 
>     protected DiagramDocument getDiagramDocument () {
>         return document;
>     }
34,35c56,65
<                 protected void handleNotification (TransactionalEditingDomain domain, Notification notification) {
<                     if (diagram != null && notification.getNotifier () instanceof Resource) {
---
>     public boolean isAdapterForType (Object type) {
>         return type == DiagramModificationListener.class;
>     }
> 
>     public void notifyChanged (Notification notification) {
>         if (notification.getNotifier () instanceof ResourceSet) {
>             super.notifyChanged (notification);
>         }
>         if (diagramResourceModifiedFilter.matches (notification)) {
>             if (getDiagramDocument ().getDiagram () != null && notification.getNotifier () instanceof Resource) {
42c72
<                                     document.setContent (document.getContent ());
---
>                             getDiagramDocument ().setContent (getDiagramDocument ().getContent ());
48d77
< 
51c80,82
<             ;
---
>     public void unsetTarget (Notifier oldTarget) {
>         if (oldTarget instanceof ResourceSet) {
>             super.unsetTarget (oldTarget);
55,56c86,87
<     public void startListening () {
<         getEditingDomain ().addResourceSetListener (diagramChangeListener);
---
>     public Notifier getTarget () {
>         return null;
59,60c90,92
<     public void stopListening () {
<         getEditingDomain ().removeResourceSetListener (diagramChangeListener);
---
>     public void setTarget (Notifier newTarget) {
>         if (newTarget instanceof ResourceSet) {
>             super.setTarget (newTarget);
62,64d93
< 
<     protected TransactionalEditingDomain getEditingDomain () {
<         return editingDomain;
