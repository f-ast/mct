69c69
<     private final Map metamodelTypeDescriptorsByEClass;
---
>     private final Map metamodelTypeDescriptorsByNsURI;
78c78
<         metamodelTypeDescriptorsByEClass = new HashMap ();
---
>         metamodelTypeDescriptorsByNsURI = new HashMap ();
271c271,272
<         Collection descriptors = (Collection) metamodelTypeDescriptorsByEClass.get (eClass);
---
>         Map metamodelTypeDescriptorsByEClass = (Map) metamodelTypeDescriptorsByNsURI.get (eClass.getEPackage ().getNsURI ());
>         Collection descriptors = metamodelTypeDescriptorsByEClass != null ? (Collection) metamodelTypeDescriptorsByEClass.get (eClass.getName ()) : null;
285c286
<                 descriptors = (Collection) metamodelTypeDescriptorsByEClass.get (nextEClass);
---
>                 descriptors = metamodelTypeDescriptorsByEClass != null ? (Collection) metamodelTypeDescriptorsByEClass.get (nextEClass.getName ()) : null;
425,426c426,433
<         EClass eClass = typeDescriptor.getEClass ();
<         Collection descriptors = (Collection) metamodelTypeDescriptorsByEClass.get (eClass);
---
>         String nsURI = typeDescriptor.getNsURI ();
>         String eClassName = typeDescriptor.getEClassName ();
>         Map metamodelTypeDescriptorsByEClass = (Map) metamodelTypeDescriptorsByNsURI.get (nsURI);
>         if (metamodelTypeDescriptorsByEClass == null) {
>             metamodelTypeDescriptorsByEClass = new HashMap ();
>             metamodelTypeDescriptorsByNsURI.put (nsURI, metamodelTypeDescriptorsByEClass);
>         }
>         Collection descriptors = (Collection) metamodelTypeDescriptorsByEClass.get (eClassName);
429c436
<             metamodelTypeDescriptorsByEClass.put (eClass, descriptors);
---
>             metamodelTypeDescriptorsByEClass.put (eClassName, descriptors);
