20a21,22
> import org.eclipse.gmf.runtime.draw2d.ui.internal.l10n.Draw2dResourceManager;
> 
37,38d38
< import org.eclipse.gmf.runtime.draw2d.ui.internal.l10n.Draw2dResourceManager;
< 
40,65c40,42
<     protected static class State {
<         private double zoom;
<         private double appliedX;
<         private double appliedY;
<         private Font font;
<         private int lineWidth;
< 
<         protected State () {
<         }
< 
<         protected State (double zoom, double x, double y, Font font, int lineWidth) {
<             this.zoom = zoom;
<             this.appliedX = x;
<             this.appliedY = y;
<             this.font = font;
<             this.lineWidth = lineWidth;
<         }
< 
<         protected void setValues (double zoom, double x, double y, Font font, int lineWidth) {
<             this.zoom = zoom;
<             this.appliedX = x;
<             this.appliedY = y;
<             this.font = font;
<             this.lineWidth = lineWidth;
<         }
< 
---
>     private static class FontHeightCache {
>         Font font;
>         int height;
95,97c72,97
<     private static class FontHeightCache {
<         Font font;
<         int height;
---
>     protected static class State {
>         private double appliedX;
>         private double appliedY;
>         private Font font;
>         private int lineWidth;
>         private double zoom;
> 
>         protected State () {
>         }
> 
>         protected State (double zoom, double x, double y, Font font, int lineWidth) {
>             this.zoom = zoom;
>             this.appliedX = x;
>             this.appliedY = y;
>             this.font = font;
>             this.lineWidth = lineWidth;
>         }
> 
>         protected void setValues (double zoom, double x, double y, Font font, int lineWidth) {
>             this.zoom = zoom;
>             this.appliedX = x;
>             this.appliedY = y;
>             this.font = font;
>             this.lineWidth = lineWidth;
>         }
> 
100,113d99
<     private static final Rectangle TEMP = new Rectangle ();
<     private Map fontDataCache = new HashMap ();
<     private FontHeightCache localCache = new FontHeightCache ();
<     private FontHeightCache targetCache = new FontHeightCache ();
<     private Graphics graphics;
<     private Font localFont;
<     private int localLineWidth;
<     private double fractionalX;
<     private double fractionalY;
<     double zoom = 1.0;
<     private List stack = new ArrayList ();
<     private int stackPointer = 0;
<     private FontKey fontKey = new FontKey ();
<     private boolean allowText = true;
114a101
>     private final Rectangle tempRECT = new Rectangle ();
121a109,122
>     private boolean allowText = true;
>     private Map fontDataCache = new HashMap ();
>     private FontKey fontKey = new FontKey ();
>     private double fractionalX;
>     private double fractionalY;
>     private Graphics graphics;
>     private FontHeightCache localCache = new FontHeightCache ();
>     private Font localFont;
>     private int localLineWidth;
>     private List stack = new ArrayList ();
>     private int stackPointer = 0;
>     private FontHeightCache targetCache = new FontHeightCache ();
>     double zoom = 1.0;
> 
131a133,136
>     Font createFont (FontData data) {
>         return new Font (Display.getCurrent (), data);
>     }
> 
145,155d149
<     public void fillArc (int x, int y, int w, int h, int offset, int sweep) {
<         Rectangle z = zoomFillRect (x, y, w, h);
<         if (z.isEmpty () || sweep == 0) return;
< 
<         graphics.fillArc (z, offset, sweep);
<     }
< 
<     public void fillGradient (int x, int y, int w, int h, boolean vertical) {
<         graphics.fillGradient (zoomFillRect (x, y, w, h), vertical);
<     }
< 
179,180c173,174
<     public void fillOval (int x, int y, int w, int h) {
<         graphics.fillOval (zoomFillRect (x, y, w, h));
---
>     public void drawPoint (int x, int y) {
>         graphics.drawPoint ((int) Math.floor (x * zoom + fractionalX), (int) Math.floor (y * zoom + fractionalY));
191,202d184
<     public void drawPoint (int x, int y) {
<         graphics.drawPoint ((int) Math.floor (x * zoom + fractionalX), (int) Math.floor (y * zoom + fractionalY));
<     }
< 
<     public void fillPolygon (int [] points) {
<         graphics.fillPolygon (zoomPointList (points));
<     }
< 
<     public void fillPolygon (PointList points) {
<         graphics.fillPolygon (zoomPointList (points.toIntArray ()));
<     }
< 
215,218d196
<     public void fillRectangle (int x, int y, int w, int h) {
<         graphics.fillRectangle (zoomFillRect (x, y, w, h));
<     }
< 
223,226d200
<     public void fillRoundRectangle (Rectangle r, int arcWidth, int arcHeight) {
<         graphics.fillRoundRectangle (zoomFillRect (r.x, r.y, r.width, r.height), (int) (arcWidth * zoom), (int) (arcHeight * zoom));
<     }
< 
232,236d205
<     public void fillString (String s, int x, int y) {
<         if (allowText) graphics.fillString (s, zoomTextPoint (x, y));
< 
<     }
< 
252a222,257
>     public void fillArc (int x, int y, int w, int h, int offset, int sweep) {
>         Rectangle z = zoomFillRect (x, y, w, h);
>         if (z.isEmpty () || sweep == 0) return;
> 
>         graphics.fillArc (z, offset, sweep);
>     }
> 
>     public void fillGradient (int x, int y, int w, int h, boolean vertical) {
>         graphics.fillGradient (zoomFillRect (x, y, w, h), vertical);
>     }
> 
>     public void fillOval (int x, int y, int w, int h) {
>         graphics.fillOval (zoomFillRect (x, y, w, h));
>     }
> 
>     public void fillPolygon (int [] points) {
>         graphics.fillPolygon (zoomPointList (points));
>     }
> 
>     public void fillPolygon (PointList points) {
>         graphics.fillPolygon (zoomPointList (points.toIntArray ()));
>     }
> 
>     public void fillRectangle (int x, int y, int w, int h) {
>         graphics.fillRectangle (zoomFillRect (x, y, w, h));
>     }
> 
>     public void fillRoundRectangle (Rectangle r, int arcWidth, int arcHeight) {
>         graphics.fillRoundRectangle (zoomFillRect (r.x, r.y, r.width, r.height), (int) (arcWidth * zoom), (int) (arcHeight * zoom));
>     }
> 
>     public void fillString (String s, int x, int y) {
>         if (allowText) graphics.fillString (s, zoomTextPoint (x, y));
> 
>     }
> 
257a263,274
>     public double getAbsoluteScale () {
>         return zoom * graphics.getAbsoluteScale ();
>     }
> 
>     public int getAlpha () {
>         return graphics.getAlpha ();
>     }
> 
>     public int getAntialias () {
>         return graphics.getAntialias ();
>     }
> 
261a279,293
>     Font getCachedFont (FontKey key) {
>         FontData data = key.font.getFontData () [0];
>         data.setHeight (key.height);
>         return Draw2dResourceManager.getInstance ().getFont (Display.getCurrent (), data);
>     }
> 
>     FontData getCachedFontData (Font f) {
>         FontData data = (FontData) fontDataCache.get (f);
>         if (data != null) return data;
> 
>         data = getLocalFont ().getFontData () [0];
>         fontDataCache.put (f, data);
>         return data;
>     }
> 
272a305,308
>     public int getFillRule () {
>         return graphics.getFillRule ();
>     }
> 
284a321,332
>     public int getInterpolation () {
>         return graphics.getInterpolation ();
>     }
> 
>     public int getLineCap () {
>         return graphics.getLineCap ();
>     }
> 
>     public int getLineJoin () {
>         return graphics.getLineJoin ();
>     }
> 
301,302c349,350
<     public double getAbsoluteScale () {
<         return zoom * graphics.getAbsoluteScale ();
---
>     public int getTextAntialias () {
>         return graphics.getTextAntialias ();
344,364c392,393
<     void setScale (double value) {
<         if (zoom == value) return;
< 
<         this.zoom = value;
<         graphics.setFont (zoomFont (getLocalFont ()));
<         graphics.setLineWidth (zoomLineWidth (localLineWidth));
<     }
< 
<     Font getCachedFont (FontKey key) {
<         FontData data = key.font.getFontData () [0];
<         data.setHeight (key.height);
<         return Draw2dResourceManager.getInstance ().getFont (Display.getCurrent (), data);
<     }
< 
<     FontData getCachedFontData (Font f) {
<         FontData data = (FontData) fontDataCache.get (f);
<         if (data != null) return data;
< 
<         data = getLocalFont ().getFontData () [0];
<         fontDataCache.put (f, data);
<         return data;
---
>     public void setAlpha (int alpha) {
>         graphics.setAlpha (alpha);
367,368c396,397
<     Font createFont (FontData data) {
<         return new Font (Display.getCurrent (), data);
---
>     public void setAntialias (int value) {
>         graphics.setAntialias (value);
378a408,411
>     public void setFillRule (int rule) {
>         graphics.setFillRule (rule);
>     }
> 
386a420,435
>     public void setInterpolation (int interpolation) {
>         graphics.setInterpolation (interpolation);
>     }
> 
>     public void setLineCap (int cap) {
>         graphics.setLineCap (cap);
>     }
> 
>     public void setLineDash (int [] dash) {
>         graphics.setLineDash (dash);
>     }
> 
>     public void setLineJoin (int join) {
>         graphics.setLineJoin (join);
>     }
> 
404a454,465
>     void setScale (double value) {
>         if (zoom == value) return;
> 
>         this.zoom = value;
>         graphics.setFont (zoomFont (getLocalFont ()));
>         graphics.setLineWidth (zoomLineWidth (localLineWidth));
>     }
> 
>     public void setTextAntialias (int value) {
>         graphics.setTextAntialias (value);
>     }
> 
416a478,544
>     private Rectangle zoomClipRect (Rectangle r) {
>         tempRECT.x = (int) (Math.floor (r.x * zoom + fractionalX));
>         tempRECT.y = (int) (Math.floor (r.y * zoom + fractionalY));
>         tempRECT.width = (int) (Math.ceil (((r.x + r.width) * zoom + fractionalX))) - tempRECT.x;
>         tempRECT.height = (int) (Math.ceil (((r.y + r.height) * zoom + fractionalY))) - tempRECT.y;
>         return tempRECT;
>     }
> 
>     private Rectangle zoomFillRect (int x, int y, int w, int h) {
>         tempRECT.x = (int) (Math.floor ((x * zoom + fractionalX)));
>         tempRECT.y = (int) (Math.floor ((y * zoom + fractionalY)));
>         tempRECT.width = (int) (Math.floor (((x + w - 1) * zoom + fractionalX))) - tempRECT.x + 1;
>         tempRECT.height = (int) (Math.floor (((y + h - 1) * zoom + fractionalY))) - tempRECT.y + 1;
>         return tempRECT;
>     }
> 
>     Font zoomFont (Font f) {
>         if (f == null) f = Display.getCurrent ().getSystemFont ();
> 
>         FontData data = getCachedFontData (f);
>         int zoomedFontHeight = zoomFontHeight (data.getHeight ());
>         allowText = zoomedFontHeight > 0;
>         fontKey.setValues (f, zoomedFontHeight);
>         return getCachedFont (fontKey);
>     }
> 
>     int zoomFontHeight (int height) {
>         return (int) (zoom * height);
>     }
> 
>     int zoomLineWidth (int w) {
>         return w;
>     }
> 
>     private int [] zoomPointList (int [] points) {
>         int [] scaled = null;
>         for (int i = 0;
>         i < intArrayCache.length; i ++) {
>             if (intArrayCache [i].length == points.length) {
>                 scaled = intArrayCache [i];
>                 if (i != 0) {
>                     int [] temp = intArrayCache [i - 1];
>                     intArrayCache [i - 1] = scaled;
>                     intArrayCache [i] = temp;
>                 }
>             }
>         }
>         if (scaled == null) {
>             intArrayCache [intArrayCache.length - 1] = new int [points.length];
>             scaled = intArrayCache [intArrayCache.length - 1];
>         }
>         for (int i = 0;
>         (i + 1) < points.length; i += 2) {
>             scaled [i] = (int) (Math.floor ((points [i] * zoom + fractionalX)));
>             scaled [i + 1] = (int) (Math.floor ((points [i + 1] * zoom + fractionalY)));
>         }
>         return scaled;
>     }
> 
>     protected Rectangle zoomRect (int x, int y, int w, int h) {
>         tempRECT.x = (int) (Math.floor (x * zoom + fractionalX));
>         tempRECT.y = (int) (Math.floor (y * zoom + fractionalY));
>         tempRECT.width = (int) (Math.floor (((x + w) * zoom + fractionalX))) - tempRECT.x;
>         tempRECT.height = (int) (Math.floor (((y + h) * zoom + fractionalY))) - tempRECT.y;
>         return tempRECT;
>     }
> 
453c581
<     private Point zoomTextPoint (int x, int y) {
---
>     Point zoomTextPoint (int x, int y) {
467,535c595,596
<     private int [] zoomPointList (int [] points) {
<         int [] scaled = null;
<         for (int i = 0;
<         i < intArrayCache.length; i ++) {
<             if (intArrayCache [i].length == points.length) {
<                 scaled = intArrayCache [i];
<                 if (i != 0) {
<                     int [] temp = intArrayCache [i - 1];
<                     intArrayCache [i - 1] = scaled;
<                     intArrayCache [i] = temp;
<                 }
<             }
<         }
<         if (scaled == null) {
<             intArrayCache [intArrayCache.length - 1] = new int [points.length];
<             scaled = intArrayCache [intArrayCache.length - 1];
<         }
<         for (int i = 0;
<         (i + 1) < points.length; i += 2) {
<             scaled [i] = (int) (Math.floor ((points [i] * zoom + fractionalX)));
<             scaled [i + 1] = (int) (Math.floor ((points [i + 1] * zoom + fractionalY)));
<         }
<         return scaled;
<     }
< 
<     private Rectangle zoomFillRect (int x, int y, int w, int h) {
<         TEMP.x = (int) (Math.floor ((x * zoom + fractionalX)));
<         TEMP.y = (int) (Math.floor ((y * zoom + fractionalY)));
<         TEMP.width = (int) (Math.floor (((x + w - 1) * zoom + fractionalX))) - TEMP.x + 1;
<         TEMP.height = (int) (Math.floor (((y + h - 1) * zoom + fractionalY))) - TEMP.y + 1;
<         return TEMP;
<     }
< 
<     Font zoomFont (Font f) {
<         if (f == null) f = Display.getCurrent ().getSystemFont ();
< 
<         FontData data = getCachedFontData (f);
<         int zoomedFontHeight = zoomFontHeight (data.getHeight ());
<         allowText = zoomedFontHeight > 0;
<         fontKey.setValues (f, zoomedFontHeight);
<         return getCachedFont (fontKey);
<     }
< 
<     int zoomFontHeight (int height) {
<         return (int) (zoom * height);
<     }
< 
<     private Rectangle zoomClipRect (Rectangle r) {
<         TEMP.x = (int) (Math.floor (r.x * zoom + fractionalX));
<         TEMP.y = (int) (Math.floor (r.y * zoom + fractionalY));
<         TEMP.width = (int) (Math.ceil (((r.x + r.width) * zoom + fractionalX))) - TEMP.x;
<         TEMP.height = (int) (Math.ceil (((r.y + r.height) * zoom + fractionalY))) - TEMP.y;
<         return TEMP;
<     }
< 
<     private Rectangle zoomRect (int x, int y, int w, int h) {
<         TEMP.x = (int) (Math.floor (x * zoom + fractionalX));
<         TEMP.y = (int) (Math.floor (y * zoom + fractionalY));
<         TEMP.width = (int) (Math.floor (((x + w) * zoom + fractionalX))) - TEMP.x;
<         TEMP.height = (int) (Math.floor (((y + h) * zoom + fractionalY))) - TEMP.y;
<         return TEMP;
<     }
< 
<     int zoomLineWidth (int w) {
<         return w;
<     }
< 
<     public void setLineDash (int [] dash) {
<         graphics.setLineDash (dash);
---
>     protected Graphics getGraphics () {
>         return graphics;
