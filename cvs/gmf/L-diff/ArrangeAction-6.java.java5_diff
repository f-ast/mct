2a3,4
> import java.util.ArrayList;
> 
4a7,10
> import java.util.HashSet;
> 
> import java.util.Iterator;
> 
8a15,16
> import java.util.Set;
> 
22a31,32
> import org.eclipse.gef.commands.CompoundCommand;
> 
26a37,38
> import org.eclipse.gmf.runtime.diagram.ui.IPreferenceConstants;
> 
30a43,44
> import org.eclipse.gmf.runtime.diagram.ui.editparts.DiagramEditPart;
> 
37,38d50
< import org.eclipse.gmf.runtime.diagram.ui.preferences.IPreferenceConstants;
< 
71,74c83,89
<         if (! getOperationSet ().isEmpty ()) {
<             EditPart parent = getSelectionParent (getOperationSet ());
<             if (parent != null) {
<                 return parent.getCommand (getTargetRequest ());
---
>         if (isArrangeAll ()) {
>             CompoundCommand arrangeCC = new CompoundCommand (getLabel ());
>             List elements = getOperationSet ();
>             for (Iterator iter = elements.iterator ();
>             iter.hasNext ();) {
>                 EditPart element = (EditPart) iter.next ();
>                 arrangeCC.add (element.getCommand (getTargetRequest ()));
75a91,95
>             return arrangeCC;
>         } else if (getOperationSet ().size () >= 2) {
>             EditPart parent = getSelectionParent (getOperationSet ());
>             if (parent != null) return parent.getCommand (getTargetRequest ());
> 
76a97
> 
98,99c119,121
<             if (! selection.isEmpty () && selection.get (0) instanceof ShapeCompartmentEditPart) return createOperationSet (((ShapeCompartmentEditPart) selection.get (0)).getChildren ());
< 
---
>             if (! selection.isEmpty ()) {
>                 return getElementsToArrange (selection);
>             }
197c219,225
<             if (operationSet != null && ! operationSet.isEmpty ()) {
---
>             if (isArrangeAll ()) {
>                 for (Iterator iter = operationSet.iterator ();
>                 iter.hasNext ();) {
>                     IGraphicalEditPart element = (IGraphicalEditPart) iter.next ();
>                     AnimationFigureHelper.getInstance ().animate (element.getFigure ());
>                 }
>             } else if (operationSet != null && ! operationSet.isEmpty ()) {
200a229,230
> 
>         }
201a232,254
> 
>     private List getElementsToArrange (List selection) {
>         Set parentsSet = new HashSet ();
>         for (Iterator iter = selection.iterator ();
>         iter.hasNext ();) {
>             Object element = iter.next ();
>             if (element instanceof ShapeCompartmentEditPart || element instanceof DiagramEditPart) {
>                 parentsSet.add (element);
>             } else if (element instanceof EditPart) {
>                 EditPart gEditPart = (EditPart) element;
>                 EditPart parentEditPart = gEditPart.getParent ();
>                 if (parentEditPart instanceof ShapeCompartmentEditPart || parentEditPart instanceof DiagramEditPart) {
>                     if (! parentsSet.contains (parentEditPart)) parentsSet.add (parentEditPart);
> 
>                 }
>             }
> 
>         }
>         if (parentsSet.isEmpty ()) return Collections.EMPTY_LIST;
> 
>         List elements = new ArrayList ();
>         elements.addAll (parentsSet);
>         return elements;
