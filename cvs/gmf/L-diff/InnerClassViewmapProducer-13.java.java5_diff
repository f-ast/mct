8a9,10
> import java.util.LinkedHashSet;
> 
26a29,32
> import org.eclipse.gmf.gmfgraph.Border;
> 
> import org.eclipse.gmf.gmfgraph.BorderRef;
> 
30a37,38
> import org.eclipse.gmf.gmfgraph.CompoundBorder;
> 
32a41,42
> import org.eclipse.gmf.gmfgraph.CustomBorder;
> 
34a45,46
> import org.eclipse.gmf.gmfgraph.CustomLayout;
> 
42a55,56
> import org.eclipse.gmf.gmfgraph.FigureRef;
> 
44a59,60
> import org.eclipse.gmf.gmfgraph.LayoutRef;
> 
146,148c162,187
<         FigureGallery gallery = findAncestorFigureGallery (figure);
<         if (gallery != null) {
<             viewmap.getRequiredPluginIDs ().addAll (Arrays.asList (fqnSwitch.getDependencies (gallery)));
---
>         LinkedHashSet < String > allRequired = new LinkedHashSet < String > ();
>         for (FigureGallery gallery : findAllGalleriesForImport (figure)) {
>             allRequired.addAll (Arrays.asList (fqnSwitch.getDependencies (gallery)));
>         }
>         viewmap.getRequiredPluginIDs ().addAll (allRequired);
>     }
> 
>     public static Collection < FigureGallery > findAllGalleriesForImport (Figure figure) {
>         LinkedHashSet < FigureGallery > rv = new LinkedHashSet < FigureGallery > ();
>         rv.add (findAncestorFigureGallery (figure));
>         LinkedList < Figure > queue = new LinkedList < Figure > ();
>         queue.add (figure);
>         do {
>             final RealFigure fig;
>             if (queue.peek () instanceof RealFigure) {
>                 fig = (RealFigure) queue.removeFirst ();
>             } else if (queue.peek () instanceof FigureRef) {
>                 fig = ((FigureRef) queue.removeFirst ()).getFigure ();
>             } else {
>                 assert false;
>                 queue.removeFirst ();
>                 continue;
>             }
> 
>             if (fig.getLayout () instanceof LayoutRef && ((LayoutRef) fig.getLayout ()).getActual () instanceof CustomLayout) {
>                 rv.add (findAncestorFigureGallery (((LayoutRef) fig.getLayout ()).getActual ()));
149a189,209
>             if (fig.getBorder () != null) {
>                 LinkedList < Border > borderQueue = new LinkedList < Border > ();
>                 borderQueue.add (fig.getBorder ());
>                 do {
>                     if (borderQueue.peek () instanceof BorderRef) {
>                         borderQueue.add (((BorderRef) borderQueue.peek ()).getActual ());
>                     } else if (borderQueue.peek () instanceof CompoundBorder) {
>                         CompoundBorder b = (CompoundBorder) borderQueue.peek ();
>                         borderQueue.addLast (b.getInner ());
>                         borderQueue.addLast (b.getOuter ());
>                     } else if (borderQueue.peek () instanceof CustomBorder) {
>                         rv.add (findAncestorFigureGallery (borderQueue.peek ()));
>                     }
> 
>                     borderQueue.removeFirst ();
>                 } while (! borderQueue.isEmpty ());
>             }
>             queue.addAll (fig.getChildren ());
>         } while (! queue.isEmpty ());
>         rv.remove (null);
>         return rv;
152c212
<     public static FigureGallery findAncestorFigureGallery (Figure figure) {
---
>     public static FigureGallery findAncestorFigureGallery (EObject figure) {
