head	1.4;
access;
symbols
	v20081020-0700:1.4
	v20080722-1827:1.4
	R2_1_maintenance:1.4.0.6
	Root_R2_1_maintenance:1.4
	R2_1_0:1.4
	v20080425-1959:1.4
	v20080322-0000:1.4
	v20080222-1200:1.4
	v20070809-0000:1.4
	R2_0_maintenance:1.4.0.4
	R2_0:1.4
	R4_20:1.4
	RC3_20:1.4
	v20070601-1400:1.4
	v20070518-1300:1.4
	v20070330-1300:1.4
	M4_20:1.4
	v20061214-0000:1.4
	M3_20:1.4
	v20061013-1330:1.4
	M1_20:1.4
	v20060810-1700:1.4
	v20060721-1130:1.4
	v20060713-1700:1.4
	R1_0_maintenance:1.4.0.2
	R1_0:1.4
	v20060627-1200:1.4
	v20060616-1200:1.4
	v20060531-1730:1.4
	I20060424-0500:1.4
	I20060424-0300:1.4
	M6_10:1.4
	I20060407-1200:1.4
	I20060331-1000:1.4
	I20060324-0300:1.3
	I20060317-1300:1.3
	I20060317-1200:1.3
	I20060316-1300:1.3
	I20060309-1300:1.3
	M5_10:1.3
	S20060303-1600:1.3
	I20060227-1730:1.3
	I20060216-1945:1.3
	I20060210-1715:1.2
	I20060209-1815:1.2
	I20060203-0830:1.2
	I20060129-1145:1.2
	I20060127-0900:1.2
	I20060120-1530:1.2
	I20060113-1700:1.2
	M4_10:1.2
	I20060107-1100:1.2
	I20060105-1630:1.2
	I20051230-1230:1.2
	I20051223-1100:1.2
	I20051217-0925:1.2
	I20051124-2000:1.2
	M3_10:1.2
	I20051118-1245:1.2
	I20051111-1800:1.2
	I20051106-0900:1.2
	v20051030:1.2;
locks; strict;
comment	@# @;


1.4
date	2006.03.29.21.27.15;	author ldamus;	state Exp;
branches;
next	1.3;

1.3
date	2006.02.13.19.11.01;	author ldamus;	state Exp;
branches;
next	1.2;

1.2
date	2005.09.12.21.25.30;	author sshaw;	state Exp;
branches;
next	1.1;

1.1
date	2005.08.30.03.16.25;	author sshaw;	state Exp;
branches;
next	;


desc
@@


1.4
log
@[133879] gmf_head ldamus 060329 Copying a shape on the diagram clears the undo history
@
text
@/******************************************************************************
 * Copyright (c) 2002, 2006 IBM Corporation and others.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    IBM Corporation - initial API and implementation 
 ****************************************************************************/

package org.eclipse.gmf.runtime.common.ui.action.global;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Vector;

import org.eclipse.core.commands.ExecutionException;
import org.eclipse.core.commands.operations.IUndoContext;
import org.eclipse.core.commands.operations.IUndoableOperation;
import org.eclipse.core.runtime.IProgressMonitor;
import org.eclipse.core.runtime.IStatus;
import org.eclipse.core.runtime.Status;
import org.eclipse.gmf.runtime.common.core.command.CompositeCommand;
import org.eclipse.gmf.runtime.common.core.command.ICommand;
import org.eclipse.gmf.runtime.common.core.util.Log;
import org.eclipse.gmf.runtime.common.core.util.Trace;
import org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler;
import org.eclipse.gmf.runtime.common.ui.action.internal.CommonUIActionDebugOptions;
import org.eclipse.gmf.runtime.common.ui.action.internal.CommonUIActionPlugin;
import org.eclipse.gmf.runtime.common.ui.action.internal.CommonUIActionStatusCodes;
import org.eclipse.gmf.runtime.common.ui.action.internal.global.GlobalActionHandlerData;
import org.eclipse.gmf.runtime.common.ui.services.action.global.GlobalActionContext;
import org.eclipse.gmf.runtime.common.ui.services.action.global.GlobalActionHandlerContext;
import org.eclipse.gmf.runtime.common.ui.services.action.global.GlobalActionHandlerService;
import org.eclipse.gmf.runtime.common.ui.services.action.global.IGlobalActionContext;
import org.eclipse.gmf.runtime.common.ui.services.action.global.IGlobalActionHandler;
import org.eclipse.gmf.runtime.common.ui.services.action.global.IGlobalActionHandlerProvider;
import org.eclipse.jface.text.ITextSelection;
import org.eclipse.jface.viewers.IStructuredSelection;
import org.eclipse.ui.IWorkbenchPage;
import org.eclipse.ui.IWorkbenchPart;

/**
 * The abstract parent of all concrete global actions. A concrete global action
 * needs to override the <code>getActionId()</code> method. The concrete
 * global action could override the <code>createContext()</code> and
 * <code>createCompoundCommand()</code> methods.
 * 
 * @@author Vishy Ramaswamy
 */
public abstract class GlobalAction
	extends AbstractActionHandler {

	/**
	 * Associated IWorkbenchActionConstant if one exists
	 */
	private final String workbenchActionConstant = getActionId();

	/**
	 * Default label for this global action.
	 */
	private String defaultLabel;

	/**
	 * Creates a GlobalAction.
	 * 
	 * @@param workbenchPart
	 *            The part associated with this action
	 */
	public GlobalAction(IWorkbenchPart workbenchPart) {
		super(workbenchPart);

		assert null != workbenchPart;

		/* Disable the action when it is created */
		setEnabled(false);
	}

	/**
	 * Creates a GlobalAction.
	 * 
	 * @@param workbenchPage
	 *            The part associated with this action
	 */
	public GlobalAction(IWorkbenchPage workbenchPage) {
		super(workbenchPage);

		assert null != workbenchPage;

		/* Disable the action when it is created */
		setEnabled(false);
	}

	/* (non-Javadoc)
	 * @@see org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler#doRun(org.eclipse.core.runtime.IProgressMonitor)
	 */
	protected void doRun(IProgressMonitor progressMonitor) {
		Vector list = new Vector();

		/* Get the handler data */
		List handlerInfo = getGlobalActionHandlerData();
		for (Iterator i = handlerInfo.iterator(); i.hasNext();) {
			/* get the next element */
			GlobalActionHandlerData data = (GlobalActionHandlerData) i.next();

			/* Get the command */
			ICommand command = data.getHandler().getCommand(data.getContext());
			if (command != null) {
				list.addElement(command);
			}
		}

		if (list.size() <= 0) {
			return;
		}

		/* Create the composite operation */
		IUndoableOperation operation = createCompositeCommand(list).reduce();
        try {
            IStatus status = getOperationHistory()
                .execute(operation, progressMonitor, null);
            
    		if (!status.isOK()) {
    			/* log status error */
    			Log.log(CommonUIActionPlugin.getDefault(), status);
    		}
        } catch (ExecutionException e) {
            Trace.catching(CommonUIActionPlugin.getDefault(),
                CommonUIActionDebugOptions.EXCEPTIONS_CATCHING, getClass(),
                "doRun", e); //$NON-NLS-1$
            Log.error(CommonUIActionPlugin.getDefault(),
                CommonUIActionStatusCodes.ACTION_FAILURE, e
                    .getLocalizedMessage(), e);
        }

	}

	/* (non-Javadoc)
	 * @@see org.eclipse.gmf.runtime.common.ui.action.IRepeatableAction#refresh()
	 */
	public void refresh() {
		boolean enable = false;
		try {
			/* Get the handler data */
			List handlerInfo = getGlobalActionHandlerData();

			// Reset the label to the default
			if (defaultLabel != null) {
				setText(defaultLabel);
			}

			/* Check the handlers for enablement status */
			for (Iterator i = handlerInfo.iterator(); i.hasNext();) {
				/* Get the next element */
				GlobalActionHandlerData data = (GlobalActionHandlerData) i
					.next();

				/* Check the enablement */
				if (data.getHandler().canHandle(data.getContext())) {
					if (!enable) {
						enable = true;
					}
				}

				/* Update the label, if appropriate */
				if (handlerInfo.size() == 1) {
					String label = data.getHandler()
						.getLabel(data.getContext());
					if (label != null) {
						setText(label);
					}
				}
			}
		} catch (Throwable exception) {
			enable = false;
			Trace.catching(CommonUIActionPlugin.getDefault(),
				CommonUIActionDebugOptions.EXCEPTIONS_CATCHING, getClass(),
				"refresh", exception); //$NON-NLS-1$

			IStatus status = new Status(IStatus.WARNING, CommonUIActionPlugin
				.getPluginId(), CommonUIActionStatusCodes.GENERAL_UI_FAILURE, String
				.valueOf(exception.getMessage()), exception);

			Log.log(CommonUIActionPlugin.getDefault(), status);
		}

		/* Set the enablement of the action */
		setEnabled(enable);
	}

	/**
	 * Returns the <code>GlobalActionId</code> handled by this action
	 * 
	 * @@return int
	 */
	public abstract String getActionId();

    /**
     * Returns a <code>CompositeCommand</code> whose undo context is derived from my workbench part.
     * 
     * @@param commands a list of commands to compose into a <code>CompositeCommand</code>
     * @@return the CompositeCommand
     */
    protected CompositeCommand createCompositeCommand(List commands) {
        assert null != commands;
        
        CompositeCommand result = new CompositeCommand(getLabel(), commands);
        IUndoContext undoContext = getUndoContext();
        
        if (undoContext != null) {
            result.addContext(undoContext);
        }
        return result;
    }
    
    /**
     * Gets the undo context from my workbench part. May be <code>null</code>.
     * 
     * @@return my undo context
     */
    protected IUndoContext getUndoContext() {
        IWorkbenchPart part = getWorkbenchPart();

        if (part != null) {
            return (IUndoContext) part.getAdapter(IUndoContext.class);
        }
        return null;
    }


	/**
     * Returns a <code>IGlobalActionContext</code>
     * 
     * @@return IGlobalActionContext
     */
	protected IGlobalActionContext createContext() {
		/* Create the global action context */
		return new GlobalActionContext(getWorkbenchPart(), getSelection(),
			getLabel(), getActionId());
	}

	/**
	 * Returns a list of <code>GlobalActionHandlerData</code>. Handles
	 * different types of selections
	 * 
	 * @@return List
	 */
	protected List getGlobalActionHandlerData() {
		/* Check if the selection is a text selection */
		if (getSelection() instanceof ITextSelection) {
			return getGlobalActionHandlerData((ITextSelection) getSelection());
		} else if (getSelection() instanceof IStructuredSelection) {
			return getGlobalActionHandlerData((IStructuredSelection) getSelection());
		}

		return new ArrayList();
	}

	/**
	 * Returns a list of <code>GlobalActionHandlerData</code> for a given list
	 * of element types
	 * 
	 * @@param listOfElementTypes
	 *            list of unique element types
	 * @@return List
	 */
	private List getGlobalActionHandlerData(List listOfElementTypes) {
		assert null != listOfElementTypes;

		/* Get the global action handler for unique element types */
		ArrayList listOfHandlers = new ArrayList();
		Iterator iterator = listOfElementTypes.iterator();
		while (iterator.hasNext()) {
			/* Get the element type */
			Class clazz = (Class) iterator.next();

			/* Create the global action handler context */
			GlobalActionHandlerContext context = new GlobalActionHandlerContext(
				getWorkbenchPart(), getActionId(), clazz, false);

			/* Get the handler */
			IGlobalActionHandler handler = GlobalActionHandlerService
				.getInstance().getGlobalActionHandler(context);

			/* Get a compatible one if no handler is found for a direct match */
			if (handler == null) {
				/* Create the global action handler context */
				context = new GlobalActionHandlerContext(getWorkbenchPart(),
					getActionId(), clazz, true);

				/* Get the handler */
				handler = GlobalActionHandlerService.getInstance()
					.getGlobalActionHandler(context);
			}

			/* Add to the list */
			if (handler != null && !listOfHandlers.contains(handler)) {
				listOfHandlers.add(handler);
			}
		}

		/* Create the global action handler data and add it to the list */
		ArrayList handlerData = new ArrayList();
		IGlobalActionContext actionContext = createContext();
		for (int i = 0; i < listOfHandlers.size(); i++) {
			/* Get the next handler */
			IGlobalActionHandler handler = (IGlobalActionHandler) listOfHandlers
				.get(i);

			/* Create the global action handler data */
			handlerData
				.add(new GlobalActionHandlerData(handler, actionContext));
		}

		/* Return the handler data */
		return handlerData;
	}

	/**
	 * Returns a list of <code>GlobalActionHandlerData</code> for selection of
	 * type <code>IStructuredSelection</code>. This methods queries the
	 * <code>GlobalActionHandlerService</code> for all the global action
	 * handlers associated with this action.
	 * 
	 * @@param selection
	 *            The <code>IStructuredSelection</code>
	 * @@return List
	 */
	private List getGlobalActionHandlerData(IStructuredSelection selection) {
		assert null != selection;

		/* Create a unique list of element types */
		ArrayList listOfElementTypes = new ArrayList();

		if (selection.isEmpty()) {
			// Use the NullElementType to signify that global action handlers
			// should be found that provide regardless of the selected types.
			listOfElementTypes.add(IGlobalActionHandlerProvider.NullElementType.class);

		} else {
			/* Get the selection as an object array */
			Object[] array = selection.toArray();

			for (int i = 0; i < array.length; i++) {
				if (!listOfElementTypes.contains(array[i].getClass())) {
					listOfElementTypes.add(array[i].getClass());
				}
			}
		}

		/* Get the global action handler for unique element types */
		return getGlobalActionHandlerData(listOfElementTypes);
	}

	/**
	 * Returns a list of <code>GlobalActionHandlerData</code> for selection of
	 * type <code>ITextSelection</code>. This methods queries the
	 * <code>GlobalActionHandlerService</code> for all the global action
	 * handlers associated with this action.
	 * 
	 * @@param selection
	 *            The <code>ITextSelection</code>
	 * @@return List
	 */
	private List getGlobalActionHandlerData(ITextSelection selection) {
		assert null != selection;

		/* Get the element type */
		Class clazz = selection.getClass();

		/* Create a unique list of element types */
		ArrayList listOfElementTypes = new ArrayList();
		listOfElementTypes.add(clazz);

		/* Get the global action handler for unique element types */
		return getGlobalActionHandlerData(listOfElementTypes);
	}

	/**
	 * Returns the workbenchActionConstant.
	 * 
	 * @@return String
	 */
	protected String getWorkbenchActionConstant() {
		return workbenchActionConstant;
	}

	/**
	 * Returns a list with a GlobalActionHandlerData object containing a context
	 * of Object. You can have getObjectContextGlobalActionHandlerData call this
	 * instead.
	 * 
	 * @@return List with a GlobalActionHandlerData object containing a context
	 *         of Object
	 */
	protected List getObjectContextGlobalActionHandlerData() {
		GlobalActionHandlerContext context = new GlobalActionHandlerContext(
			getWorkbenchPart(), getActionId(), Object.class, false);

		IGlobalActionHandler globalActionHandler = GlobalActionHandlerService
			.getInstance().getGlobalActionHandler(context);

		if (globalActionHandler == null) {
			//an error may occur, OK because someone is playing with the xml
			return new ArrayList();
		}

		GlobalActionHandlerData data = new GlobalActionHandlerData(
			globalActionHandler, createContext());

		ArrayList list = new ArrayList();
		list.add(data);
		return list;
	}

	/* (non-Javadoc)
	 * @@see org.eclipse.gmf.runtime.common.ui.action.IDisposableAction#init()
	 */
	public void init() {
		super.init();
		defaultLabel = getLabel();
	}

}@


1.3
log
@[112826] gmf_head ldamus 060213 Adopt Eclipse 3.1 Operation History Framework
@
text
@d120 1
a120 1
		IUndoableOperation operation = createCompositeCommand(list);
@


1.2
log
@Bugzilla 108765 gmf_head tmacdoug 050912 - Update copyrights of GMF and EMFT plugins content to Eclipse copyright (EPL)
@
text
@d2 1
a2 1
 * Copyright (c) 2002, 2003 IBM Corporation and others.
d19 3
a24 5
import org.eclipse.jface.text.ITextSelection;
import org.eclipse.jface.viewers.IStructuredSelection;
import org.eclipse.ui.IWorkbenchPage;
import org.eclipse.ui.IWorkbenchPart;

d40 4
d119 18
a136 8
		/* Create the compound command */
		CompositeCommand compositeCommand = createCompositeCommand(list);
		getCommandManager().execute(compositeCommand, progressMonitor);
		IStatus status = compositeCommand.getCommandResult().getStatus();
		if (!status.isOK()) {
			/* log status error */
			Log.log(CommonUIActionPlugin.getDefault(), status);
		}
d200 32
a231 10
	/**
	 * Returns a <code>CompositeCommand</code>
	 * 
	 * @@param commands a list of commands to compose into a <code>CompositeCommand</code>
	 * @@return CompositeCommand
	 */
	protected CompositeCommand createCompositeCommand(List commands) {
		assert null != commands;
		return new CompositeCommand(getLabel(), commands);
	}
d234 4
a237 4
	 * Returns a <code>IGlobalActionContext</code>
	 * 
	 * @@return IGlobalActionContext
	 */
@


1.1
log
@Refactoring of the IBM gmf runtime contribution to the org.eclipse.gmf.runtime namespace.
@
text
@d1 11
a11 9
/*
 *+------------------------------------------------------------------------+
 *| Licensed Materials - Property of IBM                                   |
 *| (C) Copyright IBM Corp. 2002, 2003.  All Rights Reserved.              |
 *|                                                                        |
 *| US Government Users Restricted Rights - Use, duplication or disclosure |
 *| restricted by GSA ADP Schedule Contract with IBM Corp.                 |
 *+------------------------------------------------------------------------+
 */
@

