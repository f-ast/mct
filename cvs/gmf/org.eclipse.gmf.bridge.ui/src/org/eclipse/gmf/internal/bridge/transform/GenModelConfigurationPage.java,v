head	1.6;
access;
symbols
	v20080924-1925:1.6
	v20080722-1827:1.6
	v20080716-1642:1.6
	R2_1_maintenance:1.6.0.2
	Root_R2_1_maintenance:1.6
	R2_1_0:1.6
	v20080417-1610:1.6
	v20080322-0000:1.6
	v20080222-1200:1.5
	v20080215-1500:1.5
	v20080207-0207:1.5
	v20071124-0000:1.5
	v20071108-0000:1.5
	v20070903-0000:1.5
	v20070809-0000:1.5
	R2_0_maintenance:1.5.0.2
	R2_0:1.5
	R4_20:1.5
	v20070621-0000:1.5
	RC3_20:1.5
	v20070608-1300:1.5
	v20070605-1400:1.5
	v20070601-1400:1.5
	v20070520-1200:1.5
	v20070518-1300:1.5
	v20070420-1000:1.5
	v20070413-1300:1.4
	v20070405-2000:1.3
	v20070330-1300:1.3
	v20070322-1100:1.3
	v20060316-0600:1.3
	v20070301-1200:1.3
	v20070228-2000:1.3
	v20070208-1800:1.3;
locks; strict;
comment	@# @;
expand	@k@;


1.6
date	2008.03.06.12.46.31;	author atikhomirov;	state Exp;
branches;
next	1.5;
commitid	7e5d47cfe7a74567;

1.5
date	2007.04.18.12.29.18;	author atikhomirov;	state Exp;
branches;
next	1.4;
commitid	779946260f1e4567;

1.4
date	2007.04.12.14.40.18;	author atikhomirov;	state Exp;
branches;
next	1.3;
commitid	5f58461e44d04567;

1.3
date	2007.02.07.12.11.12;	author atikhomirov;	state Exp;
branches;
next	1.2;
commitid	ff145c9c1e04567;

1.2
date	2007.01.25.18.14.32;	author atikhomirov;	state Exp;
branches;
next	1.1;
commitid	7f7045b8f3874567;

1.1
date	2007.01.18.18.49.15;	author atikhomirov;	state Exp;
branches;
next	;
commitid	197b45afc1284567;


desc
@@


1.6
log
@[220711] respect workspace resource models - refactored transformation operation to manage resource set easily
@
text
@/*
 * Copyright (c) 2006, 2008 Borland Software Corporation
 * 
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    Alexander Fedorov (Borland) - initial API and implementation
 */
package org.eclipse.gmf.internal.bridge.transform;

import org.eclipse.core.resources.IContainer;
import org.eclipse.core.resources.IFile;
import org.eclipse.core.resources.ResourcesPlugin;
import org.eclipse.core.runtime.CoreException;
import org.eclipse.core.runtime.IPath;
import org.eclipse.core.runtime.IProgressMonitor;
import org.eclipse.core.runtime.IStatus;
import org.eclipse.core.runtime.Path;
import org.eclipse.emf.codegen.ecore.genmodel.GenModel;
import org.eclipse.emf.common.util.URI;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.emf.ecore.resource.ResourceSet;
import org.eclipse.emf.importer.ui.EMFModelWizard;
import org.eclipse.emf.importer.ui.GenModelReloadActionDelegate;
import org.eclipse.gmf.internal.common.ui.ResourceLocationProvider;
import org.eclipse.jface.action.Action;
import org.eclipse.jface.action.IAction;
import org.eclipse.jface.viewers.StructuredSelection;
import org.eclipse.jface.window.Window;
import org.eclipse.jface.wizard.WizardDialog;
import org.eclipse.swt.SWT;
import org.eclipse.swt.events.SelectionAdapter;
import org.eclipse.swt.events.SelectionEvent;
import org.eclipse.swt.layout.GridData;
import org.eclipse.swt.layout.GridLayout;
import org.eclipse.swt.widgets.Button;
import org.eclipse.swt.widgets.Composite;
import org.eclipse.swt.widgets.Shell;
import org.eclipse.swt.widgets.Widget;
import org.eclipse.ui.PlatformUI;


class GenModelConfigurationPage extends ModelConfigurationPage {
	
	private static final String FILE_EXT_ECORE = "ecore"; //$NON-NLS-1$
	private Button createWizardBtn;
	private Button createDefaultBtn;
	private Button refreshStaleBtn;
	
	GenModelConfigurationPage(String pageId, ResourceLocationProvider rlp, ResourceSet resourceSet) {
		super(pageId, rlp, resourceSet);
		setTitle(Messages.TransformToGenModelWizard_title_genmodel);
		setDescription(Messages.TransformToGenModelWizard_descr_genmodel);
		setModelFileExtension("genmodel"); //$NON-NLS-1$
	}
	
	@@Override
	protected void createAdditionalControls(Composite parent) {
		Composite createComposite = new Composite(parent, SWT.NONE);
		createComposite.setLayout(new GridLayout(2, true));
		createComposite.setLayoutData(createGridData());

		createWizardBtn = new Button(createComposite, SWT.PUSH);
		createWizardBtn.setText(Messages.GenModelConfigurationPage_btn_new_wizard);
		setButtonLayoutData(createWizardBtn);

		createDefaultBtn = new Button(createComposite, SWT.PUSH);
		createDefaultBtn.setText(Messages.GenModelConfigurationPage_btn_create_default);
		setButtonLayoutData(createDefaultBtn);

		refreshStaleBtn = new Button(createComposite, SWT.PUSH);
		refreshStaleBtn.setText(Messages.GenModelConfigurationPage_btn_refresh_stale);
		setButtonLayoutData(refreshStaleBtn);

		SelectionAdapter selectionAdapter = new SelectionAdapter() {
			@@Override
			public void widgetSelected(SelectionEvent e) {
				handleSelection(e.widget);
			}
		};
		createWizardBtn.addSelectionListener(selectionAdapter);
		createDefaultBtn.addSelectionListener(selectionAdapter);
		refreshStaleBtn.addSelectionListener(selectionAdapter);
	}

	private GridData createGridData() {
		GridData gd = new GridData();
		gd.horizontalAlignment = GridData.FILL;
		gd.grabExcessHorizontalSpace = true;
		return gd;
	}
	
	void handleSelection(Widget w) {
		if (createDefaultBtn.equals(w)){
			createDefault();
		} else if (createWizardBtn.equals(w)) {
			launchWizard();
		} else if (refreshStaleBtn.equals(w)) {
			refreshGenmodel();
		}
	}

	@@Override
	protected void initControls() {
		super.initControls();
		if (getURI() == null) {
			findGenmodel();
		} else {
			updateControls();
		}
	}
	
	void findGenmodel() {
		try {
			GenModel genModel = getOperation().findGenmodel();
			if (genModel != null) {
				Resource r = genModel.eResource();
				URI genURI = r.getURI();
				setURI(genURI);
				updateURI();
			} else {
				setPageComplete(true);
				updateControls();
			}
		} catch (CoreException e) {
			setErrorMessage(e.getMessage());
			updateControls();
		}
	}

	/* (non-Javadoc)
	 * @@see org.eclipse.gmf.internal.common.ui.ModelSelectionPage#resourceChanged()
	 */
	@@Override
	protected void resourceChanged() {
		super.resourceChanged();
		updateControls();
		setPageComplete(getResource() != null);
	}

	private void updateControls() {
		GenModelDetector gmd = getOperation().getGenModelDetector();
		if (gmd!= null) {
			createDefaultBtn.setEnabled(gmd.canCreateDefault());
		}
		IStatus stale = getOperation().getStaleGenmodelStatus();
		if (stale != null && !stale.isOK()) {
			setStatusMessage(stale);
			refreshStaleBtn.setEnabled((getURI() != null));
		} else {
			refreshStaleBtn.setEnabled(false);
		}
	}

	@@Override
	protected Resource doLoadResource(IProgressMonitor monitor) throws CoreException {
		GenModel genModel = getOperation().loadGenModel(getURI(), monitor);
		if (genModel == null) {
			return null;
		}
		return genModel.eResource();
	}

	private void createDefault() {
		try {
			TransformToGenModelOperation to = getOperation();
			GenModelDetector gmd = to.getGenModelDetector();
			TransformToGenModelWizard wizard = (TransformToGenModelWizard) getWizard();
			IFile mapFile = wizard.getMapFile();
			String pluginID = mapFile.getProject().getName();
			URI genURI = gmd.createDefault(pluginID, mapFile);
			setURI(genURI);
			updateURI();
		} catch (CoreException e) {
			setErrorMessage(e.getMessage());
		}
	}
	
	private void launchWizard() {
		TransformToGenModelWizard wizard = (TransformToGenModelWizard) getWizard();
		IFile mapFile = wizard.getMapFile();
		IFile genmodel = createWithWizard(getShell(), mapFile);
		if (genmodel != null) {
			setURI(URI.createPlatformResourceURI(genmodel.getFullPath().toString(), true));
			updateURI();
		}
	}
	
	private static IFile createWithWizard(Shell shell, IFile patternResource) {
		final IFile[] result = new IFile[1];
		EMFModelWizard wizard = new EMFModelWizard() {
			@@Override
			public boolean performFinish() {
				result[0] = ResourcesPlugin.getWorkspace().getRoot().getFile(genModelContainerPath.append(genModelFileName));
				return super.performFinish();
			}
		};
		wizard.init(PlatformUI.getWorkbench(), createSelectionForEMFWizard(patternResource));
		if (Window.OK == new WizardDialog(shell, wizard).open()) {
			assert result[0] != null;
			return result[0];
		}
		return null;
	}
	private static StructuredSelection createSelectionForEMFWizard(IFile patternResource) {
		final IContainer parent = patternResource.getParent();
		IFile neighbour = parent.getFile(new Path(patternResource.getName()).removeFileExtension().addFileExtension(FILE_EXT_ECORE));
		if (neighbour.exists()) {
			return new StructuredSelection(neighbour);
		} else {
			return new StructuredSelection(patternResource);
		}
	}

	private void refreshGenmodel() {
		IPath p = new Path(getURI().path()).removeFirstSegments(1);
		IFile genModelFile = ResourcesPlugin.getWorkspace().getRoot().getFile(p);
		GenModelReloadActionDelegate action = new GenModelReloadActionDelegate();
		IAction uiAction = new Action() {
			//empty
		};
		action.selectionChanged(uiAction, new StructuredSelection(genModelFile));
		action.run(uiAction);
		updateURI();
	}

	private TransformToGenModelOperation getOperation() {
		TransformToGenModelWizard wizard = (TransformToGenModelWizard) getWizard();
		return wizard.getTransformOperation();
	}

}
@


1.5
log
@overriding method to pass constant value is not a good approach
@
text
@d1 2
a2 2
/**
 * Copyright (c) 2006, 2007 Borland Software Corporation
d118 1
a118 1
			GenModel genModel = getOperation().findGenmodel(getResourceSet());
d160 1
a160 1
		GenModel genModel = getOperation().loadGenModel(getResourceSet(), getURI(), monitor);
@


1.4
log
@[181896] afedorov - Allow transformation wizard to complete if there are errors in the resulting gmfgen model
refactored not to define extra strings for page names, titles and descriptions moved to owning pages.
@
text
@d2 1
a2 1
 * Copyright (c) 2006 Borland Software Corporation
a48 2
	private static final String FILE_EXT_GENMODEL = "genmodel"; //$NON-NLS-1$

d57 1
a57 4
	}
	
	protected String getModelFileExtension() {
		return FILE_EXT_GENMODEL;
@


1.3
log
@[171593] afedorov - Tests for TransformToGenModelOperation
@
text
@d57 2
@


1.2
log
@[148836] afedorov - Provide "Create generator model..." wizard instead of existing dialog sequence. Fix for NPE on pure-design gmfmap
@
text
@a27 1
import org.eclipse.gmf.internal.common.URIUtil;
d174 2
a175 2
			URI mapURI = to.getMapURI();
			IFile mapFile = URIUtil.getFile(mapURI);
d177 1
a177 2
			IFile genmodel = gmd.createDefault(pluginID, mapFile);
			URI genURI = URI.createPlatformResourceURI(genmodel.getFullPath().toString(), true);
d186 2
a187 2
		URI mapURI = getOperation().getMapURI();
		IFile mapFile = URIUtil.getFile(mapURI);
@


1.1
log
@[148836] afedorov - Provide "Create generator model..." wizard instead of existing dialog sequence
@
text
@d123 9
a131 4
			Resource r = genModel.eResource();
			URI genURI = r.getURI();
			setURI(genURI);
			updateURI();
d145 1
d165 3
@

