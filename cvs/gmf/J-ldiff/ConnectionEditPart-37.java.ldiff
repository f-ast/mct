41a42,42
> import org.eclipse.gef.EditPartViewer;
72,72c80,80
< import org.eclipse.gmf.runtime.diagram.ui.internal.editparts.DefaultEditableEditPart;
---
> import org.eclipse.gmf.runtime.diagram.ui.internal.type.NotationTypeUtil;
78,78c83,83
< import org.eclipse.gmf.runtime.diagram.ui.internal.l10n.DiagramFontRegistry;
---
> import org.eclipse.gmf.runtime.diagram.ui.parts.DiagramGraphicalViewer;
84a86,86
> import org.eclipse.gmf.runtime.diagram.ui.preferences.IPreferenceConstants;
86a89,89
> import org.eclipse.gmf.runtime.draw2d.ui.figures.FigureUtilities;
108a112,117
> import org.eclipse.jface.preference.IPreferenceStore;
> import org.eclipse.jface.preference.PreferenceConverter;
> import org.eclipse.jface.resource.DeviceResourceException;
> import org.eclipse.jface.resource.FontDescriptor;
> import org.eclipse.jface.resource.JFaceResources;
> import org.eclipse.jface.resource.ResourceManager;
115,115c123,123
< import org.eclipse.swt.widgets.Display;
---
> import org.eclipse.swt.graphics.Font;
134a144,148
>     /**
>      * Flag to indicate if the edit part is in edit mode
>      */
>     private boolean isEditable = true;
> 
142a157,169
>      
>     /**
>      * Cache the font data when a font is created so that it can be
>      * disposed later.
>      */
>     private FontData cachedFontData;
>     
>     /**
> 	 * Cache the answer to whether or not this is a semantic connection after it
> 	 * is retrieved.
> 	 */
>     private Boolean semanticConnection;
>     
162,164d188
< 	/** Used for handling the editable status of the edit part */
< 	private final IEditableEditPart editableEditPart;
< 
181,181c205,205
< 		EObject semanticElement = EMFCoreUtil.resolve(getEditingDomain(), semanticProxy);
---
>         EObject semanticElement = EMFCoreUtil.resolve(getEditingDomain(),
181a206,206
>             semanticProxy);
213,213c238,238
< 		getDiagramEventBroker().addNotificationListener(element,
---
>         getDiagramEventBroker().addNotificationListener(element, listener);
214,214d238
< 			listener);
241,241c265,265
< 		getDiagramEventBroker().addNotificationListener(element,
---
>         getDiagramEventBroker().addNotificationListener(element, feature,
242,242c266,266
< 			feature, listener);
---
>             listener);
325a350,359
>     public void removeNotify() {
>         super.removeNotify();
>         
>         if (cachedFontData != null) {
>             getResourceManager().destroyFont(
>                 FontDescriptor.createFrom(cachedFontData));
>             cachedFontData = null;
>         }
>     }
> 
453,453c487,487
< 		if (adapter == SnapToHelper.class) {
---
>         if (key == SnapToHelper.class) {
455a490,491
>             EditPartViewer viewer = getViewer();
>             Boolean val = (Boolean) viewer
456,457d489
< 
< 			Boolean val = (Boolean) getViewer().getProperty(
458,458c492,492
< 				RulerProvider.PROPERTY_RULER_VISIBILITY);
---
>                 .getProperty(RulerProvider.PROPERTY_RULER_VISIBILITY);
461a496,496
>             val = (Boolean) viewer
462,462d495
< 			val = (Boolean) getViewer().getProperty(
463,463c497,497
< 				SnapToGeometry.PROPERTY_SNAP_ENABLED);
---
>                 .getProperty(SnapToGeometry.PROPERTY_SNAP_ENABLED);
481a516,516
>             return model;
482,482d515
< 			return getModel();
539a574,574
>             Log
540,540c575,575
< 			Log.error(DiagramUIPlugin.getInstance(),
---
>                 .error(DiagramUIPlugin.getInstance(),
613a649,657
>         EObject eObj = ((View) getModel()).getElement();
>         if (eObj == null) {
>             return null;
>         }
> 
>         if (!eObj.eIsProxy()) {
>             return eObj;
>         }
> 
618a663,663
>                         setResult(ViewUtil
619,619c664,664
< 					setResult(ViewUtil.resolveSemanticElement((View) getModel()));
---
>                             .resolveSemanticElement((View) getModel()));
631,631c1078,1078
< 
---
> 
670a715,715
>      * Handles the property changed event. Clients should override to respond to
671,671d714
< 	 * Handles the property changed event.  Clients should override to
672,672c716,716
< 	 * respond to the specific notification events they are interested.
---
>      * the specific notification events they are interested.
676a721,722
>      * main thread. Alternatively if this is not possible, then the client can
>      * wrap their handler within the Display.synchExec runnable to ensure
676,676c720,720
< 	 * unsupported calls (i.e. Display.getCurrent() ) assuming they are on
---
>      * unsupported calls (i.e. Display.getCurrent() ) assuming they are on the
677,678d720
< 	 * the main thread.  Alternatively if this is not possible, then the
< 	 * client can wrap their handler within the Display.synchExec runnable
679,679c723,723
< 	 * to ensure synchronization and subsequent execution on the main thread.
---
>      * synchronization and subsequent execution on the main thread.
682a727,727
>      *            changed event
682,682c726,726
< 	 *            the <code>Notification</code> object that is the property changed event
---
>      *            the <code>Notification</code> object that is the property
748a794,794
>             NotationPackage.Literals.LINE_STYLE);
749,749d793
< 			NotationPackage.eINSTANCE.getLineStyle());
750a796,796
>             setForegroundColor(DiagramColorRegistry.getInstance().getColor(
751,751d795
< 			setForegroundColor(DiagramColorRegistry
752,752c797,797
< 				.getInstance().getColor(new Integer(style.getLineColor())));
---
>                 new Integer(style.getLineColor())));
777a823,823
>             getDiagramEventBroker().removeNotificationListener(
778,778d822
< 			DiagramEventBroker.getInstance(getEditingDomain()).removeNotificationListener(
837,837c882,882
< 	 * This method adds all listeners to the semantic element behind this EditPart 
---
>      * This method adds all listeners to the semantic element behind this
838,838c883,883
< 	 * Override this method to add more semantic listeners down the hierarchy
---
>      * EditPart Override this method to add more semantic listeners down the
839,839c884,884
< 	 * This method is called only if the semantic element is resolvable
---
>      * hierarchy This method is called only if the semantic element is
839a885,885
>      * resolvable
858,858c904,904
< 	 * This method removes all listeners to the semantic element behind this EditPart
---
>      * This method removes all listeners to the semantic element behind this
859,859c905,905
< 	 * Override this method to remove semantic listeners
---
>      * EditPart Override this method to remove semantic listeners down the
860,860c906,906
< 	 * down the hierarchy
---
>      * hierarchy
890,890d935
< 		this.editableEditPart = new DefaultEditableEditPart(this);
977,977c1022,1022
< 			.getStyle(NotationPackage.eINSTANCE.getRoutingStyle());
---
>             .getStyle(NotationPackage.Literals.ROUTING_STYLE);
1063,1063c1109,1109
< 			.getStyle(NotationPackage.eINSTANCE.getRoutingStyle());
---
>             .getStyle(NotationPackage.Literals.ROUTING_STYLE);
1089,1089c1135,1135
< 			.getStyle(NotationPackage.eINSTANCE.getRoutingStyle());
---
>             .getStyle(NotationPackage.Literals.ROUTING_STYLE);
1128,1128c1174,1174
< 			.getStyle(NotationPackage.eINSTANCE.getRoutingStyle());
---
>             .getStyle(NotationPackage.Literals.ROUTING_STYLE);
1134a1181,1186
>             
> 			if (avoidObstruction)
> 				installEditPolicy(EditPolicy.CONNECTION_BENDPOINTS_ROLE,null);
> 			else
> 				installBendpointEditPolicy();
> 
1158a1211,1211
>             NotationPackage.Literals.FONT_STYLE);
1159,1159d1210
< 			NotationPackage.eINSTANCE.getFontStyle());
1177a1230,1238
>         if (cachedFontData != null && cachedFontData.equals(fontData)) {
>             // the font was previously set and has not changed; do nothing.
>             return;
>         }
> 
>         try {
>             Font newFont = getResourceManager().createFont(
>                 FontDescriptor.createFrom(fontData));
>             getFigure().setFont(newFont);
1178,1180d1229
< 		getFigure().setFont(
< 			DiagramFontRegistry.getInstance().getFont(Display.getDefault(),
< 				fontData));
1181a1240,1252
> 
>             if (cachedFontData != null) {
>                 getResourceManager().destroyFont(
>                     FontDescriptor.createFrom(cachedFontData));
>             }
>             cachedFontData = fontData;
>         } catch (DeviceResourceException e) {
>             Trace.catching(DiagramUIPlugin.getInstance(),
>                 DiagramUIDebugOptions.EXCEPTIONS_CATCHING, getClass(),
>                 "setFont", e); //$NON-NLS-1$
>             Log.error(DiagramUIPlugin.getInstance(),
>                 DiagramUIStatusCodes.IGNORED_EXCEPTION_WARNING, "setFont", e); //$NON-NLS-1$
>         }
1329a1401,1423
>         if (isEditable == false) {
>             return;
>         }
> 
>         List l = getSourceConnections();
>         int size = l.size();
>         for (int i = 0; i < size; i++) {
>             Object obj = l.get(i);
>             if (obj instanceof IEditableEditPart) {
>                 ((IEditableEditPart) obj).disableEditMode();
>             }
>         }
> 
>         List c = getChildren();
>         size = c.size();
>         for (int i = 0; i < size; i++) {
>             Object obj = c.get(i);
>             if (obj instanceof IEditableEditPart) {
>                 ((IEditableEditPart) obj).disableEditMode();
>             }
>         }
> 
>         isEditable = false;
1330,1330d1400
< 		this.editableEditPart.disableEditMode();
1336a1430,1450
>         if (isEditable) {
>             return;
>         }
>         isEditable = true;
>         List c = getChildren();
>         int size = c.size();
>         for (int i = 0; i < size; i++) {
>             Object obj = c.get(i);
>             if (obj instanceof IEditableEditPart) {
>                 ((IEditableEditPart) obj).enableEditMode();
>             }
>         }
> 
>         List l = getSourceConnections();
>         size = l.size();
>         for (int i = 0; i < size; i++) {
>             Object obj = l.get(i);
>             if (obj instanceof IEditableEditPart) {
>                 ((IEditableEditPart) obj).enableEditMode();
>             }
>         }
1337,1337d1429
< 		this.editableEditPart.enableEditMode();
1344a1458,1458
>         // transaction
1344,1344c1457,1457
< 		// protect against deadlock - don't allow any action while write transaction
---
>         // protect against deadlock - don't allow any action while write
1347a1462,1462
>         return isEditable;
1348,1349d1461
< 		
< 		return this.editableEditPart.isEditModeEnabled();
1412a1526,1527
>         RootEditPart root = getRoot();
>         if (root instanceof IDiagramPreferenceSupport) {
1413,1413d1525
< 		if (getRoot() instanceof IDiagramPreferenceSupport) {
1414,1414c1528,1528
< 			return ((IDiagramPreferenceSupport) getRoot()).getPreferencesHint();
---
>             return ((IDiagramPreferenceSupport) root).getPreferencesHint();
1438,1438c1552,1552
< 		if (NotationPackage.eINSTANCE.getView_PersistedChildren().equals(
---
>         if (NotationPackage.Literals.VIEW__PERSISTED_CHILDREN.equals(
1439a1554,1554
>             || NotationPackage.Literals.VIEW__TRANSIENT_CHILDREN.equals(
1440,1440d1553
< 			|| NotationPackage.eINSTANCE.getView_TransientChildren().equals(
1443,1443c1557,1557
< 		} else if (NotationPackage.eINSTANCE.getView_Visible().equals(feature)) {
---
>         } else if (NotationPackage.Literals.VIEW__VISIBLE.equals(feature)) {
1450,1450c1564,1564
< 		} else if (NotationPackage.eINSTANCE.getRoutingStyle_Routing().equals(
---
>         } else if (NotationPackage.Literals.ROUTING_STYLE__ROUTING.equals(
1452a1567,1567
>         } else if (NotationPackage.Literals.ROUTING_STYLE__SMOOTHNESS
1453,1453d1566
< 		} else if (NotationPackage.eINSTANCE.getRoutingStyle_Smoothness()
1454a1569,1569
>             || NotationPackage.Literals.ROUTING_STYLE__AVOID_OBSTRUCTIONS
1455,1455d1568
< 			|| NotationPackage.eINSTANCE.getRoutingStyle_AvoidObstructions()
1456a1571,1571
>             || NotationPackage.Literals.ROUTING_STYLE__CLOSEST_DISTANCE
1457,1457d1570
< 			|| NotationPackage.eINSTANCE.getRoutingStyle_ClosestDistance()
1458a1573,1573
>             || NotationPackage.Literals.ROUTING_STYLE__JUMP_LINK_STATUS
1459,1459d1572
< 			|| NotationPackage.eINSTANCE.getRoutingStyle_JumpLinkStatus()
1460a1575,1575
>             || NotationPackage.Literals.ROUTING_STYLE__JUMP_LINK_TYPE.equals(
1461,1461d1574
< 			|| NotationPackage.eINSTANCE.getRoutingStyle_JumpLinkType().equals(
1462a1577,1577
>             || NotationPackage.Literals.ROUTING_STYLE__JUMP_LINKS_REVERSE
1463,1463d1576
< 			|| NotationPackage.eINSTANCE.getRoutingStyle_JumpLinksReverse()
1466,1466c1580,1580
< 		} else if (NotationPackage.eINSTANCE.getLineStyle_LineColor().equals(
---
>         } else if (NotationPackage.Literals.LINE_STYLE__LINE_COLOR.equals(
1469,1469c1583,1583
< 			setForegroundColor(DiagramColorRegistry
---
>             setForegroundColor(DiagramColorRegistry.getInstance().getColor(c));
1469a1584,1584
>         } else if (NotationPackage.Literals.RELATIVE_BENDPOINTS__POINTS
1470,1471d1583
< 				.getInstance().getColor(c));
< 		} else if (NotationPackage.eINSTANCE.getRelativeBendpoints_Points()
1473a1587,1588
>         } else if (event.getFeature() == NotationPackage.Literals
>             .VIEW__ELEMENT
1474,1475d1586
< 		} else if (event.getFeature() == NotationPackage.eINSTANCE
< 			.getView_Element()
1476,1476c1589,1589
< 			&& ((EObject) event.getNotifier()) == getNotationView())
---
>             && ((EObject) event.getNotifier()) == getNotationView()){
1476a1590,1592
>             handleMajorSemanticChange();
>        } else if (event.getEventType() == EventType.UNRESOLVE
>                 && event.getNotifier() == ((View) getModel()).getElement())
1481,1481c1597,1597
< 	 * @return <code>IMapMode</code> that allows for the coordinate mapping from device to
---
>      * @return <code>IMapMode</code> that allows for the coordinate mapping
1481a1598,1598
>      *         from device to logical units.
1482,1482d1597
< 	 * logical units. 
1484,1484c1600,1600
< 	final protected IMapMode getMapMode() {
---
>     protected IMapMode getMapMode() {
1504a1621,1621
>                 editingDomain = TransactionUtil
1505,1505c1622,1622
<                 editingDomain = TransactionUtil.getEditingDomain(getDiagramView());
---
>                     .getEditingDomain(getDiagramView());
1522a1640,1707
>     
>     
>     public Object getPreferredValue(EStructuralFeature feature) {
>         Object preferenceStore = getDiagramPreferencesHint()
>             .getPreferenceStore();
>         if (preferenceStore instanceof IPreferenceStore) {            
>             if (feature == NotationPackage.eINSTANCE.getLineStyle_LineColor()) {
>                 
>                 return FigureUtilities.RGBToInteger(PreferenceConverter
>                     .getColor((IPreferenceStore) preferenceStore,
>                         IPreferenceConstants.PREF_LINE_COLOR));
>                 
>             } else if (feature == NotationPackage.eINSTANCE
>                 .getFontStyle_FontColor()) {
>                 
>                 return FigureUtilities.RGBToInteger(PreferenceConverter
>                     .getColor((IPreferenceStore) preferenceStore,
>                         IPreferenceConstants.PREF_FONT_COLOR));
>                 
>             }
>         }
>         return getStructuralFeatureValue(feature);
>     }
>     
>     
>     /**
>      * Gets the resource manager to remember the resources allocated for this
>      * graphical viewer. All resources will be disposed when the graphical
>      * viewer is closed if they have not already been disposed.
>      * 
>      * @return the resource manager
>      */
>     protected ResourceManager getResourceManager() {
>         EditPartViewer viewer = getViewer();
>         if (viewer instanceof DiagramGraphicalViewer) {
>             return ((DiagramGraphicalViewer) viewer).getResourceManager();
>         }
>         return JFaceResources.getResources();
>     } 
>     
>     /**
> 	 * Answers whether or not this connection represents a part of the semantic
> 	 * model.
> 	 * 
> 	 * @return <code>true</code> if this connection has semantic meaning,
> 	 *         <code>false</code> otherwise.
> 	 */
> 	public boolean isSemanticConnection() {
> 
> 		if (semanticConnection == null) {
> 			if (getEdge() != null && (getEdge().getElement() != null
> 					|| !NotationTypeUtil.hasNotationType(getEdge()))) {
> 				semanticConnection = Boolean.TRUE;
> 			} else {
> 				semanticConnection = Boolean.FALSE;
> 			}
> 		}
> 		return semanticConnection.booleanValue();
> 	}
> 	
> 	/**
> 	 * Clear the semantic connection value when the model changes.
> 	 */
> 	public void setModel(Object model) {
> 		super.setModel(model);
> 		semanticConnection = null;
> 	}
>   
