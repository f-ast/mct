108,108d107
< 
110a110,112
> 			// Semantic hint is not specified. Can be a result of call from CanonicalEditPolicy.
> 			// In this situation there should be NO elementType, visualID will be determined
> 			// by VisualIDRegistry.getNodeVisualID() for domainElement.
117a120,125
> 				// Semantic hint is specified together with element type.
> 				// Both parameters should describe exactly the same diagram element.
> 				// In addition we check that visualID returned by VisualIDRegistry.getNodeVisualID() for
> 				// domainElement (if specified) is the same as in element type.
> 				if (!GMFGraphElementTypes.isKnownElementType(elementType) || (!(elementType instanceof IHintedType))) {
> 					return null; // foreign element type
118,118c270,270
< 				if (!GMFGraphElementTypes.isKnownElementType(elementType) || false == elementType instanceof IHintedType) {
---
> 		if (!GMFGraphElementTypes.isKnownElementType(elementType) || (!(elementType instanceof IHintedType))) {
118a271,271
> 			return null; // foreign element type
119,119d270
< 					return null;
122a129,129
> 					return null; // if semantic hint is specified it should be the same as in element type
123,123d128
< 					return null;
125a132,132
> 					return null; // visual id for node EClass should match visual id from element type
126,126d131
< 					return null;
128a135,141
> 				// Element type is not specified. Domain element should be present (except pure design elements).
> 				// This method is called with EObjectAdapter as parameter from:
> 				//   - ViewService.createNode(View container, EObject eObject, String type, PreferencesHint preferencesHint) 
> 				//   - generated ViewFactory.decorateView() for parent element
> 				if (!CanvasEditPart.MODEL_ID.equals(GMFGraphVisualIDRegistry.getModelID(containerView))) {
> 					return null; // foreign diagram
> 				}
130,130d142
< 				case CanvasEditPart.VISUAL_ID:
137,137c152,152
< 				case Rectangle2EditPart.VISUAL_ID:
---
> 				case Rectangle2EditPart.VISUAL_ID:
147a160,193
> 					if (domainElement == null || visualID != GMFGraphVisualIDRegistry.getNodeVisualID(containerView, domainElement)) {
> 						return null; // visual id in semantic hint should match visual id for domain element
> 					}
> 					break;
> 				case CompartmentNameEditPart.VISUAL_ID:
> 				case CompartmentVisualFacetsEditPart.VISUAL_ID:
> 					if (CompartmentEditPart.VISUAL_ID != GMFGraphVisualIDRegistry.getVisualID(containerView) || containerView.getElement() != domainElement) {
> 						return null; // wrong container
> 					}
> 					break;
> 				case NodeNameEditPart.VISUAL_ID:
> 				case NodeVisualFacetsEditPart.VISUAL_ID:
> 					if (NodeEditPart.VISUAL_ID != GMFGraphVisualIDRegistry.getVisualID(containerView) || containerView.getElement() != domainElement) {
> 						return null; // wrong container
> 					}
> 					break;
> 				case ConnectionNameEditPart.VISUAL_ID:
> 				case ConnectionVisualFacetsEditPart.VISUAL_ID:
> 					if (ConnectionEditPart.VISUAL_ID != GMFGraphVisualIDRegistry.getVisualID(containerView) || containerView.getElement() != domainElement) {
> 						return null; // wrong container
> 					}
> 					break;
> 				case FigureGalleryNameEditPart.VISUAL_ID:
> 				case FigureGalleryFiguresEditPart.VISUAL_ID:
> 					if (FigureGalleryEditPart.VISUAL_ID != GMFGraphVisualIDRegistry.getVisualID(containerView) || containerView.getElement() != domainElement) {
> 						return null; // wrong container
> 					}
> 					break;
> 				case FigureDescriptorNameEditPart.VISUAL_ID:
> 					if (FigureDescriptorEditPart.VISUAL_ID != GMFGraphVisualIDRegistry.getVisualID(containerView) || containerView.getElement() != domainElement) {
> 						return null; // wrong container
> 					}
> 					break;
> 				default:
148,151d159
< 				case ChildAccessEditPart.VISUAL_ID:
< 				case CompartmentAccessorEditPart.VISUAL_ID:
< 				case DiagramLabelAccessorEditPart.VISUAL_ID:
< 				case DiagramElementFigureEditPart.VISUAL_ID:
155a198,204
> 		return getNodeViewClass(containerView, visualID);
> 	}
> 
> 	/**
> 	 * @generated
> 	 */
> 	protected Class getNodeViewClass(View containerView, int visualID) {
156,156c205,205
< 		if (!GMFGraphVisualIDRegistry.canCreateNode(containerView, visualID)) {
---
> 		if (containerView == null || !GMFGraphVisualIDRegistry.canCreateNode(containerView, visualID)) {
221,225d269
< 		if (elementType == null) {
< 			return null;
< 		}
< 		if (!GMFGraphElementTypes.isKnownElementType(elementType) || false == elementType instanceof IHintedType) {
< 			return null;
228a275,275
> 			return null; // our hint is visual id and must be specified
229,229d274
< 			return null;
231a278,278
> 			return null; // if semantic hint is specified it should be the same as in element type
232,232d277
< 			return null;
236a283,283
> 			return null; // visual id for link EClass should match visual id from element type
237,237d282
< 			return null;
238a285,291
> 		return getEdgeViewClass(visualID);
> 	}
> 
> 	/**
> 	 * @generated
> 	 */
> 	protected Class getEdgeViewClass(int visualID) {
