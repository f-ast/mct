2,2c2,2
<  * Copyright (c) 2006 Borland Software Corporation and others.
---
>  *  Copyright (c) 2006, 2007 Borland Software Corporation and others.
12a13,17
> import java.util.ArrayList;
> import java.util.Collection;
> import java.util.Collections;
> import java.util.Iterator;
> 
13,14d30
< import org.eclipse.gef.commands.Command;
< import org.eclipse.gmf.runtime.emf.type.core.commands.DestroyElementCommand;
15,15c31,31
< import org.eclipse.gmf.runtime.emf.type.core.requests.CreateRelationshipRequest;
---
> import org.eclipse.gmf.runtime.emf.type.core.requests.CreateRelationshipRequest;
16,16c32,32
< import org.eclipse.gmf.runtime.emf.type.core.requests.DestroyElementRequest;
---
> import org.eclipse.gmf.runtime.emf.type.core.requests.DestroyElementRequest;
17a19,21
> import org.eclipse.gef.EditPart;
> import org.eclipse.gef.commands.Command;
> import org.eclipse.gef.commands.CompoundCommand;
17a34,34
> import org.eclipse.gmf.runtime.notation.Edge;
18,18d33
< import org.eclipse.emf.ecore.EAnnotation;
19,19c35,35
< import org.eclipse.gmf.runtime.notation.View;
---
> import org.eclipse.gmf.runtime.notation.View;
21,21c89,89
< 
---
> 
22a24,24
> import org.eclipse.gmf.gmfgraph.FigureHandle;
23a26,26
> import org.eclipse.gmf.graphdef.editor.edit.parts.Polyline2EditPart;
24,24d25
< 
25a28,29
> import org.eclipse.gmf.runtime.diagram.ui.requests.EditCommandRequestWrapper;
> import org.eclipse.gmf.runtime.emf.type.core.commands.DestroyElementCommand;
26,26d27
< 
28,28d30
< 
39a46,47
> 		CompoundCommand cc = new CompoundCommand();
> 		Collection allEdges = new ArrayList();
40,40c58,58
< 		return getMSLWrapper(new DestroyElementCommand(req) {
---
> 		cc.add(getMSLWrapper(new DestroyElementCommand(req)));
40a59,59
> 		return cc;
41,42d58
< 
< 			protected EObject getElementToDestroy() {
43a49,56
> 		allEdges.addAll(view.getSourceEdges());
> 		allEdges.addAll(view.getTargetEdges());
> 		for (Iterator it = allEdges.iterator(); it.hasNext();) {
> 			Edge nextEdge = (Edge) it.next();
> 			EditPart nextEditPart = (EditPart) getHost().getViewer().getEditPartRegistry().get(nextEdge);
> 			EditCommandRequestWrapper editCommandRequest = new EditCommandRequestWrapper(new DestroyElementRequest(((Polyline2EditPart) getHost()).getEditingDomain(), req.isConfirmationRequired()),
> 					Collections.EMPTY_MAP);
> 			cc.add(nextEditPart.getCommand(editCommandRequest));
44,48d48
< 				EAnnotation annotation = view.getEAnnotation("Shortcut"); //$NON-NLS-1$
< 				if (annotation != null) {
< 					return view;
< 				}
< 				return super.getElementToDestroy();
50,51d57
< 
< 		});
59,59c67,67
< 			return req.getTarget() == null ? null : getCreateCompleteIncomingDiagramElement_Figure4001Command(req);
---
> 			return req.getTarget() == null ? null : getCreateCompleteIncomingDiagramElementFigure_4001Command(req);
67,67c75,75
< 	protected Command getCreateCompleteIncomingDiagramElement_Figure4001Command(CreateRelationshipRequest req) {
---
> 	protected Command getCreateCompleteIncomingDiagramElementFigure_4001Command(CreateRelationshipRequest req) {
67a76,78
> 		EObject sourceEObject = req.getSource();
> 		EObject targetEObject = req.getTarget();
> 		if (false == sourceEObject instanceof DiagramElement || false == targetEObject instanceof FigureHandle) {
68,68d75
< 		if (!(req.getSource() instanceof DiagramElement)) {
70a81,83
> 		DiagramElement source = (DiagramElement) sourceEObject;
> 		FigureHandle target = (FigureHandle) targetEObject;
> 		if (!GMFGraphBaseItemSemanticEditPolicy.LinkConstraints.canCreateDiagramElementFigure_4001(source, target)) {
71,72d80
< 		DiagramElement element = (DiagramElement) req.getSource();
< 		if (element.getFigure() != null) {
75,75c86,86
< 		SetRequest setReq = new SetRequest(req.getSource(), GMFGraphPackage.eINSTANCE.getDiagramElement_Figure(), req.getTarget());
---
> 		SetRequest setReq = new SetRequest(sourceEObject, GMFGraphPackage.eINSTANCE.getDiagramElement_Figure(), target);
