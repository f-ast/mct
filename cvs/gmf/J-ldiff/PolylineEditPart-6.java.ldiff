3a4,4
> import java.util.Collection;
8,8d8
< 
14,14d13
< 
20,20d19
< 
21a22,22
> import org.eclipse.emf.ecore.EObject;
22,22d21
< 
24,24d23
< 
26,26d24
< 
29,29d26
< 
32,32d28
< 
38,38c20,20
< import org.eclipse.gmf.gmfgraph.Layout;
---
> import org.eclipse.draw2d.geometry.Rectangle;
39,40d20
< import org.eclipse.gmf.gmfgraph.LayoutData;
< import org.eclipse.gmf.gmfgraph.LineKind;
45,45d37
< 
50,50d41
< 
52,52d42
< 
54,54d43
< 
57,57d45
< 
61,61d48
< 
63,63d49
< 
66,66d51
< 
126,126c111,111
< 		final NotificationListener layoutListener = new NotificationListener() {
---
> 		final NotificationListener Layoutable_LayoutData_PropertiesListener = new NotificationListener() {
129,130d113
< 				Layout layout = (Layout) notification.getNotifier();
< 				layoutPropertyChanged(layout);
134,134c138,138
< 			addListenerFilter("LayoutPropertiesListener", layoutListener, modelElement.getLayout());
---
> 			addListenerFilter("Layoutable_Layout_PropertiesListener", Layoutable_Layout_PropertiesListener, modelElement.getLayout());
136,136c140,140
< 		addListenerFilter("ModelElementLayoutListener", new NotificationListener() {
---
> 		addListenerFilter("Layoutable_Layout_Listener", new NotificationListener() {
138a143,145
> 				removeListenerFilter("Layoutable_Layout_PropertiesListener");
> 				if (modelElement.getLayout() != null) {
> 					addListenerFilter("Layoutable_Layout_PropertiesListener", Layoutable_Layout_PropertiesListener, modelElement.getLayout());
139,142d142
< 				Layout newLayout = (Layout) notification.getNewValue();
< 				removeListenerFilter("LayoutPropertiesListener");
< 				if (newLayout != null) {
< 					addListenerFilter("LayoutPropertiesListener", layoutListener, newLayout);
144,144d146
< 				layoutChanged(newLayout, true);
148,148d150
< 		final NotificationListener layoutDataListener = new NotificationListener() {
151,151d153
< 				layoutDataPropertyChanged();
152a156,161
> 		}, modelElement, GMFGraphPackage.eINSTANCE.getShape_Outline());
> 
> 		addListenerFilter("Shape_Fill_Listener", new NotificationListener() {
> 
> 			public void notifyChanged(Notification notification) {
> 				myFigure.setFill(modelElement.isFill());
152a114,115
> 				layoutDataChanged(modelElement.getLayoutData());
> 			}
153,153c116,116
< 		};
---
> 		};
154,154c117,117
< 		if (modelElement.getLayoutData() != null) {
---
> 		if (modelElement.getLayoutData() != null) {
155a119,134
> 		}
> 		addListenerFilter("Layoutable_LayoutData_Listener", new NotificationListener() {
> 
> 			public void notifyChanged(Notification notification) {
> 				removeListenerFilter("Layoutable_LayoutData_PropertiesListener");
> 				if (modelElement.getLayoutData() != null) {
> 					addListenerFilter("Layoutable_LayoutData_PropertiesListener", Layoutable_LayoutData_PropertiesListener, modelElement.getLayoutData());
> 				}
> 				layoutDataChanged(modelElement.getLayoutData());
> 			}
> 		}, modelElement, GMFGraphPackage.eINSTANCE.getLayoutable_LayoutData());
> 
> 		final NotificationListener Layoutable_Layout_PropertiesListener = new NotificationListener() {
> 
> 			public void notifyChanged(Notification notification) {
> 				layoutChanged(modelElement.getLayout());
155,155c118,118
< 			addListenerFilter("LayoutDataPropertiesListener", layoutDataListener, modelElement.getLayoutData());
---
> 			addListenerFilter("Layoutable_LayoutData_PropertiesListener", Layoutable_LayoutData_PropertiesListener, modelElement.getLayoutData());
156a163,165
> 		}, modelElement, GMFGraphPackage.eINSTANCE.getShape_Fill());
> 
> 		addListenerFilter("Shape_LineWidth_Listener", new NotificationListener() {
157,157c151,151
< 		addListenerFilter("ModelElementLayoutDataListener", new NotificationListener() {
---
> 		addListenerFilter("Shape_Outline_Listener", new NotificationListener() {
160,163d167
< 				LayoutData newLayoutData = (LayoutData) notification.getNewValue();
< 				removeListenerFilter("LayoutDataPropertiesListener");
< 				if (newLayoutData != null) {
< 					addListenerFilter("LayoutDataPropertiesListener", layoutDataListener, newLayoutData);
164a170,175
> 		}, modelElement, GMFGraphPackage.eINSTANCE.getShape_LineWidth());
> 
> 		addListenerFilter("Shape_LineKind_Listener", new NotificationListener() {
> 
> 			public void notifyChanged(Notification notification) {
> 				myFigure.setLineStyle(getLineStyle(modelElement.getLineKind()));
165,165d169
< 				layoutDataChanged();
167,167c177,177
< 		}, modelElement, GMFGraphPackage.eINSTANCE.getLayoutable_LayoutData());
---
> 		}, modelElement, GMFGraphPackage.eINSTANCE.getShape_LineKind());
169,169c179,179
< 		addListenerFilter("ModelElementPropertiesListener", new NotificationListener() {
---
> 		addListenerFilter("Shape_XorFill_Listener", new NotificationListener() {
172,176d181
< 				switch (notification.getFeatureID(Polyline.class)) {
< 				case org.eclipse.gmf.gmfgraph.GMFGraphPackage.POLYLINE__OUTLINE: {
< 					boolean value = modelElement.isOutline();
< 					myFigure.setOutline(value);
< 					break;
177a184,189
> 		}, modelElement, GMFGraphPackage.eINSTANCE.getShape_XorFill());
> 
> 		addListenerFilter("Shape_XorOutline_Listener", new NotificationListener() {
> 
> 			public void notifyChanged(Notification notification) {
> 				myFigure.setOutlineXOR(modelElement.isXorOutline());
178,181d183
< 				case org.eclipse.gmf.gmfgraph.GMFGraphPackage.POLYLINE__FILL: {
< 					boolean value = modelElement.isFill();
< 					myFigure.setFill(value);
< 					break;
182a191,196
> 		}, modelElement, GMFGraphPackage.eINSTANCE.getShape_XorOutline());
> 
> 		final NotificationListener Polyline_Template_PropertiesListener = new NotificationListener() {
> 
> 			public void notifyChanged(Notification notification) {
> 				myFigure.setPoints(getPointList(modelElement.getTemplate()));
183,183d478
< 				case org.eclipse.gmf.gmfgraph.GMFGraphPackage.POLYLINE__LINE_WIDTH: {
184,184c479,479
< 					int value = modelElement.getLineWidth();
---
> 				myFigure.setLineWidth(modelElement.getLineWidth());
185,186d479
< 					myFigure.setLineWidth(value);
< 					break;
187a198,200
> 		};
> 		for (int i = 0; i < modelElement.getTemplate().size(); i++) {
> 			addListenerFilter("Polyline_Template_PropertiesListener#" + i, Polyline_Template_PropertiesListener, (EObject) modelElement.getTemplate().get(i));
188,194d197
< 				case org.eclipse.gmf.gmfgraph.GMFGraphPackage.POLYLINE__LINE_KIND: {
< 					LineKind value = modelElement.getLineKind();
< 					myFigure.setLineStyle("LINE_DASH".equals(value.getName()) ? org.eclipse.draw2d.Graphics.LINE_DASH : "LINE_DOT".equals(value.getName()) ? org.eclipse.draw2d.Graphics.LINE_DOT
< 							: "LINE_DASHDOT".equals(value.getName()) ? org.eclipse.draw2d.Graphics.LINE_DASHDOT
< 									: "LINE_DASHDOTDOT".equals(value.getName()) ? org.eclipse.draw2d.Graphics.LINE_DASHDOTDOT
< 											: "LINE_CUSTOM".equals(value.getName()) ? org.eclipse.draw2d.Graphics.LINE_CUSTOM : org.eclipse.draw2d.Graphics.LINE_SOLID);
< 					break;
195a202,209
> 		addListenerFilter("Polyline_Template_Listener", new NotificationListener() {
> 
> 			public void notifyChanged(Notification notification) {
> 				int listSize = modelElement.getTemplate().size();
> 				if (notification.getOldValue() instanceof Collection) {
> 					listSize += ((Collection) notification.getOldValue()).size();
> 				} else {
> 					listSize++;
196,199d201
< 				case org.eclipse.gmf.gmfgraph.GMFGraphPackage.POLYLINE__XOR_FILL: {
< 					boolean value = modelElement.isXorFill();
< 					myFigure.setFillXOR(value);
< 					break;
200a211,212
> 				for (int i = 0; i < listSize; i++) {
> 					removeListenerFilter("Polyline_Template_PropertiesListener#" + i);
201,204d210
< 				case org.eclipse.gmf.gmfgraph.GMFGraphPackage.POLYLINE__XOR_OUTLINE: {
< 					boolean value = modelElement.isXorOutline();
< 					myFigure.setOutlineXOR(value);
< 					break;
205a214,215
> 				for (int i = 0; i < modelElement.getTemplate().size(); i++) {
> 					addListenerFilter("Polyline_Template_PropertiesListener#" + i, Polyline_Template_PropertiesListener, (EObject) modelElement.getTemplate().get(i));
206a217,217
> 				myFigure.setPoints(getPointList(modelElement.getTemplate()));
207,207d216
< 				myFigure.repaint();
208a219,219
> 		}, modelElement, GMFGraphPackage.eINSTANCE.getPolyline_Template());
208a467,470
> 				layoutDataChanged(modelElement.getLayoutData());
> 			}
> 			{
> 				layoutChanged(modelElement.getLayout());
209,209d466
< 		}, modelElement);
457,457c154,154
< 				boolean value = modelElement.isOutline();
---
> 				myFigure.setOutline(modelElement.isOutline());
458,458d154
< 				myFigure.setOutline(value);
460a473,473
> 				myFigure.setOutline(modelElement.isOutline());
461,461c476,476
< 				boolean value = modelElement.isFill();
---
> 				myFigure.setFill(modelElement.isFill());
462,462d476
< 				myFigure.setFill(value);
465,465c168,168
< 				int value = modelElement.getLineWidth();
---
> 				myFigure.setLineWidth(modelElement.getLineWidth());
466,466d168
< 				myFigure.setLineWidth(value);
468a15,15
> import org.eclipse.draw2d.Graphics;
469,472d14
< 				LineKind value = modelElement.getLineKind();
< 				myFigure.setLineStyle("LINE_DASH".equals(value.getName()) ? org.eclipse.draw2d.Graphics.LINE_DASH : "LINE_DOT".equals(value.getName()) ? org.eclipse.draw2d.Graphics.LINE_DOT
< 						: "LINE_DASHDOT".equals(value.getName()) ? org.eclipse.draw2d.Graphics.LINE_DASHDOT : "LINE_DASHDOTDOT".equals(value.getName()) ? org.eclipse.draw2d.Graphics.LINE_DASHDOTDOT
< 								: "LINE_CUSTOM".equals(value.getName()) ? org.eclipse.draw2d.Graphics.LINE_CUSTOM : org.eclipse.draw2d.Graphics.LINE_SOLID);
474a482,482
> 				myFigure.setLineStyle(getLineStyle(modelElement.getLineKind()));
475,475c182,182
< 				boolean value = modelElement.isXorFill();
---
> 				myFigure.setFillXOR(modelElement.isXorFill());
476,476d182
< 				myFigure.setFillXOR(value);
478a485,487
> 				myFigure.setFillXOR(modelElement.isXorFill());
> 			}
> 			{
479,479c488,488
< 				boolean value = modelElement.isXorOutline();
---
> 				myFigure.setOutlineXOR(modelElement.isXorOutline());
479a489,491
> 			}
> 			{
> 				myFigure.setPoints(getPointList(modelElement.getTemplate()));
480,480d488
< 				myFigure.setOutlineXOR(value);
482,482c147,147
< 			layoutChanged(modelElement.getLayout(), false);
---
> 				layoutChanged(modelElement.getLayout());
585a596,597
> 		private Rectangle myBounds;
> 
599a612,657
> 		protected void outlineShape(Graphics g) {
> 			Rectangle bounds = getBounds();
> 			g.translate(bounds.x, bounds.y);
> 			super.outlineShape(g);
> 			g.translate(-bounds.x, -bounds.y);
> 		}
> 
> 		public Rectangle getBounds() {
> 			if (myBounds == null) {
> 				myBounds = new Rectangle(0, 0, 0, 0);
> 			}
> 			return myBounds;
> 		}
> 
> 		public void primTranslate(int dx, int dy) {
> 			getBounds().x += dx;
> 			getBounds().y += dy;
> 			if (useLocalCoordinates()) {
> 				fireCoordinateSystemChanged();
> 				return;
> 			}
> 		}
> 
> 		public void setBounds(Rectangle rect) {
> 			boolean resize = (rect.width != getBounds().width) || (rect.height != getBounds().height), translate = (rect.x != getBounds().x) || (rect.y != getBounds().y);
> 
> 			if ((resize || translate) && isVisible())
> 				erase();
> 			if (translate) {
> 				int dx = rect.x - getBounds().x;
> 				int dy = rect.y - getBounds().y;
> 				primTranslate(dx, dy);
> 			}
> 
> 			getBounds().width = rect.width;
> 			getBounds().height = rect.height;
> 
> 			if (translate || resize) {
> 				if (resize)
> 					invalidate();
> 				fireFigureMoved();
> 				repaint();
> 			}
> 
> 		}
> 
