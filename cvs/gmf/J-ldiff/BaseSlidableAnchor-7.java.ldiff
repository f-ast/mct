16a17,17
> import org.eclipse.draw2d.PositionConstants;
24a26,26
> import org.eclipse.gmf.runtime.draw2d.ui.geometry.PrecisionPointList;
34,34c36,36
< 	extends AbstractConnectionAnchor {
---
> 	extends AbstractConnectionAnchor implements OrthogonalConnectionAnchor {
40,40c42,42
< 	// The connection anchor refrence point (sometimes the same as anchor location)
---
> 	// The connection anchor reference point (sometimes the same as anchor location)
112a115,115
> 		PrecisionRectangle rBox = new PrecisionRectangle(getBox());
113,113d114
< 		Rectangle rBox = getBox();
116,116c118,118
< 		return new Point(Math.round(relativeReference.preciseX * rBox.width
---
> 		return new PrecisionPoint(relativeReference.preciseX * rBox.preciseWidth
117,117c119,119
< 			+ rBox.x), Math.round(relativeReference.preciseY
---
> 				+ rBox.preciseX, relativeReference.preciseY * rBox.preciseHeight
118,118c120,120
< 			* rBox.height + rBox.y));
---
> 				+ rBox.preciseY);
139,139c141,141
< 	static private int STRAIGHT_LINE_TOLERANCE = 10;
---
> 	static private int STRAIGHT_LINE_TOLERANCE = 3;
145a148,148
> 		Point ownReference = normalizeToStraightlineTolerance(reference, getReferencePoint(), STRAIGHT_LINE_TOLERANCE);
146,150d149
< 		Point foreignReference = reference.getCopy();
< 		Point ownReference = getReferencePoint().getCopy();
< 		
< 		ownReference = normalizeToStraightlineTolerance(foreignReference, ownReference, STRAIGHT_LINE_TOLERANCE);
< 		
151,151c150,150
< 		Point location = getLocation(ownReference, foreignReference);
---
> 		Point location = getLocation(ownReference, reference);
152,152c151,151
< 		if (location == null || 
---
> 		if (location == null) {
153,154d151
< 			getBox().expand(1, 1).contains(foreignReference) &&
< 			!getBox().shrink(1, 1).contains(foreignReference))
155,155c152,152
< 			location = getLocation(getBox().getCenter(), foreignReference);
---
> 			location = getLocation(new PrecisionPoint(getBox().getCenter()), reference);
159a156,156
> 		}
178a176,186
> 		PrecisionPoint preciseOwnReference = new PrecisionPoint(ownReference);
> 		PrecisionPoint normalizedReference = (PrecisionPoint)preciseOwnReference.getCopy();
> 		PrecisionPoint preciseForeignReference = new PrecisionPoint(foreignReference);
> 		if (Math.abs(preciseForeignReference.preciseX - preciseOwnReference.preciseX) < tolerance) {
> 			normalizedReference.preciseX = preciseForeignReference.preciseX;
> 			normalizedReference.updateInts();
> 			return normalizedReference;
> 		}
> 		if (Math.abs(preciseForeignReference.preciseY - preciseOwnReference.preciseY) < tolerance) {
> 			normalizedReference.preciseY = preciseForeignReference.preciseY;
> 			normalizedReference.updateInts();
179,191d175
< 		Point normalizedReference = ownReference.getCopy();
< 		if (Math.abs(foreignReference.x - ownReference.x) < tolerance || 
< 			Math.abs(foreignReference.y - ownReference.y) < tolerance) {
< 			LineSeg lineSeg = new LineSeg(ownReference, foreignReference);
< 				
< 			normalizedReference = lineSeg.perpIntersect(ownReference.x, ownReference.y);
< 			
< 			// account for possible rounding errors and ensure the
< 			// resulting line is straight
< 			if (Math.abs(normalizedReference.x - foreignReference.x) < Math.abs(normalizedReference.y - foreignReference.y))
< 				normalizedReference.x = foreignReference.x;
< 			else
< 				normalizedReference.y = foreignReference.y;
222,222c217,217
< 			PointList polyList = ((IPolygonAnchorableFigure) getOwner()).getPolygonPoints();
---
> 			PrecisionPointList polyList = new PrecisionPointList(((IPolygonAnchorableFigure) getOwner()).getPolygonPoints());
225a221,227
> 		PrecisionRectangle r = new PrecisionRectangle(getBox());
> 		PrecisionPointList ptList = new PrecisionPointList(5);
> 		ptList.addPoint(new PrecisionPoint(r.preciseX, r.preciseY));
> 		ptList.addPoint(new PrecisionPoint(r.preciseX + r.preciseWidth, r.preciseY));
> 		ptList.addPoint(new PrecisionPoint(r.preciseX + r.preciseWidth, r.preciseY + r.preciseHeight));
> 		ptList.addPoint(new PrecisionPoint(r.preciseX, r.preciseY + r.preciseHeight));
> 		ptList.addPoint(new PrecisionPoint(r.preciseX, r.preciseY));
226,232d220
< 		Rectangle rBox = getBox();
< 		PointList ptList = new PointList();
< 		ptList.addPoint(rBox.getTopLeft());
< 		ptList.addPoint(rBox.getTopRight());
< 		ptList.addPoint(rBox.getBottomRight());
< 		ptList.addPoint(rBox.getBottomLeft());
< 		ptList.addPoint(rBox.getTopLeft());
277a273,273
>             .getPoints().getBounds()
278,278d272
<             .getPoints().getBounds().getCopy()
279,279c274,274
<             : getOwner().getBounds().getCopy();
---
>             : getOwner().getBounds();
313a309,345
> 	public Point getOrthogonalLocation(Point orthoReference) {
> 		PrecisionPoint ownReference = new PrecisionPoint(getReferencePoint());
> //		PrecisionRectangle bounds = new PrecisionRectangle(getBox());
> 		PrecisionRectangle bounds = new PrecisionRectangle(FigureUtilities.getAnchorableFigureBounds(getOwner()));
> 		getOwner().translateToAbsolute(bounds);
> 		bounds.expand(0.000001, 0.000001);
> 		PrecisionPoint preciseOrthoReference = new PrecisionPoint(orthoReference);
> 		int orientation = PositionConstants.NONE;
> 		if (preciseOrthoReference.preciseX >= bounds.preciseX && preciseOrthoReference.preciseX <= bounds.preciseX + bounds.preciseWidth) {
> 			ownReference.preciseX = preciseOrthoReference.preciseX;
> 			orientation = PositionConstants.VERTICAL;
> 		} else if (preciseOrthoReference.preciseY >= bounds.preciseY && preciseOrthoReference.preciseY <= bounds.preciseY + bounds.preciseHeight) {
> 			ownReference.preciseY = preciseOrthoReference.preciseY;
> 			orientation = PositionConstants.HORIZONTAL;
> 		}
> 		ownReference.updateInts();
> 		
> 		Point location = getLocation(ownReference, preciseOrthoReference);
> 		if (location == null) {
> 			location = getLocation(orthoReference);
> 			orientation = PositionConstants.NONE;
> 		}
> 		
> 		if (orientation != PositionConstants.NONE) {
> 			PrecisionPoint loc = new PrecisionPoint(location);
> 			if (orientation == PositionConstants.VERTICAL) {
> 				loc.preciseX = preciseOrthoReference.preciseX;
> 			} else {
> 				loc.preciseY = preciseOrthoReference.preciseY;
> 			}
> 			loc.updateInts();
> 			location = loc;
> 		}
> 		
> 		return location;
> 	}
> 
