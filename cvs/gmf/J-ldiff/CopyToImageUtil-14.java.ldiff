45,45c26,26
< import org.eclipse.jface.util.Assert;
---
> import org.eclipse.core.runtime.Assert;
146a147,149
>         DiagramGenerator gen = getDiagramGenerator(diagramEP, format);
>         List editParts = diagramEP.getPrimaryEditParts();
>         copyToImage(gen, editParts, gen.calculateImageRectangle(editParts), destination, format, monitor);
147,184d146
<         boolean found = false;
<         DiagramGenerator gen = null;
<         if (format.equals(ImageFileFormat.SVG)) {
< 
<             gen = new DiagramSVGGenerator(diagramEP);
<             gen.createSWTImageDescriptorForDiagram();
< 
<             monitor.worked(1);
< 
<             saveSVGToFile(destination, (DiagramSVGGenerator) gen, monitor);
<             return gen;
<         } else if (format.equals(ImageFileFormat.JPEG)
<                 || format.equals(ImageFileFormat.PNG)) {
< 
<             String exportFormat = ImageExporter.JPEG_FILE;
<             if (format.equals(ImageFileFormat.PNG))
<                 exportFormat = ImageExporter.PNG_FILE;
< 
<             gen = new DiagramImageGenerator(diagramEP);
<             java.awt.Image image = gen.createAWTImageForDiagram();
<             if (image instanceof BufferedImage) {
<                 ImageExporter.exportToFile(destination, (BufferedImage) image,
<                     exportFormat, monitor);
<                 found = true;
<             }
<         }
< 
<         if (!found) {
<             gen = new DiagramImageGenerator(diagramEP);
<             Image image = gen.createSWTImageDescriptorForDiagram()
<                 .createImage();
< 
<             monitor.worked(1);
< 
<             saveToFile(destination, image, format, monitor);
<             image.dispose();
<         }
< 
208a174,177
>     	DiagramGenerator gen = getDiagramGenerator(diagramEP, format);
>     	copyToImage(gen, selection, gen.calculateImageRectangle(selection), destination, format, monitor);
>         monitor.worked(1);
>     }
209,210d173
<         boolean found = false;
<         if (format.equals(ImageFileFormat.SVG)) {
211a179,193
>     /**
>      * Creates the appropriate <code>DiagramGenerator</code> from <code>DiagramEditPart</code>
>      * based on the supplied <code>ImageFileFormat</code>
>      * 
>      * @param diagramEP diagram editpart
>      * @param format image file format
>      * @return appropriate diagram generator
>      */
>     protected DiagramGenerator getDiagramGenerator(DiagramEditPart diagramEP, ImageFileFormat format) {
>         if (format.equals(ImageFileFormat.SVG)) {
>             return new DiagramSVGGenerator(diagramEP);
>         } else {
>         	return new DiagramImageGenerator(diagramEP);
>         }
>     }
212,213d178
<             DiagramSVGGenerator gen = new DiagramSVGGenerator(diagramEP);
<             gen.createSWTImageDescriptorForParts(selection);
214a195,220
>     /**
> 	 * Generates image of editparts with on a given image rectangle and creates
> 	 * the specified image file containing this image. The image rectangle may
> 	 * be the limitation for the editparts displayed on the image
> 	 * 
> 	 * @param gen
> 	 *            diagram generator
> 	 * @param editParts
> 	 *            editparts to be present on the image
> 	 * @param imageRect
> 	 *            clipping rectangle for the image
> 	 * @param destination
> 	 *            image file path
> 	 * @param format
> 	 *            image file format
> 	 * @param monitor
> 	 *            progress monitor
> 	 * @throws CoreException
> 	 */
>     protected void copyToImage(DiagramGenerator gen, List editParts,
> 			org.eclipse.swt.graphics.Rectangle imageRect, IPath destination,
> 			ImageFileFormat format, IProgressMonitor monitor)
> 			throws CoreException {
> 		boolean found = false;
> 		if (format.equals(ImageFileFormat.SVG)) {
> 			gen.createSWTImageDescriptorForParts(editParts, imageRect);
216,216d221
< 
217,217c222,222
<             saveSVGToFile(destination, gen, monitor);
---
> 			saveSVGToFile(destination, (DiagramSVGGenerator) gen, monitor);
226a232,233
> 					imageRect);
> 			monitor.worked(1);
226,226c231,231
<             java.awt.Image image = new DiagramImageGenerator(diagramEP)
---
> 			java.awt.Image image = gen.createAWTImageForParts(editParts,
227,227d231
<                 .createAWTImageForParts(selection);
236,236d241
<             Image image = new DiagramImageGenerator(diagramEP)
237,237c242,242
<                 .createSWTImageDescriptorForParts(selection).createImage();
---
> 			Image image = gen.createSWTImageDescriptorForParts(editParts,
237a243,243
> 					imageRect).createImage();
238,238d242
< 
240,240d244
< 
244,244d247
< 
