19,19d18
< import org.eclipse.emf.ecore.util.EcoreUtil;
25,25d19
< import org.eclipse.gmf.gmfgraph.Figure;
26,26c20,20
< import org.eclipse.gmf.gmfgraph.FigureAccessor;
---
> import org.eclipse.gmf.gmfgraph.ChildAccess;
28,28c25,25
< import org.eclipse.gmf.gmfgraph.FigureHandle;
---
> import org.eclipse.gmf.gmfgraph.FigureDescriptor;
33,33d30
< import org.eclipse.gmf.graphdef.codegen.NamingStrategy;
100,100c97,97
< 			handleFigure(next.getNodeFigure());
---
> 			handleFigure(next.getFigure());
106,106c103,103
< 			handleFigure(next.getConnectionFigure());
---
> 			handleFigure(next.getFigure());
112,112c109,109
< 			FigureHandle nextFigure = next.getFigure();
---
> 			FigureDescriptor nextFigure = next.getFigure();
116,120d112
< 			if (nextFigure instanceof Figure) {
< 				handleFigure((Figure) nextFigure);
< 			} else {
< 				throw new IllegalStateException("Don't support accessors for compartments yet");
< 			}
125a119,122
> 			if (next.getAccessor() != null) {
> 				// accessor
> 				ChildAccess labelAccess = next.getAccessor();
> 				// XXX nothing to do?
126,151d118
< 			if (next.getFigure() instanceof FigureAccessor) {
< 				assert myElementCopier.containsKey(next.getFigure()) : "Should be copied as part of previously referenced CustomFigure";
< 			} else {
< 				assert next.getFigure() instanceof Figure;
< 				Figure f = (Figure) next.getFigure(); 
< 				if (isInsideProcessedFigure(f)) {
< 					// obviously, fact we got here means f is !getReferencingElements().isEmpty()
< 					// feedback.findAccessorFor(f)
< 					FigureAccessor accessor = GMFGraphFactory.eINSTANCE.createFigureAccessor();
< 					accessor.setAccessor(NamingStrategy.INSTANCE.getChildFigureGetterName(f));
< 					myElementCopier.put(f, accessor);
< 					// find closest ancestor figure
< 					/* XXX assume there's no cases like
< 					 * Node1 -->   Rect1
< 					 * Node2 -->     |- Rect2
< 					 * Label -->          |- gef.Label
< 					 * and the Label we process is from Node1. 
< 					 * With the current approach, we'll get mirrored Rect2 instead of mirrored Rect1.
< 					 */
< 					Figure parent = f;
< 					do {
< 						parent = parent.getParent();
< 						// parent can't be null, as we checked isInsideProcessedFigure prior to that.
< 					} while (!myElementCopier.containsKey(parent));
< 					assert myElementCopier.get(parent) instanceof CustomFigure : "We used to keep custom figures only in the mirrored gallery";
< 					((CustomFigure) myElementCopier.get(parent)).getCustomChildren().add(accessor);
152a124,124
> 				handleFigure(next.getFigure());
153,153c113,113
< 					handleFigure(f);
---
> 			handleFigure(nextFigure);
154,155d113
< 				}
< 				
159a129,129
> 	private void handleFigure(FigureDescriptor fd) throws InterruptedException {
160,164d128
< 	private boolean isInsideProcessedFigure(Figure f) {
< 		return EcoreUtil.isAncestor(myElementCopier.keySet(), f);
< 	}
< 
< 	private void handleFigure(Figure figure) throws InterruptedException {
165,165c130,130
< 		if (myElementCopier.isSubstituted(figure)) {
---
> 		if (myElementCopier.isSubstituted(fd)) {
172,172c137,137
< 		if (figure instanceof CustomFigure && isPlainBareCustomFigure((CustomFigure) figure)) {
---
> 		if (fd.getActualFigure() instanceof CustomFigure && isPlainBareCustomFigure((CustomFigure) fd.getActualFigure())) {
175a141,141
> 			final CustomFigure f = (CustomFigure) fd.getActualFigure();
176,176c142,142
< 			myOutcomeGallery.getFigures().add((CustomFigure) myElementCopier.copy(figure));
---
> 			myOutcomeGallery.getFigures().add(myElementCopier.xcopy(f));
178,178c144,144
< 			String fqn = myCallback.visitFigure(figure);
---
> 			String fqn = myCallback.visitFigure(fd);
179,179c145,145
< 			myElementCopier.registerSubstitution(figure, createCustomFigure(figure, fqn));
---
> 			myElementCopier.registerSubstitution(fd, createCustomFigure(fd, fqn));
191a158,158
> 		featuresToCheck.remove(GMFGraphPackage.eINSTANCE.getRealFigure_Name());
192,192d157
< 		featuresToCheck.remove(GMFGraphPackage.eINSTANCE.getIdentity_Name());
193,193c159,159
< 		featuresToCheck.remove(GMFGraphPackage.eINSTANCE.getFigure_Children());
---
> 		featuresToCheck.remove(GMFGraphPackage.eINSTANCE.getRealFigure_Children());
194,195d159
< 		featuresToCheck.remove(GMFGraphPackage.eINSTANCE.getFigureMarker_Parent());
< 		featuresToCheck.remove(GMFGraphPackage.eINSTANCE.getFigureHandle_ReferencingElements());
197,197d160
< 		featuresToCheck.remove(GMFGraphPackage.eINSTANCE.getCustomClass_BundleName());
212,212c175,175
< 	private CustomFigure createCustomFigure(Figure original, String fqn) {
---
> 	private FigureDescriptor createCustomFigure(FigureDescriptor original, String fqn) {
213,213c176,176
< 		CustomFigure cf = DiagramElementsCopier.createCustomFigure(original);
---
> 		CustomFigure cf = GalleryMirrorProcessor.createCustomFigure(original.getActualFigure());
214,214d176
< 		cf.setName(original.getName());
215a178,182
> 		FigureDescriptor fd = GMFGraphFactory.eINSTANCE.createFigureDescriptor();
> 		fd.setName(original.getName());
> 		fd.setActualFigure(cf);
> 		myOutcomeGallery.getDescriptors().add(fd);
> 		return fd;
216,217d177
< 		myOutcomeGallery.getFigures().add(cf);
< 		return cf;
