13,15d12
< import java.util.HashMap;
< import java.util.Map;
< 
21,21d17
< import org.eclipse.emf.ecore.util.EcoreUtil;
26,26c22,22
< 	private final MigrationHelperDelegate myDelegate;
---
> 	private final MigrationDelegate myDelegate;
27,28d22
< 	private boolean myIsDelegateDisabled = true;
< 	private Map<EStructuralFeature, EStructuralFeature> myNarrowedFeatureTypes;
30,30c24,24
< 	public MigrationHelper(XMLResource resource, MigrationHelperDelegate delegate) {
---
> 	public MigrationHelper(XMLResource resource, MigrationDelegate delegate) {
35a30,31
> 	boolean isMigrationApplied() {
> 		return myDelegate.isMigrationApplied();
36,41d29
< 	void enableDelegate(boolean enabled) {
< 		myIsDelegateDisabled = !enabled;
< 	}
< 
< 	boolean isEnabled() {
< 		return !myIsDelegateDisabled;
46,48d35
< 		if (myIsDelegateDisabled) {
< 			return super.createObject(factory, type);
< 		}
59,66d45
< 		if (myIsDelegateDisabled) {
< 			super.setValue(object, feature, value, position);
< 			return; 
< 		}
< 		EStructuralFeature originalFeature = getOriginalFeature(feature);
< 		if (originalFeature != null) {
< 			feature = originalFeature;
< 		}
74,76d52
< 		if (myIsDelegateDisabled) {
< 			return super.getFeature(eClass, namespaceURI, name, isElement);
< 		}
81,86d56
< 		EClass narrow = myDelegate.getStructuralFeatureType(result);
< 		if (narrow != null) {
< 			EStructuralFeature fake = addNarrowedFeature(result);
< 			fake.setEType(narrow);
< 			return fake;
< 		}
92,94d61
< 		if (myIsDelegateDisabled) {
< 			return super.getType(factory, typeName);
< 		}
105,107d71
< 		if (myIsDelegateDisabled) {
< 			return;
< 		}
110,130d73
< 	
< 	@Override
< 	public void addPrefix(String prefix, String uri) {
< 		super.addPrefix(prefix, uri);
< 		if (myDelegate.isOldVersionDetected(uri)) {
< 			enableDelegate(true);
< 		}
< 	}
< 
< 	protected EStructuralFeature getOriginalFeature(EStructuralFeature feature) {
< 		return myNarrowedFeatureTypes == null ? null : myNarrowedFeatureTypes.get(feature);
< 	}
< 	
< 	protected EStructuralFeature addNarrowedFeature(EStructuralFeature originalFeature) {
< 		if (myNarrowedFeatureTypes == null) {
< 			myNarrowedFeatureTypes = new HashMap<EStructuralFeature, EStructuralFeature>();
< 		}
< 		EStructuralFeature result = (EStructuralFeature) EcoreUtil.copy(originalFeature);
< 		myNarrowedFeatureTypes.put(result, originalFeature);
< 		return result;
< 	}
