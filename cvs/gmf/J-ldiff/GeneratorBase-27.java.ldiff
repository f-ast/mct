45a46,46
> import org.eclipse.jdt.core.IImportDeclaration;
318,318c319,319
< 			pm.beginTask(null, 6);
---
> 			pm.beginTask(null, 7);
323a325,325
> 				IImportDeclaration[] declaredImports = cu.getImports();
325a328,328
> 					copyImports(cu, declaredImports, new SubProgressMonitor(pm, 1));
345,345c348,348
< 				cu.save(new SubProgressMonitor(pm, 1), true);
---
> 				cu.save(new SubProgressMonitor(pm, 2), true);
359a363,385
> 	/*
> 	 * Since we do organizeImports prior to merge, we must ensure
> 	 * imports added manually are known to OrganizeImportsProcessor
> 	 */
> 	private static void copyImports(ICompilationUnit cu, IImportDeclaration[] importsToCopy, IProgressMonitor progress) throws JavaModelException {
> 		if (importsToCopy == null || importsToCopy.length == 0) {
> 			return;
> 		}
> 		progress.beginTask(null, importsToCopy.length + 1);
> 		final String[] imports = new String[importsToCopy.length];
> 		final int[] flags = new int[imports.length];
> 		for (int i = 0; i < importsToCopy.length; i++) {
> 			imports[i] = importsToCopy[i].getElementName();
> 			flags[i] = importsToCopy[i].getFlags();
> 		}
> 		// ensure resource is in sync with buffer (otherwize NPE from CreateElementInCUOperation) 
> 		cu.save(new SubProgressMonitor(progress, 1), true);
> 		for (int i = 0; i < imports.length; i++) {
> 			cu.createImport(imports[i], null, flags[i], new SubProgressMonitor(progress, 1));
> 		}
> 		progress.done();
> 	}
> 
