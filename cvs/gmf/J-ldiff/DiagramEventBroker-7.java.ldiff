2,2c2,2
<  * Copyright (c) 2002, 2005 IBM Corporation and others.
---
>  * Copyright (c) 2002, 2005, 2006 IBM Corporation and others.
13a14,14
> import java.lang.ref.WeakReference;
24a26,27
> import org.eclipse.emf.common.command.Command;
> import org.eclipse.emf.common.command.CompoundCommand;
30,33d32
< import org.eclipse.gmf.runtime.common.core.util.Trace;
< import org.eclipse.gmf.runtime.diagram.core.internal.DiagramDebugOptions;
< import org.eclipse.gmf.runtime.diagram.core.internal.DiagramPlugin;
< import org.eclipse.gmf.runtime.diagram.core.internal.util.MEditingDomainGetter;
34a33,34
> import org.eclipse.emf.transaction.ResourceSetChangeEvent;
> import org.eclipse.emf.transaction.ResourceSetListenerImpl;
35,35d32
< import org.eclipse.gmf.runtime.emf.core.EventTypes;
36,36c35,35
< import org.eclipse.gmf.runtime.emf.core.edit.MEditingDomain;
---
> import org.eclipse.emf.transaction.TransactionalEditingDomain;
37,38d35
< import org.eclipse.gmf.runtime.emf.core.edit.MFilter;
< import org.eclipse.gmf.runtime.emf.core.edit.MUniversalListener;
41a40,40
> 
46,46c45,45
<  * @author melaasar, mmostafa
---
>  * @author melaasar, mmostafa, cmahoney
48,48c47,47
< public class DiagramEventBroker
---
> public class DiagramEventBroker extends ResourceSetListenerImpl {
49,49d47
< 	extends MUniversalListener {
54a53,55
> 	private final NotifierToKeyToListenersSetMap postListeners = new NotifierToKeyToListenersSetMap();
> 	
> 	private static final Map instanceMap = new WeakHashMap();
54,54c52,52
< 	private final NotifierToKeyToListenersSetMap listeners = new NotifierToKeyToListenersSetMap();
---
> 	private final NotifierToKeyToListenersSetMap preListeners = new NotifierToKeyToListenersSetMap();
168a170,171
> 	 * Creates a <code>DiagramEventBroker</code> that listens to all
> 	 * <code>EObject </code> notifications for the given editing domain.
169,170d169
< 	 * Start listening to the model server. {@link MFilter.WildCard} is the
< 	 * default filter by this listener.
171a173,174
> 	private DiagramEventBroker() {
> 		super(NotificationFilter.createNotifierTypeFilter(EObject.class));
172,176d172
< 	public void startListening() {
< 		Trace.trace(DiagramPlugin.getInstance(), DiagramDebugOptions.EVENTS,
< 			this + "#startListening()"); //$NON-NLS-1$
< 		setFilter(new MFilter.NotifierType(EObject.class, false));
< 		super.startListening();
178a177,191
> 	/**
> 	 * Gets the diagmam event broker instance for the editing domain passed in.
> 	 * There is one diagram event broker per editing domain.
> 	 * 
> 	 * @param editingDomain
> 	 * @return Returns the diagram event broker.
> 	 */
> 	public static DiagramEventBroker getInstance(
> 			TransactionalEditingDomain editingDomain) {
> 		WeakReference reference = (WeakReference) instanceMap
> 			.get(editingDomain);
> 		if (reference != null) {
> 			return (DiagramEventBroker) reference.get();
> 		}
> 		return null;
179,183d176
< 	/** Stop listening to Model Server */
< 	public void stopListening() {
< 		Trace.trace(DiagramPlugin.getInstance(), DiagramDebugOptions.EVENTS,
< 			this + "#stopListening()"); //$NON-NLS-1$
< 		super.stopListening();
186a195,198
>      * Creates a new diagram event broker instance for the editing domain passed
>      * in only if the editing domain does not already have a diagram event
>      * broker. There is one diagram event broker per editing domain. Adds the
>      * diagram event broker instance as a listener to the editing domain.
187,188d194
< 	 * Model Server event callback method. This method will redirect the events
< 	 * to their respective event type handler
189a200,200
>      * @param editingDomain
190,191d199
< 	 * @see #handleElementEvent(Notification)
< 	 * @see #handleResourceEvent(Notification)
192a202,211
> 	public static void startListening(
> 			TransactionalEditingDomain editingDomain) {
> 		DiagramEventBroker diagramEventBroker = getInstance(editingDomain);
> 		if (diagramEventBroker == null) {
> 			diagramEventBroker = new DiagramEventBroker();
> 			editingDomain.addResourceSetListener(diagramEventBroker);
> 			instanceMap.put(editingDomain,
> 				new WeakReference(diagramEventBroker));
> 		}
> 	}
193,194d201
< 	public final void onEvent(List events) {
< 		List eventArray = new ArrayList(events);
195a213,237
>     /**
>      * @param editingDomain
>      */
>     public static void stopListening(
>             TransactionalEditingDomain editingDomain) {
>         DiagramEventBroker diagramEventBroker = getInstance(editingDomain);
>         if (diagramEventBroker != null) {
>             editingDomain.removeResourceSetListener(diagramEventBroker);
>             instanceMap.remove(editingDomain);
>         }
>     }
>     
>     public Command transactionAboutToCommit(ResourceSetChangeEvent event) {
>         Set deletedObjects = getDeletedObjects(event);
>  
>         CompoundCommand cc = new CompoundCommand();
>         for (Iterator i = event.getNotifications().iterator(); i.hasNext();) {
>             final Notification notification = (Notification) i.next();
>             Object eventFeature = notification.getFeature();
> 
>             // ignore touch event if it is not a resolve event,and ignore the mutable feature
>             // events
>             if ((notification.isTouch() && notification.getEventType() != Notification.RESOLVE)||
>                  NotationPackage.eINSTANCE.getView_Mutable().equals(eventFeature)){
>                  continue;
195a271,277
> 				handleElementEvent(notification);
> 			}
> 		}
> 	}
>     
>     private Set getDeletedObjects(ResourceSetChangeEvent event) {
>         HashSet deletedObjects = new HashSet();
196,199d270
< 		// if the events contain "uncreated" objects, remove all events related
< 		// to those
< 		// objects from the event list (except the "uncreate" events themselves)
< 		HashSet deletedObjects = new HashSet();
200,200c278,278
< 		// first collect the "destroyed" objects
---
>         // first collect the "destroyed" objects
201,201c279,279
< 		for (Iterator i = eventArray.iterator(); i.hasNext();) {
---
>         for (Iterator i = event.getNotifications().iterator(); i.hasNext();) {
202,202c280,280
< 			Notification event = (Notification) i.next();
---
>             Notification notification = (Notification) i.next();
202a281,281
>             if (isDestroyEvent(notification))
203,204d280
< 			if (event.getEventType() == EventTypes.UNCREATE
< 				|| event.getEventType() == EventTypes.DESTROY)
205,205c282,282
< 				deletedObjects.add(event.getNotifier());
---
>                 deletedObjects.add(notification.getNotifier());
207a240,257
>             Object notifier = notification.getNotifier();
>             if (notifier instanceof EObject) {
>                 if (deletedObjects.contains(notification.getNotifier()) && !isDestroyEvent(notification))
>                     continue;
>                 Command cmd = handleTransactionAboutToCommitEvent(notification);
>                 if (cmd != null) {
>                     cc.append(cmd);
>                 }
>             }
>         }
>         return cc.isEmpty() ? null : cc;
>     }
> 
> 	public void resourceSetChanged(ResourceSetChangeEvent event) {
>         Set deletedObjects = getDeletedObjects(event);
> 
> 		for (Iterator i = event.getNotifications().iterator(); i.hasNext();) {
> 			final Notification notification = (Notification) i.next();
208,209d239
< 		for (Iterator i = eventArray.iterator(); i.hasNext();) {
< 			Notification event = (Notification) i.next();
210,210c258,258
< 			Object eventFeature = event.getFeature();
---
> 			Object eventFeature = notification.getFeature();
214,214c262,262
< 			if ((event.isTouch() && event.getEventType() != Notification.RESOLVE)||
---
> 			if ((notification.isTouch() && notification.getEventType() != Notification.RESOLVE)||
219,219c267,267
< 			Object notifier = event.getNotifier();
---
> 			Object notifier = notification.getNotifier();
220a269,269
> 				if (deletedObjects.contains(notification.getNotifier())  && !isDestroyEvent(notification))
221,224d268
< 				if (deletedObjects.contains(event.getNotifier())
< 					&& event.getEventType() != EventTypes.UNCREATE
< 					&& event.getEventType() != EventTypes.DESTROY
< 					&& event.getEventType() != EventTypes.UNRESOLVE)
226,226d270
< 				handleElementEvent(event);
227a284,284
>         return deletedObjects;
228a286,297
> 
> 	/**
> 	 * Returns true if this notification is the equivalent of what used to be a
> 	 * destroy event. Assumes the notifier is an <code>EObject</code>.
> 	 * 
> 	 * @param notification
> 	 * @return
> 	 */
> 	private boolean isDestroyEvent(Notification notification) {		
> 		return (notification.getEventType() == Notification.REMOVE || notification
> 			.getEventType() == Notification.REMOVE_MANY)
> 			&& ((EObject) notification.getNotifier()).eContainer() == null;
239a309,309
> 	private void fireNotification(Notification event) {
240,240d308
< 	protected void fireNotification(Notification event) {
241,241c310,310
< 		Collection listenerList = getInterestedNotificationListeners(event);
---
> 		Collection listenerList = getInterestedNotificationListeners(event, false);
254a324,361
> 	private Command fireTransactionAboutToCommit(Notification event) {
> 		Collection listenerList = getInterestedNotificationListeners(event,
> 			true);
> 		if (!listenerList.isEmpty()) {
> 			List listenersSnapShot = new ArrayList(listenerList);
> 			if (!listenerList.isEmpty()) {
> 				CompoundCommand cc = new CompoundCommand();
> 				for (Iterator listenerIT = listenersSnapShot.iterator(); listenerIT
> 					.hasNext();) {
> 					NotificationPreCommitListener listener = (NotificationPreCommitListener) listenerIT
> 						.next();
> 					Command cmd = listener.transactionAboutToCommit(event);
> 					if (cmd != null) {
> 						cc.append(cmd);
> 					}
> 				}
> 				return cc.isEmpty() ? null
> 					: cc;
> 			}
> 		}
> 		return null;
> 	}
> 
> 	/**
> 	 * Add the supplied <tt>listener</tt> to the listener list.
> 	 * 
> 	 * @param target
> 	 *            the traget to listen to
> 	 * @param listener
> 	 *            the listener
> 	 */
> 	public final void addNotificationListener(EObject target,
> 			NotificationPreCommitListener listener) {
> 		if (target != null) {
> 			preListeners.addListener(target, LISTEN_TO_ALL_FEATURES, listener);
> 		}
> 	}
> 
266,266c373,373
< 			listeners.addListener(target, LISTEN_TO_ALL_FEATURES, listener);
---
> 			postListeners.addListener(target, LISTEN_TO_ALL_FEATURES, listener);
282a388,389
> 			EStructuralFeature key, NotificationPreCommitListener listener) {
> 		if (target != null) {
282a406,421
> 			postListeners.addListener(target, key, listener);
> 		}
> 	}
> 
> 	/**
> 	 * remove the supplied <tt>listener</tt> from the listener list.
> 	 * 
> 	 * @param target
> 	 *            the traget to listen to
> 	 * @param listener
> 	 *            the listener
> 	 */
> 	public final void removeNotificationListener(EObject target,
> 			NotificationPreCommitListener listener) {
> 		if (target != null) {
> 			preListeners.removeListener(target, LISTEN_TO_ALL_FEATURES, listener);
283a391,403
> 		}
> 	}	
> 	/**
> 	 * Add the supplied <tt>listener</tt> to the listener list.
> 	 * 
> 	 * @param target
> 	 *            the traget to listen to
> 	 * @param key
> 	 *            the key for the listener
> 	 * @param listener
> 	 *            the listener
> 	 */
> 	public final void addNotificationListener(EObject target,
283,283c390,390
< 			listeners.addListener(target, key, listener);
---
> 			preListeners.addListener(target, key, listener);
298,298c436,436
< 			listeners.removeListener(target, LISTEN_TO_ALL_FEATURES, listener);
---
> 			postListeners.removeListener(target, LISTEN_TO_ALL_FEATURES, listener);
313,313c451,451
< 			NotificationListener listener) {
---
> 			NotificationPreCommitListener listener) {
315,315c453,453
< 			listeners.removeListener(target, key, listener);
---
> 			preListeners.removeListener(target, key, listener);
318a457,472
> 	/**
> 	 * remove the supplied <tt>listener</tt> from the listener list.
> 	 * 
> 	 * @param target
> 	 *            the traget to listen to
> 	 * @param key
> 	 *            the key for the listener
> 	 * @param listener
> 	 *            the listener
> 	 */
> 	public final void removeNotificationListener(EObject target, Object key,
> 			NotificationListener listener) {
> 		if (target != null) {
> 			postListeners.removeListener(target, key, listener);
> 		}
> 	}
320a475,482
> 			for (Iterator iter = instanceMap.keySet().iterator(); iter
> 				.hasNext();) {
> 				TransactionalEditingDomain editingDomain = (TransactionalEditingDomain) iter
> 					.next();
> 				editingDomain
> 					.removeResourceSetListener((DiagramEventBroker) ((WeakReference) instanceMap
> 						.get(editingDomain)).get());
> 			}
321,321d474
< 			stopListening();
326a488,490
> 	private Set getNotificationListeners(Object notifier, boolean preCommit) {
> 		NotifierToKeyToListenersSetMap listeners = preCommit ? preListeners
> 			: postListeners;
327,327d487
< 	protected Set getNotificationListeners(Object notifier) {
330a494,500
> 
> 	/**
> 	 * @param notifier
> 	 * @param key
> 	 * @param preCommit
> 	 * @return
> 	 */
331,331c501,501
< 	protected Set getNotificationListeners(Object notifier, Object key) {
---
> 	private Set getNotificationListeners(Object notifier, Object key, boolean preCommit) {
331a502,502
> 		NotifierToKeyToListenersSetMap listeners = preCommit ? preListeners : postListeners;
349,401d519
< 	/** SLOT_MODIFIED filter. */
< 	public final static MFilter SLOT_MODIFIED = new MFilter.And(
< 		new MFilter.NotifierType(EObject.class, false), new MFilter.And(
< 			new MFilter.EventType(EventTypes.SET), new MFilter.EventType(
< 				EventTypes.UNSET)));
< 
< 	/** ELEMENT_INSERTED_INTO_SLOT filter. */
< 	public final static MFilter ELEMENT_INSERTED_INTO_SLOT = new MFilter.And(
< 		new MFilter.NotifierType(EObject.class, false), new MFilter.Or(
< 			new MFilter.EventType(EventTypes.ADD), new MFilter.EventType(
< 				EventTypes.ADD_MANY)));
< 
< 	/** ELEMENT_REMOVED_FROM_SLOT filter. */
< 	public final static MFilter ELEMENT_REMOVED_FROM_SLOT = new MFilter.And(
< 		new MFilter.NotifierType(EObject.class, false), new MFilter.Or(
< 			new MFilter.EventType(EventTypes.REMOVE), new MFilter.EventType(
< 				EventTypes.REMOVE_MANY)));
< 
< 	/** ELEMENT_CREATED filter. */
< 	public final static MFilter ELEMENT_CREATED = new MFilter.And(
< 		new MFilter.NotifierType(EObject.class, false), new MFilter.EventType(
< 			EventTypes.CREATE));
< 
< 	/** ELEMENT_UNCREATED filter */
< 	public final static MFilter ELEMENT_UNCREATED = new MFilter.And(
< 		new MFilter.NotifierType(EObject.class, false), new MFilter.EventType(
< 			EventTypes.UNCREATE));
< 
< 	/** ELEMENT_DELETED filter. */
< 	public final static MFilter ELEMENT_DELETED = new MFilter.And(
< 		new MFilter.NotifierType(EObject.class, false), new MFilter.EventType(
< 			EventTypes.DESTROY));
< 
< 	/** ELEMENT_UNDELETED filter. */
< 	public final static MFilter ELEMENT_UNDELETED = new MFilter.And(
< 		new MFilter.NotifierType(EObject.class, false), new MFilter.EventType(
< 			EventTypes.UNDESTROY));
< 
< 	/** The DiagramEventBroker singleton */
< 	private static DiagramEventBroker instance;
< 
< 	/**
< 	 * gives access to the <code>DiagramEventBroker</code> singleton
< 	 * 
< 	 * @return the <code>DiagramEventBroker</code> singleton
< 	 */
< 	public static DiagramEventBroker getInstance() {
< 		if (instance == null) {
< 			instance = new DiagramEventBroker();
< 		}
< 		return instance;
< 	}
< 
410,410c528,528
< 	protected Set getInterestedNotificationListeners(Notification event) {
---
> 	private Set getInterestedNotificationListeners(Notification event, boolean preCommit) {
414,414c532,532
< 			.getFeature());
---
> 			.getFeature(), preCommit);
423,423c541,541
< 				listenerSet.addAll(getNotificationListeners(notifier.eContainer()));
---
> 				listenerSet.addAll(getNotificationListeners(notifier.eContainer(), preCommit));
426,426c544,544
< 			addListenersOfNotifier(listenerSet, notifier.eContainer(), event);
---
> 			addListenersOfNotifier(listenerSet, notifier.eContainer(), event, preCommit);
431,431c549,549
< 			addListenersOfNotifier(listenerSet, notifier, event);
---
> 			addListenersOfNotifier(listenerSet, notifier, event, preCommit);
444,444c562,562
< 			Notification event) {
---
> 			Notification event, boolean preCommit) {
447,447c565,565
< 				.getFeature());
---
> 				.getFeature(), preCommit);
467a586,600
> 	private Command handleTransactionAboutToCommitEvent(Notification event) {
> 		EObject element = (EObject) event.getNotifier();
> 		if (element != null) {
> 			return fireTransactionAboutToCommit(event);
> 		}
> 
> 		return null;
> 	}
> 
> 	/**
> 	 * Forwards the event to all interested listeners.
> 	 * 
> 	 * @param event
> 	 *            the event to handle
> 	 */
468a602,602
> 		
468,468c601,601
< 	protected void handleElementEvent(Notification event) {
---
> 	private void handleElementEvent(Notification event) {
469,469d601
< 		MEditingDomain doamin = null;
470,470c603,603
< 		if (!event.isTouch()
---
> 		if (!event.isTouch()) {
471,472d603
< 			&& !(doamin = MEditingDomainGetter.getMEditingDomain(event))
< 				.isUndoNotification(event) && !doamin.isRedoNotification(event)) {
482a614,614
> 
487a620,620
> 
