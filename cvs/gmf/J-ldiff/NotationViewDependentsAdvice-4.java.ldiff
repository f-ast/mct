14a15,18
> import java.util.HashSet;
> import java.util.Iterator;
> import java.util.Map;
> import java.util.Set;
17a22,24
> import org.eclipse.emf.ecore.EStructuralFeature.Setting;
> import org.eclipse.emf.transaction.TransactionalEditingDomain;
> import org.eclipse.emf.transaction.util.TransactionUtil;
20,20c27,27
< import org.eclipse.gmf.runtime.emf.core.util.EMFCoreUtil;
---
> import org.eclipse.gmf.runtime.emf.core.util.CrossReferenceAdapter;
22a30,30
> import org.eclipse.gmf.runtime.emf.type.core.requests.IEditCommandRequest;
39a60,60
> 			DestroyDependentsRequest request) {
39,39c59,59
< 	protected ICommand getBeforeDestroyDependentsCommand(DestroyDependentsRequest request) {
---
> 	protected ICommand getBeforeDestroyDependentsCommand(
40,41d59
< 		EObject destructee = request.getElementToDestroy();
< 		ICommand result = null;
42a48,53
> 	public ICommand getBeforeEditCommand(IEditCommandRequest request) {
> 		if (request instanceof DestroyDependentsRequest) {
> 			return getBeforeDestroyDependentsCommand((DestroyDependentsRequest) request);
> 		}
> 		return null;
> 	}
43,43d47
< 		// handle views referencing a semantic element being destroyed
44a55,57
> 	public ICommand getAfterEditCommand(IEditCommandRequest request) {		
> 		return null;
> 	}
45,47d54
<         Collection semanticReferencers = EMFCoreUtil.getReferencers(
<                 destructee,
<                 new EReference[] {NotationPackage.Literals.VIEW__ELEMENT});
49,51d58
<         result = CompositeCommand.compose(
<         		result,
<         		request.getDestroyDependentsCommand(semanticReferencers));
52a62,65
> 		EObject destructee = request.getElementToDestroy();
> 		CrossReferenceAdapter crossReferenceAdapter = getCrossReferenceAdapter(request, destructee);
> 		ICommand result = getDestroyDependentsCommand(destructee, request,
> 				NotationPackage.Literals.VIEW__ELEMENT, crossReferenceAdapter);
54,54d66
<         
55a68,69
> 			result = CompositeCommand.compose(result, getDestroyDependentsCommand(destructee, request,
> 				NotationPackage.Literals.NODE_ENTRY__KEY, crossReferenceAdapter));
56,63d67
<             Collection nodeEntryKeys = EMFCoreUtil.getReferencers(
<             		destructee,
<             		new EReference[] {NotationPackage.Literals.NODE_ENTRY__KEY});
< 
<             result = CompositeCommand.compose(
<             		result,
<             		request.getDestroyDependentsCommand(nodeEntryKeys));
<         }
66,66d71
<         
69a75,76
> 				if (view.eIsSet(NotationPackage.Literals.VIEW__SOURCE_EDGES)) {
> 					result = CompositeCommand.compose(result, request
70,71d74
<             result = CompositeCommand.compose(
<             		result,
72a78,80
> 				}
> 				if (view.eIsSet(NotationPackage.Literals.VIEW__TARGET_EDGES)) {
> 					result = CompositeCommand.compose(result, request
72,72c77,77
<             		request.getDestroyDependentsCommand(view.getSourceEdges()));
---
> 						.getDestroyDependentsCommand(view.getSourceEdges()));
73,75d77
<         	
<             result = CompositeCommand.compose(
<             		result,
76a82,83
> 				}
> 			}			
76,76c81,81
<             		request.getDestroyDependentsCommand(view.getTargetEdges()));
---
> 						.getDestroyDependentsCommand(view.getTargetEdges()));
78,78d84
<         
80a87,140
> 	
> 	private CrossReferenceAdapter getCrossReferenceAdapter(
> 			DestroyDependentsRequest request, EObject destructee) {
> 		
> 		CrossReferenceAdapter crossReferenceAdapter = null;
> 		Map cacheMaps = (Map) request.getParameter("Cache_Maps");//$NON-NLS-1$ RequestCacheEntries.Cache_Maps
> 		if (cacheMaps != null) {
> 			crossReferenceAdapter = (CrossReferenceAdapter) cacheMaps
> 					.get("CrossRefAdapter");//$NON-NLS-1$ RequestCacheEntries.CrossRefAdapter
> 		}
> 
> 		if (crossReferenceAdapter == null) {
> 			crossReferenceAdapter = CrossReferenceAdapter
> 					.getExistingCrossReferenceAdapter(destructee);
> 			if (crossReferenceAdapter == null) {
> 				TransactionalEditingDomain domain = TransactionUtil
> 						.getEditingDomain(destructee);
> 				if (domain != null) {
> 					crossReferenceAdapter = CrossReferenceAdapter
> 							.getCrossReferenceAdapter(domain.getResourceSet());
> 				}
> 			}
> 		}
> 		return crossReferenceAdapter;
> 	}
> 	
> 	
> 	private ICommand getDestroyDependentsCommand(EObject destructee,
> 			DestroyDependentsRequest request, EReference eRef, CrossReferenceAdapter crossReferenceAdapter) {
> 		
> 		if (crossReferenceAdapter != null) {
> 			Collection revRefs = crossReferenceAdapter
> 				.getNonNavigableInverseReferences(destructee);
> 			if (revRefs.isEmpty() == false) {
> 				Set set = null;
> 				Iterator it = revRefs.iterator();
> 				while (it.hasNext()) {
> 					Setting setting = (Setting) it.next();
> 					if (setting.getEStructuralFeature() == eRef) {
> 						if (set == null) {
> 							set = new HashSet();
> 						}
> 						set.add(setting.getEObject());
> 					}
> 				}
> 
> 				if (set != null) {
> 					return request.getDestroyDependentsCommand(set);
> 				}
> 			}
> 		}
> 
> 		return null;
> 	}
