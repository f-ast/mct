26,26c37,37
< import org.eclipse.core.runtime.Platform;
---
> import org.eclipse.gef.EditPartViewer;
68,68c72,72
< import org.eclipse.gmf.runtime.diagram.ui.internal.editparts.DefaultEditableEditPart;
---
> import org.eclipse.gmf.runtime.diagram.ui.parts.DiagramGraphicalViewer;
71,71c75,75
< import org.eclipse.gmf.runtime.diagram.ui.internal.l10n.DiagramFontRegistry;
---
> import org.eclipse.gmf.runtime.diagram.ui.preferences.IPreferenceConstants;
79a80,80
> import org.eclipse.gmf.runtime.draw2d.ui.figures.FigureUtilities;
98a94,96
> import org.eclipse.jface.preference.IPreferenceStore;
> import org.eclipse.jface.preference.PreferenceConverter;
> import org.eclipse.jface.resource.DeviceResourceException;
99a98,99
> import org.eclipse.jface.resource.JFaceResources;
> import org.eclipse.jface.resource.ResourceManager;
99,99c97,97
< import org.eclipse.swt.widgets.Display;
---
> import org.eclipse.jface.resource.FontDescriptor;
119a126,129
>     /**
>      * Flag to indicate if the edit part is in edit mode
>      */
>     private boolean isEditable = true;
120,121d125
< 	/** Used for handling the editable status of the edit part */
< 	private final IEditableEditPart editableEditPart;
128a137,142
>      * Cache the font data when a font is created so that it can be
>      * disposed later.
>      */
>     private FontData cachedFontData;
>     
>     /**
136,136d149
< 		this.editableEditPart = new DefaultEditableEditPart(this);
145a159,161
>         EObject semanticElement;
>         EObject semanticProxy;
>         if (hasNotationView()) {
146,147d158
< 		EObject semanticProxy = null;
< 		if (hasNotationView())
148,148c162,162
< 			semanticProxy = ((View) getModel()).getElement();
---
>             semanticProxy = ((View) super.getModel()).getElement();
148a163,168
>             if ((semanticProxy==null)||semanticProxy.eIsProxy()) {
>                 semanticElement = null;
>             } else {
>                 semanticElement = semanticProxy;
>             }
>         } else {
149,149d162
< 		else
150a170,170
>             if ((semanticProxy!=null) && semanticProxy.eIsProxy()) {
151,151d169
< 		
152,152c171,171
< 		EObject semanticElement = EMFCoreUtil.resolve(getEditingDomain(), semanticProxy);
---
>                 semanticElement = EMFCoreUtil.resolve(getEditingDomain(),
152a172,176
>                     semanticProxy);
>             } else {
>                 semanticElement = semanticProxy;
>             }
>         }
271a296,306
>     public void removeNotify() {
>         super.removeNotify();
>         
>         if (cachedFontData != null) {
>             getResourceManager().destroyFont(
>                 FontDescriptor.createFrom(cachedFontData));
>             cachedFontData = null;
>         }
> 
>     }
> 
290,290c339,339
< 		Object model = basicGetModel();
---
>         Object model = basicGetModel();     
300a335,336
>             else
>                 return null;
316,316c353,353
< 			if (key.isInstance(semanticObject)) {
---
>             if ((semanticObject!=null) && key.isInstance(semanticObject)) {
326,326c363,363
< 		Object adapter = super.getAdapter(key);
---
>         return super.getAdapter(key);
327,329d363
< 		if (adapter != null)
< 			return adapter;
< 		return Platform.getAdapterManager().getAdapter(this, key);
355a414,415
>         View view;
>         if (hasNotationView() && (view = (View) super.getModel()) != null) {
356,356d413
< 		if (getModel()!=null){
357,357c416,416
< 			View view = ViewUtil.getChildBySemanticHint((View)getModel(),semanticHint);
---
>             return ViewUtil.getChildBySemanticHint(view, semanticHint);
378a390,391
>         View view;
>         if (hasNotationView() && (view = (View) super.getModel()) != null) {
379,379d389
< 		if (getModel()!=null){
380,380c392,392
< 			return ViewUtil.getChildBySemanticHint((View)getModel(),semanticHint);
---
>             view = ViewUtil.getChildBySemanticHint(view,semanticHint);
442,442c478,478
< 					cc.add( ToggleCanonicalModeCommand.getToggleCanonicalModeCommand(tcmd, true));
---
>                     ToggleCanonicalModeCommand tcmd2 = ToggleCanonicalModeCommand.getToggleCanonicalModeCommand(tcmd, true);
442a479,482
>                     if (tcmd2 != null) {
>                         tcmd2.setDomain(getEditingDomain());
>                     }
>                     cc.add( tcmd2 );
586,587d625
< 		EditDomain editDomain = getEditDomain();
< 		if (editDomain != null) {
588,588c626,626
< 			return (IDiagramEditDomain) editDomain;
---
>         return (IDiagramEditDomain) getEditDomain();
589,590d626
< 		}
< 		return null;
613,613c649,649
< 			return ViewUtil.getStructuralFeatureValue((View) getModel(),feature);
---
>             return ViewUtil.getPropertyValue((View) super.getModel(), feature,
613a650,650
>                 feature.getEContainingClass());
624a662,676
>         EObject semanticElement = null;
>         Object basicModel = basicGetModel();
>         if (hasNotationView()) {
>             semanticElement = ((View) basicModel).getElement();
>         } else if (basicModel instanceof EObject) {
>             semanticElement = (EObject) basicModel;
>         }
>         if (semanticElement == null) {
>             return null;
>         }
> 
>         if (!semanticElement.eIsProxy()) {
>             return semanticElement;
>         }
> 
636a689,689
>                                 setResult(EMFCoreUtil.resolve(
637,637c690,690
< 								setResult(EMFCoreUtil.resolve(getEditingDomain(), element));
---
>                                     getEditingDomain(), element));
762,762c815,815
< 		FillStyle style = (FillStyle)getPrimaryView().getStyle(NotationPackage.eINSTANCE.getFillStyle());
---
>         FillStyle style = (FillStyle)getPrimaryView().getStyle(NotationPackage.Literals.FILL_STYLE);
770,770c823,823
< 		FontStyle style = (FontStyle) getPrimaryView().getStyle(NotationPackage.eINSTANCE.getFontStyle());
---
>         FontStyle style = (FontStyle) getPrimaryView().getStyle(NotationPackage.Literals.FONT_STYLE);
782,782c835,835
< 		FontStyle style = (FontStyle)  getPrimaryView().getStyle(NotationPackage.eINSTANCE.getFontStyle());
---
>         FontStyle style = (FontStyle)  getPrimaryView().getStyle(NotationPackage.Literals.FONT_STYLE);
790,790c843,843
< 		LineStyle style = (LineStyle)  getPrimaryView().getStyle(NotationPackage.eINSTANCE.getLineStyle());
---
>         LineStyle style = (LineStyle)  getPrimaryView().getStyle(NotationPackage.Literals.LINE_STYLE);
822,822c875,875
< 		Object[] objects = (Object[]) listenerFilters.get(filterId);
---
>         Object[] objects = (Object[]) listenerFilters.remove(filterId);
832a886,886
>         
833,833d885
< 		listenerFilters.remove(filterId);
855a909,912
>          if (cachedFontData != null && cachedFontData.equals(fontData)) {
>             // the font was previously set and has not changed; do nothing.
>             return;
>         }
856,858d908
<         Font newFont = DiagramFontRegistry.getInstance().getFont(
< 				Display.getDefault(),
<             fontData);
859a914,916
>         try {
>             Font newFont = getResourceManager().createFont(
>                 FontDescriptor.createFrom(fontData));
860,860d913
<         if (!newFont.equals(getFigure().getFont())) {
862a919,930
> 
>             if (cachedFontData != null) {
>                 getResourceManager().destroyFont(
>                     FontDescriptor.createFrom(cachedFontData));
>             }
>             cachedFontData = fontData;
>         } catch (DeviceResourceException e) {
>             Trace.catching(DiagramUIPlugin.getInstance(),
>                 DiagramUIDebugOptions.EXCEPTIONS_CATCHING, getClass(),
>                 "setFont", e); //$NON-NLS-1$
>             Log.error(DiagramUIPlugin.getInstance(),
>                 DiagramUIStatusCodes.IGNORED_EXCEPTION_WARNING, "setFont", e); //$NON-NLS-1$
888a957,957
>         if (hasNotationView() && (feature != null)) {
889,889d956
< 		if (hasNotationView())
890,890c958,958
< 			ViewUtil.setStructuralFeatureValue((View) getModel(), feature, value);
---
>             ViewUtil.setPropertyValue((View) super.getModel(), feature, feature
890a959,960
>                 .getEContainingClass(), value);
>         }
1024a1095,1095
>         EditPartViewer viewer = getViewer();
1028,1028c1099,1099
< 			getViewer().getEditPartRegistry().put(basicGetModel(), this);
---
>             viewer.getEditPartRegistry().put(basicGetModel(), this);
1042,1042c1113,1113
< 		((IDiagramGraphicalViewer) getViewer()).registerEditPartForElement(
---
>         ((IDiagramGraphicalViewer) viewer).registerEditPartForElement(
1048a1120,1120
>         EditPartViewer viewer = getViewer();
1052,1052c1124,1124
< 			Map registry = getViewer().getEditPartRegistry();
---
>             Map registry = viewer.getEditPartRegistry();
1061,1061c1133,1133
< 		((IDiagramGraphicalViewer) getViewer()).unregisterEditPartForElement(
---
>         ((IDiagramGraphicalViewer) viewer).unregisterEditPartForElement(
1113,1113c1185,1185
< 	public final boolean isCanonical() {
---
>     public boolean isCanonical() {
1129a1202,1224
>         if (!isEditModeEnabled()) {
>             return;
>         }
> 
>         List l = getSourceConnections();
>         int size = l.size();
>         for (int i = 0; i < size; i++) {
>             Object obj = l.get(i);
>             if (obj instanceof IEditableEditPart) {
>                 ((IEditableEditPart) obj).disableEditMode();
>             }
>         }
> 
>         List c = getChildren();
>         size = c.size();
>         for (int i = 0; i < size; i++) {
>             Object obj = c.get(i);
>             if (obj instanceof IEditableEditPart) {
>                 ((IEditableEditPart) obj).disableEditMode();
>             }
>         }
> 
>         isEditable = false;
1130,1130d1201
< 		this.editableEditPart.disableEditMode();		
1136a1231,1253
>         if (isEditModeEnabled()) {
>             return;
>         }
> 
>         isEditable = true;
> 
>         List c = getChildren();
>         int size = c.size();
>         for (int i = 0; i < size; i++) {
>             Object obj = c.get(i);
>             if (obj instanceof IEditableEditPart) {
>                 ((IEditableEditPart) obj).enableEditMode();
>             }
>         }
> 
>         List l = getSourceConnections();
>         size = l.size();
>         for (int i = 0; i < size; i++) {
>             Object obj = l.get(i);
>             if (obj instanceof IEditableEditPart) {
>                 ((IEditableEditPart) obj).enableEditMode();
>             }
>         }
1137,1137d1230
< 		this.editableEditPart.enableEditMode();
1147a1264,1264
>         return isEditable;
1148,1149d1263
< 		
< 		return this.editableEditPart.isEditModeEnabled();
1208a1324,1325
>         RootEditPart root = getRoot();
>         if (root instanceof IDiagramPreferenceSupport) {
1209,1209d1323
< 		if (getRoot() instanceof IDiagramPreferenceSupport) {
1210,1210c1326,1326
< 			return ((IDiagramPreferenceSupport) getRoot()).getPreferencesHint();
---
>             return ((IDiagramPreferenceSupport) root).getPreferencesHint();
1241,1241c1357,1357
< 		if (NotationPackage.eINSTANCE.getView_PersistedChildren().equals(event.getFeature())||
---
>         if (NotationPackage.Literals.VIEW__PERSISTED_CHILDREN.equals(event.getFeature())||
1242,1242c1358,1358
< 				NotationPackage.eINSTANCE.getView_TransientChildren().equals(event.getFeature())) {
---
>                 NotationPackage.Literals.VIEW__TRANSIENT_CHILDREN.equals(event.getFeature())) {
1244,1244c1360,1360
< 		}else if (NotationPackage.eINSTANCE.getView_Visible().equals(event.getFeature())) {
---
>         }else if (NotationPackage.Literals.VIEW__VISIBLE.equals(event.getFeature())) {
1252,1252c1368,1368
< 		else if (NotationPackage.eINSTANCE.getView_Element().equals(event.getFeature())) {
---
>         else if (NotationPackage.Literals.VIEW__ELEMENT.equals(event.getFeature())) {
1261,1261c1377,1377
< 	final protected IMapMode getMapMode() {
---
>      protected IMapMode getMapMode() {
1312a1429,1439
>     protected IFigure createFigure() {
>         // TODO Auto-generated method stub
>         return null;
>     }
> 
>     public void setModel(Object model) {
>         // reset the editing domain cache
>         editingDomain = null;
>         super.setModel(model);
>     }
> 
1332a1460,1504
>     
>    public Object getPreferredValue(EStructuralFeature feature) {
>         Object preferenceStore = getDiagramPreferencesHint()
>             .getPreferenceStore();
>         if (preferenceStore instanceof IPreferenceStore) {
>             if (feature == NotationPackage.eINSTANCE.getLineStyle_LineColor()) {
>                 
>                 return FigureUtilities.RGBToInteger(PreferenceConverter
>                     .getColor((IPreferenceStore) preferenceStore,
>                         IPreferenceConstants.PREF_LINE_COLOR));
>                 
>             } else if (feature == NotationPackage.eINSTANCE
>                 .getFontStyle_FontColor()) {
>                 
>                 return FigureUtilities.RGBToInteger(PreferenceConverter
>                     .getColor((IPreferenceStore) preferenceStore,
>                         IPreferenceConstants.PREF_FONT_COLOR));
>                 
>             } else if (feature == NotationPackage.eINSTANCE
>                 .getFillStyle_FillColor()) {
>                 
>                 return FigureUtilities.RGBToInteger(PreferenceConverter
>                     .getColor((IPreferenceStore) preferenceStore,
>                         IPreferenceConstants.PREF_FILL_COLOR));
>                 
>             }
>         }
> 
>         return getStructuralFeatureValue(feature);
>     }    
>     /**
>      * Gets the resource manager to remember the resources allocated for this
>      * graphical viewer. All resources will be disposed when the graphical
>      * viewer is closed if they have not already been disposed.
>      * 
>      * @return the resource manager
>      */
>     protected ResourceManager getResourceManager() {
>         EditPartViewer viewer = getViewer();
>         if (viewer instanceof DiagramGraphicalViewer) {
>             return ((DiagramGraphicalViewer) viewer).getResourceManager();
>         }
>         return JFaceResources.getResources();
>     }    
>     
