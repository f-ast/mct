2,2c2,2
<  * Copyright (c) 2002, 2003 IBM Corporation and others.
---
>  * Copyright (c) 2002, 2006 IBM Corporation and others.
21,22d20
< import org.eclipse.emf.common.notify.Notification;
< import org.eclipse.emf.transaction.TransactionalEditingDomain;
27,29d24
< import org.eclipse.gmf.runtime.diagram.core.listener.DiagramEventBroker;
< import org.eclipse.gmf.runtime.diagram.core.listener.NotificationListener;
< import org.eclipse.gmf.runtime.diagram.ui.editparts.GraphicalEditPart;
36,36d30
< import org.eclipse.gmf.runtime.notation.NotationPackage;
156a151,159
>     /* (non-Javadoc)
>      * @see org.eclipse.gef.editpolicies.SelectionEditPolicy#activate()
>      */
>     public void activate() {
>         super.activate();
>         if (getHost().getParent().getSelected() != EditPart.SELECTED_NONE)
>             setSelectedState();
>     }
> 
161,162d163
< 	private NotificationListener propertyListener;
< 
184,193d184
< 		propertyListener = new NotificationListener() {
< 
< 			public void notifyChanged(Notification notification) {
< 				if (NotationPackage.eINSTANCE.getView_Visible().equals(
< 					notification.getFeature()))
< 					setSelectedState();
< 			}
< 		};
< 		getDiagramEventBroker().addNotificationListener(
< 			getGraphicalEditPart().getNotationView(), propertyListener);
200,201d190
< 		getDiagramEventBroker().removeNotificationListener(
< 			getGraphicalEditPart().getNotationView(), propertyListener);
215,215c204,204
< 		if (((GraphicalEditPart) getGraphicalEditPart())
---
> 		if (getGraphicalEditPart().getTopGraphicEditPart() != null) {
216,216d204
< 			.getTopGraphicEditPart() != null) {
217,217c205,205
< 			topState = ((GraphicalEditPart) getGraphicalEditPart())
---
> 			topState = getGraphicalEditPart().getTopGraphicEditPart().getSelected();
218,218d205
< 				.getTopGraphicEditPart().getSelected();
229a217,217
> 	private IGraphicalEditPart getParentGraphicEditPart() {
230,230d216
< 	private GraphicalEditPart getParentGraphicEditPart() {
231,231c218,218
< 		return (GraphicalEditPart) getGraphicalEditPart().getParent();
---
> 		return (IGraphicalEditPart) getGraphicalEditPart().getParent();
286,293d272
<     private DiagramEventBroker getDiagramEventBroker() {
<         TransactionalEditingDomain theEditingDomain = ((IGraphicalEditPart) getHost())
<             .getEditingDomain();
<         if (theEditingDomain != null) {
<             return DiagramEventBroker.getInstance(theEditingDomain);
<         }
<         return null;
<     }
