2,2c2,2
<  * Copyright (c) 2006 Borland Software Corp.
---
>  * Copyright (c) 2006 Borland Software Corporation
14,15d13
< import java.io.IOException;
< import java.util.ArrayList;
17,17d14
< import java.util.Collections;
22a20,20
> import org.eclipse.draw2d.ColorConstants;
23,26d19
< import org.eclipse.core.runtime.IStatus;
< import org.eclipse.core.runtime.NullProgressMonitor;
< import org.eclipse.core.runtime.Status;
< import org.eclipse.draw2d.LightweightSystem;
27,27c21,21
< import org.eclipse.draw2d.Viewport;
---
> import org.eclipse.draw2d.IFigure;
28,29d21
< import org.eclipse.draw2d.parts.ScrollableThumbnail;
< import org.eclipse.draw2d.parts.Thumbnail;
40a32,32
> import org.eclipse.gef.EditDomain;
41,43d31
< import org.eclipse.gef.KeyHandler;
< import org.eclipse.gef.KeyStroke;
< import org.eclipse.gef.LayerConstants;
44,44c33,33
< import org.eclipse.gef.RootEditPart;
---
> import org.eclipse.gef.EditPart;
44a34,34
> import org.eclipse.gef.GraphicalEditPart;
48,51d38
< import org.eclipse.gef.editparts.FreeformGraphicalRootEditPart;
< import org.eclipse.gef.editparts.RootTreeEditPart;
< import org.eclipse.gef.editparts.ScalableFreeformRootEditPart;
< import org.eclipse.gef.editparts.ScalableRootEditPart;
55,55c45,45
< import org.eclipse.gef.ui.actions.GEFActionConstants;
---
> import org.eclipse.gef.ui.views.palette.PalettePage;
58,58d43
< import org.eclipse.gef.ui.actions.UpdateAction;
60,66d44
< import org.eclipse.gef.ui.parts.ContentOutlinePage;
< import org.eclipse.gef.ui.parts.GraphicalEditorWithFlyoutPalette;
< import org.eclipse.gef.ui.parts.TreeViewer;
< import org.eclipse.gmf.internal.runtime.lite.Activator;
< import org.eclipse.gmf.runtime.lite.edit.parts.tree.DiagramTreeEditPartFactory;
< import org.eclipse.gmf.runtime.lite.properties.PropertySourceProvider;
< import org.eclipse.gmf.runtime.lite.properties.UndoablePropertySheetEntry;
69,69d47
< import org.eclipse.jface.action.Action;
71,78d48
< import org.eclipse.jface.action.IToolBarManager;
< import org.eclipse.jface.viewers.ISelection;
< import org.eclipse.jface.viewers.ISelectionChangedListener;
< import org.eclipse.jface.viewers.StructuredSelection;
< import org.eclipse.swt.SWT;
< import org.eclipse.swt.events.DisposeEvent;
< import org.eclipse.swt.events.DisposeListener;
< import org.eclipse.swt.widgets.Canvas;
80,81d49
< import org.eclipse.swt.widgets.Control;
< import org.eclipse.ui.IActionBars;
83,83d50
< import org.eclipse.ui.IEditorPart;
85,86d51
< import org.eclipse.ui.ISelectionListener;
< import org.eclipse.ui.IWorkbenchPart;
88,89d52
< import org.eclipse.ui.actions.ActionFactory;
< import org.eclipse.ui.part.IPageSite;
90,90c53,53
< import org.eclipse.ui.part.Page;
---
> import org.eclipse.ui.part.EditorPart;
91,91d53
< import org.eclipse.ui.part.PageBook;
94,94d55
< import org.eclipse.ui.views.properties.PropertySheetPage;
96a58,59
>  * This class serves as the base class for the generated diagram editors. 
>  * @author bblajer
97,97d57
<  * Common functionality of all diagram editors generated with the lite generator.
98a61,63
> public abstract class DiagramEditor extends EditorPart implements IDiagramManager {
> 	private DiagramDisplayer myDiagramDisplayer;
> 	private boolean myIsDirty = false;
99,101d60
< public abstract class DiagramEditor extends GraphicalEditorWithFlyoutPalette {
< 	protected static final int ID_OVERVIEW = 0;
< 	protected static final int ID_OUTLINE = 1;
103,127d64
< 	protected class DiagramContentOutlinePage extends Page implements IContentOutlinePage {
< 		private ContentOutlinePage myOutlinePage;
< 		private Canvas myOverview;
< 		private PageBook myPageBook;
< 		private IAction myShowOutlineAction;
< 		private IAction myShowOverviewAction;
< 		private Thumbnail myThumbnail;
< 		private TreeViewer myTreeViewer;
< 		private DisposeListener myDisposeListener;
< 
< 		@Override
< 		public void init(IPageSite pageSite) {
< 			super.init(pageSite);
< 			ActionRegistry registry = getActionRegistry();
< 			IActionBars bars = pageSite.getActionBars();
< 			String id = ActionFactory.UNDO.getId();
< 			bars.setGlobalActionHandler(id, registry.getAction(id));
< 			id = ActionFactory.REDO.getId();
< 			bars.setGlobalActionHandler(id, registry.getAction(id));
< 			id = ActionFactory.DELETE.getId();
< 			bars.setGlobalActionHandler(id, registry.getAction(id));
< 			bars.updateActionBars();
< 			
< 			// Toolbar refresh to solve linux defect RATLC525198
< 			bars.getToolBarManager().markDirty();
128a69,69
> 	};
129a71,72
> 	protected void save(IProgressMonitor monitor) throws CoreException {
> 		myDiagramDisplayer.save(monitor);
130,133d70
< 		public void addSelectionChangedListener(ISelectionChangedListener listener) {
< 			if (myOutlinePage != null) {
< 				myOutlinePage.addSelectionChangedListener(listener);
< 			}
135a75,76
> 	protected final TransactionalEditingDomain getEditingDomain() {
> 		return myDiagramDisplayer.getEditingDomain();
136,139d74
< 		public void removeSelectionChangedListener(ISelectionChangedListener listener) {
< 			if (myOutlinePage != null) {
< 				myOutlinePage.removeSelectionChangedListener(listener);
< 			}
141a79,80
> 	protected final EditDomain getEditDomain() {
> 		return myDiagramDisplayer.getEditDomain();
142,146d78
< 		public ISelection getSelection() {
< 			if (myOutlinePage != null) {
< 				return myOutlinePage.getSelection();
< 			}
< 			return StructuredSelection.EMPTY;
148a83,84
> 	protected final CommandStack getCommandStack() {
> 		return getEditDomain().getCommandStack();
149,152d82
< 		public void setSelection(ISelection selection) {
< 			if (myOutlinePage != null) {
< 				myOutlinePage.setSelection(selection);
< 			}
154a87,88
> 	protected final ZoomManager getZoomManager() {
> 		return myDiagramDisplayer.getZoomManager();
155,168d86
< 		@Override
< 		public void createControl(Composite parent) {
< 			myPageBook = new PageBook(parent, SWT.NONE);
< 			myTreeViewer = new TreeViewer();
< 			myTreeViewer.setRootEditPart(new RootTreeEditPart());
< 			myTreeViewer.setEditDomain(getEditDomain());
< 			myTreeViewer.setEditPartFactory(new DiagramTreeEditPartFactory(getGraphicalViewer()));
< 			configureTreeViewer(myTreeViewer);
< 			myOutlinePage = new ContentOutlinePage(myTreeViewer);
< 			myOutlinePage.createControl(myPageBook);
< 			myTreeViewer.setContents(getGraphicalViewer().getContents().getModel());
< 			hookOutlineViewer(myTreeViewer);
< 			configureOutlinePage();
< 			showPage(getDefaultOutlineViewMode());
170a91,92
> 	protected final ActionRegistry getActionRegistry() {
> 		return myDiagramDisplayer.getActionRegistry();
171,172d90
< 		protected void hookOutlineViewer(TreeViewer viewer) {
< 			getSelectionSynchronizer().addViewer(viewer);
174a95,96
> 	protected final GraphicalViewer getGraphicalViewer() {
> 		return myDiagramDisplayer.getGraphicalViewer();
175,176d94
< 		protected void unhookOutlineViewer(TreeViewer viewer) {
< 			getSelectionSynchronizer().removeViewer(viewer);
178a99,100
> 	protected IPropertySheetPage getPropertySheetPage() {
> 		return myDiagramDisplayer.getPropertySheetPage();
179,227d98
< 		protected void configureOutlinePage() {
< 			IToolBarManager tbm = this.getSite().getActionBars().getToolBarManager();
< 			myShowOutlineAction = new Action() {
< 				public void run() {
< 					showPage(ID_OUTLINE);
< 				}
< 			};
< 			myShowOutlineAction.setImageDescriptor(Activator.getImageDescriptor("icons/outline.gif"));	//$NON-NLS-1$
< 			myShowOutlineAction.setToolTipText("Show Outline");
< 			tbm.add(myShowOutlineAction);
< 			myShowOverviewAction = new Action() {
< 				public void run() {
< 					showPage(ID_OVERVIEW);
< 				}
< 			};
< 			myShowOverviewAction.setImageDescriptor(Activator.getImageDescriptor("icons/overview.gif"));	//$NON-NLS-1$
< 			myShowOverviewAction.setToolTipText("Show Overview");
< 			tbm.add(myShowOverviewAction);
< 		}
< 
< 		protected void configureTreeViewer(TreeViewer treeViewer) {
< 			KeyHandler keyHandler = new KeyHandler();
< 			keyHandler.put(KeyStroke.getPressed(SWT.DEL, 127, 0),
< 					getActionRegistry().getAction(ActionFactory.DELETE.getId()));
< 			keyHandler.put(KeyStroke.getPressed(SWT.F2, 0), getActionRegistry()
< 					.getAction(GEFActionConstants.DIRECT_EDIT));
< 			treeViewer.setKeyHandler(keyHandler);
< 		}
< 
< 		protected void showPage(int pageId) {
< 			switch (pageId) {
< 			case ID_OUTLINE:
< 				myShowOutlineAction.setChecked(true);
< 				myShowOverviewAction.setChecked(false);
< 				myPageBook.showPage(myOutlinePage.getControl());
< 				if (myThumbnail != null) {
< 					myThumbnail.setVisible(false);
< 				}
< 				break;
< 			case ID_OVERVIEW:
< 				myShowOutlineAction.setChecked(false);
< 				myShowOverviewAction.setChecked(true);
< 				if (myOverview == null || myOverview.isDisposed()) {
< 					initializeOverview();
< 				}
< 				myPageBook.showPage(myOverview);
< 				if (myThumbnail != null) {
< 					myThumbnail.setVisible(true);
< 				}
228a102,104
> 
> 	protected IContentOutlinePage getOutlinePage() {
> 		return new DiagramContentOutlinePage(myDiagramDisplayer, getDefaultOutlineViewMode());
230a107,108
> 	protected IDiagramLayouter getDiagramLayouter() {
> 		return new DefaultDiagramLayouter();
231,242d106
< 		protected void initializeOverview() {
< 			myOverview = new Canvas(myPageBook, SWT.NONE);
< 			LightweightSystem lws = new LightweightSystem(myOverview);
< 			FreeformGraphicalRootEditPart root = (FreeformGraphicalRootEditPart) getGraphicalViewer().getRootEditPart();
< 			myThumbnail = new ScrollableThumbnail((Viewport) root.getFigure());
< 			myThumbnail.setSource(root.getLayer(LayerConstants.SCALABLE_LAYERS));
< 			lws.setContents(myThumbnail);
< 			myDisposeListener = new DisposeListener() {
< 				public void widgetDisposed(DisposeEvent e) {
< 					if (myThumbnail != null) {
< 						myThumbnail.deactivate();
< 						myThumbnail = null;
243a110,117
> 
> 	/**
> 	 * Returns the initial display mode for the outline page to be shown. Possible values are <code>DiagramContentOutlinePage.ID_OUTLINE</code> and 
> 	 * <code>DiagramContentOutlinePage.ID_OVERVIEW</code>.
> 	 * By default, the outline page starts in the overview mode. Subclasses may reimplement.
> 	 */
> 	protected int getDefaultOutlineViewMode() {
> 		return DiagramContentOutlinePage.ID_OVERVIEW;
244a119,123
> 
> 	@Override
> 	public boolean isSaveAsAllowed() {
> 		// TODO: should be allowed.
> 		return false;
245,246d118
< 			};
< 			getGraphicalControl().addDisposeListener(myDisposeListener);
249a127,128
> 	public void doSaveAs() {
> 		// TODO: Implement.
250,251d126
< 		public Control getControl() {
< 			return myPageBook;
255,257d131
< 		public void setFocus() {
< 			if (myOutlinePage != null) {
< 				myOutlinePage.setFocus();
258a138,140
> 		myDiagramDisplayer = new DiagramDisplayer(this, createEditDomain(), editingDomain);
> 		getCommandStack().addCommandStackListener(commandStackListener);
> 		setInput(input);
262a145,148
> 		if (myDiagramDisplayer != null) {
> 			getCommandStack().removeCommandStackListener(commandStackListener);
> 			myDiagramDisplayer.dispose();
> 			myDiagramDisplayer = null;
263,269d144
< 			if (myOutlinePage != null) {
< 				myOutlinePage.dispose();
< 			}
< 			unhookOutlineViewer(myTreeViewer);
< 			if (myThumbnail != null) {
< 				myThumbnail.deactivate();
< 				myThumbnail = null;
271,274d149
< 			if (myDisposeListener != null) {
< 				getGraphicalControl().removeDisposeListener(myDisposeListener);
< 			}
< 			myOverview = null;
277,287d151
< 	}
< 
< 	private static class UpdatableActionGroup {
< 		public void addAction(UpdateAction action) {
< 			assert action != null;
< 			myActions.add(action);
< 		}
< 
< 		public void removeAction(UpdateAction action) {
< 			myActions.remove(action);
< 		}
289,292d152
< 		public void update() {
< 			for (Iterator it = myActions.iterator(); it.hasNext();) {
< 				UpdateAction next = (UpdateAction) it.next();
< 				next.update();
293a176,176
> 		return super.getAdapter(type);
295a179,182
> 	private void setDirty(boolean isDirty) {
> 		if (isDirty != myIsDirty) {
> 			myIsDirty = isDirty;
> 			firePropertyChange(PROP_DIRTY);
296,296d178
< 		private ArrayList myActions = new ArrayList();
298,308d64
< 
< 	private TransactionalEditingDomain editingDomain;
< 
< 	private boolean isDirty = false;
< 
< 	private PaletteRoot paletteRoot;
< 
< 	private PropertySheetPage undoablePropertySheetPage;
< 
< 	private UpdatableActionGroup stackActions = new UpdatableActionGroup();
< 
309,309c65,65
< 	private CommandStackListener commandStackListener = new CommandStackListener() {
---
> 	private CommandStackListener commandStackListener = new CommandStackListener() {
310,310c66,66
< 		public void commandStackChanged(EventObject event) {
---
> 		public void commandStackChanged(EventObject event) {
311,311d66
< 			stackActions.update();
312,312c67,67
< 			setDirty(((CommandStack) event.getSource()).isDirty());
---
> 			setDirty(((CommandStack) event.getSource()).isDirty());
314,316d184
< 	};
< 
< 	private UpdatableActionGroup editPartActions = new UpdatableActionGroup();
317a186,188
> 	@Override
> 	public boolean isDirty() {
> 		return myIsDirty;
318,328d185
< 	private ISelectionListener selectionListener = new ISelectionListener() {
< 		public void selectionChanged(IWorkbenchPart part, ISelection selection) {
< 			editPartActions.update();
< 		}
< 	};
< 
< 	private UpdatableActionGroup editorActions = new UpdatableActionGroup();
< 
< 	protected void firePropertyChange(int propertyId) {
< 		super.firePropertyChange(propertyId);
< 		editorActions.update();
339,339d198
< 		getActionRegistry().registerAction(action);
351a212,212
> 		myDiagramDisplayer.addEditorAction(action);
352,352d198
< 		getActionRegistry().registerAction(action);
353,353c199,199
< 		editorActions.addAction(action);
---
> 		myDiagramDisplayer.addAction(action);
366a226,226
> 		myDiagramDisplayer.addEditPartAction(action);
367,368d225
< 		getActionRegistry().registerAction(action);
< 		editPartActions.addAction(action);
381a240,240
> 		myDiagramDisplayer.addStackAction(action);
382,383d239
< 		getActionRegistry().registerAction(action);
< 		stackActions.addAction(action);
386,386c132,132
< 	public void init(IEditorSite site, IEditorInput input) throws PartInitException {
---
> 	public void init(IEditorSite site, IEditorInput input) throws PartInitException {
387a134,136
> 		TransactionalEditingDomain editingDomain = getEditingDomain(input);
> 		if (editingDomain == null) {
> 			editingDomain = createEditingDomain();
387,387c133,133
< 		setSite(site);
---
> 		setSite(site);
423a321,321
> 		return domain;
424,431d320
< 		setEditDomain(domain);
< 
< 		// add CommandStackListener
< 		getCommandStack().addCommandStackListener(getStackActionsListener());
< 
< 		// add selection change listener
< 		getSite().getWorkbenchWindow().getSelectionService().addSelectionListener(getSelectionListener());
< 		setInput(input);
433a324,324
> 	public abstract void initializeGraphicalViewer();
434,443d323
< 	public void dispose() {
< 		// remove CommandStackListener
< 		getCommandStack().removeCommandStackListener(getStackActionsListener());
< 
< 		// remove selection listener
< 		getSite().getWorkbenchWindow().getSelectionService().removeSelectionListener(getSelectionListener());
< 
< 		// dispose the ActionRegistry (will dispose all actions)
< 		getActionRegistry().dispose();
< 	}
444a326,326
> 	public abstract AdapterFactory getDomainAdapterFactory();
445,464d325
< 	protected void save(IProgressMonitor progressMonitor) throws CoreException {
< 		if (progressMonitor == null) {
< 			progressMonitor = new NullProgressMonitor();
< 		}
< 		progressMonitor.beginTask("Saving", getEditingDomain().getResourceSet().getResources().size());
< 		try {
< 			for(Iterator it = getEditingDomain().getResourceSet().getResources().iterator(); it.hasNext(); ) {
< 				Resource next = (Resource)it.next();
< 				if (next.isLoaded() && (next.isModified() || !next.isTrackingModification())) {
< 					next.save(Collections.EMPTY_MAP);
< 				}
< 				progressMonitor.worked(1);
< 			}
< 		} catch (IOException e) {
< 			IStatus status = new Status(IStatus.ERROR, Activator.getDefault().getBundle().getSymbolicName(), 0, "Error writing file.", e);
< 			throw new CoreException(status);
< 		} finally {
< 			progressMonitor.done();
< 		}
< 	}
465a153,153
> 	@Override
465a328,328
> 	public abstract boolean isFlyoutPalette();
466,474d152
< 	public boolean isSaveAsAllowed() {
< 		// TODO: should be allowed.
< 		return false;
< 	}
< 
< 	public void doSaveAs() {
< 		// TODO: Implement.
< 	}
< 
475,475c154,154
< 	public Object getAdapter(Class type) {
---
> 	public Object getAdapter(Class type) {
476,476c155,155
< 		if (type == IPropertySheetPage.class) {
---
> 		if (type == IPropertySheetPage.class) {
477,477c156,156
< 			return getPropertySheetPage();
---
> 			return getPropertySheetPage();
478,478c157,157
< 		} else if (type == IContentOutlinePage.class) {
---
> 		} else if (type == IContentOutlinePage.class) {
479,479c158,158
< 			return getOutlinePage();
---
> 			return getOutlinePage();
480,480c159,159
< 		} else if (type == ZoomManager.class) {
---
> 		} else if (type == ZoomManager.class) {
481,481c160,160
< 			return getZoomManager();
---
> 			return getZoomManager();
482,482c161,161
< 		} else if (type == IDiagramLayouter.class) {
---
> 		} else if (type == IDiagramLayouter.class) {
483a163,165
> 		} else if (type == PalettePage.class) {
> 			return myDiagramDisplayer.getPalettePage();
> 		} else if (type == GraphicalViewer.class) {
483,483c162,162
< 			return getDiagramLayouter();
---
> 			return getDiagramLayouter();
484,488d162
< 		}
< 		return super.getAdapter(type);
< 	}
< 
< 	protected IDiagramLayouter getDiagramLayouter() {
489,489c166,166
< 		return new DefaultDiagramLayouter();
---
> 			return getGraphicalViewer();
489a167,174
> 		} else if (type == CommandStack.class) {
> 			return getCommandStack();
> 		} else if (type == ActionRegistry.class) {
> 			return getActionRegistry();
> 		} else if (type == EditPart.class && getGraphicalViewer() != null) {
> 			return getGraphicalViewer().getRootEditPart();
> 		} else if (type == IFigure.class && getGraphicalViewer() != null) {
> 			return ((GraphicalEditPart)getGraphicalViewer().getRootEditPart()).getFigure();
490,490d166
< 	}
491a243,246
> 	@Override
> 	public void createPartControl(Composite parent) {
> 		myDiagramDisplayer.createViewer(parent);
> 		createActions();
491a330,330
> 	protected abstract void createActions();
492,493d242
< 	protected ZoomManager getZoomManager() {
< 		return getZoomManager(getGraphicalViewer());
494,494c247,247
< 	}
---
> 	}
495a249,251
> 	@Override
> 	public void setFocus() {
> 		myDiagramDisplayer.setFocus();
495,495c248,248
< 
---
> 
496,505d248
< 	private ZoomManager getZoomManager(GraphicalViewer viewer) {
< 		// get zoom manager from root edit part
< 		RootEditPart rootEditPart = viewer.getRootEditPart();
< 		ZoomManager zoomManager = null;
< 		if (rootEditPart instanceof ScalableFreeformRootEditPart) {
< 			zoomManager = ((ScalableFreeformRootEditPart) rootEditPart).getZoomManager();
< 		} else if (rootEditPart instanceof ScalableRootEditPart) {
< 			zoomManager = ((ScalableRootEditPart) rootEditPart).getZoomManager();
< 		}
< 		return zoomManager;
506,506c252,252
< 	}
---
> 	}
507a254,260
> 	/**
> 	 * Returns the editing domain instance to be used for the specified input. If this method returns <code>null</code>, 
> 	 * a {@link #createEditDomain() default instance} will be created and used.
> 	 * By default, return <code>null</code>. Subclasses may reimplement.
> 	 */
> 	protected TransactionalEditingDomain getEditingDomain(IEditorInput editorInput) {
> 		return null;
507,507c253,253
< 
---
> 
508,513d253
< 	protected PaletteRoot getPaletteRoot() {
< 		if (paletteRoot == null) {
< 			paletteRoot = new PaletteRoot();
< 			configurePalette(paletteRoot);
< 		}
< 		return paletteRoot;
514,514c261,261
< 	}
---
> 	}
515,515c262,262
< 
---
> 
516,525d262
< 	protected abstract void configurePalette(PaletteRoot paletteRoot);
< 
< 	protected CommandStackListener getStackActionsListener() {
< 		return commandStackListener;
< 	}
< 
< 	protected IContentOutlinePage getOutlinePage() {
< 		return new DiagramContentOutlinePage();
< 	}
< 
526a264,265
> 	 * Returns the editing domain instance to be used for the diagram if none may be {@link #getEditingDomain(IEditorInput) inferred} from the input.
> 	 * Subclasses may extend or reimplement.
526,526c263,263
< 	/**
---
> 	/**
527,528d263
< 	 * Returns the initial display mode for the outline page to be shown. Possible values are <code>ID_OUTLINE</code> and <code>ID_OVERVIEW</code>.
< 	 * By default, the outline page starts in the overview mode. Subclasses may reimplement.
529,529c266,266
< 	 */
---
> 	 */
529a267,272
> 	protected TransactionalEditingDomain createEditingDomain() {
> 		TransactionalEditingDomain editingDomain = WorkspaceEditingDomainFactory.INSTANCE.createEditingDomain();
> 		editingDomain.getResourceSet().eAdapters().add(new AdapterFactoryEditingDomain.EditingDomainProvider(editingDomain));
> 		editingDomain.getResourceSet().eAdapters().add(new ForceTrackingModificationAdapter());
> 		return editingDomain;
> 	}
530,532d266
<     protected int getDefaultOutlineViewMode() {
<         return ID_OVERVIEW;
<     }
533,533c273,273
< 
---
> 
533a274,276
> 	public void configureGraphicalViewer() {
> 		getGraphicalViewer().getControl().setBackground(ColorConstants.listBackground);
> 	}
534,534c277,277
< 
---
> 
534a278,278
> 	public abstract void configurePalette(PaletteRoot paletteRoot);
535,541d277
< 	protected PropertySheetPage getPropertySheetPage() {
< 		if (undoablePropertySheetPage == null) {
< 			undoablePropertySheetPage = new PropertySheetPage();
< 			UndoablePropertySheetEntry rootEntry = new UndoablePropertySheetEntry(getCommandStack());
< 			rootEntry.setPropertySourceProvider(new PropertySourceProvider(getDomainAdapterFactory()));
< 			undoablePropertySheetPage.setRootEntry(rootEntry);
< 		}
542,542c279,279
< 
---
> 
542a280,283
> 	/**
> 	 * Creates edit domain that will be used for the editor. 
> 	 * Subclasses may extend.
> 	 */
543,560d279
< 		return undoablePropertySheetPage;
< 	}
< 
< 	private ISelectionListener getSelectionListener() {
< 		return selectionListener;
< 	}
< 
< 	public boolean isDirty() {
< 		return isDirty;
< 	}
< 
< 	private void setDirty(boolean dirty) {
< 		if (isDirty != dirty) {
< 			isDirty = dirty;
< 			firePropertyChange(IEditorPart.PROP_DIRTY);
< 		}
< 	}
< 
561,561c284,284
< 	protected TransactionalEditingDomain getEditingDomain() {
---
> 	protected EditDomain createEditDomain() {
562,581d284
< 		if (editingDomain == null) {
< 			editingDomain = WorkspaceEditingDomainFactory.INSTANCE.createEditingDomain();
< 			//editingDomain.setAdapterFactory(getDomainAdapterFactory());
< 			editingDomain.getResourceSet().eAdapters().add(new AdapterFactoryEditingDomain.EditingDomainProvider(editingDomain));
< 			editingDomain.getResourceSet().eAdapters().add(new ForceTrackingModificationAdapter());
< 		}
< 		return editingDomain;
< 	}
< 
< 	protected abstract AdapterFactory getDomainAdapterFactory();
< 
< 	public void setFocus() {
< 		getGraphicalViewer().getControl().setFocus();
< 	}
< 
< 	public final void createPartControl(Composite parent) {
< 		super.createPartControl(parent);
< 		// initialize actions
< 		createActions();
< 	}
