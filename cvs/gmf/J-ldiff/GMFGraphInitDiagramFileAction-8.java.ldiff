14,14d42
< 
15,15c43,43
< import org.eclipse.emf.common.util.URI;
---
> 	private org.eclipse.emf.common.util.URI domainModelURI;
17,17d14
< 
19,19d15
< 
22,22d17
< 
24,24d18
< 
26,26d19
< 
28,28d20
< 
30,30d25
< 
31,31c26,26
< import org.eclipse.jface.dialogs.IDialogSettings;
---
> import org.eclipse.swt.widgets.Shell;
33,33d22
< 
36,37d24
< import org.eclipse.jface.viewers.StructuredSelection;
< 
39,40d25
< import org.eclipse.jface.wizard.WizardDialog;
< 
52,52c38,38
< 	private IWorkbenchPart myPart;
---
> 	private IWorkbenchPart targetPart;
57,62d42
< 	private IFile mySelectedModelFile;
< 
< 	/**
< 	 * @generated
< 	 */
< 	private IStructuredSelection mySelection;
68,68c49,49
< 		myPart = targetPart;
---
> 		this.targetPart = targetPart;
74a56,56
> 		domainModelURI = null;
75,76d55
< 		mySelectedModelFile = null;
< 		mySelection = StructuredSelection.EMPTY;
80a61,62
> 		IFile file = (IFile) ((IStructuredSelection) selection).getFirstElement();
> 		domainModelURI = org.eclipse.emf.common.util.URI.createPlatformResourceURI(file.getFullPath().toString(), true);
81,82d60
< 		mySelection = (IStructuredSelection) selection;
< 		mySelectedModelFile = (IFile) ((IStructuredSelection) selection).getFirstElement();
88a69,75
> 	private Shell getShell() {
> 		return targetPart.getSite().getShell();
> 	}
> 
> 	/**
> 	 * @generated
> 	 */
94,94c81,81
< 			Resource resource = resourceSet.getResource(URI.createPlatformResourceURI(mySelectedModelFile.getFullPath().toString(), true), true);
---
> 			Resource resource = resourceSet.getResource(domainModelURI, true);
97,97c84,84
< 			GMFGraphDiagramEditorPlugin.getInstance().logError("Unable to load resource: " + mySelectedModelFile.getFullPath().toString(), ex); //$NON-NLS-1$
---
> 			GMFGraphDiagramEditorPlugin.getInstance().logError("Unable to load resource: " + domainModelURI, ex);
100,100c87,87
< 			MessageDialog.openError(myPart.getSite().getShell(), "Error", "Model file loading failed");
---
> 			MessageDialog.openError(getShell(), "Error", "Model file loading failed");
102a90,90
> 		Wizard wizard = new GMFGraphNewDiagramFileWizard(domainModelURI, diagramRoot, editingDomain);
103,110d89
< 		Wizard wizard = new GMFGraphNewDiagramFileWizard(mySelectedModelFile, myPart.getSite().getPage(), mySelection, diagramRoot, editingDomain);
< 		IDialogSettings pluginDialogSettings = GMFGraphDiagramEditorPlugin.getInstance().getDialogSettings();
< 		IDialogSettings initDiagramFileSettings = pluginDialogSettings.getSection("InisDiagramFile"); //$NON-NLS-1$
< 		if (initDiagramFileSettings == null) {
< 			initDiagramFileSettings = pluginDialogSettings.addNewSection("InisDiagramFile"); //$NON-NLS-1$
< 		}
< 		wizard.setDialogSettings(initDiagramFileSettings);
< 		wizard.setForcePreviousAndNextButtons(false);
111a92,92
> 		GMFGraphDiagramEditorUtil.runWizard(getShell(), wizard, "InitDiagramFile"); //$NON-NLS-1$
112,116d91
< 
< 		WizardDialog dialog = new WizardDialog(myPart.getSite().getShell(), wizard);
< 		dialog.create();
< 		dialog.getShell().setSize(Math.max(500, dialog.getShell().getSize().x), 500);
< 		dialog.open();
118,118d93
< 
