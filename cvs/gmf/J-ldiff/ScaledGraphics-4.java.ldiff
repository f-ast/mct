34,34c25,25
< import org.eclipse.gmf.runtime.draw2d.ui.internal.l10n.Draw2dResourceManager;
---
> import org.eclipse.gmf.runtime.draw2d.ui.internal.l10n.Draw2dResourceManager;
35,35d25
< 
44a44,44
>  * See also bugzilla #111454
46a47,49
> /**
>  * A Graphics object able to scale all operations based on the current scale factor.
>  */
48,48d50
< 	extends Graphics {
53,53c91,91
< 		private double zoom;
---
> 	private double zoom; 
62,62c96,96
< 		protected State() {
---
> 	protected State() {/* empty constructor */}
63,64d96
< 			// Empty block
< 		}
101a51,52
> 	extends Graphics
> {
102,127d50
< 	static class FontKey {
< 		Font font;
< 		int height;
< 		
< 		/**
< 		 * Default constructor
< 		 */
< 		protected FontKey() {
< 			// Empty block
< 		}
< 		
< 		/**
< 		 * Constructor
< 		 * 
< 		 * @param font the <code>Font</code> to be stored in the key
< 		 * @param height the height of the font
< 		 */
< 		protected FontKey(Font font, int height) {
< 			this.font = font;
< 			this.height = height;
< 		}
< 		
< 		public boolean equals(Object obj) {
< 			return (((FontKey)obj).font.equals(font) 
< 					&& ((FontKey)obj).height == height);
< 		}
128,128c53,53
< 
---
> 
128a54,57
> private static class FontHeightCache {
> 	Font font;
> 	int height;
> }
129,131d53
< 		public int hashCode() {
< 			return font.hashCode() ^ height;
< 		}
132a59,65
> static class FontKey {
> 	Font font;
> 	int height;
> 	protected FontKey() {/* empty constructor */ }
> 	protected FontKey(Font font, int height) {
> 		this.font = font;
> 		this.height = height;
132,132c58,58
< 
---
> 
133,142d58
< 		/**
< 		 * Sets the values that the key utilizes to calculate the hash value.
< 		 * 
< 		 * @param font the <code>Font</code> to be stored in the key
< 		 * @param height the height of the font
< 		 */
< 		protected void setValues(Font font, int height) {
< 			this.font = font;
< 			this.height = height;
< 		}
143a67,82
> 	
> 	public boolean equals(Object obj) {
> 		return (((FontKey)obj).font.equals(font) 
> 				&& ((FontKey)obj).height == height);
> 	}
> 
> 	public int hashCode() {
> 		return font.hashCode() ^ height;
> 	}
> 
> 	protected void setValues(Font font, int height) {
> 		this.font = font;
> 		this.height = height;
> 	}
> }
> 
143,143c66,66
< 	}
---
> 	}
145,147d136
< 	private static class FontHeightCache {
< 		Font font;
< 		int height;
149a142,144
> private boolean allowText = true;
> //private static final Point PT = new Point();
> //private Map fontCache = new HashMap();
149a134,134
> private static int[][] intArrayCache = new int[8][];
150,150c135,135
< 	private static final Rectangle TEMP = new Rectangle();
---
> private final Rectangle tempRECT = new Rectangle();
152,152d149
< 
153,153c150,150
< 	private FontHeightCache localCache = new FontHeightCache();
---
> private FontHeightCache localCache = new FontHeightCache();
154,154d150
< 	private FontHeightCache targetCache = new FontHeightCache();
158,159d156
< 	private double fractionalX;
< 	private double fractionalY;
160,160c157,157
< 	double zoom = 1.0;
---
> double zoom = 1.0;
162a155,155
> private FontHeightCache targetCache = new FontHeightCache();
163,163c146,146
< 	private FontKey fontKey = new FontKey();
---
> private FontKey fontKey = new FontKey();
164a148,148
> private double fractionalY;
164,164c147,147
< 	private boolean allowText = true;
---
> private double fractionalX;
165,165d147
< 	private static int[][] intArrayCache = new int[8][];
166a137,137
> static {
167,167d136
< 	static {
168,168c138,138
< 		for (int i = 0; i < intArrayCache.length; i++)
---
> 	for (int i = 0; i < intArrayCache.length; i++)
169,169c139,139
< 			intArrayCache[i] = new int[i + 1];
---
> 		intArrayCache[i] = new int[i + 1];
170,170d139
< 	}
204a310,316
> /** @see Graphics#fillArc(int, int, int, int, int, int) */
> public void fillArc(int x, int y, int w, int h, int offset, int sweep) {
> 	Rectangle z = zoomFillRect(x, y, w, h);
> 	if (z.isEmpty() || sweep == 0)
> 		return;
> 	graphics.fillArc(z, offset, sweep);
> }
205,211d309
< 	/** @see Graphics#fillArc(int, int, int, int, int, int) */
< 	public void fillArc(int x, int y, int w, int h, int offset, int sweep) {
< 		Rectangle z = zoomFillRect(x, y, w, h);
< 		if (z.isEmpty() || sweep == 0)
< 			return;
< 		graphics.fillArc(z, offset, sweep);
< 	}
212a318,321
> /** @see Graphics#fillGradient(int, int, int, int, boolean) */
> public void fillGradient(int x, int y, int w, int h, boolean vertical) {
> 	graphics.fillGradient(zoomFillRect(x, y, w, h), vertical);
> }
212,212c317,317
< 
---
> 
213,216d317
< 	/** @see Graphics#fillGradient(int, int, int, int, boolean) */
< 	public void fillGradient(int x, int y, int w, int h, boolean vertical) {
< 		graphics.fillGradient(zoomFillRect(x, y, w, h), vertical);
< 	}
217,217c322,322
< 
---
> 
217a323,357
> /** @see Graphics#fillOval(int, int, int, int) */
> public void fillOval(int x, int y, int w, int h) {
> 	graphics.fillOval(zoomFillRect(x, y, w, h));
> }
> 
> /**
>  * @see Graphics#fillPolygon(int[])
>  */
> public void fillPolygon(int[] points) {
> 	graphics.fillPolygon(zoomPointList(points));
> }
> 
> /** @see Graphics#fillPolygon(PointList) */
> public void fillPolygon(PointList points) {
> 	graphics.fillPolygon(zoomPointList(points.toIntArray()));
> }
> 
> /** @see Graphics#fillRectangle(int, int, int, int) */
> public void fillRectangle(int x, int y, int w, int h) {
> 	graphics.fillRectangle(zoomFillRect(x, y, w, h));
> }
> 
> /** @see Graphics#fillRoundRectangle(Rectangle, int, int) */
> public void fillRoundRectangle(Rectangle r, int arcWidth, int arcHeight) {
> 	graphics.fillRoundRectangle(zoomFillRect(r.x, r.y, r.width, r.height),
> 		(int)(arcWidth * zoom),
> 		(int)(arcHeight * zoom));
> }
> 
> /** @see Graphics#fillString(String, int, int) */
> public void fillString(String s, int x, int y) {
> 	if (allowText)
> 		graphics.fillString(s, zoomTextPoint(x, y));
> }
> 
256a578,599
> /**
>  * @see org.eclipse.draw2d.Graphics#setInterpolation(int)
>  */
> public void setInterpolation(int interpolation) {
> 	graphics.setInterpolation(interpolation);
> }
> 
> /**
>  * @see Graphics#setLineCap(int)
>  */
> public void setLineCap(int cap) {
> 	graphics.setLineCap(cap);
> }
> 
> /**
>  * @see Graphics#setLineDash(int[])
>  */
> public void setLineDash(int[] dash) {
> 	graphics.setLineDash(dash);
> }
> 
> /**
257a601,601
>  */
257,257c600,600
< 	/** @see Graphics#fillOval(int, int, int, int) */
---
>  * @see Graphics#setLineJoin(int)
258a603,605
> 	graphics.setLineJoin(join);
> }
> 
258,258c602,602
< 	public void fillOval(int x, int y, int w, int h) {
---
> public void setLineJoin(int join) {
259,259d602
< 		graphics.fillOval(zoomFillRect(x, y, w, h));
274,274c235,235
< 	/** @see Graphics#drawPoint(int, int) */
---
> /** @see Graphics#drawPoint(int, int) */
275,275c236,236
< 	public void drawPoint(int x, int y) {
---
> public void drawPoint(int x, int y) {
276,276c237,237
< 		graphics.drawPoint((int)Math.floor(x * zoom + fractionalX),(int)Math.floor(y * zoom + fractionalY));
---
> 	graphics.drawPoint((int)Math.floor(x * zoom + fractionalX),
276a238,238
> 			(int)Math.floor(y * zoom + fractionalY));
277,290d237
< 	}
< 
< 	/**
< 	 * @see Graphics#fillPolygon(int[])
< 	 */
< 	public void fillPolygon(int[] points) {
< 		graphics.fillPolygon(zoomPointList(points));
< 	}
< 
< 	/** @see Graphics#fillPolygon(PointList) */
< 	public void fillPolygon(PointList points) {
< 		graphics.fillPolygon(zoomPointList(points.toIntArray()));
< 	}
< 
308,312d269
< 	/** @see Graphics#fillRectangle(int, int, int, int) */
< 	public void fillRectangle(int x, int y, int w, int h) {
< 		graphics.fillRectangle(zoomFillRect(x, y, w, h));
< 	}
< 
320,326d276
< 	/** @see Graphics#fillRoundRectangle(Rectangle, int, int) */
< 	public void fillRoundRectangle(Rectangle r, int arcWidth, int arcHeight) {
< 		graphics.fillRoundRectangle(zoomFillRect(r.x, r.y, r.width, r.height),
< 			(int)(arcWidth * zoom),
< 			(int)(arcHeight * zoom));
< 	}
< 
333,338d282
< 	/** @see Graphics#fillString(String, int, int) */
< 	public void fillString(String s, int x, int y) {
< 		if (allowText)
< 			graphics.fillString(s, zoomTextPoint(x, y));
< 	}
< 
346,346c290,290
< 	 * @see org.eclipse.draw2d.Graphics#drawText(java.lang.String, int, int, int)
---
>  * @see Graphics#drawText(String, int, int, int)
394a423,429
> /**
>  * @see Graphics#getFillRule()
>  */
> public int getFillRule() {
> 	return graphics.getFillRule();
> }
> 
409a445,465
> /**
>  * @see Graphics#getInterpolation()
>  */
> public int getInterpolation() {
> 	return graphics.getInterpolation();
> }
> 
> /**
>  * @see Graphics#getLineCap()
>  */
> public int getLineCap() {
> 	return graphics.getLineCap();
> }
> 
> /**
>  * @see Graphics#getLineJoin()
>  */
> public int getLineJoin() {
> 	return graphics.getLineJoin();
> }
> 
428a485,485
>  * @see Graphics#getTextAntialias()
429,429d484
< 	 * @see org.eclipse.draw2d.Graphics#getAbsoluteScale()
430a487,488
> public int getTextAntialias() {
> 	return graphics.getTextAntialias();
430a364,367
> /**
>  * @see Graphics#getAbsoluteScale()
>  */
> public double getAbsoluteScale() {
431,431d363
< 	public double getAbsoluteScale() {
432,432c368,368
< 		return zoom * graphics.getAbsoluteScale();
---
> 	return zoom * graphics.getAbsoluteScale();
432a369,384
> }
> 
> /**
>  * @see Graphics#getAlpha()
>  */
> public int getAlpha() {
> 	return graphics.getAlpha();
> }
> 
> /**
>  * @see Graphics#getAntialias()
>  */
> public int getAntialias() {
> 	return graphics.getAntialias();
> }
> 
480a537,541
> /**
>  * @see Graphics#setAlpha(int)
>  */
> public void setAlpha(int alpha) {
> 	graphics.setAlpha(alpha);
480a390,394
> Font getCachedFont(FontKey key) {
> 	FontData data = key.font.getFontData()[0];		
> 	data.setHeight(key.height);
> 	return Draw2dResourceManager.getInstance().getFont(Display.getCurrent(), data);
> }
481,487d389
< 	void setScale(double value) {
< 		if (zoom == value)
< 			return;
< 		this.zoom = value;
< 		graphics.setFont(zoomFont(getLocalFont()));
< 		graphics.setLineWidth(zoomLineWidth(localLineWidth));
< 	}
488a396,398
> FontData getCachedFontData(Font f) {
> 	FontData data = (FontData)fontDataCache.get(f);
> 	if (data != null)
488,488c395,395
< 
---
> 
489,500d395
< 	Font getCachedFont(FontKey key) {
< 		FontData data = key.font.getFontData()[0];		
< 		data.setHeight(key.height);
< 		return Draw2dResourceManager.getInstance().getFont(Display.getCurrent(), data);
< 	}
< 	
< 	FontData getCachedFontData(Font f) {
< 		FontData data = (FontData)fontDataCache.get(f);
< 		if (data != null)
< 			return data;
< 		data = getLocalFont().getFontData()[0];
< 		fontDataCache.put(f, data);
501a400,404
> 	data = getLocalFont().getFontData()[0];
> 	fontDataCache.put(f, data);
> 	return data;
> }
> 
501,501c399,399
< 		return data;
---
> 		return data;
503a174,174
> Font createFont(FontData data) {
503a544,548
> /**
>  * @see Graphics#setAntialias(int)
>  */
> public void setAntialias(int value) {
> 	graphics.setAntialias(value);
504,504d173
< 	Font createFont(FontData data) {
505a176,177
> }
> 
505,505c175,175
< 		return new Font(Display.getCurrent(), data);
---
> 	return new Font(Display.getCurrent(), data);
517a561,567
> /**
>  * @see Graphics#setFillRule(int)
>  */
> public void setFillRule(int rule) {
> 	graphics.setFillRule(rule);
> }
> 
547a626,640
> void setScale(double value) {
> 	if (zoom == value)
> 		return;
> 	this.zoom = value;
> 	graphics.setFont(zoomFont(getLocalFont()));
> 	graphics.setLineWidth(zoomLineWidth(localLineWidth));
> }
> 
> /**
>  * @see Graphics#setTextAntialias(int)
>  */
> public void setTextAntialias(int value) {
> 	graphics.setTextAntialias(value);
> }	
> 
608,608c774,774
< 	private Point zoomTextPoint(int x, int y) {
---
> Point zoomTextPoint(int x, int y) {
625,626d790
< 	private int[] zoomPointList(int[] points) {
< 		int[] scaled = null;
627a792,793
> protected Graphics getGraphics() {
> 	return graphics;
627a657,663
> private Rectangle zoomClipRect(Rectangle r) {
> 	tempRECT.x = (int)(Math.floor(r.x * zoom + fractionalX));
> 	tempRECT.y = (int)(Math.floor(r.y * zoom + fractionalY));
> 	tempRECT.width = (int)(Math.ceil(((r.x + r.width) * zoom + fractionalX))) - tempRECT.x;
> 	tempRECT.height = (int)(Math.ceil(((r.y + r.height) * zoom + fractionalY))) - tempRECT.y;
> 	return tempRECT;
> }
628,654d656
< 		// Look in cache for a integer array with the same length as 'points'
< 		for (int i = 0; i < intArrayCache.length; i++) {
< 			if (intArrayCache[i].length == points.length) {
< 				scaled = intArrayCache[i];
< 				
< 				// Move this integer array up one notch in the array
< 				if (i != 0) {
< 					int[] temp = intArrayCache[i - 1];
< 					intArrayCache[i - 1] = scaled;
< 					intArrayCache[i] = temp;	
< 				}
< 			}
< 		}
< 		
< 		// If no match is found, take the one that is last and resize it.
< 		if (scaled == null) {
< 			intArrayCache[intArrayCache.length - 1] = new int[points.length];
< 			scaled = intArrayCache[intArrayCache.length - 1];
< 		}
< 		
< 		// Scale the points
< 		for (int i = 0; (i + 1) < points.length; i+= 2) {
< 			scaled[i] = (int)(Math.floor((points[i] * zoom + fractionalX)));
< 			scaled[i + 1] = (int)(Math.floor((points[i + 1] * zoom + fractionalY)));
< 		}
< 		return scaled;
< 	}
655a665,671
> private Rectangle zoomFillRect(int x, int y, int w, int h) {
> 	tempRECT.x = (int)(Math.floor((x * zoom + fractionalX)));
> 	tempRECT.y = (int)(Math.floor((y * zoom + fractionalY)));
> 	tempRECT.width = (int)(Math.floor(((x + w - 1) * zoom + fractionalX))) - tempRECT.x + 1;
> 	tempRECT.height = (int)(Math.floor(((y + h - 1) * zoom + fractionalY))) - tempRECT.y + 1;
> 	return tempRECT;
> }
655,655c664,664
< 
---
> 
656,662d664
< 	private Rectangle zoomFillRect(int x, int y, int w, int h) {
< 		TEMP.x = (int)(Math.floor((x * zoom + fractionalX)));
< 		TEMP.y = (int)(Math.floor((y * zoom + fractionalY)));
< 		TEMP.width = (int)(Math.floor(((x + w - 1) * zoom + fractionalX))) - TEMP.x + 1;
< 		TEMP.height = (int)(Math.floor(((y + h - 1) * zoom + fractionalY))) - TEMP.y + 1;
< 		return TEMP;
< 	}
663,663c672,672
< 
---
> 
663a673,681
> Font zoomFont(Font f) {
> 	if (f == null)
> 		f = Display.getCurrent().getSystemFont();
> 	FontData data = getCachedFontData(f);
> 	int zoomedFontHeight = zoomFontHeight(data.getHeight());
> 	allowText = zoomedFontHeight > 0;
> 	fontKey.setValues(f, zoomedFontHeight);
> 	return getCachedFont(fontKey);
> }
664,672d672
< 	Font zoomFont(Font f) {
< 		if (f == null)
< 			f = Display.getCurrent().getSystemFont();
< 		FontData data = getCachedFontData(f);
< 		int zoomedFontHeight = zoomFontHeight(data.getHeight());
< 		allowText = zoomedFontHeight > 0;
< 		fontKey.setValues(f, zoomedFontHeight);
< 		return getCachedFont(fontKey);
< 	}
673,673c682,682
< 
---
> 
674,674c683,683
< 	int zoomFontHeight(int height) {
---
> int zoomFontHeight(int height) {
675,675c684,684
< 		return (int)(zoom * height);
---
> 	return (int)(zoom * height);
675a685,729
> }
> 
> int zoomLineWidth(int w) {
> 	return w;
> }
> 
> private int[] zoomPointList(int[] points) {
> 	int[] scaled = null;
> 
> 	// Look in cache for a integer array with the same length as 'points'
> 	for (int i = 0; i < intArrayCache.length; i++) {
> 		if (intArrayCache[i].length == points.length) {
> 			scaled = intArrayCache[i];
> 			
> 			// Move this integer array up one notch in the array
> 			if (i != 0) {
> 				int[] temp = intArrayCache[i - 1];
> 				intArrayCache[i - 1] = scaled;
> 				intArrayCache[i] = temp;	
> 			}
> 		}
> 	}
> 	
> 	// If no match is found, take the one that is last and resize it.
> 	if (scaled == null) {
> 		intArrayCache[intArrayCache.length - 1] = new int[points.length];
> 		scaled = intArrayCache[intArrayCache.length - 1];
> 	}
> 	
> 	// Scale the points
> 	for (int i = 0; (i + 1) < points.length; i += 2) {
> 		scaled[i] = (int)(Math.floor((points[i] * zoom + fractionalX)));
> 		scaled[i + 1] = (int)(Math.floor((points[i + 1] * zoom + fractionalY)));
> 	}
> 	return scaled;
> }	
> 
> protected Rectangle zoomRect(int x, int y, int w, int h) {
> 	tempRECT.x = (int)(Math.floor(x * zoom + fractionalX));
> 	tempRECT.y = (int)(Math.floor(y * zoom + fractionalY));
> 	tempRECT.width = (int)(Math.floor(((x + w) * zoom + fractionalX))) - tempRECT.x;
> 	tempRECT.height = (int)(Math.floor(((y + h) * zoom + fractionalY))) - tempRECT.y;
> 	return tempRECT;
> }
> 
678,712d795
< 	private Rectangle zoomClipRect(Rectangle r) {
< 		TEMP.x = (int)(Math.floor(r.x * zoom + fractionalX));
< 		TEMP.y = (int)(Math.floor(r.y * zoom + fractionalY));
< 		TEMP.width = (int)(Math.ceil(((r.x + r.width) * zoom + fractionalX))) - TEMP.x;
< 		TEMP.height = (int)(Math.ceil(((r.y + r.height) * zoom + fractionalY))) - TEMP.y;
< 		return TEMP;
< 	}
< 
< 	private Rectangle zoomRect(int x, int y, int w, int h) {
< 		TEMP.x = (int)(Math.floor(x * zoom + fractionalX));
< 		TEMP.y = (int)(Math.floor(y * zoom + fractionalY));
< 		TEMP.width = (int)(Math.floor(((x + w) * zoom + fractionalX))) - TEMP.x;
< 		TEMP.height = (int)(Math.floor(((y + h) * zoom + fractionalY))) - TEMP.y;
< 		return TEMP;
< 	}
< 
< //	private Rectangle zoomRect(Rectangle r) {
< //		TEMP.x = (int)(Math.floor((r.x * zoom + fractionalX)));
< //		TEMP.y = (int)(Math.floor((r.y * zoom + fractionalY)));
< //		TEMP.width = (int)(Math.floor((r.right() * zoom + fractionalX))) - TEMP.x;
< //		TEMP.height = (int)(Math.floor((r.bottom() * zoom + fractionalY))) - TEMP.y;
< //		return TEMP;
< //	}
< 
< 	int zoomLineWidth(int w) {
< 		return w;
< 	}
< 	
< 	/* 
< 	 * (non-Javadoc)
< 	 * @see org.eclipse.draw2d.Graphics#setLineDash(int[])
< 	 */
< 	public void setLineDash(int[] dash) {
< 		graphics.setLineDash(dash);
< 	}
