17,19d16
< import java.util.ArrayList;
< import java.util.Collections;
< import java.util.List;
21,21d17
< import org.eclipse.core.runtime.IProgressMonitor;
96,96c105,105
< import org.eclipse.gmf.common.codegen.ImportAssistant;
---
> import org.eclipse.gmf.internal.common.codegen.XpandTextEmitter;
110,110d104
< import org.eclipse.gmf.internal.xpand.BufferOutput;
112,115d106
< import org.eclipse.gmf.internal.xpand.XpandFacade;
< import org.eclipse.gmf.internal.xpand.expression.Variable;
< import org.eclipse.gmf.internal.xpand.model.XpandExecutionContext;
< import org.eclipse.gmf.internal.xpand.model.XpandExecutionContextImpl;
117,117d107
< import org.eclipse.gmf.internal.xpand.util.ContextFactory;
309,309c299,299
< 		return new XpandTextEmitter(myResourceManager, "xpt::diagram::editparts::DiagramEditPart::DiagramEditPart"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::diagram::editparts::DiagramEditPart::DiagramEditPart"); //$NON-NLS-1$
313,313c303,303
< 		return new XpandTextEmitter(myResourceManager, "xpt::diagram::editparts::NodeEditPart::NodeEditPart"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::diagram::editparts::NodeEditPart::NodeEditPart"); //$NON-NLS-1$
317,317c307,307
< 		return new XpandTextEmitter(myResourceManager, "xpt::diagram::editparts::NodeLabelEditPart::NodeLabelEditPart"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::diagram::editparts::NodeLabelEditPart::NodeLabelEditPart"); //$NON-NLS-1$
321,321c311,311
< 		return new XpandTextEmitter(myResourceManager, "xpt::diagram::editparts::ExternalNodeLabelEditPart::ExternalNodeLabelEditPart"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::diagram::editparts::ExternalNodeLabelEditPart::ExternalNodeLabelEditPart"); //$NON-NLS-1$
325,325c315,315
< 		return new XpandTextEmitter(myResourceManager, "xpt::diagram::editparts::ChildNodeLabelEditPart::ChildNodeLabelEditPart"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::diagram::editparts::ChildNodeLabelEditPart::ChildNodeLabelEditPart"); //$NON-NLS-1$
329,329c319,319
< 		return new XpandTextEmitter(myResourceManager, "xpt::diagram::editparts::CompartmentEditPart::CompartmentEditPart"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::diagram::editparts::CompartmentEditPart::CompartmentEditPart"); //$NON-NLS-1$
333,333c323,323
< 		return new XpandTextEmitter(myResourceManager, "xpt::diagram::editparts::LinkEditPart::LinkEditPart"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::diagram::editparts::LinkEditPart::LinkEditPart"); //$NON-NLS-1$
337,337c327,327
< 		return new XpandTextEmitter(myResourceManager, "xpt::diagram::editparts::LinkLabelEditPart::LinkLabelEditPart"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::diagram::editparts::LinkLabelEditPart::LinkLabelEditPart"); //$NON-NLS-1$
341,341c331,331
< 		return new XpandTextEmitter(myResourceManager, "xpt::diagram::editparts::EditPartFactory::EditPartFactory"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::diagram::editparts::EditPartFactory::EditPartFactory"); //$NON-NLS-1$
347,347c337,337
< 		return new XpandTextEmitter(myResourceManager, "xpt::policies::BaseItemSemanticEditPolicy::BaseItemSemanticEditPolicy"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::policies::BaseItemSemanticEditPolicy::BaseItemSemanticEditPolicy"); //$NON-NLS-1$
351,351c341,341
< 		return new XpandTextEmitter(myResourceManager, "xpt::policies::OpenDiagram::EditPolicy"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::policies::OpenDiagram::EditPolicy"); //$NON-NLS-1$
375,375c365,365
< 		return new XpandTextEmitter(myResourceManager, "xpt::policies::NodeItemSemanticEditPolicy::NodeItemSemanticEditPolicy"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::policies::NodeItemSemanticEditPolicy::NodeItemSemanticEditPolicy"); //$NON-NLS-1$
391,391c381,381
< 		return new XpandTextEmitter(myResourceManager, "xpt::diagram::editpolicies::TextFeedback::TextSelectionEditPolicy"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::diagram::editpolicies::TextFeedback::TextSelectionEditPolicy"); //$NON-NLS-1$
395,395c385,385
< 		return new XpandTextEmitter(myResourceManager, "xpt::diagram::editpolicies::TextFeedback::TextNonResizableEditPolicy"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::diagram::editpolicies::TextFeedback::TextNonResizableEditPolicy"); //$NON-NLS-1$
429,429c419,419
< 		return new XpandTextEmitter(myResourceManager, "xpt::diagram::providers::ElementTypes::ElementTypes"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::diagram::providers::ElementTypes::ElementTypes"); //$NON-NLS-1$
511,511c501,501
< 		return new XpandTextEmitter(myResourceManager, "xpt::editor::palette::PaletteFactory::Factory"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::editor::palette::PaletteFactory::Factory"); //$NON-NLS-1$
563,563c553,553
< 		return new XpandTextEmitter(myResourceManager, "xpt::navigator::NavigatorContentProvider::NavigatorContentProvider"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::navigator::NavigatorContentProvider::NavigatorContentProvider"); //$NON-NLS-1$
599,599c589,589
< 		return new XpandTextEmitter(myResourceManager, "xpt::plugin::plugin"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::plugin::plugin"); //$NON-NLS-1$
603,603c593,593
< 		return new XpandTextEmitter(myResourceManager, "xpt::properties::properties"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::properties::properties"); //$NON-NLS-1$
687,687c677,677
< 		return new XpandTextEmitter(myResourceManager, "xpt::application::Application::Application"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::application::Application::Application"); //$NON-NLS-1$
691,691c681,681
< 		return new XpandTextEmitter(myResourceManager, "xpt::application::ActionBarAdvisor::ActionBarAdvisor"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::application::ActionBarAdvisor::ActionBarAdvisor"); //$NON-NLS-1$
695,695c685,685
< 		return new XpandTextEmitter(myResourceManager, "xpt::application::Perspective::Perspective"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::application::Perspective::Perspective"); //$NON-NLS-1$
699,699c689,689
< 		return new XpandTextEmitter(myResourceManager, "xpt::application::WorkbenchAdvisor::WorkbenchAdvisor"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::application::WorkbenchAdvisor::WorkbenchAdvisor"); //$NON-NLS-1$
703,703c693,693
< 		return new XpandTextEmitter(myResourceManager, "xpt::application::WorkbenchWindowAdvisor::WorkbenchWindowAdvisor"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::application::WorkbenchWindowAdvisor::WorkbenchWindowAdvisor"); //$NON-NLS-1$
711,711c701,701
< 		return new XpandTextEmitter(myResourceManager, "xpt::editor::URIDiagramDocumentProvider::URIDiagramDocumentProvider"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::editor::URIDiagramDocumentProvider::URIDiagramDocumentProvider"); //$NON-NLS-1$
719,719c709,709
< 		return new XpandTextEmitter(myResourceManager, "xpt::editor::URIEditorInputProxy::URIEditorInputProxy"); //$NON-NLS-1$
---
> 		return newXpandEmitter("xpt::editor::URIEditorInputProxy::URIEditorInputProxy"); //$NON-NLS-1$
727,727c717,717
<         return new XpandTextEmitter(myResourceManager, "xpt::Externalizer::Access");
---
>         return newXpandEmitter("xpt::Externalizer::Access");
731,731c721,721
<         return new XpandTextEmitter(myResourceManager, "xpt::Externalizer::Values");
---
>         return newXpandEmitter("xpt::Externalizer::Values");
742a783,783
> 	private TextEmitter newXpandEmitter(String definition) {
743,743c784,784
< 		return new XpandTextEmitter(myResourceManager, definition);
---
> 		return new XpandTextEmitter(myResourceManager, definition, getClass().getClassLoader());
751a742,742
> 		return newXpandEmitter(definition);
752,752c733,733
< 		return new XpandTextEmitter(myResourceManager, definition);
---
> 		return newXpandEmitter(definition);
754a745,745
> 
792,834d782
< 	private static class XpandTextEmitter implements TextEmitter {
< 		private final ResourceManager myResourceManager;
< 		private final String myTemplateFQN;
< 
< 		public XpandTextEmitter(ResourceManager manager, String templateFQN) {
< 			myResourceManager = manager;
< 			myTemplateFQN = templateFQN;
< 		}
< 
< 		public String generate(IProgressMonitor monitor, Object[] arguments) throws InterruptedException, InvocationTargetException, UnexpectedBehaviourException {
< 			StringBuilder result = new StringBuilder();
< 			// JET gets single Object as an argument, and that's Object[] {diagram, importUtil} in our case.
< 			// FIXME it's JETEmitterAdapter's role to wrap Object[] into single Object passed to emitter, not XpandEmitter's
< 			Object[] actualArguments = arguments != null && arguments.length == 1 && arguments[0] instanceof Object[] ? (Object[]) arguments[0] : arguments;
< 			new XpandFacade(createContext(result)).evaluate(myTemplateFQN, extractTarget(actualArguments), extractArguments(actualArguments));
< 			return result.toString();
< 		}
< 
< 		protected Object extractTarget(Object[] arguments) {
< 			assert arguments != null && arguments.length > 0;
< 			return arguments[0];
< 		}
< 
< 		protected Object[] extractArguments(Object[] arguments) {
< 			assert arguments != null && arguments.length > 0;
< 			ArrayList<Object> res = new ArrayList<Object>(arguments.length);
< 			// strip first one off, assume it's target
< 			for (int i = 1; i < arguments.length; i++) {
< 				if (false == arguments[i] instanceof ImportAssistant) {
< 					// strip assistant off
< 					res.add(arguments[i]);
< 				}
< 			}
< 			return res.toArray();
< 		}
< 
< 		private XpandExecutionContext createContext(StringBuilder result) {
< 			final BufferOutput output = new BufferOutput(result);
< 			final List<Variable> globals = Collections.emptyList();
< 			final XpandExecutionContext xpandContext = ContextFactory.createXpandContext(myResourceManager, output, globals);
< 			((XpandExecutionContextImpl) xpandContext).setContextClassLoader(getClass().getClassLoader());
< 			return xpandContext;
< 		}
