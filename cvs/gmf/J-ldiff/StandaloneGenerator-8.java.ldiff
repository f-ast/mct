24,24d23
< import org.eclipse.core.runtime.IProgressMonitor;
26,26c25,25
< import org.eclipse.emf.codegen.jet.JETException;
---
> import org.eclipse.emf.codegen.util.CodeGenUtil;
27a31,31
> import org.eclipse.gmf.internal.common.codegen.DelegateImportManager;
28a33,33
> import org.eclipse.gmf.internal.common.codegen.ImportUtil;
28,28c32,32
< import org.eclipse.gmf.common.codegen.GeneratorBase;
---
> import org.eclipse.gmf.internal.common.codegen.GeneratorBase;
30,30d27
< import org.eclipse.gmf.common.codegen.ImportUtil;
38,38c38,38
< 	private final Emitter myFigureGenerator;
---
> 	private final FigureGenerator myFigureGenerator;
38a39,39
> 	private DelegateImportManager myMapModeImportHack;
78,78c79,79
< 			this(pluginId, mainPackageName, pluginId, "", "PluginActivator", mainPackageName + ".activator", useMapMode);
---
> 			this(pluginId, mainPackageName, pluginId, "", "PluginActivator", (mainPackageName == null ? "" : mainPackageName + ".")  + "activator", useMapMode);
83,83c84,84
< 			myMainPackageName = mainPackageName;
---
> 			myMainPackageName = mainPackageName == null ? "" : mainPackageName;
129,129c215,215
< 		ImportAssistant importAssistant = new ImportUtil(getPackageName());
---
> 		final ImportAssistant importAssistant = new ImportUtil(getPackageName(), CodeGenUtil.validJavaIdentifier(figure.getName()));
129a216,221
> 		Object[] args = new Object[] { figure, importAssistant };
> 		if (myMapModeImportHack != null) {
> 			myMapModeImportHack.setDelegate(importAssistant);
> 		}
> 		doGenerateJavaClass(myFigureGenerator, getPackageName(), importAssistant.getCompilationUnitName(), args);
> 		myGenerationInfo.registerFQN(figure, composeFQN(getPackageName(), importAssistant.getCompilationUnitName()));
132a133,133
> 			myMapModeImportHack = new DelegateImportManager();
133,133c134,134
< 			strategy = new MapModeCodeGenStrategy.RuntimeMapModeFromPluginClass(importAssistant, pluginActivatorFQN);
---
> 			strategy = new MapModeCodeGenStrategy.RuntimeMapModeFromPluginClass(myMapModeImportHack, pluginActivatorFQN);
138,138c139,139
< 		myFigureGenerator = new FigureGeneratorAdapter( //
---
> 		myFigureGenerator = new FigureGenerator(fqnSwitch, strategy);
139,140d139
< 				new FigureGenerator(getPackageName(), importAssistant, fqnSwitch, strategy)
< 		);
183a183,183
> 		Object[] args = new Object[] {myArgs, new ImportUtil(myArgs.getPluginActivatorPackageName(), myArgs.getPluginActivatorClassName())};
184,184c184,184
< 		doGenerateJavaClass(myAuxiliaryGenerators.getPluginActivatorEmitter(), myArgs.getPluginActivatorPackageName(), myArgs.getPluginActivatorClassName(), myArgs);		
---
> 		doGenerateJavaClass(myAuxiliaryGenerators.getPluginActivatorEmitter(), myArgs.getPluginActivatorPackageName(), myArgs.getPluginActivatorClassName(), new Object[] {args});		
187a188,188
> 		doGenerateFile(myAuxiliaryGenerators.getBuildPropertiesEmitter(), new Path("build.properties"), new Object[] { myArgs });
188,188d187
< 		doGenerateFile(myAuxiliaryGenerators.getBuildPropertiesEmitter(), new Path("build.properties"), myArgs);
189,189c189,189
< 		doGenerateFile(myAuxiliaryGenerators.getManifestMFEmitter(), new Path("META-INF/MANIFEST.MF"), new Object[] {myArgs, getRequiredBundles()});
---
> 		doGenerateFile(myAuxiliaryGenerators.getManifestMFEmitter(), new Path("META-INF/MANIFEST.MF"), new Object[] { new Object[] { myArgs, getRequiredBundles() } });
190,190c190,190
< 		doGenerateFile(myAuxiliaryGenerators.getPluginPropertiesEmitter(), new Path("plugin.properties"), myArgs);
---
> 		doGenerateFile(myAuxiliaryGenerators.getPluginPropertiesEmitter(), new Path("plugin.properties"), new Object[] { myArgs });
215,218d214
< 		String packageName = getPackageName();
< 		String className = figure.getName();
< 		doGenerateJavaClass(myFigureGenerator, packageName, className, figure);
< 		myGenerationInfo.registerFQN(figure, composeFQN(packageName, className));
235,249d237
< 	private static class FigureGeneratorAdapter implements GeneratorBase.Emitter {
< 		private final FigureGenerator myDelegate;
< 
< 		public FigureGeneratorAdapter(FigureGenerator delegate){
< 			myDelegate = delegate;
< 		}
< 		
< 		public String generate(IProgressMonitor monitor, Object param) throws JETException {
< 			if (false == param instanceof Figure){
< 				throw new IllegalStateException("Figure expected: " + param);
< 			}
< 			return myDelegate.go((Figure)param);
< 		}
< 	}
< 	
