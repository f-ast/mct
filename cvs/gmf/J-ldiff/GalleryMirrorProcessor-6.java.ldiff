15,15d14
< import java.util.Enumeration;
18a18,18
> import org.eclipse.gmf.gmfgraph.ConnectionFigure;
19a20,20
> import org.eclipse.gmf.gmfgraph.DecorationFigure;
20a22,22
> import org.eclipse.gmf.gmfgraph.FigureDescriptor;
31a34,34
> 	private final Map<FigureDescriptor, String> myFigure2FQN = new IdentityHashMap<FigureDescriptor, String>();
32,32d33
< 	private final GenerationInfoImpl myGenerationInfo;
37,37d38
< 		myGenerationInfo = new GenerationInfoImpl();
49a51,53
> 		for (FigureDescriptor fd : myFigure2FQN.keySet()) {
> 			Figure nextOriginal = fd.getActualFigure();
> 			String nextConvertedFqn = myFigure2FQN.get(fd);
50,52d50
< 		for (Enumeration<Figure> originalFigures = myGenerationInfo.getProcessedFigures(); originalFigures.hasMoreElements();) {
< 			Figure nextOriginal = originalFigures.nextElement();
< 			String nextConvertedFqn = myGenerationInfo.getGeneratedClassFQN(nextOriginal);
53,53c54,54
< 			CustomFigure custom = DiagramElementsCopier.createCustomFigure(nextOriginal);
---
> 			CustomFigure custom = createCustomFigure(nextOriginal);
54,54c55,55
< 			custom.setName(nextOriginal.getName());
---
> 			custom.setName(fd.getName());
55,55d55
< 			custom.setBundleName(myGeneratedBundle);
62a63,64
> 	public Map<FigureDescriptor, String> getGenerationInfo() {
> 		return Collections.unmodifiableMap(myFigure2FQN);
63,64d62
< 	public GenerationInfo getGenerationInfo() {
< 		return myGenerationInfo;
67,67c67,67
< 	protected void handle(Figure next, String fqn) {
---
> 	protected void handle(FigureDescriptor next, String fqn) {
68,68c68,68
< 		myGenerationInfo.registerFQN(next, fqn);
---
> 		myFigure2FQN.put(next, fqn);
70a71,74
> 	static CustomFigure createCustomFigure(Figure original){
> 		GMFGraphFactory factory = GMFGraphFactory.eINSTANCE;
> 		if (original instanceof DecorationFigure){
> 			return factory.createCustomDecoration();
71,74d70
< 	public interface GenerationInfo {
< 		// FIXME use iterator instead to allow enhanced for loop
< 		public Enumeration<Figure> getProcessedFigures();
< 		public String getGeneratedClassFQN(Figure figure);
75a76,77
> 		if (original instanceof ConnectionFigure){
> 			return factory.createCustomConnection();
76,92d75
< 
< 	private static class GenerationInfoImpl implements GenerationInfo {
< 		private final Map<Figure, String> myFigure2FQN = new IdentityHashMap<Figure, String>();
< 		
< 		public GenerationInfoImpl(){
< 		}
< 		
< 		public void registerFQN(Figure figure, String fqn){
< 			myFigure2FQN.put(figure, fqn);
< 		}
< 		
< 		public String getGeneratedClassFQN(Figure figure) {
< 			return myFigure2FQN.get(figure);
< 		}
< 		
< 		public Enumeration<Figure> getProcessedFigures() {
< 			return Collections.enumeration(myFigure2FQN.keySet());
93a79,79
> 		return factory.createCustomFigure();
