12a13,14
> import java.util.HashMap;
> import java.util.Map;
19,19c21,21
< import org.eclipse.emf.ecore.impl.EReferenceImpl;
---
> import org.eclipse.emf.ecore.util.EcoreUtil;
25,25c28,28
< 	private EStructuralFeature mySavedFeature;
---
> 	private Map<EStructuralFeature, EStructuralFeature> myNarrowedFeatureTypes;
26,26d28
< 	private EReferenceImpl myFakeFeatureWithNarrowType;
57a59,60
> 		EStructuralFeature originalFeature = getOriginalFeature(feature);
> 		if (originalFeature != null) {
58,58d58
< 		if (feature != null && feature.equals(myFakeFeatureWithNarrowType)) {
59,59c61,61
< 			feature = mySavedFeature;
---
> 			feature = originalFeature;
76a79,81
> 			EStructuralFeature fake = addNarrowedFeature(result);
> 			fake.setEType(narrow);
> 			return fake;
77,81d78
< 			mySavedFeature = result;
< 			myFakeFeatureWithNarrowType = new EReferenceImpl() {};
< 			myFakeFeatureWithNarrowType.setName(result.getName());
< 			myFakeFeatureWithNarrowType.setEType(narrow);
< 			return myFakeFeatureWithNarrowType;
105a106,121
> 	
> 	protected EStructuralFeature getOriginalFeature(EStructuralFeature feature) {
> 		if (myNarrowedFeatureTypes == null) {
> 			myNarrowedFeatureTypes = new HashMap<EStructuralFeature, EStructuralFeature>();
> 		}
> 		return myNarrowedFeatureTypes.get(feature);
> 	}
> 	
> 	protected EStructuralFeature addNarrowedFeature(EStructuralFeature originalFeature) {
> 		if (myNarrowedFeatureTypes == null) {
> 			myNarrowedFeatureTypes = new HashMap<EStructuralFeature, EStructuralFeature>();
> 		}
> 		EStructuralFeature result = (EStructuralFeature) EcoreUtil.copy(originalFeature);
> 		myNarrowedFeatureTypes.put(result, originalFeature);
> 		return result;
> 	}
