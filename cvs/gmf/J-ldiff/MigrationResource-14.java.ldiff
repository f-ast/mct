16,16d15
< import java.util.Collection;
20,20d18
< import org.eclipse.emf.ecore.EPackage;
23,25d20
< import org.eclipse.emf.ecore.xmi.XMLLoad;
< import org.eclipse.emf.ecore.xmi.impl.SAXXMIHandler;
< import org.eclipse.emf.ecore.xmi.impl.XMILoadImpl;
27,27d21
< import org.xml.sax.helpers.DefaultHandler;
31,31d24
< 	private boolean isOldVersionDetected;
41,41d33
< 			isOldVersionDetected = false;
53,80d44
< 	@Override
< 	protected XMLLoad createXMLLoad() {
< 		return new XMILoadImpl(createXMLHelper()) {
< 
< 			@Override
< 			protected DefaultHandler makeDefaultHandler() {
< 				return new SAXXMIHandler(resource, helper, options) {
< 					@Override
< 					protected EPackage getPackageForURI(String uriString) {
< 						// FIXME move the check to delegate
< 						if (!getMetamodelNsURI().equals(uriString) && getBackwardSupportedURIs().contains(uriString)) {
< 							handleOldVersionDetected();
< 							return super.getPackageForURI(getMetamodelNsURI());
< 						}
< 						return super.getPackageForURI(uriString);
< 					}
< 				};
< 			}
< 		};
< 	}
< 
< 	private void handleOldVersionDetected() {
< 		if (myMigrationHelper != null) {
< 			myMigrationHelper.enableDelegate(true);
< 		}
< 		isOldVersionDetected = true;
< 	}
< 
81a46,46
> 		if (myMigrationHelper != null && myMigrationHelper.isEnabled()) {
82,82d45
< 		if (isOldVersionDetected) {
101,101d64
< 	protected abstract Collection<String> getBackwardSupportedURIs();
103,104d65
< 	protected abstract String getMetamodelNsURI();
< 
