189a214,214
> 		
189a190,191
>     	
>     	return initializeDiagramEventBroker(editingDomain);
190,192d213
<         WeakReference reference = (WeakReference) instanceMap
<             .get(editingDomain);
<         if (reference != null) {
193,193c215,215
<             return (DiagramEventBroker) reference.get();
---
> 		return (DiagramEventBroker) reference.get();
194,195d215
<         }
<         return null;
207,210d202
<         DiagramEventBroker diagramEventBroker = getInstance(editingDomain);
<         if (diagramEventBroker == null) {
<             diagramEventBroker = new DiagramEventBroker();
<             startListening(editingDomain, diagramEventBroker);
214a219,220
>      * Factory interface that can be used to create overrides of the DiagramEventBroker class
>      * @author sshaw
215,222d218
<      * Creates a new diagram event broker instance for the editing domain passed
<      * in only if the editing domain does not already have a diagram event
<      * broker. There is one diagram event broker per editing domain. Adds the
<      * diagram event broker instance as a listener to the editing domain.
<      * 
<      * @param editingDomain
<      * @param diagramEventBroker the <code>DiagramEventBroker</code> to add as a listener to the 
<      * <code>TransactionalEditingDomain</code>
223a203,209
>     	initializeDiagramEventBroker(editingDomain);
>     }
> 
> 	private static DiagramEventBroker initializeDiagramEventBroker(TransactionalEditingDomain editingDomain) {
> 		WeakReference reference = (WeakReference) instanceMap.get(editingDomain);
> 		if (reference == null) {
>             DiagramEventBroker diagramEventBroker = debFactory.createDiagramEventBroker(editingDomain);
223a222,243
>     public static interface DiagramEventBrokerFactory {
>     	/**
>     	 * @param editingDomain the <code>TransactionalEditingDomain</code> that is associated
>     	 * with the <code>DiagramEventBroker</code> instance.
>     	 * @return the <code>DiagramEventBroker</code> instance.
>     	 */
>     	public DiagramEventBroker createDiagramEventBroker(TransactionalEditingDomain editingDomain); 
>     }
>     
>     private static class DiagramEventBrokerFactoryImpl implements DiagramEventBrokerFactory {
>     	public DiagramEventBroker createDiagramEventBroker(TransactionalEditingDomain editingDomain) {
>     		return new DiagramEventBroker();
>     	}
>     }
>     
>     private static DiagramEventBrokerFactory debFactory = new DiagramEventBrokerFactoryImpl();
>     
>     /**
>      * @param newDebFactory
>      */
>     public static void registerDiagramEventBrokerFactory(DiagramEventBrokerFactory newDebFactory) {
>     	debFactory = newDebFactory;
224,225d202
<     public static void startListening(TransactionalEditingDomain editingDomain, DiagramEventBroker diagramEventBroker) {
<         stopListening(editingDomain);
226,226c210,210
<         editingDomain.addResourceSetListener(diagramEventBroker);
---
>             editingDomain.addResourceSetListener(diagramEventBroker);
227,227c211,211
<         instanceMap.put(editingDomain, new WeakReference(diagramEventBroker));
---
>             reference = new WeakReference(diagramEventBroker);
227a212,212
>             instanceMap.put(editingDomain, reference);
569,569c585,585
<     private Set getInterestedNotificationListeners(Notification event,
---
>     final protected Set getInterestedNotificationListeners(Notification event,
