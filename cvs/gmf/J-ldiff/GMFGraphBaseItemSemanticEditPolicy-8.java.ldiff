1,1c1,1
< /**
---
> /*
19a20,20
> import org.eclipse.gmf.runtime.diagram.ui.commands.CommandProxy;
40a42,43
> import org.eclipse.gmf.graphdef.editor.edit.helpers.GMFGraphBaseEditHelper;
> 
57a61,63
> 		if (editHelperContext == null) {
> 			editHelperContext = ViewUtil.resolveSemanticElement((View) getHost().getModel());
> 		}
59,59c65,65
< 		if (elementType == ElementTypeRegistry.getInstance().getType("org.eclipse.gmf.runtime.emf.type.core.default")) {
---
> 		if (elementType == ElementTypeRegistry.getInstance().getType("org.eclipse.gmf.runtime.emf.type.core.default")) { //$NON-NLS-1$
60,60c66,66
< 			GMFGraphDiagramEditorPlugin.getInstance().logInfo("Failed to get element type for " + editHelperContext);
---
> 			GMFGraphDiagramEditorPlugin.getInstance().logInfo("Failed to get element type for " + editHelperContext); //$NON-NLS-1$
62a74,74
> 		Command ehCommand = null;
62a69,72
> 		Command epCommand = getSemanticCommandSwitch(completedRequest);
> 		if (epCommand != null) {
> 			ICommand command = epCommand instanceof EtoolsProxyCommand ? ((EtoolsProxyCommand) epCommand).getICommand() : new CommandProxy(epCommand);
> 			completedRequest.setParameter(GMFGraphBaseEditHelper.EDIT_POLICY_COMMAND, command);
63,63d73
< 		Command semanticHelperCommand = null;
64,64c75,75
< 		if (elementType != null) {
---
> 		if (elementType != null) {
65,65c76,76
< 			ICommand semanticCommand = elementType.getEditCommand(completedRequest);
---
> 			ICommand command = elementType.getEditCommand(completedRequest);
66a78,80
> 				if (!(command instanceof CompositeTransactionalCommand)) {
> 					TransactionalEditingDomain editingDomain = ((IGraphicalEditPart) getHost()).getEditingDomain();
> 					command = new CompositeTransactionalCommand(editingDomain, null).compose(command);
66,66c77,77
< 			if (semanticCommand != null) {
---
> 			if (command != null) {
67,68d77
< 				semanticHelperCommand = new EtoolsProxyCommand(semanticCommand);
< 			}
70,77d73
< 		Command semanticPolicyCommand = getSemanticCommandSwitch(completedRequest);
< 
< 		// combine commands from edit policy and edit helper
< 		if (semanticPolicyCommand == null) {
< 			if (semanticHelperCommand == null) {
< 				return null;
< 			} else {
< 				semanticPolicyCommand = semanticHelperCommand;
78a82,82
> 				ehCommand = new EtoolsProxyCommand(command);
79,81d81
< 		} else {
< 			if (semanticHelperCommand != null) {
< 				semanticPolicyCommand = semanticPolicyCommand.chain(semanticHelperCommand);
84,85d84
< 
< 		// append command to delete view if necessary
91a91,91
> 				TransactionalEditingDomain editingDomain = ((IGraphicalEditPart) getHost()).getEditingDomain();
92,92c92,92
< 				Command deleteViewCommand = new EtoolsProxyCommand(new DeleteCommand(((IGraphicalEditPart) getHost()).getEditingDomain(), (View) getHost().getModel()));
---
> 				Command deleteViewCommand = new EtoolsProxyCommand(new DeleteCommand(editingDomain, (View) getHost().getModel()));
93,93c93,93
< 				semanticPolicyCommand = semanticPolicyCommand.chain(deleteViewCommand);
---
> 				ehCommand = ehCommand == null ? deleteViewCommand : ehCommand.chain(deleteViewCommand);
95,95c95,95
< 			return semanticPolicyCommand;
---
> 			return ehCommand;
211,213d210
< 		TransactionalEditingDomain editingDomain = ((IGraphicalEditPart) getHost()).getEditingDomain();
< 		CompositeTransactionalCommand modelCmd = new CompositeTransactionalCommand(editingDomain, cmd.getLabel());
< 		modelCmd.compose(cmd);
214,214c211,211
< 		return new EtoolsProxyCommand(modelCmd);
---
> 		return new EtoolsProxyCommand(cmd);
