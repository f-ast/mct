2,2c2,2
<  * Copyright (c) 2003, 2006 IBM Corporation and others.
---
>  * Copyright (c) 2003, 2007 IBM Corporation and others.
13a14,14
> import java.util.Arrays;
23,23d23
< import org.eclipse.gef.commands.CompoundCommand;
29,29d28
< import org.eclipse.gmf.runtime.diagram.ui.internal.dialogs.sortfilter.SortFilterRootPreferenceNode;
48,48d46
< import org.eclipse.jface.viewers.LabelProvider;
130,130c128,128
< 	private LabelProvider labelProvider = null;
---
> 	private SortFilterLabelProvider labelProvider = null;
135,140d132
< 	/** State variables */
< 	/** Used to indicate a user gesture changed the compartment children order */
< 	private boolean sortChanged = false;
< 	/** Used to indicate a user gesture changed the visibility of a compartment child */
< 	private boolean filterChanged = false;
< 
150a143,147
> 	private List elementCollectionBackUp = Collections.EMPTY_LIST;
> 	private Sorting _sortingBackUp = _sorting;
> 	private Filtering _filteringBackUp = _filtering;
> 	
> 	
233a231,231
> 				refreshList();
234,234d230
< 				filterItemsFromList();
364a362,362
> 		populateFilterLists();
365,365d361
< 		initFilterLists();
437a435,435
> 		updateFilteringKeysFromControls();
439,439d436
< 			filterItemsFromList();			
440a462,464
> 			
> 		}
> 		updateApplyButton();
441,441d461
< 		filterChanged = true;
458a482,482
> 	private void updateFilteringKeysFromControls() {
459,462d481
< 	/**
< 	 * Updates the table items to reflect the change in the filtering lists.
< 	 */
< 	void filterItemsFromList() {
463a499,502
> 	/**
> 	 * Updates the table items to reflect the change in the filtering lists.
> 	 */
> 	void refreshList() {
464,465d498
< 		String[] nontheFilterStrings = filterList.getItems();
< 		TableItem[] tableItems = tableViewer.getTable().getItems();
466,466c503,503
< 		int filterColumn = findColumnIndexFromProperty(filterAppliesTo);
---
> 		int filterColumn = findColumnIndexFromProperty(filterAppliesTo);
467,467c504,504
< 		if (filterColumn == -1)
---
> 		if (filterColumn == -1)
468,468c505,505
< 			return;
---
> 			return;
469a507,511
> 		for (int j = 0; j < elementCollection.size(); j++) {
> 			String cell = labelProvider.getColumnText(elementCollection.get(j),
> 					filterColumn);
> 			((SortFilterElement) elementCollection.get(j))
> 					.setVisible(!_filteringKeys.contains(cell));
469,469c506,506
< 		// Set the matching items in this list as not visible
---
> 		// Set the matching items in this list as not visible
470,482d506
< 		for (int i = 0; i < theFilterStrings.length; i++) {
< 			for (int j = 0; j < tableItems.length; j++) {
< 				String cell = tableItems[j].getText(filterColumn);
< 				if (theFilterStrings[i].equals(cell)) {
< 					(
< 						(SortFilterElement) tableViewer.getElementAt(
< 							j)).setVisible(
< 						false);
< 					tableViewer.update(
< 						new Object[] { tableViewer.getElementAt(j)},
< 						new String[] { getColumnProperties()[0] });
< 				}
< 			}
483,483c512,512
< 		}
---
> 		}
483a513,513
> 		if (tableViewer != null)
484,492d512
< 		// Set the matching items in this list as visible
< 		for (int i = 0; i < nontheFilterStrings.length; i++) {
< 			for (int j = 0; j < tableItems.length; j++) {
< 				String cell = tableItems[j].getText(filterColumn);
< 				if (nontheFilterStrings[i].equals(cell)) {
< 					(
< 						(SortFilterElement) tableViewer.getElementAt(
< 							j)).setVisible(
< 						true);
493,493c514,514
< 					tableViewer.update(
---
> 			tableViewer.refresh();
494,498d514
< 						new Object[] { tableViewer.getElementAt(j)},
< 						new String[] { getColumnProperties()[0] });
< 				}
< 			}
< 		}
500,500d484
< 		filterChanged = true;
514,515d498
< 		if (getApplyButton() != null)
< 			getApplyButton().setEnabled(sortChanged || filterChanged);
618a618,619
> 		elementCollection = newModel;
> 		createBackUp();
618a497,497
> 	}
619,619d496
< 
677,677c677,677
< 		List model = (ArrayList) ((ArrayList) tableViewer.getInput()).clone();
---
> 		List model = (ArrayList) ((ArrayList) tableViewer.getInput());
684a685,685
> 		tableViewer.refresh();
685,685d684
< 		tableViewer.setInput(model);
686a687,687
> 		_sorting = isSameOrder(elementCollection, baseElements) ? Sorting.NONE_LITERAL
687,687c688,688
< 		_sorting = Sorting.MANUAL_LITERAL;
---
> 				: Sorting.MANUAL_LITERAL;
691a693,693
> 		updateApplyButton();
692,693d692
< 		sortChanged = true;
< 		getApplyButton().setEnabled(sortChanged || filterChanged);
705,705c705,705
< 		List model = (ArrayList) ((ArrayList) tableViewer.getInput()).clone();
---
> 		List model = (ArrayList) ((ArrayList) tableViewer.getInput());
713a714,714
> 		tableViewer.refresh();
714,714d713
< 		tableViewer.setInput(model);
715a716,716
> 		_sorting = isSameOrder(elementCollection, baseElements) ? Sorting.NONE_LITERAL
716,716c717,717
< 		_sorting = Sorting.MANUAL_LITERAL;
---
> 				: Sorting.MANUAL_LITERAL;
720a722,741
> 		updateApplyButton();
> 	}
> 
> 	/**
> 	 * Compares two sort filter element lists based on the equality of data fields
> 	 * only. 
> 	 * @param elements1 <code>List</code> of sort filter elements
> 	 * @param elements2 <code>List</code> of sort filter elements
> 	 * @return <code>true</code> if both lists are e
> 	 */
> 	private boolean isSameOrder(List elements1, List elements2) {
> 		Iterator itr1 = elements1.iterator();
> 		Iterator itr2 = elements2.iterator();
> 		while (itr1.hasNext() && itr2.hasNext()) {
> 			SortFilterElement element1 = (SortFilterElement)itr1.next();
> 			SortFilterElement element2 = (SortFilterElement)itr2.next();
> 			if (!element1.getData().equals(element2.getData()))
> 				return false;
> 		}
> 		return !itr1.hasNext() && !itr2.hasNext();
721,722d721
< 		sortChanged = true;
< 		getApplyButton().setEnabled(sortChanged || filterChanged);
797,799d815
< 		Object[] columnNames = tableViewer.getColumnProperties();
< 		for (int i = 0; i < columnNames.length; i++) {
< 			if (((String) columnNames[i]).equals(property))
818a837,840
> 		baseElements = new ArrayList(updatedSortFilterElements.size());
> 		for (Iterator itr = updatedSortFilterElements.iterator(); itr.hasNext();) {
> 			baseElements.add(new SortFilterElement(((SortFilterElement)itr.next()).getData()));
> 		}
819,819d836
< 		baseElements = updatedSortFilterElements;
873a895,895
> 		createBackUp();
892,901d913
< 		// Reset the filter list if they exist
< 		if (filterStrings != null) {
< 			String[] filterItems = filters.getItems();
< 			for (int i = 0; i < filterItems.length; i++) {
< 				filterList.add(filterItems[i]);
< 				filters.remove(filterItems[i]);
< 				filterChanged = true;
< 			}
< 		}
< 		
903,903d914
< 		_filteringKeys = Collections.EMPTY_LIST;
905a917,921
> 		// Reset the filter list if they exist
> 		if (filterStrings != null) {
> 			if (!_filteringKeys.isEmpty()) {
> 				_filteringKeys = Collections.EMPTY_LIST;
> 				populateFilterLists();
906,920d916
< 		// Set all elements as visible
< 		TableItem[] tableItems = tableViewer.getTable().getItems();
< 		for (int j = 0; j < tableItems.length; j++) {
< 			if (!((SortFilterElement) tableViewer.getElementAt(j))
< 				.isVisible()) {
< 				filterChanged = true;
< 				((SortFilterElement) tableViewer.getElementAt(j)).setVisible(
< 					true);
< 				tableViewer.update(
< 					new Object[] { tableViewer.getElementAt(j)},
< 					new String[] { getColumnProperties()[0] });
< 
< 			}
< 			if (!((SortFilterElement)tableViewer.getElementAt(j)).equals(baseElements.get(j))) {
< 				sortChanged = true;
924,926d924
< 		if (tableViewer.getSorter() != null)
< 			sortChanged = true;
< 		
937,937d934
< 		tableViewer.setInput(baseElements);
938a942,942
> 		updateApplyButton();
939,939d941
< 		getApplyButton().setEnabled(sortChanged || filterChanged);
947,947d949
< 
948,948c950,950
< 		Command filteringCommand = getApplyCommand();
---
> 		Command sortAndFilteringCommand = getApplyCommand();
948a951,953
> 		if (sortAndFilteringCommand != null
> 				&& sortAndFilteringCommand.canExecute()) {
> 			editPart.getRoot().getViewer().getEditDomain().getCommandStack()
949,955d950
< 		if (filteringCommand != null && filteringCommand.canExecute()) {				
< 			editPart
< 				.getRoot()
< 				.getViewer()
< 				.getEditDomain()
< 				.getCommandStack()
< 				.execute(
956a955,955
> 			createBackUp();
956,956c954,954
< 				filteringCommand);
---
> 					.execute(sortAndFilteringCommand);
957a957,957
> 		updateApplyButton();            
961,962d960
< 	 * Returns a <code>Command</code> that set both the sorting and
< 	 * filtering for this particular list compartment.
965a979,980
> 		Command cmd = UnexecutableCommand.INSTANCE;
> 		if (CHILD_PAGE.equals(pageType)) {
966,966d978
< 		if (pageType == CHILD_PAGE) {
969a984,985
> 					for (Iterator itr = elementCollection.iterator(); itr.hasNext();) {
> 						SortFilterElement element = (SortFilterElement) itr.next();
970,972d983
< 					List model = (ArrayList) tableViewer.getInput();
< 					for (int j = 0; j < model.size(); j++) {
< 						SortFilterElement element = (SortFilterElement) model.get(j);
979a993,994
> 				for (Iterator itr = elementCollection.iterator(); itr.hasNext();) {
> 					SortFilterElement element = (SortFilterElement) itr.next();
980,980c935,935
< 				List model = (ArrayList) tableViewer.getInput();			
---
> 		List input = (List)tableViewer.getInput();
980a936,936
> 		input.clear();
981,981c937,937
< 				for (int i = 0; i < model.size(); i++) {
---
> 		for (int i=0; i<baseElements.size(); i++) {
982,982c938,938
< 					SortFilterElement element = (SortFilterElement) model.get(i);
---
> 			input.add(new SortFilterElement( ((SortFilterElement)baseElements.get(i)).getData() ));
982a939,940
> 		}
> 		tableViewer.refresh();
1002a1015,1015
> 			cmd = editPart.getCommand(request);		
1002a437,437
> 			refreshList();			
1003,1007d436
< 			sortChanged = false;
< 			filterChanged = false;
< 			getApplyButton().setEnabled(sortChanged || filterChanged);
< 	
< 			return editPart.getCommand(request);
1008,1008c438,438
< 		} else if (pageType == ROOT_PAGE) {
---
> 		} else if (pageType == ROOT_PAGE) {
1009,1009c439,439
< 			PreferenceManager preferenceManager =
---
> 			PreferenceManager preferenceManager =
1010,1010c440,440
< 				((SortFilterDialog) getContainer()).getPreferenceManager();
---
> 				((SortFilterDialog) getContainer()).getPreferenceManager();
1011,1011c441,441
< 			Iterator nodes =
---
> 			Iterator nodes =
1012,1012c442,442
< 				preferenceManager
---
> 				preferenceManager
1013,1013c443,443
< 					.getElements(PreferenceManager.PRE_ORDER)
---
> 					.getElements(PreferenceManager.PRE_ORDER)
1014,1014c444,444
< 					.iterator();
---
> 					.iterator();
1014a445,445
>             while (nodes.hasNext()) {
1015,1018d444
< 			SortFilterRootPreferenceNode rootNode = null;
< 			CompoundCommand cc = new CompoundCommand(
< 	            DiagramUIMessages.Command_SortFilterCommand);
< 	        while (nodes.hasNext()) {
1019,1019c446,446
< 				PreferenceNode node = (PreferenceNode) nodes.next();
---
> 				PreferenceNode node = (PreferenceNode) nodes.next();
1020,1020c447,447
< 				SortFilterPage page = (SortFilterPage) node.getPage();
---
> 				SortFilterPage page = (SortFilterPage) node.getPage();
1021,1021c448,448
< 				if (page == this) {
---
> 				if (page == this) {
1022,1022d448
< 					rootNode = (SortFilterRootPreferenceNode) node;
1023,1023c449,449
< 					continue;
---
> 					continue;
1024a451,451
> 
1024,1024c450,450
< 				}
---
> 				}
1025,1033d450
< 	
< 				// We must build the page if it is already not done because each
< 				// page
< 				// in the dialog knows how to filter itself.
< 				((SortFilterDialog) rootNode.getPreferenceDialog()).showPage(
< 					node);
< 	
< 				// We set the child's filter criteria to the root's
< 				// criteria if the child is using the same filtering criteria.
1034a453,456
> 					page._filteringKeys = new ArrayList(_filteringKeys.size());
> 					page._filteringKeys.addAll(_filteringKeys);
> 					page._filtering = _filtering;
> 					page.populateFilterLists();
1034,1034c452,452
< 				if (compareFilters(page.getFilterList())) {
---
> 				if (Arrays.equals(filterStrings, page.getFilterList())) {
1035,1036d452
< 					page.setFilterCriteria(filters.getItems());
< 					page.setCriteria(filterList.getItems());
1037a458,460
> 					page.updateApplyButton();
> 				}				
> 				
1037,1037c457,457
< 					page.filterItemsFromList();
---
> 					page.refreshList();
1038a1017,1017
> 		return cmd;
1039,1043d1016
< 				cc.add(page.getApplyCommand());
< 			}
< 	        return cc;
< 		}
< 		return UnexecutableCommand.INSTANCE;
1050,1050c1024,1024
< 	private void initFilterLists() {
---
> 	private void populateFilterLists() {
1051a1026,1027
> 			filterList.removeAll();
> 			filters.removeAll();
1051,1051c1025,1025
< 		if (filterMap != null && !filterMap.isEmpty()) {
---
> 		if (filterMap != null && !filterMap.isEmpty() && filterList != null && filters != null) {
1177,1177c1149,1149
< 				boolean newValue = ((Boolean) value).booleanValue();
---
> 			boolean newValue = ((Boolean) value).booleanValue();
1190,1190d1165
< 						filterChanged = true;
1206a1184,1188
> 				_filtering = newValue ? Filtering.NONE_LITERAL : Filtering.MANUAL_LITERAL;
> 				if (newValue) {
> 					Iterator itr = elementCollection.iterator();
> 					while (itr.hasNext()) {
> 						if (!baseElements.contains(itr.next())) {
1207,1207d1183
< 
1208,1208c1189,1189
< 				_filtering = Filtering.MANUAL_LITERAL;
---
> 							_filtering = Filtering.MANUAL_LITERAL;
1208a1190,1194
> 							break;
> 						}
> 					}
> 				}
> 				updateApplyButton();
1211,1212d1183
< 				filterChanged = true;
< 				getApplyButton().setEnabled(sortChanged || filterChanged);
1318a1301,1302
> 				elementCollection.clear();
> 				elementCollection.addAll(newModel);
1319,1319d1300
< 				_tableViewer.setInput(newModel);
1333a1317,1317
> 				updateApplyButton();
1334,1335d1316
< 				sortChanged = true;
< 				getApplyButton().setEnabled(sortChanged || filterChanged);
1373a1356,1362
> 	/* (non-Javadoc)
> 	 * @see org.eclipse.jface.preference.PreferencePage#updateApplyButton()
> 	 */
> 	protected void updateApplyButton() {
> 		if (getApplyButton() != null)
> 			getApplyButton().setEnabled(isValid() && isDirty());
> 	}
1374,1384d1355
< 	/**
< 	 * Returns <code>true</code> if the filter criteria are the same and
< 	 * <code>false</code> otherwise.
< 	 * @param other
< 	 * @return <code>true</code> if the filter criteria are the same
< 	 */
< 	private boolean compareFilters(String[] other) {
< 		if (filterStrings == null
< 			|| other == null
< 			|| filterStrings.length != other.length)
< 			return false;
1385a1364,1369
> 	/* (non-Javadoc)
> 	 * @see org.eclipse.jface.preference.PreferencePage#createControl(org.eclipse.swt.widgets.Composite)
> 	 */
> 	public void createControl(Composite parent) {
> 		super.createControl(parent);
> 		updateApplyButton();
1386,1386c816,816
< 		for (int i = 0; i < filterStrings.length; i++) {
---
> 		for (int i = 0; i < collectionColumns.size(); i++) {
1386a817,817
> 			if (((SortFilterCollectionColumn)collectionColumns.get(i)).getCaption().equals(property))
1387,1388d816
< 			if (filterStrings[i] != other[i])
< 				return false;
1389a1371,1379
> 	
> 	/**
> 	 * Determines whether the page contains changes that can be applied.
> 	 * @return <code>true</code> if page is dirty
> 	 */
> 	protected boolean isDirty() {
> 		if (pageType == ROOT_PAGE
> 			|| _filteringBackUp != _filtering
> 			|| _sortingBackUp != _sorting)
1390a1381,1382
> 		
> 		return !elementCollection.equals(elementCollectionBackUp);
1393a1386,1387
> 	 * Creates the back up of the initial data to determine whether the page
> 	 * has applicable changes later on.
1394,1394c961,961
< 	 * Creates the command that needs to be executed for this page when "Ok" is
---
> 	 * Creates the command that needs to be executed for this page when "Ok" is
1395,1395c962,962
< 	 * pressed. It's different from {@link #getApplyCommand()}, because it checks
---
> 	 * pressed. It's different from {@link #getApplyCommand()}, because it checks
1396,1396c963,963
< 	 * whether the page is dirty or not.
---
> 	 * whether the page is dirty or not.
1397a965,975
> 	 */
> 	public Command getCommand() {
> 		if (isDirty())
> 			return getApplyCommand();
> 		return null;
> 	}
> 	
> 	/**
> 	 * Returns a <code>Command</code> that set both the sorting and filtering
> 	 * for this particular list compartment.
> 	 * 
1397,1397c964,964
< 	 * @return <code>Command</code> to be executed per this page
---
> 	 * @return <code>Command</code> to be executed per this page
1398a1389,1397
> 	private void createBackUp() {
> 		_filteringBackUp = _filtering;
> 		_sortingBackUp = _sorting;
> 		elementCollectionBackUp = new ArrayList(elementCollection.size());
> 		for (Iterator itr = elementCollection.iterator(); itr.hasNext();) {
> 			SortFilterElement element = (SortFilterElement) itr.next();
> 			elementCollectionBackUp.add(new SortFilterElement(element
> 					.isVisible(), element.getData()));
> 		}
1399,1402d1388
< 	public Command getCommand() {
< 		if (filterChanged || sortChanged)
< 			return getApplyCommand();
< 		return null;
