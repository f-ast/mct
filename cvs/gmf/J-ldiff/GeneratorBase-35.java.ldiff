338a339,342
> 				ICompilationUnit workingCopy = null;
> 				try {
> 					workingCopy = cu.getWorkingCopy(new SubProgressMonitor(pm, 1));
> 					final String oldContents = workingCopy.getSource();
339,339d338
< 				final String oldContents = cu.getSource();
340,340c343,343
<                 IImportDeclaration[] declaredImports = cu.getImports();
---
> 	                IImportDeclaration[] declaredImports = workingCopy.getImports();
341,341c344,344
< 				cu.getBuffer().setContents(genText);
---
> 	                workingCopy.getBuffer().setContents(genText);
341a345,345
> 	                workingCopy.reconcile(ICompilationUnit.NO_AST, false, null, null);
348,348c352,352
< 					getImportsPostrocessor().organizeImports(cu, declaredImportsAsStrings, new SubProgressMonitor(pm, 1));
---
> 						getImportsPostrocessor().organizeImports(workingCopy, declaredImportsAsStrings, new SubProgressMonitor(pm, 1));
350,350c354,354
< 					cu.save(new SubProgressMonitor(pm, 1), true); // save to investigate contents
---
> 						workingCopy.commitWorkingCopy(true, new SubProgressMonitor(pm, 1)); // save to investigate contents
353,353c357,357
< 				genText = mergeJavaCode(oldContents, cu.getSource(), new SubProgressMonitor(pm, 1));
---
> 					genText = mergeJavaCode(oldContents, workingCopy.getSource(), new SubProgressMonitor(pm, 1));
356a361,361
> 						workingCopy.reconcile(ICompilationUnit.NO_AST, false, null, null);
356,356c360,360
< 					cu.getBuffer().setContents(genText);
---
> 						workingCopy.getBuffer().setContents(genText);
357,357c362,362
< 					cu.save(new SubProgressMonitor(pm, 1), true);
---
> 						workingCopy.commitWorkingCopy(true, new SubProgressMonitor(pm, 1));
358a364,364
> 						// discard changes - would happen in finally, nothing else to do
359,359d363
< 					cu.getBuffer().close(); // discard changes
361a367,369
> 				} finally {
> 					workingCopy.discardWorkingCopy();
> 				}
