15,15d14
< import java.util.HashMap;
22a22,22
> import org.eclipse.core.runtime.IExtension;
25,25c646,646
< 
---
> 
122,122c680,680
< 
---
> 
149,149c147,147
< 					Log.info(corePlugin, CommonCoreStatusCodes.OK, "Activating provider '" + getElement().getAttribute(A_CLASS) + "'..."); //$NON-NLS-1$ //$NON-NLS-2$
---
> 					Log.info(corePlugin, CommonCoreStatusCodes.OK, "Activating provider '" + element.getAttribute(A_CLASS) + "'..."); //$NON-NLS-1$ //$NON-NLS-2$
150,150d147
< 					provider =
151,151c148,148
< 						(IProvider) getElement().createExecutableExtension(
---
> 					provider = (IProvider)element.createExecutableExtension(A_CLASS);
152,152d148
< 							A_CLASS);
154,154c150,150
< 					Trace.trace(corePlugin, CommonCoreDebugOptions.SERVICES_ACTIVATE, "Provider '" + String.valueOf(provider) + "' activated."); //$NON-NLS-1$ //$NON-NLS-2$
---
> 					Trace.trace(corePlugin, CommonCoreDebugOptions.SERVICES_ACTIVATE, "Provider '" + provider + "' activated."); //$NON-NLS-1$ //$NON-NLS-2$
180,180c176,176
< 				IConfigurationElement[] elements =
---
> 				IConfigurationElement[] elements = element.getChildren(E_POLICY);
181,181d176
< 					getElement().getChildren(E_POLICY);
200,201d194
< 							policy =
< 								(IProviderPolicy) getElement()
202,202c195,195
< 									.createExecutableExtension(
---
> 							policy = (IProviderPolicy)element.createExecutableExtension(E_POLICY);
203,203d195
< 									E_POLICY);
205,205c197,197
< 							Trace.trace(corePlugin, CommonCoreDebugOptions.SERVICES_ACTIVATE, "Provider policy '" + String.valueOf(policy) + "' activated."); //$NON-NLS-1$ //$NON-NLS-2$
---
> 							Trace.trace(corePlugin, CommonCoreDebugOptions.SERVICES_ACTIVATE, "Provider policy '" + policy + "' activated."); //$NON-NLS-1$ //$NON-NLS-2$
273,273c265,265
< 	private static final int cacheSize;
---
> 	private static final int priorityCount;
274a267,267
> 	// Initialize priorityCount.
275,275d266
< 	// Initialize the cacheSize.
288,288c280,280
< 		cacheSize = maxOrdinal + 1;
---
> 		priorityCount = maxOrdinal + 1;
298,298c290,290
< 	 * The list of registered providers.
---
> 	 * The lists of registered providers.
300,300c292,292
< 	private final Map providers = new HashMap();
---
> 	private final ArrayList[] providers;
360,360c352,352
< 			cache = new Map[cacheSize];
---
> 			cache = new Map[priorityCount];
362,362c354,354
< 			for (int ordinal = cacheSize; --ordinal >= 0;) {
---
> 			for (int ordinal = priorityCount; --ordinal >= 0;) {
368a361,365
> 
> 		providers = new ArrayList[priorityCount];
> 
> 		for (int ordinal = priorityCount; --ordinal >= 0;)
> 			providers[ordinal] = new ArrayList(0);
432,432c429,429
< 			for (int ordinal = cacheSize; --ordinal >= 0;) {
---
> 			for (int ordinal = priorityCount; --ordinal >= 0;) {
447,447c444,444
< 	List getProviders(ProviderPriority priority) {
---
> 	final List getProviders(ProviderPriority priority) {
448,451d444
< 		List result = (List) providers.get(priority);
< 
< 		if (null == result) {
< 			result = new ArrayList();
452,452c445,445
< 			providers.put(priority, result);
---
> 		return providers[priority.getOrdinal()];
453,455d445
< 		}
< 
< 		return result;
485,485d474
< 		if (!isOptimized()) {
487a478,478
> 			Object cachingKey = getCachingKey(operation);
489,489c480,480
< 			providerList = (List) map.get(getCachingKey(operation));
---
> 			providerList = (List)map.get(cachingKey);
490a482,491
> 			if (null != providerList) {
> 				if (optimistic)
> 					return providerList;
> 
> 				int n = providerList.size();
> 
> 				if (n != 0) {
> 					for (int i = 0;;) {
> 						IProvider provider = (IProvider)providerList.get(i);
> 
491,496d481
< 			if (!isOptimistic() && null != providerList) {
< 				if (providerList.isEmpty()) {
< 					providerList = null;
< 				} else {
< 					for (Iterator i = providerList.iterator(); i.hasNext();) {
< 						IProvider provider = (IProvider) i.next();
497,497c492,492
< 						if (!provider.provides(operation)) {
---
> 						if (!provider.provides(operation))
498,498d492
< 							providerList = null;
499a494,496
> 
> 						if (++i == n)
> 							return providerList;
500,500d493
< 						}
505,505c475,475
< 			if (null == providerList) {
---
> 		if (null == cache) {
507,507c502,502
< 				map.put(getCachingKey(operation), providerList);
---
> 			map.put(cachingKey, providerList);
508,508d502
< 			}
520,520d513
< 		List allProviders = new ArrayList();
521a514,523
> 		int i;
> 		int n = priorityCount;
> 		int total;
> 
> 		for (i = n, total = 0; --i >= 0;)
> 			total += providers[i].size();
> 
> 		List allProviders = new ArrayList(total);
> 
> 		for (i = 0; i < n; ++i)
522,522d513
< 		for (Iterator i = providers.values().iterator(); i.hasNext();) {
523,523c524,524
< 			allProviders.addAll((List)i.next());
---
> 			allProviders.addAll(providers[i]);
524,524d524
< 		}
543a545,546
> 		int ordinal = priority.getOrdinal();
> 
545,545c548,548
< 			cache[priority.getOrdinal()].clear();
---
> 			cache[ordinal].clear();
548,548c551,551
< 		getProviders(priority).add(provider);
---
> 		providers[ordinal].add(provider);
560a564,564
> 		for (int i = 0, n = priorityCount; i < n; ++i) {
561,561d563
< 		for (Iterator i = providers.values().iterator(); i.hasNext();) {
562,562c565,565
< 			if (((List) i.next()).remove(provider)) {
---
> 			if (providers[i].remove(provider)) {
593,593c596,596
< 					"Operation '" + String.valueOf(operation) + "' executed using strategy '" + String.valueOf(strategy) + "'."); //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$
---
> 					"Operation '" + operation + "' executed using strategy '" + strategy + "'."); //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$
634a638,644
> 		for (int priority = 0, n = priorityCount; priority < n; ++priority)
> 		{
> 			List providerList = providers[priority];
> 			int providerCount = providerList.size();
> 
> 			for (int provider = 0; provider < providerCount; ++provider)
> 				if (((IProvider)providerList.get(provider)).provides(operation))
635,637d637
< 		for (Iterator list = providers.values().iterator(); list.hasNext();) {
< 			for (Iterator provider = ((List) list.next()).iterator(); provider.hasNext();) {
< 				if (((IProvider) provider.next()).provides(operation)) {
639,640d645
< 				}
< 			}
665,665c671,671
< 		for (int i = 0; i < ExecutionStrategy.PRIORITIES.length; i++) {
---
> 		for (int i = 0; i < ExecutionStrategy.PRIORITIES.length; ++i) {
667a674,676
> 			int providerCount = providerList.size();
> 
> 			for (int provider = 0; provider < providerCount; ++provider)
668,668d673
< 			for (Iterator provider = providerList.iterator(); provider.hasNext();) {
669,669c677,677
< 				if (((IProvider) provider.next()).provides(operation)) {
---
> 				if (((IProvider)providerList.get(provider)).provides(operation))
672,673d679
< 			}
< 		}
690a698,712
> 	 * Registers the service providers described by the extensions of the
> 	 * specified namespace and extension point name with this service.
> 	 *
> 	 * @param namespace the namespace for the given extension point 
> 	 *		(e.g. <code>"org.eclipse.gmf.runtime.common.core"</code>)
> 	 * @param extensionPointName the simple identifier of the 
> 	 *		extension point (e.g. <code>"parserProviders"</code>)
> 	 */
> 	public final void configureProviders(String namespace, String extensionPointName) {
> 		configureProviders(Platform.getExtensionRegistry()
> 									.getExtensionPoint(namespace, extensionPointName)
> 									.getConfigurationElements());
> 	}
> 
> 	/**
700a723,728
> 		{
> 			IConfigurationElement element = elements[i];
> 
> 			try
> 			{
> 				addProvider(ProviderPriority.parse(getPriority(element)),
700,700c722,722
< 		for (int i = 0; i < elements.length; i++) {
---
> 		for (int i = 0; i < elements.length; ++i)
701,703d722
< 			addProvider(
< 				ProviderPriority.parse(
< 					getPriority(elements[i])),
704a730,746
> 			}
> 			finally
> 			{
> 				if (Trace.shouldTrace(CommonCorePlugin.getDefault(), CommonCoreDebugOptions.SERVICES_CONFIG))
> 				{
> 					IExtension extension = element.getDeclaringExtension();
> 					String identifier = extension.getUniqueIdentifier();
> 
> 					if (identifier == null)
> 						identifier = String.valueOf(extension.getNamespace());
> 
> 					extension.getExtensionPointUniqueIdentifier();
> 
> 					Trace.trace(CommonCorePlugin.getDefault(), CommonCoreDebugOptions.SERVICES_CONFIG,
> 							"Provider of '" + extension.getExtensionPointUniqueIdentifier() //$NON-NLS-1$
> 								+ "' configured from extension '" + identifier + "'."); //$NON-NLS-1$ //$NON-NLS-2$
> 				}
704,704c729,729
< 				newProviderDescriptor(elements[i]));
---
> 						newProviderDescriptor(element));
705,705d729
< 			Trace.trace(CommonCorePlugin.getDefault(), CommonCoreDebugOptions.SERVICES_CONFIG, "Provider configured from extension '" + String.valueOf(elements[i].getDeclaringExtension()) + "'."); //$NON-NLS-1$ //$NON-NLS-2$
708a750,753
> 		for (int i = priorityCount; --i >= 0;)
> 			providers[i].trimToSize();
> 	}
> 
