29,29c32,32
< import org.osgi.framework.Bundle;
---
> import org.osgi.framework.Bundle;
30,30d32
< 
852,854d850
< 			Bundle bundle = getPluginBundle(parameterPluginID);
< 			if(bundle==null)
< 				return Object.class;
855a852,855
> 			Class clazz = loadClass(parameterClassName,parameterPluginID);
> 			if(clazz==null)
> 				clazz =  Object.class;
> 			return clazz;
856,856d851
< 			return loadClass(parameterClassName, bundle);
1144,1149d1142
< 	protected static Class loadClass(
< 		String className,
< 		Bundle bundle) {
< 			/*
< 			WeakReference ref = (WeakReference) successLookupTable.get(className);
< 			Class found = (ref != null) ? (Class) ref.get() : null;
1152a1172,1173
> 				successLookupTable.remove(keyString);
> 			if (!failureLookupTable.contains(keyString)) {
1153,1155d1171
< 					successLookupTable.remove(className);
< 				Collection classNames = (Collection)failureLookupTable.get(bundle);
< 				if (classNames == null || !classNames.contains(className)) {
1157a1178,1180
> 						successLookupTable.put(keyString, new WeakReference(found));
> 					}else{
> 						failureLookupTable.add(keyString);
1158,1162d1177
< 						successLookupTable.put(className, new WeakReference(found));
< 					} catch (ClassNotFoundException e) {
< 						if (classNames == null) {
< 							classNames = new ArrayList();
< 							failureLookupTable.put(bundle, classNames);
1163a1182,1183
> 				} catch (ClassNotFoundException e) {
> 					failureLookupTable.add(keyString);
1164,1164d1181
< 						classNames.add(className);
1168a1143,1143
> 	 /*protected static Class loadClass(String className, Bundle bundle) {
1169,1169d1142
< */		
1170,1170c1144,1144
< 		try {
---
> 		try {
1171,1171c1145,1145
< 			return bundle.loadClass(className);
---
> 			return bundle.loadClass(className);
1172,1172c1146,1146
< 		} catch (ClassNotFoundException e) {
---
> 		} catch (ClassNotFoundException e) {
1173,1173c1147,1147
< 			return null;
---
> 			return null;
1174,1174c1148,1148
< 		}
---
> 		}
1174a1149,1149
> 	}*/
1176a1190,1190
> 	
1298a1151,1165
> 	/**
> 	 * A utility method to load a class using its name and a given class loader.
> 	 * 
> 	 * @param className
> 	 *            The class name
> 	 * @param bundle
> 	 *            The class loader
> 	 * @return The loaded class or <code>null</code> if could not be loaded
> 	 */
> 	protected static Class loadClass(String className, String pluginId) {
> 		StringBuffer keyStringBuf = new StringBuffer(className.length()
> 			+ pluginId.length() + 2); // 2 is for . and extra.
> 		keyStringBuf.append(pluginId);
> 		keyStringBuf.append('.');
> 		keyStringBuf.append(className);
1298a1313,1313
> 			Class theClass = loadClass(className,pluginId);
1299,1302d1150
< 			StringBuffer keyStringBuf = new StringBuffer(className.length() + pluginId.length() + 2); // 2 is for . and extra.
< 			keyStringBuf.append(pluginId);
< 			keyStringBuf.append('.');
< 			keyStringBuf.append(className);
1303,1303c1166,1166
< 			String keyString = keyStringBuf.toString();
---
> 		String keyString = keyStringBuf.toString();
1304,1309d1166
< 			
< 			// Return null if this failed before
< 			if(failureLookupTable.contains(keyString))
< 				return null;
< 			
< 			// Check to see if this key string is in the success table.
1310,1310c1167,1167
< 			WeakReference loadedClassRef = (WeakReference)successLookupTable.get(keyString);
---
> 		WeakReference ref = (WeakReference) successLookupTable.get(keyString);
1310a1168,1168
> 		Class found = (ref != null) ? (Class) ref.get()
1311,1317d1167
< 			Class theClass = null;
< 			if(loadedClassRef != null)
< 				theClass = (Class)loadedClassRef.get();
< 			
< 			if(theClass == null) {
< 				Bundle bundle = (pluginId != null) 
< 						? getPluginBundle(pluginId)
1318,1318c1169,1169
< 						: null;
---
> 			: null;
1319,1329d1169
< 						
< 				if (bundle == null)
< 					return null;
< 				theClass = loadClass(className, bundle);
< 				
< 				if(theClass != null)
< 					successLookupTable.put(keyString, new WeakReference(theClass));
< 				else
< 					failureLookupTable.add(keyString);
< 			}
< 			
1413a1175,1175
> 					Bundle bundle = getPluginBundle(pluginId);
1414,1414d1174
< 		Bundle bundle = getPluginBundle(staticMethodDescriptor.getPluginID());
1415,1415c1176,1176
< 		if (bundle == null)
---
> 					if (bundle!=null){
1416,1416d1176
< 			return null;
1417a1399,1401
> 									staticMethodDescriptor.getPluginID());
> 		if (theClass==null)
> 			return null;
1418,1418d1398
< 								   bundle);
