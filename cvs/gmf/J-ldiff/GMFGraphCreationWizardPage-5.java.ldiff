2,2c2,2
<  * Copyright (c) 2006 Borland Software Corporation and others.
---
>  * Copyright (c) 2006, 2007 Borland Software Corporation and others.
13,15d12
< import java.io.InputStream;
< 
< import org.eclipse.core.resources.IFile;
17,19d13
< import org.eclipse.core.runtime.IProgressMonitor;
< import org.eclipse.gmf.runtime.diagram.ui.resources.editor.ide.wizards.EditorWizardPage;
< import org.eclipse.gmf.runtime.diagram.ui.resources.editor.util.DiagramFileCreator;
21,21c17,17
< import org.eclipse.ui.IWorkbench;
---
> import org.eclipse.osgi.util.NLS;
22a19,19
> import org.eclipse.ui.dialogs.WizardNewFileCreationPage;
22,22c18,18
< import org.eclipse.ui.IWorkbenchWindow;
---
> import org.eclipse.swt.widgets.Composite;
24,24c14,14
< import org.eclipse.core.resources.ResourcesPlugin;
---
> import org.eclipse.core.runtime.Path;
24a15,15
> import org.eclipse.emf.common.util.URI;
25a26,29
> 	/**
> 	 * @generated
> 	 */
> 	private final String fileExtension;
26,26d25
< import org.eclipse.gmf.graphdef.editor.edit.parts.CanvasEditPart;
30a34,37
> 	public GMFGraphCreationWizardPage(String pageName, IStructuredSelection selection, String fileExtension) {
> 		super(pageName, selection);
> 		this.fileExtension = fileExtension;
> 	}
30a21,23
> /**
>  * @generated
>  */
31,31c24,24
< public class GMFGraphCreationWizardPage extends EditorWizardPage {
---
> public class GMFGraphCreationWizardPage extends WizardNewFileCreationPage {
33a40,41
> 	 * Override to create files with this extension.
> 	 * 
36,39d43
< 	public GMFGraphCreationWizardPage(IWorkbench workbench, IStructuredSelection selection) {
< 		super("CreationWizardPage", workbench, selection); //$NON-NLS-1$
< 		setTitle("Create GMFGraph Diagram");
< 		setDescription("Create a new GMFGraph diagram.");
44a51,52
> 	public URI getURI() {
> 		return URI.createPlatformResourceURI(getFilePath().toString());
45,47d50
< 	public IFile createAndOpenDiagram(IPath containerPath, String fileName, InputStream initialContents, String kind, IWorkbenchWindow dWindow, IProgressMonitor progressMonitor, boolean saveDiagram) {
< 		return GMFGraphDiagramEditorUtil.createAndOpenDiagram(getDiagramFileCreator(), containerPath, fileName, initialContents, kind, dWindow, progressMonitor, isOpenNewlyCreatedDiagramEditor(),
< 				saveDiagram);
52a58,67
> 	protected IPath getFilePath() {
> 		IPath path = getContainerFullPath();
> 		if (path == null) {
> 			path = new Path(""); //$NON-NLS-1$
> 		}
> 		String fileName = getFileName();
> 		if (fileName != null) {
> 			path = path.append(fileName);
> 		}
> 		return path;
53,54d57
< 	protected String getDefaultFileName() {
< 		return "default"; //$NON-NLS-1$
59a73,96
> 	private String getUniqueFileName(IPath containerFullPath, String fileName) {
> 		if (containerFullPath == null) {
> 			containerFullPath = new Path(""); //$NON-NLS-1$
> 		}
> 		if (fileName == null || fileName.trim().length() == 0) {
> 			fileName = "default"; //$NON-NLS-1$
> 		}
> 		IPath filePath = containerFullPath.append(fileName);
> 		String extension = getExtension();
> 		if (extension != null && !extension.equals(filePath.getFileExtension())) {
> 			filePath = filePath.addFileExtension(extension);
> 		}
> 
> 		extension = filePath.getFileExtension();
> 		fileName = filePath.removeFileExtension().lastSegment();
> 		int i = 1;
> 		while (GMFGraphDiagramEditorUtil.exists(filePath)) {
> 			i++;
> 			filePath = containerFullPath.append(fileName + i);
> 			if (extension != null) {
> 				filePath = filePath.addFileExtension(extension);
> 			}
> 		}
> 		return filePath.lastSegment();
60,61d72
< 	public DiagramFileCreator getDiagramFileCreator() {
< 		return GMFGraphDiagramFileCreator.getInstance();
66a102,105
> 	public void createControl(Composite parent) {
> 		super.createControl(parent);
> 		setFileName(getUniqueFileName(getContainerFullPath(), getFileName()));
> 		setPageComplete(validatePage());
67,67c44,44
< 	protected String getDiagramKind() {
---
> 	protected String getExtension() {
67a45,45
> 		return fileExtension;
68,68d44
< 		return CanvasEditPart.MODEL_ID;
75,75c112,112
< 		if (super.validatePage()) {
---
> 		if (!super.validatePage()) {
76,77d112
< 			String fileName = getFileName();
< 			if (fileName == null) {
79a115,117
> 		String extension = getExtension();
> 		if (extension != null && !getFilePath().toString().endsWith("." + extension)) {
> 			setErrorMessage(NLS.bind("File name should have ''{0}'' extension.", extension));
80,84d114
< 			// appending file extension to correctly process file names including "." symbol
< 			IPath path = getContainerFullPath().append(getDiagramFileCreator().appendExtensionToFileName(fileName));
< 			path = path.removeFileExtension().addFileExtension("gmfgraph"); //$NON-NLS-1$
< 			if (ResourcesPlugin.getWorkspace().getRoot().exists(path)) {
< 				setErrorMessage("Model File already exists: " + path.lastSegment());
89,91d121
< 		return false;
< 	}
< 
