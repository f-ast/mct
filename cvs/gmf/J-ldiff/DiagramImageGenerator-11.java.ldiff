24,24d23
< import org.eclipse.draw2d.geometry.PrecisionRectangle;
177,178d175
< 		Rectangle originalBounds = new PrecisionRectangle(new Rectangle(calculateImageRectangle(editParts)));
< 		mm.LPtoDP(originalBounds);
179a177,177
> 		ConstrainedImageRenderingData data = getConstrainedImageRenderingData(editParts, maxDeviceWidth, maxDeviceHeight, useMargins);
180,182d176
< 		int deviceMargins = mm.LPtoDP(getImageMargin());
< 		int threshold = useMargins ? deviceMargins : 0; 
< 		double xScalingFactor = 1.0, yScalingFactor = xScalingFactor;
183a179,179
> 		awtImage = new BufferedImage(data.imageWidth, data.imageHeight, BufferedImage.TYPE_4BYTE_ABGR_PRE);
184,203d178
< 		originalBounds.shrink(deviceMargins, deviceMargins);
< 		
< 		if (maxDeviceWidth > threshold) {
< 			xScalingFactor = (maxDeviceWidth  - threshold - threshold)/ (originalBounds.preciseWidth());
< 		}
< 		if (maxDeviceHeight > threshold) {
< 			yScalingFactor = (maxDeviceHeight - threshold - threshold) / (originalBounds.preciseHeight());
< 		}
< 		
< 		double scalingFactor = Math.min(Math.min(xScalingFactor, yScalingFactor), 1);
< 		
< 		int imageWidth = originalBounds.width + threshold + threshold;
< 		int imageHeight = originalBounds.height + threshold + threshold;
< 		
< 		if (scalingFactor < 1) {
< 			imageWidth = (int) Math.round(originalBounds.preciseWidth() * scalingFactor) + threshold + threshold;
< 			imageHeight = (int) Math.round(originalBounds.preciseHeight() * scalingFactor) + threshold + threshold;
< 		}
< 		
< 		awtImage = new BufferedImage(imageWidth, imageHeight, BufferedImage.TYPE_4BYTE_ABGR_PRE);
227,227c203,203
< 				new org.eclipse.swt.graphics.Rectangle(0, 0, imageWidth, imageHeight));
---
> 				new org.eclipse.swt.graphics.Rectangle(0, 0, data.imageWidth, data.imageHeight));
233a210,210
> 		g2d.translate(data.margin, data.margin);
234,234d209
< 		g2d.translate(threshold, threshold);
235,235c211,211
< 		mapModeGraphics.scale(scalingFactor);
---
> 		mapModeGraphics.scale(data.scalingFactor);
237,237c213,213
< 		Point location = new PrecisionPoint(originalBounds.preciseX(), originalBounds.preciseY());
---
> 		Point location = new PrecisionPoint(data.imageOriginalBounds.preciseX(), data.imageOriginalBounds.preciseY());
