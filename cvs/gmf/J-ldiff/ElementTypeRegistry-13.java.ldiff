73a74,74
> 	 * and each value is a map, whose key is an EClass name and whose value is a
73,73c73,73
< 	 * Metamodel type descriptors stored by EClass. Each value is a collection of
---
> 	 * Metamodel type descriptors stored by nsURI. Each key is a namespace URI
74,74c75,75
< 	 * MetamodelTypeDescriptors.
---
> 	 * collection of MetamodelTypeDescriptors.
76,76c77,77
< 	private final Map metamodelTypeDescriptorsByEClass;
---
> 	private final Map metamodelTypeDescriptorsByNsURI;
108,108c109,109
< 		metamodelTypeDescriptorsByEClass = new HashMap();
---
> 		metamodelTypeDescriptorsByNsURI = new HashMap();
593,593c944,944
< 		Collection descriptors = (Collection) metamodelTypeDescriptorsByEClass
---
> 		Collection descriptors = (Collection) metamodelTypeDescriptorsByEClass.get(eClassName);
594,594d944
< 				.get(eClass);
611a616,617
> 				// same nsURI is assumed because we're looking at supertypes of the eclass
> 				descriptors = metamodelTypeDescriptorsByEClass != null ? (Collection) metamodelTypeDescriptorsByEClass
612,612d615
< 				descriptors = (Collection) metamodelTypeDescriptorsByEClass
613,613c618,618
< 						.get(nextEClass);
---
> 						.get(nextEClass.getName())
613a619,619
> 						: null;
926a933,942
> 		String nsURI = typeDescriptor.getNsURI();
> 		String eClassName = typeDescriptor.getEClassName();
> 
> 		Map metamodelTypeDescriptorsByEClass = (Map) metamodelTypeDescriptorsByNsURI
> 				.get(nsURI);
> 
> 		if (metamodelTypeDescriptorsByEClass == null) {
> 			metamodelTypeDescriptorsByEClass = new HashMap();
> 			metamodelTypeDescriptorsByNsURI.put(nsURI, metamodelTypeDescriptorsByEClass);
> 		}
927,927d932
< 		EClass eClass = typeDescriptor.getEClass();
928a594,596
> 		Map metamodelTypeDescriptorsByEClass = (Map) metamodelTypeDescriptorsByNsURI
> 				.get(eClass.getEPackage().getNsURI());
> 		Collection descriptors = metamodelTypeDescriptorsByEClass != null ? (Collection) metamodelTypeDescriptorsByEClass
929,929d593
< 		Collection descriptors = (Collection) metamodelTypeDescriptorsByEClass
930a598,598
> 				: null;
930,930c597,597
< 				.get(eClass);
---
> 				.get(eClass.getName())
934,934c948,948
< 			metamodelTypeDescriptorsByEClass.put(eClass, descriptors);
---
> 			metamodelTypeDescriptorsByEClass.put(eClassName, descriptors);
