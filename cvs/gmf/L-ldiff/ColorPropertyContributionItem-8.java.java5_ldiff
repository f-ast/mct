19,19c25,25
< import org.eclipse.gmf.runtime.diagram.ui.internal.properties.Properties;
---
> import org.eclipse.gmf.runtime.diagram.ui.internal.properties.Properties;
21,21c23,23
< import org.eclipse.gmf.runtime.diagram.ui.preferences.IPreferenceConstants;
---
> import org.eclipse.gmf.runtime.diagram.ui.editparts.IGraphicalEditPart;
24a11,11
> import org.eclipse.emf.ecore.EStructuralFeature;
24a29,29
> import org.eclipse.gmf.runtime.emf.core.util.PackageUtil;
25,25d10
< import org.eclipse.jface.preference.IPreferenceStore;
26,26c12,12
< 
---
> 
27a14,14
> 
27,27c13,13
< import org.eclipse.jface.preference.PreferenceConverter;
---
> import org.eclipse.gef.EditPart;
150,150d151
<     private String preferenceId;
161,161c162,162
<     public ColorPropertyContributionItem (IWorkbenchPage workbenchPage, String id, String propertyId, String propertyName, String preferenceId, String toolTipText, ImageData basicImageData, ImageData disabledBasicImageData) {
---
>     public ColorPropertyContributionItem (IWorkbenchPage workbenchPage, String id, String propertyId, String propertyName, String toolTipText, ImageData basicImageData, ImageData disabledBasicImageData) {
165,165d165
<         this.preferenceId = preferenceId;
382a383,394
>         for (Iterator iter = getOperationSet ().iterator ();
>         iter.hasNext ();) {
>             EditPart editpart = (EditPart) iter.next ();
>             if (editpart instanceof IGraphicalEditPart) {
>                 final EStructuralFeature feature = (EStructuralFeature) PackageUtil.getElement (getPropertyId ());
>                 Object preferredValue = ((IGraphicalEditPart) editpart).getPreferredValue (feature);
>                 if (preferredValue instanceof Integer) {
>                     return FigureUtilities.integerToRGB ((Integer) preferredValue);
>                 }
>             }
>         }
>         return DEFAULT_PREF_COLOR;
383,387d382
<         IPreferenceStore store = (IPreferenceStore) getDiagramEditPart ().getDiagramPreferencesHint ().getPreferenceStore ();
<         RGB color = null;
<         if (preferenceId != null) color = PreferenceConverter.getColor (store, preferenceId);
< 
<         return color != null ? color : DEFAULT_PREF_COLOR;
399,399c406,406
<         return new ColorPropertyContributionItem (workbenchPage, ActionIds.CUSTOM_FONT_COLOR, Properties.ID_FONTCOLOR, propertyName, null, toolTipText, basicImageData, disabledBasicImageData);
---
>         return new ColorPropertyContributionItem (workbenchPage, ActionIds.CUSTOM_FONT_COLOR, Properties.ID_FONTCOLOR, propertyName, toolTipText, basicImageData, disabledBasicImageData);
407,407c414,414
<         return new ColorPropertyContributionItem (workbenchPage, ActionIds.CUSTOM_LINE_COLOR, Properties.ID_LINECOLOR, propertyName, IPreferenceConstants.PREF_LINE_COLOR, toolTipText, basicImageData, disabledBasicImageData);
---
>         return new ColorPropertyContributionItem (workbenchPage, ActionIds.CUSTOM_LINE_COLOR, Properties.ID_LINECOLOR, propertyName, toolTipText, basicImageData, disabledBasicImageData);
415,415c422,422
<         return new ColorPropertyContributionItem (workbenchPage, ActionIds.CUSTOM_FILL_COLOR, Properties.ID_FILLCOLOR, propertyName, IPreferenceConstants.PREF_FILL_COLOR, toolTipText, basicImageData, disabledBasicImageData);
---
>         return new ColorPropertyContributionItem (workbenchPage, ActionIds.CUSTOM_FILL_COLOR, Properties.ID_FILLCOLOR, propertyName, toolTipText, basicImageData, disabledBasicImageData);
