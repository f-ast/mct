62a25,25
> import org.eclipse.core.runtime.Assert;
63,63d24
< import org.eclipse.jface.util.Assert;
64,64c26,26
< 
---
> 
98a111,112
> 
>     protected DiagramGenerator getDiagramGenerator (DiagramEditPart diagramEP, ImageFileFormat format) {
98a99,101
>         DiagramGenerator gen = getDiagramGenerator (diagramEP, format);
>         List editParts = diagramEP.getPrimaryEditParts ();
>         copyToImage (gen, editParts, gen.calculateImageRectangle (editParts), destination, format, monitor);
99,100d110
<         boolean found = false;
<         DiagramGenerator gen = null;
101,101c113,113
<         if (format.equals (ImageFileFormat.SVG)) {
---
>         if (format.equals (ImageFileFormat.SVG)) {
102,102c114,114
<             gen = new DiagramSVGGenerator (diagramEP);
---
>             return new DiagramSVGGenerator (diagramEP);
102a115,115
>         } else {
103,103c116,116
<             gen.createSWTImageDescriptorForDiagram ();
---
>             return new DiagramImageGenerator (diagramEP);
103a117,117
>         }
105,105c125,125
<             saveSVGToFile (destination, (DiagramSVGGenerator) gen, monitor);
---
>             saveSVGToFile (destination, (DiagramSVGGenerator) gen, monitor);
107,116d103
<         } else if (format.equals (ImageFileFormat.JPEG) || format.equals (ImageFileFormat.PNG)) {
<             String exportFormat = ImageExporter.JPEG_FILE;
<             if (format.equals (ImageFileFormat.PNG)) exportFormat = ImageExporter.PNG_FILE;
< 
<             gen = new DiagramImageGenerator (diagramEP);
<             java.awt.Image image = gen.createAWTImageForDiagram ();
<             if (image instanceof BufferedImage) {
<                 ImageExporter.exportToFile (destination, (BufferedImage) image, exportFormat, monitor);
<                 found = true;
<             }
119,121d105
<         if (! found) {
<             gen = new DiagramImageGenerator (diagramEP);
<             Image image = gen.createSWTImageDescriptorForDiagram ().createImage ();
123,124d109
<             saveToFile (destination, image, format, monitor);
<             image.dispose ();
125a131,131
>             java.awt.Image image = gen.createAWTImageForParts (editParts, imageRect);
126,126c132,132
<         monitor.worked (1);
---
>             monitor.worked (1);
127,127d132
<         return gen;
129a120,120
>     protected void copyToImage (DiagramGenerator gen, List editParts, org.eclipse.swt.graphics.Rectangle imageRect, IPath destination, ImageFileFormat format, IProgressMonitor monitor) throws CoreException {
130a107,108
>         DiagramGenerator gen = getDiagramGenerator (diagramEP, format);
>         copyToImage (gen, selection, gen.calculateImageRectangle (selection), destination, format, monitor);
130,130c106,106
<     public void copyToImage (DiagramEditPart diagramEP, List selection, IPath destination, ImageFileFormat format, IProgressMonitor monitor) throws CoreException {
---
>     public void copyToImage (DiagramEditPart diagramEP, List selection, IPath destination, ImageFileFormat format, IProgressMonitor monitor) throws CoreException {
132a123,123
>             gen.createSWTImageDescriptorForParts (editParts, imageRect);
133,134d122
<             DiagramSVGGenerator gen = new DiagramSVGGenerator (diagramEP);
<             gen.createSWTImageDescriptorForParts (selection);
136,136d124
<             saveSVGToFile (destination, gen, monitor);
142,142d130
<             java.awt.Image image = new DiagramImageGenerator (diagramEP).createAWTImageForParts (selection);
150,150c140,140
<             Image image = new DiagramImageGenerator (diagramEP).createSWTImageDescriptorForParts (selection).createImage ();
---
>             Image image = gen.createSWTImageDescriptorForParts (editParts, imageRect).createImage ();
