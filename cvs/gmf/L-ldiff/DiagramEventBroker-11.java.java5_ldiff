44a45,50
> import org.eclipse.emf.transaction.util.TransactionUtil;
> 
> import org.eclipse.emf.workspace.EMFOperationCommand;
> 
> import org.eclipse.gmf.runtime.diagram.core.internal.commands.PersistElementCommand;
> 
156a196,196
>     protected boolean shouldIgnoreNotification (Notification notification) {
156a163,164
>             if (shouldIgnoreNotification (notification)) continue;
> 
157,157d195
<             Object eventFeature = notification.getFeature ();
158a198,198
>             return true;
158,158c197,197
<             if ((notification.isTouch () && notification.getEventType () != Notification.RESOLVE) || NotationPackage.eINSTANCE.getView_Mutable ().equals (eventFeature)) {
---
>         if ((notification.isTouch () && notification.getEventType () != Notification.RESOLVE) || NotationPackage.eINSTANCE.getView_Mutable ().equals (notification.getFeature ())) {
159,159d197
<                 continue;
160a200,202
>         return false;
>     }
> 
160,160c199,199
<             }
---
>         }
179a184,185
>             if (shouldIgnoreNotification (notification)) continue;
> 
180,183d183
<             Object eventFeature = notification.getFeature ();
<             if ((notification.isTouch () && notification.getEventType () != Notification.RESOLVE) || NotationPackage.eINSTANCE.getView_Mutable ().equals (eventFeature)) {
<                 continue;
<             }
213a220,220
>         preparePersistCommand (event, cc);
213,213c219,219
<                 CompoundCommand cc = new CompoundCommand ();
---
>         CompoundCommand cc = new CompoundCommand ();
225,225c406,406
<         return null;
---
>         return pvc;
332a362,365
>     public boolean isAggregatePrecommitListener () {
>         return true;
>     }
> 
358,358d390
<         if (! event.isTouch ()) {
359a235,245
>         if (cc.isEmpty ()) return null;
> 
>         return cc;
>     }
> 
>     private void preparePersistCommand (Notification event, CompoundCommand cc) {
>         PersistElementCommand persistCmd = null;
>         if (! event.isTouch ()) {
>             EObject elementToPersist = (EObject) event.getNotifier ();
>             while (elementToPersist != null && ! (elementToPersist instanceof View)) {
>                 elementToPersist = elementToPersist.eContainer ();
360,361d234
<             while (element != null && ! (element instanceof View)) {
<                 element = element.eContainer ();
362a247,247
>             if (elementToPersist != null && (NotationPackage.eINSTANCE.getView_TransientChildren () == elementToPersist.eContainingFeature () || NotationPackage.eINSTANCE.getDiagram_TransientEdges () == elementToPersist.eContainingFeature ())) {
362,362c246,246
<             }
---
>             }
363,363d246
<             if (element != null && (NotationPackage.eINSTANCE.getView_TransientChildren () == element.eContainingFeature () || NotationPackage.eINSTANCE.getDiagram_TransientEdges () == element.eContainingFeature ())) {
364,364c248,248
<                 if (! NotificationFilter.READ.matches (event)) {
---
>                 if (! NotificationFilter.READ.matches (event)) {
365,365c249,249
<                     ViewUtil.persistElement ((View) element);
---
>                     persistCmd = getPersistViewCommand ((View) elementToPersist);
365a250,254
>                 }
>             }
>         }
>         if (persistCmd != null) cc.append (new EMFOperationCommand (persistCmd.getEditingDomain (), persistCmd));
> 
367a396,403
> 
>     private PersistElementCommand getPersistViewCommand (View view) {
>         PersistElementCommand pvc = null;
>         if (! view.isMutable ()) {
>             TransactionalEditingDomain editingDomain = TransactionUtil.getEditingDomain (view);
>             View viewToPersist = ViewUtil.getTopViewToPersist (view);
>             if (viewToPersist != null) {
>                 pvc = new PersistElementCommand (editingDomain, viewToPersist);
369,369d391
<         EObject element = (EObject) event.getNotifier ();
370,370c392,392
<         if (element != null) {
---
>         if (element != null) {
371,371c393,393
<             fireNotification (event);
---
>             fireNotification (event);
