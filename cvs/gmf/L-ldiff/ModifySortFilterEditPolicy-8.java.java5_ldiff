4a5,6
> import org.eclipse.emf.transaction.TransactionalEditingDomain;
> 
14a17,18
> import org.eclipse.gmf.runtime.diagram.ui.editparts.IGraphicalEditPart;
> 
25,25c29,29
< import org.eclipse.gmf.runtime.emf.commands.core.command.CompositeModelCommand;
---
> import org.eclipse.gmf.runtime.emf.commands.core.command.CompositeTransactionalCommand;
36a41,44
>             TransactionalEditingDomain editingDomain = ((IGraphicalEditPart) getHost ()).getEditingDomain ();
>             CompositeTransactionalCommand command = new CompositeTransactionalCommand (editingDomain, DiagramUIMessages.Command_SortFilterCommand);
>             SetPropertyCommand filteringCommand = new SetPropertyCommand (editingDomain, new EObjectAdapter (view), Properties.ID_FILTERING, Properties.ID_FILTERING, req.getFiltering ());
>             SetPropertyCommand filterKeyCommand = new SetPropertyCommand (editingDomain, new EObjectAdapter (view), Properties.ID_FILTERING_KEYS, Properties.ID_FILTERING_KEYS, req.getFilterKeys ());
37,39d40
<             CompositeModelCommand command = new CompositeModelCommand (DiagramUIMessages.Command_SortFilterCommand);
<             SetPropertyCommand filteringCommand = new SetPropertyCommand (new EObjectAdapter (view), Properties.ID_FILTERING, Properties.ID_FILTERING, req.getFiltering ());
<             SetPropertyCommand filterKeyCommand = new SetPropertyCommand (new EObjectAdapter (view), Properties.ID_FILTERING_KEYS, Properties.ID_FILTERING_KEYS, req.getFilterKeys ());
40,40c45,45
<             SetPropertyCommand filteredObjectsCommand = new SetPropertyCommand (new EObjectAdapter (view), Properties.ID_FILTERED_OBJECTS, Properties.ID_FILTERED_OBJECTS, req.getFilteredObjects ());
---
>             SetPropertyCommand filteredObjectsCommand = new SetPropertyCommand (editingDomain, new EObjectAdapter (view), Properties.ID_FILTERED_OBJECTS, Properties.ID_FILTERED_OBJECTS, req.getFilteredObjects ());
43a49,49
>             SetPropertyCommand sortingCommand = new SetPropertyCommand (editingDomain, new EObjectAdapter (view), Properties.ID_SORTING, Properties.ID_SORTING, req.getSorting ());
44,44d48
<             SetPropertyCommand sortingCommand = new SetPropertyCommand (new EObjectAdapter (view), Properties.ID_SORTING, Properties.ID_SORTING, req.getSorting ());
45,45c50,50
<             SetPropertyCommand sortingKeysCommand = new SetPropertyCommand (new EObjectAdapter (view), Properties.ID_SORTING_KEYS, Properties.ID_SORTING_KEYS, req.getSortKeys () == null ? Collections.EMPTY_MAP : req.getSortKeys ());
---
>             SetPropertyCommand sortingKeysCommand = new SetPropertyCommand (editingDomain, new EObjectAdapter (view), Properties.ID_SORTING_KEYS, Properties.ID_SORTING_KEYS, req.getSortKeys () == null ? Collections.EMPTY_MAP : req.getSortKeys ());
46,46c51,51
<             SetPropertyCommand sortedObjectsCommand = new SetPropertyCommand (new EObjectAdapter (view), Properties.ID_SORTED_OBJECTS, Properties.ID_SORTED_OBJECTS, req.getSortedObjects ());
---
>             SetPropertyCommand sortedObjectsCommand = new SetPropertyCommand (editingDomain, new EObjectAdapter (view), Properties.ID_SORTED_OBJECTS, Properties.ID_SORTED_OBJECTS, req.getSortedObjects ());
50,50c55,55
<             return new EtoolsProxyCommand (command.unwrap ());
---
>             return new EtoolsProxyCommand (command.reduce ());
