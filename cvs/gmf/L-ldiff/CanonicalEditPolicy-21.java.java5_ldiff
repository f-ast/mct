50a55,55
> import org.eclipse.gef.EditPartViewer;
51,51d54
< import org.eclipse.emf.transaction.impl.InternalTransaction;
52,52c56,56
< 
---
> 
53,54d56
< import org.eclipse.emf.transaction.impl.InternalTransactionalEditingDomain;
< 
104a103,104
> import org.eclipse.gmf.runtime.diagram.ui.internal.parts.NotificationForEditPartsListener;
> 
108a109,110
> import org.eclipse.gmf.runtime.diagram.ui.util.EditPartUtil;
> 
129,129c131,131
< public abstract class CanonicalEditPolicy extends AbstractEditPolicy implements NotificationListener {
---
> public abstract class CanonicalEditPolicy extends AbstractEditPolicy implements NotificationForEditPartsListener {
356,356c358,358
<         if (ep == null || (ep != null && ((DiagramEditPart) ep).isActivatingDiagram ()) || ! isWriteTransactionInProgress ()) options = Collections.singletonMap (Transaction.OPTION_UNPROTECTED, Boolean.TRUE);
---
>         if (ep == null || (ep != null && ((DiagramEditPart) ep).isActivatingDiagram ()) || ! EditPartUtil.isWriteTransactionInProgress ((IGraphicalEditPart) getHost (), false)) options = Collections.singletonMap (Transaction.OPTION_UNPROTECTED, Boolean.TRUE);
736a739,740
>     final public EditPartViewer getViewer () {
>         return getHost ().getViewer ();
737,748d738
<     private boolean isWriteTransactionInProgress () {
<         TransactionalEditingDomain theEditingDomain = ((IGraphicalEditPart) getHost ()).getEditingDomain ();
<         if (theEditingDomain instanceof InternalTransactionalEditingDomain) {
<             InternalTransactionalEditingDomain internalEditingDomain = (InternalTransactionalEditingDomain) theEditingDomain;
<             InternalTransaction transaction = internalEditingDomain.getActiveTransaction ();
<             if (transaction != null && ! transaction.isReadOnly ()) {
<                 Object unprotectedMode = transaction.getOptions ().get (Transaction.OPTION_UNPROTECTED);
<                 if (unprotectedMode == null || unprotectedMode == Boolean.FALSE) return true;
< 
<             }
<         }
<         return false;
