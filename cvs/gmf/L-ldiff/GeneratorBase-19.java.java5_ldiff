291,291d290
<             String oldContents = null;
293,293c292,292
<                 oldContents = cu.getSource ();
---
>                 final String oldContents = cu.getSource ();
295,297d293
<             } else {
<                 pm.worked (1);
<             }
299a305,309
>                 } else {
>                     pm.worked (2);
>                 }
>             } else {
>                 cu = pf.createCompilationUnit (cu.getElementName (), genText, true, new SubProgressMonitor (pm, 1));
299a296,301
>                     cu.getBuffer ().setContents (genText);
>                     getImportsPostrocessor ().organizeImports (cu, isToRestoreExistingImports, new SubProgressMonitor (pm, 1));
>                     String newContents = formatCode (cu.getSource ());
>                     if (! newContents.equals (oldContents)) {
>                         cu.getBuffer ().setContents (newContents);
>                         cu.save (new SubProgressMonitor (pm, 1), true);
300,300d304
<                 ICompilationUnit newCU = pf.createCompilationUnit (cu.getElementName (), genText, true, new SubProgressMonitor (pm, 1));
301a311,312
>                 String newContents = formatCode (cu.getSource ());
>                 cu.getBuffer ().setContents (newContents);
301,301c310,310
<                 getImportsPostrocessor ().organizeImports (newCU, isToRestoreExistingImports, new SubProgressMonitor (pm, 1));
---
>                 getImportsPostrocessor ().organizeImports (cu, isToRestoreExistingImports, new SubProgressMonitor (pm, 1));
302,302c313,313
<                 newCU.save (new SubProgressMonitor (pm, 1), true);
---
>                 cu.save (new SubProgressMonitor (pm, 1), true);
302a314,314
>             }
