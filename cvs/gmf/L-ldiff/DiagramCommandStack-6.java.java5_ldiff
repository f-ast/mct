8a9,10
> import java.util.EventObject;
> 
16a19,34
> import org.eclipse.core.commands.ExecutionException;
> 
> import org.eclipse.core.commands.operations.IOperationHistory;
> 
> import org.eclipse.core.commands.operations.IOperationHistoryListener;
> 
> import org.eclipse.core.commands.operations.IUndoContext;
> 
> import org.eclipse.core.commands.operations.IUndoableOperation;
> 
> import org.eclipse.core.commands.operations.ObjectUndoContext;
> 
> import org.eclipse.core.commands.operations.OperationHistoryEvent;
> 
> import org.eclipse.core.commands.operations.OperationHistoryFactory;
> 
27,27c53,53
< import org.eclipse.gmf.runtime.common.core.command.CommandManager;
---
> import org.eclipse.gmf.runtime.common.core.command.ICompositeCommand;
28,30d53
< 
< import org.eclipse.gmf.runtime.common.core.command.CommandManagerChangeEvent;
< 
36a55,56
> import org.eclipse.gmf.runtime.common.core.util.Log;
> 
37,37c57,57
< import org.eclipse.gmf.runtime.common.core.command.ICommandManagerChangeListener;
---
> import org.eclipse.gmf.runtime.common.core.util.Trace;
39a62,67
> 
> import org.eclipse.gmf.runtime.diagram.ui.internal.DiagramUIDebugOptions;
> 
> import org.eclipse.gmf.runtime.diagram.ui.internal.DiagramUIPlugin;
> 
> import org.eclipse.gmf.runtime.diagram.ui.internal.DiagramUIStatusCodes;
39,39c61,61
< import org.eclipse.gmf.runtime.diagram.ui.commands.EtoolsProxyCommand;
---
> import org.eclipse.gmf.runtime.diagram.ui.commands.EtoolsProxyCommand;
43,43c69,69
< import org.eclipse.gmf.runtime.diagram.ui.commands.XtoolsProxyCommand;
---
> import org.eclipse.gmf.runtime.diagram.ui.internal.tools.ConnectionHandleTool;
45,45c37,37
< import org.eclipse.gmf.runtime.emf.commands.core.command.CompositeModelCommand;
---
> import org.eclipse.core.runtime.NullProgressMonitor;
45a38,38
> 
52a77,91
>     private IOperationHistory delegate;
>     private IUndoContext undoContext;
>     private final class HistoryEventObject extends EventObject {
>         private final OperationHistoryEvent event;
> 
>         private HistoryEventObject (OperationHistoryEvent event) {
>             super (event.getHistory ());
>             this.event = event;
>         }
> 
>         public OperationHistoryEvent getOperationHistoryEvent () {
>             return event;
>         }
> 
>     }
53,53d76
<     private CommandManager commandManager;
61a100,100
>         IOperationHistoryListener cmcl = new IOperationHistoryListener () {
62,63d101
<         ICommandManagerChangeListener cmcl = new ICommandManagerChangeListener () {
< 
64,64c102,102
<             public void commandManagerChanged (CommandManagerChangeEvent event) {
---
>             public void historyNotification (OperationHistoryEvent event) {
65,65c103,103
<                 if (csl != null) csl.commandStackChanged (event);
---
>                 if (csl != null) {
65a104,105
>                     csl.commandStackChanged (new HistoryEventObject (event));
>                 }
72a112,112
>         getOperationHistory ().addOperationHistoryListener (cmcl);
73,73d111
<         getCommandManager ().addCommandManagerChangeListener (cmcl);
77,77c116,116
<         return getCommandManager ().canRedo ();
---
>         return getOperationHistory ().canRedo (getUndoContext ());
81,81c120,120
<         return getCommandManager ().canUndo ();
---
>         return getOperationHistory ().canUndo (getUndoContext ());
103a143,147
>                 command.addContext (getUndoContext ());
>                 getOperationHistory ().execute (command, progressMonitor, null);
>             } catch (ExecutionException e) {
>                 Trace.catching (DiagramUIPlugin.getInstance (), DiagramUIDebugOptions.EXCEPTIONS_CATCHING, getClass (), "execute", e);
>                 Log.error (DiagramUIPlugin.getInstance (), DiagramUIStatusCodes.COMMAND_FAILURE, "execute", e);
104,104d142
<                 getCommandManager ().execute (command, progressMonitor);
108a152,160
>         } else {
>             try {
>                 command.addContext (getUndoContext ());
>                 getOperationHistory ().execute (command, new NullProgressMonitor (), null);
>             } catch (ExecutionException e) {
>                 Trace.catching (DiagramUIPlugin.getInstance (), DiagramUIDebugOptions.EXCEPTIONS_CATCHING, getClass (), "execute", e);
>                 Log.error (DiagramUIPlugin.getInstance (), DiagramUIStatusCodes.COMMAND_FAILURE, "execute", e);
>             }
>         }
109,110d151
<         } else getCommandManager ().execute (command);
< 
129,129c179,179
<             CompositeCommand cc = new CompositeCommand (command.getLabel ());
---
>             CompositeCommand composite = new CompositeCommand (command.getLabel ());
133,133c183,183
<                 cc.compose (getICommand ((Command) subCommands [i]));
---
>                 composite.compose (getICommand ((Command) subCommands [i]));
134a185,185
>             return composite.reduce ();
135,135d184
<             return cc.unwrap ();
143a194,207
>         ICommand result = command;
>         if (command instanceof ICompositeCommand) {
>             List processedCommands = new ArrayList ();
>             ICompositeCommand composite = (ICompositeCommand) command;
>             if (! composite.isEmpty ()) {
>                 for (Iterator i = composite.iterator ();
>                 i.hasNext ();) {
>                     IUndoableOperation nextOperation = (IUndoableOperation) i.next ();
>                     i.remove ();
>                     if (nextOperation instanceof ICommand) {
>                         ICommand nextCommand = (ICommand) nextOperation;
>                         processedCommands.add (getICommand (nextCommand));
>                     } else {
>                         processedCommands.add (nextOperation);
144,149d193
<         if (command instanceof CompositeModelCommand) {
<             CompositeModelCommand cc = new CompositeModelCommand (command.getLabel ());
<             List subCommands = ((CompositeCommand) command).getCommands ();
<             for (int i = 0;
<             i < subCommands.size (); i ++) {
<                 cc.compose (getICommand ((ICommand) subCommands.get (i)));
151,151d208
<             return cc.unwrap ();
152a210,212
>                 for (Iterator i = processedCommands.iterator ();
>                 i.hasNext ();) {
>                     composite.add ((IUndoableOperation) i.next ());
153,158d209
<         if (command instanceof CompositeCommand) {
<             CompositeCommand cc = new CompositeCommand (command.getLabel ());
<             List subCommands = ((CompositeCommand) command).getCommands ();
<             for (int i = 0;
<             i < subCommands.size (); i ++) {
<                 cc.compose (getICommand ((ICommand) subCommands.get (i)));
159a214,214
>                 result = composite.reduce ();
160,160d213
<             return cc.unwrap ();
162,163d215
<         if (command instanceof XtoolsProxyCommand) {
<             return getICommand (((XtoolsProxyCommand) command).getCommand ());
168,168c220,220
<         return command;
---
>         return result;
171a224,230
>         getOperationHistory ().dispose (getUndoContext (), true, true, false);
>         super.flush ();
>     }
> 
>     public void dispose () {
>         super.dispose ();
>         flush ();
172,172d223
<         getCommandManager ().clear ();
180,180c238,238
<         if (getCommandManager ().canRedo ()) {
---
>         if (getOperationHistory ().canRedo (getUndoContext ())) {
184a243,244
>             IUndoableOperation redo = getOperationHistory ().getRedoOperation (getUndoContext ());
>             emptyCmd.setLabel (redo.getLabel ());
185,185d242
<             emptyCmd.setLabel (getCommandManager ().getRedoLabel ());
192,192c251,251
<         if (getCommandManager ().canUndo ()) {
---
>         if (getOperationHistory ().canUndo (getUndoContext ())) {
196a256,257
>             IUndoableOperation undo = getOperationHistory ().getUndoOperation (getUndoContext ());
>             emptyCmd.setLabel (undo.getLabel ());
197,197d255
<             emptyCmd.setLabel (getCommandManager ().getUndoLabel ());
204a265,270
>         try {
>             getOperationHistory ().redo (getUndoContext (), new NullProgressMonitor (), null);
>         } catch (ExecutionException e) {
>             Trace.catching (DiagramUIPlugin.getInstance (), DiagramUIDebugOptions.EXCEPTIONS_CATCHING, ConnectionHandleTool.class, "redo", e);
>             Log.error (DiagramUIPlugin.getInstance (), DiagramUIStatusCodes.COMMAND_FAILURE, "redo", e);
>         }
205,205d264
<         getCommandManager ().redo ();
210a276,279
>             IOperationHistoryListener historyListener = (IOperationHistoryListener) stackToManager.get (csl);
>             if (historyListener != null) {
>                 getOperationHistory ().removeOperationHistoryListener (historyListener);
>             }
211,213d275
<             ICommandManagerChangeListener cmcl = (ICommandManagerChangeListener) stackToManager.get (csl);
<             if (cmcl != null) getCommandManager ().removeCommandManagerChangeListener (cmcl);
< 
219a286,291
>         try {
>             getOperationHistory ().undo (getUndoContext (), new NullProgressMonitor (), null);
>         } catch (ExecutionException e) {
>             Trace.catching (DiagramUIPlugin.getInstance (), DiagramUIDebugOptions.EXCEPTIONS_CATCHING, ConnectionHandleTool.class, "undo", e);
>             Log.error (DiagramUIPlugin.getInstance (), DiagramUIStatusCodes.COMMAND_FAILURE, "undo", e);
>         }
220,220d285
<         getCommandManager ().undo ();
226a298,302
>     protected IOperationHistory getOperationHistory () {
>         if (delegate == null) {
>             delegate = OperationHistoryFactory.getOperationHistory ();
>         }
>         return delegate;
227,230d297
<     protected CommandManager getCommandManager () {
<         if (commandManager == null) return CommandManager.getDefault ();
< 
<         return commandManager;
232a305,306
>     public void setOperationHistory (IOperationHistory operationHistory) {
>         this.delegate = operationHistory;
233,234d304
<     protected void setCommandManager (CommandManager commandManager) {
<         this.commandManager = commandManager;
256,259d327
<     public static Collection getReturnValues (XtoolsProxyCommand cmd) {
<         return getReturnValues (cmd.getCommand ());
<     }
< 
265,265c333,333
<         if (cmd instanceof CompositeCommand) {
---
>         if (cmd instanceof ICompositeCommand) {
266,266c334,334
<             CompositeCommand cc = (CompositeCommand) cmd;
---
>             ICompositeCommand cc = (ICompositeCommand) cmd;
268,268c336,336
<             for (Iterator i = cc.getCommands ().iterator ();
---
>             for (Iterator i = cc.iterator ();
272,273d339
<         } else if (cmd instanceof XtoolsProxyCommand) {
<             return getReturnValues ((XtoolsProxyCommand) cmd);
289a356,366
>     public IUndoContext getUndoContext () {
>         if (undoContext == null) {
>             undoContext = new ObjectUndoContext (this);
>         }
>         return undoContext;
>     }
> 
>     public void setUndoContext (IUndoContext undoContext) {
>         this.undoContext = undoContext;
>     }
> 
