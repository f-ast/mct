16a17,20
> import org.eclipse.core.runtime.Platform;
> 
> import org.eclipse.core.runtime.jobs.IJobManager;
> 
24a29,30
> import org.eclipse.gmf.runtime.common.core.util.StringStatics;
> 
53a60,80
>     protected class JobData {
>         public IElementSelectionInput elementSelectionInput;
>         public IElementSelectionListener elementSelectionListener;
>         public HashMap jobs = new HashMap ();
>     }
> 
>     private Map jobs2Data = new HashMap ();
> 
>     public JobData getJobData () {
>         Job currentJob = jobManager.currentJob ();
>         assert currentJob != null;
>         if (currentJob == null) {
>             return null;
>         }
>         JobData data = null;
>         synchronized (jobs2Data) {
>             data = (JobData) jobs2Data.get (currentJob);
>         }
>         return data;
>     }
> 
54,56d59
<     private IElementSelectionInput elementSelectionInput;
<     private IElementSelectionListener elementSelectionListener;
<     private HashMap jobs = new HashMap ();
59a84,84
>         instance.configureProviders ();
60,60d83
<         instance.configureProviders (CommonUIServicesPlugin.getPluginId (), "elementSelectionProviders");
75a100,116
>         ElementSelectionServiceJob job = createSelectionJob ();
>         JobData data = new JobData ();
>         data.elementSelectionInput = input;
>         data.elementSelectionListener = listener;
>         job.setName (getJobName (data));
>         synchronized (jobs2Data) {
>             jobs2Data.put (job, data);
>         }
>         job.schedule ();
>         return job;
>     }
> 
>     protected String getJobName () {
>         return StringStatics.BLANK;
>     }
> 
>     protected ElementSelectionServiceJob createSelectionJob () {
76,77d99
<         elementSelectionInput = input;
<         elementSelectionListener = listener;
80,80c149,149
<         job.schedule ();
---
>             schedule (provider, job);
83a122,123
>     public static final IJobManager jobManager = Platform.getJobManager ();
> 
84a125,127
>         JobData data = getJobData ();
>         if (data == null) return;
> 
86,86c129,129
<         IOperation operation = new MatchingObjectsOperation (elementSelectionInput);
---
>         IOperation operation = new MatchingObjectsOperation (data.elementSelectionInput);
95,95c138,138
<             addJob (provider);
---
>             addJob (data, provider);
97a141,141
>         synchronized (data) {
98,98d140
<         synchronized (jobs) {
99,99c142,142
<             jobsClone = (HashMap) jobs.clone ();
---
>             jobsClone = (HashMap) data.jobs.clone ();
103a147,147
>             IElementSelectionProvider provider = (IElementSelectionProvider) entry.getKey ();
104a170,170
>     protected void schedule (IElementSelectionProvider provider, ElementSelectionServiceJob job) {
105a172,173
>     }
> 
105,105c171,171
<             job.schedule ();
---
>         job.schedule ();
107,107c151,151
<         monitor.beginTask (getJobName (), 1000);
---
>         monitor.beginTask (getJobName (data), 1000);
108a153,153
>             synchronized (data) {
109,109d152
<             synchronized (jobs) {
110,110c154,154
<                 if (jobs.size () == 0) {
---
>                 if (data.jobs.size () == 0) {
115a160,161
>                 synchronized (data) {
>                     data.elementSelectionListener = null;
119a166,166
>         }
127,127c178,178
<     protected String getJobName () {
---
>     protected String getJobName (JobData data) {
127a179,179
>         if ((getJobName () != null && getJobName ().equals (StringStatics.BLANK)) && data != null) {
129,129c181,181
<         String filter = elementSelectionInput.getInput ();
---
>             String filter = data.elementSelectionInput.getInput ();
131a184,185
>         return getJobName ();
>     }
132a187,187
>     private void addJob (JobData data, IElementSelectionProvider provider) {
133,133d186
<     private void addJob (IElementSelectionProvider provider) {
134a189,189
>         synchronized (data) {
134,134c188,188
<         ElementSelectionServiceJob job = provider.getMatchingObjects (elementSelectionInput, this);
---
>         ElementSelectionServiceJob job = provider.getMatchingObjects (data.elementSelectionInput, this);
135,135d188
<         synchronized (jobs) {
136,136c190,190
<             jobs.put (provider, job);
---
>             data.jobs.put (provider, job);
136a191,193
>         }
>         synchronized (jobs2Data) {
>             jobs2Data.put (job, data);
140,140c197,197
<     private void removeJob (IElementSelectionProvider provider) {
---
>     private void removeJob (JobData data, IElementSelectionProvider provider) {
141a199,201
>         Object job = null;
>         synchronized (data) {
>             job = data.jobs.remove (provider);
142,143d198
<         synchronized (jobs) {
<             jobs.remove (provider);
144,144c202,202
<             if (jobs.size () == 0) {
---
>             if (data.jobs.size () == 0) {
150a209,211
>         synchronized (jobs2Data) {
>             jobs2Data.remove (job);
>         }
153a215,224
>         final Job currentJob = jobManager.currentJob ();
>         if (currentJob == null) return;
> 
>         JobData data = null;
>         synchronized (jobs2Data) {
>             data = (JobData) jobs2Data.get (currentJob);
>         }
>         if (data == null) return;
> 
>         final JobData finalData = data;
156a228,229
>                 synchronized (finalData) {
>                     if (finalData.elementSelectionListener != null) {
157,157c230,230
<                 elementSelectionListener.matchingObjectEvent (matchingObjectEvent);
---
>                         finalData.elementSelectionListener.matchingObjectEvent (matchingObjectEvent);
157a231,232
>                     }
>                 }
171a247,249
>         JobData data = getJobData ();
>         if (data == null) return;
> 
173,173c251,251
<             removeJob (matchingObjectEvent.getMatchingObject ().getProvider ());
---
>             removeJob (data, matchingObjectEvent.getMatchingObject ().getProvider ());
179a258,258
>         JobData data = getJobData ();
180a260,260
>         synchronized (data) {
181,181d259
<         synchronized (jobs) {
182,182c261,261
<             jobsClone = (HashMap) jobs.clone ();
---
>             jobsClone = (HashMap) data.jobs.clone ();
190,190c269,269
<             removeJob (provider);
---
>             removeJob (data, provider);
197a277,291
>     protected void configureProviders () {
>         configureProviders (CommonUIServicesPlugin.getPluginId (), "elementSelectionProviders");
>     }
> 
>     public void cancelJob (ElementSelectionServiceJob job) {
>         JobData data = null;
>         synchronized (jobs2Data) {
>             data = (JobData) jobs2Data.get (job);
>         }
>         synchronized (data) {
>             data.elementSelectionListener = null;
>         }
>         job.cancel ();
>     }
> 
