31,31c37,37
< import org.osgi.framework.Bundle;
---
> import org.osgi.framework.Bundle;
32,32c38,38
< 
---
> 
456a458,459
>             Class clazz = loadClass (parameterClassName, parameterPluginID);
>             if (clazz == null) clazz = Object.class;
457,458d457
<             Bundle bundle = getPluginBundle (parameterPluginID);
<             if (bundle == null) return Object.class;
459a461,461
>             return clazz;
459,459c460,460
< 
---
> 
461,461d457
<             return loadClass (parameterClassName, bundle);
620,620d619
<     protected static Class loadClass (String className, Bundle bundle) {
621a633,639
>                     Bundle bundle = getPluginBundle (pluginId);
>                     if (bundle != null) {
>                         found = bundle.loadClass (className);
>                         successLookupTable.put (keyString, new WeakReference (found));
>                     } else {
>                         failureLookupTable.add (keyString);
>                     }
622,622d632
<             return bundle.loadClass (className);
623a641,642
>                     failureLookupTable.add (keyString);
>                 }
624a646,646
>     }
624,624c645,645
<             return null;
---
>         return found;
671a620,629
>     protected static Class loadClass (String className, String pluginId) {
>         StringBuffer keyStringBuf = new StringBuffer (className.length () + pluginId.length () + 2);
>         keyStringBuf.append (pluginId);
>         keyStringBuf.append ('.');
>         keyStringBuf.append (className);
>         String keyString = keyStringBuf.toString ();
>         WeakReference ref = (WeakReference) successLookupTable.get (keyString);
>         Class found = (ref != null) ? (Class) ref.get () : null;
>         if (found == null) {
>             if (ref != null) successLookupTable.remove (keyString);
671a692,692
>             Class theClass = loadClass (className, pluginId);
672,677d619
<             StringBuffer keyStringBuf = new StringBuffer (className.length () + pluginId.length () + 2);
<             keyStringBuf.append (pluginId);
<             keyStringBuf.append ('.');
<             keyStringBuf.append (className);
<             String keyString = keyStringBuf.toString ();
<             if (failureLookupTable.contains (keyString)) return null;
678,678c630,630
< 
---
> 
679,688d630
<             WeakReference loadedClassRef = (WeakReference) successLookupTable.get (keyString);
<             Class theClass = null;
<             if (loadedClassRef != null) theClass = (Class) loadedClassRef.get ();
< 
<             if (theClass == null) {
<                 Bundle bundle = (pluginId != null) ? getPluginBundle (pluginId) : null;
<                 if (bundle == null) return null;
< 
<                 theClass = loadClass (className, bundle);
<                 if (theClass != null) successLookupTable.put (keyString, new WeakReference (theClass));
689,689c631,631
<                 else failureLookupTable.add (keyString);
---
>             if (! failureLookupTable.contains (keyString)) {
690,691d631
< 
<             }
744,745d744
<         Bundle bundle = getPluginBundle (staticMethodDescriptor.getPluginID ());
<         if (bundle == null) return null;
747a746,746
>         if (theClass == null) return null;
747,747c745,745
<         Class theClass = loadClass (staticMethodDescriptor.getClassName (), bundle);
---
>         Class theClass = loadClass (staticMethodDescriptor.getClassName (), staticMethodDescriptor.getPluginID ());
