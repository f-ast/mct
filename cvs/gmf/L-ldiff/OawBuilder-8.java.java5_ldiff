2a3,6
> import java.util.ArrayList;
> 
> import java.util.Collection;
> 
28a33,34
> import org.eclipse.core.runtime.OperationCanceledException;
> 
32a39,40
> import org.eclipse.gmf.internal.xpand.RootManager;
> 
50a59,59
> public class OawBuilder extends IncrementalProjectBuilder implements RootManager.IRootChangeListener {
51,52d58
< public class OawBuilder extends IncrementalProjectBuilder {
<     private boolean firstBuild = true;
53,53c60,60
<     private WorkspaceResourceManager resourceManager;
---
>     private RootManager myRootManager;
54a62,62
>     private boolean myRootsChanged = true;
64a73,74
>         myRootManager = Activator.getRootManager (getProject ());
>         myRootManager.addRootChangeListener (this);
65,67d72
<         resourceManager = new WorkspaceResourceManager (getProject ());
<         Activator.registerResourceManager (getProject (), resourceManager);
<         firstBuild = true;
74a100,114
>         myRootsChanged = false;
>         Set < IProject > referencedProjects = myRootManager.getReferencedProjects ();
>         referencedProjects.remove (getProject ());
>         return referencedProjects.toArray (new IProject [referencedProjects.size ()]);
>     }
> 
>     private void doBuild (int kind, Map < ?, ? > args, IProgressMonitor monitor) throws CoreException {
>         if ((kind == FULL_BUILD) || haveRootsChangedSinceLastBuild ()) {
>             fullBuild (monitor);
>         } else {
>             Set < IProject > referencedProjects = myRootManager.getReferencedProjects ();
>             referencedProjects.remove (getProject ());
>             Collection < IResourceDelta > deltas = new ArrayList < IResourceDelta > (referencedProjects.size ());
>             IResourceDelta projectDelta = getDelta (getProject ());
>             if (projectDelta == null) {
74a82,82
>             doBuild (kind, args, monitor);
75,75d99
<             if (firstBuild || (kind == FULL_BUILD)) {
76,76c115,115
<                 fullBuild (monitor);
---
>                 fullBuild (monitor);
76a116,119
>                 return;
>             }
>             for (IProject next : referencedProjects) {
>                 final IResourceDelta delta = getDelta (next);
77,78d115
<             } else {
<                 final IResourceDelta delta = getDelta (getProject ());
79,79c120,120
<                 if (delta == null) {
---
>                 if (delta == null) {
80,80c121,121
<                     fullBuild (monitor);
---
>                     fullBuild (monitor);
80a122,122
>                     return;
81,82d121
<                 } else {
<                     incrementalBuild (delta, monitor);
83a124,124
>                 deltas.add (delta);
83,83c123,123
<                 }
---
>                 }
84,84c125,125
<             }
---
>             }
84a126,135
>             incrementalBuild (projectDelta, deltas, monitor);
>         }
>     }
> 
>     public void rootsChanged (RootManager rootManager) {
>         myRootsChanged = true;
>     }
> 
>     private boolean haveRootsChangedSinceLastBuild () {
>         return myRootsChanged;
88,88d85
<         firstBuild = false;
90,90c87,87
<             final ExecutionContext ctx = ContextFactory.createXtendContext (getResourceManager ());
---
>             final ExecutionContext ctx = ContextFactory.createXtendContext (getResourceManager (xtendResourcesToAnalyze.get (r)));
96,96c93,93
<             final XpandExecutionContext ctx = ContextFactory.createXpandContext (getResourceManager ());
---
>             final XpandExecutionContext ctx = ContextFactory.createXpandContext (getResourceManager (xpandResourcesToAnalyze.get (r)));
103,103d99
<         return null;
110,110c139,139
<         getResourceManager ().forget (resource);
---
>         getResourceManager (resource).forget (resource);
113,113c145,145
<                 XpandResource r = getResourceManager ().loadXpandResource (resource);
---
>                 XpandResource r = getResourceManager (resource).loadXpandResource (resource);
118,118c150,150
<                 XtendResource r = getResourceManager ().loadXtendResource (resource);
---
>                 XtendResource r = getResourceManager (resource).loadXtendResource (resource);
135a168,173
>     }
> 
>     private WorkspaceResourceManager getResourceManager (IFile file) {
>         WorkspaceResourceManager result = myRootManager.getResourceManager (file);
>         assert result != null;
>         return result;
135,135c167,167
<         getResourceManager ().forget (resource);
---
>         getResourceManager (resource).forget (resource);
138a177,183
>         Set < IProject > referencedProjects = myRootManager.getReferencedProjects ();
>         referencedProjects.add (getProject ());
>         OawMarkerManager.deleteMarkers (getProject ());
>         monitor.beginTask (null, 1 + referencedProjects.size ());
>         try {
>             for (IProject next : referencedProjects) {
>                 checkCanceled (monitor);
139,139d176
<         monitor.beginTask (null, 2);
140a185,186
>             }
>             checkCanceled (monitor);
140,140c184,184
<         getProject ().accept (new XpandResourceVisitor (new SubProgressMonitor (monitor, 1)));
---
>                 next.accept (new XpandResourceVisitor (new SubProgressMonitor (monitor, 1)));
141a188,188
>         } finally {
143a191,191
>     }
145,145c193,193
<     protected void incrementalBuild (final IResourceDelta delta, final IProgressMonitor monitor) throws CoreException {
---
>     protected void incrementalBuild (final IResourceDelta projectDelta, final Collection < IResourceDelta > referencedProjectDeltas, final IProgressMonitor monitor) throws CoreException {
146a195,197
>         try {
>             for (IResourceDelta delta : referencedProjectDeltas) {
>                 checkCanceled (monitor);
146,146c194,194
<         monitor.beginTask (null, 2);
---
>         monitor.beginTask (null, 2 + referencedProjectDeltas.size ());
147a199,202
>             }
>             checkCanceled (monitor);
>             projectDelta.accept (new XpandResourceVisitor (new SubProgressMonitor (monitor, 1)));
>             checkCanceled (monitor);
148a204,204
>         } finally {
148,148c203,203
<         modelRegistry.build (getProject (), delta, new SubProgressMonitor (monitor, 1));
---
>             modelRegistry.build (getProject (), projectDelta, new SubProgressMonitor (monitor, 1));
150a207,207
>     }
151a209,212
>     private void checkCanceled (final IProgressMonitor monitor) {
>         if (monitor.isCanceled ()) {
>             throw new OperationCanceledException ();
>         }
152,153d208
<     private WorkspaceResourceManager getResourceManager () {
<         return resourceManager;
174,174c233,233
<     private static boolean isFileOfInterest (IFile file) {
---
>     private boolean isFileOfInterest (IFile file) {
175,175c234,234
<         return isXpand (file) || isXtend (file);
---
>         if (! isXpand (file) && ! isXtend (file)) {
175a235,240
>             return false;
>         }
>         if (getResourceManager (file) == null) {
>             return false;
>         }
>         return true;
