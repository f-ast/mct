12a15,15
> import java.util.LinkedHashMap;
13,13d14
< import java.util.HashSet;
14a17,18
> import java.util.LinkedHashSet;
> 
14,14c16,16
< 
---
> 
45,46d46
< import org.eclipse.emf.transaction.util.TransactionUtil;
< 
49,49c49,49
< import org.eclipse.gmf.runtime.diagram.core.internal.commands.PersistElementCommand;
---
> import org.eclipse.gmf.runtime.diagram.core.internal.commands.PersistViewsCommand;
61a62,62
>     private WeakReference editingDomainRef;
71,71c72,72
<             Set listenersSet = (Set) keys.get (key);
---
>             Map listenersSet = (Map) keys.get (key);
73,73c74,74
<                 listenersSet = new HashSet (4);
---
>                 listenersSet = new LinkedHashMap (4);
76,76c77,77
<             listenersSet.add (listener);
---
>             listenersSet.put (listener, null);
86,86c87,87
<                 Set listenersSet = (Set) keys.get (key);
---
>                 Map listenersSet = (Map) keys.get (key);
101,101c102,102
<                 Set listenersSet = (Set) keys.get (key);
---
>                 Map listenersSet = (Map) keys.get (key);
103,103c104,104
<                     return listenersSet;
---
>                     return listenersSet.keySet ();
114,114c115,115
<             Set listenersCollection = new HashSet ();
---
>             Set listenersCollection = new LinkedHashSet ();
118a120,120
>                 Map listenersSet = (Map) entry.getValue ();
119,119d119
<                 Set listenersSet = (Set) entry.getValue ();
120,120c121,121
<                 if (listenersSet != null && ! listenersSet.isEmpty ()) listenersCollection.addAll (listenersSet);
---
>                 if (listenersSet != null && ! listenersSet.isEmpty ()) listenersCollection.addAll (listenersSet.keySet ());
125a127,130
>         public boolean isEmpty () {
>             return listenersMap.isEmpty ();
>         }
> 
143a149,151
>             if (diagramEventBroker.editingDomainRef == null) {
>                 diagramEventBroker.editingDomainRef = new WeakReference (editingDomain);
>             }
159a168,169
>             DiagramEventBroker diagramEventBroker = new DiagramEventBroker ();
>             diagramEventBroker.editingDomainRef = new WeakReference (editingDomain);
160,160c170,170
<             return new DiagramEventBroker ();
---
>             return diagramEventBroker;
181,181c191,191
<         Set elementsInPersistQueue = new HashSet ();
---
>         Set elementsInPersistQueue = new LinkedHashSet ();
182a193,195
>         TransactionalEditingDomain editingDomain = (TransactionalEditingDomain) editingDomainRef.get ();
>         boolean hasPreListeners = (preListeners.isEmpty () == false);
>         List viewsToPersistList = new ArrayList ();
190,190c203,203
<                 if (deletedObjects.contains (notification.getNotifier ())) {
---
>                 if (deletedObjects.contains (notifier)) {
192a206,213
>                 if (editingDomain != null) {
>                     View viewToPersist = getViewToPersist (notification, elementsInPersistQueue);
>                     if (viewToPersist != null) {
>                         viewsToPersistList.add (viewToPersist);
>                     }
>                 }
>                 if (hasPreListeners) {
>                     Command cmd = fireTransactionAboutToCommit (notification);
193,193d205
<                 Command cmd = handleTransactionAboutToCommitEvent (notification, elementsInPersistQueue);
199,199d218
<         elementsInPersistQueue.clear ();
203a228,230
>         if (postListeners.isEmpty ()) {
>             return;
>         }
213,213c240,240
<                 if (deletedObjects.contains (notification.getNotifier ()) && ! customNotification) {
---
>                 if (! customNotification && deletedObjects.contains (notifier)) {
216,216c243,243
<                 handleElementEvent (notification);
---
>                 fireNotification (notification);
229,229c256,256
<         Collection listenerList = getInterestedNotificationListeners (event, false);
---
>         Collection listenerList = getInterestedNotificationListeners (event, postListeners);
230,231d256
<         if (! listenerList.isEmpty ()) {
<             List listenersSnapShot = new ArrayList (listenerList);
233,233c258,258
<                 for (Iterator listenerIT = listenersSnapShot.iterator ();
---
>             for (Iterator listenerIT = listenerList.iterator ();
240,240d264
<     }
241a266,266
>     private Command fireTransactionAboutToCommit (Notification event) {
242,242d265
<     private Command fireTransactionAboutToCommit (Notification event, Set elementsInPersistQueue) {
243,243c267,267
<         Collection listenerList = getInterestedNotificationListeners (event, true);
---
>         Collection listenerList = getInterestedNotificationListeners (event, preListeners);
244,247d267
<         CompoundCommand cc = new CompoundCommand ();
<         preparePersistCommand (event, cc, elementsInPersistQueue);
<         if (! listenerList.isEmpty ()) {
<             List listenersSnapShot = new ArrayList (listenerList);
248a269,269
>             CompoundCommand cc = new CompoundCommand ();
249,249c270,270
<                 for (Iterator listenerIT = listenersSnapShot.iterator ();
---
>             for (Iterator listenerIT = listenerList.iterator ();
259,261d279
<         }
<         if (cc.isEmpty ()) return null;
< 
262,262c280,280
<         return cc;
---
>         return null;
265,265c283,283
<     private void preparePersistCommand (Notification event, CompoundCommand cc, Set elementsInPersistQueue) {
---
>     private View getViewToPersist (Notification event, Set elementsInPersistQueue) {
266,266d283
<         PersistElementCommand persistCmd = null;
275,275d291
<                     persistCmd = getPersistViewCommand ((View) elementToPersist);
278a302,303
>         }
>         return null;
278a219,221
>         }
>         if (viewsToPersistList.isEmpty () == false) {
>             PersistViewsCommand persistCmd = new PersistViewsCommand (editingDomain, viewsToPersistList);
279a223,223
>         }
279,279c222,222
<         if (persistCmd != null && persistCmd.getEditingDomain () != null) cc.append (new EMFOperationCommand (persistCmd.getEditingDomain (), persistCmd));
---
>             cc.append (new EMFOperationCommand (editingDomain, persistCmd));
280,280d222
< 
330a354,354
>     private Set getNotificationListeners (Object notifier, NotifierToKeyToListenersSetMap listeners) {
331,343d353
<     public final void finalize () {
<         try {
<             for (Iterator iter = instanceMap.keySet ().iterator ();
<             iter.hasNext ();) {
<                 TransactionalEditingDomain editingDomain = (TransactionalEditingDomain) iter.next ();
<                 editingDomain.removeResourceSetListener ((DiagramEventBroker) ((WeakReference) instanceMap.get (editingDomain)).get ());
<             }
<         } catch (Throwable ignored) {
<         }
<     }
< 
<     private Set getNotificationListeners (Object notifier, boolean preCommit) {
<         NotifierToKeyToListenersSetMap listeners = preCommit ? preListeners : postListeners;
347,347c358,358
<     private Set getNotificationListeners (Object notifier, Object key, boolean preCommit) {
---
>     private Set getNotificationListeners (Object notifier, Object key, NotifierToKeyToListenersSetMap listeners) {
348,348d358
<         NotifierToKeyToListenersSetMap listeners = preCommit ? preListeners : postListeners;
351,351c361,361
<                 Set listenersSet = new HashSet ();
---
>                 Set listenersSet = new LinkedHashSet ();
366a377,378
>     final protected Set getInterestedNotificationListeners (Notification event, NotifierToKeyToListenersSetMap listeners) {
>         Set listenerSet = new LinkedHashSet ();
367,368d376
<     final protected Set getInterestedNotificationListeners (Notification event, boolean preCommit) {
<         HashSet listenerSet = new HashSet ();
369,369c379,379
<         Collection c = getNotificationListeners (event.getNotifier (), event.getFeature (), preCommit);
---
>         Collection c = getNotificationListeners (event.getNotifier (), event.getFeature (), listeners);
375,375c385,385
<             listenerSet.addAll (getNotificationListeners (notifier.eContainer (), preCommit));
---
>             listenerSet.addAll (getNotificationListeners (notifier.eContainer (), listeners));
377,377c387,387
<             addListenersOfNotifier (listenerSet, notifier.eContainer (), event, preCommit);
---
>             addListenersOfNotifier (listenerSet, notifier.eContainer (), event, listeners);
382,382c392,392
<             addListenersOfNotifier (listenerSet, notifier, event, preCommit);
---
>             addListenersOfNotifier (listenerSet, notifier, event, listeners);
392,392c402,402
<     private void addListenersOfNotifier (Set listenerSet, EObject notifier, Notification event, boolean preCommit) {
---
>     private void addListenersOfNotifier (Set listenerSet, EObject notifier, Notification event, NotifierToKeyToListenersSetMap listeners) {
394,394c404,404
<             Collection c = getNotificationListeners (notifier, event.getFeature (), preCommit);
---
>             Collection c = getNotificationListeners (notifier, event.getFeature (), listeners);
407a292,293
>                     View view = (View) elementToPersist;
>                     if (! view.isMutable ()) {
408,426d291
<     private Command handleTransactionAboutToCommitEvent (Notification event, Set elementsInPersistQueue) {
<         EObject element = (EObject) event.getNotifier ();
<         if (element != null) {
<             return fireTransactionAboutToCommit (event, elementsInPersistQueue);
<         }
<         return null;
<     }
< 
<     private void handleElementEvent (Notification event) {
<         EObject element = (EObject) event.getNotifier ();
<         if (element != null) {
<             fireNotification (event);
<         }
<     }
< 
<     private PersistElementCommand getPersistViewCommand (View view) {
<         PersistElementCommand pvc = null;
<         if (! view.isMutable ()) {
<             TransactionalEditingDomain editingDomain = TransactionUtil.getEditingDomain (view);
427,427c294,294
<             View viewToPersist = ViewUtil.getTopViewToPersist (view);
---
>                         View viewToPersist = ViewUtil.getTopViewToPersist (view);
428,428c295,295
<             if (viewToPersist != null) {
---
>                         if (viewToPersist != null) {
429a297,297
>                             return viewToPersist;
429,429c296,296
<                 pvc = new PersistElementCommand (editingDomain, viewToPersist);
---
>                             elementsInPersistQueue.add (viewToPersist);
430,430c298,298
<             }
---
>                         }
431,434d298
<         }
<         return pvc;
<     }
< 
