18a259,259
>         if (layout instanceof StackLayout) {
19,19c260,260
< import org.eclipse.draw2d.StackLayout;
---
>             return new org.eclipse.draw2d.StackLayout ();
20,20d260
< 
22a262,262
>         if (layout instanceof XYLayout) {
23,23c263,263
< import org.eclipse.draw2d.XYLayout;
---
>             return new org.eclipse.draw2d.XYLayout ();
24,24d263
< 
40a37,38
> import org.eclipse.gmf.gmfgraph.Dimension;
> 
52a57,57
> import org.eclipse.gmf.gmfgraph.Shape;
53,53d56
< import org.eclipse.gmf.gmfgraph.Layoutable;
54a59,62
> import org.eclipse.gmf.gmfgraph.StackLayout;
> 
> import org.eclipse.gmf.gmfgraph.XYLayout;
> 
54,54c58,58
< 
---
> 
85a88,90
>     private Object getLayoutConstraint () {
>         Shape shape = getShape ();
>         if (shape == null || shape.getLayoutData () == null) {
86,88d87
<     public Object getLayoutConstraint () {
<         Layoutable layoutable = (Layoutable) ((View) getModel ()).getElement ();
<         if (layoutable == null || layoutable.getLayoutData () == null) {
91,91c93,93
<         LayoutData layoutData = layoutable.getLayoutData ();
---
>         LayoutData layoutData = shape.getLayoutData ();
143,143c145,145
<                     if (xyLayoutData.getTopLeft () != null) {
---
>                     if (xyLayoutData.getTopLeft () != null && xyLayoutData.getSize () != null) {
145,146d146
<                     }
<                     if (xyLayoutData.getSize () != null) {
169,169c169,169
<         } else if (layoutManager instanceof XYLayout) {
---
>         } else if (layoutManager instanceof org.eclipse.draw2d.XYLayout) {
177a178,179
>     private boolean isFigureRefreshAllowed () {
>         return figure != null && figure.getParent () != null;
178,180d177
<     protected void layoutDataChanged (LayoutData layoutData) {
<         if (isFigureRefreshAllowed ()) {
<             handleMajorSemanticChange ();
183a192,201
>     private Integer getGridDataAlignment (Alignment alignment) {
>         switch (alignment.getValue ()) {
>             case Alignment.BEGINNING :
>                 return GridData.BEGINNING;
>             case Alignment.END :
>                 return GridData.END;
>             case Alignment.CENTER :
>                 return GridData.CENTER;
>             case Alignment.FILL :
>                 return GridData.FILL;
184,186d202
<     protected void layoutChanged (Layout layout) {
<         if (layout == null) {
<             setFigureLayoutManager (null);
187,187c203,203
<             return;
---
>         return null;
188a205,207
> 
>     protected LayoutManager getLayoutManager (Layout layout) {
>         if (layout instanceof BorderLayout) {
189,191d204
<         switch (layout.eClass ().getClassifierID ()) {
<             case GMFGraphPackage.BORDER_LAYOUT :
<                 {
192,192c208,208
<                     BorderLayout borderLayout = (BorderLayout) layout;
---
>             BorderLayout borderLayout = (BorderLayout) layout;
193,196d208
<                     org.eclipse.draw2d.BorderLayout layoutManager;
<                     if (getFigureLayoutManager () instanceof org.eclipse.draw2d.BorderLayout) {
<                         layoutManager = (org.eclipse.draw2d.BorderLayout) getFigureLayoutManager ();
<                     } else {
197,197c209,209
<                         layoutManager = new org.eclipse.draw2d.BorderLayout ();
---
>             org.eclipse.draw2d.BorderLayout layoutManager = new org.eclipse.draw2d.BorderLayout ();
198,198d209
<                         setFigureLayoutManager (layoutManager);
203a214,216
>             return layoutManager;
>         }
>         if (layout instanceof FlowLayout) {
204,209d213
<                     break;
<                 } case GMFGraphPackage.CUSTOM_LAYOUT :
<                 {
<                     break;
<                 } case GMFGraphPackage.FLOW_LAYOUT :
<                 {
212,215d218
<                         ToolbarLayout layoutManager;
<                         if (getFigureLayoutManager () instanceof ToolbarLayout) {
<                             layoutManager = (ToolbarLayout) getFigureLayoutManager ();
<                         } else {
216,216c219,219
<                             layoutManager = new ToolbarLayout ();
---
>                 ToolbarLayout layoutManager = new ToolbarLayout ();
217,218d219
<                             setFigureLayoutManager (layoutManager);
<                         }
222a224,224
>                 return layoutManager;
224,227d225
<                         org.eclipse.draw2d.FlowLayout layoutManager;
<                         if (getFigureLayoutManager () instanceof org.eclipse.draw2d.FlowLayout) {
<                             layoutManager = (org.eclipse.draw2d.FlowLayout) getFigureLayoutManager ();
<                         } else {
228,228c226,226
<                             layoutManager = new org.eclipse.draw2d.FlowLayout ();
---
>                 org.eclipse.draw2d.FlowLayout layoutManager = new org.eclipse.draw2d.FlowLayout ();
229,230d226
<                             setFigureLayoutManager (layoutManager);
<                         }
236a233,233
>                 return layoutManager;
237a236,236
>         if (layout instanceof GridLayout) {
238,240d235
<                     break;
<                 } case GMFGraphPackage.GRID_LAYOUT :
<                 {
241,241c237,237
<                     GridLayout gridLayout = (GridLayout) layout;
---
>             GridLayout gridLayout = (GridLayout) layout;
242,245d237
<                     org.eclipse.draw2d.GridLayout layoutManager;
<                     if (getFigureLayoutManager () instanceof org.eclipse.draw2d.GridLayout) {
<                         layoutManager = (org.eclipse.draw2d.GridLayout) getFigureLayoutManager ();
<                     } else {
246,246c238,238
<                         layoutManager = new org.eclipse.draw2d.GridLayout ();
---
>             org.eclipse.draw2d.GridLayout layoutManager = new org.eclipse.draw2d.GridLayout ();
247,247d238
<                         setFigureLayoutManager (layoutManager);
266a257,257
>             return layoutManager;
267,271d256
<                     break;
<                 } case GMFGraphPackage.STACK_LAYOUT :
<                 {
<                     if (false == getFigureLayoutManager () instanceof StackLayout) {
<                         setFigureLayoutManager (new StackLayout ());
273,282d258
<                     break;
<                 } case GMFGraphPackage.XY_LAYOUT :
<                 {
<                     if (false == getFigureLayoutManager () instanceof XYLayout) {
<                         setFigureLayoutManager (new XYLayout ());
<                     }
<                     break;
<                 }}
<         if (isFigureRefreshAllowed ()) {
<             handleMajorSemanticChange ();
284,284d180
<     }
285,285c181,181
< 
---
> 
286,293d181
<     private boolean isFigureRefreshAllowed () {
<         return figure != null;
<     }
< 
<     protected abstract LayoutManager getFigureLayoutManager ();
< 
<     protected abstract void setFigureLayoutManager (LayoutManager layoutManager);
< 
294,294c182,182
<     private int getDraw2dAllignment (Alignment alignment, boolean isToolbar) {
---
>     private int getDraw2dAllignment (Alignment alignment, boolean isToolbar) {
295,295c183,183
<         switch (alignment.getValue ()) {
---
>         switch (alignment.getValue ()) {
296,296c184,184
<             case Alignment.BEGINNING :
---
>             case Alignment.BEGINNING :
297,297c185,185
<                 return isToolbar ? ToolbarLayout.ALIGN_TOPLEFT : org.eclipse.draw2d.FlowLayout.ALIGN_LEFTTOP;
---
>                 return isToolbar ? ToolbarLayout.ALIGN_TOPLEFT : org.eclipse.draw2d.FlowLayout.ALIGN_LEFTTOP;
298,298c186,186
<             case Alignment.END :
---
>             case Alignment.END :
299,299c187,187
<                 return isToolbar ? ToolbarLayout.ALIGN_BOTTOMRIGHT : org.eclipse.draw2d.FlowLayout.ALIGN_RIGHTBOTTOM;
---
>                 return isToolbar ? ToolbarLayout.ALIGN_BOTTOMRIGHT : org.eclipse.draw2d.FlowLayout.ALIGN_RIGHTBOTTOM;
300,300c188,188
<         }
---
>         }
301,301c189,189
<         return isToolbar ? ToolbarLayout.ALIGN_CENTER : org.eclipse.draw2d.FlowLayout.ALIGN_CENTER;
---
>         return isToolbar ? ToolbarLayout.ALIGN_CENTER : org.eclipse.draw2d.FlowLayout.ALIGN_CENTER;
302,313d189
<     }
< 
<     private Integer getGridDataAlignment (Alignment alignment) {
<         switch (alignment.getValue ()) {
<             case Alignment.BEGINNING :
<                 return GridData.BEGINNING;
<             case Alignment.END :
<                 return GridData.END;
<             case Alignment.CENTER :
<                 return GridData.CENTER;
<             case Alignment.FILL :
<                 return GridData.FILL;
318,318c268,268
<     protected int getLineStyle (LineKind lineKind) {
---
>     protected static int getLineStyle (LineKind lineKind) {
340a291,294
>     protected org.eclipse.draw2d.geometry.Dimension getCornerDimensions (int width, int height) {
>         return new org.eclipse.draw2d.geometry.Dimension (getMapMode ().DPtoLP (width), getMapMode ().DPtoLP (height));
>     }
> 
413a368,393
>     protected org.eclipse.draw2d.geometry.Dimension getDraw2dDimension (Dimension dimension) {
>         return new org.eclipse.draw2d.geometry.Dimension (getMapMode ().DPtoLP (dimension.getDx ()), getMapMode ().DPtoLP (dimension.getDy ()));
>     }
> 
>     protected org.eclipse.draw2d.geometry.Point getDraw2DPoint (Point point) {
>         return new org.eclipse.draw2d.geometry.Point (getMapMode ().DPtoLP (point.getX ()), getMapMode ().DPtoLP (point.getY ()));
>     }
> 
>     protected void refreshLayoutData () {
>         if (! isFigureRefreshAllowed ()) {
>             return;
>         }
>         Object layoutConstraint = getLayoutConstraint ();
>         if (layoutConstraint != null) {
>             getFigure ().getParent ().setConstraint (getFigure (), layoutConstraint);
>         }
>     }
> 
>     protected Shape getShape () {
>         View view = getNotationView ();
>         if (view != null && view.getElement () instanceof Shape) {
>             return (Shape) view.getElement ();
>         }
>         return null;
>     }
> 
