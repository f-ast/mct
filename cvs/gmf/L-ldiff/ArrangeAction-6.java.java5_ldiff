2a3,4
> import java.util.ArrayList;
> 
4a7,10
> import java.util.HashSet;
> 
> import java.util.Iterator;
> 
8a15,16
> import java.util.Set;
> 
22a31,32
> import org.eclipse.gef.commands.CompoundCommand;
> 
30a43,44
> import org.eclipse.gmf.runtime.diagram.ui.editparts.DiagramEditPart;
> 
36a37,37
> import org.eclipse.gmf.runtime.diagram.ui.IPreferenceConstants;
37,37d36
< import org.eclipse.gmf.runtime.diagram.ui.preferences.IPreferenceConstants;
38,38c38,38
< 
---
> 
70a91,92
>             return arrangeCC;
>         } else if (getOperationSet ().size () >= 2) {
70a83,89
>         if (isArrangeAll ()) {
>             CompoundCommand arrangeCC = new CompoundCommand (getLabel ());
>             List elements = getOperationSet ();
>             for (Iterator iter = elements.iterator ();
>             iter.hasNext ();) {
>                 EditPart element = (EditPart) iter.next ();
>                 arrangeCC.add (element.getCommand (getTargetRequest ()));
71,71d90
<         if (! getOperationSet ().isEmpty ()) {
72,72c93,93
<             EditPart parent = getSelectionParent (getOperationSet ());
---
>             EditPart parent = getSelectionParent (getOperationSet ());
73,73d93
<             if (parent != null) {
74a95,95
> 
74,74c94,94
<                 return parent.getCommand (getTargetRequest ());
---
>             if (parent != null) return parent.getCommand (getTargetRequest ());
76a97,97
> 
97a119,121
>             if (! selection.isEmpty ()) {
>                 return getElementsToArrange (selection);
>             }
98,99d118
<             if (! selection.isEmpty () && selection.get (0) instanceof ShapeCompartmentEditPart) return createOperationSet (((ShapeCompartmentEditPart) selection.get (0)).getChildren ());
< 
196a219,224
>             if (isArrangeAll ()) {
>                 for (Iterator iter = operationSet.iterator ();
>                 iter.hasNext ();) {
>                     IGraphicalEditPart element = (IGraphicalEditPart) iter.next ();
>                     AnimationFigureHelper.getInstance ().animate (element.getFigure ());
>                 }
197,197c225,225
<             if (operationSet != null && ! operationSet.isEmpty ()) {
---
>             } else if (operationSet != null && ! operationSet.isEmpty ()) {
200a229,230
> 
>         }
201a232,254
> 
>     private List getElementsToArrange (List selection) {
>         Set parentsSet = new HashSet ();
>         for (Iterator iter = selection.iterator ();
>         iter.hasNext ();) {
>             Object element = iter.next ();
>             if (element instanceof ShapeCompartmentEditPart || element instanceof DiagramEditPart) {
>                 parentsSet.add (element);
>             } else if (element instanceof EditPart) {
>                 EditPart gEditPart = (EditPart) element;
>                 EditPart parentEditPart = gEditPart.getParent ();
>                 if (parentEditPart instanceof ShapeCompartmentEditPart || parentEditPart instanceof DiagramEditPart) {
>                     if (! parentsSet.contains (parentEditPart)) parentsSet.add (parentEditPart);
> 
>                 }
>             }
> 
>         }
>         if (parentsSet.isEmpty ()) return Collections.EMPTY_LIST;
> 
>         List elements = new ArrayList ();
>         elements.addAll (parentsSet);
>         return elements;
