5,6d4
< import java.util.HashMap;
< 
11,12d8
< import java.util.Map;
< 
43,43c115,115
< import org.eclipse.jface.preference.IPreferenceStore;
---
> import org.eclipse.jface.preference.IPreferenceStore;
44,44c116,116
< 
---
> 
45,45c117,117
< import org.eclipse.jface.util.Assert;
---
> import org.eclipse.jface.util.Assert;
46,46c118,118
< 
---
> 
47,47c119,119
< import org.eclipse.swt.widgets.Display;
---
> import org.eclipse.swt.widgets.Display;
48,48c120,120
< 
---
> 
84a77,78
> import org.eclipse.gmf.runtime.diagram.ui.internal.requests.CreateViewRequestFactory;
> 
101,101c55,55
< import org.eclipse.gmf.runtime.diagram.core.util.ViewUtil;
---
> import org.eclipse.gmf.runtime.diagram.core.util.ViewUtil;
102,102c56,56
< 
---
> 
107,107c103,103
< import org.eclipse.gmf.runtime.emf.ui.services.modelingassistant.ModelingAssistantService;
---
> import org.eclipse.gmf.runtime.emf.ui.services.modelingassistant.ModelingAssistantService;
108,108c104,104
< 
---
> 
437a501,505
>     protected List getConnectionMenuContent (CreateConnectionRequest request) {
>         List validRelTypes = new ArrayList ();
>         if (request instanceof CreateUnspecifiedTypeConnectionRequest) {
>             CreateUnspecifiedTypeConnectionRequest unspecifiedRequest = (CreateUnspecifiedTypeConnectionRequest) request;
>             List allRequests = unspecifiedRequest.getAllRequests ();
437a477,478
>         List menuContent = getConnectionMenuContent (request);
>         if (menuContent.isEmpty ()) {
438,438d500
<         List allRequests = request.getAllRequests ();
439a507,507
>                 return null;
439,439c506,506
<         if (allRequests.isEmpty ()) {
---
>             if (allRequests.isEmpty ()) {
440a480,481
>         } else if (menuContent.size () == 1) {
>             return getConnectionCompleteCommand (menuContent.get (0), request);
441,441d508
<         }
442,442c509,509
<         IGraphicalEditPart sourceEP = (IGraphicalEditPart) ((CreateConnectionRequest) allRequests.get (0)).getSourceEditPart ();
---
>             IGraphicalEditPart sourceEP = (IGraphicalEditPart) ((CreateConnectionRequest) allRequests.get (0)).getSourceEditPart ();
443,443c510,510
<         IGraphicalEditPart targetEP = (IGraphicalEditPart) ((CreateConnectionRequest) allRequests.get (0)).getTargetEditPart ();
---
>             IGraphicalEditPart targetEP = (IGraphicalEditPart) ((CreateConnectionRequest) allRequests.get (0)).getTargetEditPart ();
443a511,513
>             List allRelTypes = unspecifiedRequest.useModelingAssistantService () ? ModelingAssistantService.getInstance ().getRelTypesOnSourceAndTarget (sourceEP, targetEP) : unspecifiedRequest.getElementTypes ();
>             for (Iterator iter = allRelTypes.iterator ();
>             iter.hasNext ();) {
444,448d510
<         List relTypes = request.useModelingAssistantService () ? ModelingAssistantService.getInstance ().getRelTypesOnSourceAndTarget (sourceEP, targetEP) : request.getElementTypes ();
<         final Map connectionCmds = new HashMap ();
<         List validRelTypes = new ArrayList ();
<         for (Iterator iter = relTypes.iterator ();
<         iter.hasNext ();) {
449a515,516
>                 Command individualCmd = null;
>                 Request createConnectionRequest = unspecifiedRequest.getRequestForType (type);
449,449c514,514
<             IElementType type = (IElementType) iter.next ();
---
>                 IElementType type = (IElementType) iter.next ();
450,450d514
<             Request createConnectionRequest = request.getRequestForType (type);
451,451c517,517
<             if (createConnectionRequest != null) {
---
>                 if (createConnectionRequest != null) {
452,452c518,518
<                 Command individualCmd = getHost ().getCommand (createConnectionRequest);
---
>                     individualCmd = getHost ().getCommand (createConnectionRequest);
453,455d518
<                 if (individualCmd != null && individualCmd.canExecute ()) {
<                     connectionCmds.put (type, individualCmd);
<                     validRelTypes.add (type);
456a520,520
>                     CreateConnectionViewRequest connectionRequest = CreateViewRequestFactory.getCreateConnectionRequest (type, ((IGraphicalEditPart) getHost ()).getDiagramPreferencesHint ());
456,456c519,519
<                 }
---
>                 } else {
457,460d519
<             }
<         }
<         if (connectionCmds.isEmpty ()) {
<             return null;
461a522,528
>                     connectionRequest.setTargetEditPart (sourceEP);
>                     connectionRequest.setType (RequestConstants.REQ_CONNECTION_START);
>                     sourceEP.getCommand (connectionRequest);
>                     connectionRequest.setSourceEditPart (sourceEP);
>                     connectionRequest.setTargetEditPart (targetEP);
>                     connectionRequest.setType (RequestConstants.REQ_CONNECTION_END);
>                     individualCmd = targetEP.getCommand (connectionRequest);
461,461c521,521
<         } else if (connectionCmds.size () == 1) {
---
>                     connectionRequest.setSourceEditPart (null);
462,462d521
<             return (Command) connectionCmds.values ().toArray () [0];
464,465d482
<             CreateOrSelectElementCommand selectAndCreateConnectionCmd = new CreateOrSelectElementCommand (CREATE_CONNECTION_COMMAND_LABEL, Display.getCurrent ().getActiveShell (), validRelTypes) {
<                 private Command undoCommand;
466a124,133
>     protected class PromptAndCreateConnectionCommand extends CreateOrSelectElementCommand {
>         private CreateConnectionRequest request;
> 
>         public PromptAndCreateConnectionCommand (List content, CreateConnectionRequest request) {
>             super (CREATE_CONNECTION_COMMAND_LABEL, Display.getCurrent ().getActiveShell (), content);
>             this.request = request;
>         }
> 
>         private Command createCommand;
> 
467,467c134,134
<                 protected CommandResult doExecute (IProgressMonitor progressMonitor) {
---
>         protected CommandResult doExecute (IProgressMonitor progressMonitor) {
468,468c135,135
<                     CommandResult cmdResult = super.doExecute (progressMonitor);
---
>             CommandResult cmdResult = super.doExecute (progressMonitor);
469,469c136,136
<                     if (! cmdResult.getStatus ().isOK ()) {
---
>             if (! cmdResult.getStatus ().isOK ()) {
470a138,164
>             }
>             Command cmd = getConnectionCompleteCommand (cmdResult.getReturnValue (), getRequest ());
>             Assert.isTrue (cmd != null && cmd.canExecute ());
>             cmd.execute ();
>             createCommand = cmd;
>             return newOKCommandResult ();
>         }
> 
>         protected CommandResult doUndo () {
>             if (createCommand != null) {
>                 createCommand.undo ();
>             }
>             return super.doUndo ();
>         }
> 
>         protected CommandResult doRedo () {
>             if (createCommand != null) {
>                 createCommand.redo ();
>             }
>             return super.doRedo ();
>         }
> 
>         private CreateConnectionRequest getRequest () {
>             return request;
>         }
> 
>     }
470,470c137,137
<                         return cmdResult;
---
>                 return cmdResult;
471a487,489
> 
>     protected ICommand getPromptAndCreateConnectionCommand (List content, CreateConnectionRequest request) {
>         return new PromptAndCreateConnectionCommand (content, request);
472,477d486
<                     IElementType relationshipType = (IElementType) cmdResult.getReturnValue ();
<                     Command cmd = (Command) connectionCmds.get (relationshipType);
<                     Assert.isTrue (cmd != null && cmd.canExecute ());
<                     cmd.execute ();
<                     undoCommand = cmd;
<                     return newOKCommandResult ();
479a492,495
>     protected Command getConnectionCompleteCommand (Object connectionType, CreateConnectionRequest request) {
>         if (connectionType instanceof IElementType) {
>             if (request instanceof CreateUnspecifiedTypeConnectionRequest) {
>                 return getHost ().getCommand (((CreateUnspecifiedTypeConnectionRequest) request).getRequestForType ((IElementType) connectionType));
480,482d491
<                 protected CommandResult doUndo () {
<                     if (undoCommand != null) {
<                         undoCommand.undo ();
483a497,498
>         }
>         return null;
484,484d496
<                     return super.doUndo ();
487,489d500
<                 protected CommandResult doRedo () {
<                     if (undoCommand != null) {
<                         undoCommand.redo ();
491,491d508
<                     return super.doRedo ();
492a530,531
>                 if (individualCmd != null && individualCmd.canExecute ()) {
>                     validRelTypes.add (type);
493,493d529
< 
495,496d482
< 
<             ;
497a484,484
>         }
497,497c483,483
<             return new EtoolsProxyCommand (selectAndCreateConnectionCmd);
---
>             return new EtoolsProxyCommand (getPromptAndCreateConnectionCommand (menuContent, request));
498a534,535
>         }
>         return validRelTypes;
499,499d533
< 
