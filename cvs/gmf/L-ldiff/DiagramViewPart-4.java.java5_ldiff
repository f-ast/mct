4a5,6
> import org.eclipse.core.runtime.NullProgressMonitor;
> 
26a31,31
> import org.eclipse.gef.commands.CommandStackEvent;
27,27d30
< import org.eclipse.gef.commands.Command;
28a33,34
> import org.eclipse.gef.commands.CommandStackEventListener;
> 
28,28c32,32
< 
---
> 
88,88c109,109
<             myDiagramDisplayer.dispose ();
---
>             disposeDisplayer (myDiagramDisplayer);
130a152,152
>             initDisplayer (myDiagramDisplayer);
140a163,163
>                     disposeDisplayer (myDiagramDisplayer);
141,142d162
<                     myDiagramDisplayer.getTopLevelControl ().dispose ();
<                     myDiagramDisplayer.dispose ();
148a170,170
>             disposeDisplayer (oldDiagramDisplayer);
149,150d169
<             oldDiagramDisplayer.getTopLevelControl ().dispose ();
<             oldDiagramDisplayer.dispose ();
155a176,187
>     protected void initDisplayer (DiagramDisplayer diagramDisplayer) {
>         diagramDisplayer.getCommandStack ().addCommandStackEventListener (mySaveListener);
>     }
> 
>     protected void disposeDisplayer (DiagramDisplayer diagramDisplayer) {
>         if (diagramDisplayer.getTopLevelControl () != null) {
>             diagramDisplayer.getTopLevelControl ().dispose ();
>         }
>         diagramDisplayer.getCommandStack ().removeCommandStackEventListener (mySaveListener);
>         diagramDisplayer.dispose ();
>     }
> 
167a83,83
>     private CommandStackEventListener mySaveListener = new CommandStackEventListener () {
168,168d82
<         domain.setCommandStack (new CommandStack () {
169a85,93
>         public void stackChanged (CommandStackEvent event) {
>             assert event.getSource () == myDiagramDisplayer.getCommandStack ();
>             if (event.isPostChangeEvent ()) {
>                 try {
>                     myDiagramDisplayer.save (new NullProgressMonitor ());
>                     myDiagramDisplayer.getCommandStack ().markSaveLocation ();
>                 } catch (CoreException e) {
>                     Activator.getDefault ().getLog ().log (e.getStatus ());
>                 }
169,169c84,84
< 
---
> 
170,173d84
<             @Override
<             public void execute (Command command) {
<                 super.execute (command);
<                 save ();
174a95,95
>         }
174,174c94,94
<             }
---
>             }
175a97,97
>     }
175,175c96,96
< 
---
> 
176,180d96
<             @Override
<             public void undo () {
<                 super.undo ();
<                 save ();
<             }
181,181c98,98
< 
---
> 
182,197d98
<             @Override
<             public void redo () {
<                 super.redo ();
<                 save ();
<             }
< 
<             private void save () {
<                 try {
<                     myDiagramDisplayer.save (null);
<                 } catch (CoreException e) {
<                     Activator.getDefault ().getLog ().log (e.getStatus ());
<                 }
<             }
< 
<         }
< 
198,198c99,99
<         );
---
>     ;
