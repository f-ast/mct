24a47,47
> import org.eclipse.gef.EditPartViewer;
25,25d46
< import org.eclipse.core.runtime.Platform;
26,26c48,48
< 
---
> 
108a117,117
> import org.eclipse.gmf.runtime.diagram.ui.parts.DiagramGraphicalViewer;
109,109d116
< import org.eclipse.gmf.runtime.diagram.ui.internal.editparts.DefaultEditableEditPart;
110,110c118,118
< 
---
> 
114a123,123
> import org.eclipse.gmf.runtime.diagram.ui.preferences.IPreferenceConstants;
115,115d122
< import org.eclipse.gmf.runtime.diagram.ui.internal.l10n.DiagramFontRegistry;
116,116c124,124
< 
---
> 
132a133,134
> import org.eclipse.gmf.runtime.draw2d.ui.figures.FigureUtilities;
> 
170a161,161
> import org.eclipse.jface.preference.IPreferenceStore;
171,171d160
< import org.eclipse.swt.widgets.Display;
172a163,172
> import org.eclipse.jface.preference.PreferenceConverter;
> 
> import org.eclipse.jface.resource.DeviceResourceException;
> 
> import org.eclipse.jface.resource.FontDescriptor;
> 
> import org.eclipse.jface.resource.JFaceResources;
> 
> import org.eclipse.jface.resource.ResourceManager;
> 
172,172c162,162
< 
---
> 
178a191,191
>     private boolean isEditable = true;
179,179d190
<     private final IEditableEditPart editableEditPart;
180a193,193
>     private FontData cachedFontData;
184,184d196
<         this.editableEditPart = new DefaultEditableEditPart (this);
191a204,213
>         EObject semanticElement;
>         EObject semanticProxy;
>         if (hasNotationView ()) {
>             semanticProxy = ((View) super.getModel ()).getElement ();
>             if ((semanticProxy == null) || semanticProxy.eIsProxy ()) {
>                 semanticElement = null;
>             } else {
>                 semanticElement = semanticProxy;
>             }
>         } else {
192,193d203
<         EObject semanticProxy = null;
<         if (hasNotationView ()) semanticProxy = ((View) getModel ()).getElement ();
194,194c214,214
<         else semanticProxy = (EObject) basicGetModel ();
---
>             semanticProxy = (EObject) basicGetModel ();
194a215,215
>             if ((semanticProxy != null) && semanticProxy.eIsProxy ()) {
195,195d214
< 
196a217,220
>             } else {
>                 semanticElement = semanticProxy;
>             }
>         }
196,196c216,216
<         EObject semanticElement = EMFCoreUtil.resolve (getEditingDomain (), semanticProxy);
---
>                 semanticElement = EMFCoreUtil.resolve (getEditingDomain (), semanticProxy);
267a292,299
>     public void removeNotify () {
>         super.removeNotify ();
>         if (cachedFontData != null) {
>             getResourceManager ().destroyFont (FontDescriptor.createFrom (cachedFontData));
>             cachedFontData = null;
>         }
>     }
> 
277,277c318,318
<         Object model = basicGetModel ();
---
>         Object model = basicGetModel ();
283a315,315
>             else return null;
296,296c329,329
<             if (key.isInstance (semanticObject)) {
---
>             if ((semanticObject != null) && key.isInstance (semanticObject)) {
303,303c336,336
<         Object adapter = super.getAdapter (key);
---
>         return super.getAdapter (key);
304,306d336
<         if (adapter != null) return adapter;
< 
<         return Platform.getAdapterManager ().getAdapter (this, key);
317a348,349
>         View view;
>         if (hasNotationView () && (view = (View) super.getModel ()) != null) {
318,318d347
<         if (getModel () != null) {
319,319c350,350
<             View view = ViewUtil.getChildBySemanticHint ((View) getModel (), semanticHint);
---
>             view = ViewUtil.getChildBySemanticHint (view, semanticHint);
331a363,364
>         View view;
>         if (hasNotationView () && (view = (View) super.getModel ()) != null) {
332,332d362
<         if (getModel () != null) {
333,333c365,365
<             return ViewUtil.getChildBySemanticHint ((View) getModel (), semanticHint);
---
>             return ViewUtil.getChildBySemanticHint (view, semanticHint);
377,377c409,409
<                     cc.add (ToggleCanonicalModeCommand.getToggleCanonicalModeCommand (tcmd, true));
---
>                     ToggleCanonicalModeCommand tcmd2 = ToggleCanonicalModeCommand.getToggleCanonicalModeCommand (tcmd, true);
377a410,413
>                     if (tcmd2 != null) {
>                         tcmd2.setDomain (getEditingDomain ());
>                     }
>                     cc.add (tcmd2);
459,460d494
<         EditDomain editDomain = getEditDomain ();
<         if (editDomain != null) {
461,461c495,495
<             return (IDiagramEditDomain) editDomain;
---
>         return (IDiagramEditDomain) getEditDomain ();
462,463d495
<         }
<         return null;
475,475c507,507
<         if (hasNotationView ()) return ViewUtil.getStructuralFeatureValue ((View) getModel (), feature);
---
>         if (hasNotationView ()) return ViewUtil.getPropertyValue ((View) super.getModel (), feature, feature.getEContainingClass ());
480a513,526
>         EObject semanticElement = null;
>         Object basicModel = basicGetModel ();
>         if (hasNotationView ()) {
>             semanticElement = ((View) basicModel).getElement ();
>         } else if (basicModel instanceof EObject) {
>             semanticElement = (EObject) basicModel;
>         }
> 
>         if (semanticElement == null) {
>             return null;
>         }
>         if (! semanticElement.eIsProxy ()) {
>             return semanticElement;
>         }
583,583c629,629
<         FillStyle style = (FillStyle) getPrimaryView ().getStyle (NotationPackage.eINSTANCE.getFillStyle ());
---
>         FillStyle style = (FillStyle) getPrimaryView ().getStyle (NotationPackage.Literals.FILL_STYLE);
590,590c636,636
<         FontStyle style = (FontStyle) getPrimaryView ().getStyle (NotationPackage.eINSTANCE.getFontStyle ());
---
>         FontStyle style = (FontStyle) getPrimaryView ().getStyle (NotationPackage.Literals.FONT_STYLE);
597,597c643,643
<         FontStyle style = (FontStyle) getPrimaryView ().getStyle (NotationPackage.eINSTANCE.getFontStyle ());
---
>         FontStyle style = (FontStyle) getPrimaryView ().getStyle (NotationPackage.Literals.FONT_STYLE);
604,604c650,650
<         LineStyle style = (LineStyle) getPrimaryView ().getStyle (NotationPackage.eINSTANCE.getLineStyle ());
---
>         LineStyle style = (LineStyle) getPrimaryView ().getStyle (NotationPackage.Literals.LINE_STYLE);
629,629c675,675
<         Object [] objects = (Object []) listenerFilters.get (filterId);
---
>         Object [] objects = (Object []) listenerFilters.remove (filterId);
637,637d682
<         listenerFilters.remove (filterId);
644a690,694
>         if (cachedFontData != null && cachedFontData.equals (fontData)) {
>             return;
>         }
>         try {
>             Font newFont = getResourceManager ().createFont (FontDescriptor.createFrom (fontData));
645,646d689
<         Font newFont = DiagramFontRegistry.getInstance ().getFont (Display.getDefault (), fontData);
<         if (! newFont.equals (getFigure ().getFont ())) {
648a697,703
>             if (cachedFontData != null) {
>                 getResourceManager ().destroyFont (FontDescriptor.createFrom (cachedFontData));
>             }
>             cachedFontData = fontData;
>         } catch (DeviceResourceException e) {
>             Trace.catching (DiagramUIPlugin.getInstance (), DiagramUIDebugOptions.EXCEPTIONS_CATCHING, getClass (), "setFont", e);
>             Log.error (DiagramUIPlugin.getInstance (), DiagramUIStatusCodes.IGNORED_EXCEPTION_WARNING, "setFont", e);
660,660c715,715
<         if (hasNotationView ()) ViewUtil.setStructuralFeatureValue ((View) getModel (), feature, value);
---
>         if (hasNotationView () && (feature != null)) {
660a716,717
>             ViewUtil.setPropertyValue ((View) super.getModel (), feature, feature.getEContainingClass (), value);
>         }
661,661d715
< 
749a806,806
>         EditPartViewer viewer = getViewer ();
753,753c810,810
<             getViewer ().getEditPartRegistry ().put (basicGetModel (), this);
---
>             viewer.getEditPartRegistry ().put (basicGetModel (), this);
763,763c820,820
<         ((IDiagramGraphicalViewer) getViewer ()).registerEditPartForElement (elementGuid, this);
---
>         ((IDiagramGraphicalViewer) viewer).registerEditPartForElement (elementGuid, this);
766a824,824
>         EditPartViewer viewer = getViewer ();
769,769c827,827
<             Map registry = getViewer ().getEditPartRegistry ();
---
>             Map registry = viewer.getEditPartRegistry ();
776,776c834,834
<         ((IDiagramGraphicalViewer) getViewer ()).unregisterEditPartForElement (elementGuid, this);
---
>         ((IDiagramGraphicalViewer) viewer).unregisterEditPartForElement (elementGuid, this);
804,804c862,862
<     public final boolean isCanonical () {
---
>     public boolean isCanonical () {
813a872,893
>         if (! isEditModeEnabled ()) {
>             return;
>         }
>         List l = getSourceConnections ();
>         int size = l.size ();
>         for (int i = 0;
>         i < size; i ++) {
>             Object obj = l.get (i);
>             if (obj instanceof IEditableEditPart) {
>                 ((IEditableEditPart) obj).disableEditMode ();
>             }
>         }
>         List c = getChildren ();
>         size = c.size ();
>         for (int i = 0;
>         i < size; i ++) {
>             Object obj = c.get (i);
>             if (obj instanceof IEditableEditPart) {
>                 ((IEditableEditPart) obj).disableEditMode ();
>             }
>         }
>         isEditable = false;
814,814d871
<         this.editableEditPart.disableEditMode ();
817a897,918
>         if (isEditModeEnabled ()) {
>             return;
>         }
>         isEditable = true;
>         List c = getChildren ();
>         int size = c.size ();
>         for (int i = 0;
>         i < size; i ++) {
>             Object obj = c.get (i);
>             if (obj instanceof IEditableEditPart) {
>                 ((IEditableEditPart) obj).enableEditMode ();
>             }
>         }
>         List l = getSourceConnections ();
>         size = l.size ();
>         for (int i = 0;
>         i < size; i ++) {
>             Object obj = l.get (i);
>             if (obj instanceof IEditableEditPart) {
>                 ((IEditableEditPart) obj).enableEditMode ();
>             }
>         }
818,818d896
<         this.editableEditPart.enableEditMode ();
823a924,924
>         return isEditable;
824,824d923
<         return this.editableEditPart.isEditModeEnabled ();
861a962,963
>         RootEditPart root = getRoot ();
>         if (root instanceof IDiagramPreferenceSupport) {
862,862d961
<         if (getRoot () instanceof IDiagramPreferenceSupport) {
863,863c964,964
<             return ((IDiagramPreferenceSupport) getRoot ()).getPreferencesHint ();
---
>             return ((IDiagramPreferenceSupport) root).getPreferencesHint ();
879,879c980,980
<         if (NotationPackage.eINSTANCE.getView_PersistedChildren ().equals (event.getFeature ()) || NotationPackage.eINSTANCE.getView_TransientChildren ().equals (event.getFeature ())) {
---
>         if (NotationPackage.Literals.VIEW__PERSISTED_CHILDREN.equals (event.getFeature ()) || NotationPackage.Literals.VIEW__TRANSIENT_CHILDREN.equals (event.getFeature ())) {
881,881c982,982
<         } else if (NotationPackage.eINSTANCE.getView_Visible ().equals (event.getFeature ())) {
---
>         } else if (NotationPackage.Literals.VIEW__VISIBLE.equals (event.getFeature ())) {
887,887c988,988
<         } else if (NotationPackage.eINSTANCE.getView_Element ().equals (event.getFeature ())) {
---
>         } else if (NotationPackage.Literals.VIEW__ELEMENT.equals (event.getFeature ())) {
893,893c994,994
<     final protected IMapMode getMapMode () {
---
>     protected IMapMode getMapMode () {
927a1029,1037
>     protected IFigure createFigure () {
>         return null;
>     }
> 
>     public void setModel (Object model) {
>         editingDomain = null;
>         super.setModel (model);
>     }
> 
942a1053,1075
>     public Object getPreferredValue (EStructuralFeature feature) {
>         Object preferenceStore = getDiagramPreferencesHint ().getPreferenceStore ();
>         if (preferenceStore instanceof IPreferenceStore) {
>             if (feature == NotationPackage.eINSTANCE.getLineStyle_LineColor ()) {
>                 return FigureUtilities.RGBToInteger (PreferenceConverter.getColor ((IPreferenceStore) preferenceStore, IPreferenceConstants.PREF_LINE_COLOR));
>             } else if (feature == NotationPackage.eINSTANCE.getFontStyle_FontColor ()) {
>                 return FigureUtilities.RGBToInteger (PreferenceConverter.getColor ((IPreferenceStore) preferenceStore, IPreferenceConstants.PREF_FONT_COLOR));
>             } else if (feature == NotationPackage.eINSTANCE.getFillStyle_FillColor ()) {
>                 return FigureUtilities.RGBToInteger (PreferenceConverter.getColor ((IPreferenceStore) preferenceStore, IPreferenceConstants.PREF_FILL_COLOR));
>             }
> 
>         }
>         return getStructuralFeatureValue (feature);
>     }
> 
>     protected ResourceManager getResourceManager () {
>         EditPartViewer viewer = getViewer ();
>         if (viewer instanceof DiagramGraphicalViewer) {
>             return ((DiagramGraphicalViewer) viewer).getResourceManager ();
>         }
>         return JFaceResources.getResources ();
>     }
> 
