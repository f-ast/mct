64a91,91
> import org.eclipse.gmf.runtime.notation.CanonicalStyle;
65,65d90
< import org.eclipse.gmf.runtime.diagram.core.listener.PropertyChangeNotifier;
66a93,94
> import org.eclipse.gmf.runtime.notation.DrawerStyle;
> 
66,66c92,92
< 
---
> 
77,77c99,99
< import org.eclipse.gmf.runtime.diagram.ui.editparts.ConnectionEditPart;
---
> import org.eclipse.gmf.runtime.notation.Style;
78,78d99
< 
97,97c101,101
< import org.eclipse.gmf.runtime.notation.View;
---
> import org.eclipse.gmf.runtime.notation.View;
99,99c35,35
< import org.eclipse.jface.util.Assert;
---
> import org.eclipse.emf.common.util.UniqueEList;
99a36,36
> 
104,104c106,106
<     public static class AsyncCommand extends Command {
---
>     private static class AsyncCommand extends Command {
157,157c159,159
<     public static final class CanonicalElementAdapter extends EObjectAdapter {
---
>     protected static final class CanonicalElementAdapter extends EObjectAdapter {
337a340,342
>         Command cmd = host ().getCommand (request);
>         if (cmd == null) {
>             assert request instanceof CreateViewRequest;
338,338d339
<         Assert.isTrue (request instanceof CreateViewRequest);
346,346c350,350
<         return new EtoolsProxyCommand (cc.unwrap ());
---
>             cmd = new EtoolsProxyCommand (cc.unwrap ());
346a351,352
>         }
>         return cmd;
373a380,380
>             addListenerFilter (SEMANTIC_FILTER_ID, this, semanticHost);
374a382,389
>             Style style = ((View) host ().getModel ()).getStyle (NotationPackage.eINSTANCE.getDrawerStyle ());
>             if (style != null) {
>                 addListenerFilter ("NotationListener_DrawerStyle", this, style);
>             }
>             style = ((View) host ().getModel ()).getStyle (NotationPackage.eINSTANCE.getCanonicalStyle ());
>             if (style != null) {
>                 addListenerFilter ("NotationListener_CanonicalStyle", this, style);
>             }
380a396,403
>         DrawerStyle dstyle = (DrawerStyle) ((View) host ().getModel ()).getStyle (NotationPackage.eINSTANCE.getDrawerStyle ());
>         boolean isCollapsed = dstyle == null ? false : dstyle.isCollapsed ();
>         if (isCollapsed) {
>             return false;
>         }
>         CanonicalStyle style = getCanonicalStyle ();
>         boolean enabled = _enabled && ((View) host ().getModel ()).isVisible ();
>         return style == null ? enabled : style.isCanonical () && enabled;
381,381d395
<         return _enabled && ((View) host ().getModel ()).isVisible ();
420,420d441
<         removeListenerFilter ("NotationListener_Visibility");
424,439d444
<     protected boolean addListenerFilter (String filterId, PropertyChangeListener listener, PropertyChangeNotifier notifier) {
<         if (filterId == null || listener == null) {
<             throw new NullPointerException ();
<         }
<         if (notifier != null) {
<             if (_listenerFilters == null) _listenerFilters = new HashMap ();
< 
<             if (! _listenerFilters.containsKey (filterId)) {
<                 notifier.addPropertyChangeListener (listener);
<                 _listenerFilters.put (filterId, new Object [] {notifier, listener});
<                 return true;
<             }
<         }
<         return false;
<     }
< 
481,483d485
<             if (objects [0] instanceof PropertyChangeNotifier) {
<                 ((PropertyChangeNotifier) objects [0]).removePropertyChangeListener ((PropertyChangeListener) objects [1]);
<             } else {
487,487d488
<     }
516a518,523
>             if (NotationPackage.eINSTANCE.getCanonicalStyle_Canonical () == event.getFeature ()) {
>                 CanonicalStyle style = (CanonicalStyle) ((View) host ().getModel ()).getStyle (NotationPackage.eINSTANCE.getCanonicalStyle ());
>                 if (style != null) {
>                     setEnable (style.isCanonical ());
>                 }
>             }
527a535,535
>         if (NotationPackage.eINSTANCE.getDrawerStyle_Collapsed () == event.getFeature () || NotationPackage.eINSTANCE.getCanonicalStyle_Canonical () == event.getFeature () || NotationPackage.eINSTANCE.getView_Visible () == event.getFeature () || NotationPackage.eINSTANCE.getView_PersistedChildren () == event.getFeature ()) {
528,528d534
<         if (NotationPackage.eINSTANCE.getView_Visible () == event.getFeature ()) {
568a576,576
>             addListenersToContainers (createdViews);
575a584,601
>     private void addListenersToContainers (List createdViews) {
>         UniqueEList list = new UniqueEList ();
>         ListIterator li = createdViews.listIterator ();
>         while (li.hasNext ()) {
>             Object obj = li.next ();
>             if (obj instanceof IAdaptable) {
>                 View view = (View) ((IAdaptable) obj).getAdapter (View.class);
>                 if (view != null) list.add (view.eContainer ());
> 
>             }
>         }
>         ListIterator liContainers = list.listIterator ();
>         while (liContainers.hasNext ()) {
>             View containerView = (View) liContainers.next ();
>             addListenerFilter ("NotationListener_Container" + containerView.toString (), this, containerView, NotationPackage.eINSTANCE.getView_PersistedChildren ());
>         }
>     }
> 
625a652,652
>         Map viewToSemanticMap = new HashMap ();
630a658,658
>                 viewToSemanticMap.put (semanticChild, viewChild);
633a662,669
>             View viewInMap = (View) viewToSemanticMap.get (semanticChild);
>             if (viewInMap != null && ! viewChild.equals (viewInMap)) {
>                 if (viewInMap.isMutable ()) {
>                     orphaned.remove (viewChild);
>                     orphaned.add (viewInMap);
>                     viewToSemanticMap.put (semanticChild, viewChild);
>                 }
>             }
645a682,685
>     protected CanonicalStyle getCanonicalStyle () {
>         return (CanonicalStyle) ((View) host ().getModel ()).getStyle (NotationPackage.eINSTANCE.getCanonicalStyle ());
>     }
> 
