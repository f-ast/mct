12a13,14
> import java.util.Map;
> 
88a91,93
>     private static final String DEFINE_ONLY = "defineOnly";
>     private static final String PREDEFINED_ENTRY = "predefinedEntry";
>     private static final String REMOVE = "remove";
113a119,123
>             configChildren = configElement.getChildren (PREDEFINED_ENTRY);
>             for (int i = 0;
>             i < configChildren.length; i ++) {
>                 entries.add (new PredefinedEntryDescriptor (configChildren [i]));
>             }
116,116c126,126
<         public void contribute (Object content, PaletteRoot root) {
---
>         public void contribute (Object content, PaletteRoot root, Map predefinedEntries) {
119,119c129,129
<                 ((EntryDescriptor) iter.next ()).contribute (content, root, paletteFactory);
---
>                 ((IEntryDescriptor) iter.next ()).contribute (content, root, paletteFactory, predefinedEntries);
125a136,141
> 
>         public void contribute (Object content, PaletteRoot root, PaletteFactoryProxy paletteFactory, Map predefinedEntries);
> 
>     }
> 
>     private static class EntryDescriptor implements IEntryDescriptor {
125,125c135,135
<     private static class EntryDescriptor {
---
>     private static interface IEntryDescriptor {
134a151,151
>         private boolean defineOnly;
147a165,165
>             defineOnly = Boolean.valueOf (configElement.getAttribute (DEFINE_ONLY)).booleanValue ();
149,149c167,167
<             if (path == null) Log.info (DiagramProvidersPlugin.getInstance (), DiagramProvidersStatusCodes.SERVICE_FAILURE, "No factory class name is provided");
---
>             if (path == null && ! defineOnly) Log.info (DiagramProvidersPlugin.getInstance (), DiagramProvidersStatusCodes.SERVICE_FAILURE, "Path must be provided when contributing a palette entry");
193,193c211,211
<         public void contribute (Object content, PaletteRoot root, PaletteFactoryProxy paletteFactory) {
---
>         public void contribute (Object content, PaletteRoot root, PaletteFactoryProxy paletteFactory, Map predefinedEntries) {
194,194c212,212
<             if (kind == null || id == null || path == null || label == null) return;
---
>             if (kind == null || id == null || label == null) return;
222a323,327
>     private static void appendPaletteEntry (PaletteRoot root, Map predefinedEntries, String path, PaletteEntry paletteEntry) {
>         PaletteEntry fEntry = findPaletteEntry (root, path);
>         if (fEntry == null) {
>             fEntry = findPredefinedEntry (predefinedEntries, path);
>         }
222a241,255
>                 if (defineOnly) {
>                     predefinedEntries.put (id, paletteEntry);
>                 } else {
>                     appendPaletteEntry (root, predefinedEntries, path, paletteEntry);
>                 }
>             }
>         }
> 
>     }
> 
>     private static class PredefinedEntryDescriptor implements IEntryDescriptor {
>         private String id;
>         private String path;
>         private DrawerExpandHelper expandHelper;
>         private boolean remove;
223,223d322
<                 PaletteEntry fEntry = findPaletteEntry (root, path);
224,224c328,328
<                 if (fEntry == null) Log.info (DiagramProvidersPlugin.getInstance (), DiagramProvidersStatusCodes.SERVICE_FAILURE, "Invalid palette entry path");
---
>         if (fEntry == null) Log.info (DiagramProvidersPlugin.getInstance (), DiagramProvidersStatusCodes.SERVICE_FAILURE, "Invalid palette entry path");
224a329,330
>         else if (fEntry instanceof PaletteContainer) ((PaletteContainer) fEntry).add (paletteEntry);
>         else if (fEntry instanceof PaletteSeparator) appendTo ((PaletteSeparator) fEntry, paletteEntry);
225,226d328
<                 else if (fEntry instanceof PaletteContainer) ((PaletteContainer) fEntry).add (paletteEntry);
<                 else if (fEntry instanceof PaletteSeparator) appendTo ((PaletteSeparator) fEntry, paletteEntry);
227,227c331,331
<                 else fEntry.getParent ().add (fEntry.getParent ().getChildren ().indexOf (fEntry) + 1, paletteEntry);
---
>         else fEntry.getParent ().add (fEntry.getParent ().getChildren ().indexOf (fEntry) + 1, paletteEntry);
227a332,335
> 
>     }
> 
>     private static void appendTo (PaletteSeparator separator, PaletteEntry entry) {
228a257,260
>         public PredefinedEntryDescriptor (IConfigurationElement configElement) {
>             id = configElement.getAttribute (ID);
>             if (id == null) {
>                 Log.info (DiagramProvidersPlugin.getInstance (), DiagramProvidersStatusCodes.SERVICE_FAILURE, "No ID provided");
229a262,267
>             path = configElement.getAttribute (PATH);
>             IConfigurationElement [] configChildren = configElement.getChildren (EXPAND);
>             if (configChildren.length > 0) expandHelper = new DrawerExpandHelper (configChildren [0]);
>             else expandHelper = new DrawerExpandHelper (Boolean.FALSE);
> 
>             remove = Boolean.valueOf (configElement.getAttribute (REMOVE)).booleanValue ();
231a270,303
>         public void contribute (Object content, PaletteRoot root, PaletteFactoryProxy paletteFactory, Map predefinedEntries) {
>             if (id == null) return;
> 
>             PaletteEntry paletteEntry = findPredefinedEntry (predefinedEntries, id);
>             if (paletteEntry != null) {
>                 if (path != null && ! remove) {
>                     appendPaletteEntry (root, predefinedEntries, path, paletteEntry);
>                 }
>             } else {
>                 paletteEntry = findPaletteEntry (root, id);
>             }
>             if (remove) {
>                 paletteEntry.getParent ().remove (paletteEntry);
>                 return;
>             }
>             if (paletteEntry instanceof PaletteDrawer && expandHelper.expand (content)) {
>                 ((PaletteDrawer) paletteEntry).setInitialState (PaletteDrawer.INITIAL_STATE_OPEN);
>             }
>         }
> 
>     }
> 
>     private static PaletteEntry findPredefinedEntry (Map predefinedEntries, String path) {
>         StringTokenizer tokens = new StringTokenizer (path, "/");
>         PaletteEntry root = (PaletteEntry) predefinedEntries.get (tokens.nextToken ());
>         while (tokens.hasMoreElements ()) {
>             if (root instanceof PaletteContainer) root = findChildPaletteEntry ((PaletteContainer) root, tokens.nextToken ());
>             else return null;
> 
>         }
>         return root;
>     }
> 
>     private static PaletteEntry findPaletteEntry (PaletteEntry root, String aPath) {
232,232d269
<         private PaletteEntry findPaletteEntry (PaletteEntry root, String aPath) {
242,242c313,313
<         private PaletteEntry findChildPaletteEntry (PaletteContainer container, String childId) {
---
>     private static PaletteEntry findChildPaletteEntry (PaletteContainer container, String childId) {
252,252d322
<         private void appendTo (PaletteSeparator separator, PaletteEntry entry) {
262,263d344
<     }
< 
346,346c427,427
<     public void contributeToPalette (IEditorPart editor, Object content, PaletteRoot root) {
---
>     public void contributeToPalette (IEditorPart editor, Object content, PaletteRoot root, Map predefinedEntries) {
349,349c430,430
<             ((ContributionDescriptor) iter.next ()).contribute (content, root);
---
>             ((ContributionDescriptor) iter.next ()).contribute (content, root, predefinedEntries);
