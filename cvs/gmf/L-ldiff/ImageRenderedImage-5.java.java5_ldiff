6a7,8
> import org.eclipse.draw2d.SWTGraphics;
> 
22a27,29
> import org.eclipse.swt.graphics.Rectangle;
> 
> import org.eclipse.ui.PlatformUI;
23a20,20
> 
23,23c19,19
< import org.eclipse.swt.widgets.Display;
---
> import org.eclipse.swt.graphics.GC;
30a37,37
>     protected Image renderImage () {
31,33d36
<     public Image getSWTImage () {
<         if (img != null) return img;
< 
34a73,74
>                 return new Image (PlatformUI.getWorkbench ().getDisplay (), scaledImgData);
>             }
35,35d72
<             img = loadImageFromBuffer ();
36a76,77
>             Trace.throwing (Draw2dRenderPlugin.getInstance (), Draw2dRenderDebugOptions.EXCEPTIONS_THROWING, ImageRenderedImage.class, "ImageRenderedImage.renderImage() : couldn't load image from buffer", e);
>             return null;
36,36c75,75
<         } catch (Exception e) {
---
>         } catch (Exception e) {
37,37d75
<             Trace.throwing (Draw2dRenderPlugin.getInstance (), Draw2dRenderDebugOptions.EXCEPTIONS_THROWING, ImageRenderedImage.class, "ImageRenderedImage.getSWTImage() : couldn't load image from buffer", e);
38,38c78,78
<         }
---
>         }
39,42d78
<         return img;
<     }
< 
<     private Image loadImageFromBuffer () throws Exception {
49a46,46
>             int bufferWidth = getKey ().getWidth () == 0 ? origWidth : getKey ().getWidth ();
50,50d45
<         int newWidth = getKey ().getWidth () == 0 ? origWidth : getKey ().getWidth ();
51a48,49
>             int newWidth = bufferWidth;
>             int newHeight = bufferWidth;
51,51c47,47
<         int newHeight = getKey ().getHeight () == 0 ? origHeight : getKey ().getHeight ();
---
>             int bufferHeight = getKey ().getHeight () == 0 ? origHeight : getKey ().getHeight ();
52a51,57
>                 if (newWidth > newHeight) {
>                     newHeight = (int) Math.round (newWidth * origHeight / (double) origWidth);
>                 } else {
>                     newWidth = (int) Math.round (newHeight * origWidth / (double) origHeight);
>                 }
>                 double scale = 1.0;
>                 if (newWidth > bufferWidth) scale = bufferWidth / newWidth;
53,54d50
<             if (origWidth < origHeight) newWidth = (int) Math.round (newHeight * origWidth / (double) origHeight);
<             else newHeight = (int) Math.round (newWidth * origHeight / (double) origWidth);
55,55c58,58
< 
---
> 
55a59,70
>                 if (newHeight > bufferHeight) scale = Math.min (scale, bufferHeight / (double) newHeight);
> 
>                 newWidth *= scale;
>                 newHeight *= scale;
>                 Image origImage = new Image (PlatformUI.getWorkbench ().getDisplay (), imgData [0]);
>                 Image image = new Image (PlatformUI.getWorkbench ().getDisplay (), new Rectangle (0, 0, bufferWidth, bufferHeight));
>                 GC gc = new GC (image);
>                 SWTGraphics swtG = new SWTGraphics (gc);
>                 swtG.drawImage (origImage, 0, 0, origWidth, origHeight, (bufferWidth - newWidth) / 2, (bufferHeight - newHeight) / 2, newWidth, newHeight);
>                 gc.dispose ();
>                 origImage.dispose ();
>                 return image;
56,56c71,71
<         }
---
>             } else {
58,58d72
<         return new Image (Display.getDefault (), scaledImgData);
