15,16d14
< import org.eclipse.core.runtime.IAdaptable;
< 
59a58,61
>     public ViewRefactorHelper () {
>         this (PreferencesHint.USE_DEFAULTS);
>     }
> 
87,87c89,89
<             filteredObjects.add (filteredObjects.indexOf (oldElement), newElement);
---
>             if (! filteredObjects.contains (oldElement)) filteredObjects.add (filteredObjects.indexOf (oldElement), newElement);
87a90,90
> 
94a98,98
> 
94,94c97,97
<             sortingObjects.add (sortingObjects.indexOf (oldElement), newElement);
---
>             if (! sortingObjects.contains (oldElement)) sortingObjects.add (sortingObjects.indexOf (oldElement), newElement);
109a114,114
>         return null;
110,110d113
<         throw new RuntimeException ("could not refactor a node for the morphed element");
122a127,127
>         return null;
123,123d126
<         throw new RuntimeException ("could not refactor an edge for the morphed element");
132a137,137
>                 refactorDiagramLinks (oldDiagram, newDiagram);
135a141,150
>         return null;
>     }
> 
>     protected void refactorDiagramLinks (Diagram oldDiagram, Diagram newDiagram) {
>         Collection links = EObjectUtil.getReferencers (oldDiagram, new EReference [] {NotationPackage.eINSTANCE.getView_Element ()});
>         for (Iterator i = links.iterator ();
>         i.hasNext ();) {
>             View view = (View) i.next ();
>             view.setElement (newDiagram);
>         }
136,136d140
<         throw new RuntimeException ("could not refactor a diagram for the morphed element");
183,183c197,197
<     protected void copyViewStyles (View oldView, View newView, final List excludeStyles) {
---
>     protected void copyViewStyles (View oldView, View newView, List excludeStyles) {
186a201,205
>             copyViewStyle (oldView, newView, oldStyle, excludeStyles);
>         }
>     }
> 
>     protected void copyViewStyle (View oldView, View newView, Style oldStyle, List excludeStyles) {
205,205d223
<     }
235a254,262
>         Collection views = EObjectUtil.getReferencers (element, new EReference [] {NotationPackage.eINSTANCE.getView_Element ()});
>         for (Iterator i = views.iterator ();
>         i.hasNext ();) {
>             View view = (View) i.next ();
>             EObject parent = null;
>             while ((parent = view.eContainer ()) instanceof View) {
>                 if (views.contains (parent)) {
>                     i.remove ();
>                     break;
236,236d253
<         return EObjectUtil.getReferencers (element, new EReference [] {NotationPackage.eINSTANCE.getView_Element ()});
237a264,264
>                 view = (View) parent;
238,238d269
< 
239,239c270,270
<     protected Node createNode (Node oldNode, EObject newElement) {
---
>     protected Node createNode (Node oldNode, EObject newElement) {
240,240c271,271
<         return createNode (ViewUtil.getContainerView (oldNode), newElement, getNewViewType (oldNode, newElement));
---
>         return ViewService.getInstance ().createNode (new EObjectAdapter (newElement), (View) oldNode.eContainer (), getNewViewType (oldNode, newElement), ViewUtil.APPEND, preferencesHint);
242,242d273
< 
243,243c274,274
<     protected Edge createEdge (Edge oldEdge, EObject newElement) {
---
>     protected Edge createEdge (Edge oldEdge, EObject newElement) {
244,244c275,275
<         return createEdge (oldEdge.getSource (), oldEdge.getTarget (), newElement, getNewViewType (oldEdge, newElement));
---
>         Edge edge = (Edge) ViewService.getInstance ().createEdge (new EObjectAdapter (newElement), oldEdge.getDiagram (), getNewViewType (oldEdge, newElement), ViewUtil.APPEND, preferencesHint);
244a276,278
>         if (edge != null) {
>             edge.setSource (oldEdge.getSource ());
>             edge.setTarget (oldEdge.getTarget ());
245a267,267
>         return views;
246,246d282
< 
247,247c283,283
<     protected Diagram createDiagram (Diagram oldDiagram, EObject newElement) {
---
>     protected Diagram createDiagram (Diagram oldDiagram, EObject newElement) {
248,248c284,284
<         return createDiagram (newElement, getNewViewType (oldDiagram, newElement));
---
>         return ViewService.getInstance ().createDiagram (new EObjectAdapter (newElement), getNewViewType (oldDiagram, newElement), preferencesHint);
251,251c287,287
<     protected String getNewViewType (View oldView, EObject newElement) {
---
>     protected String getNewViewType (View oldView, EObject newElement) {
252,253d287
<         if (oldView instanceof Diagram) return ((Diagram) oldView).getType ();
< 
254,254c288,288
<         return null;
---
>         return oldView.getType ();
257,260d273
<     private Diagram createDiagram (EObject context, String kind) {
<         IAdaptable viewModel = (context != null) ? new EObjectAdapter (context) : null;
<         String viewType = (kind != null) ? kind : "";
<         return ViewService.getInstance ().createDiagram (viewModel, viewType, preferencesHint);
261a280,280
>         return edge;
262,267d279
< 
<     private Node createNode (View container, EObject eObject, String type) {
<         IAdaptable viewModel = (eObject != null) ? new EObjectAdapter (eObject) : null;
<         String viewType = (type != null) ? type : "";
<         View view = ViewService.getInstance ().createNode (viewModel, container, viewType, ViewUtil.APPEND, preferencesHint);
<         return (view != null) ? (Node) view : null;
270,274d282
<     private Edge createEdge (Diagram diagram, EObject eObject, String type) {
<         IAdaptable viewModel = (eObject != null) ? new EObjectAdapter (eObject) : null;
<         String viewType = (type != null) ? type : "";
<         View view = ViewService.getInstance ().createEdge (viewModel, diagram, viewType, ViewUtil.APPEND, preferencesHint);
<         return (view != null) ? (Edge) view : null;
277,283d286
<     private Edge createEdge (View source, View target, EObject eObject, String type) {
<         Edge edge = createEdge (source.getDiagram (), eObject, type);
<         if (edge != null) {
<             edge.setSource (source);
<             edge.setTarget (target);
<         }
<         return edge;
