2a3,4
> import java.util.Collection;
> 
34a37,38
> import org.eclipse.emf.ecore.EStructuralFeature.Setting;
> 
70a75,75
>     private HashSet < URI > myProcessedMetaModels = new HashSet < URI > ();
70,70c74,74
<     private EPackage.Registry registry;
---
>     private EPackage.Registry registry = new EPackageRegistryImpl (EPackage.Registry.INSTANCE);
101a107,112
>         Object value = context.get (ExternModelImport.class);
>         assert value == null || value instanceof ExternModelImport : "incorrect object registered as ExternModelImport: " + value.getClass ();
>         if (value instanceof ExternModelImport) {
>             return ((ExternModelImport) value).registry;
>         }
>         return null;
102,104d106
<         Object registry = context.get (EPackageRegistryImpl.class);
<         assert registry == null || registry instanceof EPackage.Registry : "registry must be EPackage.Registry";
<         return (EPackage.Registry) registry;
127a136,150
>         Resource metaModelResource = root.eClass ().getEPackage ().eResource ();
>         if (! myProcessedMetaModels.contains (metaModelResource.getURI ())) {
>             for (EObject nextResourceElement : metaModelResource.getContents ()) {
>                 if (nextResourceElement instanceof EPackage) {
>                     registerLocally ((EPackage) nextResourceElement);
>                 }
>             }
>             registerReferencedMetaModels (EcoreUtil.ExternalCrossReferencer.find (metaModelResource));
>             myProcessedMetaModels.add (metaModelResource.getURI ());
>         }
>         registerReferencedMetaModels (EcoreUtil.ExternalCrossReferencer.find (root));
>     }
> 
>     private void registerReferencedMetaModels (Map < EObject, Collection < Setting > > externalCrossReferences) {
>         for (EObject next : externalCrossReferences.keySet ()) {
128,129d135
<         EPackage.Registry registryToInit = registry != null ? registry : EPackage.Registry.INSTANCE;
<         for (EObject next : EcoreUtil.ExternalCrossReferencer.find (root).keySet ()) {
144a171,171
>     private void registerLocally (EPackage nextPackage) {
144a166,166
>                 registerLocally (nextPackage);
145,145c172,172
<                 registryToInit.getEPackage (nextPackage.getNsURI ());
---
>         registry.put (nextPackage.getNsURI (), registry.getEPackage (nextPackage.getNsURI ()));
145a173,174
>     }
> 
159,159c184,184
<                 EPackage p = EPackage.Registry.INSTANCE.getEPackage (importVal);
---
>                 EPackage p = registry.getEPackage (importVal);
160a186,186
>                     registerLocally (p);
211a238,238
>                     registerLocally (ePackage);
212,212d237
<                     EPackage.Registry.INSTANCE.getEPackage (ePackage.getNsURI ());
