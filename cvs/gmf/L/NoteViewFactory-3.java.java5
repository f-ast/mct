package org.eclipse.gmf.runtime.diagram.ui.view.factories;

import org.eclipse.core.runtime.IAdaptable;

import org.eclipse.emf.ecore.EAnnotation;

import org.eclipse.emf.ecore.EcoreFactory;

import org.eclipse.jface.preference.IPreferenceStore;

import org.eclipse.jface.preference.PreferenceConverter;

import org.eclipse.swt.graphics.RGB;

import org.eclipse.gmf.runtime.diagram.core.preferences.PreferencesHint;

import org.eclipse.gmf.runtime.diagram.core.util.ViewUtil;

import org.eclipse.gmf.runtime.diagram.ui.IPreferenceConstants;

import org.eclipse.gmf.runtime.diagram.ui.properties.Properties;

import org.eclipse.gmf.runtime.draw2d.ui.figures.FigureUtilities;

import org.eclipse.gmf.runtime.notation.Diagram;

import org.eclipse.gmf.runtime.notation.View;

public class NoteViewFactory extends TextShapeViewFactory {

    public View createView (IAdaptable semanticAdapter, View containerView, String semanticHint, int index, boolean persisted, final PreferencesHint preferencesHint) {
        View view = super.createView (semanticAdapter, containerView, semanticHint, index, persisted, preferencesHint);
        if (view.getElement () instanceof Diagram) {
            if (semanticHint == null || semanticHint.length () == 0) view.setType (Properties.NOTE);

            EAnnotation annotation = EcoreFactory.eINSTANCE.createEAnnotation ();
            annotation.setSource (Properties.DIAGRAMLINK_ANNOTATION);
            view.getEAnnotations ().add (annotation);
        }
        return view;
    }

    protected void initializeFromPreferences (View view) {
        super.initializeFromPreferences (view);
        if (! (view.getElement () instanceof Diagram)) {
            IPreferenceStore store = (IPreferenceStore) getPreferencesHint ().getPreferenceStore ();
            RGB fillRGB = PreferenceConverter.getColor (store, IPreferenceConstants.PREF_NOTE_FILL_COLOR);
            ViewUtil.setPropertyValue (view, Properties.ID_FILLCOLOR, FigureUtilities.RGBToInteger (fillRGB));
            RGB lineRGB = PreferenceConverter.getColor (store, IPreferenceConstants.PREF_NOTE_LINE_COLOR);
            ViewUtil.setPropertyValue (view, Properties.ID_LINECOLOR, FigureUtilities.RGBToInteger (lineRGB));
        }
    }

}

