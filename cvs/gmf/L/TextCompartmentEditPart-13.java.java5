package org.eclipse.gmf.runtime.diagram.ui.editparts;

import java.beans.PropertyChangeEvent;

import java.util.Collections;

import java.util.List;

import org.eclipse.draw2d.IFigure;

import org.eclipse.draw2d.Label;

import org.eclipse.draw2d.PositionConstants;

import org.eclipse.draw2d.geometry.Point;

import org.eclipse.emf.common.notify.Notification;

import org.eclipse.emf.ecore.EObject;

import org.eclipse.emf.transaction.RunnableWithResult;

import org.eclipse.gef.AccessibleEditPart;

import org.eclipse.gef.EditPolicy;

import org.eclipse.gef.Request;

import org.eclipse.gef.requests.DirectEditRequest;

import org.eclipse.gef.tools.DirectEditManager;

import org.eclipse.gmf.runtime.common.core.util.Log;

import org.eclipse.gmf.runtime.common.core.util.Trace;

import org.eclipse.gmf.runtime.common.ui.services.parser.CommonParserHint;

import org.eclipse.gmf.runtime.common.ui.services.parser.IParser;

import org.eclipse.gmf.runtime.common.ui.services.parser.IParserEditStatus;

import org.eclipse.gmf.runtime.common.ui.services.parser.ParserEditStatus;

import org.eclipse.gmf.runtime.common.ui.services.parser.ParserOptions;

import org.eclipse.gmf.runtime.common.ui.services.parser.ParserService;

import org.eclipse.gmf.runtime.diagram.core.util.ViewUtil;

import org.eclipse.gmf.runtime.diagram.ui.editpolicies.EditPolicyRoles;

import org.eclipse.gmf.runtime.diagram.ui.editpolicies.LabelDirectEditPolicy;

import org.eclipse.gmf.runtime.diagram.ui.internal.DiagramUIDebugOptions;

import org.eclipse.gmf.runtime.diagram.ui.internal.DiagramUIPlugin;

import org.eclipse.gmf.runtime.diagram.ui.internal.DiagramUIStatusCodes;

import org.eclipse.gmf.runtime.diagram.ui.l10n.DiagramColorRegistry;

import org.eclipse.gmf.runtime.diagram.ui.preferences.IPreferenceConstants;

import org.eclipse.gmf.runtime.diagram.ui.tools.TextDirectEditManager;

import org.eclipse.gmf.runtime.draw2d.ui.figures.WrapLabel;

import org.eclipse.gmf.runtime.emf.core.util.EObjectAdapter;

import org.eclipse.gmf.runtime.emf.ui.services.parser.ISemanticParser;

import org.eclipse.gmf.runtime.emf.ui.services.parser.ParserHintAdapter;

import org.eclipse.gmf.runtime.gef.ui.internal.requests.DirectEditRequestWrapper;

import org.eclipse.gmf.runtime.notation.FontStyle;

import org.eclipse.gmf.runtime.notation.NotationPackage;

import org.eclipse.gmf.runtime.notation.View;

import org.eclipse.jface.preference.IPreferenceStore;

import org.eclipse.jface.preference.PreferenceConverter;

import org.eclipse.jface.text.contentassist.IContentAssistProcessor;

import org.eclipse.jface.viewers.ICellEditorValidator;

import org.eclipse.swt.SWT;

import org.eclipse.swt.accessibility.AccessibleEvent;

import org.eclipse.swt.graphics.Color;

import org.eclipse.swt.graphics.FontData;

import org.eclipse.swt.graphics.Image;

public class TextCompartmentEditPart extends CompartmentEditPart implements ITextAwareEditPart {
    private DirectEditManager manager;
    protected IParser parser;
    private ParserOptions parserOptions;
    private List parserElements = null;
    private int numIcons = 0;
    private Label toolTipLabel = new Label ();

    public TextCompartmentEditPart (EObject model) {
        super (model);
    }

    protected void createDefaultEditPolicies () {
        super.createDefaultEditPolicies ();
        installEditPolicy (EditPolicy.DIRECT_EDIT_ROLE, new LabelDirectEditPolicy ());
        removeEditPolicy (EditPolicyRoles.CREATION_ROLE);
    }

    protected IFigure createFigure () {
        return createWrapLabel ();
    }

    protected WrapLabel createWrapLabel () {
        WrapLabel label = new WrapLabel ("");
        label.setLabelAlignment (PositionConstants.TOP);
        label.setTextAlignment (PositionConstants.TOP);
        return label;
    }

    public IFigure getFigure () {
        return super.getFigure ();
    }

    public WrapLabel getLabel () {
        return (WrapLabel) getFigure ();
    }

    protected Image getLabelIcon (int index) {
        return null;
    }

    protected String getLabelText () {
        EObject element = resolveSemanticElement ();
        return (element == null) ? null : (getParser () == null) ? null : getParser ().getPrintString (new EObjectAdapter (element), getParserOptions ().intValue ());
    }

    public String getEditText () {
        EObject element = resolveSemanticElement ();
        return (element == null) ? "" : getParser ().getEditString (new EObjectAdapter (element), getParserOptions ().intValue ());
    }

    public void setLabelText (String text) {
        getLabel ().setText (text);
    }

    public IContentAssistProcessor getCompletionProcessor () {
        EObject element = resolveSemanticElement ();
        if (element != null) {
            return getParser ().getCompletionProcessor (new EObjectAdapter (element));
        }
        return null;
    }

    private boolean canParse () {
        return getEditText () != null;
    }

    public ICellEditorValidator getEditTextValidator () {
        return new ICellEditorValidator () {

            public String isValid (final Object value) {
                if (value instanceof String) {
                    final EObject element = resolveSemanticElement ();
                    final IParser theParser = getParser ();
                    try {
                        IParserEditStatus isValid = (IParserEditStatus) getEditingDomain ().runExclusive (new RunnableWithResult.Impl () {

                            public void run () {
                                setResult (theParser.isValidEditString (new EObjectAdapter (element), (String) value));
                            }

                        }

                        );
                        return isValid.getCode () == ParserEditStatus.EDITABLE ? null : isValid.getMessage ();
                    } catch (InterruptedException e) {
                        Trace.catching (DiagramUIPlugin.getInstance (), DiagramUIDebugOptions.EXCEPTIONS_CATCHING, getClass (), "getEditTextValidator", e);
                        Log.error (DiagramUIPlugin.getInstance (), DiagramUIStatusCodes.IGNORED_EXCEPTION_WARNING, "getEditTextValidator", e);
                    }
                }
                return null;
            }

        }

        ;
    }

    public final ParserOptions getParserOptions () {
        if (parserOptions == null) parserOptions = buildParserOptions ();

        return parserOptions;
    }

    protected ParserOptions buildParserOptions () {
        return ParserOptions.NONE;
    }

    protected final void refreshParserOptions () {
        parserOptions = buildParserOptions ();
    }

    protected boolean isAffectingParserOptions (PropertyChangeEvent evt) {
        return false;
    }

    protected boolean isAffectingParserOptions (Notification evt) {
        return false;
    }

    protected IFigure getLabelToolTip () {
        String text = getToolTipText ();
        if (text != null && text.length () > 0) {
            toolTipLabel.setText (text);
            return toolTipLabel;
        }
        return null;
    }

    protected String getToolTipText () {
        return null;
    }

    protected boolean isEditable () {
        EObject element = resolveSemanticElement ();
        if (element != null && canParse ()) {
            return true;
        }
        return false;
    }

    protected void performDirectEdit () {
        getManager ().show ();
    }

    protected void performDirectEdit (Point eventLocation) {
        if (getManager ().getClass () == TextDirectEditManager.class) {
            ((TextDirectEditManager) getManager ()).show (eventLocation.getSWTPoint ());
        }
    }

    private void performDirectEdit (char initialCharacter) {
        if (getManager () instanceof TextDirectEditManager) {
            ((TextDirectEditManager) getManager ()).show (initialCharacter);
        } else {
            performDirectEdit ();
        }
    }

    protected void performDirectEditRequest (Request request) {
        final Request theRequest = request;
        try {
            getEditingDomain ().runExclusive (new Runnable () {

                public void run () {
                    if (isActive () && isEditable ()) {
                        if (theRequest instanceof DirectEditRequestWrapper) {
                            char initialCharacter = ((DirectEditRequestWrapper) theRequest).getInitialCharacter ();
                            performDirectEdit (initialCharacter);
                        } else if ((theRequest instanceof DirectEditRequest) && (getEditText ().equals (getLabelText ()))) {
                            DirectEditRequest editRequest = (DirectEditRequest) theRequest;
                            performDirectEdit (editRequest.getLocation ());
                        } else {
                            performDirectEdit ();
                        }

                    }
                }

            }

            );
        } catch (InterruptedException e) {
            Trace.catching (DiagramUIPlugin.getInstance (), DiagramUIDebugOptions.EXCEPTIONS_CATCHING, getClass (), "performDirectEditRequest", e);
            Log.error (DiagramUIPlugin.getInstance (), DiagramUIStatusCodes.IGNORED_EXCEPTION_WARNING, "performDirectEditRequest", e);
        }
    }

    protected void handleNotificationEvent (Notification event) {
        Object feature = event.getFeature ();
        if (NotationPackage.eINSTANCE.getFontStyle_FontColor ().equals (feature)) {
            Integer c = (Integer) event.getNewValue ();
            setFontColor (DiagramColorRegistry.getInstance ().getColor (c));
        } else if (NotationPackage.eINSTANCE.getFontStyle_Underline ().equals (feature)) refreshUnderline ();
        else if (NotationPackage.eINSTANCE.getFontStyle_StrikeThrough ().equals (feature)) refreshStrikeThrough ();
        else if (NotationPackage.eINSTANCE.getFontStyle_FontHeight ().equals (feature) || NotationPackage.eINSTANCE.getFontStyle_FontName ().equals (feature) || NotationPackage.eINSTANCE.getFontStyle_Bold ().equals (feature) || NotationPackage.eINSTANCE.getFontStyle_Italic ().equals (feature)) {
            refreshFont ();
        } else if (isAffectingParserOptions (event)) {
            refreshParserOptions ();
            refreshLabel ();
        } else {
            if (getParser () != null && getParser ().isAffectingEvent (event, getParserOptions ().intValue ())) {
                refreshLabel ();
                return;
            }
            if (getParser () instanceof ISemanticParser) {
                ISemanticParser modelParser = (ISemanticParser) getParser ();
                if (modelParser.areSemanticElementsAffected (null, event)) {
                    removeSemanticListeners ();
                    if (resolveSemanticElement () != null) addSemanticListeners ();

                    refreshLabel ();
                    return;
                }
            }
        }

        super.handleNotificationEvent (event);
    }

    protected void refreshVisuals () {
        super.refreshVisuals ();
        refreshParserOptions ();
        refreshLabel ();
        refreshFont ();
        refreshUnderline ();
        refreshStrikeThrough ();
        refreshFontColor ();
    }

    protected void refreshFont () {
        FontStyle style = (FontStyle) getPrimaryView ().getStyle (NotationPackage.eINSTANCE.getFontStyle ());
        FontData fontData = null;
        if (style != null) {
            fontData = new FontData (style.getFontName (), style.getFontHeight (), (style.isBold () ? SWT.BOLD : SWT.NORMAL) | (style.isItalic () ? SWT.ITALIC : SWT.NORMAL));
        } else {
            fontData = PreferenceConverter.getFontData ((IPreferenceStore) getDiagramPreferencesHint ().getPreferenceStore (), IPreferenceConstants.PREF_DEFAULT_FONT);
        }
        setFont (fontData);
    }

    protected void setFontColor (Color color) {
        getLabel ().setForegroundColor (color);
    }

    protected void addNotationalListeners () {
        super.addNotationalListeners ();
        addListenerFilter ("PrimaryView", this, getPrimaryView ());
    }

    protected void addSemanticListeners () {
        if (getParser () instanceof ISemanticParser) {
            EObject semanticElement = resolveSemanticElement ();
            parserElements = ((ISemanticParser) getParser ()).getSemanticElementsBeingParsed (semanticElement);
            for (int i = 0;
            i < parserElements.size (); i ++) addListenerFilter ("SemanticModel" + i, this, (EObject) parserElements.get (i));

        } else super.addSemanticListeners ();

    }

    protected void removeNotationalListeners () {
        super.removeNotationalListeners ();
        removeListenerFilter ("PrimaryView");
    }

    protected void removeSemanticListeners () {
        if (parserElements != null) {
            for (int i = 0;
            i < parserElements.size (); i ++) removeListenerFilter ("SemanticModel" + i);

        } else super.removeSemanticListeners ();

    }

    public int getNumIcons () {
        return numIcons;
    }

    public void setNumIcons (int numIcons) {
        this.numIcons = numIcons;
    }

    protected List getModelChildren () {
        return Collections.EMPTY_LIST;
    }

    public IParser getParser () {
        if (parser == null) {
            String parserHint = ((View) getModel ()).getType ();
            EObject element = resolveSemanticElement ();
            if (element != null) {
                ParserHintAdapter hintAdapter = new ParserHintAdapter (element, parserHint);
                parser = ParserService.getInstance ().getParser (hintAdapter);
            }
        }
        return parser;
    }

    protected void refreshLabel () {
        getLabel ().setText (getLabelText ());
        for (int i = 0;
        i < numIcons; i ++) getLabel ().setIcon (getLabelIcon (i), i);

        getLabel ().setToolTip (getLabelToolTip ());
    }

    protected void refreshUnderline () {
        FontStyle style = (FontStyle) getPrimaryView ().getStyle (NotationPackage.eINSTANCE.getFontStyle ());
        if (style != null) getLabel ().setTextUnderline (style.isUnderline ());

    }

    protected void refreshStrikeThrough () {
        FontStyle style = (FontStyle) getPrimaryView ().getStyle (NotationPackage.eINSTANCE.getFontStyle ());
        if (style != null) getLabel ().setTextStrikeThrough (style.isStrikeThrough ());

    }

    protected AccessibleEditPart getAccessibleEditPart () {
        if (accessibleEP == null) accessibleEP = new AccessibleGraphicalEditPart () {

            public void getName (AccessibleEvent e) {
                IFigure fig = getFigure ();
                if (fig instanceof WrapLabel) {
                    e.result = ((WrapLabel) fig).getText ();
                }
            }

        }

        ;

        return accessibleEP;
    }

    public IGraphicalEditPart getChildBySemanticHint (String semanticHint) {
        return null;
    }

    protected DirectEditManager getManager () {
        if (manager == null) setManager (new TextDirectEditManager (this));

        return manager;
    }

    protected void setManager (DirectEditManager manager) {
        this.manager = manager;
    }

    public View getPrimaryChildView () {
        if (getModel () != null) {
            View view = (View) getModel ();
            return ViewUtil.getChildBySemanticHint (view, CommonParserHint.DESCRIPTION);
        }
        return null;
    }

}

