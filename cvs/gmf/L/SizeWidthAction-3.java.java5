package org.eclipse.gmf.runtime.diagram.ui.actions.internal;

import java.util.Iterator;

import java.util.List;

import org.eclipse.draw2d.geometry.Dimension;

import org.eclipse.gef.Request;

import org.eclipse.gef.commands.Command;

import org.eclipse.gef.commands.CompoundCommand;

import org.eclipse.ui.IWorkbenchPage;

import org.eclipse.gmf.runtime.diagram.ui.actions.PresentationAction;

import org.eclipse.gmf.runtime.diagram.ui.actions.internal.l10n.Images;

import org.eclipse.gmf.runtime.diagram.ui.actions.internal.l10n.Messages;

import org.eclipse.gmf.runtime.diagram.ui.commands.EtoolsProxyCommand;

import org.eclipse.gmf.runtime.diagram.ui.commands.SetBoundsCommand;

import org.eclipse.gmf.runtime.diagram.ui.editparts.IGraphicalEditPart;

import org.eclipse.gmf.runtime.diagram.ui.internal.requests.ActionIds;

import org.eclipse.gmf.runtime.diagram.ui.properties.Properties;

import org.eclipse.gmf.runtime.diagram.core.util.ViewUtil;

import org.eclipse.gmf.runtime.emf.core.util.EObjectAdapter;

import org.eclipse.gmf.runtime.notation.View;

public class SizeWidthAction extends PresentationAction {
    private static final String ACTION_LABEL = "SameSizeAction.MakeSameSizeWidth.ActionLabelText";
    private static final String ACTION_TOOLTIP = "SameSizeAction.MakeSameSizeWidth.ActionToolTipText";

    public SizeWidthAction (IWorkbenchPage workbenchPage) {
        super (workbenchPage);
    }

    public void init () {
        super.init ();
        setId (ActionIds.ACTION_MAKE_SAME_SIZE_WIDTH);
        setText (Messages.getString (ACTION_LABEL));
        setToolTipText (Messages.getString (ACTION_TOOLTIP));
        setImageDescriptor (Images.DESC_ACTION_MAKE_SAME_SIZE_WIDTH);
        setHoverImageDescriptor (Images.DESC_ACTION_MAKE_SAME_SIZE_WIDTH);
    }

    protected Request createTargetRequest () {
        return null;
    }

    protected boolean isSelectionListener () {
        return true;
    }

    protected Command getCommand () {
        CompoundCommand doResizeCmd = new CompoundCommand ();
        Iterator iter = getSelectedObjects ().iterator ();
        int last = getSelectedObjects ().size () - 1;
        IGraphicalEditPart primary = (IGraphicalEditPart) getSelectedObjects ().get (last);
        View primaryView = (View) primary.getModel ();
        Integer width = (Integer) ViewUtil.getPropertyValue (primaryView, Properties.ID_EXTENTX);
        Integer height = (Integer) ViewUtil.getPropertyValue (primaryView, Properties.ID_EXTENTY);
        Dimension primarySize;
        if (width.intValue () == - 1 || height.intValue () == - 1) primarySize = primary.getFigure ().getSize ().getCopy ();
        else primarySize = new Dimension (width.intValue (), height.intValue ());

        while (iter.hasNext ()) {
            IGraphicalEditPart toResize = (IGraphicalEditPart) iter.next ();
            View resizeView = (View) toResize.getModel ();
            Dimension size = primarySize.getCopy ();
            size.height = ((Integer) ViewUtil.getPropertyValue (resizeView, Properties.ID_EXTENTY)).intValue ();
            doResizeCmd.add (new EtoolsProxyCommand (new SetBoundsCommand ("", new EObjectAdapter (resizeView), size)));
        }
        return doResizeCmd.unwrap ();
    }

    protected boolean calculateEnabled () {
        List selection = getSelectedObjects ();
        if (selection.size () < 2) {
            return false;
        }
        return true;
    }

}

