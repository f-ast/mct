package org.eclipse.gmf.internal.xpand.build;

import java.io.FileNotFoundException;

import java.io.IOException;

import java.io.InputStream;

import java.io.InputStreamReader;

import java.io.Reader;

import java.net.URL;

import java.nio.charset.Charset;

import java.util.ArrayList;

import org.eclipse.core.resources.IFile;

import org.eclipse.core.resources.IProject;

import org.eclipse.core.resources.IResource;

import org.eclipse.core.resources.ResourcesPlugin;

import org.eclipse.core.runtime.CoreException;

import org.eclipse.core.runtime.IPath;

import org.eclipse.core.runtime.Path;

import org.eclipse.core.runtime.Platform;

import org.eclipse.gmf.internal.xpand.expression.SyntaxConstants;

import org.eclipse.gmf.internal.xpand.model.XpandResource;

import org.eclipse.gmf.internal.xpand.util.ParserException;

import org.eclipse.gmf.internal.xpand.util.ResourceManagerImpl;

import org.eclipse.gmf.internal.xpand.util.StreamConverter;

import org.eclipse.gmf.internal.xpand.xtend.ast.XtendResource;

import org.osgi.framework.Bundle;

public class WorkspaceResourceManager extends ResourceManagerImpl {
    private final IProject contextProject;
    private final IPath [] myConfiguredRoots;

    public WorkspaceResourceManager (IProject context, IPath [] configuredRoots) {
        this.contextProject = context;
        myConfiguredRoots = configuredRoots;
    }

    public XtendResource loadXtendResource (IFile file) throws CoreException, IOException, ParserException {
        if (file == null) {
            return null;
        }
        String fullyQualifiedName = toFullyQualifiedName (file);
        if (fullyQualifiedName == null) {
            return null;
        }
        return super.loadXtendResource (fullyQualifiedName);
    }

    public XpandResource loadXpandResource (IFile file) throws CoreException, IOException, ParserException {
        if (file == null) {
            return null;
        }
        String fullyQualifiedName = toFullyQualifiedName (file);
        if (fullyQualifiedName == null) {
            return null;
        }
        fullyQualifiedName = getNonAspectsTemplateName (fullyQualifiedName);
        return super.loadXpandResource (fullyQualifiedName);
    }

    @Override
    protected boolean shouldCache () {
        return false;
    }

    public void forget (IFile resource) {
    }

    protected Reader resolve (String fqn, String ext) throws IOException {
        IPath fp = new Path (fqn.replaceAll (SyntaxConstants.NS_DELIM, "/")).addFileExtension (ext);
        IResource r = null;
        for (IPath p : getResolutions (fp)) {
            r = contextProject.findMember (p);
            if (r != null) {
                break;
            }
        }
        if (false == r instanceof IFile) {
            throw new FileNotFoundException (fp.toString ());
        }
        try {
            return new StreamConverter ().toContentsReader ((IFile) r);
        } catch (CoreException ex) {
            IOException wrap = new IOException (ex.getStatus ().getMessage ());
            wrap.initCause (ex);
            throw wrap;
        }
    }

    @Override
    protected Reader [] resolveMultiple (String fqn, String ext) throws IOException {
        IPath fp = new Path (fqn.replaceAll (SyntaxConstants.NS_DELIM, "/")).addFileExtension (ext);
        IPath [] resolutions = getResolutions (fp);
        ArrayList < Reader > result = new ArrayList < Reader > (resolutions.length);
        for (IPath p : getResolutions (fp)) {
            Reader nextReader = getReader (p);
            if (nextReader != null) {
                result.add (nextReader);
            }
        }
        if (result.isEmpty ()) {
            throw new FileNotFoundException (fp.toString ());
        }
        return result.toArray (new Reader [result.size ()]);
    }

    private Reader getReader (IPath p) throws IOException {
        if (p.isAbsolute ()) {
            assert p.segmentCount () > 1;
            IProject project = ResourcesPlugin.getWorkspace ().getRoot ().getProject (p.segment (0));
            if (project.isAccessible ()) {
                return getWorkspaceFileReader (project, p.removeFirstSegments (1));
            }
            Bundle platformBundle = Platform.getBundle (p.segment (0));
            if (platformBundle != null) {
                URL url = platformBundle.getEntry (p.removeFirstSegments (1).toString ());
                if (url != null) {
                    InputStream is = url.openStream ();
                    return new InputStreamReader (is, Charset.forName ("ISO-8859-1"));
                }
            }
        } else {
            return getWorkspaceFileReader (contextProject, p);
        }
        return null;
    }

    private Reader getWorkspaceFileReader (IProject project, IPath path) throws IOException {
        IResource r = project.findMember (path);
        if (r instanceof IFile) {
            try {
                return new StreamConverter ().toContentsReader ((IFile) r);
            } catch (CoreException ex) {
                IOException wrap = new IOException (ex.getStatus ().getMessage ());
                wrap.initCause (ex);
                throw wrap;
            }
        }
        return null;
    }

    private IPath [] getResolutions (IPath p) {
        IPath [] configured = getConfiguredRoots ();
        IPath [] rv = new IPath [configured.length];
        for (int i = 0;
        i < configured.length; i ++) {
            rv [i] = configured [i].append (p);
        }
        return rv;
    }

    private IPath [] getConfiguredRoots () {
        return myConfiguredRoots;
    }

    private String toFullyQualifiedName (IFile file) {
        for (IPath nextRoot : getConfiguredRoots ()) {
            if (! nextRoot.isAbsolute ()) {
                if (file.getProject ().equals (contextProject) && nextRoot.isPrefixOf (file.getProjectRelativePath ())) {
                    return toFullyQualifiedName (file.getProjectRelativePath ().removeFirstSegments (nextRoot.segmentCount ()));
                }
            } else {
                if (nextRoot.isPrefixOf (file.getFullPath ())) {
                    return toFullyQualifiedName (file.getFullPath ().removeFirstSegments (nextRoot.segmentCount ()));
                }
            }
        }
        return null;
    }

    private String toFullyQualifiedName (IPath filePath) {
        return filePath.removeFileExtension ().toString ().replace ("/", SyntaxConstants.NS_DELIM);
    }

}

