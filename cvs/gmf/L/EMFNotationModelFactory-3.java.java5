package org.eclipse.gmf.runtime.diagram.ui.resources.editor.internal.notationprovider;

import org.eclipse.core.resources.IFile;

import org.eclipse.core.resources.IResource;

import org.eclipse.core.runtime.IProgressMonitor;

import org.eclipse.emf.ecore.EObject;

import org.eclipse.emf.ecore.resource.Resource;

import org.eclipse.gmf.runtime.common.core.util.Trace;

import org.eclipse.gmf.runtime.diagram.core.internal.util.MEditingDomainGetter;

import org.eclipse.gmf.runtime.diagram.ui.resources.editor.internal.EditorDebugOptions;

import org.eclipse.gmf.runtime.diagram.ui.resources.editor.internal.EditorPlugin;

import org.eclipse.gmf.runtime.emf.core.edit.MEditingDomain;

import org.eclipse.gmf.runtime.emf.core.util.ResourceUtil;

import org.eclipse.gmf.runtime.notation.Diagram;

public class EMFNotationModelFactory {

    static public Diagram load (final IFile file) throws EmfNotationException {
        return load (file, MEditingDomain.INSTANCE);
    }

    static public Diagram load (final IFile file, MEditingDomain editingDomain) throws EmfNotationException {
        Resource notationModel = null;
        try {
            file.refreshLocal (IResource.DEPTH_ZERO, null);
            String fileName = file.getLocation ().toOSString ();
            notationModel = editingDomain.loadResource (fileName);
        } catch (Exception e) {
            Trace.catching (EditorPlugin.getInstance (), EditorDebugOptions.EXCEPTIONS_CATCHING, EMFNotationModelFactory.class, "load", e);
            EmfNotationException t = new EmfNotationException (e);
            Trace.throwing (EditorPlugin.getInstance (), EditorDebugOptions.EXCEPTIONS_CATCHING, EMFNotationModelFactory.class, "load", e);
            throw t;
        }
        EObject element = ResourceUtil.getFirstRoot (notationModel);
        return (element instanceof Diagram) ? (Diagram) element : null;
    }

    static public void save (IFile file, Diagram diagram, boolean clone, IProgressMonitor progressMonitor) throws Exception {
        Resource notationModel = ((EObject) diagram).eResource ();
        String fileName = file.getLocation ().toOSString ();
        if (clone) {
            MEditingDomainGetter.getMEditingDomain (notationModel).saveResourceAs (notationModel, fileName);
        } else {
            MEditingDomainGetter.getMEditingDomain (notationModel).saveResource (notationModel);
        }
        if (progressMonitor != null) progressMonitor.done ();

    }

}

