package org.eclipse.gmf.runtime.diagram.ui.editpolicies;

import java.util.ArrayList;

import java.util.Iterator;

import java.util.List;

import org.eclipse.emf.ecore.EObject;

import org.eclipse.gef.EditPart;

import org.eclipse.gef.Request;

import org.eclipse.gef.commands.Command;

import org.eclipse.gef.commands.CompoundCommand;

import org.eclipse.gef.requests.ChangeBoundsRequest;

import org.eclipse.gmf.runtime.diagram.ui.editparts.IGraphicalEditPart;

import org.eclipse.gmf.runtime.diagram.ui.editparts.ListCompartmentEditPart;

import org.eclipse.gmf.runtime.diagram.ui.requests.ArrangeRequest;

import org.eclipse.gmf.runtime.diagram.ui.requests.CreateViewRequest;

import org.eclipse.gmf.runtime.diagram.ui.requests.DropObjectsRequest;

import org.eclipse.gmf.runtime.diagram.ui.requests.RefreshConnectionsRequest;

import org.eclipse.gmf.runtime.diagram.ui.requests.RequestConstants;

import org.eclipse.gmf.runtime.emf.core.util.EObjectAdapter;

public class DiagramDragDropEditPolicy extends DragDropEditPolicy {

    protected Command getDropFileCommand (DropObjectsRequest dropRequest) {
        Iterator iter = dropRequest.getObjects ().iterator ();
        while (iter.hasNext ()) {
            Object obj = iter.next ();
            if (obj instanceof String) {
            }
        }
        return null;
    }

    public Command getDropObjectsCommand (DropObjectsRequest dropRequest) {
        List viewDescriptors = new ArrayList ();
        Iterator iter = dropRequest.getObjects ().iterator ();
        if (dropRequest.getObjects ().size () > 0 && dropRequest.getObjects ().get (0) instanceof String) {
            return getDropFileCommand (dropRequest);
        }
        while (iter.hasNext ()) viewDescriptors.add (new CreateViewRequest.ViewDescriptor (new EObjectAdapter ((EObject) iter.next ()), ((IGraphicalEditPart) getHost ()).getDiagramPreferencesHint ()));

        return createViewsAndArrangeCommand (dropRequest, viewDescriptors);
    }

    protected Command createViewsAndArrangeCommand (DropObjectsRequest dropRequest, List viewDescriptors) {
        CreateViewRequest createViewRequest = new CreateViewRequest (viewDescriptors);
        createViewRequest.setLocation (dropRequest.getLocation ());
        Command createCommand = getHost ().getCommand (createViewRequest);
        if (createCommand != null) {
            List result = (List) createViewRequest.getNewObject ();
            dropRequest.setResult (result);
            RefreshConnectionsRequest refreshRequest = new RefreshConnectionsRequest (result);
            Command refreshCommand = getHost ().getCommand (refreshRequest);
            ArrangeRequest arrangeRequest = new ArrangeRequest (RequestConstants.REQ_ARRANGE_DEFERRED);
            arrangeRequest.setViewAdaptersToArrange (result);
            Command arrangeCommand = getHost ().getCommand (arrangeRequest);
            CompoundCommand cc = new CompoundCommand (createCommand.getLabel ());
            cc.add (createCommand.chain (refreshCommand));
            cc.add (arrangeCommand);
            return cc;
        }
        return null;
    }

    public void showTargetFeedback (Request request) {
    }

    protected Command getDropCommand (ChangeBoundsRequest request) {
        EditPart parentEP = ((IGraphicalEditPart) request.getEditParts ().get (0)).getParent ();
        if (parentEP instanceof ListCompartmentEditPart) {
            Object originalType = request.getType ();
            request.setType (RequestConstants.REQ_SHOW_AS_ALTERNATE_VIEW);
            Command cmd = parentEP.getCommand (request);
            request.setType (originalType);
            if (cmd != null) {
                return cmd;
            }
        }
        return super.getDropCommand (request);
    }

}

