package org.eclipse.gmf.runtime.diagram.ui.parts;

import java.util.List;

import org.eclipse.draw2d.DeferredUpdateManager;

import org.eclipse.draw2d.LightweightSystem;

import org.eclipse.gef.EditPart;

import org.eclipse.gef.ui.parts.ScrollingGraphicalViewer;

import org.eclipse.gmf.runtime.diagram.ui.internal.parts.ElementToEditPartsMap;

import org.eclipse.jface.preference.IPreferenceStore;

import org.eclipse.jface.util.TransferDragSourceListener;

import org.eclipse.jface.util.TransferDropTargetListener;

import org.eclipse.jface.viewers.ISelection;

import org.eclipse.jface.viewers.ISelectionChangedListener;

import org.eclipse.jface.viewers.SelectionChangedEvent;

import org.eclipse.jface.viewers.StructuredSelection;

import org.eclipse.swt.widgets.Display;

import org.eclipse.ui.PlatformUI;

public class DiagramGraphicalViewer extends ScrollingGraphicalViewer implements IDiagramGraphicalViewer {

    public DiagramGraphicalViewer () {
        super ();
    }

    public void enableUpdates (boolean enable) {
        if (enable) getLightweightSystemWithUpdateToggle ().enableUpdates ();
        else getLightweightSystemWithUpdateToggle ().disableUpdates ();

    }

    private class ToggleUpdateManager extends DeferredUpdateManager {
        private boolean disableUpdates = false;

        public boolean shouldDisableUpdates () {
            return disableUpdates;
        }

        protected void sendUpdateRequest () {
            PlatformUI.getWorkbench ().getDisplay ().asyncExec (new UpdateRequest ());
        }

        public void setDisableUpdates (boolean disableUpdates) {
            this.disableUpdates = disableUpdates;
            if (! disableUpdates) {
                queueWork ();
            }
        }

        public synchronized void performUpdate () {
            if (! shouldDisableUpdates ()) super.performUpdate ();

        }

        public void performValidation () {
            if (! shouldDisableUpdates ()) super.performValidation ();

        }

        public void queueWork () {
            if (! shouldDisableUpdates ()) super.queueWork ();

        }

    }

    private class LightweightSystemWithUpdateToggle extends LightweightSystem {

        public ToggleUpdateManager getToggleUpdateManager () {
            return (ToggleUpdateManager) getUpdateManager ();
        }

        public void disableUpdates () {
            getToggleUpdateManager ().setDisableUpdates (true);
        }

        public void enableUpdates () {
            getToggleUpdateManager ().setDisableUpdates (false);
        }

    }

    private LightweightSystemWithUpdateToggle getLightweightSystemWithUpdateToggle () {
        return (LightweightSystemWithUpdateToggle) getLightweightSystem ();
    }

    protected LightweightSystem createLightweightSystem () {
        LightweightSystem lws = new LightweightSystemWithUpdateToggle ();
        lws.setUpdateManager (new ToggleUpdateManager ());
        return lws;
    }

    private boolean selectionEventPending = false;
    private ElementToEditPartsMap elementToEditPartsMap = new ElementToEditPartsMap ();

    protected void hookControl () {
        super.hookControl ();
    }

    public void removeDragSourceListener (TransferDragSourceListener listener) {
        getDelegatingDragAdapter ().removeDragSourceListener (listener);
        refreshDragSourceAdapter ();
    }

    public void removeDropTargetListener (TransferDropTargetListener listener) {
        getDelegatingDropAdapter ().removeDropTargetListener (listener);
        refreshDropTargetAdapter ();
    }

    public void flush () {
        super.flush ();
        if (selectionEventPending) {
            flushSelectionEvents (getSelection ());
        }
    }

    protected void fireSelectionChanged () {
        if (selectionEventPending) return;

        selectionEventPending = true;
        Display display = PlatformUI.getWorkbench ().getDisplay ();
        if (display != null) {
            display.asyncExec (new Runnable () {

                public void run () {
                    flushSelectionEvents (getSelection ());
                }

            }

            );
        }
    }

    protected void flushSelectionEvents (ISelection sel) {
        selectionEventPending = false;
        SelectionChangedEvent event = new SelectionChangedEvent (this, sel);
        Object [] array = selectionListeners.toArray ();
        for (int i = 0;
        i < array.length; i ++) {
            ISelectionChangedListener l = (ISelectionChangedListener) array [i];
            if (selectionListeners.contains (l)) l.selectionChanged (event);

        }
    }

    private void fireEmptySelection () {
        if (selectionEventPending) return;

        selectionEventPending = true;
        Display display = PlatformUI.getWorkbench ().getDisplay ();
        if (display != null) {
            display.asyncExec (new Runnable () {

                public void run () {
                    flushSelectionEvents (getSelection ());
                    flushSelectionEvents (StructuredSelection.EMPTY);
                }

            }

            );
        }
    }

    public IDiagramEditDomain getDiagramEditDomain () {
        return (IDiagramEditDomain) getEditDomain ();
    }

    public List findEditPartsForElement (String elementIdStr, Class editPartClass) {
        return elementToEditPartsMap.findEditPartsForElement (elementIdStr, editPartClass);
    }

    public void registerEditPartForElement (String elementIdStr, EditPart ep) {
        elementToEditPartsMap.registerEditPartForElement (elementIdStr, ep);
    }

    public void unregisterEditPartForElement (String elementIdStr, EditPart ep) {
        elementToEditPartsMap.unregisterEditPartForElement (elementIdStr, ep);
    }

    private IPreferenceStore workspacePreferenceStore;

    public void hookWorkspacePreferenceStore (IPreferenceStore store) {
        this.workspacePreferenceStore = store;
    }

    public IPreferenceStore getWorkspaceViewerPreferenceStore () {
        return workspacePreferenceStore;
    }

    protected void unhookControl () {
        fireEmptySelection ();
        super.unhookControl ();
    }

}

