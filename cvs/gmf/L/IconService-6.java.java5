package org.eclipse.gmf.runtime.common.ui.services.icon;

import org.eclipse.core.runtime.IAdaptable;

import org.eclipse.core.runtime.IConfigurationElement;

import org.eclipse.gmf.runtime.common.core.service.ExecutionStrategy;

import org.eclipse.gmf.runtime.common.core.service.IOperation;

import org.eclipse.gmf.runtime.common.core.service.IProvider;

import org.eclipse.gmf.runtime.common.core.service.Service;

import org.eclipse.gmf.runtime.common.ui.services.internal.CommonUIServicesPlugin;

import org.eclipse.gmf.runtime.common.ui.services.internal.icon.IconServiceProviderConfiguration;

import org.eclipse.swt.graphics.Image;

public class IconService extends Service implements IIconProvider {
    private final static IconService _instance = new IconService ();
    protected static class ProviderDescriptor extends Service.ProviderDescriptor {
        private IconServiceProviderConfiguration providerConfiguration;

        public ProviderDescriptor (IConfigurationElement element) {
            super (element);
            this.providerConfiguration = IconServiceProviderConfiguration.parse (element);
        }

        public boolean provides (IOperation operation) {
            if (! policyInitialized) {
                policy = getPolicy ();
                policyInitialized = true;
            }
            if (policy != null) return policy.provides (operation);

            if (provider == null) {
                if (isSupportedInExtention (operation)) {
                    providerConfiguration = null;
                    IProvider theProvider = getProvider ();
                    return theProvider != null ? theProvider.provides (operation) : false;
                }
                return false;
            }
            IProvider theProvider = getProvider ();
            return theProvider != null ? theProvider.provides (operation) : false;
        }

        private boolean isSupportedInExtention (IOperation operation) {
            if (operation instanceof GetIconOperation && providerConfiguration != null) {
                GetIconOperation o = (GetIconOperation) operation;
                return providerConfiguration.supports (o.getHint ());
            }
            return false;
        }

    }

    private IconService () {
        super ();
        configureProviders (CommonUIServicesPlugin.getPluginId (), "iconProviders");
    }

    public static IconService getInstance () {
        return _instance;
    }

    public Image getIcon (IAdaptable hint, int flags) {
        return (Image) executeUnique (ExecutionStrategy.FIRST, new GetIconOperation (hint, flags));
    }

    public Image getIcon (IAdaptable hint) {
        return getIcon (hint, IconOptions.NONE.intValue ());
    }

    protected Service.ProviderDescriptor newProviderDescriptor (IConfigurationElement element) {
        return new ProviderDescriptor (element);
    }

}

