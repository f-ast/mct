package org.eclipse.gmf.runtime.diagram.ui.actions.internal;

import java.util.Iterator;

import java.util.List;

import org.eclipse.draw2d.geometry.Dimension;

import org.eclipse.gef.Request;

import org.eclipse.gef.commands.Command;

import org.eclipse.gef.commands.CompoundCommand;

import org.eclipse.gmf.runtime.diagram.core.util.ViewUtil;

import org.eclipse.gmf.runtime.diagram.ui.actions.ActionIds;

import org.eclipse.gmf.runtime.diagram.ui.actions.DiagramAction;

import org.eclipse.gmf.runtime.diagram.ui.actions.internal.l10n.DiagramUIActionsMessages;

import org.eclipse.gmf.runtime.diagram.ui.actions.internal.l10n.DiagramUIActionsPluginImages;

import org.eclipse.gmf.runtime.diagram.ui.commands.ICommandProxy;

import org.eclipse.gmf.runtime.diagram.ui.commands.SetBoundsCommand;

import org.eclipse.gmf.runtime.diagram.ui.editparts.IGraphicalEditPart;

import org.eclipse.gmf.runtime.emf.core.util.EObjectAdapter;

import org.eclipse.gmf.runtime.notation.NotationPackage;

import org.eclipse.gmf.runtime.notation.View;

import org.eclipse.ui.IWorkbenchPage;

public class SizeWidthAction extends DiagramAction {

    public SizeWidthAction (IWorkbenchPage workbenchPage) {
        super (workbenchPage);
    }

    public void init () {
        super.init ();
        setId (ActionIds.ACTION_MAKE_SAME_SIZE_WIDTH);
        setText (DiagramUIActionsMessages.SameSizeAction_MakeSameSizeWidth_ActionLabelText);
        setToolTipText (DiagramUIActionsMessages.SameSizeAction_MakeSameSizeWidth_ActionToolTipText);
        setImageDescriptor (DiagramUIActionsPluginImages.DESC_MAKE_SAME_SIZE_WIDTH);
        setHoverImageDescriptor (DiagramUIActionsPluginImages.DESC_MAKE_SAME_SIZE_WIDTH);
    }

    protected Request createTargetRequest () {
        return null;
    }

    protected boolean isSelectionListener () {
        return true;
    }

    protected Command getCommand () {
        CompoundCommand doResizeCmd = new CompoundCommand ();
        Iterator iter = getSelectedObjects ().iterator ();
        int last = getSelectedObjects ().size () - 1;
        IGraphicalEditPart primary = (IGraphicalEditPart) getSelectedObjects ().get (last);
        View primaryView = (View) primary.getModel ();
        Integer width = (Integer) ViewUtil.getStructuralFeatureValue (primaryView, NotationPackage.eINSTANCE.getSize_Width ());
        Integer height = (Integer) ViewUtil.getStructuralFeatureValue (primaryView, NotationPackage.eINSTANCE.getSize_Height ());
        Dimension primarySize;
        if (width.intValue () == - 1 || height.intValue () == - 1) primarySize = primary.getFigure ().getSize ().getCopy ();
        else primarySize = new Dimension (width.intValue (), height.intValue ());

        while (iter.hasNext ()) {
            IGraphicalEditPart toResize = (IGraphicalEditPart) iter.next ();
            View resizeView = (View) toResize.getModel ();
            Dimension size = primarySize.getCopy ();
            size.height = ((Integer) ViewUtil.getStructuralFeatureValue (resizeView, NotationPackage.eINSTANCE.getSize_Height ())).intValue ();
            doResizeCmd.add (new ICommandProxy (new SetBoundsCommand (toResize.getEditingDomain (), "", new EObjectAdapter (resizeView), size)));
        }
        return doResizeCmd.unwrap ();
    }

    protected boolean calculateEnabled () {
        List selection = getSelectedObjects ();
        if (selection.size () < 2) {
            return false;
        }
        return true;
    }

}

