package org.eclipse.gmf.runtime.emf.ui.properties.providers;

import org.eclipse.emf.common.notify.AdapterFactory;

import org.eclipse.emf.edit.domain.AdapterFactoryEditingDomain;

import org.eclipse.emf.edit.provider.IItemPropertySource;

import org.eclipse.emf.transaction.TransactionalEditingDomain;

import org.eclipse.emf.transaction.util.TransactionUtil;

import org.eclipse.gmf.runtime.common.core.service.AbstractProvider;

import org.eclipse.gmf.runtime.common.core.service.IOperation;

import org.eclipse.gmf.runtime.common.ui.services.properties.GetPropertySourceOperation;

import org.eclipse.gmf.runtime.common.ui.services.properties.ICompositePropertySource;

import org.eclipse.gmf.runtime.common.ui.services.properties.IPropertiesProvider;

import org.eclipse.gmf.runtime.emf.ui.properties.descriptors.EMFCompositePropertySource;

import org.eclipse.ui.views.properties.IPropertySourceProvider;

public class GenericEMFPropertiesProvider extends AbstractProvider implements IPropertiesProvider {

    public GenericEMFPropertiesProvider () {
        super ();
    }

    protected static AdapterFactory getAdapterFactory (Object object) {
        TransactionalEditingDomain editingDomain = TransactionUtil.getEditingDomain (object);
        if (editingDomain instanceof AdapterFactoryEditingDomain) {
            return ((AdapterFactoryEditingDomain) editingDomain).getAdapterFactory ();
        }
        return null;
    }

    public ICompositePropertySource getPropertySource (Object object) {
        if (object instanceof ICompositePropertySource) {
            return (ICompositePropertySource) object;
        } else {
            AdapterFactory adapterFactory = getAdapterFactory (object);
            if (adapterFactory == null) {
                return null;
            }
            IItemPropertySource itemPropertySource = (IItemPropertySource) (adapterFactory.adapt (object, IItemPropertySource.class));
            return itemPropertySource != null ? createPropertySource (object, itemPropertySource) : null;
        }
    }

    public boolean provides (IOperation operation) {
        return operation instanceof GetPropertySourceOperation && (((GetPropertySourceOperation) operation).getPropertySource () == null);
    }

    protected ICompositePropertySource createPropertySource (Object object, IItemPropertySource itemPropertySource) {
        return new EMFCompositePropertySource (object, itemPropertySource, "EMF");
    }

}

