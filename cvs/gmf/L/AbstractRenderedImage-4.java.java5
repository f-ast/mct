package org.eclipse.gmf.runtime.draw2d.ui.render.internal;

import java.awt.image.BufferedImage;

import java.security.InvalidParameterException;

import org.eclipse.gmf.runtime.draw2d.ui.render.RenderInfo;

import org.eclipse.gmf.runtime.draw2d.ui.render.RenderedImage;

import org.eclipse.gmf.runtime.draw2d.ui.render.factory.RenderedImageFactory;

import org.eclipse.gmf.runtime.draw2d.ui.render.image.ImageConverter;

import org.eclipse.gmf.runtime.draw2d.ui.render.internal.factory.RenderedImageKey;

import org.eclipse.swt.graphics.Image;

abstract public class AbstractRenderedImage implements RenderedImage {

    public AbstractRenderedImage (final byte [] buff, RenderedImageKey key) {
        if (buff == null || key == null) throw new InvalidParameterException ();

        this.buffer = buff;
        this.key = key;
    }

    private byte [] buffer = null;
    private RenderedImageKey key = null;
    protected Image img = null;

    public byte [] getBuffer () {
        return buffer;
    }

    public RenderedImageKey getKey () {
        return key;
    }

    protected void finalize () throws Throwable {
        if (img != null) {
            img.dispose ();
            img = null;
        }
        key = null;
        super.finalize ();
    }

    public RenderInfo getRenderInfo () {
        return RenderedImageFactory.createInfo (key.getWidth (), key.getHeight (), key.getFillColor (), key.getOutlineColor (), key.shouldMaintainAspectRatio (), key.shouldAntiAlias ());
    }

    public RenderedImage getNewRenderedImage (RenderInfo info) {
        if (! getRenderInfo ().equals (info)) {
            RenderedImage rndImg = RenderedImageFactory.getRelatedInstance (this, info);
            if (rndImg != null) {
                return rndImg;
            } else {
                return RenderedImageFactory.getInstance (getBuffer (), info);
            }
        }
        return this;
    }

    public BufferedImage getBufferedImage () {
        return ImageConverter.convert (getSWTImage ());
    }

}

