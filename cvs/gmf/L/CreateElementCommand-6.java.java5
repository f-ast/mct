package org.eclipse.gmf.runtime.emf.type.core.commands;

import org.eclipse.core.commands.ExecutionException;

import org.eclipse.core.runtime.IAdaptable;

import org.eclipse.core.runtime.IProgressMonitor;

import org.eclipse.emf.ecore.EClass;

import org.eclipse.emf.ecore.EClassifier;

import org.eclipse.emf.ecore.EObject;

import org.eclipse.emf.ecore.EReference;

import org.eclipse.gmf.runtime.common.core.command.CommandResult;

import org.eclipse.gmf.runtime.common.core.command.ICommand;

import org.eclipse.gmf.runtime.emf.core.util.EMFCoreUtil;

import org.eclipse.gmf.runtime.emf.core.util.PackageUtil;

import org.eclipse.gmf.runtime.emf.type.core.ElementTypeRegistry;

import org.eclipse.gmf.runtime.emf.type.core.IElementType;

import org.eclipse.gmf.runtime.emf.type.core.requests.ConfigureRequest;

import org.eclipse.gmf.runtime.emf.type.core.requests.CreateElementRequest;

public class CreateElementCommand extends EditElementCommand {
    private EObject newElement;
    private final IElementType elementType;
    private EReference containmentFeature;

    public CreateElementCommand (CreateElementRequest request) {
        super (request.getLabel (), null, request);
        elementType = request.getElementType ();
        containmentFeature = request.getContainmentFeature ();
    }

    protected CommandResult doExecuteWithResult (IProgressMonitor monitor, IAdaptable info) throws ExecutionException {
        newElement = doDefaultElementCreation ();
        ConfigureRequest configureRequest = createConfigureRequest ();
        ICommand configureCommand = elementType.getEditCommand (configureRequest);
        if (configureCommand != null && configureCommand.canExecute ()) {
            configureCommand.execute (monitor, info);
        }
        getCreateRequest ().setNewElement (newElement);
        return CommandResult.newOKCommandResult (newElement);
    }

    protected ConfigureRequest createConfigureRequest () {
        ConfigureRequest configureRequest = new ConfigureRequest (getEditingDomain (), newElement, getElementType ());
        configureRequest.setClientContext (getCreateRequest ().getClientContext ());
        configureRequest.addParameters (getRequest ().getParameters ());
        return configureRequest;
    }

    protected EObject doDefaultElementCreation () {
        EReference containment = getContainmentFeature ();
        EClass eClass = getElementType ().getEClass ();
        if (containment != null) {
            EObject element = getElementToEdit ();
            if (element != null) return EMFCoreUtil.create (element, containment, eClass);

        }
        return null;
    }

    protected EObject getElementToEdit () {
        if (super.getElementToEdit () == null) {
            CreateElementRequest request = (CreateElementRequest) getRequest ();
            setElementToEdit (request.createContainer ());
        }
        return super.getElementToEdit ();
    }

    protected EClass getEClassToEdit () {
        CreateElementRequest request = (CreateElementRequest) getRequest ();
        Object context = request.getEditHelperContext ();
        if (context instanceof EObject) {
            return ((EObject) context).eClass ();
        } else {
            IElementType type = ElementTypeRegistry.getInstance ().getElementType (context);
            if (type != null) {
                return type.getEClass ();
            }
        }
        return null;
    }

    protected EReference getContainmentFeature () {
        if (containmentFeature == null) {
            EClass classToEdit = getEClassToEdit ();
            if (classToEdit != null) {
                IElementType type = getElementType ();
                if (type != null) {
                    containmentFeature = PackageUtil.findFeature (classToEdit, type.getEClass ());
                }
            }
        }
        return containmentFeature;
    }

    protected void setContainmentFeature (EReference containmentFeature) {
        this.containmentFeature = containmentFeature;
    }

    protected IElementType getElementType () {
        return elementType;
    }

    public CreateElementRequest getCreateRequest () {
        return (CreateElementRequest) getRequest ();
    }

    public boolean canExecute () {
        if (getEClassToEdit () == null) {
            return false;
        }
        if (getContainmentFeature () != null) {
            EClassifier eClassifier = getContainmentFeature ().getEType ();
            boolean result = true;
            if (eClassifier instanceof EClass) {
                result = ((EClass) eClassifier).isSuperTypeOf (getElementType ().getEClass ());
            }
            result = result && PackageUtil.canContain (getEClassToEdit (), getContainmentFeature (), getElementType ().getEClass (), false);
            return result && super.canExecute ();
        }
        return false;
    }

    public EObject getNewElement () {
        return newElement;
    }

}

