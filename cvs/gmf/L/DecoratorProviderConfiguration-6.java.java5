package org.eclipse.gmf.runtime.diagram.ui.internal.services.decorator;

import java.util.ArrayList;

import java.util.HashMap;

import java.util.Iterator;

import java.util.List;

import java.util.Map;

import org.eclipse.core.runtime.Assert;

import org.eclipse.core.runtime.IConfigurationElement;

import org.eclipse.gmf.runtime.common.core.service.AbstractProviderConfiguration;

import org.eclipse.gmf.runtime.diagram.ui.services.decorator.IDecoratorTarget;

public class DecoratorProviderConfiguration extends AbstractProviderConfiguration {
    private static final String CONTEXT = "context";
    private static final String DECORATOR_TARGETS = "decoratorTargets";
    private List contextDescriptors = new ArrayList ();

    public static DecoratorProviderConfiguration parse (IConfigurationElement configElement) {
        Assert.isNotNull (configElement, "null provider configuration element");
        return new DecoratorProviderConfiguration (configElement);
    }

    private DecoratorProviderConfiguration (IConfigurationElement configElement) {
        IConfigurationElement configChildren [];
        Map objects = new HashMap ();
        configChildren = configElement.getChildren (OBJECT);
        for (int i = 0;
        i < configChildren.length; i ++) {
            String id = configChildren [i].getAttribute (ID);
            if (id != null) objects.put (id, new ObjectDescriptor (configChildren [i]));

        }
        configChildren = configElement.getChildren (CONTEXT);
        for (int i = 0;
        i < configChildren.length; i ++) {
            List decoratorTargets = getObjectList (configChildren [i].getAttribute (DECORATOR_TARGETS), objects, configElement);
            if (decoratorTargets != null) contextDescriptors.add (new ContextDescriptor (decoratorTargets));

        }
    }

    public boolean supports (IDecoratorTarget decoratorTarget) {
        if (contextDescriptors.isEmpty ()) return true;

        Iterator iter = contextDescriptors.iterator ();
        while (iter.hasNext ()) {
            ContextDescriptor descriptor = (ContextDescriptor) iter.next ();
            if (descriptor.matches (decoratorTarget)) return true;

        }
        return false;
    }

    private static class ContextDescriptor {
        private final List decoratorTargets;

        public ContextDescriptor (List decoratorTargets) {
            this.decoratorTargets = decoratorTargets;
        }

        public boolean matches (IDecoratorTarget decoratorTarget) {
            if (decoratorTargets != null) {
                if (! objectMatches (decoratorTarget, decoratorTargets)) return false;

            }
            return true;
        }

    }

}

