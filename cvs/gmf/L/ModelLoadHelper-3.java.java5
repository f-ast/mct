package org.eclipse.gmf.internal.common.migrate;

import java.io.IOException;

import java.text.MessageFormat;

import org.eclipse.core.runtime.IStatus;

import org.eclipse.core.runtime.Status;

import org.eclipse.emf.common.util.BasicDiagnostic;

import org.eclipse.emf.common.util.Diagnostic;

import org.eclipse.emf.common.util.URI;

import org.eclipse.emf.ecore.EObject;

import org.eclipse.emf.ecore.plugin.EcorePlugin;

import org.eclipse.emf.ecore.resource.Resource;

import org.eclipse.emf.ecore.resource.ResourceSet;

import org.eclipse.emf.ecore.util.EcoreUtil;

public class ModelLoadHelper {
    private static final String DIAGNOSTIC_SOURCE = "gmf.common.modelLoadHelper";
    private IStatus status;
    private URI uri;
    private ResourceSet resourceSet;

    public ModelLoadHelper (ResourceSet targetResSet, URI resourceURI) {
        if (targetResSet == null || resourceURI == null) {
            throw new IllegalArgumentException ("null resourceSet or resourceURI");
        }
        this.resourceSet = targetResSet;
        this.uri = resourceURI;
        this.status = internalLoad (targetResSet, uri);
    }

    public Resource getLoadedResource () {
        return resourceSet.getResource (uri, false);
    }

    public EObject getContentsRoot () {
        Resource resource = getLoadedResource ();
        assert resource != null;
        if (! resource.getContents ().isEmpty ()) {
            return (EObject) resource.getContents ().get (0);
        }
        return null;
    }

    public IStatus getStatus () {
        return status;
    }

    @SuppressWarnings("unchecked")
    private static IStatus internalLoad (ResourceSet resourceSet, URI uri) {
        IStatus loadStatus = Status.OK_STATUS;
        Resource resource = resourceSet.createResource (uri);
        assert resource != null;
        Exception rootException = null;
        try {
            resource.load (resourceSet.getLoadOptions ());
        } catch (IOException e) {
            rootException = e;
        } catch (RuntimeException e) {
            EcorePlugin.INSTANCE.getPluginLogger ().log (e);
            resource.getErrors ().add (MigrationUtil.createDiagnostic (resource, e));
        }
        if (! resource.getErrors ().isEmpty () || ! resource.getWarnings ().isEmpty ()) {
            Diagnostic resourceDiagnostic = EcoreUtil.computeDiagnostic (resource, true);
            Integer severityOpt = new Integer (resourceDiagnostic.getSeverity () == Diagnostic.ERROR ? 0 : 1);
            String message = MessageFormat.format (Messages.modelLoadedWithProblems, new Object [] {severityOpt, resource.getURI ()});
            BasicDiagnostic loadDiagnostic = new BasicDiagnostic (DIAGNOSTIC_SOURCE, resourceDiagnostic.getCode (), message, (rootException != null) ? new Object [] {rootException} : null);
            loadDiagnostic.addAll (resourceDiagnostic);
            loadStatus = BasicDiagnostic.toIStatus (loadDiagnostic);
        }
        return loadStatus;
    }

}

