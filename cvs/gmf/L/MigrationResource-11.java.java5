package org.eclipse.gmf.internal.common.migrate;

import java.io.IOException;

import java.io.InputStream;

import java.util.HashMap;

import java.util.Map;

import org.eclipse.emf.common.util.URI;

import org.eclipse.emf.ecore.EClass;

import org.eclipse.emf.ecore.EObject;

import org.eclipse.emf.ecore.EPackage;

import org.eclipse.emf.ecore.EReference;

import org.eclipse.emf.ecore.EStructuralFeature;

import org.eclipse.emf.ecore.resource.Resource;

import org.eclipse.emf.ecore.xmi.XMLHelper;

import org.eclipse.emf.ecore.xmi.XMLLoad;

import org.eclipse.emf.ecore.xmi.impl.SAXXMIHandler;

import org.eclipse.emf.ecore.xmi.impl.XMILoadImpl;

import org.eclipse.gmf.internal.common.ToolingResourceFactory.ToolResource;

import org.xml.sax.helpers.DefaultHandler;

public class MigrationResource extends ToolResource {
    protected boolean oldVersionDetected;
    protected boolean migrationApplied;
    private Map < EObject, Map < String, String > > ignoredAttributes;
    private MigrationConfig config;

    MigrationResource (URI uri) {
        super (uri);
    }

    protected XMLLoad createXMLLoad () {
        return new XMILoadImpl (createXMLHelper ()) {

            protected DefaultHandler makeDefaultHandler () {
                return new MigrationHandler (MigrationResource.this, helper, options);
            }

        }

        ;
    }

    protected final void doUnload () {
        try {
            super.doUnload ();
        } finally {
            this.oldVersionDetected = false;
            this.migrationApplied = false;
        }
    }

    public final void doLoad (InputStream inputStream, Map < ?, ? > options) throws IOException {
        try {
            ignoredAttributes = new HashMap < EObject, Map < String, String > > ();
            super.doLoad (inputStream, options);
            handlePostLoad (null);
        } catch (IOException e) {
            handlePostLoad (e);
            throw e;
        } catch (RuntimeException e) {
            handlePostLoad (e);
            throw e;
        } finally {
            ignoredAttributes = null;
            config = null;
        }
    }

    protected void handleOldVersionDetected () {
        this.oldVersionDetected = true;
    }

    protected void handleMigrationPatchApplied () {
        this.migrationApplied = true;
    }

    protected void handlePostLoad (Exception exception) {
        if (exception == null && config != null) {
            config.handleResourceLoaded (this, ignoredAttributes);
        }
    }

    static Resource createCheckedResource (URI uri) {
        return new MigrationResource (uri) {

            protected XMLLoad createXMLLoad () {
                final MigrationResource res = this;
                return new XMILoadImpl (createXMLHelper ()) {

                    protected DefaultHandler makeDefaultHandler () {
                        return new BCKWDCompatibleHandler (res, helper, options);
                    }

                }

                ;
            }

            protected void handlePostLoad (Exception exception) {
                super.handlePostLoad (exception);
                if (oldVersionDetected && exception != null || ! getErrors ().isEmpty () || ! getWarnings ().isEmpty ()) {
                    Diagnostic diagnostic = MigrationUtil.createMessageDiagnostic (this, Messages.oldModelVersionLoadErrorMigrationMayBeRequired);
                    getErrors ().add (0, diagnostic);
                }
            }

        }

        ;
    }

    static Resource createCheckAndMigrateOnLoadResource (URI uri) {
        return new MigrationResource (uri) {

            protected void handlePostLoad (Exception exception) {
                super.handlePostLoad (exception);
                if (this.oldVersionDetected && migrationApplied) {
                    Diagnostic diagnostic = MigrationUtil.createMessageDiagnostic (this, Messages.oldModelVersionLoadedMigrationRequired);
                    getWarnings ().add (0, diagnostic);
                }
            }

        }

        ;
    }

    private static class BCKWDCompatibleHandler extends SAXXMIHandler {
        MigrationConfig config;
        protected boolean fixmePotentiallyCompatibilityIssues;

        BCKWDCompatibleHandler (MigrationResource xmiResource, XMLHelper helper, Map < ?, ? > options) {
            super (xmiResource, helper, options);
        }

        @Override
        protected EPackage getPackageForURI (String uriString) {
            if (config == null) {
                EPackage.Registry.INSTANCE.getEPackage (uriString);
                String ext = xmlResource.getURI ().fileExtension ();
                config = (ext != null) ? MigrationConfig.Registry.INSTANCE.getConfig (ext) : null;
                resource ().config = config;
            }
            if (config != null) {
                if (! config.getMetamodelNsURI ().equals (uriString) && config.backwardSupportedNsURIs ().contains (uriString)) {
                    resource ().handleOldVersionDetected ();
                    return super.getPackageForURI (config.getMetamodelNsURI ());
                }
                if (config.getMetamodelNsURI ().equals (uriString)) {
                    fixmePotentiallyCompatibilityIssues = true;
                }
            }
            return super.getPackageForURI (uriString);
        }

        @Override
        protected void handleUnknownFeature (String prefix, String name, boolean isElement, EObject peekObject, String value) {
            if (fixmePotentiallyCompatibilityIssues) {
                if (config.shouldIgnoreAttribute (peekObject, name)) {
                    resource ().handleOldVersionDetected ();
                }
            }
            super.handleUnknownFeature (prefix, name, isElement, peekObject, value);
        }

        MigrationResource resource () {
            assert xmlResource instanceof MigrationResource;
            return (MigrationResource) xmlResource;
        }

    };

    public static class MigrationHandler extends BCKWDCompatibleHandler {
        private FeatureKey processedFeatureKey;

        MigrationHandler (MigrationResource resource, XMLHelper helper, Map < ?, ? > options) {
            super (resource, helper, options);
            this.processedFeatureKey = new FeatureKey ();
        }

        @Override
        protected void setAttribValue (EObject object, String name, String value) {
            if ((isMigrationEnabled () || fixmePotentiallyCompatibilityIssues)) {
                if (config.setAttribValue (this, object, name, value)) {
                    notifyMigrationApplied ();
                    return;
                }
                if (config.shouldIgnoreAttribute (object, name)) {
                    Map < EObject, Map < String, String > > ignoredAttributes = resource ().ignoredAttributes;
                    if (ignoredAttributes != null) {
                        Map < String, String > attrs = ignoredAttributes.get (object);
                        if (attrs == null) {
                            attrs = new HashMap < String, String > ();
                            ignoredAttributes.put (object, attrs);
                        }
                        attrs.put (name, value);
                    }
                    notifyMigrationApplied ();
                    return;
                }
            }
            super.setAttribValue (object, name, value);
        }

        @Override
        protected void createObject (EObject peekObject, EStructuralFeature feature) {
            if (isMigrationEnabled ()) {
                if (config.handleCreateObject (this, peekObject, feature)) {
                    notifyMigrationApplied ();
                    return;
                }
                processedFeatureKey.setFeature (feature);
                if (getXSIType () == null && feature instanceof EReference) {
                    EClass oldDefaultRefType = (config != null) ? config.getAddedTypeInfo (processedFeatureKey) : null;
                    if (oldDefaultRefType != null) {
                        String typeQName = helper.getQName (oldDefaultRefType);
                        super.createObjectFromTypeName (peekObject, typeQName, feature);
                        notifyMigrationApplied ();
                        return;
                    }
                }
            }
            super.createObject (peekObject, feature);
        }

        @Override
        protected void handleFeature (String prefix, String name) {
            if (isMigrationEnabled ()) {
                if (config.handleFeature (this, prefix, name)) {
                    notifyMigrationApplied ();
                    return;
                }
            }
            super.handleFeature (prefix, name);
        }

        public EObject createObjectFromTypeNameHook (EObject peekObject, String typeQName, EStructuralFeature feature) {
            return super.createObjectFromTypeName (peekObject, typeQName, feature);
        }

        public void handleFeatureHook (String prefix, String name) {
            super.handleFeature (prefix, name);
        }

        public String getXSIType () {
            return super.getXSIType ();
        }

        public EObject peekEObject () {
            return objects.peekEObject ();
        }

        private boolean isMigrationEnabled () {
            return config != null && resource ().oldVersionDetected;
        }

        private void notifyMigrationApplied () {
            resource ().handleMigrationPatchApplied ();
        }

    }

}

