package org.eclipse.gmf.runtime.diagram.ui.figures;

import org.eclipse.draw2d.Graphics;

import org.eclipse.draw2d.MarginBorder;

import org.eclipse.draw2d.geometry.Dimension;

import org.eclipse.draw2d.geometry.PointList;

import org.eclipse.draw2d.geometry.Rectangle;

import org.eclipse.gmf.runtime.draw2d.ui.figures.ConstrainedToolbarLayout;

import org.eclipse.gmf.runtime.draw2d.ui.mapmode.MapMode;

import org.eclipse.gmf.runtime.gef.ui.figures.DefaultSizeNodeFigure;

public class NoteFigure extends DefaultSizeNodeFigure {
    static public final int CLIP_HEIGHT = MapMode.DPtoLP (12);
    static public final int MARGIN = MapMode.DPtoLP (5);
    static public final int CLIP_MARGIN = MapMode.DPtoLP (14);
    static private final int clipHeight = CLIP_HEIGHT;
    static private final int clipWidth = CLIP_HEIGHT + MapMode.DPtoLP (1);
    private static final int DEFAULT_NOTE_WIDTH = MapMode.DPtoLP (100);
    private static final int DEFAULT_NOTE_HEIGHT = MapMode.DPtoLP (56);
    private boolean diagrsamLinkMode = false;
    ;
    private boolean withDanglingCorner = true;
    private int lineWidth = 1;

    public NoteFigure () {
        setDefaultSize (new Dimension (DEFAULT_NOTE_WIDTH, DEFAULT_NOTE_HEIGHT));
        setBorder (new MarginBorder (NoteFigure.MARGIN, NoteFigure.MARGIN, NoteFigure.MARGIN, NoteFigure.CLIP_MARGIN));
        ConstrainedToolbarLayout layout = new ConstrainedToolbarLayout ();
        layout.setMinorAlignment (ConstrainedToolbarLayout.ALIGN_TOPLEFT);
        layout.setSpacing (MapMode.DPtoLP (5));
        setLayoutManager (layout);
    }

    protected PointList getPointList (Rectangle r) {
        PointList p = new PointList ();
        p.addPoint (r.x, r.y);
        if (! isDiagramLinkMode ()) {
            p.addPoint (r.x + r.width - clipWidth, r.y);
            p.addPoint (r.x + r.width - 1, r.y + clipHeight);
        } else {
            p.addPoint (r.x + r.width - 1, r.y);
        }
        p.addPoint (r.x + r.width - 1, r.y + r.height - 1);
        p.addPoint (r.x, r.y + r.height - 1);
        p.addPoint (r.x, r.y);
        return p;
    }

    protected void paintBorder (Graphics g) {
        if (! isDiagramLinkMode ()) {
            Rectangle r = getBounds ();
            PointList p = getPointList (r);
            g.setLineWidth (lineWidth);
            g.drawPolyline (p);
            if (withDanglingCorner) {
                PointList corner = new PointList ();
                corner.addPoint (r.x + r.width - clipWidth, r.y);
                corner.addPoint (r.x + r.width - clipWidth, r.y + clipHeight);
                corner.addPoint (r.x + r.width, r.y + clipHeight);
                g.drawPolyline (corner);
            }
        }
    }

    protected void paintFigure (Graphics g) {
        super.paintFigure (g);
        Rectangle r = getBounds ();
        PointList p = getPointList (r);
        g.fillPolygon (p);
    }

    public Dimension getPreferredSize (int wHint, int hHint) {
        return super.getPreferredSize (wHint, hHint).getUnioned (new Dimension (2645, 1322));
    }

    public boolean setDiagramLinkMode (boolean diagramLinkMode) {
        boolean bOldDiagramLinkMode = this.diagrsamLinkMode;
        ConstrainedToolbarLayout layout = (ConstrainedToolbarLayout) getLayoutManager ();
        if (diagramLinkMode) {
            layout.setMinorAlignment (ConstrainedToolbarLayout.ALIGN_CENTER);
        } else {
            layout.setMinorAlignment (ConstrainedToolbarLayout.ALIGN_TOPLEFT);
        }
        this.diagrsamLinkMode = diagramLinkMode;
        return bOldDiagramLinkMode;
    }

    public boolean isDiagramLinkMode () {
        return diagrsamLinkMode;
    }

}

