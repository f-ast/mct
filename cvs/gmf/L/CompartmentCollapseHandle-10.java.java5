package org.eclipse.gmf.runtime.diagram.ui.handles;

import java.beans.PropertyChangeEvent;

import java.beans.PropertyChangeListener;

import org.eclipse.draw2d.Cursors;

import org.eclipse.draw2d.IFigure;

import org.eclipse.draw2d.Locator;

import org.eclipse.draw2d.StackLayout;

import org.eclipse.draw2d.TreeSearch;

import org.eclipse.draw2d.geometry.Dimension;

import org.eclipse.draw2d.geometry.Rectangle;

import org.eclipse.emf.common.notify.Notification;

import org.eclipse.emf.transaction.TransactionalEditingDomain;

import org.eclipse.gef.DragTracker;

import org.eclipse.gef.handles.AbstractHandle;

import org.eclipse.gmf.runtime.diagram.core.listener.DiagramEventBroker;

import org.eclipse.gmf.runtime.diagram.core.listener.NotificationListener;

import org.eclipse.gmf.runtime.diagram.ui.editparts.IGraphicalEditPart;

import org.eclipse.gmf.runtime.diagram.ui.editparts.IResizableCompartmentEditPart;

import org.eclipse.gmf.runtime.diagram.ui.internal.figures.CollapseFigure;

import org.eclipse.gmf.runtime.diagram.ui.internal.properties.Properties;

import org.eclipse.gmf.runtime.diagram.ui.internal.tools.CompartmentCollapseTracker;

import org.eclipse.gmf.runtime.notation.DrawerStyle;

import org.eclipse.gmf.runtime.notation.NotationPackage;

import org.eclipse.gmf.runtime.notation.View;

public class CompartmentCollapseHandle extends AbstractHandle implements PropertyChangeListener, NotificationListener {
    private class CollapseHandleLocator implements Locator {

        public void relocate (IFigure target) {
            Rectangle theBounds = getOwnerFigure ().getClientArea ().getCopy ();
            getOwnerFigure ().translateToAbsolute (theBounds);
            target.translateToRelative (theBounds);
            target.setLocation (theBounds.getLocation ());
        }

    }

    public static Dimension SIZE = new Dimension (11, 11);
    protected CollapseFigure collapseFigure = null;

    public CompartmentCollapseHandle (IGraphicalEditPart owner) {
        setOwner (owner);
        setLocator (new CollapseHandleLocator ());
        setCursor (Cursors.ARROW);
        setSize (SIZE);
        setLayoutManager (new StackLayout ());
        if (owner != null && owner.getParent () != null && owner.getParent () instanceof IGraphicalEditPart) add (collapseFigure = new CollapseFigure (((IGraphicalEditPart) owner.getParent ()).getFigure ()));
        else add (collapseFigure = new CollapseFigure ());

        View view = owner.getNotationView ();
        if (view != null) {
            DrawerStyle style = (DrawerStyle) view.getStyle (NotationPackage.eINSTANCE.getDrawerStyle ());
            if (style != null) {
                collapseFigure.setCollapsed (style.isCollapsed ());
                return;
            }
        }
        collapseFigure.setCollapsed (false);
    }

    public IFigure findFigureAt (int x, int y, TreeSearch search) {
        IFigure found = super.findFigureAt (x, y, search);
        return (collapseFigure.equals (found)) ? this : found;
    }

    protected DragTracker createDragTracker () {
        return new CompartmentCollapseTracker ((IResizableCompartmentEditPart) getOwner ());
    }

    public void propertyChange (PropertyChangeEvent evt) {
        if (evt.getPropertyName ().equals (Properties.ID_COLLAPSED)) collapseFigure.setCollapsed (((Boolean) evt.getNewValue ()).booleanValue ());

    }

    public void notifyChanged (Notification notification) {
        if (NotationPackage.eINSTANCE.getDrawerStyle_Collapsed () == notification.getFeature ()) collapseFigure.setCollapsed (notification.getNewBooleanValue ());

    }

    public void addNotify () {
        super.addNotify ();
        IGraphicalEditPart owner = (IGraphicalEditPart) getOwner ();
        View view = owner.getNotationView ();
        if (view != null) {
            getDiagramEventBroker ().addNotificationListener (owner.getNotationView (), CompartmentCollapseHandle.this);
        }
    }

    public void removeNotify () {
        IGraphicalEditPart owner = (IGraphicalEditPart) getOwner ();
        getDiagramEventBroker ().removeNotificationListener (owner.getNotationView (), this);
        super.removeNotify ();
    }

    private DiagramEventBroker getDiagramEventBroker () {
        TransactionalEditingDomain theEditingDomain = ((IGraphicalEditPart) getOwner ()).getEditingDomain ();
        if (theEditingDomain != null) {
            return DiagramEventBroker.getInstance (theEditingDomain);
        }
        return null;
    }

}

