package org.eclipse.gmf.runtime.common.ui.services.elementselection;

import java.util.ArrayList;

import java.util.HashMap;

import java.util.Iterator;

import java.util.List;

import java.util.Map;

import org.eclipse.core.runtime.IProgressMonitor;

import org.eclipse.core.runtime.jobs.Job;

import org.eclipse.gmf.runtime.common.core.service.ExecutionStrategy;

import org.eclipse.gmf.runtime.common.core.service.IOperation;

import org.eclipse.gmf.runtime.common.core.service.Service;

import org.eclipse.gmf.runtime.common.ui.services.internal.CommonUIServicesPlugin;

import org.eclipse.gmf.runtime.common.ui.services.internal.elementselection.ElementSelectionList;

import org.eclipse.gmf.runtime.common.ui.services.internal.elementselection.MatchingObjectsOperation;

import org.eclipse.gmf.runtime.common.ui.services.internal.l10n.CommonUIServicesMessages;

import org.eclipse.osgi.util.NLS;

import org.eclipse.ui.PlatformUI;

public class ElementSelectionService extends Service implements IElementSelectionProvider, IElementSelectionListener {
    private IElementSelectionInput elementSelectionInput;
    private IElementSelectionListener elementSelectionListener;
    private HashMap jobs = new HashMap ();
    private final static ElementSelectionService instance = new ElementSelectionService ();

    static {
        instance.configureProviders (CommonUIServicesPlugin.getPluginId (), "elementSelectionProviders");
    }

    protected ElementSelectionService () {
        super (true);
    }

    public static ElementSelectionService getInstance () {
        return instance;
    }

    public List getMatchingObjects (IElementSelectionInput input) {
        return new ElementSelectionList ().getMatchingObjects (input);
    }

    public ElementSelectionServiceJob getMatchingObjects (IElementSelectionInput input, IElementSelectionListener listener) {
        elementSelectionInput = input;
        elementSelectionListener = listener;
        ElementSelectionServiceJob job = new ElementSelectionServiceJob (getJobName (), this);
        job.setPriority (Job.SHORT);
        job.schedule ();
        return job;
    }

    public void run (IProgressMonitor monitor) {
        List results = new ArrayList ();
        IOperation operation = new MatchingObjectsOperation (elementSelectionInput);
        for (int i = 0;
        i < ExecutionStrategy.PRIORITIES.length; ++ i) {
            List providers = ExecutionStrategy.FORWARD.getUncachedProviders (this, ExecutionStrategy.PRIORITIES [i], operation);
            results.addAll (providers);
        }
        for (Iterator i = results.iterator ();
        i.hasNext ();) {
            IElementSelectionProvider provider = (IElementSelectionProvider) i.next ();
            addJob (provider);
        }
        HashMap jobsClone;
        synchronized (jobs) {
            jobsClone = (HashMap) jobs.clone ();
        }
        for (Iterator i = jobsClone.entrySet ().iterator ();
        i.hasNext ();) {
            Map.Entry entry = (Map.Entry) i.next ();
            ElementSelectionServiceJob job = (ElementSelectionServiceJob) entry.getValue ();
            job.schedule ();
        }
        monitor.beginTask (getJobName (), 1000);
        while (true) {
            synchronized (jobs) {
                if (jobs.size () == 0) {
                    break;
                }
            }
            monitor.worked (1);
            if (monitor.isCanceled ()) {
                cancelAllJobs ();
                break;
            }
        }
        monitor.done ();
    }

    public Object resolve (IMatchingObject object) {
        return null;
    }

    protected String getJobName () {
        String providerName = getClass ().getName ().substring (getClass ().getName ().lastIndexOf ('.') + 1);
        String filter = elementSelectionInput.getInput ();
        return NLS.bind (CommonUIServicesMessages.ElementSelectionService_JobName, new String [] {providerName, filter});
    }

    private void addJob (IElementSelectionProvider provider) {
        ElementSelectionServiceJob job = provider.getMatchingObjects (elementSelectionInput, this);
        synchronized (jobs) {
            jobs.put (provider, job);
        }
    }

    private void removeJob (IElementSelectionProvider provider) {
        boolean end_of_matches = false;
        synchronized (jobs) {
            jobs.remove (provider);
            if (jobs.size () == 0) {
                end_of_matches = true;
            }
        }
        if (end_of_matches) {
            fireEndOfMatchesEvent ();
        }
    }

    protected void fireMatchingObjectEvent (final IMatchingObjectEvent matchingObjectEvent) {
        PlatformUI.getWorkbench ().getDisplay ().asyncExec (new Runnable () {

            public void run () {
                elementSelectionListener.matchingObjectEvent (matchingObjectEvent);
            }

        }

        );
    }

    protected void fireEndOfMatchesEvent () {
        IMatchingObject matchingObject = new AbstractMatchingObject (null, null, null, this);
        MatchingObjectEvent matchingObjectEvent = new MatchingObjectEvent (MatchingObjectEventType.END_OF_MATCHES, matchingObject);
        fireMatchingObjectEvent (matchingObjectEvent);
    }

    public void matchingObjectEvent (IMatchingObjectEvent matchingObjectEvent) {
        if (matchingObjectEvent.getEventType () == MatchingObjectEventType.END_OF_MATCHES) {
            removeJob (matchingObjectEvent.getMatchingObject ().getProvider ());
        } else {
            fireMatchingObjectEvent (matchingObjectEvent);
        }
    }

    protected void cancelAllJobs () {
        HashMap jobsClone;
        synchronized (jobs) {
            jobsClone = (HashMap) jobs.clone ();
        }
        for (Iterator i = jobsClone.entrySet ().iterator ();
        i.hasNext ();) {
            Map.Entry entry = (Map.Entry) i.next ();
            IElementSelectionProvider provider = (IElementSelectionProvider) entry.getKey ();
            ElementSelectionServiceJob job = (ElementSelectionServiceJob) entry.getValue ();
            job.cancel ();
            removeJob (provider);
        }
    }

}

