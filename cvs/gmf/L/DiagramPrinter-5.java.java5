package org.eclipse.gmf.runtime.diagram.ui.printing.internal.util;

import java.util.Collection;

import java.util.Iterator;

import org.eclipse.draw2d.Graphics;

import org.eclipse.draw2d.SWTGraphics;

import org.eclipse.draw2d.geometry.Rectangle;

import org.eclipse.gef.LayerConstants;

import org.eclipse.gmf.runtime.diagram.core.preferences.PreferencesHint;

import org.eclipse.gmf.runtime.diagram.ui.editparts.DiagramEditPart;

import org.eclipse.gmf.runtime.diagram.ui.internal.pagesetup.PageInfoHelper;

import org.eclipse.gmf.runtime.diagram.ui.internal.pagesetup.PageInfoHelper.PageMargins;

import org.eclipse.gmf.runtime.diagram.ui.internal.properties.WorkspaceViewerProperties;

import org.eclipse.gmf.runtime.diagram.ui.parts.DiagramGraphicalViewer;

import org.eclipse.gmf.runtime.draw2d.ui.internal.graphics.MapModeGraphics;

import org.eclipse.gmf.runtime.draw2d.ui.internal.graphics.PrinterGraphics;

import org.eclipse.gmf.runtime.draw2d.ui.mapmode.IMapMode;

import org.eclipse.gmf.runtime.draw2d.ui.mapmode.MapModeUtil;

import org.eclipse.gmf.runtime.notation.Diagram;

import org.eclipse.jface.preference.IPreferenceStore;

import org.eclipse.jface.resource.JFaceResources;

import org.eclipse.jface.util.Assert;

import org.eclipse.swt.graphics.Font;

import org.eclipse.swt.graphics.FontData;

import org.eclipse.swt.graphics.GC;

import org.eclipse.swt.graphics.Point;

import org.eclipse.swt.printing.Printer;

import org.eclipse.swt.widgets.Display;

public class DiagramPrinter implements Runnable {
    protected Printer printer;
    private Point display_dpi;
    private boolean isScaledPercent = false;
    private int rows = 1;
    private int columns = 1;
    private GC gc;
    protected Graphics graphics;
    protected Point printerOffset;
    protected Rectangle logicalClientArea;
    private float userScale;
    protected Collection diagrams;
    private Point translated = null;
    private PreferencesHint preferencesHint;
    private IMapMode mm;

    public DiagramPrinter (PreferencesHint preferencesHint, IMapMode mm) {
        super ();
        this.preferencesHint = preferencesHint;
        this.mm = mm;
    }

    public DiagramPrinter (PreferencesHint preferencesHint) {
        this (preferencesHint, MapModeUtil.getMapMode ());
    }

    protected IMapMode getMapMode () {
        return mm;
    }

    public void setColumns (int columns) {
        this.columns = columns;
    }

    public void setDiagrams (Collection diagrams) {
        this.diagrams = diagrams;
    }

    public void setDisplayDPI (Point display_dpi) {
        this.display_dpi = new Point (display_dpi.x, display_dpi.y);
    }

    public void setPrinter (Printer printer) {
        this.printer = printer;
    }

    public void setRows (int rows) {
        this.rows = rows;
    }

    public void setScaledPercent (int scalePercent) {
        this.isScaledPercent = true;
        this.userScale = (scalePercent) / 100.0f;
    }

    public void run () {
        assert null != printer : "printer must be set";
        if (! (printer.startJob ("Printing"))) {
            return;
        }
        initialize ();
        assert diagrams != null;
        Iterator it = diagrams.iterator ();
        while (it.hasNext ()) {
            Object obj = it.next ();
            Assert.isTrue (obj instanceof Diagram);
            DiagramEditPart dgrmEP = PrintHelper.createDiagramEditPart ((Diagram) obj, preferencesHint);
            boolean loadedPreferences = PrintHelper.initializePreferences (dgrmEP, preferencesHint);
            assert dgrmEP.getViewer () instanceof DiagramGraphicalViewer;
            IPreferenceStore fPreferences = ((DiagramGraphicalViewer) dgrmEP.getViewer ()).getWorkspaceViewerPreferenceStore ();
            doPrintDiagram (dgrmEP, loadedPreferences, fPreferences);
        }
        printer.endJob ();
        dispose ();
    }

    private void doPrintDiagram (DiagramEditPart dgrmEP, boolean loadedPreferences, IPreferenceStore fPreferences) {
        this.graphics.pushState ();
        if (isScaledPercent) {
            printToScale (dgrmEP, loadedPreferences, fPreferences);
        } else {
            printToPages (dgrmEP, loadedPreferences, fPreferences);
        }
        this.graphics.popState ();
    }

    private void initialize () {
        assert null != printer : "printer must be set";
        this.gc = new GC (printer);
        gc.setXORMode (false);
        Graphics g = new SWTGraphics (gc);
        this.graphics = createMapModeGraphics (g);
        this.graphics.scale (computePrinterDisplayScale ());
        this.logicalClientArea = this.graphics.getClip (new Rectangle (this.printer.getClientArea ()));
    }

    protected Point getPrinterOffset () {
        if (printerOffset == null) {
            int offsetX = this.printer.getBounds ().width - this.printer.getClientArea ().width;
            int offsetY = this.printer.getBounds ().height - this.printer.getClientArea ().height;
            offsetX = (int) (getMapMode ().DPtoLP ((int) (offsetX / 2.0f * display_dpi.x / printer.getDPI ().x)) / userScale);
            offsetY = (int) (getMapMode ().DPtoLP ((int) (offsetY / 2.0f * display_dpi.y / printer.getDPI ().y)) / userScale);
            printerOffset = new Point (offsetX, offsetY);
        }
        return printerOffset;
    }

    protected void printToScale (DiagramEditPart dgrmEP, boolean loadedPreferences, IPreferenceStore fPreferences) {
        assert null != printer : "printer must be set";
        Rectangle figureBounds = PrintHelper.getPageBreakBounds (dgrmEP, loadedPreferences);
        translated = new Point (- figureBounds.x, - figureBounds.y);
        this.graphics.translate (translated.x, translated.y);
        this.graphics.scale (userScale);
        org.eclipse.draw2d.geometry.Point pageSize = PageInfoHelper.getPageSize (fPreferences, false);
        float fNumRows = (figureBounds.height * userScale) / pageSize.y;
        int numRows = (int) Math.ceil (fNumRows);
        float fNumCols = (figureBounds.width * userScale) / pageSize.x;
        int numCols = (int) Math.ceil (fNumCols);
        PageMargins margins = PageInfoHelper.getPageMargins (fPreferences);
        adjustMargins (margins, userScale, getPrinterOffset ());
        GC gc_ = new GC (Display.getDefault ());
        FontData fontData = JFaceResources.getDefaultFont ().getFontData () [0];
        Font font = new Font (printer, fontData);
        try {
            for (int row = 1;
            row <= numRows; row ++) {
                for (int col = 1;
                col <= numCols; col ++) {
                    printer.startPage ();
                    drawPage (gc_, dgrmEP, fPreferences, figureBounds, margins, font, row, col);
                    printer.endPage ();
                }
            }
        } finally {
            font.dispose ();
            gc_.dispose ();
        }
    }

    protected void drawHeaderAndFooter (GC gc_, DiagramEditPart dgrmEP, Rectangle figureBounds, Font font, int rowIndex, int colIndex) {
        int width = this.logicalClientArea.width;
        int height = this.logicalClientArea.height;
        this.graphics.pushState ();
        this.graphics.setFont (font);
        this.graphics.scale (1.0f / userScale);
        this.graphics.translate (- translated.x, - translated.y);
        String headerOrFooter = HeaderAndFooterHelper.makeHeaderOrFooterString (WorkspaceViewerProperties.HEADER_PREFIX, rowIndex, colIndex, dgrmEP);
        this.graphics.drawText (headerOrFooter, HeaderAndFooterHelper.LEFT_MARGIN + (width - getMapMode ().DPtoLP (gc_.textExtent (headerOrFooter).x)) / 2, HeaderAndFooterHelper.TOP_MARGIN);
        headerOrFooter = HeaderAndFooterHelper.makeHeaderOrFooterString (WorkspaceViewerProperties.FOOTER_PREFIX, rowIndex, colIndex, dgrmEP);
        this.graphics.drawText (headerOrFooter, HeaderAndFooterHelper.LEFT_MARGIN + (width - getMapMode ().DPtoLP (gc_.textExtent (headerOrFooter).x)) / 2, height - HeaderAndFooterHelper.BOTTOM_MARGIN);
        this.graphics.popState ();
    }

    protected void drawPage (GC gc_, DiagramEditPart dgrmEP, IPreferenceStore fPreferences, Rectangle figureBounds, PageMargins margins, Font font, int rowIndex, int colIndex) {
        org.eclipse.draw2d.geometry.Point pageSize = PageInfoHelper.getPageSize (fPreferences, false);
        int width = pageSize.x, height = pageSize.y;
        int translateX = - (width * (colIndex - 1));
        int translateY = - (height * (rowIndex - 1));
        int scaledTranslateX = (int) (translateX / userScale);
        int scaledTranslateY = (int) (translateY / userScale);
        int scaledWidth = (int) (width / userScale);
        int scaledHeight = (int) (height / userScale);
        scaledTranslateX += ((margins.left * colIndex) + (margins.right * (colIndex - 1)));
        scaledTranslateY += ((margins.top * rowIndex) + (margins.bottom * (rowIndex - 1)));
        drawHeaderAndFooter (gc_, dgrmEP, figureBounds, font, rowIndex, colIndex);
        this.graphics.pushState ();
        this.graphics.translate (scaledTranslateX, scaledTranslateY);
        Rectangle r = new Rectangle ((scaledWidth - margins.left - margins.right) * (colIndex - 1) + figureBounds.x, (scaledHeight - margins.top - margins.bottom) * (rowIndex - 1) + figureBounds.y, scaledWidth - margins.left - margins.right, scaledHeight - margins.top - margins.bottom);
        this.graphics.clipRect (r);
        dgrmEP.getLayer (LayerConstants.PRINTABLE_LAYERS).paint (this.graphics);
        this.graphics.popState ();
    }

    protected void printToPages (DiagramEditPart dgrmEP, boolean loadedPreferences, IPreferenceStore fPreferences) {
        assert null != printer : "printer must be set";
        Rectangle figureBounds = PrintHelper.getPageBreakBounds (dgrmEP, loadedPreferences);
        org.eclipse.draw2d.geometry.Point pageBounds = PageInfoHelper.getPageSize (fPreferences);
        Rectangle translate = new Rectangle (Math.min (0, figureBounds.x), Math.min (0, figureBounds.y), Math.max (pageBounds.x, figureBounds.width), Math.max (pageBounds.y, figureBounds.height));
        org.eclipse.draw2d.geometry.Point pageSize = PageInfoHelper.getPageSize (fPreferences, true);
        int offsetX = this.printer.getBounds ().width - this.printer.getClientArea ().width;
        int offsetY = this.printer.getBounds ().height - this.printer.getClientArea ().height;
        pageSize.x -= offsetX * columns;
        pageSize.y -= offsetY * rows;
        float vScale = ((float) (this.rows * pageSize.y)) / translate.height;
        float hScale = ((float) (this.columns * pageSize.x)) / translate.width;
        this.userScale = Math.min (hScale, vScale);
        translated = new Point ((int) (- translate.x * userScale), (int) (- translate.y * userScale));
        this.graphics.translate (translated.x, translated.y);
        this.graphics.scale (this.userScale);
        PageMargins margins = PageInfoHelper.getPageMargins (fPreferences);
        adjustMargins (margins, userScale, getPrinterOffset ());
        GC gc_ = new GC (Display.getDefault ());
        FontData fontData = JFaceResources.getDefaultFont ().getFontData () [0];
        Font font = new Font (printer, fontData);
        try {
            for (int row = 1;
            row <= rows; row ++) {
                for (int col = 1;
                col <= columns; col ++) {
                    printer.startPage ();
                    drawPage (gc_, dgrmEP, fPreferences, translate, margins, font, row, col);
                    printer.endPage ();
                }
            }
        } finally {
            font.dispose ();
            gc_.dispose ();
        }
    }

    private float computePrinterDisplayScale () {
        assert null != printer : "printer must be set";
        assert null != display_dpi : "display_dpi must be set";
        Point dpi = printer.getDPI ();
        float scale = dpi.x / (float) display_dpi.x;
        return scale;
    }

    private void dispose () {
        if (this.gc != null) {
            this.gc.dispose ();
            this.gc = null;
        }
    }

    protected MapModeGraphics createMapModeGraphics (Graphics theGraphics) {
        return new MapModeGraphics (new PrinterGraphics (theGraphics, printer, true), getMapMode ());
    }

    protected PreferencesHint getPreferencesHint () {
        return preferencesHint;
    }

    protected void adjustMargins (PageMargins margins, float scale, Point offset) {
        margins.left /= scale;
        margins.top /= scale;
        margins.right /= scale;
        margins.bottom /= scale;
        margins.left -= offset.x;
        margins.right += offset.x;
        margins.top -= offset.y;
        margins.bottom += offset.y;
        if (margins.left < 0) margins.left = 0;

        if (margins.right < 0) margins.right = 0;

        if (margins.top < 0) margins.top = 0;

        if (margins.bottom < 0) margins.bottom = 0;

    }

}

