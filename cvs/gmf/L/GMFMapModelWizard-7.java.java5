package org.eclipse.gmf.mappings.presentation;

import java.util.HashMap;

import java.util.Map;

import org.eclipse.core.resources.IContainer;

import org.eclipse.core.resources.IFile;

import org.eclipse.core.resources.IFolder;

import org.eclipse.core.resources.IProject;

import org.eclipse.core.resources.IResource;

import org.eclipse.core.resources.ResourcesPlugin;

import org.eclipse.core.runtime.IProgressMonitor;

import org.eclipse.core.runtime.Path;

import org.eclipse.emf.common.util.URI;

import org.eclipse.emf.ecore.EObject;

import org.eclipse.emf.ecore.resource.Resource;

import org.eclipse.emf.ecore.resource.ResourceSet;

import org.eclipse.emf.ecore.resource.impl.ResourceSetImpl;

import org.eclipse.emf.ecore.xmi.XMLResource;

import org.eclipse.emf.edit.ui.provider.ExtendedImageRegistry;

import org.eclipse.gmf.mappings.provider.GMFMapEditPlugin;

import org.eclipse.jface.dialogs.MessageDialog;

import org.eclipse.jface.viewers.ISelection;

import org.eclipse.jface.viewers.IStructuredSelection;

import org.eclipse.jface.viewers.StructuredSelection;

import org.eclipse.jface.wizard.Wizard;

import org.eclipse.ui.INewWizard;

import org.eclipse.ui.IWorkbench;

import org.eclipse.ui.IWorkbenchPage;

import org.eclipse.ui.IWorkbenchPart;

import org.eclipse.ui.IWorkbenchWindow;

import org.eclipse.ui.PartInitException;

import org.eclipse.ui.actions.WorkspaceModifyOperation;

import org.eclipse.ui.dialogs.WizardNewFileCreationPage;

import org.eclipse.ui.part.FileEditorInput;

import org.eclipse.ui.part.ISetSelectionTarget;

public class GMFMapModelWizard extends Wizard implements INewWizard {
    protected GMFMapModelWizardNewFileCreationPage newFileCreationPage;
    protected MapRefModelPages refPages;
    protected IStructuredSelection selection;
    protected IWorkbench workbench;

    public void init (IWorkbench workbench, IStructuredSelection selection) {
        this.workbench = workbench;
        this.selection = selection;
        setWindowTitle (GMFMapEditPlugin.INSTANCE.getString ("_UI_Wizard_label"));
        setDefaultPageImageDescriptor (ExtendedImageRegistry.INSTANCE.getImageDescriptor (GMFMapEditPlugin.INSTANCE.getImage ("full/wizban/NewGMFMap")));
        refPages = new MapRefModelPages (true, null);
    }

    protected EObject createInitialModel () {
        return refPages.createMapping ();
    }

    public boolean performFinish () {
        try {
            final IFile modelFile = getModelFile ();
            WorkspaceModifyOperation operation = new WorkspaceModifyOperation () {

                protected void execute (IProgressMonitor progressMonitor) {
                    try {
                        ResourceSet resourceSet = new ResourceSetImpl ();
                        URI fileURI = URI.createPlatformResourceURI (modelFile.getFullPath ().toString ());
                        Resource resource = resourceSet.createResource (fileURI);
                        EObject rootObject = createInitialModel ();
                        if (rootObject != null) {
                            resource.getContents ().add (rootObject);
                        }
                        Map options = new HashMap ();
                        options.put (XMLResource.OPTION_ENCODING, "UTF-8");
                        resource.save (options);
                    } catch (Exception exception) {
                        GMFMapEditPlugin.INSTANCE.log (exception);
                    } finally {
                        progressMonitor.done ();
                    }
                }

            }

            ;
            getContainer ().run (false, false, operation);
            IWorkbenchWindow workbenchWindow = workbench.getActiveWorkbenchWindow ();
            IWorkbenchPage page = workbenchWindow.getActivePage ();
            final IWorkbenchPart activePart = page.getActivePart ();
            if (activePart instanceof ISetSelectionTarget) {
                final ISelection targetSelection = new StructuredSelection (modelFile);
                getShell ().getDisplay ().asyncExec (new Runnable () {

                    public void run () {
                        ((ISetSelectionTarget) activePart).selectReveal (targetSelection);
                    }

                }

                );
            }
            try {
                page.openEditor (new FileEditorInput (modelFile), workbench.getEditorRegistry ().getDefaultEditor (modelFile.getFullPath ().toString ()).getId ());
            } catch (PartInitException exception) {
                MessageDialog.openError (workbenchWindow.getShell (), GMFMapEditPlugin.INSTANCE.getString ("_UI_OpenEditorError_label"), exception.getMessage ());
                return false;
            }
            return true;
        } catch (Exception exception) {
            GMFMapEditPlugin.INSTANCE.log (exception);
            return false;
        }
    }

    public class GMFMapModelWizardNewFileCreationPage extends WizardNewFileCreationPage {

        public GMFMapModelWizardNewFileCreationPage (String pageId, IStructuredSelection selection) {
            super (pageId, selection);
        }

        protected boolean validatePage () {
            if (super.validatePage ()) {
                String requiredExt = GMFMapEditPlugin.INSTANCE.getString ("_UI_GMFMapEditorFilenameExtension");
                String enteredExt = new Path (getFileName ()).getFileExtension ();
                if (enteredExt == null || ! enteredExt.equals (requiredExt)) {
                    setErrorMessage (GMFMapEditPlugin.INSTANCE.getString ("_WARN_FilenameExtension", new Object [] {requiredExt}));
                    return false;
                } else {
                    return true;
                }
            } else {
                return false;
            }
        }

        public IFile getModelFile () {
            return ResourcesPlugin.getWorkspace ().getRoot ().getFile (getContainerFullPath ().append (getFileName ()));
        }

    }

    public void addPages () {
        newFileCreationPage = new GMFMapModelWizardNewFileCreationPage ("Whatever", selection);
        newFileCreationPage.setTitle (GMFMapEditPlugin.INSTANCE.getString ("_UI_GMFMapModelWizard_label"));
        newFileCreationPage.setDescription (GMFMapEditPlugin.INSTANCE.getString ("_UI_GMFMapModelWizard_description"));
        newFileCreationPage.setFileName (GMFMapEditPlugin.INSTANCE.getString ("_UI_GMFMapEditorFilenameDefaultBase") + "." + GMFMapEditPlugin.INSTANCE.getString ("_UI_GMFMapEditorFilenameExtension"));
        addPage (newFileCreationPage);
        if (selection != null && ! selection.isEmpty ()) {
            Object selectedElement = selection.iterator ().next ();
            if (selectedElement instanceof IResource) {
                IResource selectedResource = (IResource) selectedElement;
                if (selectedResource.getType () == IResource.FILE) {
                    selectedResource = selectedResource.getParent ();
                }
                if (selectedResource instanceof IFolder || selectedResource instanceof IProject) {
                    newFileCreationPage.setContainerFullPath (selectedResource.getFullPath ());
                    String defaultModelBaseFilename = GMFMapEditPlugin.INSTANCE.getString ("_UI_GMFMapEditorFilenameDefaultBase");
                    String defaultModelFilenameExtension = GMFMapEditPlugin.INSTANCE.getString ("_UI_GMFMapEditorFilenameExtension");
                    String modelFilename = defaultModelBaseFilename + "." + defaultModelFilenameExtension;
                    for (int i = 1;
                    ((IContainer) selectedResource).findMember (modelFilename) != null; ++ i) {
                        modelFilename = defaultModelBaseFilename + i + "." + defaultModelFilenameExtension;
                    }
                    newFileCreationPage.setFileName (modelFilename);
                }
            }
        }
        refPages.addPages (this, selection);
    }

    public IFile getModelFile () {
        return newFileCreationPage.getModelFile ();
    }

}

