head	1.1;
access;
symbols
	v20081020-0700:1.1
	v20080807-1333:1.1
	v20080807-1325:1.1
	v20080731-1520:1.1
	v20080725-1738:1.1
	v20080722-1827:1.1
	R2_1_maintenance:1.1.0.6
	Root_R2_1_maintenance:1.1
	R2_1_0:1.1
	v20080425-1959:1.1
	v20080328-1605:1.1
	v20080222-1200:1.1
	v20080114-2222:1.1
	v20080107-1111:1.1
	v20071130-1111:1.1
	v20071124-0000:1.1
	v20070809-0000:1.1
	R2_0_maintenance:1.1.0.4
	R2_0:1.1
	R4_20:1.1
	RC3_20:1.1
	v20070601-1400:1.1
	v20070518-1300:1.1
	v20070403-1500:1.1
	v20070330-1300:1.1
	v20070208-1800:1.1
	M4_20:1.1
	v20061214-0000:1.1
	M3_20:1.1
	v20061117-0800:1.1
	v20061013-1330:1.1
	v20060919-0800:1.1
	v20060907-1100:1.1
	M1_20:1.1
	v20060831-1500:1.1
	v20060817-1500:1.1
	v20060803-1200:1.1
	v20060721-1130:1.1
	v20060713-1700:1.1
	R1_0_maintenance:1.1.0.2
	R1_0:1.1
	v20060627-1200:1.1
	v20060616-1200:1.1
	v20060609-1400:1.1
	v20060531-1730:1.1
	v20060530-1930:1.1
	v20060526-1200:1.1
	v20060519-0800:1.1
	I20060505-1400:1.1
	I20060428-1300:1.1;
locks; strict;
comment	@# @;


1.1
date	2006.04.26.20.14.33;	author ldamus;	state Exp;
branches;
next	;


desc
@@


1.1
log
@[136760] gmf_head ldamus 060426  ElementTypeRegistry prevents deployment of different applications sharing the same metamodel
@
text
@/******************************************************************************
 * Copyright (c) 2006 IBM Corporation and others.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    IBM Corporation - initial API and implementation 
 ****************************************************************************/

package org.eclipse.gmf.runtime.emf.type.core.internal.impl;

import org.eclipse.core.runtime.CoreException;
import org.eclipse.core.runtime.IConfigurationElement;
import org.eclipse.gmf.runtime.common.core.util.Trace;
import org.eclipse.gmf.runtime.emf.type.core.ClientContext;
import org.eclipse.gmf.runtime.emf.type.core.IElementMatcher;
import org.eclipse.gmf.runtime.emf.type.core.internal.EMFTypeDebugOptions;
import org.eclipse.gmf.runtime.emf.type.core.internal.EMFTypePlugin;
import org.eclipse.gmf.runtime.emf.type.core.internal.EMFTypePluginStatusCodes;
import org.eclipse.gmf.runtime.emf.type.core.internal.descriptors.ElementTypeXmlConfig;
import org.eclipse.gmf.runtime.emf.type.core.internal.l10n.EMFTypeCoreMessages;

/**
 * The implementation of the client context that is created using a
 * configuration element.
 * 
 * @@author ldamus
 */
public class XMLClientContext extends ClientContext {

	private static final String E_ENABLEMENT = "enablement"; //$NON-NLS-1$

	private static final String E_MATCHER = "matcher"; //$NON-NLS-1$

	/**
	 * Initializes me with my XML configuration.
	 * 
	 * @@param config
	 *            my XML configuration element
	 * @@throws CoreException
	 *             on any problem in accessing the <code>config</code>uration
	 *             or if anything is missing or incorrect
	 */
	public XMLClientContext(IConfigurationElement config) throws CoreException {
		super(initializeId(config), initializeMatcher(config, config
				.getAttribute(ElementTypeXmlConfig.A_ID)));
	}

	/**
	 * Gets my ID from the specified XML <code>config</code>.
	 * 
	 * @@param config
	 *            my XML configuration
	 * @@return my ID (never <code>null</code>)
	 * @@throws CoreException
	 *             if my ID is not specified
	 */
	private static String initializeId(IConfigurationElement config)
			throws CoreException {
		String result = config.getAttribute(ElementTypeXmlConfig.A_ID);

		if (result == null) {
			CoreException ce = EMFTypePluginStatusCodes
					.getContextInitException(config.getContributor().getName(),
							EMFTypeCoreMessages.context_no_id_ERROR_);

			Trace.throwing(EMFTypePlugin.getPlugin(),
					EMFTypeDebugOptions.EXCEPTIONS_THROWING,
					XMLClientContext.class, "initializeId", ce); //$NON-NLS-1$

			throw ce;
		}

		return result;
	}

	/**
	 * Gets my matcher from the specified XML <code>config</code>.
	 * 
	 * @@param config
	 *            my XML configuration
	 * @@param id
	 *            the client context ID
	 * @@return my matcher (never <code>null</code>)
	 * @@throws CoreException
	 *             if my matcher is not specified or something went wrong in
	 *             initializing it
	 */
	private static IElementMatcher initializeMatcher(
			IConfigurationElement config, String id) throws CoreException {
		IElementMatcher result = null;

		IConfigurationElement[] enablement = config.getChildren(E_ENABLEMENT);
		if (enablement.length > 0) {
			result = initializeExpressionMatcher(enablement[0], id);
		} else {
			IConfigurationElement[] custom = config.getChildren(E_MATCHER);
			if (custom.length > 0) {
				result = initializeCustomMatcher(custom[0], id);
			}
		}

		if (result == null) {
			CoreException ce = EMFTypePluginStatusCodes
					.getContextInitException(id,
							EMFTypeCoreMessages.context_no_matcher_ERROR_);

			Trace.throwing(EMFTypePlugin.getPlugin(),
					EMFTypeDebugOptions.EXCEPTIONS_THROWING,
					XMLClientContext.class, "initializeMatcher", ce); //$NON-NLS-1$

			throw ce;
		}

		return result;
	}

	/**
	 * Creates an expression-based matcher from the specified XML
	 * <code>enablement</code> expression.
	 * 
	 * @@param enablement
	 *            my XML expression
	 * @@param id
	 *            the client context ID
	 * @@return the matcher (never <code>null</code>)
	 * @@throws CoreException
	 *             if something is malformed in the expression
	 */
	private static IElementMatcher initializeExpressionMatcher(
			IConfigurationElement enablement, String id) throws CoreException {

		return new XMLExpressionMatcher(enablement, id);
	}

	/**
	 * Instantiates a custom matcher class specified in the XML.
	 * 
	 * @@param config
	 *            a matcher configuration element
	 * @@param id
	 *            the client context ID
	 * @@return the matcher (never <code>null</code>)
	 * @@throws CoreException
	 *             if something is malformed in the expression
	 */
	private static IElementMatcher initializeCustomMatcher(
			IConfigurationElement config, String id) throws CoreException {
		Object result = config
				.createExecutableExtension(ElementTypeXmlConfig.A_CLASS);

		if (!(result instanceof IElementMatcher)) {

			CoreException ce = EMFTypePluginStatusCodes
					.getContextInitException(
							id,
							EMFTypeCoreMessages.context_matcher_wrong_class_ERROR_);

			Trace.throwing(EMFTypePlugin.getPlugin(),
					EMFTypeDebugOptions.EXCEPTIONS_THROWING,
					XMLClientContext.class, "initializeMatcher", ce); //$NON-NLS-1$

			throw ce;
		}

		return (IElementMatcher) result;
	}
}
@
