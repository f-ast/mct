head	1.1;
access;
symbols
	ocl_qvt:1.1.0.2;
locks; strict;
comment	@# @;
expand	@k@;


1.1
date	2008.08.20.12.22.02;	author ashatalin;	state dead;
branches
	1.1.2.1;
next	;
commitid	697648ac0c684567;

1.1.2.1
date	2008.08.20.12.22.02;	author ashatalin;	state Exp;
branches;
next	1.1.2.2;
commitid	697648ac0c684567;

1.1.2.2
date	2008.08.21.12.22.18;	author ashatalin;	state Exp;
branches;
next	1.1.2.3;
commitid	348648ad5df34567;

1.1.2.3
date	2008.08.28.07.30.33;	author ashatalin;	state Exp;
branches;
next	1.1.2.4;
commitid	5f8648b654184567;

1.1.2.4
date	2008.09.18.18.43.42;	author ashatalin;	state Exp;
branches;
next	;
commitid	1960148d2a15d4567;


desc
@@


1.1
log
@file MigrateXtendResource.java was initially added on branch ocl_qvt.
@
text
@@


1.1.2.1
log
@[243157] - Develop automatic migration tool creating QVTO/OCL constructions having Xtend as an input
 Migrate xtend resource pop-up menu action added.
@
text
@a0 112
package org.eclipse.gmf.internal.xpand.migration.ui;

import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.io.UnsupportedEncodingException;

import org.eclipse.core.resources.IFile;
import org.eclipse.core.resources.ResourcesPlugin;
import org.eclipse.core.runtime.CoreException;
import org.eclipse.core.runtime.IPath;
import org.eclipse.gmf.internal.xpand.RootManager;
import org.eclipse.gmf.internal.xpand.build.WorkspaceResourceManager;
import org.eclipse.gmf.internal.xpand.expression.AnalysationIssue;
import org.eclipse.gmf.internal.xpand.migration.MigrationException;
import org.eclipse.gmf.internal.xpand.migration.MigrationFacade;
import org.eclipse.jface.action.IAction;
import org.eclipse.jface.dialogs.MessageDialog;
import org.eclipse.jface.viewers.ISelection;
import org.eclipse.jface.viewers.IStructuredSelection;
import org.eclipse.swt.widgets.Shell;
import org.eclipse.ui.IObjectActionDelegate;
import org.eclipse.ui.IWorkbenchPart;

public class MigrateXtendResource implements IObjectActionDelegate {

	private Shell shell;

	private IFile selectedFile;

	public void setActivePart(IAction action, IWorkbenchPart targetPart) {
		shell = targetPart.getSite().getShell();
	}

	public void run(IAction action) {
		IFile qvtoFile = getQvtoFile();
		if (qvtoFile.exists() && !MessageDialog.openConfirm(shell, "Name conflict", "The file " + qvtoFile.getName() + " already present in this folder. Do you want to owerwrite it?")) {
			return;
		}
		try {
			InputStream inputStream = getQvtoResourceContent(qvtoFile.getCharset());
			if (inputStream == null) {
				return;
			}
			if (!qvtoFile.exists()) {
				qvtoFile.create(inputStream, true, null);
			} else {
				qvtoFile.setContents(inputStream, true, true, null);
			}
		} catch (CoreException e) {
			showError("Migration problems", "Following exception appears:\n\n" + e.getMessage());
		}
	}

	private InputStream getQvtoResourceContent(String charset) {
		RootManager rootManager = new RootManager(selectedFile.getProject());
		String templateFullName = rootManager.getTemplateFullName(selectedFile);
		if (templateFullName == null) {
			showError("Incorrect xtend resource", "Unable to locate proper xpand root for this xtend resource");
			return null;
		}
		WorkspaceResourceManager resourceManager = rootManager.getResourceManager(selectedFile);
		MigrationFacade migrationFacade = new MigrationFacade(resourceManager, templateFullName);
		try {
			StringBuilder qvtoResourceContent = migrationFacade.migrateXtendResource();
			return new ByteArrayInputStream(qvtoResourceContent.toString().getBytes(charset));
		} catch (MigrationException e) {
			reportMigrationException(e);
		} catch (UnsupportedEncodingException e) {
			showError("Unsupported encoding", "Specified encoding \"" + charset + "\" is not supported by the platform: " + e.getMessage());
		}
		return null;
	}

	private void reportMigrationException(MigrationException e) {
		switch (e.getType()) {
		case ANALYZATION_PROBLEMS:
			StringBuilder sb = new StringBuilder("Following analyzation problems present:\n\n");
			for (AnalysationIssue issue : e.getIssues()) {
				sb.append(issue.toString());
				sb.append("\n");
			}
			showError("Unable to load xtend resource", sb.toString());
			return;
		default:
			showError("Migration exception", "Migration exception appears:\n" + e.getMessage());
		}
	}

	private IFile getQvtoFile() {
		IPath qvtoFilePath = selectedFile.getFullPath().removeFileExtension().addFileExtension("qvto");
		IFile qvtoFile = ResourcesPlugin.getWorkspace().getRoot().getFile(qvtoFilePath);
		return qvtoFile;
	}

	public void selectionChanged(IAction action, ISelection selection) {
		if (selection instanceof IStructuredSelection) {
			IStructuredSelection structuredSelection = (IStructuredSelection) selection;
			if (structuredSelection.size() == 1 && structuredSelection.getFirstElement() instanceof IFile) {
				selectedFile = (IFile) structuredSelection.getFirstElement();
				action.setEnabled(true);
				return;
			}
		}
		selectedFile = null;
		action.setEnabled(false);
	}

	private void showError(String title, String contents) {
		MessageDialog.openError(shell, title, contents);
	}

}
@


1.1.2.2
log
@Buildin String operations migrated using additional qvto library.
@
text
@a24 2
	
	private static final String QVTO_EXTENSION = "qvto";
d90 1
a90 1
		IPath qvtoFilePath = selectedFile.getFullPath().removeFileExtension().addFileExtension(QVTO_EXTENSION);
@


1.1.2.3
log
@[243157] - Develop automatic migration tool creating QVTO/OCL constructions having Xtend as an input
 Separate ExpressionMigrationFacade class was created covering expressions AST migration.
@
text
@d15 1
a15 1
import org.eclipse.gmf.internal.xpand.migration.XtendMigrationFacade;
d64 1
a64 1
		XtendMigrationFacade migrationFacade = new XtendMigrationFacade(resourceManager, templateFullName);
@


1.1.2.4
log
@[243157] - Develop automatic migration tool creating QVTO/OCL constructions having Xtend as an input
 - Batch migrate templates action was added.
@
text
@d26 1
a26 1
	static final String QVTO_EXTENSION = "qvto";
@


