head	1.10;
access;
symbols
	v20081020-0700:1.10
	v20080917-1925:1.10
	v20080916-2008:1.10
	v20080722-1827:1.10
	v20080718-1700:1.10
	v20080718-1731:1.10
	R2_1_maintenance:1.10.0.2
	Root_R2_1_maintenance:1.10
	R2_1_0:1.10
	v20080603-1553:1.10
	v20080503-1740:1.10
	v20080425-1959:1.10
	v20080409-1326:1.10
	v20080407-2250:1.10
	v20080328-1605:1.10
	v20080222-1200:1.10
	v20080201-2010:1.10
	v20080118-1129:1.8.4.1
	v20080114-2222:1.8.4.1
	v20071130-1111:1.10
	v20071124-0000:1.8.4.1
	v20071108-0000:1.9
	v20070903-0000:1.8
	v20070809-0000:1.8
	R2_0_maintenance:1.8.0.4
	R2_0:1.8
	R4_20:1.8
	v20070621-0000:1.8
	RC3_20:1.8
	v20070608-1300:1.8
	v20070601-1400:1.8
	v20070518-1300:1.8
	bugzilla111892_group_support:1.8.0.2
	Root_bugzilla111892_group_support:1.8
	v20070427-0600:1.8
	v20070405-2000:1.7
	v20070330-1300:1.7
	v20070322-1100:1.7
	v20060316-0600:1.7
	v20070221-1500:1.7
	v20070208-1800:1.7
	v20070119-1200:1.6.2.1
	M4_20:1.7
	v20061218-1500:1.6.2.1
	v20061214-0000:1.7
	M3_20:1.7
	v20061117-0800:1.7
	v20061027-1200:1.6.2.1
	v20061013-1330:1.7
	v20061012-1100:1.6.2.1
	v20060919-0800:1.6.2.1
	v20060907-1100:1.6.2.1
	M1_20:1.6
	v20060803-1200:1.6.2.1
	v20060721-1130:1.6.2.1
	v20060713-1700:1.6.2.1
	R1_0_maintenance:1.6.0.2
	R1_0:1.6
	v20060627-1200:1.6
	v20060616-1200:1.6
	v20060531-1730:1.6
	v20060519-0800:1.6
	v20060512-1000:1.6
	I20060512-1000:1.6
	I20060424-0500:1.6
	I20060424-0300:1.6
	M6_10:1.6
	I20060407-1200:1.6
	I20060331-1000:1.6
	I20060324-0300:1.6
	I20060317-1300:1.6
	I20060317-1200:1.6
	I20060316-1300:1.6
	I20060309-1300:1.6
	M5_10:1.6
	S20060303-1600:1.6
	I20060227-1730:1.6
	I20060216-1945:1.6
	I20060210-1715:1.6
	I20060209-1815:1.6
	I20060203-0830:1.6
	I20060202-1415:1.6
	I20060129-1145:1.6
	I20060127-0900:1.6
	I20060120-1530:1.6
	I20060113-1700:1.6
	M4_10:1.6
	I20060107-1100:1.6
	I20060105-1630:1.6
	I20051230-1230:1.6
	I20051223-1100:1.6
	I20051217-0925:1.6
	I20051201-1800:1.6
	I20051124-2000:1.5
	M3_10:1.4
	I20051118-1245:1.4
	I20051111-1800:1.4
	I20051106-0900:1.4
	v20051030:1.3;
locks; strict;
comment	@# @;


1.10
date	2007.11.21.17.57.22;	author crevells;	state Exp;
branches;
next	1.9;
commitid	49a2474471824567;

1.9
date	2007.11.06.13.59.50;	author crevells;	state Exp;
branches;
next	1.8;
commitid	44eb473073564567;

1.8
date	2007.04.20.23.16.53;	author mmostafa;	state Exp;
branches
	1.8.2.1
	1.8.4.1;
next	1.7;
commitid	23ca462949e54567;

1.7
date	2006.10.03.15.01.48;	author ahunter;	state Exp;
branches;
next	1.6;

1.6
date	2005.11.25.19.38.23;	author cmahoney;	state Exp;
branches
	1.6.2.1;
next	1.5;

1.5
date	2005.11.21.16.01.29;	author cmahoney;	state Exp;
branches;
next	1.4;

1.4
date	2005.11.02.23.29.17;	author sshaw;	state Exp;
branches;
next	1.3;

1.3
date	2005.09.22.15.42.35;	author sshaw;	state Exp;
branches;
next	1.2;

1.2
date	2005.09.12.21.28.14;	author sshaw;	state Exp;
branches;
next	1.1;

1.1
date	2005.08.30.03.18.43;	author sshaw;	state Exp;
branches;
next	;

1.6.2.1
date	2006.07.11.15.10.27;	author cmahoney;	state Exp;
branches;
next	;

1.8.2.1
date	2007.05.18.17.36.38;	author crevells;	state Exp;
branches;
next	;
commitid	1849464de4254567;

1.8.4.1
date	2007.11.06.14.49.35;	author crevells;	state Exp;
branches;
next	;
commitid	540947307eff4567;


desc
@@


1.10
log
@[111892] gmf_head crevells 071121 Group/Ungroup support
@
text
@/******************************************************************************
 * Copyright (c) 2002, 2007 IBM Corporation and others.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    IBM Corporation - initial API and implementation 
 ****************************************************************************/

package org.eclipse.gmf.runtime.diagram.ui.actions.internal;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;

import org.eclipse.emf.ecore.EStructuralFeature;
import org.eclipse.gef.EditPart;
import org.eclipse.gmf.runtime.common.ui.util.WindowUtil;
import org.eclipse.gmf.runtime.diagram.ui.actions.ActionIds;
import org.eclipse.gmf.runtime.diagram.ui.actions.internal.l10n.DiagramUIActionsMessages;
import org.eclipse.gmf.runtime.diagram.ui.actions.internal.l10n.DiagramUIActionsPluginImages;
import org.eclipse.gmf.runtime.diagram.ui.editparts.IGraphicalEditPart;
import org.eclipse.gmf.runtime.diagram.ui.internal.properties.Properties;
import org.eclipse.gmf.runtime.draw2d.ui.figures.FigureUtilities;
import org.eclipse.gmf.runtime.emf.core.util.PackageUtil;
import org.eclipse.jface.resource.CompositeImageDescriptor;
import org.eclipse.jface.resource.ImageDescriptor;
import org.eclipse.swt.SWT;
import org.eclipse.swt.graphics.Image;
import org.eclipse.swt.graphics.ImageData;
import org.eclipse.swt.graphics.PaletteData;
import org.eclipse.swt.graphics.Point;
import org.eclipse.swt.graphics.RGB;
import org.eclipse.swt.graphics.Rectangle;
import org.eclipse.swt.widgets.ColorDialog;
import org.eclipse.swt.widgets.Display;
import org.eclipse.swt.widgets.Event;
import org.eclipse.swt.widgets.Item;
import org.eclipse.swt.widgets.Listener;
import org.eclipse.swt.widgets.Menu;
import org.eclipse.swt.widgets.MenuItem;
import org.eclipse.swt.widgets.ToolBar;
import org.eclipse.swt.widgets.ToolItem;
import org.eclipse.ui.IWorkbenchPage;

/**
 * @@author melaasar
 * @@canBeSeenBy %level1
 *
 * To change the template for this generated type comment go to
 * Window>Preferences>Java>Code Generation>Code and Comments
 */
public class ColorPropertyContributionItem
	extends PropertyChangeContributionItem
	implements Listener {

	/**
	 * An image descriptor that overlays two images: a basic icon
	 * and a thin color bar underneath it
	 */
	private static class ColorMenuImageDescriptor
		extends CompositeImageDescriptor {
		/** the basic icon */
		private ImageData basicImgData;
		/** the color of the thin color bar */
		private RGB rgb;

		/**
		 * Creates a new color menu image descriptor
		 * @@param basicIcon The basic Image data
		 * @@param rgb The color bar RGB value
		 */
		public ColorMenuImageDescriptor(ImageData basicImgData, RGB rgb) {
			this.basicImgData = basicImgData;
			this.rgb = rgb;
		}

		/**
		* @@see org.eclipse.jface.resource.CompositeImageDescriptor#drawCompositeImage(int, int)
		*/
		protected void drawCompositeImage(int width, int height) {
			// draw the base image
			drawImage(basicImgData, 0, 0);

			// draw the thin color bar underneath
			if (rgb != null) {
				ImageData colorBar =
					new ImageData(14, 4, 1, new PaletteData(new RGB[] { rgb }));
				drawImage(colorBar, 1, height - 4);
			}
		}

		/**
		 * @@see org.eclipse.jface.resource.CompositeImageDescriptor#getSize()
		 */
		protected Point getSize() {
			return ICON_SIZE;
		}
	}

	/**
	 * An image descriptor that creates a box with a given color
	 */
	private static class ColorBoxImageDescriptor extends ImageDescriptor {
		/** the color value in RGB scheme */
		private RGB rgb;

		/**
		 * Creates a new instance of the color box image descriptor with
		 * a given color
		 * 
		 * @@param rgb The color value in RGB scheme
		 */
		public ColorBoxImageDescriptor(RGB rgb) {
			this.rgb = rgb;
		}

		/**
		* @@see org.eclipse.jface.resource.ImageDescriptor#getImageData()
		*/
		public ImageData getImageData() {
			ImageData data =
				new ImageData(
					ICON_SIZE.x,
					ICON_SIZE.y,
					1,
					new PaletteData(new RGB[] { rgb, OUTLINE_COLOR }));

			for (int i = 0; i < ICON_SIZE.y; i++)
				data.setPixel(0, i, 1);
			for (int i = 0; i < ICON_SIZE.y; i++)
				data.setPixel(ICON_SIZE.x - 1, i, 1);
			for (int i = 0; i < ICON_SIZE.x; i++)
				data.setPixel(i, 0, 1);
			for (int i = 0; i < ICON_SIZE.x; i++)
				data.setPixel(i, ICON_SIZE.y - 1, 1);
			return data;
		}
	}

	/**
	 * A descirptor for an inventory color
	 */
	private static class InventoryColorDescriptor {
		public RGB colorValue;
		public String colorName;

		public InventoryColorDescriptor(RGB colorValue, String colorName) {
			this.colorValue = colorValue;
			this.colorName = colorName;
		}		
	}

	/** inventory colors */
	private static final InventoryColorDescriptor WHITE = new InventoryColorDescriptor(new RGB(255, 255, 255), DiagramUIActionsMessages.ColorPropertyChangeAction_white);
	private static final InventoryColorDescriptor BLACK = new InventoryColorDescriptor(new RGB(0, 0, 0), DiagramUIActionsMessages.ColorPropertyChangeAction_black);
	private static final InventoryColorDescriptor LIGHT_GRAY = new InventoryColorDescriptor(new RGB(192, 192, 192), DiagramUIActionsMessages.ColorPropertyChangeAction_lightGray);
	private static final InventoryColorDescriptor GRAY = new InventoryColorDescriptor(new RGB(128, 128, 128), DiagramUIActionsMessages.ColorPropertyChangeAction_gray);
	private static final InventoryColorDescriptor DARK_GRAY = new InventoryColorDescriptor(new RGB(64, 64, 64), DiagramUIActionsMessages.ColorPropertyChangeAction_darkGray);
	private static final InventoryColorDescriptor RED = new InventoryColorDescriptor(new RGB(227, 164, 156), DiagramUIActionsMessages.ColorPropertyChangeAction_red);
	private static final InventoryColorDescriptor GREEN = new InventoryColorDescriptor(new RGB(166, 193, 152), DiagramUIActionsMessages.ColorPropertyChangeAction_green);
	private static final InventoryColorDescriptor BLUE = new InventoryColorDescriptor(new RGB(152, 168, 191), DiagramUIActionsMessages.ColorPropertyChangeAction_blue);
	private static final InventoryColorDescriptor YELLOW = new InventoryColorDescriptor(new RGB(225, 225, 135), DiagramUIActionsMessages.ColorPropertyChangeAction_yellow);
	private static final InventoryColorDescriptor PURPLE = new InventoryColorDescriptor(new RGB(184, 151, 192), DiagramUIActionsMessages.ColorPropertyChangeAction_magenta);
	private static final InventoryColorDescriptor TEAL = new InventoryColorDescriptor(new RGB(155, 199, 204), DiagramUIActionsMessages.ColorPropertyChangeAction_cyan);
	private static final InventoryColorDescriptor PINK = new InventoryColorDescriptor(new RGB(228, 179, 229), DiagramUIActionsMessages.ColorPropertyChangeAction_pink);
	private static final InventoryColorDescriptor ORANGE = new InventoryColorDescriptor(new RGB(237, 201, 122), DiagramUIActionsMessages.ColorPropertyChangeAction_orange);
	/** default color icon width */
	private static final Point ICON_SIZE = new Point(16, 16);
	/** custom color group maximum length */
	private static final int CUSTOM_SIZE = 3;
	/** the default preference color */
	private static final RGB DEFAULT_PREF_COLOR = new RGB(0, 0, 0);
	/** the default preference color */
	private static final RGB OUTLINE_COLOR = new RGB(192, 192, 192);
	/** a color value that indicates the default color */
	private static final String DEFAULT = "Default"; //$NON-NLS-1$
	/** a color value that indicates to browse for a color */
	private static final String CHOOSE = "Choose"; //$NON-NLS-1$
	/** a color value that indicates to browse for a color */
	private static final String CLEAR = "Clear"; //$NON-NLS-1$
	/** the basic image data */
	private ImageData basicImageData;
	/** the disabledbasic image data */
	private ImageData disabledBasicImageData;
	/** the disabled basic image data **/
	private Image disabledBasicImage;
	/** the overlayed image */
	private Image overlyedImage;
	/** the last selected color */
	private Integer lastColor;
	/** the custom color list */
	private List customColors = new ArrayList();
	/** the inventory color list */
	private List inventoryColors = new ArrayList();
	/** the inventory color list  key: anRGB, value: anImage */
	private HashMap imageColorMap = new HashMap();
	/** the drop down menu */
	private Menu menu;

	/**
	 * Creates a new color property contribution item
	 * 
	 * @@param workbenchPage The part service
	 * @@param id The item id
	 * @@param propertyName The color property name (externalizable)
	 * @@param propertyId The color property id
	 * @@param toolTipText The tool tip text
	 * @@param basicImageData The basic image data
	 */
	public ColorPropertyContributionItem(
		IWorkbenchPage workbenchPage,
		String id,
		String propertyId,
		String propertyName,
		String toolTipText,
		ImageData basicImageData,
		ImageData disabledBasicImageData) {
		super(workbenchPage, id, propertyId, propertyName);
        assert null != toolTipText;
        assert null != basicImageData;
		this.basicImageData = basicImageData;
		this.disabledBasicImageData = disabledBasicImageData;
		setLabel(toolTipText);
	}

	/**
	 * @@see org.eclipse.gmf.runtime.common.ui.action.AbstractContributionItem#init()
	 */
	protected void init() {
		super.init();
		this.overlyedImage =
			new ColorMenuImageDescriptor(getBasicImageData(), null).createImage();
		this.disabledBasicImage = new ColorMenuImageDescriptor(this.disabledBasicImageData, null).createImage();
	}

	/**
	 * @@see org.eclipse.jface.action.IContributionItem#dispose()
	 */
	public void dispose() {
		if (overlyedImage != null && !overlyedImage.isDisposed()){
			overlyedImage.dispose();
			overlyedImage = null;
		}
		if (menu != null && !menu.isDisposed()){
			menu.dispose();
			menu = null;
		}
		for (Iterator i = imageColorMap.values().iterator(); i.hasNext();) {
			Image image = (Image) i.next();
			if (! image.isDisposed()) {
				image.dispose();
			}
		}
		if (disabledBasicImage != null && !disabledBasicImage.isDisposed()){
			disabledBasicImage.dispose();
			disabledBasicImage = null;
		}
		imageColorMap = new HashMap();
		
		super.dispose();
	}

	/**
	 * Render the UI as a
	 * @@see org.eclipse.gmf.runtime.common.ui.action.AbstractContributionItem#createToolItem(org.eclipse.swt.widgets.ToolBar, int)
	 */
	protected ToolItem createToolItem(ToolBar parent, int index) {
		ToolItem ti = new ToolItem(parent, SWT.DROP_DOWN, index);
		ti.addListener(SWT.Selection, getItemListener());
		ti.setImage(overlyedImage);
		ti.setDisabledImage(this.disabledBasicImage);
		return ti;
	}

	/**
	 * @@see org.eclipse.gmf.runtime.common.ui.action.AbstractContributionItem#createMenuItem(org.eclipse.swt.widgets.Menu, int)
	 */
	protected MenuItem createMenuItem(Menu parent, int index) {
		MenuItem mi = index >= 0 
			? new MenuItem(parent, SWT.CASCADE, index) 
			: new MenuItem(parent, SWT.CASCADE);
		createMenu(mi);
		mi.setImage(overlyedImage);
		return mi;
	}

	/**
	 * @@see org.eclipse.gmf.runtime.common.ui.action.AbstractContributionItem#handleWidgetEvent(org.eclipse.swt.widgets.Event)
	 */
	protected void handleWidgetEvent(Event e) {
		switch (e.type) {
			case SWT.Selection :
				handleWidgetSelection(e);
				break;
			default :
				super.handleWidgetEvent(e);
		}
	}

	/**
	 * Handles a widget selection event.
	 */
	private void handleWidgetSelection(Event e) {
		if (e.detail == 4) { // on drop-down button
			createMenu(getItem());
		} else { // on icon button
			if (lastColor != null)
				runWithEvent(e);
		}
	}

	/**
	 * Creates the color menu
	 */
	private void createMenu(Item item) {
		if (menu != null && !menu.isDisposed())
			menu.dispose();

		if (item instanceof ToolItem) {
			ToolItem toolItem = (ToolItem) item;
			menu = new Menu(toolItem.getParent());
			Rectangle b = toolItem.getBounds();
			Point p =
				toolItem.getParent().toDisplay(new Point(b.x, b.y + b.height));
			menu.setLocation(p.x, p.y); // waiting for SWT 0.42
			menu.setVisible(true);
		} else if (item instanceof MenuItem) {
			MenuItem menuItem = (MenuItem) item;
			menu = new Menu(menuItem.getParent());
			menuItem.setMenu(menu);
		}
        
        assert null != menu : "falid to create menu"; //$NON-NLS-1$
		buildMenu(menu);
	}

	/**
	 * @@see org.eclipse.gmf.runtime.diagram.ui.actions.internal.PropertyChangeContributionItem#getNewPropertyValue()
	 */
	protected Object getNewPropertyValue() {
		return lastColor;
	}

	/**
	 * Builds the color menu consisting of :
	 * inventory colors, custom colors, default and color picker
	 * 
	 * @@param theMenu The menu
	 */
	private void buildMenu(Menu theMenu) {
		// inventory colors
		createInventoryColorMenuItem(theMenu, WHITE);
		createInventoryColorMenuItem(theMenu, BLACK);
		createInventoryColorMenuItem(theMenu, LIGHT_GRAY);
		createInventoryColorMenuItem(theMenu, GRAY);
		createInventoryColorMenuItem(theMenu, DARK_GRAY);
		createInventoryColorMenuItem(theMenu, RED);
		createInventoryColorMenuItem(theMenu, GREEN);
		createInventoryColorMenuItem(theMenu, BLUE);
		createInventoryColorMenuItem(theMenu, YELLOW);
		createInventoryColorMenuItem(theMenu, PURPLE);
		createInventoryColorMenuItem(theMenu, TEAL);
		createInventoryColorMenuItem(theMenu, PINK);
		createInventoryColorMenuItem(theMenu, ORANGE);

		// history colors
		if (!customColors.isEmpty()) {
			createMenuSeparator(theMenu);
			Iterator iter = customColors.iterator();
			while (iter.hasNext()) {
				RGB rgb = (RGB) iter.next();
				createColorMenuItem(theMenu, rgb);
			}
			createClearCustomColorMenuItem(theMenu);
		}

		// default color and color picker
		createMenuSeparator(theMenu);
		createDefaultColorMenuItem(theMenu);
		createChooseColorMenuItem(theMenu);
	}

	/**
	 * Creates a new menu separator
	 * 
	 * @@param theMenu The menu
	 */
	private void createMenuSeparator(Menu theMenu) {
		new MenuItem(theMenu, SWT.SEPARATOR);
	}

	/**
	 * Creates a inventory color menu item with the given color name and RGB value
	 * 
	 * @@param theMenu The menu
	 * @@param color The color RGB value
	 * @@param colorName the color name (externalizable)
	 */
	private void createInventoryColorMenuItem(
		Menu theMenu,
		InventoryColorDescriptor color) {
		
		RGB rgb = color.colorValue;
		Image image = (Image) imageColorMap.get(rgb);		
		if (image == null){
			image = new ColorBoxImageDescriptor(color.colorValue).createImage();
			imageColorMap.put(rgb, image);
		}		
		MenuItem mi = createMenuItem(theMenu, color.colorName, image);
		mi.setData(rgb);
		inventoryColors.add(rgb);		
	}

	/**
	 * Creates a color menu item with the RGB value as a name
	 * 
	 * @@param theMenu The menu
	 * @@param rgb The color RGB value
	 */
	private void createColorMenuItem(Menu theMenu, RGB rgb) {
		Image image = (Image) imageColorMap.get(rgb);		
		if (image == null){
			image = new ColorBoxImageDescriptor(rgb).createImage();
			imageColorMap.put(rgb, image);
		}
		MenuItem mi = createMenuItem(theMenu, rgb.toString(), image);
		mi.setData(rgb);		
	}

	/**
	 * Creates a menu item for the default color
	 * 
	 * @@param theMenu The menu
	 */
	private void createDefaultColorMenuItem(Menu theMenu) {
		String text = DiagramUIActionsMessages.ColorPropertyChangeAction_default;
		Image image = null; //new ColorBoxImageDescriptor(color).createImage();
		MenuItem mi = createMenuItem(theMenu, text, image);
		mi.setData(DEFAULT);
	}

	/**
	 * Creates a menu item for the color picker
	 * 
	 * @@param theMenu The menu
	 */
	private void createChooseColorMenuItem(Menu theMenu) {
		String text = DiagramUIActionsMessages.ColorPropertyChangeAction_moreColors;
		Image image = null; //new ColorBoxImageDescriptor(color).createImage();
		MenuItem mi = createMenuItem(theMenu, text, image);
		mi.setData(CHOOSE);
	}

	/**
	 * Creates a menu item to clear the custom color menu group
	 * 
	 * @@param theMenu The menu
	 */
	private void createClearCustomColorMenuItem(Menu theMenu) {
		String text = DiagramUIActionsMessages.ColorPropertyChangeAction_clearColors;
		Image image = null; //new ColorBoxImageDescriptor(color).createImage();
		MenuItem mi = createMenuItem(theMenu, text, image);
		mi.setData(CLEAR);
	}

	/**
	 * Creates a menu item with a given text and image with the push style
	 * 
	 * @@param theMenu The menu
	 * @@param text The menu item text
	 * @@param image The menu item image
	 */
	private MenuItem createMenuItem(Menu theMenu, String text, Image image) {
		MenuItem mi = new MenuItem(theMenu, SWT.PUSH);
		if (text != null)
			mi.setText(text);
		if (image != null)
			mi.setImage(image);
		mi.addListener(SWT.Selection, this);
		return mi;
	}

	/**
	 * Handle the selection of menu items in the color menu
	 * 
	 * @@see org.eclipse.swt.widgets.Listener#handleEvent(org.eclipse.swt.widgets.Event)
	 */
	public void handleEvent(Event event) {
		MenuItem menuItem = (MenuItem) event.widget;
		Object data = menuItem.getData();

		RGB rgb = null;

		if (data instanceof RGB) {
			rgb = (RGB) data;
		} else if (data.equals(CHOOSE)) {
			rgb = getBrowseColor();
		} else if (data.equals(DEFAULT)) {
			rgb = getDefaultColor();
		} else if (data.equals(CLEAR)) {
			customColors.clear();
		}

		if (rgb != null) {
			if (getToolItem() != null) {
				// if a new custom color add it to history
				if (!customColors.contains(rgb)
					&& !inventoryColors.contains(rgb)) {
					if (customColors.size() == CUSTOM_SIZE)
						customColors.remove(0);
					customColors.add(rgb);
				}

				// create a new overlayed icon with the new color
				if (overlyedImage != null)
					overlyedImage.dispose();
				overlyedImage =
					new ColorMenuImageDescriptor(
						getBasicImageData(),
						rgb)
						.createImage();
				getItem().setImage(overlyedImage);
			}

			// set the new color as the last color
			lastColor = FigureUtilities.RGBToInteger(rgb);

			// run the action
			runWithEvent(event);
		}
	}

	/**
	 * Returns the color to use in the browse mode. By default,
	 * this comes from the color picker dialog
	 * 
	 * @@return The color to use in browse mode
	 */
	protected RGB getBrowseColor() {
		ColorDialog dialog =
			new ColorDialog(Display.getCurrent().getActiveShell());
		WindowUtil.centerDialog(
			dialog.getParent(),
			Display.getCurrent().getActiveShell());
		if (lastColor != null){			
			dialog.setRGB(FigureUtilities.integerToRGB(lastColor));
		}			
		dialog.open();		
		return dialog.getRGB();
	}

	/**
     * Returns the color to use in the default mode. A limitation is that if
     * there are multiple editparts with different default colors only the
     * default color of the first is returned.
     * 
     * @@return The color to use in default mode
     */
    protected RGB getDefaultColor() {
        for (Iterator iter = getOperationSet().iterator(); iter.hasNext();) {
            EditPart editpart = (EditPart) iter.next();
            if (editpart instanceof IGraphicalEditPart) {
                final EStructuralFeature feature = (EStructuralFeature) PackageUtil
                    .getElement(getPropertyId());

                Object preferredValue = ((IGraphicalEditPart) editpart)
                    .getPreferredValue(feature);
                if (preferredValue instanceof Integer) {
                    return FigureUtilities
                        .integerToRGB((Integer) preferredValue);
                }

            }

        }

        return DEFAULT_PREF_COLOR;
    }
	
	/**
	 * Gets the basic image data.
	 * @@return ImageData basicImageData
	 */
	protected ImageData getBasicImageData(){
		return this.basicImageData;
	}

	/**
	 * Create the FONT color menu
	 * 
	 * @@param workbenchPage The part service
	 * @@return The FONT color menu
	 */
	public static ColorPropertyContributionItem createFontColorContributionItem(IWorkbenchPage workbenchPage) {
		String propertyName = DiagramUIActionsMessages.PropertyDescriptorFactory_FontColor;
		String toolTipText = DiagramUIActionsMessages.ColorChangeActionMenu_fontColor;
		ImageData basicImageData = DiagramUIActionsPluginImages.DESC_FONT_COLOR
			.getImageData();
		ImageData disabledBasicImageData = DiagramUIActionsPluginImages.DESC_FONT_COLOR_DISABLED
			.getImageData();

		return new ColorPropertyContributionItem(
			workbenchPage,
			ActionIds.CUSTOM_FONT_COLOR,
			Properties.ID_FONTCOLOR,
			propertyName,
			toolTipText,
			basicImageData,
			disabledBasicImageData);
	}

	/**
	 * Create the LINE color menu
	 * 
	 * @@param workbenchPage The part service
	 * @@return The LINE color menu
	 */
	public static ColorPropertyContributionItem createLineColorContributionItem(IWorkbenchPage workbenchPage) {
		String propertyName = DiagramUIActionsMessages.PropertyDescriptorFactory_LineColor;
		String toolTipText = DiagramUIActionsMessages.ColorChangeActionMenu_lineColor;
		ImageData basicImageData = 
			DiagramUIActionsPluginImages.DESC_LINE_COLOR.getImageData();
		ImageData disabledBasicImageData = DiagramUIActionsPluginImages.DESC_LINE_COLOR_DISABLED
			.getImageData();

		return new ColorPropertyContributionItem(
			workbenchPage,
			ActionIds.CUSTOM_LINE_COLOR,
			Properties.ID_LINECOLOR,
			propertyName,
			toolTipText,
			basicImageData,
			disabledBasicImageData);
	}

	/**
	 * Create the FILL color menu
	 * 
	 * @@param workbenchPage The part service
	 * @@return The FILL color menu
	 */
	public static ColorPropertyContributionItem createFillColorContributionItem(IWorkbenchPage workbenchPage) {
		String propertyName = DiagramUIActionsMessages.PropertyDescriptorFactory_FillColor;
		String toolTipText = DiagramUIActionsMessages.ColorChangeActionMenu_fillColor;
		ImageData basicImageData = 
			DiagramUIActionsPluginImages.DESC_FILL_COLOR.getImageData();
		ImageData disabledBasicImageData = DiagramUIActionsPluginImages.DESC_FILL_COLOR_DISABLED
			.getImageData();

		return new ColorPropertyContributionItem(
			workbenchPage,
			ActionIds.CUSTOM_FILL_COLOR,
			Properties.ID_FILLCOLOR,
			propertyName,
			toolTipText,
			basicImageData,
			disabledBasicImageData);
	}

    @@Override
    protected boolean digIntoGroups() {
        return true;
    }


}
@


1.9
log
@[183150] gmf_head crevells 071106 [RulersGrid] Properties view: Rulers and Grid page: Custom color dialog should use currently selected color
Contributed by:  Carson Li
@
text
@d664 5
@


1.8
log
@[183474] gmf_head mmostafa 070420 Can not change the Fill Color of a shape using tool bar
@
text
@d549 4
a552 1
		dialog.open();
@


1.8.4.1
log
@[183150] gmf_R2_0_maintenance crevells 071106 [RulersGrid] Properties view: Rulers and Grid page: Custom color dialog should use currently selected color
Contributed by:  Carson Li
@
text
@d549 1
a549 4
		if (lastColor != null){			
			dialog.setRGB(FigureUtilities.integerToRGB(lastColor));
		}			
		dialog.open();		
@


1.8.2.1
log
@[111892] gmf_head crevells 070518 First milestone of group/ungroup support (painting issues when grouping shapes with border items)
@
text
@a24 1
import org.eclipse.gmf.runtime.diagram.ui.editparts.GroupEditPart;
a660 13
  
    protected List getTargetEditParts(EditPart editpart) {
        if (editpart instanceof GroupEditPart) {
            List list = new ArrayList();
            for (Iterator iter = ((GroupEditPart) editpart)
                .getFlattenedChildren().iterator(); iter.hasNext();) {
                list.addAll(getTargetEditParts((EditPart) iter.next()));
            }
            return list;
        } else {
            return super.getTargetEditParts(editpart);
        }
    }
@


1.7
log
@gmf_head ahunter 061003 Merge 1.0.1 Runtime to HEAD 2.0
@
text
@d2 1
a2 1
 * Copyright (c) 2002, 2003 IBM Corporation and others.
a30 1
import org.eclipse.jface.util.Assert;
d92 1
a92 1
				drawImage(colorBar, 1, 13);
d223 2
a224 2
		Assert.isNotNull(toolTipText);
		Assert.isNotNull(basicImageData);
d336 2
a337 2

		Assert.isNotNull(menu, "falid to create menu"); //$NON-NLS-1$
@


1.6
log
@Bugzilla#113812 gmf_head cmahoney 051125 Deprecating DiagramResourceManager
@
text
@d19 2
d25 1
a26 1
import org.eclipse.gmf.runtime.diagram.ui.preferences.IPreferenceConstants;
d28 1
a28 2
import org.eclipse.jface.preference.IPreferenceStore;
import org.eclipse.jface.preference.PreferenceConverter;
a185 2
	/** the preference id */
	private String preferenceId;
a211 1
	 * @@param preferenceId The id of color property in pref store (optionl)
a219 1
		String preferenceId,
a225 1
		this.preferenceId = preferenceId;
d555 26
a580 13
	 * Returns the color to use in the default mode. By default,
	 * this comes from the preference store
	 * 
	 * @@return The color to use in default mode
	 */
	protected RGB getDefaultColor() {
		IPreferenceStore store = (IPreferenceStore) getDiagramEditPart()
			.getDiagramPreferencesHint().getPreferenceStore();
		RGB color = null;
		if (preferenceId != null)
			color = PreferenceConverter.getColor(store, preferenceId);
		return color != null ? color : DEFAULT_PREF_COLOR;
	}
a608 1
			null,
a632 1
			IPreferenceConstants.PREF_LINE_COLOR,
a656 1
			IPreferenceConstants.PREF_FILL_COLOR,
@


1.6.2.1
log
@Bugzilla#146690 gmf_R1_0_maintenance cmahoney 060711 Inconsistent default colours
@
text
@a18 2
import org.eclipse.emf.ecore.EStructuralFeature;
import org.eclipse.gef.EditPart;
a22 1
import org.eclipse.gmf.runtime.diagram.ui.editparts.IGraphicalEditPart;
d24 1
d26 2
a27 1
import org.eclipse.gmf.runtime.emf.core.util.PackageUtil;
d185 2
d213 1
d222 1
d229 1
d559 13
a571 26
     * Returns the color to use in the default mode. A limitation is that if
     * there are multiple editparts with different default colors only the
     * default color of the first is returned.
     * 
     * @@return The color to use in default mode
     */
    protected RGB getDefaultColor() {
        for (Iterator iter = getOperationSet().iterator(); iter.hasNext();) {
            EditPart editpart = (EditPart) iter.next();
            if (editpart instanceof IGraphicalEditPart) {
                final EStructuralFeature feature = (EStructuralFeature) PackageUtil
                    .getElement(getPropertyId());

                Object preferredValue = ((IGraphicalEditPart) editpart)
                    .getPreferredValue(feature);
                if (preferredValue instanceof Integer) {
                    return FigureUtilities
                        .integerToRGB((Integer) preferredValue);
                }

            }

        }

        return DEFAULT_PREF_COLOR;
    }
d600 1
d625 1
d650 1
@


1.5
log
@Bugzilla#116030 gmf_head cmahoney 051121 Diagram ActionIds should be public
@
text
@a18 1
import org.eclipse.gmf.runtime.common.ui.l10n.AbstractUIResourceManager;
d21 2
a22 1
import org.eclipse.gmf.runtime.diagram.ui.actions.internal.l10n.DiagramActionsResourceManager;
d158 13
a170 13
	private static final InventoryColorDescriptor WHITE = new InventoryColorDescriptor(new RGB(255, 255, 255), getResources().getString("ColorPropertyChangeAction.white")); //$NON-NLS-1$
	private static final InventoryColorDescriptor BLACK = new InventoryColorDescriptor(new RGB(0, 0, 0), getResources().getString("ColorPropertyChangeAction.black")); //$NON-NLS-1$
	private static final InventoryColorDescriptor LIGHT_GRAY = new InventoryColorDescriptor(new RGB(192, 192, 192), getResources().getString("ColorPropertyChangeAction.lightGray")); //$NON-NLS-1$
	private static final InventoryColorDescriptor GRAY = new InventoryColorDescriptor(new RGB(128, 128, 128), getResources().getString("ColorPropertyChangeAction.gray")); //$NON-NLS-1$
	private static final InventoryColorDescriptor DARK_GRAY = new InventoryColorDescriptor(new RGB(64, 64, 64), getResources().getString("ColorPropertyChangeAction.darkGray")); //$NON-NLS-1$
	private static final InventoryColorDescriptor RED = new InventoryColorDescriptor(new RGB(227, 164, 156), getResources().getString("ColorPropertyChangeAction.red")); //$NON-NLS-1$
	private static final InventoryColorDescriptor GREEN = new InventoryColorDescriptor(new RGB(166, 193, 152), getResources().getString("ColorPropertyChangeAction.green")); //$NON-NLS-1$
	private static final InventoryColorDescriptor BLUE = new InventoryColorDescriptor(new RGB(152, 168, 191), getResources().getString("ColorPropertyChangeAction.blue")); //$NON-NLS-1$
	private static final InventoryColorDescriptor YELLOW = new InventoryColorDescriptor(new RGB(225, 225, 135), getResources().getString("ColorPropertyChangeAction.yellow")); //$NON-NLS-1$
	private static final InventoryColorDescriptor PURPLE = new InventoryColorDescriptor(new RGB(184, 151, 192), getResources().getString("ColorPropertyChangeAction.magenta")); //$NON-NLS-1$
	private static final InventoryColorDescriptor TEAL = new InventoryColorDescriptor(new RGB(155, 199, 204), getResources().getString("ColorPropertyChangeAction.cyan")); //$NON-NLS-1$
	private static final InventoryColorDescriptor PINK = new InventoryColorDescriptor(new RGB(228, 179, 229), getResources().getString("ColorPropertyChangeAction.pink")); //$NON-NLS-1$
	private static final InventoryColorDescriptor ORANGE = new InventoryColorDescriptor(new RGB(237, 201, 122), getResources().getString("ColorPropertyChangeAction.orange")); //$NON-NLS-1$
d445 1
a445 1
		String text = getResources().getString("ColorPropertyChangeAction.default"); //$NON-NLS-1$
d457 1
a457 1
		String text = getResources().getString("ColorPropertyChangeAction.moreColors"); //$NON-NLS-1$
d469 1
a469 1
		String text = getResources().getString("ColorPropertyChangeAction.clearColors"); //$NON-NLS-1$
d588 3
a590 4
		String propertyName = getResources().getString("PropertyDescriptorFactory.FontColor"); //$NON-NLS-1$
		String toolTipText = getResources().getString("ColorChangeActionMenu.fontColor"); //$NON-NLS-1$
		ImageData basicImageData = DiagramActionsResourceManager.getInstance()
			.getImageDescriptor(DiagramActionsResourceManager.IMAGE_FONT_COLOR)
d592 1
a592 3
		ImageData disabledBasicImageData = DiagramActionsResourceManager
			.getInstance().getImageDescriptor(
				DiagramActionsResourceManager.IMAGE_FONT_COLOR_DISABLED)
d613 5
a617 8
		String propertyName = getResources().getString("PropertyDescriptorFactory.LineColor"); //$NON-NLS-1$
		String toolTipText = getResources().getString("ColorChangeActionMenu.lineColor"); //$NON-NLS-1$
		ImageData basicImageData = DiagramActionsResourceManager.getInstance()
			.getImageDescriptor(DiagramActionsResourceManager.IMAGE_LINE_COLOR)
			.getImageData();
		ImageData disabledBasicImageData = DiagramActionsResourceManager
			.getInstance().getImageDescriptor(
				DiagramActionsResourceManager.IMAGE_LINE_COLOR_DISABLED)
d638 5
a642 8
		String propertyName = getResources().getString("PropertyDescriptorFactory.FillColor"); //$NON-NLS-1$
		String toolTipText = getResources().getString("ColorChangeActionMenu.fillColor"); //$NON-NLS-1$
		ImageData basicImageData = DiagramActionsResourceManager.getInstance()
			.getImageDescriptor(DiagramActionsResourceManager.IMAGE_FILL_COLOR)
			.getImageData();
		ImageData disabledBasicImageData = DiagramActionsResourceManager
			.getInstance().getImageDescriptor(
				DiagramActionsResourceManager.IMAGE_FILL_COLOR_DISABLED)
a655 6
	/**
	 * @@return a short cut to the resources
	 */
	private static AbstractUIResourceManager getResources() {
		return DiagramActionsResourceManager.getInstance();
	}
@


1.4
log
@Bugzilla#113157 gmf_head cmahoney 051102 GMF Diagram Layer Public API Name Changes
@
text
@d21 1
a23 1
import org.eclipse.gmf.runtime.diagram.ui.internal.requests.ActionIds;
@


1.3
log
@Bugzilla 109092: gmf_head sshaw 050922 : API Analysis: Diagram layer API.  Determine if all API is needed and/or has appropriate signatures
Contributed by Mohammed Mostafa
@
text
@d19 7
a48 9
import org.eclipse.gmf.runtime.common.ui.l10n.AbstractUIResourceManager;
import org.eclipse.gmf.runtime.common.ui.util.WindowUtil;
import org.eclipse.gmf.runtime.diagram.ui.IPreferenceConstants;
import org.eclipse.gmf.runtime.diagram.ui.actions.internal.l10n.DiagramActionsResourceManager;
import org.eclipse.gmf.runtime.diagram.ui.actions.internal.l10n.Images;
import org.eclipse.gmf.runtime.diagram.ui.internal.properties.Properties;
import org.eclipse.gmf.runtime.diagram.ui.internal.requests.ActionIds;
import org.eclipse.gmf.runtime.draw2d.ui.figures.FigureUtilities;

d590 7
a596 2
		ImageData basicImageData = Images.DESC_ACTION_FONT_COLOR.getImageData();
		ImageData disabledBasicImageData = Images.DESC_ACTION_FONT_COLOR_DISABLED.getImageData();
d618 7
a624 2
		ImageData basicImageData = Images.DESC_ACTION_LINE_COLOR.getImageData();
		ImageData disabledBasicImageData = Images.DESC_ACTION_LINE_COLOR_DISABLED.getImageData();
d646 7
a652 2
		ImageData basicImageData = Images.DESC_ACTION_FILL_COLOR.getImageData();
		ImageData disabledBasicImageData = Images.DESC_ACTION_FILL_COLOR_DISABLED.getImageData();
@


1.2
log
@Bugzilla 108765 gmf_head tmacdoug 050912 - Update copyrights of GMF and EMFT plugins content to Eclipse copyright (EPL)
@
text
@d47 1
a48 1
import org.eclipse.gmf.runtime.diagram.ui.properties.Properties;
@


1.1
log
@Refactoring of the IBM gmf runtime contribution to the org.eclipse.gmf.runtime namespace.
@
text
@d1 11
a11 9
/*
 *+------------------------------------------------------------------------+
 *| Licensed Materials - Property of IBM                                   |
 *| (C) Copyright IBM Corp. 2002, 2003.  All Rights Reserved.              |
 *|                                                                        |
 *| US Government Users Restricted Rights - Use, duplication or disclosure |
 *| restricted by GSA ADP Schedule Contract with IBM Corp.                 |
 *+------------------------------------------------------------------------+
 */
@

