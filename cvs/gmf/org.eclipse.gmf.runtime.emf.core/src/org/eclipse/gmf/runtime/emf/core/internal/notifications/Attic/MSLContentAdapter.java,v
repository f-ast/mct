head	1.3;
access;
symbols
	R1_0_maintenance:1.3.0.2
	R1_0:1.3
	I20060203-0830:1.2
	I20060129-1145:1.2
	I20060127-0900:1.2
	I20060120-1530:1.2
	I20060113-1700:1.2
	M4_10:1.2
	I20060107-1100:1.2
	I20060105-1630:1.2
	I20051230-1230:1.2
	I20051223-1100:1.2
	I20051217-0925:1.2
	I20051201-1800:1.2
	I20051124-2000:1.2
	M3_10:1.2
	I20051118-1245:1.2
	I20051111-1800:1.2
	I20051106-0900:1.2
	v20051030:1.2;
locks; strict;
comment	@# @;


1.3
date	2006.02.08.14.52.10;	author ldamus;	state dead;
branches;
next	1.2;

1.2
date	2005.09.12.21.25.11;	author sshaw;	state Exp;
branches;
next	1.1;

1.1
date	2005.08.30.03.26.54;	author sshaw;	state Exp;
branches;
next	;


desc
@@


1.3
log
@[121508] gmf_head cdamus 060208 Refactor MSL using the new transaction API
@
text
@/******************************************************************************
 * Copyright (c) 2002, 2003 IBM Corporation and others.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    IBM Corporation - initial API and implementation 
 ****************************************************************************/

package org.eclipse.gmf.runtime.emf.core.internal.notifications;

import java.util.Collection;
import java.util.Iterator;

import org.eclipse.emf.common.notify.Notification;
import org.eclipse.emf.common.notify.Notifier;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.EReference;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.emf.ecore.resource.ResourceSet;
import org.eclipse.emf.ecore.util.EContentAdapter;

import org.eclipse.gmf.runtime.emf.core.internal.domain.MSLEditingDomain;
import org.eclipse.gmf.runtime.emf.core.internal.resources.MResource;

/**
 * This class overrides EMF content adapter class by disabling the automatic
 * removal of the content adapter from the object's adapter list when the object
 * it self is removed from its container. This is required since the MSL
 * requires events on detached objects.
 * 
 * @@author rafikj
 */
public class MSLContentAdapter
	extends EContentAdapter {

	private MSLEditingDomain domain = null;

	/**
	 * Constructor.
	 */
	public MSLContentAdapter(MSLEditingDomain domain) {
		super();
		this.domain = domain;
	}

	/**
	 * Attaches adapter to notifier.
	 */
	public void listenToModifications(Notifier notifier) {

		if (notifier.eAdapters().contains(this))
			return;

		addAdapter(notifier);
	}

	/**
	 * @@see org.eclipse.emf.common.notify.Adapter#notifyChanged(org.eclipse.emf.common.notify.Notification)
	 */
	public void notifyChanged(Notification notification) {

		super.notifyChanged(notification);

		Object notifier = notification.getNotifier();

		if (notifier instanceof EObject)
			domain.getObjectListener().handleEvent(notification);

		else if (notifier instanceof Resource)
			domain.getResouceListener().handleEvent(notification);

		else if (notifier instanceof ResourceSet)
			domain.getResouceSetListener().handleEvent(notification);
	}

	/**
	 * @@see org.eclipse.emf.ecore.util.EContentAdapter#selfAdapt(org.eclipse.emf.common.notify.Notification)
	 */
	protected void selfAdapt(Notification notification) {

		Object notifier = notification.getNotifier();

		if (notifier instanceof ResourceSet) {

			if (notification.getFeatureID(ResourceSet.class) == ResourceSet.RESOURCE_SET__RESOURCES)
				handleContainment(notification);

		} else if (notifier instanceof Resource) {

			if (notification.getFeatureID(Resource.class) == Resource.RESOURCE__CONTENTS)
				handleContainment(notification);

		} else if (notifier instanceof EObject) {

			Object feature = notification.getFeature();

			if (feature instanceof EReference
				&& ((EReference) feature).isContainment())
				handleContainment(notification);
		}
	}

	/**
	 * @@see org.eclipse.emf.ecore.util.EContentAdapter#handleContainment(org.eclipse.emf.common.notify.Notification)
	 */
	protected void handleContainment(Notification notification) {

		switch (notification.getEventType()) {

			case Notification.SET:
			case Notification.UNSET: {
				Notifier newValue = (Notifier) notification.getNewValue();

				if (newValue != null)
					addAdapter(newValue);

				break;
			}
			case Notification.ADD: {
				Notifier newValue = (Notifier) notification.getNewValue();

				if (newValue != null)
					addAdapter(newValue);

				break;
			}
			case Notification.ADD_MANY: {
				Collection newValues = (Collection) notification.getNewValue();

				for (Iterator i = newValues.iterator(); i.hasNext();) {

					Notifier newValue = (Notifier) i.next();

					addAdapter(newValue);
				}

				break;
			}
		}
	}

	/**
	 * @@see org.eclipse.emf.common.notify.Adapter#setTarget(org.eclipse.emf.common.notify.Notifier)
	 */
	public void setTarget(Notifier object) {

		// do not set "this.target" to "object" as it will cause a memory leak.

		Collection contents = getContents(object);

		if (contents != null)
			for (Iterator i = contents.iterator(); i.hasNext();)
				addAdapter((Notifier) i.next());
	}

	/**
	 * @@see org.eclipse.emf.ecore.util.EContentAdapter#unsetTarget(java.lang.Object)
	 */
	protected void unsetTarget(Object object) {

		this.target = null;

		Collection contents = getContents(object);

		if (contents != null)
			for (Iterator i = contents.iterator(); i.hasNext();)
				removeAdapter((Notifier) i.next());
	}

	/**
	 * Attaches adapter to notifier.
	 */
	protected void addAdapter(Notifier notifier) {

		MSLContentAdapter foundAdapter = null;

		for (Iterator i = notifier.eAdapters().iterator(); (i.hasNext())
			&& (foundAdapter == null);) {

			Object adapter = i.next();

			if (adapter instanceof MSLContentAdapter)
				foundAdapter = (MSLContentAdapter) adapter;
		}

		if (foundAdapter != null)
			notifier.eAdapters().remove(foundAdapter);

		notifier.eAdapters().add(this);
	}

	/**
	 * detaches adapter from notifier.
	 */
	protected void removeAdapter(Notifier notifier) {
		notifier.eAdapters().remove(this);
	}

	/**
	 * Gets contents of object.
	 */
	private static Collection getContents(Object object) {

		Collection contents = null;

		if (object instanceof EObject) {

			EObject eObject = (EObject) object;

			Resource resource = eObject.eResource();

			if ((resource != null) && (resource instanceof MResource))
				contents = ((MResource) resource).getHelper().getContents(
					eObject);
			else
				contents = eObject.eContents();

		} else if (object instanceof Resource)
			contents = ((Resource) object).getContents();

		else if (object instanceof ResourceSet)
			contents = ((ResourceSet) object).getResources();

		return contents;
	}
}@


1.2
log
@Bugzilla 108765 gmf_head tmacdoug 050912 - Update copyrights of GMF and EMFT plugins content to Eclipse copyright (EPL)
@
text
@@


1.1
log
@Refactoring of the IBM gmf runtime contribution to the org.eclipse.gmf.runtime namespace.
@
text
@d1 11
a11 9
/*
 *+------------------------------------------------------------------------+
 *| Licensed Materials - Property of IBM                                   |
 *| (C) Copyright IBM Corp. 2002, 2003.  All Rights Reserved.              |
 *|                                                                        |
 *| US Government Users Restricted Rights - Use, duplication or disclosure |
 *| restricted by GSA ADP Schedule Contract with IBM Corp.                 |
 *+------------------------------------------------------------------------+
 */
@

