head	1.7;
access;
symbols
	v20081022-1925:1.7
	v20081015-1925:1.7
	v20081008-1925:1.7
	v20081001-1925:1.7
	v20080924-1925:1.7
	v20080917-1925:1.7
	v20080911-1728:1.7
	v20080910-1520:1.7
	v20080903-1520:1.7
	v20080827-1520:1.7
	v20080813-1520:1.7
	v20080806-1520:1.7
	v20070903-0000:1.6
	v20070809-0000:1.6
	R2_0_maintenance:1.6.0.2
	R2_0:1.6
	R4_20:1.6
	v20070621-0000:1.6
	RC3_20:1.6
	v20070614-1400:1.6
	v20070608-1300:1.6
	v20070605-1400:1.6
	v20070601-1400:1.6
	v20070525-1500:1.6
	v20070520-1200:1.6
	v20070518-1300:1.6
	v20070504-1000:1.6
	v20070427-0600:1.5
	v20070420-1000:1.5
	v20070413-1300:1.5
	v20070405-1100:1.5
	v20070403-1500:1.5
	v20070330-1300:1.5
	v20060330-1300:1.5
	v20070322-1100:1.5
	v20060316-0600:1.5
	v20070307-0700:1.5
	v20070301-1200:1.5
	v20070228-2000:1.5
	v20070221-1500:1.5
	v20070208-1800:1.5
	v20070202-0200:1.4
	v20070103-0300:1.5
	M4_20:1.5
	v20061222-1800:1.5
	v20061218-1200:1.5
	v20061214-0000:1.5
	v20061120-1300:1.5
	M3_20:1.5
	v20061117-0800:1.5
	v20061027-1200:1.4
	v20061020-1000:1.4
	v20061013-1330:1.4
	v20060919-0800:1.4
	v20060907-1100:1.4
	M1_20:1.4
	v20060904-1500:1.4
	v20060824-1600:1.4
	v20060817-1500:1.4
	v20060728-0500:1.4
	v20060713-1700:1.4
	R1_0_maintenance:1.4.0.2
	R1_0:1.4
	v20060627-1200:1.4
	v20060626-1420:1.4
	v20060620-0400:1.4
	v20060616-1400:1.4
	v20060616-1200:1.4
	v20060609-1400:1.3
	v20060531-1730:1.2
	v20060530-1930:1.2
	v20060526-1200:1.2
	v20060519-1300:1.2
	v20060519-0800:1.2
	v20060512-1000:1.2
	I20060512-1000:1.2
	I20060505-1400:1.2
	I20060428-1300:1.2
	I20060424-0500:1.2
	I20060424-0300:1.2
	M6_10:1.2;
locks; strict;
comment	@# @;


1.7
date	2007.09.14.14.53.25;	author dstadnik;	state dead;
branches;
next	1.6;
commitid	40c546eaa0634567;

1.6
date	2007.04.30.11.55.02;	author atikhomirov;	state Exp;
branches
	1.6.2.1;
next	1.5;
commitid	27bb4635d9164567;

1.5
date	2006.11.16.16.41.33;	author radvorak;	state Exp;
branches;
next	1.4;
commitid	6165455c94bc4567;

1.4
date	2006.06.13.12.53.34;	author radvorak;	state Exp;
branches;
next	1.3;

1.3
date	2006.06.05.21.08.38;	author radvorak;	state Exp;
branches;
next	1.2;

1.2
date	2006.04.14.11.23.23;	author radvorak;	state Exp;
branches;
next	1.1;

1.1
date	2006.04.13.15.41.17;	author radvorak;	state Exp;
branches;
next	;

1.6.2.1
date	2007.09.14.15.11.12;	author dstadnik;	state dead;
branches;
next	;
commitid	18546eaa48f4567;


desc
@@


1.7
log
@rewrite abs expr in xpand
@
text
@<%@@ jet package="org.eclipse.gmf.codegen.templates.expressions" class="AbstractExpressionGenerator"
    imports="org.eclipse.gmf.codegen.gmfgen.* org.eclipse.gmf.common.codegen.*"%>
<%
final GenDiagram genDiagram = (GenDiagram) ((Object[]) argument)[0];
final ImportAssistant importManager = (ImportAssistant) ((Object[]) argument)[1];
final GenExpressionProviderContainer providerContainer = genDiagram.getEditorGen().getExpressionProviders();
%>
<%@@ include file="../copyright4java.jetinc"%>
<%importManager.emitPackageStatement(stringBuffer);%>

<%importManager.markImportLocation(stringBuffer);%>

<%
importManager.registerInnerClass("NoImplException");
importManager.addImport("java.math.BigDecimal");
importManager.addImport("java.math.BigInteger");
importManager.addImport("java.util.Collection");
importManager.addImport("java.util.Collections");
importManager.addImport("java.util.Iterator");
importManager.addImport("java.util.Map");
importManager.addImport("org.eclipse.core.runtime.IStatus");
importManager.addImport("org.eclipse.core.runtime.Status");
importManager.addImport("org.eclipse.emf.ecore.EObject");
importManager.addImport("org.eclipse.emf.ecore.EStructuralFeature");
importManager.addImport("org.eclipse.emf.ecore.ETypedElement");
importManager.addImport("org.eclipse.emf.ecore.EClassifier");
importManager.addImport("org.eclipse.emf.ecore.util.EcoreUtil");
importManager.addImport("org.eclipse.core.runtime.Platform");
%>

/**
 * @@generated
 */
public abstract class <%=providerContainer.getAbstractExpressionClassName()%> {		
	/**
	 * @@generated
	 */
	private static final boolean DISABLED_NO_IMPL_EXCEPTION_LOG = Boolean.valueOf(Platform.getDebugOption(<%=importManager.getImportedName(genDiagram.getEditorGen().getPlugin().getActivatorQualifiedClassName())%>.getInstance().getBundle().getSymbolicName() + "/debug/disableNoExprImplExceptionLog")).booleanValue();
	/**
	 * @@generated
	 */
	private final String body;
	/**
	 * @@generated
	 */
	private final EClassifier context;

	/**
	 * @@generated
	 */	
	private IStatus status = Status.OK_STATUS;	

	/**
	 * @@generated
	 */
	protected <%=providerContainer.getAbstractExpressionClassName()%>(EClassifier context) {
		this(null, context);
	}
	
	/**
	 * @@generated
	 */	
	protected <%=providerContainer.getAbstractExpressionClassName()%>(String body, EClassifier context) {
		this.body = body;
		this.context = context;
	}
	
	/**
	 * @@generated
	 */	
	protected void setStatus(int severity, String message, Throwable throwable) {		
		String pluginID = <%=importManager.getImportedName(genDiagram.getEditorGen().getPlugin().getActivatorQualifiedClassName())%>.ID;
		this.status = new Status(severity, pluginID, -1, (message != null) ? message : "", throwable); //$NON-NLS-1$
		if(!this.status.isOK()) {
			<%=importManager.getImportedName(genDiagram.getEditorGen().getPlugin().getActivatorQualifiedClassName())%>
					.getInstance().logError("Expression problem:" + message + "body:"+ body, throwable); //$NON-NLS-1$ //$NON-NLS-2$
		
		}
	}
	
	/**
	 * @@generated
	 */	
	protected abstract Object doEvaluate(Object context, Map env);

	/**
	 * @@generated
	 */	
	public Object evaluate(Object context) {
		return evaluate(context, Collections.EMPTY_MAP);
	}
	
	/**
	 * @@generated
	 */	
	public Object evaluate(Object context, Map env) {
		if(context().isInstance(context)) {
			try {
				return doEvaluate(context, env);
			} catch(Exception e) {
				if(DISABLED_NO_IMPL_EXCEPTION_LOG && e instanceof NoImplException) {
					return null;
				}
				<%=importManager.getImportedName(genDiagram.getEditorGen().getPlugin().getActivatorQualifiedClassName())%>
					.getInstance().logError("Expression evaluation failure: " + body, e);
			}
		}
		return null;
	}

	/**
	 * @@generated
	 */	
	public IStatus getStatus() {
		return status;
	}
	
	/**
	 * @@generated
	 */	
	public String body() {
		return body;
	}

	/**
	 * @@generated
	 */
	public EClassifier context() {
		return context;
	}
	
	/**
	 * @@generated
	 */	
	public void assignTo(EStructuralFeature feature, EObject target) {
		Object value = evaluate(target);
		value = (value != null) ? performCast(value, feature) : null;
		if (feature.isMany()) {
			Collection destCollection = (Collection) target.eGet(feature);
			destCollection.clear();
			if(value instanceof Collection) {
				Collection valueCollection = (Collection) value;
				for (Iterator it = valueCollection.iterator(); it.hasNext();) {
					destCollection.add(performCast(it.next(), feature));
				}
			} else {
				destCollection.add(value);
			}
			return;
		}
		target.eSet(feature, value);
	}
	
	/**
	 * @@generated
	 */	
	protected Object performCast(Object value, ETypedElement targetType) {
		if(targetType.getEType() == null || targetType.getEType().getInstanceClass() == null) {
			return value;
		}
		Class targetClass = targetType.getEType().getInstanceClass();	
		if(value != null && value instanceof Number) {
			Number num = (Number)value;
			Class valClass = value.getClass();			
			Class targetWrapperClass = targetClass;
			if(targetClass.isPrimitive()) {
				targetWrapperClass = EcoreUtil.wrapperClassFor(targetClass);
			}			
			if(valClass.equals(targetWrapperClass)) {
				return value;				
			}
			if(Number.class.isAssignableFrom(targetWrapperClass)) {
				if(targetWrapperClass.equals(Byte.class)) return new Byte(num.byteValue());
				if(targetWrapperClass.equals(Integer.class)) return new Integer(num.intValue());
				if(targetWrapperClass.equals(Short.class)) return new Short(num.shortValue());
				if(targetWrapperClass.equals(Long.class)) return new Long(num.longValue());					
				if(targetWrapperClass.equals(BigInteger.class)) return BigInteger.valueOf(num.longValue());
				if(targetWrapperClass.equals(Float.class)) return new Float(num.floatValue());
				if(targetWrapperClass.equals(Double.class)) return new Double(num.doubleValue());
				if(targetWrapperClass.equals(BigDecimal.class)) return new BigDecimal(num.doubleValue());
			}
		}
		return value;
	}	
	
	/**
	 * @@generated
	 */	
	public static final <%=providerContainer.getAbstractExpressionClassName()%> createNullExpression(EClassifier context) {
		return new <%=providerContainer.getAbstractExpressionClassName()%>(context) {
			protected Object doEvaluate(Object context, Map env) {
				// TODO - log entry about not provider available for this expression
				return null;
			}
		};
	}
	
	/**
	 * @@generated
	 */	
	public static class NoImplException extends RuntimeException {
		/**
		 * @@generated
		 */	
		public NoImplException(String message) {
			super(message);
		}
	}	
}
<%importManager.emitSortedImports();%>
@


1.6
log
@update not to use deprecated ocl code
@
text
@@


1.6.2.1
log
@rewrite abs expr in xpand
@
text
@@


1.5
log
@[151719] ...ExpressionFactory templates should implement weakref caching of re-parseable expressions
@
text
@d42 1
a42 1
	private String body;
d46 2
a47 5
	private EClassifier context;
	/**
	 * @@generated
	 */
	private Map env;	
d57 1
a57 1
		this.context = context;
d63 1
a63 1
	protected <%=providerContainer.getAbstractExpressionClassName()%>(String body, EClassifier context, Map env) {
a65 1
		this.env = env;
a134 7
	public Map environment() {
		return env;
	}	

	/**
	 * @@generated
	 */
@


1.4
log
@#145753 Suppress exceptions logged from unimplemented methods of JavaAudits during tests execution
@
text
@d49 4
d69 1
d135 7
@


1.3
log
@#145337 Move element initializer's assignment of expressions to features into expression templates
@
text
@d14 1
d28 1
d38 4
d100 3
a104 1
				return null;
d196 12
@


1.2
log
@#136812 AbstractExpression template: final keyword in parameters list is lost upon regeneration
@
text
@d14 3
d18 1
d22 3
d26 1
d122 54
@


1.1
log
@[#134511] common access to expressions of different languages
@
text
@d118 1
a118 1
	public static final <%=providerContainer.getAbstractExpressionClassName()%> createNullExpression(final EClassifier context) {
@

